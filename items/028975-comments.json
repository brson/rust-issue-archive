[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/285117595",
    "html_url": "https://github.com/rust-lang/rust/issues/28975#issuecomment-285117595",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28975",
    "id": 285117595,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4NTExNzU5NQ==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-03-08T17:59:47Z",
    "updated_at": "2017-03-08T17:59:47Z",
    "body": "Tagging with the libs team here, I don't know if they want to make a change or not.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/285117595/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344831695",
    "html_url": "https://github.com/rust-lang/rust/issues/28975#issuecomment-344831695",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28975",
    "id": 344831695,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NDgzMTY5NQ==",
    "user": {
      "login": "dtolnay",
      "id": 1940490,
      "node_id": "MDQ6VXNlcjE5NDA0OTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dtolnay",
      "html_url": "https://github.com/dtolnay",
      "followers_url": "https://api.github.com/users/dtolnay/followers",
      "following_url": "https://api.github.com/users/dtolnay/following{/other_user}",
      "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions",
      "organizations_url": "https://api.github.com/users/dtolnay/orgs",
      "repos_url": "https://api.github.com/users/dtolnay/repos",
      "events_url": "https://api.github.com/users/dtolnay/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dtolnay/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-16T06:48:17Z",
    "updated_at": "2017-11-16T06:48:17Z",
    "body": "I agree, the current behavior seems broken to me. Would you expect the environment to be captured when `new` is called or when `spawn` is called? I believe #33183 wanted the latter, with the sequence of `env` / `env_remove` / `env_clear` changes replayed against whatever the parent process environment contains at that time. @oconnor663\r\n\r\nMy only concern would be that if we provide getters on the Command builder as requested in #44434, the user may call a getter to get the child environment to validate, which would need to dynamically compute the environment based on the current parent process environment.\r\n\r\n```rust\r\nlet mut cmd = Command::new(\"...\");\r\nfill_in_the_environment(&mut cmd);\r\n\r\nlet child_env = cmd.get_the_environment();\r\nvalidate_the_environment(child_env)?;\r\n\r\n/* Environment is global state, suppose it changes in between. Now the environment\r\n   we validated is no longer the one that the process will run with. */\r\n\r\ncmd.spawn()?;\r\n```",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344831695/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344979687",
    "html_url": "https://github.com/rust-lang/rust/issues/28975#issuecomment-344979687",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28975",
    "id": 344979687,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NDk3OTY4Nw==",
    "user": {
      "login": "oconnor663",
      "id": 860932,
      "node_id": "MDQ6VXNlcjg2MDkzMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/860932?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/oconnor663",
      "html_url": "https://github.com/oconnor663",
      "followers_url": "https://api.github.com/users/oconnor663/followers",
      "following_url": "https://api.github.com/users/oconnor663/following{/other_user}",
      "gists_url": "https://api.github.com/users/oconnor663/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/oconnor663/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/oconnor663/subscriptions",
      "organizations_url": "https://api.github.com/users/oconnor663/orgs",
      "repos_url": "https://api.github.com/users/oconnor663/repos",
      "events_url": "https://api.github.com/users/oconnor663/events{/privacy}",
      "received_events_url": "https://api.github.com/users/oconnor663/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-16T16:33:31Z",
    "updated_at": "2017-12-18T15:16:15Z",
    "body": "@dtolnay yes, personally I'd prefer capturing it during `spawn`. A few thoughts:\r\n\r\n- Most callers probably don't modify the child's environment at all. In that case, `spawn` wouldn't actually need to do anything, as the child would inherit the parent's environment by default. Capturing the environment in `new` on the other hand, would need to unconditionally copy it for every caller.\r\n  - A counterpoint might be that, if we capture in `spawn` and the caller is using `env` functions, every call to `spawn` on the same `Command` instance will need to repeat the work to construct the final child environment. Probably at the end of the day, though, performance probably doesn't _really_ matter on either side :)\r\n- My opinion is that capturing in `spawn` is \"less surprising\" than capturing in `new` would be, since it's the same behavior a simple C program would have using `fork` + `execv`. I like that there's just \"less state in the world\".\r\n- If we capture the current environment in `new`, we might also ask whether we're supposed to capture the current working directory in `new`. Probably no one wants to do that?\r\n  - Or the current stdin/stdout/stderr pipes? Or even more obscure and platform-specific global state?\r\n  - We might also think about the corner case where the caller sets some environment variables in `before_exec`. In that case those would be reflected in the child, _even if_ the parent environment was otherwise captured in `new`. Though maybe people who do interesting things in `before_exec` are already signing up for trouble?\r\n- Whether we decide to capture in `new` or capture in `spawn`, either is a potentially breaking change. But switching to `spawn` is maybe less risky; it can only affect callers who are already using the `env` methods (because the current capture is lazy).",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344979687/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/345496498",
    "html_url": "https://github.com/rust-lang/rust/issues/28975#issuecomment-345496498",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28975",
    "id": 345496498,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NTQ5NjQ5OA==",
    "user": {
      "login": "dtolnay",
      "id": 1940490,
      "node_id": "MDQ6VXNlcjE5NDA0OTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dtolnay",
      "html_url": "https://github.com/dtolnay",
      "followers_url": "https://api.github.com/users/dtolnay/followers",
      "following_url": "https://api.github.com/users/dtolnay/following{/other_user}",
      "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions",
      "organizations_url": "https://api.github.com/users/dtolnay/orgs",
      "repos_url": "https://api.github.com/users/dtolnay/repos",
      "events_url": "https://api.github.com/users/dtolnay/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dtolnay/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-19T06:58:27Z",
    "updated_at": "2017-11-19T06:58:27Z",
    "body": "I would be prepared to consider a PR that delays capturing environment variables from the parent process until `spawn`.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/345496498/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/352197853",
    "html_url": "https://github.com/rust-lang/rust/issues/28975#issuecomment-352197853",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28975",
    "id": 352197853,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MjE5Nzg1Mw==",
    "user": {
      "login": "Diggsey",
      "id": 451321,
      "node_id": "MDQ6VXNlcjQ1MTMyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/451321?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Diggsey",
      "html_url": "https://github.com/Diggsey",
      "followers_url": "https://api.github.com/users/Diggsey/followers",
      "following_url": "https://api.github.com/users/Diggsey/following{/other_user}",
      "gists_url": "https://api.github.com/users/Diggsey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Diggsey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Diggsey/subscriptions",
      "organizations_url": "https://api.github.com/users/Diggsey/orgs",
      "repos_url": "https://api.github.com/users/Diggsey/repos",
      "events_url": "https://api.github.com/users/Diggsey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Diggsey/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-12-16T17:33:08Z",
    "updated_at": "2017-12-16T17:33:08Z",
    "body": "@dtolnay I started implementing this, and found the reason for the odd behaviour: at the moment, the linux implementation provides the method `exec()` on `CommandExt`, and there is a comment indicating that this function should not allocate:\r\n\r\n```rust\r\n    // Currently we try hard to ensure that the call to `.exec()` doesn't\r\n    // actually allocate any memory. While many platforms try to ensure that\r\n    // memory allocation works after a fork in a multithreaded process, it's\r\n    // been observed to be buggy and somewhat unreliable, so we do our best to\r\n    // just not do it at all!\r\n    //\r\n    // Along those lines, the `argv` and `envp` raw pointers here are exactly\r\n    // what's gonna get passed to `execvp`. The `argv` array starts with the\r\n    // `program` and ends with a NULL, and the `envp` pointer, if present, is\r\n    // also null-terminated.\r\n    //\r\n    // Right now we don't support removing arguments, so there's no much fancy\r\n    // support there, but we support adding and removing environment variables,\r\n    // so a side table is used to track where in the `envp` array each key is\r\n    // located. Whenever we add a key we update it in place if it's already\r\n    // present, and whenever we remove a key we update the locations of all\r\n    // other keys.\r\n```\r\n\r\nI don't see a way to retain this (undocumented) guarantee if environment variables are captured at the point of spawn.\r\n\r\nHowever, my suspicion is that the comment may be referring to `do_exec()` rather than `exec()` - in that case it would be fine for `exec()` to allocate as only `do_exec()` is called after a fork. I'm going to implement the changes under this assumption.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/352197853/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/352456852",
    "html_url": "https://github.com/rust-lang/rust/issues/28975#issuecomment-352456852",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28975",
    "id": 352456852,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MjQ1Njg1Mg==",
    "user": {
      "login": "oconnor663",
      "id": 860932,
      "node_id": "MDQ6VXNlcjg2MDkzMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/860932?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/oconnor663",
      "html_url": "https://github.com/oconnor663",
      "followers_url": "https://api.github.com/users/oconnor663/followers",
      "following_url": "https://api.github.com/users/oconnor663/following{/other_user}",
      "gists_url": "https://api.github.com/users/oconnor663/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/oconnor663/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/oconnor663/subscriptions",
      "organizations_url": "https://api.github.com/users/oconnor663/orgs",
      "repos_url": "https://api.github.com/users/oconnor663/repos",
      "events_url": "https://api.github.com/users/oconnor663/events{/privacy}",
      "received_events_url": "https://api.github.com/users/oconnor663/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-12-18T15:21:39Z",
    "updated_at": "2017-12-18T15:21:39Z",
    "body": "@Diggsey I interpreted that comment to mean that no allocations should happen after `fork` is called. But `spawn` is able to do as much work as it wants before it eventually calls `fork`, so I think we can still do what we want?\r\n\r\nWhen I was playing with this, I was surprised that the implementations for `env` were completely duplicated across the different platform implementations, rather than having some sort of cross-platform `HashMap<OsString, OsString>` in the `Command` object itself. If I get back to this, the first thing I'll want to try is to putting more responsibility for args and env storage into `Command`, and making the platform-specific code deal only in temporaries. (Would that use an excessive amount of extra memory, to make copies? I'm not sure.)",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/352456852/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/352457949",
    "html_url": "https://github.com/rust-lang/rust/issues/28975#issuecomment-352457949",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28975",
    "id": 352457949,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MjQ1Nzk0OQ==",
    "user": {
      "login": "Diggsey",
      "id": 451321,
      "node_id": "MDQ6VXNlcjQ1MTMyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/451321?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Diggsey",
      "html_url": "https://github.com/Diggsey",
      "followers_url": "https://api.github.com/users/Diggsey/followers",
      "following_url": "https://api.github.com/users/Diggsey/following{/other_user}",
      "gists_url": "https://api.github.com/users/Diggsey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Diggsey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Diggsey/subscriptions",
      "organizations_url": "https://api.github.com/users/Diggsey/orgs",
      "repos_url": "https://api.github.com/users/Diggsey/repos",
      "events_url": "https://api.github.com/users/Diggsey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Diggsey/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-12-18T15:25:15Z",
    "updated_at": "2017-12-18T15:25:15Z",
    "body": "@oconnor0 That's basically what I implemented in #46789",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/352457949/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
