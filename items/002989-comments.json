[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7164308",
    "html_url": "https://github.com/rust-lang/rust/issues/2989#issuecomment-7164308",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/2989",
    "id": 7164308,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcxNjQzMDg=",
    "user": {
      "login": "Dretch",
      "id": 1428731,
      "node_id": "MDQ6VXNlcjE0Mjg3MzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1428731?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Dretch",
      "html_url": "https://github.com/Dretch",
      "followers_url": "https://api.github.com/users/Dretch/followers",
      "following_url": "https://api.github.com/users/Dretch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Dretch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Dretch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Dretch/subscriptions",
      "organizations_url": "https://api.github.com/users/Dretch/orgs",
      "repos_url": "https://api.github.com/users/Dretch/repos",
      "events_url": "https://api.github.com/users/Dretch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Dretch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-07-22T18:45:05Z",
    "updated_at": "2012-07-22T18:45:05Z",
    "body": "I have now done a little more investigation.\n\nUsing the following code, which is a simplified version of the original that also has some io::println added for debugging:\n\n```\nuse std;\n\ntrait methods {\n    fn to_bytes() -> ~[u8];\n}\n\nimpl of methods for () {\n    fn to_bytes() -> ~[u8] {\n        vec::from_elem(0, 0)\n    }\n}\n\n// the position of this function is significant! - if it comes before methods\n// then it works, if it comes after it then it doesnt!\nfn to_bools(bitv: {storage: ~[u64]}) -> ~[bool] {\n    vec::from_fn(8, |i| {\n        let w = i / 64;\n        let b = i % 64;\n        let x = 1u64 & (bitv.storage[w] >> b);\n        x == 1u64\n    })\n}\n\nfn main() {\n    let bools = ~[false, false, true, false, false, true, true, false];\n    let bools2 = to_bools({storage: ~[0b01100100]});\n\n    for uint::range(0, 8) |i| {\n        io::println(#fmt(\"%u => %u vs %u\", i, bools[i] as uint, bools2[i] as uint));\n    }\n\n    assert bools == bools2;\n}\n```\n\nCompilation without -O produces the expected output:\n\n```\ngareth@dimension:~/projects/tests$ rustc bitv2-test.rs && ./bitv2-test \n0 => 0 vs 0\n1 => 0 vs 0\n2 => 1 vs 1\n3 => 0 vs 0\n4 => 0 vs 0\n5 => 1 vs 1\n6 => 1 vs 1\n7 => 0 vs 0\n```\n\nAnd compilation with -O produces some strange output and an assertion failure:\n\n```\ngareth@dimension:~/projects/tests$ rustc -O bitv2-test.rs && ./bitv2-test \n0 => 0 vs 192\n1 => 0 vs 192\n2 => 1 vs 193\n3 => 0 vs 192\n4 => 0 vs 192\n5 => 1 vs 193\n6 => 1 vs 193\n7 => 0 vs 192\nrust: task failed at 'Assertion bools == bools2 failed', bitv2-test.rs:33\nrust: domain main @0x183ab80 root task failed\n```\n\nIts like the optimized code is producing bools that are off by 192.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7164308/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7314050",
    "html_url": "https://github.com/rust-lang/rust/issues/2989#issuecomment-7314050",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/2989",
    "id": 7314050,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMTQwNTA=",
    "user": {
      "login": "Dretch",
      "id": 1428731,
      "node_id": "MDQ6VXNlcjE0Mjg3MzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1428731?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Dretch",
      "html_url": "https://github.com/Dretch",
      "followers_url": "https://api.github.com/users/Dretch/followers",
      "following_url": "https://api.github.com/users/Dretch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Dretch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Dretch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Dretch/subscriptions",
      "organizations_url": "https://api.github.com/users/Dretch/orgs",
      "repos_url": "https://api.github.com/users/Dretch/repos",
      "events_url": "https://api.github.com/users/Dretch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Dretch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-07-27T19:30:10Z",
    "updated_at": "2012-07-27T19:30:10Z",
    "body": "Just in case this might be useful... when this code was inside std::bitv then the test suite failed valgrind with a bunch of stuff like:\n\n```\n==24424== Invalid write of size 8\n==24424==    at 0x554F76F: ev_run (ev.c:2198)\n==24424==    by 0x5541EB1: uv_run (core.c:212)\n==24424==    by 0x554100C: ??? (in /home/gareth/projects/dretch-rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so)\n==24424==  Address 0x6ddfb68 is 2,744 bytes inside a block of size 3,632 free'd\n==24424==    at 0x4C282E0: free (vg_replace_malloc.c:366)\n==24424==    by 0x552D3E6: rust_task::cleanup_after_turn() (rust_task.cpp:561)\n==24424==    by 0x5529ED4: rust_sched_loop::activate(rust_task*) (rust_sched_loop.cpp:47)\n==24424==    by 0x552A020: rust_sched_loop::run_single_turn() (rust_sched_loop.cpp:230)\n==24424==    by 0x552B704: rust_sched_driver::start_main_loop() (rust_sched_driver.cpp:28)\n==24424==    by 0x5524BB9: rust_thread_start(void*) (rust_thread.cpp:25)\n==24424==    by 0x63BFEFB: start_thread (pthread_create.c:304)\n==24424==    by 0x5A6A59C: clone (clone.S:112)\n==24424== \n==24424== Invalid write of size 4\n==24424==    at 0x554F701: ev_run (ev.c:1189)\n==24424==    by 0x5541EB1: uv_run (core.c:212)\n==24424==    by 0x554100C: ??? (in /home/gareth/projects/dretch-rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so)\n==24424==  Address 0x6ddfb48 is 2,712 bytes inside a block of size 3,632 free'd\n==24424==    at 0x4C282E0: free (vg_replace_malloc.c:366)\n==24424==    by 0x552D3E6: rust_task::cleanup_after_turn() (rust_task.cpp:561)\n==24424==    by 0x5529ED4: rust_sched_loop::activate(rust_task*) (rust_sched_loop.cpp:47)\n==24424==    by 0x552A020: rust_sched_loop::run_single_turn() (rust_sched_loop.cpp:230)\n==24424==    by 0x552B704: rust_sched_driver::start_main_loop() (rust_sched_driver.cpp:28)\n==24424==    by 0x5524BB9: rust_thread_start(void*) (rust_thread.cpp:25)\n==24424==    by 0x63BFEFB: start_thread (pthread_create.c:304)\n==24424==    by 0x5A6A59C: clone (clone.S:112)\n==24424== \n==24424== Invalid read of size 4\n==24424==    at 0x554BB93: ev_feed_event (ev.c:900)\n==24424==    by 0x554F851: ev_run (ev.c:924)\n==24424==    by 0x5541EB1: uv_run (core.c:212)\n==24424==    by 0x554100C: ??? (in /home/gareth/projects/dretch-rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so)\n==24424==  Address 0x6ddfb50 is 2,720 bytes inside a block of size 3,632 free'd\n==24424==    at 0x4C282E0: free (vg_replace_malloc.c:366)\n==24424==    by 0x552D3E6: rust_task::cleanup_after_turn() (rust_task.cpp:561)\n==24424==    by 0x5529ED4: rust_sched_loop::activate(rust_task*) (rust_sched_loop.cpp:47)\n==24424==    by 0x552A020: rust_sched_loop::run_single_turn() (rust_sched_loop.cpp:230)\n==24424==    by 0x552B704: rust_sched_driver::start_main_loop() (rust_sched_driver.cpp:28)\n==24424==    by 0x5524BB9: rust_thread_start(void*) (rust_thread.cpp:25)\n==24424==    by 0x63BFEFB: start_thread (pthread_create.c:304)\n==24424==    by 0x5A6A59C: clone (clone.S:112)\n==24424== \n==24424== Invalid read of size 4\n==24424==    at 0x554BB97: ev_feed_event (ev.c:902)\n==24424==    by 0x554F851: ev_run (ev.c:924)\n==24424==    by 0x5541EB1: uv_run (core.c:212)\n==24424==    by 0x554100C: ??? (in /home/gareth/projects/dretch-rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so)\n==24424==  Address 0x6ddfb4c is 2,716 bytes inside a block of size 3,632 free'd\n==24424==    at 0x4C282E0: free (vg_replace_malloc.c:366)\n==24424==    by 0x552D3E6: rust_task::cleanup_after_turn() (rust_task.cpp:561)\n==24424==    by 0x5529ED4: rust_sched_loop::activate(rust_task*) (rust_sched_loop.cpp:47)\n==24424==    by 0x552A020: rust_sched_loop::run_single_turn() (rust_sched_loop.cpp:230)\n==24424==    by 0x552B704: rust_sched_driver::start_main_loop() (rust_sched_driver.cpp:28)\n==24424==    by 0x5524BB9: rust_thread_start(void*) (rust_thread.cpp:25)\n==24424==    by 0x63BFEFB: start_thread (pthread_create.c:304)\n==24424==    by 0x5A6A59C: clone (clone.S:112)\n==24424== \n==24424== Invalid read of size 4\n==24424==    at 0x554BBAD: ev_feed_event (ev.c:906)\n==24424==    by 0x554F851: ev_run (ev.c:924)\n==24424==    by 0x5541EB1: uv_run (core.c:212)\n==24424==    by 0x554100C: ??? (in /home/gareth/projects/dretch-rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so)\n==24424==  Address 0x227ab8bc is not stack'd, malloc'd or (recently) free'd\n==24424== \n==24424== \n==24424== Process terminating with default action of signal 11 (SIGSEGV)\n==24424==  Access not within mapped region at address 0x227AB8BC\n==24424==    at 0x554BBAD: ev_feed_event (ev.c:906)\n==24424==    by 0x554F851: ev_run (ev.c:924)\n==24424==    by 0x5541EB1: uv_run (core.c:212)\n==24424==    by 0x554100C: ??? (in /home/gareth/projects/dretch-rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustc/x86_64-unknown-linux-gnu/lib/librustrt.so)\n==24424==  If you believe this happened as a result of a stack\n==24424==  overflow in your program's main thread (unlikely but\n==24424==  possible), you can try to increase the size of the\n==24424==  main thread stack using the --main-stacksize= flag.\n==24424==  The main thread stack size used in this run was 16777216.\nmake: *** [check-stage2-T-x86_64-unknown-linux-gnu-H-x86_64-unknown-linux-gnu-std-dummy] Killed\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7314050/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/8213187",
    "html_url": "https://github.com/rust-lang/rust/issues/2989#issuecomment-8213187",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/2989",
    "id": 8213187,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMTMxODc=",
    "user": {
      "login": "Dretch",
      "id": 1428731,
      "node_id": "MDQ6VXNlcjE0Mjg3MzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1428731?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Dretch",
      "html_url": "https://github.com/Dretch",
      "followers_url": "https://api.github.com/users/Dretch/followers",
      "following_url": "https://api.github.com/users/Dretch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Dretch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Dretch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Dretch/subscriptions",
      "organizations_url": "https://api.github.com/users/Dretch/orgs",
      "repos_url": "https://api.github.com/users/Dretch/repos",
      "events_url": "https://api.github.com/users/Dretch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Dretch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-09-01T14:08:34Z",
    "updated_at": "2012-09-01T14:08:34Z",
    "body": "This now seems to be fixed - the assertion failures that were occurring in the examples above no longer seem to happen.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/8213187/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/8216590",
    "html_url": "https://github.com/rust-lang/rust/issues/2989#issuecomment-8216590",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/2989",
    "id": 8216590,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMTY1OTA=",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-09-01T21:10:38Z",
    "updated_at": "2012-09-01T21:10:38Z",
    "body": "Thanks for following up on this @Dretch. I added the test case.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/8216590/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
