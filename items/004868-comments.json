[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13403887",
    "html_url": "https://github.com/rust-lang/rust/issues/4868#issuecomment-13403887",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/4868",
    "id": 13403887,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNDAzODg3",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-11T21:26:56Z",
    "updated_at": "2013-02-11T21:26:56Z",
    "body": "To return that borrowed pointer you must prove to the compiler that it lives in a region further up the stack, which requires baking that knowledge into the call signature of your callback.\n\nThe code in question, slightly modified and annotated\n\n```\ndo draw_each(screen, map) |position : map::Position, _ : map::Tile| {\n    if player.sees(position) {\n        // This pointer must provably be valid in the caller's stack frame, which means that it must be in a region\n        // that is known to the caller.\n        let thing = &*fog;\n        Some(thing)\n    } else {\n        None\n    }\n}\n\n// The draw each signature\nfn draw_each(screen : &video::Surface, map : &mut map::Map,\n                       f : fn(position : map::Position, tile : map::Tile) -> Option<&video::Surface>) { ... }\n```\n\nIn order to make a return value have a valid region in the caller's frame we must annotate the regions in the function signature, in this case the callback to `draw_each`:\n\n```\nfn(position : map::Position, tile : map::Tile) -> Option<&video::Surface>)\n```\n\n(note this should probably be written `&fn` - I'm not even sure what bare `fn` means right now).\n\nThis signature says we're returning an optional region pointer, but doesn't indicate which region that pointer is in. As written it is (mostly) impossible to write the body of this function because there's no way to aquire a region that point's into a frame that is still valid when the function returns. In order to do that you need to tie the region to either `position` or `tile`, like so\n\n```\n&fn(position: &a/map::Position, tile: map::Tile) -> Option<&a/video::Surface>\n```\n\nThe `&a/`'s indicate that we're going to return a pointer back into the `Position` struct who's region is known.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13403887/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13408192",
    "html_url": "https://github.com/rust-lang/rust/issues/4868#issuecomment-13408192",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/4868",
    "id": 13408192,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNDA4MTky",
    "user": {
      "login": "dpc",
      "id": 9209,
      "node_id": "MDQ6VXNlcjkyMDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9209?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dpc",
      "html_url": "https://github.com/dpc",
      "followers_url": "https://api.github.com/users/dpc/followers",
      "following_url": "https://api.github.com/users/dpc/following{/other_user}",
      "gists_url": "https://api.github.com/users/dpc/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dpc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dpc/subscriptions",
      "organizations_url": "https://api.github.com/users/dpc/orgs",
      "repos_url": "https://api.github.com/users/dpc/repos",
      "events_url": "https://api.github.com/users/dpc/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dpc/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-11T22:51:20Z",
    "updated_at": "2013-02-11T22:51:41Z",
    "body": "Tying to the `position` or `title` didn't work. But you shed some light on the nature of the problem and tying to the `fn` itself works for me. The following:\n\n```\n-       f : fn(position : map::Position, tile : map::Tile) -> Option<&video::Surface>)\n+       f : &a/fn(position : map::Position, tile : map::Tile) -> Option<&a/video::Surface>)\n```\n\nFixes my problem. Thank you! :)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13408192/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
