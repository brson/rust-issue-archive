[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13815200",
    "html_url": "https://github.com/rust-lang/rust/pull/5047#issuecomment-13815200",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5047",
    "id": 13815200,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODE1MjAw",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-20T04:23:13Z",
    "updated_at": "2013-02-20T04:23:13Z",
    "body": "Ah, right. Will fix tomorrow.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13815200/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13824312",
    "html_url": "https://github.com/rust-lang/rust/pull/5047#issuecomment-13824312",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5047",
    "id": 13824312,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODI0MzEy",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-20T10:07:43Z",
    "updated_at": "2013-02-20T10:46:56Z",
    "body": "@brson: Here's a simpler test case that also triggers the issue:\n\n```\nenum Variant { A, B(~u16) }\n\npub struct Blob {\n    desc: Variant,\n    sig: Variant\n}\n\n#[inline(never)]\nfn bar() -> Variant { A }\n\nfn main() {\n    let a = bar();\n    let _b = Blob {\n        desc: B(~5),\n        sig: copy a\n    };\n}\n```\n\nRemoving the `copy` or allowing `bar()` to be inlined causes valid code to be generated, but I really don't understand what goes wrong when the copy happens...\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13824312/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13842368",
    "html_url": "https://github.com/rust-lang/rust/pull/5047#issuecomment-13842368",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5047",
    "id": 13842368,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODQyMzY4",
    "user": {
      "login": "pcwalton",
      "id": 157897,
      "node_id": "MDQ6VXNlcjE1Nzg5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pcwalton",
      "html_url": "https://github.com/pcwalton",
      "followers_url": "https://api.github.com/users/pcwalton/followers",
      "following_url": "https://api.github.com/users/pcwalton/following{/other_user}",
      "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions",
      "organizations_url": "https://api.github.com/users/pcwalton/orgs",
      "repos_url": "https://api.github.com/users/pcwalton/repos",
      "events_url": "https://api.github.com/users/pcwalton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pcwalton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-20T16:49:17Z",
    "updated_at": "2013-02-20T16:49:17Z",
    "body": "Let me copy and paste my email to the core team:\n\nOK, I think I've figured it out. It seems to be a slightly sketchy, but harmless in this case, LLVM optimization. Here is the testcase:\n\n```\npub struct VariantDoc {\n    desc: Option<~str>,\n    sig: Option<~str>\n}\n\nfn main() {\n    let variants = ~[\n        VariantDoc {\n            desc: None,\n            sig: None\n        }\n    ];\n\n    let _ = do vec::map(variants) |variant| {\n        let new_variant = copy *variant;\n        let result = VariantDoc {\n            desc: None,\n            sig: None,\n        };\n        io::println(\"vvv\");\n        result\n    };\n    io::println(\"^^^\");\n}\n```\n\n(The error occurs in between 'vvv' and '^^^').\n\nThe conditional uninitialized branch occurs as part of inlined drop glue. Here is the annotated assembly:\n\n```\n0x0000000100000da6 <_rust_main+54>:    lea    rdi,[rbp-0x70]\n0x0000000100000daa <_rust_main+58>:    lea    r14,[rip+0x12cf]        # 0x100002080 <tydesc_1980>\n0x0000000100000db1 <_rust_main+65>:    mov    rdx,r14\n0x0000000100000db4 <_rust_main+68>:    mov    ecx,0x90\n0x0000000100000db9 <_rust_main+73>:    call   0x100001c04 <dyld_stub__ZN2rt18rt_exchange_malloc16_63f842b316661113_06E> ; allocate\n0x0000000100000dbe <_rust_main+78>:    mov    rbx,QWORD PTR [rbp-0x70] ; rbx = result of malloc\n... straight line code ...\n0x0000000100000ddd <_rust_main+109>:    mov    QWORD PTR [rbx+0x30],0x0 ; store None tag\n... straight line code ...\n0x0000000100000dfa <_rust_main+138>:    lea    rbx,[rbx+0x20] ; skip over allocation header\n... straight line code ...\n0x0000000100000e66 <_rust_main+246>:    mov    rax,QWORD PTR [rbx+0x10] ; rax = None tag\n0x0000000100000e6a <_rust_main+250>:    mov    QWORD PTR [rbp-0xa0],rax ; copy None tag to new variant\n0x0000000100000e71 <_rust_main+257>:    mov    QWORD PTR [rbp-0x98],rbx\n0x0000000100000e78 <_rust_main+264>:    mov    rbx,QWORD PTR [rbx+0x18] ; rbx = eagerly load value of the ~str (which is undefined since the tag discriminant is None)\n0x0000000100000e7c <_rust_main+268>:    cmp    rax,0x1 ; was tag Some?\n0x0000000100000e80 <_rust_main+272>:    jne    0x100000ebe ; taken <_rust_main+334> ;\n...\n0x0000000100000ebe <_rust_main+334>:    mov    r12,rbx ; r12 = undefined value of ~str\n... straight line code ...\n0x0000000100000f23 <_rust_main+435>:    cmp    QWORD PTR [rbp-0xa0],0x1 ; is tag Some?\n0x0000000100000f2b <_rust_main+443>:    setne  al ; invert previous check; al is now 1 iff tag is *None* (i.e. al is always 1)\n0x0000000100000f2e <_rust_main+446>:    test   r12,r12 ; is tag None?\n0x0000000100000f31 <_rust_main+449>:    je     0x100000f3f <_rust_main+463> ; ***valgrind error***; conditional branch depends on undefined value. Here, we are checking to see whether the pointer is NULL.\n0x0000000100000f33 <_rust_main+451>:    test   al,al ; is tag None?\n0x0000000100000f35 <_rust_main+453>:    jne    0x100000f3f <_rust_main+463> ; taken\n0x0000000100000f37 <_rust_main+455>:    mov    rdx,r12\n0x0000000100000f3a <_rust_main+458>:    call   0x100001bfe <dyld_stub__ZN2rt16rt_exchange_free17_bea361ae477736593_06E> ; free the allocation\n0x0000000100000f3f <_rust_main+463>:    cmp    QWORD PTR [rbp-0x90],0x1\n```\n\nSo, as you can see, it is undefined whether the first branch (at _rust_main+449) is taken or not taken, but even if it isn't taken the second branch (at _rust_main+453) will always be taken, and it goes to the same spot. Thus we always end up at _rust_main+463 safely and don't try to free a wild pointer.\n\nIn pseudocode, the compiler reordered \"is the variant Some? if so, is the string pointer non-null?\" into \"is the string pointer non-null? if so, is the variant Some?\" The answer to the question of whether the string pointer is non-null is undefined, since we didn't store anything there. But it doesn't matter because the code does nothing unless both conditions hold.\n\nThe reason why strcat's change triggered this is that we started inlining glue, which triggered scalar replacement of aggregates and LLVM started performing more clever optimizations regarding tag discriminants and the ~str. Basically, LLVM promoted them to registers. (Notice how ~str stayed in r12 across basic blocks above.) Because it then saw SSA values and not memory it started reordering things. This isn't harmful, but it tipped off Valgrind.\n\nSo yeah, this seems harmless. How to suppress it in valgrind is another story...\n\nPatrick\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13842368/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/16278408",
    "html_url": "https://github.com/rust-lang/rust/pull/5047#issuecomment-16278408",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5047",
    "id": 16278408,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2Mjc4NDA4",
    "user": {
      "login": "sanxiyn",
      "id": 45249,
      "node_id": "MDQ6VXNlcjQ1MjQ5",
      "avatar_url": "https://avatars.githubusercontent.com/u/45249?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sanxiyn",
      "html_url": "https://github.com/sanxiyn",
      "followers_url": "https://api.github.com/users/sanxiyn/followers",
      "following_url": "https://api.github.com/users/sanxiyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/sanxiyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sanxiyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sanxiyn/subscriptions",
      "organizations_url": "https://api.github.com/users/sanxiyn/orgs",
      "repos_url": "https://api.github.com/users/sanxiyn/repos",
      "events_url": "https://api.github.com/users/sanxiyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sanxiyn/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-12T06:54:04Z",
    "updated_at": "2013-04-12T06:54:04Z",
    "body": "[LLVM bug 12319](http://llvm.org/bugs/show_bug.cgi?id=12319) seems to be about the same Valgrind issue.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/16278408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/16312887",
    "html_url": "https://github.com/rust-lang/rust/pull/5047#issuecomment-16312887",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5047",
    "id": 16312887,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MzEyODg3",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-12T19:31:19Z",
    "updated_at": "2013-04-12T19:31:19Z",
    "body": "@sanxiyn thanks for finding that!\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/16312887/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
