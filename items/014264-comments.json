[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43425002",
    "html_url": "https://github.com/rust-lang/rust/pull/14264#issuecomment-43425002",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/14264",
    "id": 43425002,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDI1MDAy",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-17T21:45:58Z",
    "updated_at": "2014-05-17T21:47:29Z",
    "body": "This is only more efficient when you're doing a single mutation to the vector. If you push anything else to the vector afterwards, then it's markedly less efficient:\n\n``` rust\nlet v = Vec::new();\nv.grow(10, false);\nv.grow(6, true);\n```\n\nYou cannot assume that any given operation that lengthens a vector is the only operation that's going to be applied. In fact, it's relatively common to append several collections to a vector in a row.\n\nIf you know you're only going to be doing the one mutation operation, you can use `.reserve_exact()` ahead of time to avoid the excess capacity. But `libstd` doesn't have enough knowledge to know when this is appropriate. Only clients of the library can make that call.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43425002/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43429927",
    "html_url": "https://github.com/rust-lang/rust/pull/14264#issuecomment-43429927",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/14264",
    "id": 43429927,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDI5OTI3",
    "user": {
      "login": "stepancheg",
      "id": 28969,
      "node_id": "MDQ6VXNlcjI4OTY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/28969?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stepancheg",
      "html_url": "https://github.com/stepancheg",
      "followers_url": "https://api.github.com/users/stepancheg/followers",
      "following_url": "https://api.github.com/users/stepancheg/following{/other_user}",
      "gists_url": "https://api.github.com/users/stepancheg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stepancheg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stepancheg/subscriptions",
      "organizations_url": "https://api.github.com/users/stepancheg/orgs",
      "repos_url": "https://api.github.com/users/stepancheg/repos",
      "events_url": "https://api.github.com/users/stepancheg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stepancheg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-18T02:47:26Z",
    "updated_at": "2014-05-18T02:49:31Z",
    "body": "@kballard Consider `a.push_all(b)` Basically, there are two mutually exclusive cases:\n1. `a.len() <= b.len()`. In this case patched `reserve` is as efficient as original `reserve` \n   statistically: for random sets of lengths of `a` and `b`. For example, patched `reserve` loses in `grow(10); grow(6);` and wins in `grow(10); grow(7);`\n2. `a.len() < b.len()`. In this case patched `reserve` is clear winner.\n\nSince probablility of case 2 is greater than zero, patched `reserve` is statistically better.\n\n`reserve_exact` is not panacea, because `reserve*` are rarely used directly, but rather implicitly in `push_all`, `push_all_move`, `append` and similar operations.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43429927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43430040",
    "html_url": "https://github.com/rust-lang/rust/pull/14264#issuecomment-43430040",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/14264",
    "id": 43430040,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDMwMDQw",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-18T02:56:00Z",
    "updated_at": "2014-05-18T02:56:00Z",
    "body": "@stepancheg \n\nAsymptotically? Vectors don't grow asymptotically. And the patched `reserve` doesn't win in `grow(10); grow(7);`. Both the original and the patched behavior has to reallocate on the `grow(7)`, which means that it's at best a tie. Although the patched `reserve` will end up with a capacity of `20` and the original with a capacity of `32`. In the general case, it's hard to say which is better (it largely depends on whether the vector will continue to grow).\n\nI also disagree that the `a.len() < b.len()` case is a \"clear winner\". This is equivalent to the `grow(7)` case, in that both approaches will have to reallocate, but the patched `reserve` will end up with a smaller capacity. In fact, the patched `reserve` is very likely to be worse-performing here, because even appending a single element will require another reallocation (as it did an exact reserve).\n\nWhich is to say, once again, the patched `reserve` definitively loses if you have to grow the vector again.\n\nBut of course we're also missing the obvious reason why this is bad, which is that it's disregarding proper allocator behavior. Allocating powers of 2 is generally the best way to handle allocators (although I believe @thestinger has indicated that, for jemalloc, we should actually be using powers of 2 only once the allocation size is >=4096, and should be using a different scheme with IIRC a 1.5x multiplier below that).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43430040/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43430474",
    "html_url": "https://github.com/rust-lang/rust/pull/14264#issuecomment-43430474",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/14264",
    "id": 43430474,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDMwNDc0",
    "user": {
      "login": "stepancheg",
      "id": 28969,
      "node_id": "MDQ6VXNlcjI4OTY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/28969?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stepancheg",
      "html_url": "https://github.com/stepancheg",
      "followers_url": "https://api.github.com/users/stepancheg/followers",
      "following_url": "https://api.github.com/users/stepancheg/following{/other_user}",
      "gists_url": "https://api.github.com/users/stepancheg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stepancheg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stepancheg/subscriptions",
      "organizations_url": "https://api.github.com/users/stepancheg/orgs",
      "repos_url": "https://api.github.com/users/stepancheg/repos",
      "events_url": "https://api.github.com/users/stepancheg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stepancheg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-18T03:29:35Z",
    "updated_at": "2014-05-18T03:29:35Z",
    "body": "@kballard I meant statistically.\n\n> Although the patched reserve will end up with a capacity of 20 and the original with a capacity of 32. In the general case, it's hard to say which is better (it largely depends on whether the vector will continue to grow).\n> \n> I also disagree that the a.len() < b.len() case is a \"clear winner\". This is equivalent to the grow(7) case, in that both approaches will have to reallocate, but the patched reserve will end up with a smaller capacity. In fact, the patched reserve is very likely to be worse-performing here, because even appending a single element will require another reallocation (as it did an exact reserve).\n\nIf vector continues to grow, it is a tie (statistically).\n\n> Which is to say, once again, the patched reserve definitively loses if you have to grow the vector again.\n\nNo, it is not. It has the same number of reallocations and the same average capacity overhead. Patched `realloc` wins if last `push` pushes more than vec already contains.\n\n> But of course we're also missing the obvious reason why this is bad, which is that it's disregarding proper allocator behavior. Allocating powers of 2 is generally the best way to handle allocators (although I believe @thestinger has indicated that, for jemalloc, we should actually be using powers of 2 only once the allocation size is >=4096, and should be using a different scheme with IIRC a 1.5x multiplier below that).\n\nI guess, it is quite the contrary: allocators use powers of two for small allocations. But it is not important right now, and you made a good point.\n\nBTW, if rust's going to rely on implementation details of concrete allocator (jemalloc), I suppose it should query allocator for actual allocated memory size (something like, `je_sallocx` function) and store it in vector `cap` field. In this case, patched `realloc` will be even better.\n\nAnyway, I think this patch is not very important, so I better close this PR.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43430474/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43431584",
    "html_url": "https://github.com/rust-lang/rust/pull/14264#issuecomment-43431584",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/14264",
    "id": 43431584,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDMxNTg0",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-18T05:05:24Z",
    "updated_at": "2014-05-18T05:06:45Z",
    "body": "@kballard: The crossover point is actually far larger than 4096 bytes, but otherwise you're remembering correctly. Using two as the multiplier is the worst case at small sizes because it misses any chance to do in-place growth.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43431584/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
