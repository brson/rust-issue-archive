{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/27003",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27003/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27003/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27003/events",
  "html_url": "https://github.com/rust-lang/rust/pull/27003",
  "id": 94626200,
  "node_id": "MDExOlB1bGxSZXF1ZXN0Mzk3NzU2MzQ=",
  "number": 27003,
  "title": "Add a Cargo-based build system to replace the Makefiles",
  "user": {
    "login": "cl91",
    "id": 3608694,
    "node_id": "MDQ6VXNlcjM2MDg2OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3608694?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cl91",
    "html_url": "https://github.com/cl91",
    "followers_url": "https://api.github.com/users/cl91/followers",
    "following_url": "https://api.github.com/users/cl91/following{/other_user}",
    "gists_url": "https://api.github.com/users/cl91/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cl91/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cl91/subscriptions",
    "organizations_url": "https://api.github.com/users/cl91/orgs",
    "repos_url": "https://api.github.com/users/cl91/repos",
    "events_url": "https://api.github.com/users/cl91/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cl91/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 9,
  "created_at": "2015-07-13T02:57:32Z",
  "updated_at": "2015-08-31T13:57:19Z",
  "closed_at": "2015-07-15T21:19:02Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/27003",
    "html_url": "https://github.com/rust-lang/rust/pull/27003",
    "diff_url": "https://github.com/rust-lang/rust/pull/27003.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/27003.patch",
    "merged_at": null
  },
  "body": "This pull request adds a Cargo-based build system, in parallel to the old Makefile-based one. The two build systems should be able to function alongside each other, but it is preferred to use the new one and the Makefiles will be deleted once the new system has been thoroughly tested and is considered mature enough.\n\nOn a high-level, this pull request:\n1. Adds the necessary `Cargo.toml` files to convert the crates into Cargo packages.\n2. Adds a Cargo build script if building and linking native runtime libraries is required.\n3. Adds a Python script `etc/build_llvm.py` to drive the LLVM build system.\n4. Adds a driver script `etc/build_rust.py` to drive the whole system. This driver script will parse the command line arguments, build LLVM, and then invoke Cargo to bootstrap the compiler, build the docs, and build and run the compiler tests and library tests.\n\nThe new build system offers a number of advantages over the old one. They include:\n1. Being a lot simpler and easier to understand and hack.\n2. Reuses the Cargo infrastructure and makes it easier to move the built-in crates into crates.io\n3. Cross-bootstrapping is as simple as doing `cargo build --target=<target-triple>`\n4. Much easier to run the `libstd` tests without bootstrapping the compiler. This can save quite some time when you are developing the standard library.\n5. Reduces the build-time dependencies, by not depending on `make` and other Unix tools when they are unavailable. You can now build the compiler under a standard Windows command line window, without having MSYS2 installed (see [the list in the tracking Windows issue](https://github.com/rust-lang/rfcs/issues/1061)).\n\nThere are a number of technical differences between the two build systems:\n1. Instead of bootstrapping from a stage0 snapshot, we use the latest Rust nightly (which includes both `rustc` and `cargo`). Because the stage0 compiler is already a hosted compiler (instead of a freestanding one), there is no need to go through the staged api and compile a hosted stage0 compiler. Instead we will simply use nightly to compile the stage1 compiler and then use the stage1 compiler to compile the stage2 compiler.\n2. The compiler executables (`rustc` and `rustdoc`) will be statically linked against the standard library and compiler crates. This is the default behaviour of Cargo. It also makes it easier to redistribute the compiler as there won't be any dylib dependencies of the executables, although it doesn't really make the distribution smaller (they have roughly the same size on release builds as I measured).\n3. For release builds, the compiler and standard crates are compiled with `opt-level=3` and `lto=true`, to make them faster.\n4. When building `compiler-rt`, we will not use the builtin Makefiles and instead invoke the C toolchain directly. This is much simpler and works on platforms where gnu `make` is not universally available. This requires an update to the `compiler-rt` source by adding a small header file which is missing for Windows (it is available for Linux and darwin), because the standalone mingw doesn't include it.\n\nCurrent limitations of the new system:\n1. Although the code is written in a way that should be able to handle MSVC, currently it won't work as Cargo cannot pass `-C link-args=-DEF:` to rustc. This requires extending Cargo and support for MSVC will come in pull requests to follow.\n2. Although in theory cross-bootstrapping is as simple as invoking `cargo build --target=<target-triple>`, and the code is written to handle cross-bootstrapping properly, in practice there will be platform differences. Therefore cross-bootstrapping needs a lot more testing than it currently has.\n\nTo test, one needs to\n1. Pull https://github.com/rust-lang/cargo/pull/1802 and recompile Cargo.\n2. You will also need to pull https://github.com/rust-lang/compiler-rt/pull/9 if you want to build on Windows.\n3. On a Unix-based system, run\n   \n   ``` sh\n   $ ./build.sh\n   ```\n   \n   On Windows, open a command line window and run\n   \n   ```\n   python src\\etc\\build_rust.py\n   ```\n   \n   To see a list of supported options, pass `--help` to the build script. For instance, you might want to use `--enable-debug` to build with debug profile (the default is to build with the release profile).\n\nSee also the discussion in https://github.com/rust-lang/rust/pull/26493.\n\nr? @alexcrichton \n",
  "closed_by": {
    "login": "cl91",
    "id": 3608694,
    "node_id": "MDQ6VXNlcjM2MDg2OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3608694?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cl91",
    "html_url": "https://github.com/cl91",
    "followers_url": "https://api.github.com/users/cl91/followers",
    "following_url": "https://api.github.com/users/cl91/following{/other_user}",
    "gists_url": "https://api.github.com/users/cl91/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cl91/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cl91/subscriptions",
    "organizations_url": "https://api.github.com/users/cl91/orgs",
    "repos_url": "https://api.github.com/users/cl91/repos",
    "events_url": "https://api.github.com/users/cl91/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cl91/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/27003/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27003/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
