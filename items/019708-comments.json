[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66509110",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66509110",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66509110,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTA5MTEw",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T19:32:03Z",
    "updated_at": "2014-12-10T19:32:03Z",
    "body": "I requested @Gankro remove his r+ because I have some reservations about this move. Specifically, I plan on deprecating the `into_string` method on `&str` in the upcoming `std::str` stabilization. It is not necessarily the correct name for the method as it's not actually consuming `&str` (which the `into_` prefix implies). \n\nThe `into_string` method is a relic of an era where owned and borrowed strings were generically programmed over. Today we much prefer taking `&str` wherever possible (I believe it's even a convention) instead of `String`. What this is getting at is that from an API perspective, I believe `into_string` is not the right method for the job here.\n\nI'll also note that calling `.into_string` clashes with the usage of `fmt::Show` to go from an arbitrary type to a `String`, when `.to_string()` must still be used.\n\nIn terms of performance, the `to_string()` problem definitely exists, but I would like to see concrete numbers about runtime or memory usage which strongly argue for a fix _now_. It's possible to improve the `std::fmt` system in the future, but it's not a priority at this time as we have many other parts of the standard library that need to be standardized. Out of curiosity, did you happen to collect some numbers along the way with respect to this change?\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66509110/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66512603",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66512603",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66512603,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTEyNjAz",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T19:53:27Z",
    "updated_at": "2014-12-10T19:53:27Z",
    "body": "`to_string()` does many reallocations instead of reserving space with a size hint which is a major performance issue, especially for large strings. You don't need numbers specific to this case to know that it's a problem.\n\nThe only thing that's unknown is the additional cost of the formatting infrastructure on top of the memory allocations, but I think it's going to be insignificant relative to the cost of memory allocation.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66512603/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66513296",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66513296",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66513296,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTEzMjk2",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T19:57:28Z",
    "updated_at": "2014-12-10T19:57:28Z",
    "body": "The fact that it over-allocates up to the next power of 2 makes it easy to calculate the excess memory usage. Just take a look at the size classes here:\n\nhttps://github.com/jemalloc/jemalloc/blob/9b41ac909facf4f09bb1b637b78ba647348e572e/doc/jemalloc.xml.in#L540-L655\n\nAn 85 byte string will consume 160 bytes instead of 96 bytes, a 4.5MiB string will consume 8MiB instead of 5MiB and so on.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66513296/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66515340",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66515340",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66515340,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTE1MzQw",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T20:09:35Z",
    "updated_at": "2014-12-10T20:09:35Z",
    "body": "> The only thing that's unknown is the additional cost of the formatting infrastructure on top of the memory allocations, but I think it's going to be insignificant relative to the cost of memory allocation.\n\n(If it only did 1 allocation, then this would actually matter)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66515340/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66542978",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66542978",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66542978,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTQyOTc4",
    "user": {
      "login": "tbu-",
      "id": 6666593,
      "node_id": "MDQ6VXNlcjY2NjY1OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6666593?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbu-",
      "html_url": "https://github.com/tbu-",
      "followers_url": "https://api.github.com/users/tbu-/followers",
      "following_url": "https://api.github.com/users/tbu-/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbu-/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbu-/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbu-/subscriptions",
      "organizations_url": "https://api.github.com/users/tbu-/orgs",
      "repos_url": "https://api.github.com/users/tbu-/repos",
      "events_url": "https://api.github.com/users/tbu-/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbu-/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T23:17:51Z",
    "updated_at": "2014-12-10T23:18:06Z",
    "body": "A quick benchmark shows the opposite, I have no idea why:\n\n```\n$ ./a --bench\n\nrunning 6 tests\ntest bench_long_direct       ... bench:  42474438 ns/iter (+/- 818109) = 17 MB/s\ntest bench_long_via_format   ... bench:   9322190 ns/iter (+/- 388832) = 80 MB/s\ntest bench_medium_direct     ... bench:     42862 ns/iter (+/- 1327) = 17 MB/s\ntest bench_medium_via_format ... bench:      9349 ns/iter (+/- 282) = 80 MB/s\ntest bench_short_direct      ... bench:       871 ns/iter (+/- 29) = 13 MB/s\ntest bench_short_via_format  ... bench:       344 ns/iter (+/- 9) = 34 MB/s\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 6 measured\n```\n\n`a.rs`:\n\n```\nextern crate test;\n\nconst TEXT: &'static str = \"Hello World!\";\nconst LONG_TEXT: &'static str = \"\nThere are not many persons who know what wonders are opened to them in the\nstories and visions of their youth; for when as children we listen and dream,\nwe think but half-formed thoughts, and when as men we try to remember, we are\ndulled and prosaic with the poison of life. But some of us awake in the night\nwith strange phantasms of enchanted hills and gardens, of fountains that sing\nin the sun, of golden cliffs overhanging murmuring seas, of plains that stretch\ndown to sleeping cities of bronze and stone, and of shadowy companies of heroes\nthat ride caparisoned white horses along the edges of thick forests; and then\nwe know that we have looked back through the ivory gates into that world of\nwonder which was ours before we were wise and unhappy.\";\n\nfn bench_direct(b: &mut test::Bencher, string: &str) {\n    b.iter(|| {\n        test::black_box(string.into_string());\n    });\n    b.bytes = string.as_bytes().len().to_u64().unwrap();\n}\n\nfn bench_via_format(b: &mut test::Bencher, string: &str) {\n    b.iter(|| {\n        test::black_box(string.to_string());\n    });\n    b.bytes = string.as_bytes().len().to_u64().unwrap();\n}\n\nfn very_long_string() -> String {\n    let mut s = String::with_capacity(LONG_TEXT.len() * 1000);\n    for _ in range(0u32, 1000) {\n        s.push_str(LONG_TEXT);\n    }\n    s\n}\n\n#[bench] fn bench_short_direct(b: &mut test::Bencher) { bench_direct(b, TEXT); }\n#[bench] fn bench_short_via_format(b: &mut test::Bencher) { bench_via_format(b, TEXT); }\n\n#[bench] fn bench_medium_direct(b: &mut test::Bencher) { bench_direct(b, LONG_TEXT); }\n#[bench] fn bench_medium_via_format(b: &mut test::Bencher) { bench_via_format(b, LONG_TEXT); }\n\n#[bench] fn bench_long_direct(b: &mut test::Bencher) { bench_direct(b, very_long_string().as_slice()); }\n#[bench] fn bench_long_via_format(b: &mut test::Bencher) { bench_via_format(b, very_long_string().as_slice()); }\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66542978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66543191",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66543191",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66543191,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTQzMTkx",
    "user": {
      "login": "tbu-",
      "id": 6666593,
      "node_id": "MDQ6VXNlcjY2NjY1OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6666593?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbu-",
      "html_url": "https://github.com/tbu-",
      "followers_url": "https://api.github.com/users/tbu-/followers",
      "following_url": "https://api.github.com/users/tbu-/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbu-/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbu-/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbu-/subscriptions",
      "organizations_url": "https://api.github.com/users/tbu-/orgs",
      "repos_url": "https://api.github.com/users/tbu-/repos",
      "events_url": "https://api.github.com/users/tbu-/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbu-/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T23:19:32Z",
    "updated_at": "2014-12-10T23:19:32Z",
    "body": "Ah, it was the optimization level, my bad:\n\n```\n$ ./a --bench\n\nrunning 6 tests\ntest bench_long_direct       ... bench:    174465 ns/iter (+/- 15410) = 4332 MB/s\ntest bench_long_via_format   ... bench:    823062 ns/iter (+/- 16784) = 917 MB/s\ntest bench_medium_direct     ... bench:        54 ns/iter (+/- 1) = 13999 MB/s\ntest bench_medium_via_format ... bench:       827 ns/iter (+/- 17) = 914 MB/s\ntest bench_short_direct      ... bench:        30 ns/iter (+/- 1) = 399 MB/s\ntest bench_short_via_format  ... bench:       116 ns/iter (+/- 2) = 103 MB/s\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 6 measured\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66543191/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66543321",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66543321",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66543321,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTQzMzIx",
    "user": {
      "login": "tbu-",
      "id": 6666593,
      "node_id": "MDQ6VXNlcjY2NjY1OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6666593?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbu-",
      "html_url": "https://github.com/tbu-",
      "followers_url": "https://api.github.com/users/tbu-/followers",
      "following_url": "https://api.github.com/users/tbu-/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbu-/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbu-/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbu-/subscriptions",
      "organizations_url": "https://api.github.com/users/tbu-/orgs",
      "repos_url": "https://api.github.com/users/tbu-/repos",
      "events_url": "https://api.github.com/users/tbu-/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbu-/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T23:20:36Z",
    "updated_at": "2014-12-10T23:20:36Z",
    "body": "So it looks like it's `>= 4` times as fast in this micro-benchmark, if we now knew the amount of these calls in the average Rust program and the Rust compiler, we could get to conclusions.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66543321/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66544379",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66544379",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66544379,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTQ0Mzc5",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-10T23:29:22Z",
    "updated_at": "2014-12-10T23:29:22Z",
    "body": "We can make conclusions about memory usage by calculating the waste. You don't need a benchmark to know that it increases the memory usage of many ranges of string sizes by up to 2x.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66544379/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66638588",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66638588",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66638588,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NjM4NTg4",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T15:50:05Z",
    "updated_at": "2014-12-11T15:50:05Z",
    "body": "@tbu- thanks for collecting some data! I would be very interested in the impact on the compiler as well in terms of this patch.\n\n@thestinger I agree that these are drawbacks of the current formatting implementation, but I do not want to jump to conclusions about memory usage or runtime without analyzing the data. For example the profile of @tbu-'s benchmark shows the hottest rust function is `str::is_utf8`, not allocation. \n\n```\n 52.22%  foo  [kernel.kallsyms]   [k] 0xffffffff8104f45a\n 35.00%  foo  foo                 [.] str::is_utf8::hab1db396681c19080ds\n  8.22%  foo  foo                 [.] vec::Vec$LT$T$GT$::push_all::h14954786383563052596\n  3.82%  foo  foo                 [.] vec::Vec$LT$u8$GT$.fmt..FormatWriter::write::h576aa16a265866a1e3k\n  0.17%  foo  foo                 [.] bench_long_direct::hf06e2cc845c083d2Xca\n  0.14%  foo  foo                 [.] arena_purge_stashed\n```\n\nTo be clear I'm not disagreeing with your technical points, I'd just like to emphasize that we still need data to draw conclusions from this change as its sometimes surprising. I do not expect, for example, that formatting with a size hint would reduce memory usage of the compiler by half. I would be, however, curious in the impact of the memory usage on the compiler if we inserted a `shrink_to_fit` after formatting.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66638588/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66686651",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66686651",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66686651,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2Njg2NjUx",
    "user": {
      "login": "japaric",
      "id": 5018213,
      "node_id": "MDQ6VXNlcjUwMTgyMTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/japaric",
      "html_url": "https://github.com/japaric",
      "followers_url": "https://api.github.com/users/japaric/followers",
      "following_url": "https://api.github.com/users/japaric/following{/other_user}",
      "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/japaric/subscriptions",
      "organizations_url": "https://api.github.com/users/japaric/orgs",
      "repos_url": "https://api.github.com/users/japaric/repos",
      "events_url": "https://api.github.com/users/japaric/events{/privacy}",
      "received_events_url": "https://api.github.com/users/japaric/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T20:52:39Z",
    "updated_at": "2014-12-11T20:52:39Z",
    "body": "@alexcrichton I agree with you in that `into_string()` is a bad/misleading name, and than it should be removed. However, I still don't think that we should use `to_string()`, for two reasons:\n- The method `to_string()` is _tied to formatting_ (via `Show`). In all these operations, we don't want to \"format a string literal\", but rather produce an _owned value from a slice_, just like `to_vec()` does on `&[T]`.\n- It has performance problems, as shown in other comments.\n\nI'm going to leave this alternative as a suggestion.\n- Instead of using `[in]to_string()` on string literals use `to_owned()`\n- Implement `to_owned()` as `String(self.as_bytes().to_vec())` instead of just calling `to_string()`\n\nAdvantages:\n- It conveys the right semantics: give me an owned version of this string literal\n- It's performant (no overallocation)\n- It's one character shorter than `to_string()` :P\n\nDisadvantages:\n- The `ToOwned` trait is not in the prelude, so it'll need to be imported in several places. (Or we could just put it in the prelude :-))\n- If at some point we implement, e.g. `ToOwned<Box<str>>` for `str`, then type annotations will be required in some cases.\n\n---\n\nFeel free to close this PR, as I don't expect `into_string()` to survive.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66686651/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66687811",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66687811",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66687811,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2Njg3ODEx",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T21:00:03Z",
    "updated_at": "2014-12-11T21:00:03Z",
    "body": "@alexcrichton:\n\n> but I do not want to jump to conclusions about memory usage or runtime without analyzing the data.\n\nCalculating the excess memory usage is not jumping to conclusions.\n\n> I do not expect, for example, that formatting with a size hint would reduce memory usage of the compiler by half.\n\nThe compiler is not representative of every application. It's enough to calculate the excess memory usage for the different sizes of strings and then apply that to the observed distribution of string sizes in a few domains (Rust or not) to figure out the increase in memory usage.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66687811/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66688671",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66688671",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66688671,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2Njg4Njcx",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T21:06:06Z",
    "updated_at": "2014-12-11T21:09:36Z",
    "body": "A naive micro-benchmark is unable to measure the cost of memory allocation. It will just be grabbing the same memory over and over again without the usual bookkeeping work and cache misses.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66688671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66690398",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66690398",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66690398,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NjkwMzk4",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T21:17:43Z",
    "updated_at": "2014-12-11T21:17:43Z",
    "body": "In-place reallocation rarely succeeds in the real world but it will succeed _every time_ in a naive micro-benchmark because nothing else has been allocated so the cost won't be apparent. It will also be grabbing the _same_ small allocations over and over again from the thread cache. This is a great example of why performing benchmarks can _decrease_ your understanding of the performance rather than increasing it.\n\nThe suggestion to benchmark / measure with `rustc` isn't helpful either. It's not at all dependent on the performance on string manipulation... but many applications are.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66690398/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66707344",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66707344",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66707344,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzA3MzQ0",
    "user": {
      "login": "tbu-",
      "id": 6666593,
      "node_id": "MDQ6VXNlcjY2NjY1OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6666593?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbu-",
      "html_url": "https://github.com/tbu-",
      "followers_url": "https://api.github.com/users/tbu-/followers",
      "following_url": "https://api.github.com/users/tbu-/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbu-/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbu-/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbu-/subscriptions",
      "organizations_url": "https://api.github.com/users/tbu-/orgs",
      "repos_url": "https://api.github.com/users/tbu-/repos",
      "events_url": "https://api.github.com/users/tbu-/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbu-/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T23:18:54Z",
    "updated_at": "2014-12-11T23:18:54Z",
    "body": "@alexcrichton When does this call `is_utf8`? Shouldn't everything on the way be known to be UTF-8?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66707344/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66707631",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66707631",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66707631,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzA3NjMx",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T23:21:32Z",
    "updated_at": "2014-12-11T23:21:32Z",
    "body": "@japaric your suggestion of `.to_owned()` seems like a good one to me. It does, however, call into question the `.to_vec()` method as to whether it should become `.to_owned()` as well. It seems a little odd to me that we would have two traits for references => owned objects in the prelude (Clone + ToOwned), but they seem semantically core enough that I would be ok putting them into the prelude. With path slices and such I also suspect that the `.to_owend()` operation may be more common. cc @aturon on this topic.\n\n@tbu- whenever formatting finishes it calls `String::from_utf8` which calls `is_utf8` at the top of the function.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66707631/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66711343",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66711343",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66711343,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzExMzQz",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-11T23:57:08Z",
    "updated_at": "2014-12-11T23:57:08Z",
    "body": "I don't like 'to owned' because it's not specific enough. It used to refer to owned pointers but we don't have those anymore, and for good reason.=\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66711343/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66741315",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66741315",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66741315,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzQxMzE1",
    "user": {
      "login": "seanmonstar",
      "id": 51479,
      "node_id": "MDQ6VXNlcjUxNDc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/51479?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/seanmonstar",
      "html_url": "https://github.com/seanmonstar",
      "followers_url": "https://api.github.com/users/seanmonstar/followers",
      "following_url": "https://api.github.com/users/seanmonstar/following{/other_user}",
      "gists_url": "https://api.github.com/users/seanmonstar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/seanmonstar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/seanmonstar/subscriptions",
      "organizations_url": "https://api.github.com/users/seanmonstar/orgs",
      "repos_url": "https://api.github.com/users/seanmonstar/repos",
      "events_url": "https://api.github.com/users/seanmonstar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/seanmonstar/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-12T07:43:46Z",
    "updated_at": "2014-12-12T07:43:46Z",
    "body": "Please don't completely remove it. I just completed a lint to catch exactly this https://github.com/hyperium/hyper/blob/pocketlint/hyperlint/src/lib.rs#L64\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66741315/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66766086",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66766086",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66766086,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzY2MDg2",
    "user": {
      "login": "japaric",
      "id": 5018213,
      "node_id": "MDQ6VXNlcjUwMTgyMTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/japaric",
      "html_url": "https://github.com/japaric",
      "followers_url": "https://api.github.com/users/japaric/followers",
      "following_url": "https://api.github.com/users/japaric/following{/other_user}",
      "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/japaric/subscriptions",
      "organizations_url": "https://api.github.com/users/japaric/orgs",
      "repos_url": "https://api.github.com/users/japaric/repos",
      "events_url": "https://api.github.com/users/japaric/events{/privacy}",
      "received_events_url": "https://api.github.com/users/japaric/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-12T12:22:03Z",
    "updated_at": "2014-12-12T12:22:03Z",
    "body": "@seanmonstar `into_string()` is being removed in #19741. But, if @alexcrichton takes [my `to_owned()` suggestion](https://github.com/rust-lang/rust/pull/19741/files#diff-2544e5e5ce71797344d5ec6acde08b87R658), then you can use `to_owned()` instead of `into_string()` as they would have the same implementation.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66766086/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66831594",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66831594",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66831594,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2ODMxNTk0",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-12T20:38:34Z",
    "updated_at": "2014-12-12T20:38:34Z",
    "body": "I'd like to reiterate that we should not be jumping to conclusions about how slow or fast code is without profiling and analyzing it. To be super clear about the `is_utf8` check problem, I'd like to reiterate with [an updated version](https://gist.github.com/alexcrichton/1c286fab9e39f4630ace) of @tbu-'s benchmark with more numbers. \n\n```\nrunning 9 tests\ntest bench_long_direct       ... bench:    187995 ns/iter (+/- 6773) = 4021 MB/s\ntest bench_long_via_format   ... bench:    190527 ns/iter (+/- 6585) = 3967 MB/s\ntest bench_long_via_write    ... bench:    190592 ns/iter (+/- 7014) = 3965 MB/s\ntest bench_medium_direct     ... bench:        36 ns/iter (+/- 3) = 20999 MB/s\ntest bench_medium_via_format ... bench:       102 ns/iter (+/- 4) = 7411 MB/s\ntest bench_medium_via_write  ... bench:        61 ns/iter (+/- 5) = 12393 MB/s\ntest bench_short_direct      ... bench:        21 ns/iter (+/- 1) = 571 MB/s\ntest bench_short_via_format  ... bench:        66 ns/iter (+/- 3) = 181 MB/s\ntest bench_short_via_write   ... bench:        49 ns/iter (+/- 1) = 244 MB/s\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 9 measured\n```\n\nBefore collecting these numbers, I made the following changes:\n- I altered the one method of `FormatWriter` to `write_str` so we have a static guarantee that the contents are always valid UTF-8.\n- I altered the `.to_string()` implementation to call `.shrink_to_fit()` when it's done formatting.\n- I added a `*_via_write` variant of the tests where a `String` is pre-allocated with enough space for the result, and then I `write!()` into it. This notably should benchmark the overhead of the formatting system relative to just calling `.to_owned()` because the number of allocations are the same.\n\nPrimarily we can see a drastic improvement by avoiding the `is_utf8` check. I plan on writing an RFC about this soon. From the numbers we can also conclude that the formatting system does indeed impose some overhead, but the claims made in this thread can seem much more drastic than the effects actually are. Note that very little work has been put into optimizing that work, however, and it is likely ripe for improvements to reduce the overhead.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66831594/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66832239",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66832239",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66832239,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2ODMyMjM5",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-12T20:43:42Z",
    "updated_at": "2014-12-12T20:43:42Z",
    "body": "As I pointed out above, the benchmark _does not include the cost of reallocations_ because it's too naive. I guess you didn't read what I wrote. If you did, then it's blatant misinformation.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66832239/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66832959",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66832959",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66832959,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2ODMyOTU5",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-12T20:48:57Z",
    "updated_at": "2014-12-12T20:48:57Z",
    "body": "> but the claims made in this thread can seem much more drastic than the effects actually are.\n\nNo, you just didn't take the time to read the claims in this thread:\n\n> A naive micro-benchmark is unable to measure the cost of memory allocation. It will just be grabbing the same memory over and over again without the usual bookkeeping work and cache misses.\n> \n> In-place reallocation rarely succeeds in the real world but it will succeed every time in a naive micro-benchmark because nothing else has been allocated so the cost won't be apparent. It will also be grabbing the same small allocations over and over again from the thread cache. This is a great example of why performing benchmarks can decrease your understanding of the performance rather than increasing it.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66832959/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66930515",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-66930515",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 66930515,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2OTMwNTE1",
    "user": {
      "login": "shepmaster",
      "id": 174509,
      "node_id": "MDQ6VXNlcjE3NDUwOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/174509?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shepmaster",
      "html_url": "https://github.com/shepmaster",
      "followers_url": "https://api.github.com/users/shepmaster/followers",
      "following_url": "https://api.github.com/users/shepmaster/following{/other_user}",
      "gists_url": "https://api.github.com/users/shepmaster/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shepmaster/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shepmaster/subscriptions",
      "organizations_url": "https://api.github.com/users/shepmaster/orgs",
      "repos_url": "https://api.github.com/users/shepmaster/repos",
      "events_url": "https://api.github.com/users/shepmaster/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shepmaster/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-14T21:27:06Z",
    "updated_at": "2014-12-14T21:27:06Z",
    "body": "I ran into this a while back (based on profiler feedback about my full application), you can see the [relevant change](https://github.com/shepmaster/sxd-document/commit/4f29dee8ee4e98653b10778fb660ddc76f5debc6) in my repo, but the core part was:\n\n> On a 100MB XML file, [replacing .to_string with String::from_str] reduced time to open, parse, and output it to /dev/null by 1.2 seconds (taking 87% of the previous time).\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/66930515/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/67926440",
    "html_url": "https://github.com/rust-lang/rust/pull/19708#issuecomment-67926440",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19708",
    "id": 67926440,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3OTI2NDQw",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-12-23T06:56:41Z",
    "updated_at": "2014-12-23T06:56:41Z",
    "body": "Now that https://github.com/rust-lang/rust/pull/19741 has landed, I'm going to close this now that `into_string` has been deprecated. [As mentioned](https://github.com/rust-lang/rust/pull/19741#issuecomment-67092674), the combination of [tweaking `Formatter`](https://github.com/rust-lang/rfcs/pull/526) and size hints should address the performance concerns with `to_string`.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/67926440/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
