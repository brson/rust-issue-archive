{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/14638",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/14638/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/14638/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/14638/events",
  "html_url": "https://github.com/rust-lang/rust/pull/14638",
  "id": 34935531,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTY2OTQ1MTQ=",
  "number": 14638,
  "title": "std: Extract librustrt out of libstd",
  "user": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 6,
  "created_at": "2014-06-04T07:25:13Z",
  "updated_at": "2014-06-12T22:48:43Z",
  "closed_at": "2014-06-07T07:46:36Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/14638",
    "html_url": "https://github.com/rust-lang/rust/pull/14638",
    "diff_url": "https://github.com/rust-lang/rust/pull/14638.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/14638.patch",
    "merged_at": "2014-06-07T07:46:38Z"
  },
  "body": "As part of the libstd facade efforts, this commit extracts the runtime interface\nout of the standard library into a standalone crate, librustrt. This crate will\nprovide the following services:\n- Definition of the rtio interface\n- Definition of the Runtime interface\n- Implementation of the Task structure\n- Implementation of task-local-data\n- Implementation of task failure via unwinding via libunwind\n- Implementation of runtime initialization and shutdown\n- Implementation of thread-local-storage for the local rust Task\n\nNotably, this crate avoids the following services:\n- Thread creation and destruction. The crate does not require the knowledge of\n  an OS threading system, and as a result it seemed best to leave out the\n  `rt::thread` module from librustrt. The librustrt module does depend on\n  mutexes, however.\n- Implementation of backtraces. There is no inherent requirement for the runtime\n  to be able to generate backtraces. As will be discussed later, this\n  functionality continues to live in libstd rather than librustrt.\n\nAs usual, a number of architectural changes were required to make this crate\npossible. Users of \"stable\" functionality will not be impacted by this change,\nbut users of the `std::rt` module will likely note the changes. A list of\narchitectural changes made is:\n- The stdout/stderr handles no longer live directly inside of the `Task`\n  structure. This is a consequence of librustrt not knowing about `std::io`.\n  These two handles are now stored inside of task-local-data.\n  \n  The handles were originally stored inside of the `Task` for perf reasons, and\n  TLD is not currently as fast as it could be. For comparison, 100k prints goes\n  from 59ms to 68ms (a 15% slowdown). This appeared to me to be an acceptable\n  perf loss for the successful extraction of a librustrt crate.\n- The `rtio` module was forced to duplicate more functionality of `std::io`. As\n  the module no longer depends on `std::io`, `rtio` now defines structures such\n  as socket addresses, addrinfo fiddly bits, etc. The primary change made was\n  that `rtio` now defines its own `IoError` type. This type is distinct from\n  `std::io::IoError` in that it does not have an enum for what error occurred,\n  but rather a platform-specific error code.\n  \n  The native and green libraries will be updated in later commits for this\n  change, and the bulk of this effort was put behind updating the two libraries\n  for this change (with `rtio`).\n- Printing a message on task failure (along with the backtrace) continues to\n  live in libstd, not in librustrt. This is a consequence of the above decision\n  to move the stdout/stderr handles to TLD rather than inside the `Task` itself.\n  The unwinding API now supports registration of global callback functions which\n  will be invoked when a task fails, allowing for libstd to register a function\n  to print a message and a backtrace.\n  \n  The API for registering a callback is experimental and unsafe, as the\n  ramifications of running code on unwinding is pretty hairy.\n- The `std::unstable::mutex` module has moved to `std::rt::mutex`.\n- The `std::unstable::sync` module has been moved to `std::rt::exclusive` and\n  the type has been rewritten to not internally have an Arc and to have an RAII\n  guard structure when locking. Old code should stop using `Exclusive` in favor\n  of the primitives in `libsync`, but if necessary, old code should port to\n  `Arc<Exclusive<T>>`.\n- The local heap has been stripped down to have fewer debugging options. None of\n  these were tested, and none of these have been used in a very long time.\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/14638/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/14638/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
