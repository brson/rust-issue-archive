[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52111994",
    "html_url": "https://github.com/rust-lang/rust/issues/16481#issuecomment-52111994",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/16481",
    "id": 52111994,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyMTExOTk0",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-08-13T21:13:50Z",
    "updated_at": "2014-08-13T21:13:50Z",
    "body": "I thought it might be a dup of https://github.com/rust-lang/rust/issues/6393 , but I don't think so.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52111994/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52124991",
    "html_url": "https://github.com/rust-lang/rust/issues/16481#issuecomment-52124991",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/16481",
    "id": 52124991,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyMTI0OTkx",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-08-13T23:19:22Z",
    "updated_at": "2014-08-13T23:19:22Z",
    "body": "Yes, this is a dupe of #6393.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52124991/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/147178335",
    "html_url": "https://github.com/rust-lang/rust/issues/16481#issuecomment-147178335",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/16481",
    "id": 147178335,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0NzE3ODMzNQ==",
    "user": {
      "login": "colin-kiegel",
      "id": 7691186,
      "node_id": "MDQ6VXNlcjc2OTExODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7691186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/colin-kiegel",
      "html_url": "https://github.com/colin-kiegel",
      "followers_url": "https://api.github.com/users/colin-kiegel/followers",
      "following_url": "https://api.github.com/users/colin-kiegel/following{/other_user}",
      "gists_url": "https://api.github.com/users/colin-kiegel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/colin-kiegel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/colin-kiegel/subscriptions",
      "organizations_url": "https://api.github.com/users/colin-kiegel/orgs",
      "repos_url": "https://api.github.com/users/colin-kiegel/repos",
      "events_url": "https://api.github.com/users/colin-kiegel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/colin-kiegel/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-10-11T10:07:49Z",
    "updated_at": "2015-10-11T10:09:57Z",
    "body": "@reem (or anyone else): I am struggling with a similar issue as yours. After quite some time of research in the bug tracker, I understand that this is a (minor) design limitation of the current borrow checker.\n\nNow I am looking for a good short term workaround. My scenario is very similar, as yours - I have a function which does a cache-lookup in a HashMap. If the cache-lookup is successful, the value is returned, otherwise it is calculated first, added to the cache and then returned. Not a big deal - but I am fighting with the borrow checker, because the checker does not have the notion of _conditionally_ escaping borrows.\n\nI came up with a 'quick & dirty' using an unsafe pointer to sneak out the reference, without the compiler knowing. :-) I know this is not StackOverflow but a bugtracker, but I had quite some trouble finding a _solution_ for this and I think other people might have similar questions.\n\n``` rust\nuse std::collections::HashMap;\n\npub struct Map {\n    map: HashMap<&'static str, &'static str>\n}\n\nfn produce(_: &Map) -> &'static str { \"goodbye\" }\n\nimpl Map {\n    fn get(&mut self, k: &'static str) -> Option<&&'static str> {\n        {\n            if let Some(x) = self.map.get(&k) {\n                let sneak_out : *const &'static str = x;\n                return Some(unsafe {&*sneak_out});\n            }\n            // Immutable borrow ENDS here as usual\n            // because the borrow checker is not aware\n            // of any references escaping this block.\n        }\n\n        let tmp = produce(self);\n        self.map.insert(k, tmp);\n        self.get(k)\n    }\n}\n\nfn main() {\n  let mut m = Map { map: HashMap::new() };\n  m.get(\"hello\");\n}\n```\n\nI wonder, is there a better way to refactor the code without `unsafe`?\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/147178335/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/147179008",
    "html_url": "https://github.com/rust-lang/rust/issues/16481#issuecomment-147179008",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/16481",
    "id": 147179008,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0NzE3OTAwOA==",
    "user": {
      "login": "jonas-schievink",
      "id": 1786438,
      "node_id": "MDQ6VXNlcjE3ODY0Mzg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonas-schievink",
      "html_url": "https://github.com/jonas-schievink",
      "followers_url": "https://api.github.com/users/jonas-schievink/followers",
      "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions",
      "organizations_url": "https://api.github.com/users/jonas-schievink/orgs",
      "repos_url": "https://api.github.com/users/jonas-schievink/repos",
      "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonas-schievink/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-10-11T10:16:41Z",
    "updated_at": "2015-10-11T10:16:41Z",
    "body": "> If the cache-lookup is successful, the value is returned, otherwise it is calculated first, added to the cache and then returned. \n\nThis sounds like a job for the [entry API](http://manishearth.github.io/rust-internals-docs/std/collections/hash_map/struct.HashMap.html#method.entry)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/147179008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/147179772",
    "html_url": "https://github.com/rust-lang/rust/issues/16481#issuecomment-147179772",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/16481",
    "id": 147179772,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0NzE3OTc3Mg==",
    "user": {
      "login": "colin-kiegel",
      "id": 7691186,
      "node_id": "MDQ6VXNlcjc2OTExODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7691186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/colin-kiegel",
      "html_url": "https://github.com/colin-kiegel",
      "followers_url": "https://api.github.com/users/colin-kiegel/followers",
      "following_url": "https://api.github.com/users/colin-kiegel/following{/other_user}",
      "gists_url": "https://api.github.com/users/colin-kiegel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/colin-kiegel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/colin-kiegel/subscriptions",
      "organizations_url": "https://api.github.com/users/colin-kiegel/orgs",
      "repos_url": "https://api.github.com/users/colin-kiegel/repos",
      "events_url": "https://api.github.com/users/colin-kiegel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/colin-kiegel/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-10-11T10:40:54Z",
    "updated_at": "2015-10-11T10:40:54Z",
    "body": "very true - that was indeed my first version, before I even encountered this issue. That definitely works.\n\nThe thing is my `HashMap<String, _>` uses heap-allocated keys (is this a bad idea?). If I use the entry API I need to heap-allocate a key _for every lookup_, which I was trying to eliminate with this alternative. HashMap::entry() needs a value in advance, while HashMap::get() works with references like &str in my case.\n\nThese thoughts about allocations maybe 'academic' - I am learning rust for fun and trying to get it right. ;-)\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/147179772/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
