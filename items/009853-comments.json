[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/26308475",
    "html_url": "https://github.com/rust-lang/rust/issues/9853#issuecomment-26308475",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9853",
    "id": 26308475,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2MzA4NDc1",
    "user": {
      "login": "MicahChalmer",
      "id": 698400,
      "node_id": "MDQ6VXNlcjY5ODQwMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/698400?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MicahChalmer",
      "html_url": "https://github.com/MicahChalmer",
      "followers_url": "https://api.github.com/users/MicahChalmer/followers",
      "following_url": "https://api.github.com/users/MicahChalmer/following{/other_user}",
      "gists_url": "https://api.github.com/users/MicahChalmer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MicahChalmer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MicahChalmer/subscriptions",
      "organizations_url": "https://api.github.com/users/MicahChalmer/orgs",
      "repos_url": "https://api.github.com/users/MicahChalmer/repos",
      "events_url": "https://api.github.com/users/MicahChalmer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MicahChalmer/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-10-15T04:23:06Z",
    "updated_at": "2013-10-15T04:23:06Z",
    "body": "This seems similar to the [recursive closure problem](http://smallcultfollowing.com/babysteps/blog/2013/04/30/the-case-of-the-recurring-closure/) that @nikomatsakis mentioned in a blog post.  It's another case where an alias inside a closure environment is not considered by the borrower checker.\n\nHere's a version without the `Option` that shows the same problem.  This version, like the original, compiles (even though it shouldn't) and gives the same use-after-free result as above:\n\n``` rust\nstruct A {\n    foo : ~fn(&mut A)\n}\n\nimpl A {\n    fn call(&mut self) {\n        (self.foo)(self)\n    }\n}\n\nstruct S {\n    msg: ~str\n}\n\nimpl Drop for S {\n    fn drop(&mut self) {\n        println!(\"drop {:?}\", *self);\n        self.msg = ~\"dropped\";\n    }\n}\n\nfn main() {\n    let x = S { msg: ~\"ok\" };\n    let f: ~fn(&mut A) = |a| { a.foo = |_| {}; println!(\"{:?}\", x); }; // this frees closure environment via `a`, then accesses it\n    let mut a = A { foo: f };\n    a.call();\n}\n```\n\nIf you take out the owned closure and insert an equivalent owned struct instead, the borrow checker is no longer fooled.  The compiler correctly rejects this one:\n\n``` rust\nstruct A {\n    foo : ~NotAClosure\n}\n\nimpl A {\n    fn call(&mut self) {\n        self.foo.call(self);\n    }\n}\n\nstruct NotAClosure {\n    s: Option<S>\n}\n\nimpl NotAClosure {\n    fn call(&self, a:&mut A) {\n        a.foo.s = None;\n        println!(\"{:?}\", self);\n    }\n}\n\nstruct S {\n    msg: ~str\n}\n\nimpl Drop for S {\n    fn drop(&mut self) {\n        println!(\"drop {:?}\", *self);\n        self.msg = ~\"dropped\";\n    }\n}\n\nfn main() {\n    let mut a = A{ foo: ~NotAClosure { s: Some(S { msg: ~\"ok\" }) } };\n    a.call();\n}\n```\n\nThe error message points out the problematic line:\n\n```\nwtf3.rs:7:22: 7:27 error: cannot borrow `*self` as mutable because it is also borrowed as immutable\nwtf3.rs:7         self.foo.call(self);\n                                ^~~~~\nwtf3.rs:7:8: 7:16 note: second borrow of `*self` occurs here\nwtf3.rs:7         self.foo.call(self);\n                  ^~~~~~~~\n```\n\nWith the upcoming change of `~fn` to `proc`, this bug might inherently be fixed...\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/26308475/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/26322669",
    "html_url": "https://github.com/rust-lang/rust/issues/9853#issuecomment-26322669",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9853",
    "id": 26322669,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2MzIyNjY5",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-10-15T10:07:19Z",
    "updated_at": "2013-10-15T10:07:19Z",
    "body": "cc me\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/26322669/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41521920",
    "html_url": "https://github.com/rust-lang/rust/issues/9853#issuecomment-41521920",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9853",
    "id": 41521920,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTIxOTIw",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-28T04:21:43Z",
    "updated_at": "2014-04-28T04:21:43Z",
    "body": "Closing, `~fn()` no longer exists as a type and borrowing semantics around closures have changed significantly.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41521920/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
