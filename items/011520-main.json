{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/11520",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/11520/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/11520/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/11520/events",
  "html_url": "https://github.com/rust-lang/rust/pull/11520",
  "id": 25534342,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTE0NzIxMzY=",
  "number": 11520,
  "title": "Alternative lockless Mutex implementation (2nd try)",
  "user": {
    "login": "bill-myers",
    "id": 4647491,
    "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bill-myers",
    "html_url": "https://github.com/bill-myers",
    "followers_url": "https://api.github.com/users/bill-myers/followers",
    "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
    "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
    "organizations_url": "https://api.github.com/users/bill-myers/orgs",
    "repos_url": "https://api.github.com/users/bill-myers/repos",
    "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bill-myers/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 20,
  "created_at": "2014-01-13T22:34:15Z",
  "updated_at": "2014-06-12T10:35:09Z",
  "closed_at": "2014-01-16T01:15:26Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/11520",
    "html_url": "https://github.com/rust-lang/rust/pull/11520",
    "diff_url": "https://github.com/rust-lang/rust/pull/11520.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/11520.patch",
    "merged_at": null
  },
  "body": "This is yet another attempt to create a satisfying implementation of Mutex (first in #11462, second in #11509), created since I believe I have managed to devise a working lockless algorithm.\n\nI think the algorithm is correct, but please check; if it is, then this has none of the drawbacks of the previous pulls.\n\nThis code is based on Alex Crichton's code, but replaces the \"held\" AtomicBool variable with a more sophisticated MutexState struct which consists of an atomic (lockers, queue_size) pair.\n\nAlso, we replace the intrusive MPSC queue implementation with one using list reversal, to remove the need to yield there and the need to store a stub node in the Mutex.\n\nFeatures:\n- No yields!\n- Only one OS mutex\n- Smallest Mutex struct size ever, since the new MPSC implementation no longers needs a stub node\n- Fair even when combining native and green tasks\n- Provides \"can zap Mutex just after unlock\" guarantee since we can now provide it for free\n\nNon-features:\n- Recursively locking will deadlock; this can be fixed, but enlarges the mutex or requires an OS mutex with a trylock that can detect recursion (but you can anyway deadlock by taking two mutexes in opposite orders from two threads, so not sure if it's essential) \n\nNon-issues:\n- Uses cmpxchg loops rather than non-loops; however, the previous version was using yield loops\n- Green tasks can block on the OS mutex, but only when it is known that another thread is about to release it; again, the previous version was using yield loops for the same purpose, which are worse \n- unlock is O(n) in the number of contending tasks in the worst case due to list reversal, when green tasks are used; however mutex lock is already fundamentally O(n) due to the obvious contention properties of mutexes, so this shouldn't really matter\n\nThe only known issue is that as implemented now this only works with up to 2^16 tasks on 32-bit and up to 2^32 tasks on 64-bit, since it needs to store two variables with a task count in a single atomic variable.\n\nThis shouldn't be a problem for two reasons:\n1. As long as tasks use at least 64KB (in user stack, kernel stack, etc.) and 64-bit platforms actually only provide 48-bit addressing (this is the case for x86-64 right now) the 2^16/2^32 limitation cannot be overrun\n2. Anyway, Pentium Pro+ and ARMv6+ provide 64-bit atomics in 32-bit mode (cmpxchg8b and ldrexd etc.) and x86-64 processors beyond the early Opterons as well as ARMv8 provide 128-bit atomics in 64-bit mode (cmpxchg16b), so it's only a matter of implementing support for and using those if desired\n\nCurrently Rust uses 2MB stacks by default, so programs that don't specify the stack size manually already cannot trip this limitation.\n",
  "closed_by": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/11520/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/11520/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
