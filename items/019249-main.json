{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/19249",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/19249/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/19249/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/19249/events",
  "html_url": "https://github.com/rust-lang/rust/pull/19249",
  "id": 49835106,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjQ5MDQ5MjY=",
  "number": 19249,
  "title": "Improve type safety of serialize::json::Encoder",
  "user": {
    "login": "barosl",
    "id": 573768,
    "node_id": "MDQ6VXNlcjU3Mzc2OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/573768?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/barosl",
    "html_url": "https://github.com/barosl",
    "followers_url": "https://api.github.com/users/barosl/followers",
    "following_url": "https://api.github.com/users/barosl/following{/other_user}",
    "gists_url": "https://api.github.com/users/barosl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/barosl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/barosl/subscriptions",
    "organizations_url": "https://api.github.com/users/barosl/orgs",
    "repos_url": "https://api.github.com/users/barosl/repos",
    "events_url": "https://api.github.com/users/barosl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/barosl/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 7,
  "created_at": "2014-11-23T19:04:31Z",
  "updated_at": "2014-12-09T13:51:51Z",
  "closed_at": "2014-12-09T13:51:51Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/19249",
    "html_url": "https://github.com/rust-lang/rust/pull/19249",
    "diff_url": "https://github.com/rust-lang/rust/pull/19249.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/19249.patch",
    "merged_at": "2014-12-09T13:51:51Z"
  },
  "body": "This pull request tries to improve type safety of `serialize::json::Encoder`.\n\nLooking at #18319, I decided to test some JSON implementations in other languages. The results are as follows:\n- Encoding to JSON\n\n| Language | 111111111111111111 | 1.0 |\n| --- | --- | --- |\n| JavaScript\u2122 | \"111111111111111100\" | \"1\" |\n| Python | \"111111111111111111\" | **\"1.0\"** |\n| Go | \"111111111111111111\" | \"1\" |\n| Haskell | \"111111111111111111\" | \"1\" |\n| Rust | **\"111111111111111104\"** | \"1\" |\n- Decoding from JSON\n\n| Language | \"1\" | \"1.0\" | \"1.6\" |\n| --- | --- | --- | --- |\n| JavaScript\u2122 | 1 (Number) | 1 (Number) | 1.6 (Number) |\n| Python | 1 (int) | 1.0 (float) | 1.6 (float) |\n| Go | **1 (float64)** | 1 (float64) | 1.6 (float64) |\n| Go (expecting `int`) | 1 (int) | **error** | error |\n| Haskell (with `:: Int`) | 1 (Int) | 1 (Int) | **2 (Int)** |\n| Haskell (with `:: Double`) | 1.0 (Double) | 1.0 (Double) | 1.6 (Double) |\n| Rust (with `::<int>`) | 1 (int) | 1 (Int) | **1 (Int)** |\n| Rust (with `::<f64>`) | 1 (f64) | 1 (f64) | 1.6 (f64) |\n- The tests on Haskell were done using the [json](http://hackage.haskell.org/package/json) package.\n- The error message printed by Go was: `cannot unmarshal number 1.0 into Go value of type int`\n\nAs you see, there is no uniform behavior. Every implementation follows its own principle. So I think it is reasonable to find a desirable set of behaviors for Rust.\n\nFirstly, every implementation except the one for JavaScript is capable of handling `i64` values. It is even practical, because [Twitter API uses an i64 number to represent a tweet ID](https://dev.twitter.com/overview/api/twitter-ids-json-and-snowflake), although it is recommended to use the string version of the ID.\n\nSecondly, looking into the Go's behavior, implicit type conversion is not allowed in their decoder. If the user expects an integer value to follow, decoding a float value will raise an error. This behavior is desirable in Rust, because we are pleased to follow the principles of strong typing.\n\nThirdly, Python's JSON module forces a decimal point to be printed even if the fractional part does not exist. This eases the distinction of a float value from an integer value in JSON, because by the spec there is only one type to represent numbers, `Number`.\n\nSo, I suggest the following three breaking changes:\n1. Remove float preprocessing in serialize::json::Encoder\n   \n   `serialize::json::Encoder` currently uses `f64` to emit any integral type. This is possibly due to the behavior of JavaScript, which uses `f64` to represent any numeric value.\n   \n   This leads to a problem that only the integers in the range of [-2^53+1, 2^53-1] can be encoded. Therefore, `i64` and `u64` cannot be used reliably in the current implementation.\n   \n   [RFC 7159](http://tools.ietf.org/html/rfc7159) suggests that good interoperability can be achieved if the range is respected by implementations. However, it also says that implementations are allowed to set the range of number accepted. And it seems that the JSON encoders outside of the JavaScript world usually make use of `i64` values.\n   \n   This commit removes the float preprocessing done in the `emit_*` methods. It also increases performance, because transforming `f64` into String costs more than that of an integral type.\n   \n   Fixes #18319\n2. Do not coerce to integer when decoding a float value\n   \n   When an integral value is expected by the user but a fractional value is found, the current implementation uses `std::num::cast()` to coerce to an integer type, losing the fractional part. This behavior is not desirable because the number loses precision without notice.\n   \n   This commit makes it raise `ExpectedError` when such a situation arises.\n3. Always use a decimal point when emitting a float value\n   \n   JSON doesn't distinguish between integer and float. They are just numbers. Also, in the current implementation, a fractional number without the fractional part is encoded without a decimal point.\n   \n   Thereforce, when the value is decoded, it is first rendered as `Json`, either `I64` or `U64`. This reduces type safety, because while the original intention was to cast the value to float, it can also be casted to integer.\n   \n   As a workaround of this problem, this commit makes the encoder always emit a decimal point even if it is not necessary. If the fractional part of a float number is zero, \".0\" is padded to the end of the result.\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/19249/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/19249/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
