{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/21657",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/21657/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/21657/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/21657/events",
  "html_url": "https://github.com/rust-lang/rust/pull/21657",
  "id": 55493878,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjgwMzMzOTE=",
  "number": 21657,
  "title": " Add `CodeExtent::Remainder` variant; pre-req for new scoping/drop rules.",
  "user": {
    "login": "pnkfelix",
    "id": 173127,
    "node_id": "MDQ6VXNlcjE3MzEyNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pnkfelix",
    "html_url": "https://github.com/pnkfelix",
    "followers_url": "https://api.github.com/users/pnkfelix/followers",
    "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}",
    "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions",
    "organizations_url": "https://api.github.com/users/pnkfelix/orgs",
    "repos_url": "https://api.github.com/users/pnkfelix/repos",
    "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pnkfelix/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "pnkfelix",
    "id": 173127,
    "node_id": "MDQ6VXNlcjE3MzEyNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pnkfelix",
    "html_url": "https://github.com/pnkfelix",
    "followers_url": "https://api.github.com/users/pnkfelix/followers",
    "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}",
    "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions",
    "organizations_url": "https://api.github.com/users/pnkfelix/orgs",
    "repos_url": "https://api.github.com/users/pnkfelix/repos",
    "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pnkfelix/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "pnkfelix",
      "id": 173127,
      "node_id": "MDQ6VXNlcjE3MzEyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pnkfelix",
      "html_url": "https://github.com/pnkfelix",
      "followers_url": "https://api.github.com/users/pnkfelix/followers",
      "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}",
      "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions",
      "organizations_url": "https://api.github.com/users/pnkfelix/orgs",
      "repos_url": "https://api.github.com/users/pnkfelix/repos",
      "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pnkfelix/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 12,
  "created_at": "2015-01-26T15:17:42Z",
  "updated_at": "2015-02-07T15:19:58Z",
  "closed_at": "2015-01-27T13:37:58Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/21657",
    "html_url": "https://github.com/rust-lang/rust/pull/21657",
    "diff_url": "https://github.com/rust-lang/rust/pull/21657.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/21657.patch",
    "merged_at": "2015-01-27T13:37:58Z"
  },
  "body": " Add `CodeExtent::Remainder` variant; pre-req for new scoping/drop rules.\n\nThis new enum variant introduces finer-grain code extents, i.e. we now track that a binding lives only for a suffix of a block, and (importantly) will be dropped when it goes out of scope _before_ the bindings that occurred earlier in the block.\n\nBoth of these notions are neatly captured by marking the block (and each suffix) as an enclosing scope of the next suffix beneath it.\n\nThis is work that is part of the foundation for issue #8861.\n\n(It actually has been seen in earlier posted pull requests, in particular #21022; I have just factored it out into its own PR to ease my own near-future rebasing, and also get people used to the new rules.)\n\n---\n\nThese finer grained scopes do mean that some code is newly rejected by `rustc`; for example:\n\n``` rust\nlet mut map : HashMap<u8, &u8> = HashMap::new();\nlet tmp = Box::new(2);\nmap.insert(43, &*tmp);\n```\n\nThis will now fail to compile with a message that `*tmp` does not live long enough, because the scope of `tmp` is now strictly smaller than\nthat of `map`, and the use of `&u8` in map's type requires that the borrowed references are all to data that live at least as long as the map.\n\nThe usual fix for a case like this is to move the binding for `tmp` up above that of `map`; note that you can still leave the initialization in the original spot, like so:\n\n``` rust\nlet tmp;\nlet mut map : HashMap<u8, &u8> = HashMap::new();\ntmp = box 2;\nmap.insert(43, &*tmp);\n```\n\nSimilarly, one can encounter an analogous situation with `Vec`: one would need to rewrite:\n\n``` rust\nlet mut vec = Vec::new();\nlet tmp = 'c';\nvec.push(&tmp);\n```\n\nas:\n\n``` rust\nlet tmp;\nlet mut vec = Vec::new();\ntmp = 'c';\nvec.push(&tmp);\n```\n\n---\n\nIn some corner cases, it does not suffice to reorder the bindings; in particular, when the types for both bindings need to reflect exactly the _same_ code extent, and a parent/child relationship between them does not work.\n\nIn pnkfelix's experience this has arisen most often when mixing uses of cyclic data structures while also allowing a lifetime parameter `'a` to flow into a type parameter context where the type is _invariant_ with respect to the type parameter. An important instance of this is `arena::TypedArena<T>`, which is invariant with respect to `T`.\n\nThe reason that variance is relevant is this: _if_ `TypedArena` were covariant with respect to its type parameter, then we could assign it the longer lifetime when it is initialized, and then convert it to a subtype (via covariance) with a shorter lifetime when necessary.  But `TypedArena` is invariant with respect to its type parameter, and thus if `S` is a subtype of `T` (in particular, if `S` has a lifetime parameter that is shorter than that of `T`), then a `TypedArena<S>` is unrelated to `TypedArena<T>`). Note that the fact that `TypedArena<T>` is invariant with respect to `T` comes straight from the API of that trait; nikomatsakis and pnkfelix has discussed \"arena-like\" API's that would somehow be covariant with respect to `T`, but have not actually managed to develop such an API that is actually expressible in pure Rust without further linguistic extensions/changes.\n\nConcretely, consider code like this:\n\n``` rust\nstruct Node<'a> { sibling: Option<&'a Node<'a>> }\nstruct Context<'a> {\n    // because of this field, `Context<'a>` is invariant with respect to `'a`.\n    arena: &'a TypedArena<Node<'a>>,\n    ...\n}\nfn new_ctxt<'a>(arena: &'a TypedArena<Node<'a>>) -> Context<'a> { ... }\nfn use_ctxt<'a>(fcx: &'a Context<'a>) { ... }\n\nlet arena = TypedArena::new();\nlet ctxt = new_ctxt(&arena);\n\nuse_ctxt(&ctxt);\n```\n\nIn these situations, if you try to introduce two bindings via two distinct `let` statements, each is (with this commit) assigned a distinct extent, and the region inference system cannot find a single region to assign to the lifetime `'a` that works for both of the bindings. So you get an error that `ctxt` does not live long enough; but moving its binding up above that of `arena` just shifts the error so now the compiler complains that `arena` does not live long enough.\n- SO: What to do? The easiest fix in this case is to ensure that the two bindings _do_ get assigned the same static extent, by stuffing both\n  bindings into the same let statement, like so:\n\n``` rust\nlet (arena, ctxt): (TypedArena, Context);\narena = TypedArena::new();\nctxt = new_ctxt(&arena);\n\nuse_ctxt(&ctxt);\n```\n\n---\n\nDue to the new code restrictions outlined above, this is a ...\n\n[breaking-change]\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/21657/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/21657/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
