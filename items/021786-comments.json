[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/181537992",
    "html_url": "https://github.com/rust-lang/rust/issues/21786#issuecomment-181537992",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21786",
    "id": 181537992,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4MTUzNzk5Mg==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-08T19:49:38Z",
    "updated_at": "2016-02-08T19:49:38Z",
    "body": "Triage: I'm not aware of any change here.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/181537992/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/225046735",
    "html_url": "https://github.com/rust-lang/rust/issues/21786#issuecomment-225046735",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21786",
    "id": 225046735,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNTA0NjczNQ==",
    "user": {
      "login": "jonas-schievink",
      "id": 1786438,
      "node_id": "MDQ6VXNlcjE3ODY0Mzg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonas-schievink",
      "html_url": "https://github.com/jonas-schievink",
      "followers_url": "https://api.github.com/users/jonas-schievink/followers",
      "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions",
      "organizations_url": "https://api.github.com/users/jonas-schievink/orgs",
      "repos_url": "https://api.github.com/users/jonas-schievink/repos",
      "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonas-schievink/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-06-09T22:32:58Z",
    "updated_at": "2016-06-09T22:32:58Z",
    "body": "Updated code:\n\n``` rust\n#![feature(test)]\n#![crate_type=\"lib\"]\n\nextern crate test;\n\nstruct Big {\n  large: [u64; 100000],\n}\n\npub fn test_func() {\n  let x = Big {\n    large: [0; 100000],\n  };\n  test::black_box(x);\n}\n```\n\nNow produces this IR:\n\n``` llvm\n; Function Attrs: nounwind uwtable\ndefine void @_ZN8rust_out9test_func17h4ab794041fab200cE() unnamed_addr #0 {\nentry-block:\n  %arg = alloca %Big, align 8\n  %0 = bitcast %Big* %arg to i8*\n  call void @llvm.lifetime.start(i64 800000, i8* %0)\n  call void @llvm.memset.p0i8.i64(i8* %0, i8 0, i64 800000, i32 8, i1 false)\n  call void asm \"\", \"r,~{dirflag},~{fpsr},~{flags}\"(%Big* nonnull %arg) #2, !noalias !0, !srcloc !3\n  call void @llvm.lifetime.end(i64 800000, i8* %0) #2, !alias.scope !4, !noalias !0\n  call void @llvm.lifetime.end(i64 800000, i8* %0)\n  ret void\n}\n```\n\nThis only contains one `alloca`, so this specific example is fixed, but I'm not aware of any changes to lifetime intrinsics. I think MIR trans does not employ them at all.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/225046735/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/225203638",
    "html_url": "https://github.com/rust-lang/rust/issues/21786#issuecomment-225203638",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21786",
    "id": 225203638,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNTIwMzYzOA==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-06-10T14:50:45Z",
    "updated_at": "2016-06-10T14:50:45Z",
    "body": "Looks like the fix is very specific to this example, because LLVM can now transform `memset(%a, ...); memcpy(%b, %a, ...)` into `memset(%a, ...); memset(%b, ...)`, i.e. it only works for the `memset` case. \n\nThis still exposes the problem:\n\n``` rust\n#![feature(test)]\n#![crate_type=\"lib\"]\n\nextern crate test;\nstruct Big {\n  large: [u64; 100000],\n}\n\n\n#[inline(never)]\nfn foo() -> Big {\n    Big {\n        large: [123; 100000],\n    }\n}\n\npub fn test_func() {\n  let x = foo();\n  test::black_box(x);\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/225203638/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/445928898",
    "html_url": "https://github.com/rust-lang/rust/issues/21786#issuecomment-445928898",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21786",
    "id": 445928898,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NTkyODg5OA==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-12-10T18:53:15Z",
    "updated_at": "2018-12-10T18:53:15Z",
    "body": "Triage: today's nightly still produces\r\n\r\n```text\r\n; playground::test_func\r\n; Function Attrs: nounwind nonlazybind uwtable\r\ndefine void @_ZN10playground9test_func17h2edfd294766010a4E() unnamed_addr #1 {\r\nstart:\r\n  %_3 = alloca %Big, align 8\r\n  %x = alloca %Big, align 8\r\n  %0 = bitcast %Big* %x to i8*\r\n  call void @llvm.lifetime.start.p0i8(i64 800000, i8* nonnull %0)\r\n; call playground::foo\r\n  call fastcc void @_ZN10playground3foo17he93a54860fc3d9b4E(%Big* noalias nocapture nonnull dereferenceable(800000) %x)\r\n  %1 = bitcast %Big* %_3 to i8*\r\n  call void @llvm.lifetime.start.p0i8(i64 800000, i8* nonnull %1)\r\n  call void @llvm.memcpy.p0i8.p0i8.i64(i8* nonnull align 8 %1, i8* nonnull align 8 %0, i64 800000, i1 false)\r\n  call void asm sideeffect \"\", \"r,~{dirflag},~{fpsr},~{flags}\"(%Big* nonnull %_3) #3, !noalias !3, !srcloc !6\r\n  call void @llvm.lifetime.end.p0i8(i64 800000, i8* nonnull %1)\r\n  call void @llvm.lifetime.end.p0i8(i64 800000, i8* nonnull %0)\r\n  ret void\r\n}\r\n```\r\n\r\ntwo alloca's are still there.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/445928898/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2334734682",
    "html_url": "https://github.com/rust-lang/rust/issues/21786#issuecomment-2334734682",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21786",
    "id": 2334734682,
    "node_id": "IC_kwDOAAsO6M6LKTla",
    "user": {
      "login": "kadiwa4",
      "id": 25464294,
      "node_id": "MDQ6VXNlcjI1NDY0Mjk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/25464294?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kadiwa4",
      "html_url": "https://github.com/kadiwa4",
      "followers_url": "https://api.github.com/users/kadiwa4/followers",
      "following_url": "https://api.github.com/users/kadiwa4/following{/other_user}",
      "gists_url": "https://api.github.com/users/kadiwa4/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kadiwa4/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kadiwa4/subscriptions",
      "organizations_url": "https://api.github.com/users/kadiwa4/orgs",
      "repos_url": "https://api.github.com/users/kadiwa4/repos",
      "events_url": "https://api.github.com/users/kadiwa4/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kadiwa4/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-09-06T20:05:33Z",
    "updated_at": "2024-09-06T20:05:33Z",
    "body": "Can this still be reproduced? The current IR with Rust-side optimizations is:\r\n\r\n<details><summary>Before LLVM optimization</summary>\r\n\r\n```llvm\r\n; main::test_func\r\n; Function Attrs: uwtable\r\ndefine void @_ZN4main9test_func17hb1368fde245db818E() unnamed_addr #1 {\r\nstart:\r\n  %_2 = alloca [800000 x i8], align 8\r\n  %x = alloca [800000 x i8], align 8\r\n; call main::foo\r\n  call void @_ZN4main3foo17h6f3f3fecffc2ba45E(ptr noalias nocapture noundef sret([800000 x i8]) align 8 dereferenceable(800000) %x)\r\n  call void @llvm.lifetime.start.p0(i64 800000, ptr %_2)\r\n  call void @llvm.memcpy.p0.p0.i64(ptr align 8 %_2, ptr align 8 %x, i64 800000, i1 false)\r\n  call void asm sideeffect \"\", \"r,~{memory}\"(ptr %_2), !srcloc !2\r\n  call void @llvm.lifetime.end.p0(i64 800000, ptr %_2)\r\n  ret void\r\n}\r\n```\r\n</details>\r\n\r\nAfter LLVM optimization:\r\n```llvm\r\n; main::test_func\r\n; Function Attrs: uwtable\r\ndefine void @_ZN4main9test_func17hb1368fde245db818E() unnamed_addr #1 {\r\nstart:\r\n  %_2 = alloca [800000 x i8], align 8\r\n  call void @llvm.lifetime.start.p0(i64 800000, ptr nonnull %_2)\r\n; call main::foo\r\n  call fastcc void @_ZN4main3foo17h6f3f3fecffc2ba45E(ptr noalias nocapture noundef nonnull sret([800000 x i8]) align 8 dereferenceable(800000) %_2)\r\n  call void asm sideeffect \"\", \"r,~{memory}\"(ptr nonnull %_2) #4, !srcloc !2\r\n  call void @llvm.lifetime.end.p0(i64 800000, ptr nonnull %_2)\r\n  ret void\r\n}\r\n```\r\n\r\nThat's only one `alloca`. Is there a different reproducer that still shows how short lifetimes block these optimizations?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2334734682/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3061051374",
    "html_url": "https://github.com/rust-lang/rust/issues/21786#issuecomment-3061051374",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21786",
    "id": 3061051374,
    "node_id": "IC_kwDOAAsO6M62c-_u",
    "user": {
      "login": "tmiasko",
      "id": 51362316,
      "node_id": "MDQ6VXNlcjUxMzYyMzE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tmiasko",
      "html_url": "https://github.com/tmiasko",
      "followers_url": "https://api.github.com/users/tmiasko/followers",
      "following_url": "https://api.github.com/users/tmiasko/following{/other_user}",
      "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions",
      "organizations_url": "https://api.github.com/users/tmiasko/orgs",
      "repos_url": "https://api.github.com/users/tmiasko/repos",
      "events_url": "https://api.github.com/users/tmiasko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tmiasko/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2025-07-11T07:38:50Z",
    "updated_at": "2025-07-11T07:38:50Z",
    "body": "LLVM MemCpyOpt was taught to extend allocation lifetime when necessary to perform optimization. I think we can close the issue.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3061051374/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
