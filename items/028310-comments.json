[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138790567",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-138790567",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 138790567,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODc5MDU2Nw==",
    "user": {
      "login": "strega-nil",
      "id": 3479021,
      "node_id": "MDQ6VXNlcjM0NzkwMjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3479021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/strega-nil",
      "html_url": "https://github.com/strega-nil",
      "followers_url": "https://api.github.com/users/strega-nil/followers",
      "following_url": "https://api.github.com/users/strega-nil/following{/other_user}",
      "gists_url": "https://api.github.com/users/strega-nil/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/strega-nil/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/strega-nil/subscriptions",
      "organizations_url": "https://api.github.com/users/strega-nil/orgs",
      "repos_url": "https://api.github.com/users/strega-nil/repos",
      "events_url": "https://api.github.com/users/strega-nil/events{/privacy}",
      "received_events_url": "https://api.github.com/users/strega-nil/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-09T05:38:10Z",
    "updated_at": "2015-09-09T07:48:07Z",
    "body": "What is happening is that the drop flag is getting set to \"dropped\" in the second version, while it is never set off of \"not dropped\" in the first.\n\nEdit:\n\nWait no it isn't. I don't understand...\n\n``` LLVM\ndefine internal void @_ZN4main20he4ee6787faa2909bPaaE() unnamed_addr #0 {\nentry-block:\n  %dropflag_hint_46 = alloca i8\n  %d = alloca %Dropper\n\n  /* This is the place the dropflag is set */\n  store i8 61, i8* %dropflag_hint_46\n  %0 = getelementptr inbounds %Dropper, %Dropper* %d, i32 0, i32 0, !dbg !208\n  store i8 -44, i8* %0, !dbg !208\n  /* End dropflag set */\n\n  call void @llvm.dbg.declare(metadata %Dropper* %d, metadata !210, metadata !192), !dbg !208\n\n  // drop called\n  call void @_ZN7Dropper9drop.256317hcf85f43760592a92E(%Dropper* %d), !dbg !211\n  ret void, !dbg !212\n}\n```\n\nand part 2:\n\n``` LLVM\ndefine internal void @_ZN4main20h03656b023385628cPaaE() unnamed_addr #0 {\nentry-block:\n  %dropflag_hint_46 = alloca i8\n  %d = alloca %Dropper\n  %0 = alloca i8\n  %let = alloca i8\n\n  /* Set dropflag */\n  store i8 61, i8* %dropflag_hint_46\n  %1 = getelementptr inbounds %Dropper, %Dropper* %d, i32 0, i32 0, !dbg !208\n  store i8 -44, i8* %1, !dbg !208\n  /* end set dropflag */\n\n  call void @llvm.dbg.declare(metadata %Dropper* %d, metadata !210, metadata !192), !dbg !208\n  %2 = bitcast i8* %0 to %Dropper*, !dbg !211\n  %3 = bitcast %Dropper* %d to i8*, !dbg !211\n  %4 = bitcast %Dropper* %2 to i8*, !dbg !211\n  call void @llvm.memcpy.p0i8.p0i8.i64(i8* %4, i8* %3, i64 1, i32 1, i1 false)\n  %5 = bitcast %Dropper* %d to i8*\n  call void @llvm.memset.p0i8.i64(i8* %5, i8 29, i64 1, i32 1, i1 false)\n  %6 = load i8, i8* %0, align 1\n  store i8 %6, i8* %let, align 1\n\n  // Drop called\n  call void @_ZN7Dropper9drop.256317h2845f499b38a318cE(%Dropper* %d), !dbg !213\n  ret void, !dbg !214\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138790567/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138814099",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-138814099",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 138814099,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODgxNDA5OQ==",
    "user": {
      "login": "strega-nil",
      "id": 3479021,
      "node_id": "MDQ6VXNlcjM0NzkwMjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3479021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/strega-nil",
      "html_url": "https://github.com/strega-nil",
      "followers_url": "https://api.github.com/users/strega-nil/followers",
      "following_url": "https://api.github.com/users/strega-nil/following{/other_user}",
      "gists_url": "https://api.github.com/users/strega-nil/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/strega-nil/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/strega-nil/subscriptions",
      "organizations_url": "https://api.github.com/users/strega-nil/orgs",
      "repos_url": "https://api.github.com/users/strega-nil/repos",
      "events_url": "https://api.github.com/users/strega-nil/events{/privacy}",
      "received_events_url": "https://api.github.com/users/strega-nil/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-09T07:43:48Z",
    "updated_at": "2015-09-09T07:47:28Z",
    "body": "Okay, I started reading the assembly, because it makes way more sense.\n\nCleaned up:\n\n``` nasm\nmain:\n    push    rbp\n    mov rbp, rsp\n    sub rsp, 16\n\n    lea rdi, [rbp - 8]\n    mov byte ptr [rbp - 1], 61\n    mov byte ptr [rbp - 8], -44 ; this is where the drop flag is set\n    call    _ZN7Dropper9drop.256317hcf85f43760592a92E\n\n    add rsp, 16\n    pop rbp\n    ret\n```\n\nand\n\n``` nasm\nmain:\n    push    rbp\n    mov rbp, rsp\n    sub rsp, 32\n    lea rax, [rbp - 8] ; first, remember that rax points to the Dropper\n\n    ; begin the memset call\n    mov esi, 29 ; this is what we're memsetting to\n    mov ecx, 1\n    mov edx, ecx ; set one byte\n    mov byte ptr [rbp - 1], 61\n\n    mov byte ptr [rbp - 8], -44 ; notice we set the drop flag here\n    mov dil, byte ptr [rbp - 8]\n    mov byte ptr [rbp - 9], dil\n    mov r8, rax\n    mov qword ptr [rbp - 24], rax ; r8 and [rbp - 24] are both pointing to the Dropper now\n    mov rdi, r8 ; we're memsetting the Dropper, here\n    call    memset@PLT   ; this memset\n\n    mov r9b, byte ptr [rbp - 9]\n    mov byte ptr [rbp - 10], r9b\n\n    mov rdi, qword ptr [rbp - 24]\n    call    _ZN7Dropper9drop.256317h2845f499b38a318cE\n\n    add rsp, 32\n    pop rbp\n    ret\n```\n\nNotice the memset. That's where the drop flag gets set to the correct, DTOR_DONE\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138814099/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138955347",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-138955347",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 138955347,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODk1NTM0Nw==",
    "user": {
      "login": "arielb1",
      "id": 1830974,
      "node_id": "MDQ6VXNlcjE4MzA5NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arielb1",
      "html_url": "https://github.com/arielb1",
      "followers_url": "https://api.github.com/users/arielb1/followers",
      "following_url": "https://api.github.com/users/arielb1/following{/other_user}",
      "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions",
      "organizations_url": "https://api.github.com/users/arielb1/orgs",
      "repos_url": "https://api.github.com/users/arielb1/repos",
      "events_url": "https://api.github.com/users/arielb1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arielb1/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-09T15:55:39Z",
    "updated_at": "2015-09-09T15:55:39Z",
    "body": "`d` is consumed by the transmute and should not be dropped.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138955347/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/196331986",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-196331986",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 196331986,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5NjMzMTk4Ng==",
    "user": {
      "login": "bltavares",
      "id": 109474,
      "node_id": "MDQ6VXNlcjEwOTQ3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/109474?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bltavares",
      "html_url": "https://github.com/bltavares",
      "followers_url": "https://api.github.com/users/bltavares/followers",
      "following_url": "https://api.github.com/users/bltavares/following{/other_user}",
      "gists_url": "https://api.github.com/users/bltavares/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bltavares/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bltavares/subscriptions",
      "organizations_url": "https://api.github.com/users/bltavares/orgs",
      "repos_url": "https://api.github.com/users/bltavares/repos",
      "events_url": "https://api.github.com/users/bltavares/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bltavares/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-03-14T14:27:01Z",
    "updated_at": "2016-03-14T14:27:01Z",
    "body": "Triaging: is this still a valid issue?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/196331986/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/196390628",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-196390628",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 196390628,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5NjM5MDYyOA==",
    "user": {
      "login": "strega-nil",
      "id": 3479021,
      "node_id": "MDQ6VXNlcjM0NzkwMjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3479021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/strega-nil",
      "html_url": "https://github.com/strega-nil",
      "followers_url": "https://api.github.com/users/strega-nil/followers",
      "following_url": "https://api.github.com/users/strega-nil/following{/other_user}",
      "gists_url": "https://api.github.com/users/strega-nil/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/strega-nil/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/strega-nil/subscriptions",
      "organizations_url": "https://api.github.com/users/strega-nil/orgs",
      "repos_url": "https://api.github.com/users/strega-nil/repos",
      "events_url": "https://api.github.com/users/strega-nil/events{/privacy}",
      "received_events_url": "https://api.github.com/users/strega-nil/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-03-14T16:17:04Z",
    "updated_at": "2016-03-14T16:17:04Z",
    "body": "Yes.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/196390628/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/196399988",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-196399988",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 196399988,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5NjM5OTk4OA==",
    "user": {
      "login": "eddyb",
      "id": 77424,
      "node_id": "MDQ6VXNlcjc3NDI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eddyb",
      "html_url": "https://github.com/eddyb",
      "followers_url": "https://api.github.com/users/eddyb/followers",
      "following_url": "https://api.github.com/users/eddyb/following{/other_user}",
      "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions",
      "organizations_url": "https://api.github.com/users/eddyb/orgs",
      "repos_url": "https://api.github.com/users/eddyb/repos",
      "events_url": "https://api.github.com/users/eddyb/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eddyb/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-03-14T16:31:43Z",
    "updated_at": "2016-03-14T16:34:51Z",
    "body": "Well, MIR _as it is right now_, with `transmute` in another function. My MIR `transmute` might work, didn't get to check it yet.\n**EDIT**: Indeed, with `-Z orbit` (#32080) the drop doesn't trigger, as the MIR `transmute` code uses the general MIR method for marking an operand as consumed.\n\n``` rust\n#![crate_type = \"lib\"]\n\npub struct Dropper;\n\nimpl Drop for Dropper {\n    fn drop(&mut self) {}\n}\n\npub unsafe fn foo(d: Dropper) {\n    std::mem::transmute::<_, u8>(d);\n}\n```\n\nThe IR for this shows that `d` is managed using a `dropflag_hint_19` variable but `transmute` unconditionally calls the drop glue without looking at `dropflag_hint_19`.\n_While_ the drop glue checks for the drop filling pattern, `d` was never overwritten with it (because `dropflag_hint_19` is being used instead for that purpose).\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/196399988/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/298476106",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-298476106",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 298476106,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODQ3NjEwNg==",
    "user": {
      "login": "Mark-Simulacrum",
      "id": 5047365,
      "node_id": "MDQ6VXNlcjUwNDczNjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Mark-Simulacrum",
      "html_url": "https://github.com/Mark-Simulacrum",
      "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers",
      "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}",
      "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions",
      "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs",
      "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos",
      "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-05-02T01:35:39Z",
    "updated_at": "2017-05-02T01:35:39Z",
    "body": "The two code samples in the original issue now compile with equivalent outputs (no output), which is what I think we expect to have happen, though I'm only ~90% sure. As such, I'm going to close, but please do reopen if this is still an issue with a code sample that demonstrates it.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/298476106/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/298492622",
    "html_url": "https://github.com/rust-lang/rust/issues/28310#issuecomment-298492622",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28310",
    "id": 298492622,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODQ5MjYyMg==",
    "user": {
      "login": "strega-nil",
      "id": 3479021,
      "node_id": "MDQ6VXNlcjM0NzkwMjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3479021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/strega-nil",
      "html_url": "https://github.com/strega-nil",
      "followers_url": "https://api.github.com/users/strega-nil/followers",
      "following_url": "https://api.github.com/users/strega-nil/following{/other_user}",
      "gists_url": "https://api.github.com/users/strega-nil/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/strega-nil/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/strega-nil/subscriptions",
      "organizations_url": "https://api.github.com/users/strega-nil/orgs",
      "repos_url": "https://api.github.com/users/strega-nil/repos",
      "events_url": "https://api.github.com/users/strega-nil/events{/privacy}",
      "received_events_url": "https://api.github.com/users/strega-nil/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-05-02T04:05:58Z",
    "updated_at": "2017-05-02T04:05:58Z",
    "body": "I would like to point out that this is entirely undefined behavior, and therefore technically correct compilation :)",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/298492622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
