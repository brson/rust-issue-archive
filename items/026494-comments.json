[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/114016492",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-114016492",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 114016492,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExNDAxNjQ5Mg==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-22T06:18:02Z",
    "updated_at": "2015-06-22T06:18:02Z",
    "body": "For fat pointers this has been fixed in #26411\nAm 22.06.2015 07:58 schrieb \"Reiner Pope\" notifications@github.com:\n\n> Rust should pass more structs in registers. Consider these examples:\n> ideally, both functions would execute entirely in registers and wouldn't\n> touch memory:\n> \n> // Passing small structs by value.\n> pub fn parameters_by_value(v: (u64, u64)) -> u64 {\n>   v.0 + v.1\n> }\n> \n> // Returning small structs by value.\n> pub fn return_by_value() -> (u64, u64) {\n>   (3, 4)\n> }\n> \n> Rust, as of a recent 1.2.0-dev nightly, is unable to pass either of these\n> in registers (see LLVM IR and ASM below). It would be pretty safe to pass\n> and return small structs (ones that fit into <=2 registers) in registers,\n> and is likely to improve performance on average. This is what the System V\n> ABI does.\n> \n> It would also be nice to exploit Rust's control over aliasing, and where\n> possible also promote _reference_ arguments to registers, i.e. put the u64\n> values in registers for the following functions:\n> \n> // Passing small structs by reference.\n> pub fn parameters_by_ref(v: &(u64, u64)) -> u64 {\n>   v.0 + v.1\n> }\n> \n> // Passing small structs by _mutable_ reference.\n> pub fn mutable_parameters_by_ref(v: &mut (u64, u64)) {\n>   v.0 += 1;\n>   v.1 += 2;\n> }\n> \n> In the &mut case, this would mean passing two u64 values in registers as\n> function parameters, and returning two u64 values in registers as the\n> return values (ideally we'd arrange for the parameter registers to match\n> the return registers). Uniqueness of &mut makes this optimization valid,\n> although we may have to give up on this optimization in cases such as when\n> there are raw pointers present.\n> \n> Here's a more realistic example where I've wanted Rust to do this:\n> \n> pub fn skip_whitespace(iter: &mut std::str::Chars) -> u64 {\n>   // Reads as much whitespace as possible from the front of iter, then returns the number of\n>   // characters read.\n>   ...\n> }\n> \n> This function is too large to justify inlining. I'd like the begin and end\n> pointers of iter to be kept in registers across the function call.\n> \n> Probably not surprising to the compiler team, but for completeness here is\n> the LLVM IR of the above snippets, as of today's Rust (1.2.0-dev), compiled\n> in release mode / opt-level=3:\n> \n> define i64 @_ZN19parameters_by_value20h3d287104250c57c4eaaE({ i64, i64 }\\* noalias nocapture dereferenceable(16)) unnamed_addr #0 {\n> entry-block:\n>   %1 = getelementptr inbounds { i64, i64 }, { i64, i64 }\\* %0, i64 0, i32 0\n>   %2 = getelementptr inbounds { i64, i64 }, { i64, i64 }\\* %0, i64 0, i32 1\n>   %3 = load i64, i64\\* %1, align 8\n>   %4 = load i64, i64\\* %2, align 8\n>   %5 = add i64 %4, %3\n>   %6 = bitcast { i64, i64 }\\* %0 to i8*\n>   tail call void @llvm.lifetime.end(i64 16, i8\\* %6)\n>   ret i64 %5\n> }\n> \n> define void @_ZN15return_by_value20h703d16a2e5f298d6saaE({ i64, i64 }\\* noalias nocapture sret dereferenceable(16)) unnamed_addr #0 {\n> entry-block:\n>   %1 = bitcast { i64, i64 }\\* %0 to i8*\n>   tail call void @llvm.memcpy.p0i8.p0i8.i64(i8\\* %1, i8\\* bitcast ({ i64, i64 }\\* @const1285 to i8*), i64 16, i32 8, i1 false)\n>   ret void\n> }\n> \n> define i64 @_ZN17parameters_by_ref20hc9c548b23d173a1aBaaE({ i64, i64 }\\* noalias nocapture readonly dereferenceable(16)) unnamed_addr #2 {\n> entry-block:\n>   %1 = getelementptr inbounds { i64, i64 }, { i64, i64 }\\* %0, i64 0, i32 0\n>   %2 = getelementptr inbounds { i64, i64 }, { i64, i64 }\\* %0, i64 0, i32 1\n>   %3 = load i64, i64\\* %1, align 8\n>   %4 = load i64, i64\\* %2, align 8\n>   %5 = add i64 %4, %3\n>   ret i64 %5\n> }\n> \n> define void @_ZN25mutable_parameters_by_ref20h736bc2daba227c43QaaE({ i64, i64 }\\* noalias nocapture dereferenceable(16)) unnamed_addr #0 {\n> entry-block:\n>   %1 = bitcast { i64, i64 }\\* %0 to <2 x i64>*\n>   %2 = load <2 x i64>, <2 x i64>\\* %1, align 8\n>   %3 = add <2 x i64> %2, <i64 1, i64 2>\n>   %4 = bitcast { i64, i64 }\\* %0 to <2 x i64>*\n>   store <2 x i64> %3, <2 x i64>\\* %4, align 8\n>   ret void\n> }\n> \n> and here is the ASM:\n> \n> _ZN19parameters_by_value20h3d287104250c57c4eaaE:\n>         .cfi_startproc\n>         movq    8(%rdi), %rax\n>         addq    (%rdi), %rax\n>         retq\n> \n> _ZN15return_by_value20h703d16a2e5f298d6saaE:\n>         .cfi_startproc\n>         movups  const1285(%rip), %xmm0\n>         movups  %xmm0, (%rdi)\n>         movq    %rdi, %rax\n>         retq\n> \n> _ZN17parameters_by_ref20hc9c548b23d173a1aBaaE:\n>         .cfi_startproc\n>         movq    8(%rdi), %rax\n>         addq    (%rdi), %rax\n>         retq\n> \n> _ZN25mutable_parameters_by_ref20h736bc2daba227c43QaaE:\n>         .cfi_startproc\n>         movdqu  (%rdi), %xmm0\n>         paddq   .LCPI3_0(%rip), %xmm0\n>         movdqu  %xmm0, (%rdi)\n>         retq\n> \n> \u2014\n> Reply to this email directly or view it on GitHub\n> https://github.com/rust-lang/rust/issues/26494.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/114016492/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/114027752",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-114027752",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 114027752,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExNDAyNzc1Mg==",
    "user": {
      "login": "arielb1",
      "id": 1830974,
      "node_id": "MDQ6VXNlcjE4MzA5NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arielb1",
      "html_url": "https://github.com/arielb1",
      "followers_url": "https://api.github.com/users/arielb1/followers",
      "following_url": "https://api.github.com/users/arielb1/following{/other_user}",
      "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions",
      "organizations_url": "https://api.github.com/users/arielb1/orgs",
      "repos_url": "https://api.github.com/users/arielb1/repos",
      "events_url": "https://api.github.com/users/arielb1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arielb1/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-22T07:32:43Z",
    "updated_at": "2015-06-22T07:32:43Z",
    "body": "On `skip_whitespace` etc. this is currently impossible because the address of references is significant (you can e.g. print it with `println!(\"{:?}\", iter as *const _)`).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/114027752/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/114176829",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-114176829",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 114176829,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExNDE3NjgyOQ==",
    "user": {
      "login": "reinerp",
      "id": 777239,
      "node_id": "MDQ6VXNlcjc3NzIzOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/777239?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/reinerp",
      "html_url": "https://github.com/reinerp",
      "followers_url": "https://api.github.com/users/reinerp/followers",
      "following_url": "https://api.github.com/users/reinerp/following{/other_user}",
      "gists_url": "https://api.github.com/users/reinerp/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/reinerp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/reinerp/subscriptions",
      "organizations_url": "https://api.github.com/users/reinerp/orgs",
      "repos_url": "https://api.github.com/users/reinerp/repos",
      "events_url": "https://api.github.com/users/reinerp/events{/privacy}",
      "received_events_url": "https://api.github.com/users/reinerp/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-22T16:50:19Z",
    "updated_at": "2015-06-22T16:50:19Z",
    "body": "@arielb1 - yes, the ability to take addresses prevents doing this for all functions. But you could see doing this as an optimization: make the compiler check whether a function uses the address of a reference, and if not then change its calling convention. The compiler can use the worker/wrapper technique (as in GHC) to support call sites which aren't aware of this change in calling convention, by splitting the function into two:\n\n``` rust\n// Non-inlined worker, uses fast in-register calling convention\npub fn skip_whitespace_worker(start: u8*, end: u8*) -> (u8*, u8*, u64) {\n  ...\n}\n\n// Inlined wrapper, moves reference argument to registers and then calls the worker.\npub fn skip_whitespace(v: &mut std::str::Chars) -> u64 {\n  // Approximately:\n  let (start, end, len) = skip_whitespace_worker(v.start, v.end);\n  mut.start = start;\n  mut.end = end;\n  len\n}\n```\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/114176829/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/122967942",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-122967942",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 122967942,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEyMjk2Nzk0Mg==",
    "user": {
      "login": "pcwalton",
      "id": 157897,
      "node_id": "MDQ6VXNlcjE1Nzg5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pcwalton",
      "html_url": "https://github.com/pcwalton",
      "followers_url": "https://api.github.com/users/pcwalton/followers",
      "following_url": "https://api.github.com/users/pcwalton/following{/other_user}",
      "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions",
      "organizations_url": "https://api.github.com/users/pcwalton/orgs",
      "repos_url": "https://api.github.com/users/pcwalton/repos",
      "events_url": "https://api.github.com/users/pcwalton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pcwalton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-07-20T17:57:05Z",
    "updated_at": "2015-07-20T17:57:05Z",
    "body": "Don't do this. You will break FastISel. Fix LLVM if it's not doing the optimizations you want.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/122967942/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/123019550",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-123019550",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 123019550,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEyMzAxOTU1MA==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-07-20T20:21:06Z",
    "updated_at": "2015-07-20T20:21:06Z",
    "body": "@pcwalton what exactly would break FastISel?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/123019550/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/377941114",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-377941114",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 377941114,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3Nzk0MTExNA==",
    "user": {
      "login": "nox",
      "id": 123095,
      "node_id": "MDQ6VXNlcjEyMzA5NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/123095?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nox",
      "html_url": "https://github.com/nox",
      "followers_url": "https://api.github.com/users/nox/followers",
      "following_url": "https://api.github.com/users/nox/following{/other_user}",
      "gists_url": "https://api.github.com/users/nox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nox/subscriptions",
      "organizations_url": "https://api.github.com/users/nox/orgs",
      "repos_url": "https://api.github.com/users/nox/repos",
      "events_url": "https://api.github.com/users/nox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nox/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-04-02T14:27:44Z",
    "updated_at": "2018-04-02T14:27:44Z",
    "body": "Pretty sure that since @eddyb's work on niche-filling optimisation, `parameters_by_value` and `return_by_value` use a pair of registers for the argument and the return value, respectively.\r\n\r\nCc @rust-lang/wg-codegen ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/377941114/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/531498469",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-531498469",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 531498469,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTQ5ODQ2OQ==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-09-14T17:34:14Z",
    "updated_at": "2019-09-14T17:34:14Z",
    "body": "@eddyb didn't `Abi::ScalarPair` solve this?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/531498469/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/531498782",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-531498782",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 531498782,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTQ5ODc4Mg==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-09-14T17:39:07Z",
    "updated_at": "2019-09-14T17:39:07Z",
    "body": "Yes, this appears to be fixed. The following Rust code (https://rust.godbolt.org/z/LhQGOM):\r\n\r\n```rust\r\n// Passing small structs by value.\r\npub fn parameters_by_value(v: (u64, u64)) -> u64 {                                                                                                                                                          \r\n  v.0 + v.1\r\n}\r\n\r\n// Returning small structs by value.\r\npub fn return_by_value() -> (u64, u64) {\r\n  (3, 4)\r\n}\r\n```\r\n\r\ngenerates\r\n\r\n```asm\r\nexample::parameters_by_value:\r\n        lea     rax, [rdi + rsi]\r\n        ret\r\n\r\nexample::return_by_value:\r\n        mov     eax, 3\r\n        mov     edx, 4\r\n        ret\r\n```\r\n\r\nand\r\n\r\n```llvm\r\ndefine i64 @parameters_by_value(i64 %v.0, i64 %v.1) unnamed_addr #0 {\r\nstart:\r\n  %0 = add i64 %v.1, %v.0\r\n  ret i64 %0\r\n}\r\n\r\ndefine { i64, i64 } @return_by_value() unnamed_addr #0 {\r\nstart:\r\n  ret { i64, i64 } { i64 3, i64 4 }\r\n}\r\n```",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/531498782/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/531498939",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-531498939",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 531498939,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTQ5ODkzOQ==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-09-14T17:41:39Z",
    "updated_at": "2019-09-14T18:43:47Z",
    "body": "Ah no, I see that this issue also suggests: \r\n\r\n> It would also be nice to exploit Rust's control over aliasing, and where possible also promote reference arguments to registers, i.e. put the u64 values in registers for the following functions:\r\n\r\nWe don't do that yet: https://rust.godbolt.org/z/qnK9Ta .\r\n\r\nFWIW Maybe it is worth to split this issue into two. One part has been closed already AFAICT. \r\n\r\nThe other part (passing `&T` as a register containing a `T`) is... a suggestion at most. This issue does not suggest how to do this. @pcwalton already raised the issue that this breaks if the address is inspected. It probably needs to handle writes through `&T` (e.g. due to `UnsafeCell`) and `&mut T` somehow as well, etc. So I'm skeptic that this can work.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/531498939/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/619506345",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-619506345",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 619506345,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxOTUwNjM0NQ==",
    "user": {
      "login": "matklad",
      "id": 1711539,
      "node_id": "MDQ6VXNlcjE3MTE1Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matklad",
      "html_url": "https://github.com/matklad",
      "followers_url": "https://api.github.com/users/matklad/followers",
      "following_url": "https://api.github.com/users/matklad/following{/other_user}",
      "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matklad/subscriptions",
      "organizations_url": "https://api.github.com/users/matklad/orgs",
      "repos_url": "https://api.github.com/users/matklad/repos",
      "events_url": "https://api.github.com/users/matklad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matklad/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-04-26T08:09:04Z",
    "updated_at": "2020-04-26T08:09:04Z",
    "body": "Here's another slightly more complex example, where `extern \"C\"` ABI seems to be more efficient than `extern \"rust\"`:\r\n\r\n```rust\r\npub struct Stats { x: u32, y: u32, z: u32, }\r\n\r\npub extern \"C\" fn sum_c(a: &Stats, b: &Stats) -> Stats {\r\n    return Stats {x: a.x + b.x, y: a.y + b.y, z: a.z + b.z };\r\n}\r\n\r\npub fn sum_rust(a: &Stats, b: &Stats) -> Stats {\r\n    return Stats {x: a.x + b.x, y: a.y + b.y, z: a.z + b.z };\r\n}\r\n```\r\n[godbolt](https://godbolt.org/z/JCsSLq)",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/619506345/reactions",
      "total_count": 10,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 7
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/695952796",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-695952796",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 695952796,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NTk1Mjc5Ng==",
    "user": {
      "login": "leonardo-m",
      "id": 22328461,
      "node_id": "MDQ6VXNlcjIyMzI4NDYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/22328461?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leonardo-m",
      "html_url": "https://github.com/leonardo-m",
      "followers_url": "https://api.github.com/users/leonardo-m/followers",
      "following_url": "https://api.github.com/users/leonardo-m/following{/other_user}",
      "gists_url": "https://api.github.com/users/leonardo-m/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leonardo-m/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leonardo-m/subscriptions",
      "organizations_url": "https://api.github.com/users/leonardo-m/orgs",
      "repos_url": "https://api.github.com/users/leonardo-m/repos",
      "events_url": "https://api.github.com/users/leonardo-m/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leonardo-m/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-09-21T07:35:42Z",
    "updated_at": "2020-09-21T07:35:42Z",
    "body": "A related thread:\r\nhttps://users.rust-lang.org/t/regarding-funciton-calls/48359",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/695952796/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753393566",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-753393566",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 753393566,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MzM5MzU2Ng==",
    "user": {
      "login": "oilaba",
      "id": 61464752,
      "node_id": "MDQ6VXNlcjYxNDY0NzUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/61464752?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/oilaba",
      "html_url": "https://github.com/oilaba",
      "followers_url": "https://api.github.com/users/oilaba/followers",
      "following_url": "https://api.github.com/users/oilaba/following{/other_user}",
      "gists_url": "https://api.github.com/users/oilaba/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/oilaba/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/oilaba/subscriptions",
      "organizations_url": "https://api.github.com/users/oilaba/orgs",
      "repos_url": "https://api.github.com/users/oilaba/repos",
      "events_url": "https://api.github.com/users/oilaba/events{/privacy}",
      "received_events_url": "https://api.github.com/users/oilaba/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-01-01T22:18:35Z",
    "updated_at": "2021-01-01T22:19:52Z",
    "body": "@matklad is this fixed? Linked code is still bigger on Rust 1.48.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753393566/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753586418",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-753586418",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 753586418,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MzU4NjQxOA==",
    "user": {
      "login": "matklad",
      "id": 1711539,
      "node_id": "MDQ6VXNlcjE3MTE1Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matklad",
      "html_url": "https://github.com/matklad",
      "followers_url": "https://api.github.com/users/matklad/followers",
      "following_url": "https://api.github.com/users/matklad/following{/other_user}",
      "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matklad/subscriptions",
      "organizations_url": "https://api.github.com/users/matklad/orgs",
      "repos_url": "https://api.github.com/users/matklad/repos",
      "events_url": "https://api.github.com/users/matklad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matklad/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-01-03T08:48:20Z",
    "updated_at": "2021-01-03T08:48:20Z",
    "body": "@oilaba my example is fixed, the return value is no longer via stack:\r\n\r\n```\r\nbefore:\r\n        mov     dword ptr [rdi], ecx\r\n        mov     dword ptr [rdi + 4], r8d\r\n        mov     dword ptr [rdi + 8], edx\r\n        ret\r\n\r\nafter:\r\n        movd    edx, xmm0\r\n        movd    ecx, xmm1\r\n        shl     rcx, 32\r\n        or      rax, rcx\r\n        ret\r\n```\r\n\r\nThe difference is that rust abi version now uses a vectorized add, which seems like a win?\r\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753586418/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/987521122",
    "html_url": "https://github.com/rust-lang/rust/issues/26494#issuecomment-987521122",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26494",
    "id": 987521122,
    "node_id": "IC_kwDOAAsO6M463GBi",
    "user": {
      "login": "shampoofactory",
      "id": 56542103,
      "node_id": "MDQ6VXNlcjU2NTQyMTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/56542103?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shampoofactory",
      "html_url": "https://github.com/shampoofactory",
      "followers_url": "https://api.github.com/users/shampoofactory/followers",
      "following_url": "https://api.github.com/users/shampoofactory/following{/other_user}",
      "gists_url": "https://api.github.com/users/shampoofactory/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shampoofactory/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shampoofactory/subscriptions",
      "organizations_url": "https://api.github.com/users/shampoofactory/orgs",
      "repos_url": "https://api.github.com/users/shampoofactory/repos",
      "events_url": "https://api.github.com/users/shampoofactory/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shampoofactory/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-07T02:56:27Z",
    "updated_at": "2021-12-07T02:58:04Z",
    "body": "Hi all. I've traced back the cause of 'P-high' issue #85265 to two pulls that relate to this issue, namely #76986 and #79547.\r\n\r\nBasically, these commits break auto-vectorization post Rust version 1.48 in a way that is not easily worked around.\r\n\r\nIn short, if we take:\r\n\r\n```Rust\r\npub fn case_1(a: [f32; 4], b: [f32; 4]) -> [f32; 4] {\r\n    [\r\n        a[0] + b[0],\r\n        a[1] + b[1],\r\n        a[2] + b[2],\r\n        a[3] + b[3],\r\n    ]\r\n}\r\n```\r\n\r\n1.47 yields an efficient:\r\n\r\nhttps://rust.godbolt.org/z/v89zoajse\r\n```asm\r\nexample::case_1:\r\n        mov     rax, rdi\r\n        movups  xmm0, xmmword ptr [rsi]\r\n        movups  xmm1, xmmword ptr [rdx]\r\n        addps   xmm1, xmm0\r\n        movups  xmmword ptr [rdi], xmm1\r\n        ret\r\n```\r\n\r\n1.48 yields an awkward:\r\n\r\nhttps://rust.godbolt.org/z/hqT85doqf\r\n```asm\r\nexample::case_1:\r\n        movss   xmm0, dword ptr [rdi]\r\n        movss   xmm1, dword ptr [rdi + 4]\r\n        addss   xmm0, dword ptr [rsi]\r\n        addss   xmm1, dword ptr [rsi + 4]\r\n        movsd   xmm2, qword ptr [rdi + 8]\r\n        movsd   xmm3, qword ptr [rsi + 8]\r\n        addps   xmm3, xmm2\r\n        movd    eax, xmm0\r\n        movd    ecx, xmm1\r\n        movd    esi, xmm3\r\n        shufps  xmm3, xmm3, 229\r\n        movd    edx, xmm3\r\n        shl     rdx, 32\r\n        or      rdx, rsi\r\n        shl     rcx, 32\r\n        or      rax, rcx\r\n        ret\r\n```\r\n\r\n1.50 yields an even more awkward cascade effect:\r\n\r\nhttps://rust.godbolt.org/z/vvEePzGEM\r\n```asm\r\nexample::case_1:\r\n        movd    xmm0, esi\r\n        shr     rsi, 32\r\n        movd    xmm1, edi\r\n        shr     rdi, 32\r\n        movd    xmm2, edi\r\n        punpckldq       xmm1, xmm2\r\n        movd    xmm2, esi\r\n        movd    xmm3, edx\r\n        shr     rdx, 32\r\n        movd    xmm4, edx\r\n        punpckldq       xmm3, xmm4\r\n        movd    xmm4, ecx\r\n        shr     rcx, 32\r\n        addps   xmm3, xmm1\r\n        addss   xmm4, xmm0\r\n        movd    xmm0, ecx\r\n        addss   xmm0, xmm2\r\n        movd    edx, xmm4\r\n        movd    eax, xmm0\r\n        shl     rax, 32\r\n        or      rdx, rax\r\n        movd    ecx, xmm3\r\n        shufps  xmm3, xmm3, 229\r\n        movd    eax, xmm3\r\n        shl     rax, 32\r\n        or      rax, rcx\r\n        ret\r\n```\r\n\r\n\r\nThere are other examples in #85265.\r\n\r\nMy overly simplistic analysis, I'm no expert, is [here](https://github.com/rust-lang/rust/issues/85265#issuecomment-987511862). \r\n\r\nIn summary, if I rebuild Rust with the above pulls neutered, auto-vectorization appears to return to normal, as per 1.47.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/987521122/reactions",
      "total_count": 5,
      "+1": 5,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
