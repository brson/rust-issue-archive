[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48102934",
    "html_url": "https://github.com/rust-lang/rust/issues/15469#issuecomment-48102934",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/15469",
    "id": 48102934,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MTAyOTM0",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-06T04:45:25Z",
    "updated_at": "2014-07-06T04:45:25Z",
    "body": "Could you post a reproducing example? (Even if it's not minimal, although that would be nice. :) )\n\nJust substituting best-guess definitions in naively doesn't reproduce the ICE:\n\n``` rust\nextern crate libc;\n\nuse libc::{c_void, c_int};\n\nstruct LivelyPenData { pen: uint, cb: extern \"C\" fn() }\nstruct LivelyPenEvent { id: c_int, data: Box<LivelyPenData> }\n\nextern \"C\" fn pen_lively_callback() {}\nextern \"C\" fn cb() {}\n\nmod c {\n    extern {\n        pub fn tickit_pen_bind_event(x: uint, ev: (), fun: Option<extern \"C\" fn()>, ptr: *mut ::libc::c_void) -> ::libc::c_int;\n    }\n}\n\nfn main() {\n    let ev = ();\n\n        unsafe\n        {\n            let fun = Some(pen_lively_callback);\n            let data = box LivelyPenData{pen: 0, cb: cb};\n            let mut id: c_int = 0;\n            {\n                let raw_data_ptr: *const *const LivelyPenData = std::mem::transmute(&data);\n                let raw_data = *raw_data_ptr;\n                let raw_data: *mut c_void = std::mem::transmute(raw_data);\n                id = c::tickit_pen_bind_event(0, ev, fun, raw_data);\n            };\n            LivelyPenEvent{id: id, data: data}\n        };\n\n}\n```\n\nThat compiles (on the playpen) with a pile of warnings and a linkage error, but no ICE.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48102934/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48103953",
    "html_url": "https://github.com/rust-lang/rust/issues/15469#issuecomment-48103953",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/15469",
    "id": 48103953,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MTAzOTUz",
    "user": {
      "login": "o11c",
      "id": 964689,
      "node_id": "MDQ6VXNlcjk2NDY4OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/964689?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/o11c",
      "html_url": "https://github.com/o11c",
      "followers_url": "https://api.github.com/users/o11c/followers",
      "following_url": "https://api.github.com/users/o11c/following{/other_user}",
      "gists_url": "https://api.github.com/users/o11c/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/o11c/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/o11c/subscriptions",
      "organizations_url": "https://api.github.com/users/o11c/orgs",
      "repos_url": "https://api.github.com/users/o11c/repos",
      "events_url": "https://api.github.com/users/o11c/events{/privacy}",
      "received_events_url": "https://api.github.com/users/o11c/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-06T06:13:01Z",
    "updated_at": "2014-07-06T06:13:01Z",
    "body": "Looks like the external C functions needing the data pointer was a red herring.\n\n``` rust\n#![crate_type = \"dylib\"]\n\nstruct Boxee<'a> {\n    cb: ||: 'a,\n}\n\npub struct Boxer<'a> {\n    data: Box<Boxee<'a>>,\n}\n\nimpl<'a> Drop for Boxer<'a> {\n    fn drop(&mut self) {\n        println!(\"dropping boxer\");\n    }\n}\n\npub fn build_it<'a>(cb: ||: 'a) -> Boxer<'a> {\n    let data = box Boxee{cb: cb};\n    Boxer{data: data}\n}\n```\n\nThe ICE appeared once I added the Drop impl, but the fact that I'm taking a lifetime'd closure is also relevant. If I change the closure to 'static, I get an error (regardless of whether I leave the unused 'a lifetime on everything else):\n\n```\nice.rs:11:15: 11:20 error: cannot implement a destructor on a structure that does not satisfy Send\nice.rs:11 impl Drop for Boxer {\n                        ^~~~~\nice.rs:11:15: 11:20 note: use \"#[unsafe_destructor]\" on the implementation to force the compiler to allow this\nice.rs:11 impl Drop for Boxer {\n                        ^~~~~\nerror: aborting due to previous error\n```\n\nIf I replace the closure with an `extern fn()`, then I get the ICE if the unused lifetime is left in, and I get no error if the unused lifetime is removed.\n\nIf I impl Drop for Boxee instead of Boxer, there is no change.\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48103953/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48103997",
    "html_url": "https://github.com/rust-lang/rust/issues/15469#issuecomment-48103997",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/15469",
    "id": 48103997,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MTAzOTk3",
    "user": {
      "login": "o11c",
      "id": 964689,
      "node_id": "MDQ6VXNlcjk2NDY4OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/964689?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/o11c",
      "html_url": "https://github.com/o11c",
      "followers_url": "https://api.github.com/users/o11c/followers",
      "following_url": "https://api.github.com/users/o11c/following{/other_user}",
      "gists_url": "https://api.github.com/users/o11c/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/o11c/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/o11c/subscriptions",
      "organizations_url": "https://api.github.com/users/o11c/orgs",
      "repos_url": "https://api.github.com/users/o11c/repos",
      "events_url": "https://api.github.com/users/o11c/events{/privacy}",
      "received_events_url": "https://api.github.com/users/o11c/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-06T06:15:55Z",
    "updated_at": "2014-07-06T06:15:55Z",
    "body": "If I follow the error's suggestion and use `#[unsafe_destructor]`, then both my minimal testcase and my real code compile just fine.\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48103997/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48105088",
    "html_url": "https://github.com/rust-lang/rust/issues/15469#issuecomment-48105088",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/15469",
    "id": 48105088,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MTA1MDg4",
    "user": {
      "login": "luqmana",
      "id": 287063,
      "node_id": "MDQ6VXNlcjI4NzA2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luqmana",
      "html_url": "https://github.com/luqmana",
      "followers_url": "https://api.github.com/users/luqmana/followers",
      "following_url": "https://api.github.com/users/luqmana/following{/other_user}",
      "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions",
      "organizations_url": "https://api.github.com/users/luqmana/orgs",
      "repos_url": "https://api.github.com/users/luqmana/repos",
      "events_url": "https://api.github.com/users/luqmana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luqmana/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-06T07:30:44Z",
    "updated_at": "2014-07-06T07:30:44Z",
    "body": "Dupe of #14889.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/48105088/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
