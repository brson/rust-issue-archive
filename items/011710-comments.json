[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/32968622",
    "html_url": "https://github.com/rust-lang/rust/issues/11710#issuecomment-32968622",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11710",
    "id": 32968622,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyOTY4NjIy",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-21T22:01:18Z",
    "updated_at": "2014-01-21T22:01:18Z",
    "body": "Ah, I should also note that the valgrind warning only shows up when building with optimizations.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/32968622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33298531",
    "html_url": "https://github.com/rust-lang/rust/issues/11710#issuecomment-33298531",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11710",
    "id": 33298531,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzMjk4NTMx",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-25T19:59:06Z",
    "updated_at": "2014-01-25T19:59:06Z",
    "body": "Slightly simpler code (IMHO):\n\n``` rust\nuse std::util;\nenum Option<T> {\n    None,\n    Some(T),\n}\n\n#[inline(never)]\nfn function<T>(slot: &mut Option<T>, f: T) {\n    let a = util::replace(slot, None);\n    let _breaker = match a {\n        Some(_) => bar(f),\n        None => f,\n    };\n}\n\n#[inline(never)]\nfn bar<T>(g: T) -> T {\n    g\n}\n\n#[start]\nfn main(_: int, _: **u8) -> int {\n    let mut slot = None;\n    function(&mut slot, proc() {});\n    0\n}\n```\n\nThe rest of the code seems to be required. Or at least various attempts to simplify it further made the problem disappear.\n\nWhat I figured out so far is that the problem is in the cleanup path for `slot`. And the test that relies on the uninitialised value is apparently for the case that `slot` is not `None`. The test for `None` comes right after this one, which is wrong.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33298531/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33299979",
    "html_url": "https://github.com/rust-lang/rust/issues/11710#issuecomment-33299979",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11710",
    "id": 33299979,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzMjk5OTc5",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-25T20:40:34Z",
    "updated_at": "2014-01-25T20:40:34Z",
    "body": "OK, so at some point LLVM moved the loads not only for the discriminator, but also for the `proc` contained in `slot` to the beginning of `function`:\n\n``` llvm\ndefine internal fastcc void @_ZN8function19hf4c7ff781ac735e1an4v0.0E(%\"enum.Option<proc:Send()>\"* nocapture, { void ({ i64, %tydesc*, i8*, i8*, i8 }*)*, { i64, %tydesc*, i8*, i8*, i8 }* }* noalias nocapture readonly) unnamed_addr #1 {\nnormal-return:\n  %.sroa.2 = alloca [15 x i8], align 1\n  %_breaker = alloca { void ({ i64, %tydesc*, i8*, i8*, i8 }*)*, { i64, %tydesc*, i8*, i8*, i8 }* }, align 8\n  %arg = alloca { void ({ i64, %tydesc*, i8*, i8*, i8 }*)*, { i64, %tydesc*, i8*, i8*, i8 }* }, align 8\n  %f.sroa.0.0.idx = getelementptr inbounds { void ({ i64, %tydesc*, i8*, i8*, i8 }*)*, { i64, %tydesc*, i8*, i8*, i8 }* }* %1, i64 0, i32 0\n  %f.sroa.0.0.copyload = load void ({ i64, %tydesc*, i8*, i8*, i8 }*)** %f.sroa.0.0.idx, align 8\n  %f.sroa.5.0.idx19 = getelementptr inbounds { void ({ i64, %tydesc*, i8*, i8*, i8 }*)*, { i64, %tydesc*, i8*, i8*, i8 }* }* %1, i64 0, i32 1\n  %f.sroa.5.0.copyload = load { i64, %tydesc*, i8*, i8*, i8 }** %f.sroa.5.0.idx19, align 8\n  %.sroa.2.1.idx10 = getelementptr inbounds [15 x i8]* %.sroa.2, i64 0, i64 0\n\n  ; Loads from slot occur here\n  %tmp.sroa.0.0.idx6.i.i = getelementptr inbounds %\"enum.Option<proc:Send()>\"* %0, i64 0, i32 0\n\n  ; Discriminator for slot\n  %tmp.sroa.0.0.copyload7.i.i = load i8* %tmp.sroa.0.0.idx6.i.i, align 8\n  %tmp.sroa.6.0.idx12.i.i = getelementptr inbounds %\"enum.Option<proc:Send()>\"* %0, i64 0, i32 1, i64 0\n  %tmp.sroa.616.0.idx17.i.i = getelementptr inbounds %\"enum.Option<proc:Send()>\"* %0, i64 0, i32 2, i64 1\n  %tmp.sroa.616.0.cast18.i.i = bitcast i64* %tmp.sroa.616.0.idx17.i.i to { i64, %tydesc*, i8*, i8*, i8 }**\n\n  ; Env pointer for slot    \n  %tmp.sroa.616.0.copyload19.i.i = load { i64, %tydesc*, i8*, i8*, i8 }** %tmp.sroa.616.0.cast18.i.i, align 8\n```\n\nAnd later on we have:\n\n``` llvm\n\"_ZN17proc.Send$LP$$RP$9glue_drop19hd34fc795812c1ef2akE.exit5\": ; preds = %join, %cond.i4\n  %cond.not = xor i1 %cond, true\n  %18 = icmp eq { i64, %tydesc*, i8*, i8*, i8 }* %tmp.sroa.616.0.copyload19.i.i, null\n  %or.cond = or i1 %18, %cond.not\n  br i1 %or.cond, label %\"_ZN17proc.Send$LP$$RP$9glue_drop19hd34fc795812c1ef2akE.exit\", label %cond.i.i8\n```\n\n`%i18` is the result for checking whether the env pointer for the proc _in_ `slot` is null, `%cond.not` is the result for checking whether `slot` is `None`. In the assembly that gets translated to the two conditional jumps, and the one for the env pointer comes first.\n\nAt the moment, I have no idea _why_ that happens though.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33299979/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33313973",
    "html_url": "https://github.com/rust-lang/rust/issues/11710#issuecomment-33313973",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11710",
    "id": 33313973,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzMzEzOTcz",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-26T10:44:54Z",
    "updated_at": "2014-01-26T10:44:54Z",
    "body": "Getting simpler :-)\n\n``` rust\nstruct X {\n    x: ~uint,\n}\n\n#[inline(never)]\nfn function(mut slot: Option<X>) {\n    let a = std::util::replace(&mut slot, None);\n    let _breaker = match a {\n        Some(_) => ~1,\n        None => ~1,\n    };\n}\n\n#[start]\nfn main(_: int, _: **u8) -> int {\n    function(None);\n    0\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33313973/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33315140",
    "html_url": "https://github.com/rust-lang/rust/issues/11710#issuecomment-33315140",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11710",
    "id": 33315140,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzMzE1MTQw",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-26T12:02:57Z",
    "updated_at": "2014-01-26T12:03:16Z",
    "body": "This is a known valgrind false positive and Rust already has a lot of suppressions for it. It's reported upstream on the LLVM bug tracker but is not really an LLVM issue, just a limitation of valgrind. LLVM is allowed to generate undefined reads if it can not change the program behavior.\n\nhttp://llvm.org/bugs/show_bug.cgi?id=12319\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33315140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33315330",
    "html_url": "https://github.com/rust-lang/rust/issues/11710#issuecomment-33315330",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11710",
    "id": 33315330,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzMzE1MzMw",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-26T12:12:40Z",
    "updated_at": "2014-01-26T12:12:40Z",
    "body": "Just for the record, the undefined read doesn't change the behaviour because it's just a check whether `free` should _not_ be called, i.e. either it jumps over the `free` call right away, or it performs the second check.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33315330/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
