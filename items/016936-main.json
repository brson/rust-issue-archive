{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/16936",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/16936/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/16936/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/16936/events",
  "html_url": "https://github.com/rust-lang/rust/pull/16936",
  "id": 41678641,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjA1OTM5MTQ=",
  "number": 16936,
  "title": "core: Make TwoWaySearcher reset its prefix memory when shifting by byteset",
  "user": {
    "login": "nham",
    "id": 546409,
    "node_id": "MDQ6VXNlcjU0NjQwOQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/546409?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nham",
    "html_url": "https://github.com/nham",
    "followers_url": "https://api.github.com/users/nham/followers",
    "following_url": "https://api.github.com/users/nham/following{/other_user}",
    "gists_url": "https://api.github.com/users/nham/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nham/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nham/subscriptions",
    "organizations_url": "https://api.github.com/users/nham/orgs",
    "repos_url": "https://api.github.com/users/nham/repos",
    "events_url": "https://api.github.com/users/nham/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nham/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2014-09-02T06:23:27Z",
  "updated_at": "2014-09-17T20:06:19Z",
  "closed_at": "2014-09-17T20:06:19Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/16936",
    "html_url": "https://github.com/rust-lang/rust/pull/16936",
    "diff_url": "https://github.com/rust-lang/rust/pull/16936.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/16936.patch",
    "merged_at": "2014-09-17T20:06:19Z"
  },
  "body": "This is primarily an attempt to fix #16878, which was a false positive in the case of `\"1234567ah012345678901ah\".contains(\"hah\")` (and other examples).\n\nSome background: Two-Way starts off by factorizing the needle into two halves `(u, v)` based on some criteria. it then checks whether `u` is a suffix of `v[:period(v)]`. If so, it uses what is called \"Algorithm CP1\" in Crochemore and Rytter's book _Text Algorithms_, and \"Algorithm CP2\" otherwise. CP2 is optimized for needles with large periods.\n\n`\"hah\"` happens to get factorized into `(\"h\", \"ah\")`, which means it runs CP1. As far as I understand, this bug can only occur in CP1, because only CP1 uses an extra variable to memorize prefixes (this is the `memory` field in the `TwoWaySearcher` struct). To quote from Crochemore and Rytter, p. 317:\n\n> The variable s is used to memorize a prefix of the pattern that matches the text at the current position, given the variable pos. Variable s is updated at every mismatch. It can be set to a non-zero value only in the case of a mismatch occurring during the scan of the left part of the pattern.\n\n`self.memory` (which plays the role of `s` in our implementation) actually gets reset to 0 when a mismatch occurs during right scan, but it wasn't being reset to 0 during a jump that occurred via `byteset` mismatch. The `byteset` thing is not a part of the original Two-Way algorithm, and I actually don't understand how it works. But it checks something to determine if we can skip by the entire length of the needle. \n\nI believe the bug appears when we have a mismatch during left scan that sets `self.memory` to something non-zero, followed by a bunch of byteset skips, followed by a match on the right scan and only a partial match on the left scan. The fix should be to reset `self.memory` to 0 when doing a byteset skip, because no prefix can match after such a skip (such skips are longer than the skips for mismatches during right scans, for which it gets reset).\n\nFurther evidence that this is the correct fix is that if you remove `byteset` entirely, the false positives go away.\n\nI've also added extensive comments, maybe too many. Let me know if I've gone into too much detail.\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/16936/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/16936/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
