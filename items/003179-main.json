{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/3179",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/3179/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/3179/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/3179/events",
  "html_url": "https://github.com/rust-lang/rust/pull/3179",
  "id": 6167104,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjAzMzMzMQ==",
  "number": 3179,
  "title": "Pretty printing for closures - much better.",
  "user": {
    "login": "dbp",
    "id": 569509,
    "node_id": "MDQ6VXNlcjU2OTUwOQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/569509?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dbp",
    "html_url": "https://github.com/dbp",
    "followers_url": "https://api.github.com/users/dbp/followers",
    "following_url": "https://api.github.com/users/dbp/following{/other_user}",
    "gists_url": "https://api.github.com/users/dbp/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dbp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dbp/subscriptions",
    "organizations_url": "https://api.github.com/users/dbp/orgs",
    "repos_url": "https://api.github.com/users/dbp/repos",
    "events_url": "https://api.github.com/users/dbp/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dbp/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2012-08-11T01:31:44Z",
  "updated_at": "2014-07-28T02:30:54Z",
  "closed_at": "2012-08-11T20:18:28Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/3179",
    "html_url": "https://github.com/rust-lang/rust/pull/3179",
    "diff_url": "https://github.com/rust-lang/rust/pull/3179.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/3179.patch",
    "merged_at": null
  },
  "body": "The way the pretty printer currently handles closures is distinctly unsatisfying (the elipsis are to indicate that there is enough content so that the entire expression cannot fit on a single line; if it could, things would look fine):\n\n```\nfn main() {\n    do foo(bar) |a|\n                    {\n                        baa...z;\n                    }\n    for foo(bar) |a|\n                    {\n                        baz;\n                        ...\n                        baz;\n                    }\n    let f =\n        |a|\n            {\n                foo;\n                ...\n                foo;\n            };\n}\n```\n\nWhat is happening is that the entire closure is wrapped in a pretty printing box; since it can't fit on the line with the do / for, it starts printing it and then has to break the line, and it indents relative to that, so the block is 4 spaces in from the beginning of the closure. A lot better, in my opinion (and how I think a person would write it), is:\n\n```\nfn main() {\n    do foo(bar) |a| {\n        baa...z;\n    }\n    for foo(bar) |a| {\n        baz;\n        ...\n        baz;\n    }\n    let f = |a| {\n        foo;\n        ...\n        foo;\n    };\n}\n```\n\nThat is, the indentation is keyed on the beginning of the expression. Ideally, the way the boxes would be arranged is that the closure argument would be absorbed into the \"head\" box that has the do/for/let, but writing the code that way seemed to involve more code complexity, as we need to be looking for closures before we actually see the AST expression for them.\n\nWhat I did, and this pull request implements, fixes the formatting for do and for expressions (they look exactly like the \"desired\" output). It does this by eliminating the surrounding block (which involved a little bit of refactoring to allow you to close brackets without having a surrounding box to close). It does not fix the let expression - the arguments for the closure start on the following line. I'm actually not sure why this is happening; it might be something with an easy fix. The output of the code that this pull request adds is the following:\n\n```\nfn main() {\n    do foo(bar) |a| {\n        baa...z;\n    }\n    for foo(bar) |a| {\n        baz;\n        ...\n        baz;\n    }\n    let f = \n        |a| {\n        foo;\n        ...\n        foo;\n    };\n}\n```\n\nI'm not sure if this is the best approach - this is the first that I've dealt with the AST or the pretty printer, so I could be doing something non-optimally. Hopefully people can given feedback on the code / how it works. \n\nThe diff includes some changes to libsyntax/print/pp.rs to make the debug output more verbose - this was helpful to me as someone unfamiliar with the code, and so seem to make sense. The rest is changes to libsyntax/print/pprust.rs, based on the changes described.\n",
  "closed_by": {
    "login": "brson",
    "id": 147214,
    "node_id": "MDQ6VXNlcjE0NzIxNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brson",
    "html_url": "https://github.com/brson",
    "followers_url": "https://api.github.com/users/brson/followers",
    "following_url": "https://api.github.com/users/brson/following{/other_user}",
    "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
    "organizations_url": "https://api.github.com/users/brson/orgs",
    "repos_url": "https://api.github.com/users/brson/repos",
    "events_url": "https://api.github.com/users/brson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brson/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/3179/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/3179/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
