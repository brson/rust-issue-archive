{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/22189",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/22189/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/22189/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/22189/events",
  "html_url": "https://github.com/rust-lang/rust/pull/22189",
  "id": 57367813,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjkxMjI1MTU=",
  "number": 22189,
  "title": "remove support for dynamic choice of B in BTree, significantly reducing ...",
  "user": {
    "login": "Gankra",
    "id": 1136864,
    "node_id": "MDQ6VXNlcjExMzY4NjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Gankra",
    "html_url": "https://github.com/Gankra",
    "followers_url": "https://api.github.com/users/Gankra/followers",
    "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
    "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
    "organizations_url": "https://api.github.com/users/Gankra/orgs",
    "repos_url": "https://api.github.com/users/Gankra/repos",
    "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Gankra/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "huonw",
    "id": 1203825,
    "node_id": "MDQ6VXNlcjEyMDM4MjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/huonw",
    "html_url": "https://github.com/huonw",
    "followers_url": "https://api.github.com/users/huonw/followers",
    "following_url": "https://api.github.com/users/huonw/following{/other_user}",
    "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
    "organizations_url": "https://api.github.com/users/huonw/orgs",
    "repos_url": "https://api.github.com/users/huonw/repos",
    "events_url": "https://api.github.com/users/huonw/events{/privacy}",
    "received_events_url": "https://api.github.com/users/huonw/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2015-02-11T19:52:14Z",
  "updated_at": "2015-02-15T06:36:24Z",
  "closed_at": "2015-02-15T05:24:35Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/22189",
    "html_url": "https://github.com/rust-lang/rust/pull/22189",
    "diff_url": "https://github.com/rust-lang/rust/pull/22189.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/22189.patch",
    "merged_at": null
  },
  "body": "...memory footprint at no perf cost\n\nThis was done in 4 phases, giving detailed performance data:\n- Old design unchanged\n- Make B a const\n- Collapse the ptrs into one\n- Shrink the `len` field\n\n```\nOld design:\ntest map::bench::find_rand_100      ... bench:        51 ns/iter (+/- 5)\ntest map::bench::find_rand_10_000   ... bench:       120 ns/iter (+/- 2)\ntest map::bench::find_seq_100       ... bench:        53 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:        87 ns/iter (+/- 0)\ntest map::bench::insert_rand_100    ... bench:       144 ns/iter (+/- 4)\ntest map::bench::insert_rand_10_000 ... bench:       258 ns/iter (+/- 11)\ntest map::bench::insert_seq_100     ... bench:       264 ns/iter (+/- 5)\ntest map::bench::insert_seq_10_000  ... bench:       325 ns/iter (+/- 3)\ntest map::bench::iter_1000          ... bench:     27715 ns/iter (+/- 1646)\ntest map::bench::iter_100_000       ... bench:   2501840 ns/iter (+/- 40847)\ntest map::bench::iter_20            ... bench:       655 ns/iter (+/- 57)\n\nConst B:\ntest map::bench::find_rand_100      ... bench:        52 ns/iter (+/- 5)\ntest map::bench::find_rand_10_000   ... bench:       120 ns/iter (+/- 1)\ntest map::bench::find_seq_100       ... bench:        54 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:        87 ns/iter (+/- 1)\ntest map::bench::insert_rand_100    ... bench:       140 ns/iter (+/- 0)\ntest map::bench::insert_rand_10_000 ... bench:       254 ns/iter (+/- 12)\ntest map::bench::insert_seq_100     ... bench:       264 ns/iter (+/- 3)\ntest map::bench::insert_seq_10_000  ... bench:       329 ns/iter (+/- 2)\ntest map::bench::iter_1000          ... bench:     25093 ns/iter (+/- 592)\ntest map::bench::iter_100_000       ... bench:   2495100 ns/iter (+/- 150901)\ntest map::bench::iter_20            ... bench:       592 ns/iter (+/- 63)\n\nSquish Ptrs:\ntest map::bench::find_rand_100      ... bench:        51 ns/iter (+/- 5)\ntest map::bench::find_rand_10_000   ... bench:       124 ns/iter (+/- 3)\ntest map::bench::find_seq_100       ... bench:        51 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:        76 ns/iter (+/- 2)\ntest map::bench::insert_rand_100    ... bench:       145 ns/iter (+/- 2)\ntest map::bench::insert_rand_10_000 ... bench:       301 ns/iter (+/- 16)\ntest map::bench::insert_seq_100     ... bench:       260 ns/iter (+/- 8)\ntest map::bench::insert_seq_10_000  ... bench:       320 ns/iter (+/- 8)\ntest map::bench::iter_1000          ... bench:     27106 ns/iter (+/- 3298)\ntest map::bench::iter_100_000       ... bench:   2914572 ns/iter (+/- 183145)\ntest map::bench::iter_20            ... bench:       636 ns/iter (+/- 114)\n```\n\nFor the final form, I profiled various choices of B:\n\n```\n\nB = 100\ntest map::bench::find_rand_100      ... bench:        91 ns/iter (+/- 14)\ntest map::bench::find_rand_10_000   ... bench:       252 ns/iter (+/- 18)\ntest map::bench::find_seq_100       ... bench:       128 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:       238 ns/iter (+/- 2)\ntest map::bench::insert_rand_100    ... bench:       144 ns/iter (+/- 3)\ntest map::bench::insert_rand_10_000 ... bench:       813 ns/iter (+/- 11)\ntest map::bench::insert_seq_100     ... bench:       557 ns/iter (+/- 49)\ntest map::bench::insert_seq_10_000  ... bench:       659 ns/iter (+/- 5)\ntest map::bench::iter_1000          ... bench:     22404 ns/iter (+/- 3319)\ntest map::bench::iter_100_000       ... bench:   2037716 ns/iter (+/- 286812)\ntest map::bench::iter_20            ... bench:       488 ns/iter (+/- 9)\n\nB = 20\ntest map::bench::find_rand_100      ... bench:        67 ns/iter (+/- 7)\ntest map::bench::find_rand_10_000   ... bench:       129 ns/iter (+/- 3)\ntest map::bench::find_seq_100       ... bench:        51 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:       113 ns/iter (+/- 2)\ntest map::bench::insert_rand_100    ... bench:       142 ns/iter (+/- 3)\ntest map::bench::insert_rand_10_000 ... bench:       418 ns/iter (+/- 16)\ntest map::bench::insert_seq_100     ... bench:       342 ns/iter (+/- 13)\ntest map::bench::insert_seq_10_000  ... bench:       435 ns/iter (+/- 16)\ntest map::bench::iter_1000          ... bench:     21747 ns/iter (+/- 669)\ntest map::bench::iter_100_000       ... bench:   2173041 ns/iter (+/- 214782)\ntest map::bench::iter_20            ... bench:       487 ns/iter (+/- 24)\n\nB = 9\ntest map::bench::find_rand_100      ... bench:        52 ns/iter (+/- 5)\ntest map::bench::find_rand_10_000   ... bench:       118 ns/iter (+/- 5)\ntest map::bench::find_seq_100       ... bench:        51 ns/iter (+/- 0)\ntest map::bench::find_seq_10_000    ... bench:        88 ns/iter (+/- 5)\ntest map::bench::insert_rand_100    ... bench:       141 ns/iter (+/- 3)\ntest map::bench::insert_rand_10_000 ... bench:       307 ns/iter (+/- 24)\ntest map::bench::insert_seq_100     ... bench:       257 ns/iter (+/- 11)\ntest map::bench::insert_seq_10_000  ... bench:       333 ns/iter (+/- 14)\ntest map::bench::iter_1000          ... bench:     23128 ns/iter (+/- 771)\ntest map::bench::iter_100_000       ... bench:   2317773 ns/iter (+/- 192077)\ntest map::bench::iter_20            ... bench:       587 ns/iter (+/- 28)\n\nB = 8\ntest map::bench::find_rand_100      ... bench:        52 ns/iter (+/- 5)\ntest map::bench::find_rand_10_000   ... bench:       123 ns/iter (+/- 2)\ntest map::bench::find_seq_100       ... bench:        54 ns/iter (+/- 2)\ntest map::bench::find_seq_10_000    ... bench:        79 ns/iter (+/- 0)\ntest map::bench::insert_rand_100    ... bench:       140 ns/iter (+/- 3)\ntest map::bench::insert_rand_10_000 ... bench:       318 ns/iter (+/- 16)\ntest map::bench::insert_seq_100     ... bench:       249 ns/iter (+/- 4)\ntest map::bench::insert_seq_10_000  ... bench:       344 ns/iter (+/- 3)\ntest map::bench::iter_1000          ... bench:     23761 ns/iter (+/- 563)\ntest map::bench::iter_100_000       ... bench:   2372726 ns/iter (+/- 94588)\ntest map::bench::iter_20            ... bench:       589 ns/iter (+/- 25)\n\nB = 7\ntest map::bench::find_rand_100      ... bench:        50 ns/iter (+/- 5)\ntest map::bench::find_rand_10_000   ... bench:       115 ns/iter (+/- 6)\ntest map::bench::find_seq_100       ... bench:        51 ns/iter (+/- 2)\ntest map::bench::find_seq_10_000    ... bench:        81 ns/iter (+/- 1)\ntest map::bench::insert_rand_100    ... bench:       142 ns/iter (+/- 6)\ntest map::bench::insert_rand_10_000 ... bench:       337 ns/iter (+/- 14)\ntest map::bench::insert_seq_100     ... bench:       250 ns/iter (+/- 3)\ntest map::bench::insert_seq_10_000  ... bench:       336 ns/iter (+/- 6)\ntest map::bench::iter_1000          ... bench:     24332 ns/iter (+/- 1415)\ntest map::bench::iter_100_000       ... bench:   2638069 ns/iter (+/- 289258)\ntest map::bench::iter_20            ... bench:       597 ns/iter (+/- 23)\n\nB = 6\ntest map::bench::find_rand_100      ... bench:        50 ns/iter (+/- 4)\ntest map::bench::find_rand_10_000   ... bench:       116 ns/iter (+/- 2)\ntest map::bench::find_seq_100       ... bench:        53 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:        77 ns/iter (+/- 1)\ntest map::bench::insert_rand_100    ... bench:       140 ns/iter (+/- 1)\ntest map::bench::insert_rand_10_000 ... bench:       252 ns/iter (+/- 12)\ntest map::bench::insert_seq_100     ... bench:       257 ns/iter (+/- 8)\ntest map::bench::insert_seq_10_000  ... bench:       321 ns/iter (+/- 11)\ntest map::bench::iter_1000          ... bench:     24719 ns/iter (+/- 2973)\ntest map::bench::iter_100_000       ... bench:   2496480 ns/iter (+/- 286592)\ntest map::bench::iter_20            ... bench:       590 ns/iter (+/- 55)\n\nB = 5\ntest map::bench::find_rand_100      ... bench:        50 ns/iter (+/- 5)\ntest map::bench::find_rand_10_000   ... bench:       123 ns/iter (+/- 4)\ntest map::bench::find_seq_100       ... bench:        52 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:        79 ns/iter (+/- 2)\ntest map::bench::insert_rand_100    ... bench:       140 ns/iter (+/- 5)\ntest map::bench::insert_rand_10_000 ... bench:       273 ns/iter (+/- 11)\ntest map::bench::insert_seq_100     ... bench:       258 ns/iter (+/- 5)\ntest map::bench::insert_seq_10_000  ... bench:       336 ns/iter (+/- 6)\ntest map::bench::iter_1000          ... bench:     25958 ns/iter (+/- 761)\ntest map::bench::iter_100_000       ... bench:   2611977 ns/iter (+/- 87232)\ntest map::bench::iter_20            ... bench:       636 ns/iter (+/- 37)\n\nB = 4\ntest map::bench::find_rand_100      ... bench:        50 ns/iter (+/- 4)\ntest map::bench::find_rand_10_000   ... bench:       131 ns/iter (+/- 4)\ntest map::bench::find_seq_100       ... bench:        52 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:        82 ns/iter (+/- 4)\ntest map::bench::insert_rand_100    ... bench:       143 ns/iter (+/- 3)\ntest map::bench::insert_rand_10_000 ... bench:       334 ns/iter (+/- 11)\ntest map::bench::insert_seq_100     ... bench:       259 ns/iter (+/- 9)\ntest map::bench::insert_seq_10_000  ... bench:       349 ns/iter (+/- 7)\ntest map::bench::iter_1000          ... bench:     27685 ns/iter (+/- 716)\ntest map::bench::iter_100_000       ... bench:   2835892 ns/iter (+/- 77269)\ntest map::bench::iter_20            ... bench:       626 ns/iter (+/- 61)\n\nB = 3\ntest map::bench::find_rand_100      ... bench:        48 ns/iter (+/- 4)\ntest map::bench::find_rand_10_000   ... bench:       139 ns/iter (+/- 5)\ntest map::bench::find_seq_100       ... bench:        59 ns/iter (+/- 1)\ntest map::bench::find_seq_10_000    ... bench:        86 ns/iter (+/- 2)\ntest map::bench::insert_rand_100    ... bench:       145 ns/iter (+/- 1)\ntest map::bench::insert_rand_10_000 ... bench:       356 ns/iter (+/- 19)\ntest map::bench::insert_seq_100     ... bench:       261 ns/iter (+/- 8)\ntest map::bench::insert_seq_10_000  ... bench:       367 ns/iter (+/- 25)\ntest map::bench::iter_1000          ... bench:     32013 ns/iter (+/- 1707)\ntest map::bench::iter_100_000       ... bench:   3287997 ns/iter (+/- 195732)\ntest map::bench::iter_20            ... bench:       709 ns/iter (+/- 104)\n\nB = 2\ntest map::bench::find_rand_100      ... bench:        51 ns/iter (+/- 4)\ntest map::bench::find_rand_10_000   ... bench:       149 ns/iter (+/- 4)\ntest map::bench::find_seq_100       ... bench:        58 ns/iter (+/- 2)\ntest map::bench::find_seq_10_000    ... bench:       107 ns/iter (+/- 3)\ntest map::bench::insert_rand_100    ... bench:       156 ns/iter (+/- 15)\ntest map::bench::insert_rand_10_000 ... bench:       471 ns/iter (+/- 21)\ntest map::bench::insert_seq_100     ... bench:       304 ns/iter (+/- 14)\ntest map::bench::insert_seq_10_000  ... bench:       438 ns/iter (+/- 24)\ntest map::bench::iter_1000          ... bench:     40143 ns/iter (+/- 2316)\ntest map::bench::iter_100_000       ... bench:   4332654 ns/iter (+/- 1266146)\ntest map::bench::iter_20            ... bench:       848 ns/iter (+/- 109)\n```\n\nFrom these numbers, it would seem that the more optimized design leaves the choice B largely \"in the noise\". 6 was the old value and it still seems to be a good choice.\n\nNote that the `rand` benches have proven to be _very_ high variance between runs in my testing, making their values largely useless. It's also possible that the current microbenches aren't fully capturing the performance characteristics of the tree, because part of the BTree argument is about avoiding constant allocations, and these generally won't trigger many allocations.\n\nIf anyone is interested in further profiling these changes, I have a crate with only the BTree and the preserved change history at https://github.com/Gankro/btree-fiddles\n\nThe last 4 commits are exactly the states described above.\n",
  "closed_by": {
    "login": "Gankra",
    "id": 1136864,
    "node_id": "MDQ6VXNlcjExMzY4NjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Gankra",
    "html_url": "https://github.com/Gankra",
    "followers_url": "https://api.github.com/users/Gankra/followers",
    "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
    "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
    "organizations_url": "https://api.github.com/users/Gankra/orgs",
    "repos_url": "https://api.github.com/users/Gankra/repos",
    "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Gankra/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/22189/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/22189/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
