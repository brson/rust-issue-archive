[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13869342",
    "html_url": "https://github.com/rust-lang/rust/pull/5054#issuecomment-13869342",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5054",
    "id": 13869342,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODY5MzQy",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-21T02:26:01Z",
    "updated_at": "2013-02-21T02:29:18Z",
    "body": "It looks to me like this line in `core::task::spawn` is the one that is intended to be handling this case (when TLS has been initialized in the main task): https://github.com/mozilla/rust/blob/e51ec26dd7d915cfdfabcf5b6e32c001e30bd244/src/libcore/task/spawn.rs#L419\n\nThe problem though is that that case is triggered from the `TCB` destructor, which is called when TLS is destroyed, and the `TCB` for the main task is not initialized at the same time as TLS (it is initialized on the first call to `spawn`), so the condition in `rust_task` that is checking whether TLS is initialized is incorrect (it should actually care about when the `TCB` is constructed).\n\nSo, by my reading, this fix will not work correctly if the test is changed to `task::spawn(||()); assert false;`, since `spawn` will initialize the main task's `TCB` and both `kill_task_group` and `cleanup_task` will try to call `fail_sched_loop`.\n\nI think the easiest thing to do here is to keep your change, making `cleanup_task` always responsible for calling `fail_sched_loop` in the main task, and remove that condition from `kill_task_group` along with the `rust_task_kill_all` runtime function that it uses (and the corresponding entry in rt/rustrt.in).\n\n@alexcrichton If my description sounds correct to you, do you mind making the above change and verifying that it works for the entire test suite with `make check`?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13869342/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13869610",
    "html_url": "https://github.com/rust-lang/rust/pull/5054#issuecomment-13869610",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5054",
    "id": 13869610,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODY5NjEw",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-21T02:34:34Z",
    "updated_at": "2013-02-21T02:34:34Z",
    "body": "Certainly, I'll look some more into this, thanks for the pointers!\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13869610/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13872956",
    "html_url": "https://github.com/rust-lang/rust/pull/5054#issuecomment-13872956",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5054",
    "id": 13872956,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODcyOTU2",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-21T04:44:13Z",
    "updated_at": "2013-02-21T04:44:26Z",
    "body": "So here's some stuff that I've uncovered. I'll call the version of the test without `task::spawn` (the one in this pull request) A, and the one with task span B. B looks like this:\n\n```\npub fn main() {              \n  os::args();                \n  task::spawn(||());\n  fail!();\n}                            \n```\n- I went back to rust 0.5, and A has a 0 exit status, B has a nonzero exit status.\n- I used this pull request, A has a nonzero exit status, B has a nonzero exit status\n- Using this request plus removing `rust_task_kill_all` both A/B have a nonzero exit status.\n\nWith just this pull request gdb says that `fail_sched_loop` is called both from `kill_taskgroup` and `cleanup_task`. I didn't see any assertions trip or anything like that, so apart from this being odd behavior, this may not be causing any problems. All tests also pass when running `make check`\n\nWith this pull request plus removing `rust_task_kill_all`, tests like `run-fail/morestack4`, `run-fail/linked-failure2` and others all have a 0 exit status when they should have nonzero.\n\nI'm going to keep thinking about this, but I figured I'd at least post an update.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13872956/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13874989",
    "html_url": "https://github.com/rust-lang/rust/pull/5054#issuecomment-13874989",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5054",
    "id": 13874989,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODc0OTg5",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-21T06:23:35Z",
    "updated_at": "2013-02-21T06:23:35Z",
    "body": "Oh, that's funny. The [two](https://github.com/mozilla/rust/blob/incoming/src/rt/rust_builtin.cpp#L728) [calls](https://github.com/mozilla/rust/blob/incoming/src/rt/rust_task.cpp#L133) to `fail_sched_loop` both have independent assertions that they shouldn't be called twice - and sure enough they are each only being called once, but they are both being called.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/13874989/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/14140413",
    "html_url": "https://github.com/rust-lang/rust/pull/5054#issuecomment-14140413",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5054",
    "id": 14140413,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MTQwNDEz",
    "user": {
      "login": "catamorphism",
      "id": 427212,
      "node_id": "MDQ6VXNlcjQyNzIxMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/catamorphism",
      "html_url": "https://github.com/catamorphism",
      "followers_url": "https://api.github.com/users/catamorphism/followers",
      "following_url": "https://api.github.com/users/catamorphism/following{/other_user}",
      "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions",
      "organizations_url": "https://api.github.com/users/catamorphism/orgs",
      "repos_url": "https://api.github.com/users/catamorphism/repos",
      "events_url": "https://api.github.com/users/catamorphism/events{/privacy}",
      "received_events_url": "https://api.github.com/users/catamorphism/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-02-26T21:21:37Z",
    "updated_at": "2013-02-26T21:21:37Z",
    "body": "Closing due to lack of activity and wanting to clear out the queue, but please submit a new PR if you make progress on this, @alexcrichton !\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/14140413/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
