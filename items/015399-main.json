{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/15399",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/15399/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/15399/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/15399/events",
  "html_url": "https://github.com/rust-lang/rust/pull/15399",
  "id": 37142909,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTc5Nzk5MDM=",
  "number": 15399,
  "title": "Rewrite the local_data implementation",
  "user": {
    "login": "lilyball",
    "id": 714,
    "node_id": "MDQ6VXNlcjcxNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lilyball",
    "html_url": "https://github.com/lilyball",
    "followers_url": "https://api.github.com/users/lilyball/followers",
    "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
    "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
    "organizations_url": "https://api.github.com/users/lilyball/orgs",
    "repos_url": "https://api.github.com/users/lilyball/repos",
    "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lilyball/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 29,
  "created_at": "2014-07-04T05:28:24Z",
  "updated_at": "2014-08-01T02:04:09Z",
  "closed_at": "2014-08-01T00:51:32Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/15399",
    "html_url": "https://github.com/rust-lang/rust/pull/15399",
    "diff_url": "https://github.com/rust-lang/rust/pull/15399.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/15399.patch",
    "merged_at": null
  },
  "body": "This was motivated by a desire to remove allocation in the common\npattern of\n\n```\nlet old = key.replace(None)\ndo_something();\nkey.replace(old);\n```\n\nThis also switched the map representation from a Vec to a TreeMap. A Vec\nmay be reasonable if there's only a couple TLD keys, but a TreeMap\nprovides better behavior as the number of keys increases.\n\nLike the Vec, this TreeMap implementation does not shrink the container\nwhen a value is removed. Unlike Vec, this TreeMap implementation cannot\nreuse an empty node for a different key. Therefore any key that has been\ninserted into the TLD at least once will continue to take up space in\nthe Map until the task ends. The expectation is that the majority of\nkeys that are inserted into TLD will be expected to have a value for\nmost of the rest of the task's lifetime. If this assumption is wrong,\nthere are two reasonable ways to fix this that could be implemented in\nthe future:\n1. Provide an API call to either remove a specific key from the TLD and\n   destruct its node (e.g. `remove()`), or instead to explicitly clean\n   up all currently-empty nodes in the map (e.g. `compact()`). This is\n   simple, but requires the user to explicitly call it.\n2. Keep track of the number of empty nodes in the map and when the map\n   is mutated (via `replace()`), if the number of empty nodes passes\n   some threshold, compact it automatically. Alternatively, whenever a\n   new key is inserted that hasn't been used before, compact the map at\n   that point.\n\n---\n\nBenchmarks:\n\nI ran 3 benchmarks. tld_replace_none just replaces the tld key with None\nrepeatedly. tld_replace_some replaces it with Some repeatedly. And\ntld_replace_none_some simulates the common behavior of replacing with\nNone, then replacing with the previous value again (which was a Some).\n\nOld implementation:\n\n```\ntest tld_replace_none      ... bench:        20 ns/iter (+/- 0)\ntest tld_replace_none_some ... bench:        77 ns/iter (+/- 4)\ntest tld_replace_some      ... bench:        57 ns/iter (+/- 2)\n```\n\nNew implementation:\n\n```\ntest tld_replace_none      ... bench:        11 ns/iter (+/- 0)\ntest tld_replace_none_some ... bench:        23 ns/iter (+/- 0)\ntest tld_replace_some      ... bench:        12 ns/iter (+/- 0)\n```\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/15399/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/15399/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
