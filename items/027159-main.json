{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/27159",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27159/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27159/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27159/events",
  "html_url": "https://github.com/rust-lang/rust/pull/27159",
  "id": 96118308,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NDAzNzc2MDk=",
  "number": 27159,
  "title": "Make File's specialisation of read_to_end use the length of the file to size the Vec it gets passed",
  "user": {
    "login": "AlisdairO",
    "id": 6296622,
    "node_id": "MDQ6VXNlcjYyOTY2MjI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6296622?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlisdairO",
    "html_url": "https://github.com/AlisdairO",
    "followers_url": "https://api.github.com/users/AlisdairO/followers",
    "following_url": "https://api.github.com/users/AlisdairO/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlisdairO/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlisdairO/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlisdairO/subscriptions",
    "organizations_url": "https://api.github.com/users/AlisdairO/orgs",
    "repos_url": "https://api.github.com/users/AlisdairO/repos",
    "events_url": "https://api.github.com/users/AlisdairO/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlisdairO/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2015-07-20T17:41:39Z",
  "updated_at": "2016-08-19T18:49:33Z",
  "closed_at": "2015-07-20T21:33:33Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/27159",
    "html_url": "https://github.com/rust-lang/rust/pull/27159",
    "diff_url": "https://github.com/rust-lang/rust/pull/27159.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/27159.patch",
    "merged_at": null
  },
  "body": "Performance optimisation for File::read_to_end.  Currently reallocing in the vector takes a very large percentage of runtime for loading a large file.  This is unnecessary because File allows us to work out how much we have left to read, and we can use that information to size the vec in advance.\n## Performance figures:\n### Large (230MB+ file, 1024 initial vec capacity)\n\ntest sys_common::io::tests::bench_uninitialized_file            ... bench: 283,419,418 ns/iter (+/- 33,257,419)\ntest sys_common::io::tests::bench_uninitialized_file_hint       ... bench: 153,119,795 ns/iter (+/- 34,983,881)\n### Small files:\n\nSince I was concerned about small files - that there might be overhead when working out the remaining size of the file - I also did a test loading a large variety of 4KB files filled with random data.  I then experimented with different sizes of Vec being passed into the read_to_end function.  It looks like in the worst case (where the Vec is exactly sized to the file), the new code is a little slower, but otherwise it's generally faster.  I'm not too concerned about this - if you've already worked out the exact size of the file, you might just as well use read() instead.\n#### Using Vec::new()\n\ntest sys_common::io::tests::bench_uninitialized_file_small      ... bench:       9,811 ns/iter (+/- 1,346)\ntest sys_common::io::tests::bench_uninitialized_file_small_hint ... bench:       6,789 ns/iter (+/- 579)\n#### Using Vec::with_capacity(1024)\n\ntest sys_common::io::tests::bench_uninitialized_file_small      ... bench:       6,193 ns/iter (+/- 955)\ntest sys_common::io::tests::bench_uninitialized_file_small_hint ... bench:       5,896 ns/iter (+/- 525)\n#### Using Vec::with_capacity(4096)\n\ntest sys_common::io::tests::bench_uninitialized_file_small      ... bench:       5,123 ns/iter (+/- 2,129)\ntest sys_common::io::tests::bench_uninitialized_file_small_hint ... bench:       5,936 ns/iter (+/- 605)\n### 'Real' application\n\nI tested loading the large file in a simple rust application, and the runtime of the app averaged ~200ms with this optimisation and ~350ms without.\n",
  "closed_by": {
    "login": "AlisdairO",
    "id": 6296622,
    "node_id": "MDQ6VXNlcjYyOTY2MjI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6296622?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlisdairO",
    "html_url": "https://github.com/AlisdairO",
    "followers_url": "https://api.github.com/users/AlisdairO/followers",
    "following_url": "https://api.github.com/users/AlisdairO/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlisdairO/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlisdairO/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlisdairO/subscriptions",
    "organizations_url": "https://api.github.com/users/AlisdairO/orgs",
    "repos_url": "https://api.github.com/users/AlisdairO/repos",
    "events_url": "https://api.github.com/users/AlisdairO/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlisdairO/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/27159/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27159/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
