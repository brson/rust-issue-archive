{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/9297",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/9297/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/9297/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/9297/events",
  "html_url": "https://github.com/rust-lang/rust/pull/9297",
  "id": 19700167,
  "node_id": "MDExOlB1bGxSZXF1ZXN0ODQyNjUyNw==",
  "number": 9297,
  "title": "a couple trait method call optimizations",
  "user": {
    "login": "eugals",
    "id": 479407,
    "node_id": "MDQ6VXNlcjQ3OTQwNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/479407?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eugals",
    "html_url": "https://github.com/eugals",
    "followers_url": "https://api.github.com/users/eugals/followers",
    "following_url": "https://api.github.com/users/eugals/following{/other_user}",
    "gists_url": "https://api.github.com/users/eugals/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eugals/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eugals/subscriptions",
    "organizations_url": "https://api.github.com/users/eugals/orgs",
    "repos_url": "https://api.github.com/users/eugals/repos",
    "events_url": "https://api.github.com/users/eugals/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eugals/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2013-09-18T17:27:58Z",
  "updated_at": "2014-07-16T16:47:44Z",
  "closed_at": "2013-09-19T17:54:52Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/9297",
    "html_url": "https://github.com/rust-lang/rust/pull/9297",
    "diff_url": "https://github.com/rust-lang/rust/pull/9297.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/9297.patch",
    "merged_at": null
  },
  "body": "This is my first PR to the project.\nIt is intended to optimize/beautify the code generated in a few trivial trait operations.\nLet's take the following code as an example:\n\n```\ntrait Stuff {\n    fn bar(&self);\n}\n\nfn callBar(s: &Stuff) {\n    s.bar();\n}\n\nstruct Foo;\n\nimpl Stuff for Foo {\n    fn bar(&self) {\n    }\n}\n\npub fn main() {\n    let o = Foo;\n    callBar(&o as &Stuff);\n}\n```\n\nAt present it is translated into something like:\n\n```\ndefine void @_ZN7callBar_UUID.0E({ i32, %tydesc*, i8*, i8*, i8 }*, { %tydesc*, i8* }*) #4 {\n\"function top level\":\n  %__trait_callee = alloca { %tydesc*, i8* }\n  %__auto_borrow_obj = alloca { %tydesc*, i8* }\n  %2 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 0\n  %3 = load %tydesc** %2\n  %4 = getelementptr inbounds { %tydesc*, i8* }* %__auto_borrow_obj, i32 0, i32 0\n  store %tydesc* %3, %tydesc** %4\n  %5 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 1\n  %6 = load i8** %5\n  %7 = getelementptr inbounds { %tydesc*, i8* }* %__auto_borrow_obj, i32 0, i32 1\n  store i8* %6, i8** %7\n  %8 = bitcast { %tydesc*, i8* }* %__auto_borrow_obj to i8*\n  %9 = bitcast { %tydesc*, i8* }* %__trait_callee to i8*\n  call void @llvm.memcpy.p0i8.p0i8.i32(i8* %9, i8* %8, i32 8, i32 4, i1 false)\n  %10 = getelementptr inbounds { %tydesc*, i8* }* %__trait_callee, i32 0, i32 1\n  %11 = load i8** %10\n  %12 = bitcast i8* %11 to { i32, %tydesc*, i8*, i8*, i8 }*\n  %13 = getelementptr inbounds { %tydesc*, i8* }* %__trait_callee, i32 0, i32 0\n  %14 = bitcast %tydesc** %13 to [1 x i8*]**\n  %15 = load [1 x i8*]** %14\n  %16 = getelementptr inbounds [1 x i8*]* %15, i32 0, i32 1\n  %17 = load i8** %16\n  %18 = bitcast i8* %17 to void ({ i32, %tydesc*, i8*, i8*, i8 }*)*\n  call void %18({ i32, %tydesc*, i8*, i8*, i8 }* %12)\n  ret void\n}\n\n...\n\ndefine void @_ZN4main_UUID.0E({ i32, %tydesc*, i8*, i8*, i8 }*) #4 {\n\"function top level\":\n  %o = alloca %struct.Foo\n  %1 = alloca { %tydesc*, i8* }\n  %__auto_borrow_obj = alloca { %tydesc*, i8* }\n  %2 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 1\n  %3 = bitcast i8** %2 to %struct.Foo**\n  store %struct.Foo* %o, %struct.Foo** %3\n  %4 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 0\n  %5 = bitcast %tydesc** %4 to { %tydesc*, void ({ i32, %tydesc*, i8*, i8*, i8 }*)* }**\n  store { %tydesc*, void ({ i32, %tydesc*, i8*, i8*, i8 }*)* }* @vtable1081, { %tydesc*, void ({ i32, %tydesc*, i8*, i8*, i8 }*)* }** %5\n  %6 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 0\n  %7 = load %tydesc** %6\n  %8 = getelementptr inbounds { %tydesc*, i8* }* %__auto_borrow_obj, i32 0, i32 0\n  store %tydesc* %7, %tydesc** %8\n  %9 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 1\n  %10 = load i8** %9\n  %11 = getelementptr inbounds { %tydesc*, i8* }* %__auto_borrow_obj, i32 0, i32 1\n  store i8* %10, i8** %11\n  call void @_ZN7callBar_UUID.0E({ i32, %tydesc*, i8*, i8*, i8 }* undef, { %tydesc*, i8* }* %__auto_borrow_obj)\n  ret void\n}\n```\n\nIf you apply my patch, it would become way shorter and cleaner:\n\n```\ndefine void @_ZN7callBar_UUID.0E({ i32, %tydesc*, i8*, i8*, i8 }*, { %tydesc*, i8* }*) #4 {\n\"function top level\":\n  %2 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 1\n  %3 = load i8** %2\n  %4 = bitcast i8* %3 to { i32, %tydesc*, i8*, i8*, i8 }*\n  %5 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 0\n  %6 = bitcast %tydesc** %5 to [1 x i8*]**\n  %7 = load [1 x i8*]** %6\n  %8 = getelementptr inbounds [1 x i8*]* %7, i32 0, i32 1\n  %9 = load i8** %8\n  %10 = bitcast i8* %9 to void ({ i32, %tydesc*, i8*, i8*, i8 }*)*\n  call void %10({ i32, %tydesc*, i8*, i8*, i8 }* %4)\n  ret void\n}\n\n...\n\ndefine void @_ZN4main_UUID.0E({ i32, %tydesc*, i8*, i8*, i8 }*) #4 {\n\"function top level\":\n  %o = alloca %struct.Foo\n  %1 = alloca { %tydesc*, i8* }\n  %2 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 1\n  %3 = bitcast i8** %2 to %struct.Foo**\n  store %struct.Foo* %o, %struct.Foo** %3\n  %4 = getelementptr inbounds { %tydesc*, i8* }* %1, i32 0, i32 0\n  %5 = bitcast %tydesc** %4 to { %tydesc*, void ({ i32, %tydesc*, i8*, i8*, i8 }*)* }**\n  store { %tydesc*, void ({ i32, %tydesc*, i8*, i8*, i8 }*)* }* @vtable1081, { %tydesc*, void ({ i32, %tydesc*, i8*, i8*, i8 }*)* }** %5\n  call void @_ZN7callBar_UUID.0E({ i32, %tydesc*, i8*, i8*, i8 }* undef, { %tydesc*, i8* }* %1)\n  ret void\n}\n```\n\nAlthough this change doesn't increase the compilation speed much (I mentioned only about 1-2% boost on \"rustc -O -Z time-passes syntax.rs\"), but I still think it's a good thing to do as it greatly simplifies/clarifies LL generated in some cases which would definitely help in the future code generation investigations.\n\nI don't provide any new test cases in this patch as it is merely an optimization.\nI tried to do \"make check\" and everything passed well except \"run-pass/core-run-destroy.rs\", but as far as I can see it doesn't pass on the current branch/master too.\n",
  "closed_by": {
    "login": "eugals",
    "id": 479407,
    "node_id": "MDQ6VXNlcjQ3OTQwNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/479407?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eugals",
    "html_url": "https://github.com/eugals",
    "followers_url": "https://api.github.com/users/eugals/followers",
    "following_url": "https://api.github.com/users/eugals/following{/other_user}",
    "gists_url": "https://api.github.com/users/eugals/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eugals/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eugals/subscriptions",
    "organizations_url": "https://api.github.com/users/eugals/orgs",
    "repos_url": "https://api.github.com/users/eugals/repos",
    "events_url": "https://api.github.com/users/eugals/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eugals/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/9297/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/9297/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
