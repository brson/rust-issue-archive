[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19885639",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19885639",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19885639,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODg1NjM5",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T01:47:02Z",
    "updated_at": "2013-06-24T01:47:02Z",
    "body": "Confirmed that this segfaults on OS X too, removing the A-linux tag.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19885639/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19885695",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19885695",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19885695,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODg1Njk1",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T01:50:42Z",
    "updated_at": "2013-06-24T01:50:42Z",
    "body": "[109813.326976] traps: out[17264] trap invalid opcode ip:400a39 sp:23f1fc0 error:0 in out[400000+1000]\n[109966.893044] traps: out[17294] trap invalid opcode ip:400a39 sp:f6dfc0 error:0 in out[400000+1000]\n[109976.437905] traps: out[17317] trap invalid opcode ip:400a39 sp:10c4fc0 error:0 in out[400000+1000]\n\nconsistently dies in the same place, but there's no instruction there?\n\n```\n  400a32:   00 00 00 \n  400a35:   49 bb 00 00 00 00 00    movabs $0x0,%r11\n  400a3c:   00 00 00 \n  400a3f:   e8 60 02 00 00          callq  400ca4 <__morestack>\n```\n\nAre we aligning functions wrong or making closure pointers wrong?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19885695/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19886787",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19886787",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19886787,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODg2Nzg3",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T02:52:29Z",
    "updated_at": "2013-06-24T02:52:29Z",
    "body": "This may be related to an LLVM bug, but we seem to be putting out something that slips through LLVM's linter. Using opt to output IR between each pass (just using the standard -O2 here, doesn't make a difference), I unearth this gem:\n\n``` llvm\n;*** IR Dump After Simplify the CFG ***\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\n%0 = alloca {}, align 8\n%1 = bitcast {}* %0 to i8*\ncall void @llvm.lifetime.start(i64 0, i8* %1)\n%2 = load i64** undef, align 8\nstore i64 1, i64* %2, align 8\ncall void @llvm.lifetime.end(i64 0, i8* %1)\nret void\n}\n;*** IR Dump After Combine redundant instructions ***\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\nstore i64* undef, i64** null, align 536870912 ; (536870912 = 0x20000000)\nstore i64 1, i64* undef, align 8\nret void\n}\n;*** IR Dump After Tail Call Elimination ***\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\nstore i64* undef, i64** null, align 536870912\nstore i64 1, i64* undef, align 8\nret void\n}\n;*** IR Dump After Simplify the CFG ***\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\ncall void @llvm.trap()\nunreachable\n}\n```\n\nTechnically, there is nothing wrong with doing a 512MiB-aligned store of `undef` to `null`, but it seems that somewhere along the line, we have introduced undefined behaviour that it really doesn't like, but isn't picked up by the linter.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19886787/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19888343",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19888343",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19888343,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODg4MzQz",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T04:13:17Z",
    "updated_at": "2013-06-24T04:13:17Z",
    "body": "Nominating for production ready.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19888343/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19889643",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19889643",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19889643,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODg5NjQz",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T05:25:03Z",
    "updated_at": "2013-06-24T05:25:03Z",
    "body": "Ok, more trawling through IR turned up this:\n\n``` llvm\n*** IR Dump After Deduce function attributes ***\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\n  %tmp.i4 = alloca {}, align 8\n  %tmp.i = alloca { i64, %tydesc*, {}*, {}*, { i64** } }, align 8\n  %0 = bitcast { i64, %tydesc*, {}*, {}*, { i64** } }* %tmp.i to i8*\n  call void @llvm.lifetime.start(i64 40, i8* %0)\n  %tmp6.i = bitcast { i64, %tydesc*, {}*, {}*, { i64** } }* %tmp.i to { i64, %tydesc*, i8*, i8*, i8 }*\n  call void @llvm.lifetime.end(i64 40, i8* %0)\n  %1 = bitcast {}* %tmp.i4 to i8*\n  call void @llvm.lifetime.start(i64 0, i8* %1)\n  %tmp2.i = getelementptr inbounds { i64, %tydesc*, i8*, i8*, i8 }* %tmp6.i, i64 0, i32 4\n  %tmp3.i = bitcast i8* %tmp2.i to i64***\n  %tmp4.i = load i64*** %tmp3.i, align 8\n  %tmp5.i = load i64** %tmp4.i, align 8\n  %tmp6.i5 = load i64* %tmp5.i, align 8\n  %tmp7.i = add i64 %tmp6.i5, 1\n  store i64 %tmp7.i, i64* %tmp5.i, align 8\n  %tmp8.i = load {}* %tmp.i4, align 8\n  %2 = bitcast {}* %tmp.i4 to i8*\n  call void @llvm.lifetime.end(i64 0, i8* %2)\n  ret void\n}\n*** IR Dump After SROA ***\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\n  %tmp.i4 = alloca {}, align 8\n  %0 = bitcast {}* %tmp.i4 to i8*\n  call void @llvm.lifetime.start(i64 0, i8* %0)\n  %tmp5.i = load i64** undef, align 8\n  %tmp6.i5 = load i64* %tmp5.i, align 8\n  %tmp7.i = add i64 %tmp6.i5, 1\n  store i64 %tmp7.i, i64* %tmp5.i, align 8\n  %tmp8.i = load {}* %tmp.i4, align 8\n  %1 = bitcast {}* %tmp.i4 to i8*\n  call void @llvm.lifetime.end(i64 0, i8* %1)\n  ret void\n}\n```\n\nSROA is scalar replacement of aggregates, so in this particular instance, the aggregate is the `alloca`'d box. The value of the box just after the alloca (`%tmp.i`) is `undef`. Since this is an opaque box, we get a pointer to the placeholder `i8`, and cast it to an `i64***`. Now, both pointers here are defined, they point to the stack. However, when we load from the pointer, we're back into `undef` territory. Since we then follow this `undef` pointer, we keep being `undef`. When we do something with the `i64` at the end, that is still undef. A later pass (\"Combine redundant instructions\") to be precise, sees all this adjacent undef optations and combines them down to some `undef` stores to `null`. That is replaced with a call to `@llvm.trap` shortly afterwards.\n\nThis is a fair way through the pipeline though, so I'm not sure how it relates to the original code exactly yet. Thought I'd share my findings so far.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19889643/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19892244",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19892244",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19892244,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODkyMjQ0",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T07:17:18Z",
    "updated_at": "2013-06-24T07:17:18Z",
    "body": "Ok, getting closer, tracing back a bit more, I find this:\n\n``` llvm\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\n  %tmp.i = alloca { i64, %tydesc*, {}*, {}*, { i64* } }, align 8\n  %state.i = alloca i64, align 8\n  %0 = bitcast i64* %state.i to i8*\n  call void @llvm.lifetime.start(i64 8, i8* %0)\n  store i64 543210, i64* %state.i, align 8\n  %1 = bitcast { i64, %tydesc*, {}*, {}*, { i64* } }* %tmp.i to i8*\n  call void @llvm.lifetime.start(i64 40, i8* %1)\n  %tmp7.i = bitcast { i64, %tydesc*, {}*, {}*, { i64* } }* %tmp.i to { i64, %tydesc*, i8*, i8*, i8 }*\n  %tmp8.i = getelementptr inbounds { i64, %tydesc*, {}*, {}*, { i64* } }* %tmp.i, i64 0, i32 0\n  store i64 305419896, i64* %tmp8.i, align 8\n  %tmp9.i = getelementptr inbounds { i64, %tydesc*, {}*, {}*, { i64* } }* %tmp.i, i64 0, i32 4, i32 0\n  store i64* %state.i, i64** %tmp9.i, align 8\n  call void @llvm.lifetime.end(i64 40, i8* %1)\n  %tmp18.i = call {} @_ZN4test4anon4anon12expr_fn_2956E({ i64, %tydesc*, i8*, i8*, i8 }* %tmp7.i)\n  call void @llvm.lifetime.end(i64 8, i8* %0)\n  ret void\n}\n*** IR Dump After Dead Store Elimination ***\n; Function Attrs: uwtable\ndefine internal fastcc void @_ZN4main16_d7d397690bb61803_00E() #1 {\nstatic_allocas:\n  %tmp.i = alloca { i64, %tydesc*, {}*, {}*, { i64* } }, align 8\n  %state.i = alloca i64, align 8\n  %0 = bitcast i64* %state.i to i8*\n  call void @llvm.lifetime.start(i64 8, i8* %0)\n  %1 = bitcast { i64, %tydesc*, {}*, {}*, { i64* } }* %tmp.i to i8*\n  call void @llvm.lifetime.start(i64 40, i8* %1)\n  %tmp7.i = bitcast { i64, %tydesc*, {}*, {}*, { i64* } }* %tmp.i to { i64, %tydesc*, i8*, i8*, i8 }*\n  call void @llvm.lifetime.end(i64 40, i8* %1)\n  %tmp18.i = call {} @_ZN4test4anon4anon12expr_fn_2956E({ i64, %tydesc*, i8*, i8*, i8 }* %tmp7.i)\n  call void @llvm.lifetime.end(i64 8, i8* %0)\n  ret void\n}\n```\n\nThe `llvm.lifetime.*` calls are inserted by LLVM during inlining. This is because all the `alloca` calls are hoisted to the top of the block, so LLVM uses those calls to indicate where the value is considered \"live\" and where it is considered \"dead\", between the two is essentially the body of the inlined function.\n\nIn this case (I've been making cosmetic changes in order to make it easier to follow), the lifetime of `%tmp.i` starts just after the store to `%state.i` and ends just before the call to `test::anon::anon::expr_fn`. Unfortunately, the value passed to that function is `%tmp7.i` which is a bitcast of `%tmp.i`, thus LLVM considers it dead at the call site. Since that's the only place a few of the stores (notably the store of the _pointer_ to `%state.i` to the environment) are read, it eliminates them as dead stores.\n\nAgain, I'm not sure _why_ it ends up like this, though I'm not going to rule out an LLVM bug at this point.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19892244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19894521",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19894521",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19894521,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODk0NTIx",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T08:23:59Z",
    "updated_at": "2013-06-24T08:46:22Z",
    "body": "Ok, I tried disabling inlining and now, instead of getting a trap, I get a segmentation fault. So we are definately producing something incorrect here.\n\nI think it may be related to the way the closure environment works and it is possibly caused by something incorrect with the way the environment is re-captured in the inner-most closure.\n\nChanging the `state` variable to an `@mut` doesn't fix the problem either.\n\nFurthermore, trying to print the value of `state` to the terminal results in a segmentation fault as well.\n\ncc @nikomatsakis & @pcwalton for some more knowledgable input\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19894521/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19895471",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19895471",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19895471,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODk1NDcx",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T08:49:42Z",
    "updated_at": "2013-06-24T08:49:42Z",
    "body": "I have now managed to reduce the test case, based on what I thought the error might be to this:\n\n``` rust\nfn main() {\n    let mut state = 54321;\n    let a = || { \n        || { state += 1 }\n    };\n\n    a()();\n}\n```\n\nWhich exhibits the same error.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19895471/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19895580",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19895580",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19895580,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5ODk1NTgw",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T08:52:58Z",
    "updated_at": "2013-06-24T08:52:58Z",
    "body": "Also happens with `state = state + 1` so it's not related to the poor implementation of the in-place operators.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19895580/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19927996",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19927996",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19927996,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTI3OTk2",
    "user": {
      "login": "Blei",
      "id": 52674,
      "node_id": "MDQ6VXNlcjUyNjc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/52674?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Blei",
      "html_url": "https://github.com/Blei",
      "followers_url": "https://api.github.com/users/Blei/followers",
      "following_url": "https://api.github.com/users/Blei/following{/other_user}",
      "gists_url": "https://api.github.com/users/Blei/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Blei/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Blei/subscriptions",
      "organizations_url": "https://api.github.com/users/Blei/orgs",
      "repos_url": "https://api.github.com/users/Blei/repos",
      "events_url": "https://api.github.com/users/Blei/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Blei/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T19:01:14Z",
    "updated_at": "2013-06-24T19:06:14Z",
    "body": "This is very suspicious. From `rustc --passes '' --emit-llvm foo.rs`:\n\n```\n[...]\n  store i64 54321, i64* %1\n[...]\n  store i64 305419896, i64* %8  // in hex: 0x12345678\n[...]\n```\n\nLooks like dummy values, but I haven't yet found out where they are inserted.\n\nEdit: scratch that: the first one is obviously from the input program. Still interested in the second one though.\n\nEdit2: this mystery has been solved as well: middle/trans/closure.rs:175. Sorry for the noise.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19927996/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19939555",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19939555",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19939555,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTM5NTU1",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T22:07:13Z",
    "updated_at": "2013-06-24T22:07:13Z",
    "body": "Stripping passes off the end of the chain, after dropping `dse I end up with this:\n\n``` llvm\n; ModuleID = 'issue7336.rc'\ntarget datalayout = \"e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-unknown-linux-gnu\"\n\n%tydesc = type { i64, i64, void ({}*, %tydesc**, i8*)*, void ({}*, %tydesc**, i8*)*, void ({}*, %tydesc**, i8*)*, void ({}*, %tydesc**, i8*)*, i8*, i8* }\n\n@_rust_crate_map_toplevel = global { i32, i8*, i64, [2 x i64] } { i32 1, i8* bitcast (void ({ i64, %tydesc*, i8*, i8*, i8 }*)* @_ZN7cleanup10annihilate16_82984335c95fdd56_07preE to i8*), i64 ptrtoint ([1 x { i64, i64 }]* @_rust_mod_map to i64), [2 x i64] [i64 ptrtoint (i64* @_rust_crate_map_std_0.7-pre_6c65cf4b443341b1 to i64), i64 0] }\n@_rust_crate_map_std_0.7-pre_6c65cf4b443341b1 = external global i64\n@_rust_mod_map = internal global [1 x { i64, i64 }] zeroinitializer\n@rust_abi_version = constant i64 1\n\ndefine void @_rust_main({ i64, %tydesc*, i8*, i8*, i8 }* nocapture) #0 {\nstatic_allocas:\n  ret void\n}\n\ndefine i64 @main(i64, i8**) {\ntop:\n  %2 = tail call i64 @_ZN8unstable4lang5start17_76d6c774aa357c7a6_07preE({ i64, %tydesc*, i8*, i8*, i8 }* null, i8* bitcast (void ({ i64, %tydesc*, i8*, i8*, i8 }*)* @_rust_main to i8*), i64 %0, i8** %1, i8* bitcast ({ i32, i8*, i64, [2 x i64] }* @_rust_crate_map_toplevel to i8*))\n  ret i64 %2\n}\n\ndeclare i64 @_ZN8unstable4lang5start17_76d6c774aa357c7a6_07preE({ i64, %tydesc*, i8*, i8*, i8 }*, i8*, i64, i8**, i8*)\n\ndeclare void @_ZN7cleanup10annihilate16_82984335c95fdd56_07preE({ i64, %tydesc*, i8*, i8*, i8 }*)\n\ndeclare void @llvm.lifetime.start(i64, i8* nocapture) #1\n\ndeclare void @llvm.lifetime.end(i64, i8* nocapture) #1\n\nattributes #0 = { readnone }\nattributes #1 = { nounwind }\n```\n\nAdding `dse` back gets me:\n\n``` llvm\n; ModuleID = 'issue7336.rc'\ntarget datalayout = \"e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-unknown-linux-gnu\"\n\n%tydesc = type { i64, i64, void ({}*, %tydesc**, i8*)*, void ({}*, %tydesc**, i8*)*, void ({}*, %tydesc**, i8*)*, void ({}*, %tydesc**, i8*)*, i8*, i8* }\n\n@_rust_crate_map_toplevel = global { i32, i8*, i64, [2 x i64] } { i32 1, i8* bitcast (void ({ i64, %tydesc*, i8*, i8*, i8 }*)* @_ZN7cleanup10annihilate16_82984335c95fdd56_07preE to i8*), i64 ptrtoint ([1 x { i64, i64 }]* @_rust_mod_map to i64), [2 x i64] [i64 ptrtoint (i64* @_rust_crate_map_std_0.7-pre_6c65cf4b443341b1 to i64), i64 0] }\n@_rust_crate_map_std_0.7-pre_6c65cf4b443341b1 = external global i64\n@_rust_mod_map = internal global [1 x { i64, i64 }] zeroinitializer\n@rust_abi_version = constant i64 1\n\ndefine void @_rust_main({ i64, %tydesc*, i8*, i8*, i8 }* nocapture) {\nstatic_allocas:\n  tail call void @llvm.trap()\n  unreachable\n}\n\ndefine i64 @main(i64, i8**) {\ntop:\n  %2 = tail call i64 @_ZN8unstable4lang5start17_76d6c774aa357c7a6_07preE({ i64, %tydesc*, i8*, i8*, i8 }* null, i8* bitcast (void ({ i64, %tydesc*, i8*, i8*, i8 }*)* @_rust_main to i8*), i64 %0, i8** %1, i8* bitcast ({ i32, i8*, i64, [2 x i64] }* @_rust_crate_map_toplevel to i8*))\n  ret i64 %2\n}\n\ndeclare i64 @_ZN8unstable4lang5start17_76d6c774aa357c7a6_07preE({ i64, %tydesc*, i8*, i8*, i8 }*, i8*, i64, i8**, i8*)\n\ndeclare void @_ZN7cleanup10annihilate16_82984335c95fdd56_07preE({ i64, %tydesc*, i8*, i8*, i8 }*)\n\ndeclare void @llvm.lifetime.start(i64, i8* nocapture) #0\n\ndeclare void @llvm.lifetime.end(i64, i8* nocapture) #0\n\ndeclare void @llvm.trap() #1\n\nattributes #0 = { nounwind }\nattributes #1 = { noreturn nounwind }\n```\n\nThis reminds me of the problem with glue inlining, which failed due to the casts on the function pointers inside the call instruction. Interestingly, there is a call to `LLVMBuildPointerCast` that should cast the function pointer before passing it to `LLVMBuildCall`, but for some reason, there's no bitcase inserted before the call. \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19939555/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19941502",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19941502",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19941502,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTQxNTAy",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T22:45:08Z",
    "updated_at": "2013-06-24T22:45:08Z",
    "body": "My intermediate results seem to be misleading, removing the outer closure only removes the lifetime.start/end and trap function declarations, but `dse` doesn't kill it anymore. Probably the lifetimes are kept internally, but aren't output anymore at the stage that I captured.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19941502/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19945344",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19945344",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19945344,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTQ1MzQ0",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-25T00:17:43Z",
    "updated_at": "2013-06-25T00:17:43Z",
    "body": "Ok, I think I've finally figured it out. Stack closures capture their environment by reference, _always_. This makes sense since all the lifetimes are known and it's pretty much what makes most usage of stack closures usable.\n\nBecause of the way capturing works, a variable is captured all the way up the \"closure chain\" to where it starts life. Again, this makes sense, an outer closure must logically capture a variable if an inner closure is to use it. Another side to this is that inner closures actually capture the _parents_ environment, not the actual captured environment. This is so everything plays nice with copying-closures, don't want an inner stack closure capturing the top environment by reference if it's nested inside a heap closure.\n\nEssentially the code above is functionally equivalent to this:\n\n``` rust\nfn main() {\n    let mut state = 54321;\n    let a = || {\n        let statep = &mut state;\n        let f = || { *statep += 1 };\n        f\n    };\n\n    a()();\n}\n```\n\nThere is, however, one major difference. That code doesn't compile. Specifically it fails the borrow check. Why? Because the captured variable, `statep` doesn't last long enough, which is true. This means that in the original example, the closure returned from calling `a()` contains a pointer to **inside** `a`, which is undefined. After inlining, LLVM sees the undefined behaviour and reduces it all down.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19945344/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19955351",
    "html_url": "https://github.com/rust-lang/rust/issues/7336#issuecomment-19955351",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/7336",
    "id": 19955351,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTU1MzUx",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-25T06:17:03Z",
    "updated_at": "2013-06-25T06:17:03Z",
    "body": "So the problem is that the regionck code does not add a maximal constraint to the closure lifetime apart from the fact that they must not outlive the free variables. My first fix was to use the innermost cleanup scope but this is stricter actually stricter than necessary. It also breaks various uses of iter. The proper fix is innermost repeating scope, which is simple to compute, but more than I feel like doing tonight. I'll prepare a PR tomorrow.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19955351/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
