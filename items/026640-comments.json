[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/136083028",
    "html_url": "https://github.com/rust-lang/rust/issues/26640#issuecomment-136083028",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26640",
    "id": 136083028,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNjA4MzAyOA==",
    "user": {
      "login": "geofft",
      "id": 74644,
      "node_id": "MDQ6VXNlcjc0NjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/geofft",
      "html_url": "https://github.com/geofft",
      "followers_url": "https://api.github.com/users/geofft/followers",
      "following_url": "https://api.github.com/users/geofft/following{/other_user}",
      "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
      "organizations_url": "https://api.github.com/users/geofft/orgs",
      "repos_url": "https://api.github.com/users/geofft/repos",
      "events_url": "https://api.github.com/users/geofft/events{/privacy}",
      "received_events_url": "https://api.github.com/users/geofft/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-30T03:45:24Z",
    "updated_at": "2015-08-30T03:45:24Z",
    "body": "Seems to be because on UNIX, `open` is indirected through a compile-time shim because of #22862 (`open` is varargs on Darwin). Therefore `libc::open` is actually a Rust-language function, marked `extern` to maintain ABI with older versions of liblibc, and any `pub extern` functions are considered public symbols.\n\nIf instead of `libc` you import this crate:\n\n``` rust\n#![feature(no_std, core)]\n#![no_std]\nextern crate core;\n\npub fn burger() {}\nextern {\n    pub fn fries();\n}\npub extern fn drink() {}\n```\n\nthe resulting assembly has a public symbol for `drink`, but not for `burger` or `fries`.\n\nI suppose the real bug here is that if a library crate depends on a second library crate with a `pub extern fn`, it's assumed live. This is entirely reasonable for non-mangled functions, so that you can write a crate that helps you implement some C-ABI plugin interface that's expecting particular names. But there's probably no good reason for it for mangled ones: the only way to export such a function, I think, is through passing a pointer to it somewhere, so the symbol doesn't need to be live (and referencing the function pointer will keep the _code_ live, which is all you care about).\n\nI can think of the following workarounds (slash alternatives, if it's determined this is the right behavior for even for mangled `pub extern fn`s):\n1. Instead of implementing the `libc::open` wrapper in Rust, implement it in C in `rt/rust_builtin.c`. There's precedent for this in for `libc::opendir` and `libc::readdir_r`, ten lines below.\n2. Implement the wrapper on Darwin but not other UNIXes, since it is technically only needed there (that is, replace the non-Darwin case with `pub use open_shim::open`. That will solve your bug everywhere except Darwin.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/136083028/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/308859742",
    "html_url": "https://github.com/rust-lang/rust/issues/26640#issuecomment-308859742",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26640",
    "id": 308859742,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwODg1OTc0Mg==",
    "user": {
      "login": "Mark-Simulacrum",
      "id": 5047365,
      "node_id": "MDQ6VXNlcjUwNDczNjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Mark-Simulacrum",
      "html_url": "https://github.com/Mark-Simulacrum",
      "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers",
      "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}",
      "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions",
      "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs",
      "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos",
      "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-06-15T20:40:52Z",
    "updated_at": "2017-06-15T20:40:52Z",
    "body": "I can't seem to reproduce today (assembly output here: https://gist.github.com/Mark-Simulacrum/be225370d9b7e52fd946cd4eccedb9da), so I'm going to close. I don't see any reference to open on both macOS and on Ubuntu. I'm going to close -- if this is wrong, let us know and we'll reopen. Ideally let us know with exact instructions to reproduce.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/308859742/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/309159035",
    "html_url": "https://github.com/rust-lang/rust/issues/26640#issuecomment-309159035",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26640",
    "id": 309159035,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwOTE1OTAzNQ==",
    "user": {
      "login": "geofft",
      "id": 74644,
      "node_id": "MDQ6VXNlcjc0NjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/geofft",
      "html_url": "https://github.com/geofft",
      "followers_url": "https://api.github.com/users/geofft/followers",
      "following_url": "https://api.github.com/users/geofft/following{/other_user}",
      "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
      "organizations_url": "https://api.github.com/users/geofft/orgs",
      "repos_url": "https://api.github.com/users/geofft/repos",
      "events_url": "https://api.github.com/users/geofft/events{/privacy}",
      "received_events_url": "https://api.github.com/users/geofft/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-06-16T23:08:15Z",
    "updated_at": "2017-06-16T23:08:15Z",
    "body": "I forget the state of this in 2015 exactly, but it looks like this particular bug got fixed for `cdylib` libraries (which are new since then), but we have a much larger bug with staticlibs, which is what the bug was originally reported for: not only does `drink` get exported, but so does `burger` _and all of libcore_.\r\n\r\nTo put this in a \"what I tried, what I expected, what happened\" format: I want to be able to compile a C-ABI-compatible library that exports C functions for use by C (or languages that can FFI to C), and implement it in Rust, without the fact that it's written in Rust leaking out. In 2015, I think the only thing that leaked (either static or dynamic) was the mangled symbol for libc::open. Currently everything leaks in static libraries, but it looks fine for dynamic libraries built with `cdylib`.\r\n\r\nHere's my reproducer:\r\n\r\nmeal.rs (simulating the libc crate, in the above context)\r\n```rust\r\n#![no_std]\r\n\r\npub fn burger() {}\r\nextern {\r\n    pub fn fries();\r\n}\r\npub extern fn drink() {}\r\n```\r\n\r\ndiner.rs (library written in Rust, using libmeal as a stand-in for liblibc)\r\n\r\n```rust\r\n#![feature(lang_items)]\r\n#![no_std]\r\nextern crate meal;\r\n\r\n#[lang=\"panic_fmt\"]\r\nextern fn panic_fmt(_msg: &core::fmt::Arguments, _file: &'static str, _line: u32) -> ! {\r\n    loop { }\r\n}\r\n\r\n#[lang=\"eh_personality\"]\r\nextern fn eh_personality() {\r\n    loop { }\r\n}\r\n\r\n#[no_mangle]\r\npub extern fn libdiner_actually_public_function() -> i32 {\r\n    17\r\n}\r\n```\r\n\r\n```\r\ntitan:/tmp geofft$ rustup run nightly rustc --version\r\nrustc 1.19.0-nightly (258ae6dd9 2017-06-15)\r\ntitan:/tmp geofft$ rustup run nightly rustc --crate-type=lib meal.rs\r\ntitan:/tmp geofft$ rustup run nightly rustc --crate-type staticlib diner.rs -L.\r\ntitan:/tmp geofft$ nm libdiner.a | grep libdiner\r\n0000000000000000 T libdiner_actually_public_function\r\ntitan:/tmp geofft$ nm libdiner.a | grep burger\r\n0000000000000000 T _ZN4meal6burger17h3224d595766d9dc8E\r\ntitan:/tmp geofft$ nm libdiner.a | grep fries\r\ntitan:/tmp geofft$ nm libdiner.a | grep drink\r\n0000000000000000 T _ZN4meal5drink17h7624a2a00a5c235dE\r\ntitan:/tmp geofft$ nm libdiner.a | grep -c _ZN4core\r\n589\r\ntitan:/tmp geofft$ rustup run nightly rustc --crate-type cdylib diner.rs -L.\r\ntitan:/tmp geofft$ nm -D libdiner.so \r\n                 w __cxa_finalize\r\n                 w __gmon_start__\r\n                 w _ITM_deregisterTMCloneTable\r\n                 w _ITM_registerTMCloneTable\r\n                 w _Jv_RegisterClasses\r\n0000000000000570 T libdiner_actually_public_function\r\n```\r\n\r\nThat is, I'm compiling libdiner into a C-ABI-compatible static library and shared library, and expect my only public function to be `libdiner_actually_public_function()`. This works as expected for the `cdylib`, but not for the `staticlib`: all the symbols from libmeal and libcore are also exported by my static library.\r\n\r\nFor what it's worth, building a regular `dylib` causes similar output to the `staticlib` case (slightly fewer libcore symbols, but they still show up, as do both `burger` and `drink`). So maybe the answer is just that we need a `cstaticlib`, parallel to `cdylib`?\r\n\r\nGiven the fact that `drink` isn't showing up in the `cdylib`, my guess is that this particular bug about `libc::open` has been solved, but it's being masked by the fact that everything is getting exported into `staticlib`s, which wasn't previously the case.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/309159035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/309180066",
    "html_url": "https://github.com/rust-lang/rust/issues/26640#issuecomment-309180066",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26640",
    "id": 309180066,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwOTE4MDA2Ng==",
    "user": {
      "login": "Mark-Simulacrum",
      "id": 5047365,
      "node_id": "MDQ6VXNlcjUwNDczNjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Mark-Simulacrum",
      "html_url": "https://github.com/Mark-Simulacrum",
      "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers",
      "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}",
      "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions",
      "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs",
      "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos",
      "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-06-17T01:07:03Z",
    "updated_at": "2017-06-17T01:07:03Z",
    "body": "I believe the libcore/libstd being exposed is https://github.com/rust-lang/rust/issues/33221, so I'll leave this closed -- does that seem correct?",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/309180066/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/309291478",
    "html_url": "https://github.com/rust-lang/rust/issues/26640#issuecomment-309291478",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26640",
    "id": 309291478,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwOTI5MTQ3OA==",
    "user": {
      "login": "geofft",
      "id": 74644,
      "node_id": "MDQ6VXNlcjc0NjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/geofft",
      "html_url": "https://github.com/geofft",
      "followers_url": "https://api.github.com/users/geofft/followers",
      "following_url": "https://api.github.com/users/geofft/following{/other_user}",
      "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
      "organizations_url": "https://api.github.com/users/geofft/orgs",
      "repos_url": "https://api.github.com/users/geofft/repos",
      "events_url": "https://api.github.com/users/geofft/events{/privacy}",
      "received_events_url": "https://api.github.com/users/geofft/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-06-18T17:37:53Z",
    "updated_at": "2017-06-18T17:37:53Z",
    "body": "Yup, thanks for finding that.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/309291478/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
