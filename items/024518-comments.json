[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95042524",
    "html_url": "https://github.com/rust-lang/rust/issues/24518#issuecomment-95042524",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/24518",
    "id": 95042524,
    "node_id": "MDEyOklzc3VlQ29tbWVudDk1MDQyNTI0",
    "user": {
      "login": "erickt",
      "id": 84711,
      "node_id": "MDQ6VXNlcjg0NzEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/erickt",
      "html_url": "https://github.com/erickt",
      "followers_url": "https://api.github.com/users/erickt/followers",
      "following_url": "https://api.github.com/users/erickt/following{/other_user}",
      "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/erickt/subscriptions",
      "organizations_url": "https://api.github.com/users/erickt/orgs",
      "repos_url": "https://api.github.com/users/erickt/repos",
      "events_url": "https://api.github.com/users/erickt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/erickt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-04-22T06:09:04Z",
    "updated_at": "2015-04-22T06:09:04Z",
    "body": "@alexcrichton: Regarding `ptr::read_and_drop`, the primary user of this code is `syntax::ptr::P::map`, which uses it to avoid an alloc when folding over ast. I could copy that functionality into libsyntax at the cost of having to copy some [unstable drop code](https://github.com/rust-lang/rust/blob/master/src/libcore/mem.rs#L336) as well, which seems slightly risky. I could also reimplement `map` to just make a new allocation, at the cost of it being [~40% slower](https://gist.github.com/erickt/5f7626d8afee51b9f9b1). Do you think this is on a critical-enough path that copying `ptr::read_and_drop()` is worth it? I'd be happy to compare the compile times of rust with and without the extra alloc to see if there's any real impact.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95042524/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95043850",
    "html_url": "https://github.com/rust-lang/rust/issues/24518#issuecomment-95043850",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/24518",
    "id": 95043850,
    "node_id": "MDEyOklzc3VlQ29tbWVudDk1MDQzODUw",
    "user": {
      "login": "erickt",
      "id": 84711,
      "node_id": "MDQ6VXNlcjg0NzEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/erickt",
      "html_url": "https://github.com/erickt",
      "followers_url": "https://api.github.com/users/erickt/followers",
      "following_url": "https://api.github.com/users/erickt/following{/other_user}",
      "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/erickt/subscriptions",
      "organizations_url": "https://api.github.com/users/erickt/orgs",
      "repos_url": "https://api.github.com/users/erickt/repos",
      "events_url": "https://api.github.com/users/erickt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/erickt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-04-22T06:17:52Z",
    "updated_at": "2015-04-22T06:18:19Z",
    "body": "@alexcrichton: Interestingly enough, I just added another variation that modified `P::map` into:\n\n``` rust\n    pub fn map3<F>(mut self, f: F) -> P<T> where\n        F: FnOnce(&mut T),\n    {\n        f(&mut *self.ptr);\n        self\n    }\n```\n\nAnd it's ~66% faster. So maybe I should just replace all the users with that pattern. It's unfortunately a little less convenient, but it might not be that bad if most of the users are isolated to `syntax::fold`.\n\nedit: here's the [benchmark](https://gist.github.com/erickt/f4e841d7aef4fbaaaa24).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95043850/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95219188",
    "html_url": "https://github.com/rust-lang/rust/issues/24518#issuecomment-95219188",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/24518",
    "id": 95219188,
    "node_id": "MDEyOklzc3VlQ29tbWVudDk1MjE5MTg4",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-04-22T14:51:18Z",
    "updated_at": "2015-04-22T14:51:18Z",
    "body": "@erickt if we could get by with the `&mut T` variant I think that would be best. The current implementation is not panic-safe into the future as eventually there will be no drop flag and calling `read_and_drop` followed by an arbitrary closure will not be sound (e.g. a panic in the closure will drop invalid data).\n\nYou can also just replace the `map3` function with `foo(&mut ptr)` due to deref coercions, so if you're able to finagle it by just removing usage of the `map` function itself that may also be best.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95219188/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95970184",
    "html_url": "https://github.com/rust-lang/rust/issues/24518#issuecomment-95970184",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/24518",
    "id": 95970184,
    "node_id": "MDEyOklzc3VlQ29tbWVudDk1OTcwMTg0",
    "user": {
      "login": "erickt",
      "id": 84711,
      "node_id": "MDQ6VXNlcjg0NzEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/erickt",
      "html_url": "https://github.com/erickt",
      "followers_url": "https://api.github.com/users/erickt/followers",
      "following_url": "https://api.github.com/users/erickt/following{/other_user}",
      "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/erickt/subscriptions",
      "organizations_url": "https://api.github.com/users/erickt/orgs",
      "repos_url": "https://api.github.com/users/erickt/repos",
      "events_url": "https://api.github.com/users/erickt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/erickt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-04-24T15:40:00Z",
    "updated_at": "2015-04-24T15:40:00Z",
    "body": "@alexcrichton: Regarding BitSet, it's only used in [attr.rs](https://github.com/rust-lang/rust/blob/master/src/libsyntax/attr.rs#L32) in order to speed up tracking if an attribute has been used or not. We got three options for syntex:\n1. Replace it in libsyntax with `HashSet` with the assumption that we don't actually have that many attributes, that the overhead of using a whole `usize` might not really impact memory usage.\n2. Pull `BitSet` library into an external crate and use it in syntex.\n3. Have a patch in syntex that swaps `attr.rs`'s use of `BitSet` with `HashSet`.\n\nWhat do you think is best?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95970184/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/96032797",
    "html_url": "https://github.com/rust-lang/rust/issues/24518#issuecomment-96032797",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/24518",
    "id": 96032797,
    "node_id": "MDEyOklzc3VlQ29tbWVudDk2MDMyNzk3",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-04-24T18:49:40Z",
    "updated_at": "2015-04-24T18:49:40Z",
    "body": "@erickt in general I'm hesitant to contort libsyntax too much, so I would optimize for the least invasive solution. I'm not sure what the stability track is for `BitSet`, as that may be a plausible course of action.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/96032797/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/242826227",
    "html_url": "https://github.com/rust-lang/rust/issues/24518#issuecomment-242826227",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/24518",
    "id": 242826227,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0MjgyNjIyNw==",
    "user": {
      "login": "jonas-schievink",
      "id": 1786438,
      "node_id": "MDQ6VXNlcjE3ODY0Mzg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonas-schievink",
      "html_url": "https://github.com/jonas-schievink",
      "followers_url": "https://api.github.com/users/jonas-schievink/followers",
      "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions",
      "organizations_url": "https://api.github.com/users/jonas-schievink/orgs",
      "repos_url": "https://api.github.com/users/jonas-schievink/repos",
      "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonas-schievink/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-08-26T19:14:58Z",
    "updated_at": "2016-08-26T19:14:58Z",
    "body": "Why is this tagged `A-metadata`?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/242826227/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/301208874",
    "html_url": "https://github.com/rust-lang/rust/issues/24518#issuecomment-301208874",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/24518",
    "id": 301208874,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwMTIwODg3NA==",
    "user": {
      "login": "Mark-Simulacrum",
      "id": 5047365,
      "node_id": "MDQ6VXNlcjUwNDczNjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Mark-Simulacrum",
      "html_url": "https://github.com/Mark-Simulacrum",
      "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers",
      "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}",
      "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions",
      "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs",
      "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos",
      "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-05-12T23:41:06Z",
    "updated_at": "2017-05-12T23:41:06Z",
    "body": "Closing in favor of (newer) https://github.com/rust-lang/rust/issues/41732.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/301208874/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
