[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49374883",
    "html_url": "https://github.com/rust-lang/rust/issues/15758#issuecomment-49374883",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/15758",
    "id": 49374883,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5Mzc0ODgz",
    "user": {
      "login": "bblum",
      "id": 1820515,
      "node_id": "MDQ6VXNlcjE4MjA1MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bblum",
      "html_url": "https://github.com/bblum",
      "followers_url": "https://api.github.com/users/bblum/followers",
      "following_url": "https://api.github.com/users/bblum/following{/other_user}",
      "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bblum/subscriptions",
      "organizations_url": "https://api.github.com/users/bblum/orgs",
      "repos_url": "https://api.github.com/users/bblum/repos",
      "events_url": "https://api.github.com/users/bblum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bblum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-17T22:26:03Z",
    "updated_at": "2014-07-17T22:26:03Z",
    "body": "to clarify: with semaphores initialized to 1, and used like mutexes (i.e. never signalled up to 2 or more), the behaviour is correct; all that would be required for that case is `state.count == 0`. so it will behave correctly when used as a mutex (as it is in Mutex and RWLock), but it will signal too soon if you initialize negative, and it will fail to signal when it should if you initialize it to 2 or more.\n\nDr-Emann found this bug on irc.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49374883/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49384671",
    "html_url": "https://github.com/rust-lang/rust/issues/15758#issuecomment-49384671",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/15758",
    "id": 49384671,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5Mzg0Njcx",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-18T00:53:57Z",
    "updated_at": "2014-07-18T00:53:57Z",
    "body": "Something a little tricky is going on here, I remember thinking about this last time I was looking at this code.\n\nThe check I believe is correct in some situations, however. If you start out with a count of 1 and then immediately get 10 waiters, the count will be -9. When one of them releases a resource, the count is still negative after the bump (-8), but it definitely needs to signal someone.\n\nI think that negative initialization is indeed broken, however.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49384671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49393677",
    "html_url": "https://github.com/rust-lang/rust/issues/15758#issuecomment-49393677",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/15758",
    "id": 49393677,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MzkzNjc3",
    "user": {
      "login": "bblum",
      "id": 1820515,
      "node_id": "MDQ6VXNlcjE4MjA1MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bblum",
      "html_url": "https://github.com/bblum",
      "followers_url": "https://api.github.com/users/bblum/followers",
      "following_url": "https://api.github.com/users/bblum/following{/other_user}",
      "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bblum/subscriptions",
      "organizations_url": "https://api.github.com/users/bblum/orgs",
      "repos_url": "https://api.github.com/users/bblum/repos",
      "events_url": "https://api.github.com/users/bblum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bblum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-18T04:08:39Z",
    "updated_at": "2014-07-18T04:08:39Z",
    "body": "Oh yes, now I remember. The implementation is correct but doesn't support negative initialization, but it fails to assert nonnegative (or require uint) in the constructor. What's going on is the waiters subtract from count _unconditionally_, so count actually represents the number of resources not already \"spoken for\" by existing waiters.  The reason I chose this implementation is that it avoids needing to use `while` instead of `if` in the wait path to prevent the paradise lost race:\n\n```\nwaiter 1                waiter 2                signaller\nif count <= 0 { \n    enqueue self;\n}\n                                                count++;\n                                                signal waiter 1;\n                        if count <= 0 { \n                            // count == 1\n                        }   \n                        // have the lock\n// wakes up\n// have the lock\n```\n\nHowever even if you use while to solve this, you don't get bounded waiting since waiter 2 can still cut in line by racing this way. Subtracting from count before going to sleep \"claims your spot in line\" since it will force waiter 2 to also use the wait queue.\n\nNot to mention that since all this logic is interleaved with a raw pthread mutex `with()` access, doing a while-style implementation would require repeated calls to the mutex instead of just 1.\n\nI think the appropriate solution is just to assert in the constructor that the initial value is nonnegative -- the speed + bounded waiting benefits outweigh the obscure use case of negative initialization, since this is used as the building block for `Mutex` and `RWLock` more often than it is used directly.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49393677/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
