[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111283085",
    "html_url": "https://github.com/rust-lang/rust/issues/26218#issuecomment-111283085",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26218",
    "id": 111283085,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMTI4MzA4NQ==",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-11T21:32:15Z",
    "updated_at": "2015-06-11T21:32:15Z",
    "body": "This is the expected behavior; most things in autoderef loops stop at\nthe outermost level, and at the time we are autoderef'ing we do not\nyet know the type of the index argument. I believe that's important\nbecause we use it to supply an expected type hint when typing the\nindex. (Method calls work in a similar fashion, for example.)\n\nIt's possible we could experiment with changing it. Depending on the\nprecise rules we setup, that could be backwards incompatible.\n\nOn Thu, Jun 11, 2015 at 05:57:32AM -0700, Jorge Aparicio wrote:\n\n> ### STR\n> \n> ``` rust\n> use std::ops::{Deref, Index};\n> \n> pub struct Foo(Bar);\n> \n> pub struct Bar;\n> \n> impl Deref for Foo {\n>     type Target = Bar;\n> \n>     fn deref(&self) -> &Bar { &self.0 }\n> }\n> \n> impl Index<()> for Foo {\n>     type Output = ();\n> \n>     fn index(&self, _: ()) -> &() {\n>         unimplemented!()\n>     }\n> }\n> \n> impl Index<i32> for Bar {\n>     type Output = ();\n> \n>     fn index(&self, _: i32) -> &() {\n>         unimplemented!()\n>     }\n> }\n> \n> fn test(foo: Foo) {\n>     foo[()]; // OK\n>     foo[0];\n>     //~^ error: expected `()` found `i32` (BUT, it should work just like the line below)\n>     foo.deref()[0]; // OK\n> }\n> \n> fn main() {}\n> ```\n> \n> ### Version\n> \n> ```\n> rustc 1.2.0-nightly (613e57b44 2015-06-01) (built 2015-06-02)\n> ```\n> \n> AFAIC, the problem is that the compiler only tries to unify against the first candidate implementation (in this case `Foo: Index<()>`) that finds in the autoderef loop, but in this case there was a matching candidate deeper in the autoderef loop: `Bar: Index<i32>` after one deref.\n> \n> ### Workaround\n> \n> As a workaround, you can \"forward\" `Bar`'s `Index` implementation as an `Index` implementation on `Foo`:\n> \n> ``` rust\n> impl Index<i32> for Foo {\n>     type Output = ();\n> \n>     fn index(&self, i: i32) -> &() {\n>         self.deref().index(i)\n>     }\n> }\n> ```\n> \n> Now the three expression type check:\n> \n> ``` rust\n> fn test(foo: Foo) {\n>     foo[()]; // OK\n>     foo[0];  // OK\n>     foo.deref()[0]; // OK\n> }\n> ```\n> \n> But this is annoying, if `Bar` has lots of `Index` implementations, then you'll need to forward each one.\n> \n> The compiler should exhaustively try all the candidates in the autoderef loop instead of giving up on the first one.\n> \n> cc @nikomatsakis \n> \n> ---\n> \n> Reply to this email directly or view it on GitHub:\n> https://github.com/rust-lang/rust/issues/26218\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111283085/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/257504357",
    "html_url": "https://github.com/rust-lang/rust/issues/26218#issuecomment-257504357",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26218",
    "id": 257504357,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI1NzUwNDM1Nw==",
    "user": {
      "login": "Popog",
      "id": 761307,
      "node_id": "MDQ6VXNlcjc2MTMwNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/761307?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Popog",
      "html_url": "https://github.com/Popog",
      "followers_url": "https://api.github.com/users/Popog/followers",
      "following_url": "https://api.github.com/users/Popog/following{/other_user}",
      "gists_url": "https://api.github.com/users/Popog/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Popog/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Popog/subscriptions",
      "organizations_url": "https://api.github.com/users/Popog/orgs",
      "repos_url": "https://api.github.com/users/Popog/repos",
      "events_url": "https://api.github.com/users/Popog/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Popog/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-11-01T07:24:01Z",
    "updated_at": "2016-11-01T07:24:01Z",
    "body": "Ran into this and was very surprised that adding `Index` impl suddenly broke all my `Deref` coercion indexing.\n\nThis means either:\n- `Deref` coercions provided by a crate can't be relied upon and `.deref()` should always be explicitly called\n- or `Deref` coercions should be viewed as a contract never to add implementations that collide with the target type's impls.\n\nNot really a fan of either of those, but if this is the plan for the moment, whichever one of those is true should probably be mentioned in the book.\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/257504357/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/568912225",
    "html_url": "https://github.com/rust-lang/rust/issues/26218#issuecomment-568912225",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26218",
    "id": 568912225,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2ODkxMjIyNQ==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-12-25T16:11:55Z",
    "updated_at": "2019-12-25T16:11:55Z",
    "body": "Triage: given @nikomatsakis 's explanation that this is expected behavior, and there doesn't seem to be a ton of folks interested in changing it, I'm going to close this issue. Thank you!",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/568912225/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
