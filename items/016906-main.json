{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/16906",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/16906/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/16906/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/16906/events",
  "html_url": "https://github.com/rust-lang/rust/pull/16906",
  "id": 41594664,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjA1NDg5Mjk=",
  "number": 16906,
  "title": "WIP safe and sane B-Tree rewrite",
  "user": {
    "login": "Gankra",
    "id": 1136864,
    "node_id": "MDQ6VXNlcjExMzY4NjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Gankra",
    "html_url": "https://github.com/Gankra",
    "followers_url": "https://api.github.com/users/Gankra/followers",
    "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
    "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
    "organizations_url": "https://api.github.com/users/Gankra/orgs",
    "repos_url": "https://api.github.com/users/Gankra/repos",
    "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Gankra/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 16,
  "created_at": "2014-08-31T20:01:08Z",
  "updated_at": "2014-09-15T03:02:42Z",
  "closed_at": "2014-09-13T19:29:37Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/16906",
    "html_url": "https://github.com/rust-lang/rust/pull/16906",
    "diff_url": "https://github.com/rust-lang/rust/pull/16906.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/16906.patch",
    "merged_at": null
  },
  "body": "Total minimal rewrite of BTree to not use copy/clone at all, and to generally avoid unnecessary mutations. I have not yet implemented the \"miscellaneous\" collection things like iterators, Ord, Eq, Hash, etc as I want to nail the core stuff down first. \n\nThere is one substantial drawback to my implementation: it doesn't allow configuration of `B`. The benefit of this is that the nodes are made of `[T,..n]`'s instead of Vecs, putting more data contiguously and reducing the amount of indirection. I have done this under @aturon's recommendation that it would be better to write a BTree implementation that would benefit from the future possibility of generic integer arguments being available (I am not saying they will be added).\n\nOne consequence of this is that I currently store the Keys/Values in Options, because it's not clear to me if there's a safe way to work with partially intialized arrays, or to tell Rust to \"forget\" some or all of the array and not try to run destructors on the elements. I would _love_ if someone could show me how to do that.\n\nIn addition, right now I do a _lot_ of indexing which could probably be replaced with iterators to avoid bounds checks. I'm also not leveraging `copy` instrinsics to bulk shift the elements around. This first draft is emphasizing correctness and safety over performance, but in a way that's easily upgradable. I hope to have the time to start tuning the implementation in the coming days,\n\nThe actual code is literally 25% just comments describing the fairly complex logic of a BTree. I've tried to chunk things out into \"grokable\" functions where possible so that everyone understands what's going on. \n\nFinally, as a quick sanity check, I ran treemap's bench suite on btree (`make check-collections -j8 PLEASE_BENCH=1`):\n\n```\ntest treemap::bench::find_rand_100                         ... bench:        74 ns/iter (+/- 5)\ntest treemap::bench::find_rand_10_000                      ... bench:       164 ns/iter (+/- 3)\ntest treemap::bench::find_seq_100                          ... bench:        76 ns/iter (+/- 2)\ntest treemap::bench::find_seq_10_000                       ... bench:       115 ns/iter (+/- 2)\ntest treemap::bench::insert_rand_100                       ... bench:       126 ns/iter (+/- 2)\ntest treemap::bench::insert_rand_10_000                    ... bench:      1025 ns/iter (+/- 16)\ntest treemap::bench::insert_seq_100                        ... bench:       507 ns/iter (+/- 19)\ntest treemap::bench::insert_seq_10_000                     ... bench:       834 ns/iter (+/- 15)\n\ntest btree::bench::find_rand_100                           ... bench:        86 ns/iter (+/- 4)\ntest btree::bench::find_rand_10_000                        ... bench:       165 ns/iter (+/- 2)\ntest btree::bench::find_seq_100                            ... bench:        86 ns/iter (+/- 2)\ntest btree::bench::find_seq_10_000                         ... bench:       117 ns/iter (+/- 1)\ntest btree::bench::insert_rand_100                         ... bench:       270 ns/iter (+/- 10)\ntest btree::bench::insert_rand_10_000                      ... bench:       598 ns/iter (+/- 18)\ntest btree::bench::insert_seq_100                          ... bench:       386 ns/iter (+/- 8)\ntest btree::bench::insert_seq_10_000                       ... bench:       459 ns/iter (+/- 4)\n```\n\nAs you can see, my implementation is generally competitive with treemap, and is substantially faster during large insertion workloads. And as discussed above, I haven't even begun to tune it; my choice of B is largely arbitrary!\n\nIf anyone is a low-level optimizing expert, or just knows good BTree design/tuning, I'd love to get any feedback on this work. If anyone has any other ideas or questions, I'm more than happy to discuss this with you!\n",
  "closed_by": {
    "login": "Gankra",
    "id": 1136864,
    "node_id": "MDQ6VXNlcjExMzY4NjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Gankra",
    "html_url": "https://github.com/Gankra",
    "followers_url": "https://api.github.com/users/Gankra/followers",
    "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
    "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
    "organizations_url": "https://api.github.com/users/Gankra/orgs",
    "repos_url": "https://api.github.com/users/Gankra/repos",
    "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Gankra/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/16906/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/16906/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
