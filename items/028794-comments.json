[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/144883672",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-144883672",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 144883672,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0NDg4MzY3Mg==",
    "user": {
      "login": "ranma42",
      "id": 1506030,
      "node_id": "MDQ6VXNlcjE1MDYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1506030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ranma42",
      "html_url": "https://github.com/ranma42",
      "followers_url": "https://api.github.com/users/ranma42/followers",
      "following_url": "https://api.github.com/users/ranma42/following{/other_user}",
      "gists_url": "https://api.github.com/users/ranma42/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ranma42/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ranma42/subscriptions",
      "organizations_url": "https://api.github.com/users/ranma42/orgs",
      "repos_url": "https://api.github.com/users/ranma42/repos",
      "events_url": "https://api.github.com/users/ranma42/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ranma42/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-10-02T00:27:35Z",
    "updated_at": "2016-03-06T11:00:40Z",
    "body": "`_dyld_register_func_for_remove_image` might be the hook we need.\nManpage available at https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man3/dyld.3.html\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/144883672/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187548449",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-187548449",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 187548449,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NzU0ODQ0OQ==",
    "user": {
      "login": "emoon",
      "id": 350822,
      "node_id": "MDQ6VXNlcjM1MDgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/350822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/emoon",
      "html_url": "https://github.com/emoon",
      "followers_url": "https://api.github.com/users/emoon/followers",
      "following_url": "https://api.github.com/users/emoon/following{/other_user}",
      "gists_url": "https://api.github.com/users/emoon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/emoon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/emoon/subscriptions",
      "organizations_url": "https://api.github.com/users/emoon/orgs",
      "repos_url": "https://api.github.com/users/emoon/repos",
      "events_url": "https://api.github.com/users/emoon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/emoon/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-23T05:48:09Z",
    "updated_at": "2016-02-23T05:48:09Z",
    "body": "cc @emoon\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187548449/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/192754571",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-192754571",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 192754571,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5Mjc1NDU3MQ==",
    "user": {
      "login": "emoon",
      "id": 350822,
      "node_id": "MDQ6VXNlcjM1MDgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/350822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/emoon",
      "html_url": "https://github.com/emoon",
      "followers_url": "https://api.github.com/users/emoon/followers",
      "following_url": "https://api.github.com/users/emoon/following{/other_user}",
      "gists_url": "https://api.github.com/users/emoon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/emoon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/emoon/subscriptions",
      "organizations_url": "https://api.github.com/users/emoon/orgs",
      "repos_url": "https://api.github.com/users/emoon/repos",
      "events_url": "https://api.github.com/users/emoon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/emoon/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-03-05T22:48:01Z",
    "updated_at": "2016-03-05T22:48:01Z",
    "body": "Has there been any progress on this issue? It can be worked around but not releasing the lib but it would be nice to have a proper solution.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/192754571/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244161730",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-244161730",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 244161730,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0NDE2MTczMA==",
    "user": {
      "login": "noeleont",
      "id": 2394624,
      "node_id": "MDQ6VXNlcjIzOTQ2MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2394624?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/noeleont",
      "html_url": "https://github.com/noeleont",
      "followers_url": "https://api.github.com/users/noeleont/followers",
      "following_url": "https://api.github.com/users/noeleont/following{/other_user}",
      "gists_url": "https://api.github.com/users/noeleont/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/noeleont/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/noeleont/subscriptions",
      "organizations_url": "https://api.github.com/users/noeleont/orgs",
      "repos_url": "https://api.github.com/users/noeleont/repos",
      "events_url": "https://api.github.com/users/noeleont/events{/privacy}",
      "received_events_url": "https://api.github.com/users/noeleont/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-09-01T18:03:42Z",
    "updated_at": "2016-09-01T18:03:42Z",
    "body": "I had the same issue, one workaround was loading the lib with RTLD_NODELETE. \n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244161730/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/268709934",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-268709934",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 268709934,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2ODcwOTkzNA==",
    "user": {
      "login": "solarretrace",
      "id": 8649987,
      "node_id": "MDQ6VXNlcjg2NDk5ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8649987?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/solarretrace",
      "html_url": "https://github.com/solarretrace",
      "followers_url": "https://api.github.com/users/solarretrace/followers",
      "following_url": "https://api.github.com/users/solarretrace/following{/other_user}",
      "gists_url": "https://api.github.com/users/solarretrace/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/solarretrace/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/solarretrace/subscriptions",
      "organizations_url": "https://api.github.com/users/solarretrace/orgs",
      "repos_url": "https://api.github.com/users/solarretrace/repos",
      "events_url": "https://api.github.com/users/solarretrace/events{/privacy}",
      "received_events_url": "https://api.github.com/users/solarretrace/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-12-22T03:31:09Z",
    "updated_at": "2016-12-22T03:31:09Z",
    "body": "I think I'm having the same issue? But the RTLD_NODELETE option doesn't seem to help. It's also probably not appropriate for my use-case, which requires unloading and reloading the library repeatedly.\r\n\r\nStack looks like this:\r\n\r\nException Type:        EXC_BAD_ACCESS (SIGSEGV)\r\nException Codes:       KERN_INVALID_ADDRESS at 0x0000000115ab5cb0\r\n\r\nThread 0 Crashed:: Dispatch queue: com.apple.main-thread\r\n0   libsystem_malloc.dylib        \t0x00007fff8e8c5059 free + 58\r\n1   dyld                          \t0x00007fff6542cec1 ImageLoaderMachOCompressed::~ImageLoaderMachOCompressed() + 33\r\n2   dyld                          \t0x00007fff6541afc4 dyld::garbageCollectImages() + 831\r\n3   dyld                          \t0x00007fff65422428 dlclose + 134\r\n4   libdyld.dylib                 \t0x00007fff91143808 dlclose + 61\r\n5   brightlab                     \t0x000000010c54cfdb libloading::os::unix::{{impl}}::drop::{{closure}} + 43 (mod.rs:38)\r\n6   brightlab                     \t0x000000010c54cd56 libloading::os::unix::with_dlerror<(),closure> + 134 (mod.rs:38)\r\n7   brightlab                     \t0x000000010c54cf7d _$LT$libloading..os..unix..Library$u20$as$u20$core..ops..Drop$GT$::drop::hd8137c4da21c7d9d + 45 (mod.rs:38)\r\n8   brightlab                     \t0x000000010c4908e1 drop::h9ed5b642e5309eab + 17\r\n9   brightlab                     \t0x000000010c48e409 drop::h2bbca3905b6b58a1 + 9\r\n10  brightlab                     \t0x000000010c490e28 drop::haca7bed875860903 + 72\r\n11  brightlab                     \t0x000000010c48dee1 drop::h1e1054b6f31067c0 + 17\r\n12  brightlab                     \t0x000000010c48f385 drop::h529da6d106e4933f + 149\r\n13  brightlab                     \t0x000000010c4b2313 brightlab::main + 835 (main.rs:37)\r\n14  brightlab                     \t0x000000010c55997b __rust_maybe_catch_panic + 27 (lib.rs:106)\r\n15  brightlab                     \t0x000000010c558ec7 std::rt::lang_start::hefd96b70277e8a4a + 391 (rt.rs:57)\r\n16  brightlab                     \t0x000000010c4b245a main + 42\r\n17  libdyld.dylib                 \t0x00007fff911445c9 start + 1",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/268709934/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/268710960",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-268710960",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 268710960,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2ODcxMDk2MA==",
    "user": {
      "login": "nagisa",
      "id": 679122,
      "node_id": "MDQ6VXNlcjY3OTEyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nagisa",
      "html_url": "https://github.com/nagisa",
      "followers_url": "https://api.github.com/users/nagisa/followers",
      "following_url": "https://api.github.com/users/nagisa/following{/other_user}",
      "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions",
      "organizations_url": "https://api.github.com/users/nagisa/orgs",
      "repos_url": "https://api.github.com/users/nagisa/repos",
      "events_url": "https://api.github.com/users/nagisa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nagisa/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-12-22T03:40:14Z",
    "updated_at": "2016-12-22T03:40:14Z",
    "body": "Lack of `_tlv_atexit` in the backtrace seems to suggest that yours is different issue. [This comment](https://www.reddit.com/r/rust/comments/3n1ozv/segfault_when_using_dlclose_on_a_rust_library_osx/cvk5q8q/) might help to give some pointers.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/268710960/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/268919240",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-268919240",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 268919240,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2ODkxOTI0MA==",
    "user": {
      "login": "solarretrace",
      "id": 8649987,
      "node_id": "MDQ6VXNlcjg2NDk5ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8649987?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/solarretrace",
      "html_url": "https://github.com/solarretrace",
      "followers_url": "https://api.github.com/users/solarretrace/followers",
      "following_url": "https://api.github.com/users/solarretrace/following{/other_user}",
      "gists_url": "https://api.github.com/users/solarretrace/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/solarretrace/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/solarretrace/subscriptions",
      "organizations_url": "https://api.github.com/users/solarretrace/orgs",
      "repos_url": "https://api.github.com/users/solarretrace/repos",
      "events_url": "https://api.github.com/users/solarretrace/events{/privacy}",
      "received_events_url": "https://api.github.com/users/solarretrace/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-12-23T00:17:38Z",
    "updated_at": "2016-12-23T00:32:52Z",
    "body": "Hmm, I got the impression from that comment that it would be fixed by default... I'll look into it, thanks.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/268919240/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/302386427",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-302386427",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 302386427,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwMjM4NjQyNw==",
    "user": {
      "login": "Mark-Simulacrum",
      "id": 5047365,
      "node_id": "MDQ6VXNlcjUwNDczNjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Mark-Simulacrum",
      "html_url": "https://github.com/Mark-Simulacrum",
      "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers",
      "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}",
      "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions",
      "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs",
      "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos",
      "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-05-18T12:14:20Z",
    "updated_at": "2017-05-18T12:14:20Z",
    "body": "Copying code into here so it doesn't get lost; https://github.com/nagisa/rust_libloading/issues/5 is potentially relevant.\r\n\r\ntest.rs:\r\n```rust\r\n#[no_mangle]\r\npub extern \"system\" fn test_fn() -> i32 {\r\n    // Removing this line prevents the segfault.\r\n    // I've tried flushing stdout as well but it doesn't change anything\r\n    println!(\"In library!\");\r\n    123456\r\n}\r\n```\r\n\r\nmain.c:\r\n```c\r\n#include <dlfcn.h>\r\n#include <stdio.h>\r\n\r\nint main() {\r\n    printf(\"running\\n\");\r\n    void* handle = dlopen(\"./libtest.dylib\", RTLD_LAZY);\r\n    printf(\"opened: %p\\n\", handle);\r\n\r\n    int (*test_fn)() = dlsym(handle, \"test_fn\");\r\n    printf(\"test_fn: %d\\n\", test_fn());\r\n\r\n    printf(\"Closing...\\n\");\r\n    int code = dlclose(handle); // Removing this line prevents the segfault upon exit?\r\n    printf(\"Closed: %d.\\n\", code);\r\n}\r\n```\r\n\r\n```\r\n$ rustc --crate-type=dylib test.rs\r\n$ gcc main.c\r\n$ ./a.out\r\nrunning\r\nopened: 0x7f8a93c02640\r\nIn library!\r\ntest_fn: 123456\r\nClosing...\r\nClosed: 0.\r\nSegmentation fault: 11\r\n```",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/302386427/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344365390",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-344365390",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 344365390,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NDM2NTM5MA==",
    "user": {
      "login": "aidanhs",
      "id": 1050652,
      "node_id": "MDQ6VXNlcjEwNTA2NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1050652?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aidanhs",
      "html_url": "https://github.com/aidanhs",
      "followers_url": "https://api.github.com/users/aidanhs/followers",
      "following_url": "https://api.github.com/users/aidanhs/following{/other_user}",
      "gists_url": "https://api.github.com/users/aidanhs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aidanhs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aidanhs/subscriptions",
      "organizations_url": "https://api.github.com/users/aidanhs/orgs",
      "repos_url": "https://api.github.com/users/aidanhs/repos",
      "events_url": "https://api.github.com/users/aidanhs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aidanhs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-14T19:11:56Z",
    "updated_at": "2017-11-14T19:11:56Z",
    "body": "Mention of `RTLD_NODELETE` on reddit - https://www.reddit.com/r/rust/comments/7cxknc/evolving_our_rust_with_milksnake/dptgnng/?context=3",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344365390/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344395142",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-344395142",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 344395142,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NDM5NTE0Mg==",
    "user": {
      "login": "mitsuhiko",
      "id": 7396,
      "node_id": "MDQ6VXNlcjczOTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7396?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mitsuhiko",
      "html_url": "https://github.com/mitsuhiko",
      "followers_url": "https://api.github.com/users/mitsuhiko/followers",
      "following_url": "https://api.github.com/users/mitsuhiko/following{/other_user}",
      "gists_url": "https://api.github.com/users/mitsuhiko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mitsuhiko/subscriptions",
      "organizations_url": "https://api.github.com/users/mitsuhiko/orgs",
      "repos_url": "https://api.github.com/users/mitsuhiko/repos",
      "events_url": "https://api.github.com/users/mitsuhiko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mitsuhiko/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-14T20:54:34Z",
    "updated_at": "2017-11-14T20:54:34Z",
    "body": "I ran into this and looked at ways to work around this. It comes up with Python extension modules and so far we just decided to leak the module. The reason this cannot really be fixed to the best of my knowledge is that `_tlv_atexit` (which is somewhat of an undocumented api as far as I can tell) does not have a way to unregister the callback.\r\n\r\nSince the only callback that rust can reasonably place here is from the dylib we can't really register something here that does not crash if the dylib goes away. One would need to find a trampoline that can be used and does not unload. Unsure what the fix here is. This seems like a bug in macos albeit one that has low changes of fixing.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/344395142/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/362767581",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-362767581",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 362767581,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2Mjc2NzU4MQ==",
    "user": {
      "login": "BurntPizza",
      "id": 4973668,
      "node_id": "MDQ6VXNlcjQ5NzM2Njg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4973668?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/BurntPizza",
      "html_url": "https://github.com/BurntPizza",
      "followers_url": "https://api.github.com/users/BurntPizza/followers",
      "following_url": "https://api.github.com/users/BurntPizza/following{/other_user}",
      "gists_url": "https://api.github.com/users/BurntPizza/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/BurntPizza/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/BurntPizza/subscriptions",
      "organizations_url": "https://api.github.com/users/BurntPizza/orgs",
      "repos_url": "https://api.github.com/users/BurntPizza/repos",
      "events_url": "https://api.github.com/users/BurntPizza/events{/privacy}",
      "received_events_url": "https://api.github.com/users/BurntPizza/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-02-03T02:20:53Z",
    "updated_at": "2018-02-03T02:25:20Z",
    "body": "I'm getting something similar on Arch: https://github.com/BurntPizza/dylib_tls_crash\r\n\r\n```\r\n$ cargo build && valgrind target/debug/dylib_crash\r\n    Finished dev [unoptimized + debuginfo] target(s) in 0.0 secs\r\n==27114== Memcheck, a memory error detector\r\n==27114== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.\r\n==27114== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info\r\n==27114== Command: target/debug/dylib_crash\r\n==27114== \r\nDropping lib\r\nLib is dropped\r\nSuccess: No thread\r\nDropping lib\r\nLib is dropped\r\n==27114== Thread 2:\r\n==27114== Jump to the invalid address stated on the next line\r\n==27114==    at 0x6EC23D0: ???\r\n==27114==    by 0x524B1B7: __nptl_deallocate_tsd.part.5 (in /usr/lib/libpthread-2.26.so)\r\n==27114==    by 0x524C1DC: start_thread (in /usr/lib/libpthread-2.26.so)\r\n==27114==    by 0x577042E: clone (in /usr/lib/libc-2.26.so)\r\n==27114==  Address 0x6ec23d0 is not stack'd, malloc'd or (recently) free'd\r\n==27114== \r\n==27114== Can't extend stack to 0x402a138 during signal delivery for thread 2:\r\n==27114==   no stack segment\r\n==27114== \r\n==27114== Process terminating with default action of signal 11 (SIGSEGV): dumping core\r\n==27114==  Access not within mapped region at address 0x402A138\r\n==27114==    at 0x6EC23D0: ???\r\n==27114==    by 0x524B1B7: __nptl_deallocate_tsd.part.5 (in /usr/lib/libpthread-2.26.so)\r\n==27114==    by 0x524C1DC: start_thread (in /usr/lib/libpthread-2.26.so)\r\n==27114==    by 0x577042E: clone (in /usr/lib/libc-2.26.so)\r\n==27114==  If you believe this happened as a result of a stack\r\n==27114==  overflow in your program's main thread (unlikely but\r\n==27114==  possible), you can try to increase the size of the\r\n==27114==  main thread stack using the --main-stacksize= flag.\r\n==27114==  The main thread stack size used in this run was 8388608.\r\n==27114== Invalid write of size 8\r\n==27114==    at 0x4A27630: _vgnU_freeres (in /usr/lib/valgrind/vgpreload_core-amd64-linux.so)\r\n==27114==  Address 0x402aff8 is on thread 2's stack\r\n==27114== \r\n==27114== \r\n==27114== Process terminating with default action of signal 11 (SIGSEGV)\r\n==27114==  Access not within mapped region at address 0x402AFF8\r\n==27114==    at 0x4A27630: _vgnU_freeres (in /usr/lib/valgrind/vgpreload_core-amd64-linux.so)\r\n==27114==  If you believe this happened as a result of a stack\r\n==27114==  overflow in your program's main thread (unlikely but\r\n==27114==  possible), you can try to increase the size of the\r\n==27114==  main thread stack using the --main-stacksize= flag.\r\n==27114== \r\n==27114== HEAP SUMMARY:\r\n==27114==     in use at exit: 384 bytes in 4 blocks\r\n==27114==   total heap usage: 33 allocs, 29 frees, 9,316 bytes allocated\r\n==27114== \r\n==27114== LEAK SUMMARY:\r\n==27114==    definitely lost: 0 bytes in 0 blocks\r\n==27114==    indirectly lost: 0 bytes in 0 blocks\r\n==27114==      possibly lost: 288 bytes in 1 blocks\r\n==27114==    still reachable: 96 bytes in 3 blocks\r\n==27114==         suppressed: 0 bytes in 0 blocks\r\n==27114== Rerun with --leak-check=full to see details of leaked memory\r\n==27114== \r\n==27114== For counts of detected and suppressed errors, rerun with: -v\r\n==27114== ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 0 from 0)\r\n[1]    27114 segmentation fault (core dumped)  valgrind target/debug/dylib_crash\r\n```\r\n\r\nThe difference here is that the segfault happens when a (non-main) thread exits, if there has been a dylib dropped in that thread, even if the lib doesn't contain anything (source-wise). `mem::forget` \"works\", but interestingly so does setting the lib's `crate-type` to `cdylib`. What are the differences between `dylib` and `cdylib` in regards to TLS destructors, at least with an empty rust library?\r\n\r\nVarious things can be found be searching for [__nptl_deallocate_tsd](https://www.google.com/search?q=__nptl_deallocate_tsd) but this seems above my pay grade. The most promising thing was this comment and the patch after it: https://bugzilla.redhat.com/show_bug.cgi?id=1065695#c12\r\n\r\nInfo:\r\n```\r\n$ rustc -V\r\nrustc 1.23.0 (766bd11c8 2018-01-01)\r\n\r\n$ uname -srv \r\nLinux 4.14.11-1-ARCH #1 SMP PREEMPT Wed Jan 3 07:02:42 UTC 2018\r\n```\r\n\r\nShould I make a separate issue?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/362767581/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368477904",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-368477904",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 368477904,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODQ3NzkwNA==",
    "user": {
      "login": "ubolonton",
      "id": 198359,
      "node_id": "MDQ6VXNlcjE5ODM1OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/198359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ubolonton",
      "html_url": "https://github.com/ubolonton",
      "followers_url": "https://api.github.com/users/ubolonton/followers",
      "following_url": "https://api.github.com/users/ubolonton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ubolonton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ubolonton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ubolonton/subscriptions",
      "organizations_url": "https://api.github.com/users/ubolonton/orgs",
      "repos_url": "https://api.github.com/users/ubolonton/repos",
      "events_url": "https://api.github.com/users/ubolonton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ubolonton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-02-26T11:58:22Z",
    "updated_at": "2018-02-26T11:58:22Z",
    "body": "This seems to have been fixed by some `dyld` changes in High Sierra.\r\nLooks like `dyld` now marks a dylib as \"never unload\" if it has `MH_HAS_TLV_DESCRIPTORS` flag in the header.\r\n\r\nOn the other hands, this means that Rust dylibs will never be unloaded on OS X?",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368477904/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368600929",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-368600929",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 368600929,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODYwMDkyOQ==",
    "user": {
      "login": "scottjmaddox",
      "id": 28676699,
      "node_id": "MDQ6VXNlcjI4Njc2Njk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/28676699?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/scottjmaddox",
      "html_url": "https://github.com/scottjmaddox",
      "followers_url": "https://api.github.com/users/scottjmaddox/followers",
      "following_url": "https://api.github.com/users/scottjmaddox/following{/other_user}",
      "gists_url": "https://api.github.com/users/scottjmaddox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/scottjmaddox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/scottjmaddox/subscriptions",
      "organizations_url": "https://api.github.com/users/scottjmaddox/orgs",
      "repos_url": "https://api.github.com/users/scottjmaddox/repos",
      "events_url": "https://api.github.com/users/scottjmaddox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/scottjmaddox/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-02-26T18:30:35Z",
    "updated_at": "2018-02-26T18:30:35Z",
    "body": "Are we 100% sure the issue is with TLS? I've got TLS working without segfault through a dlclose (and reopen) on macOS Sierra (10.12.6), but only if the dylib statically links to libstd. If the dylib is dynamically linked to libstd, then I get a segfault on dlclose regardless of whether or not I'm using TLS.\r\n\r\nThis is on stable rustc 1.24.0.\r\n\r\nThis is good enough for my use case (code hot reloading during development), but it would be nice to remove the requirement to statically link libstd into the dylib.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368600929/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368604952",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-368604952",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 368604952,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODYwNDk1Mg==",
    "user": {
      "login": "mitsuhiko",
      "id": 7396,
      "node_id": "MDQ6VXNlcjczOTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7396?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mitsuhiko",
      "html_url": "https://github.com/mitsuhiko",
      "followers_url": "https://api.github.com/users/mitsuhiko/followers",
      "following_url": "https://api.github.com/users/mitsuhiko/following{/other_user}",
      "gists_url": "https://api.github.com/users/mitsuhiko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mitsuhiko/subscriptions",
      "organizations_url": "https://api.github.com/users/mitsuhiko/orgs",
      "repos_url": "https://api.github.com/users/mitsuhiko/repos",
      "events_url": "https://api.github.com/users/mitsuhiko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mitsuhiko/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-02-26T18:43:46Z",
    "updated_at": "2018-02-26T18:43:46Z",
    "body": "@scottjmaddox this particular crash is from what's registered to `_tlv_atexit` which is exclusively used by thread locals. If you have a different crash that might be interesting as well.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368604952/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368693049",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-368693049",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 368693049,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODY5MzA0OQ==",
    "user": {
      "login": "nanotech",
      "id": 34699,
      "node_id": "MDQ6VXNlcjM0Njk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/34699?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nanotech",
      "html_url": "https://github.com/nanotech",
      "followers_url": "https://api.github.com/users/nanotech/followers",
      "following_url": "https://api.github.com/users/nanotech/following{/other_user}",
      "gists_url": "https://api.github.com/users/nanotech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nanotech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nanotech/subscriptions",
      "organizations_url": "https://api.github.com/users/nanotech/orgs",
      "repos_url": "https://api.github.com/users/nanotech/repos",
      "events_url": "https://api.github.com/users/nanotech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nanotech/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-02-26T23:49:16Z",
    "updated_at": "2018-02-26T23:49:16Z",
    "body": "[WWDC 2017's Session 413 @ 29:36](https://developer.apple.com/videos/play/wwdc2017/413/?time=1776) mentions that using TLS prevents a dylib from being unloaded:\r\n\r\n> There are also a number of features on our platforms that prevent dylibs from unloading, and I'd like to go through a few of those because maybe you do them.\r\n>\r\n> You can have Objective-C classes in your dylib. That will make it not unloadable.\r\n>\r\n> You could have Swift classes. That will also make it not unloadable.\r\n>\r\n> And you can have C __thread or C++ thread local variables, all of which make it impossible to unload a dylib.\r\n>\r\n> So on macOS, where there's a number of existing Unix apps, obviously we will keep this working, but because almost every dylib on all of our other platforms does one of these things, effectively it hasn't really worked on any of them ever.\r\n>\r\n> So we are considering making it just a straight up no-op, that will not do anything on any of those platforms. If there's a reason why that's a problem, please, we want to hear about it.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/368693049/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/376785923",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-376785923",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 376785923,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3Njc4NTkyMw==",
    "user": {
      "login": "nagisa",
      "id": 679122,
      "node_id": "MDQ6VXNlcjY3OTEyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nagisa",
      "html_url": "https://github.com/nagisa",
      "followers_url": "https://api.github.com/users/nagisa/followers",
      "following_url": "https://api.github.com/users/nagisa/following{/other_user}",
      "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions",
      "organizations_url": "https://api.github.com/users/nagisa/orgs",
      "repos_url": "https://api.github.com/users/nagisa/repos",
      "events_url": "https://api.github.com/users/nagisa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nagisa/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-03-28T07:15:05Z",
    "updated_at": "2018-03-28T07:15:05Z",
    "body": "@alexcrichton seems like MacOS people have fixed this. Should we close?",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/376785923/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/376904758",
    "html_url": "https://github.com/rust-lang/rust/issues/28794#issuecomment-376904758",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28794",
    "id": 376904758,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3NjkwNDc1OA==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-03-28T14:21:54Z",
    "updated_at": "2018-03-28T14:21:54Z",
    "body": "Sure!",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/376904758/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
