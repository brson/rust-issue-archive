[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7570802",
    "html_url": "https://github.com/rust-lang/rust/issues/3139#issuecomment-7570802",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/3139",
    "id": 7570802,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NzA4MDI=",
    "user": {
      "login": "bblum",
      "id": 1820515,
      "node_id": "MDQ6VXNlcjE4MjA1MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bblum",
      "html_url": "https://github.com/bblum",
      "followers_url": "https://api.github.com/users/bblum/followers",
      "following_url": "https://api.github.com/users/bblum/following{/other_user}",
      "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bblum/subscriptions",
      "organizations_url": "https://api.github.com/users/bblum/orgs",
      "repos_url": "https://api.github.com/users/bblum/repos",
      "events_url": "https://api.github.com/users/bblum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bblum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-08-07T23:45:00Z",
    "updated_at": "2012-08-07T23:45:00Z",
    "body": "\"weak\" = \"nonexistent\" :P\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7570802/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7570863",
    "html_url": "https://github.com/rust-lang/rust/issues/3139#issuecomment-7570863",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/3139",
    "id": 7570863,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NzA4NjM=",
    "user": {
      "login": "eholk",
      "id": 105766,
      "node_id": "MDQ6VXNlcjEwNTc2Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eholk",
      "html_url": "https://github.com/eholk",
      "followers_url": "https://api.github.com/users/eholk/followers",
      "following_url": "https://api.github.com/users/eholk/following{/other_user}",
      "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eholk/subscriptions",
      "organizations_url": "https://api.github.com/users/eholk/orgs",
      "repos_url": "https://api.github.com/users/eholk/repos",
      "events_url": "https://api.github.com/users/eholk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eholk/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-08-07T23:47:58Z",
    "updated_at": "2012-08-07T23:47:58Z",
    "body": "I should add, this is the sort of change that should undergo heavy stress testing before pushing to incoming, as it's very prone to introducing races.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7570863/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7571711",
    "html_url": "https://github.com/rust-lang/rust/issues/3139#issuecomment-7571711",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/3139",
    "id": 7571711,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NzE3MTE=",
    "user": {
      "login": "eholk",
      "id": 105766,
      "node_id": "MDQ6VXNlcjEwNTc2Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eholk",
      "html_url": "https://github.com/eholk",
      "followers_url": "https://api.github.com/users/eholk/followers",
      "following_url": "https://api.github.com/users/eholk/following{/other_user}",
      "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eholk/subscriptions",
      "organizations_url": "https://api.github.com/users/eholk/orgs",
      "repos_url": "https://api.github.com/users/eholk/repos",
      "events_url": "https://api.github.com/users/eholk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eholk/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-08-08T00:34:21Z",
    "updated_at": "2012-08-08T00:34:21Z",
    "body": "I just implemented this. It made absolutely no performance change in the one test I looked at. Because it makes the code far more intricate, I vote for not doing it. In case anyone ever wants to try again though, here is the diff:\n\n```\ndiff --git a/src/libcore/pipes.rs b/src/libcore/pipes.rs\nindex b6b54a4..e415086 100644\n--- a/src/libcore/pipes.rs\n+++ b/src/libcore/pipes.rs\n@@ -111,6 +111,22 @@ type buffer<T: send> = {\n     data: T,\n };\n\n+#[doc(hidden)]\n+fn strengthen_task(task: *rust_task) -> *rust_task unsafe {\n+    // Sets the low bit on a task, indicating that it needs a deref.\n+\n+    let x : libc::uintptr_t = reinterpret_cast(task);\n+    reinterpret_cast(x | 1)\n+}\n+\n+fn weaken_task(task: *rust_task) -> (*rust_task, bool) unsafe {\n+    let x : libc::uintptr_t = reinterpret_cast(task);\n+    let strong = x & 1;\n+    // 0 the low bit.\n+    let x = (x >> 1) << 1;\n+    (reinterpret_cast(x), if strong == 1 { true } else { false })\n+}\n+\n struct packet_header {\n     let mut state: state;\n     let mut blocked_task: *rust_task;\n@@ -128,6 +144,7 @@ struct packet_header {\n     // Returns the old state.\n     unsafe fn mark_blocked(this: *rust_task) -> state {\n         rustrt::rust_task_ref(this);\n+        let this = strengthen_task(this);\n         let old_task = swap_task(self.blocked_task, this);\n         assert old_task.is_null();\n         swap_state_acq(self.state, blocked)\n@@ -135,7 +152,11 @@ struct packet_header {\n\n     unsafe fn unblock() {\n         let old_task = swap_task(self.blocked_task, ptr::null());\n-        if !old_task.is_null() { rustrt::rust_task_deref(old_task) }\n+        if !old_task.is_null() {\n+            let (old_task, deref) = weaken_task(old_task);\n+            assert deref;\n+            rustrt::rust_task_deref(old_task)\n+        }\n         match swap_state_acq(self.state, empty) {\n           empty | blocked => (),\n           terminated => self.state = terminated,\n@@ -358,9 +379,12 @@ fn send<T: send, Tbuffer: send>(-p: send_packet_buffered<T, Tbuffer>,\n             debug!{\"waking up task for %?\", p_};\n             let old_task = swap_task(p.header.blocked_task, ptr::null());\n             if !old_task.is_null() {\n+                let (old_task, deref) = weaken_task(old_task);\n                 rustrt::task_signal_event(\n                     old_task, ptr::addr_of(p.header) as *libc::c_void);\n-                rustrt::rust_task_deref(old_task);\n+                if deref {\n+                    rustrt::rust_task_deref(old_task);\n+                }\n             }\n\n             // The receiver will eventually clean this up.\n@@ -411,9 +435,7 @@ fn try_recv<T: send, Tbuffer: send>(-p: recv_packet_buffered<T, Tbuffer>)\n     // regular path\n     let this = rustrt::rust_get_task();\n     rustrt::task_clear_event_reject(this);\n-    rustrt::rust_task_ref(this);\n-    let old_task = swap_task(p.header.blocked_task, this);\n-    assert old_task.is_null();\n+    p.header.blocked_task = this;\n     let mut first = true;\n     let mut count = SPIN_COUNT;\n     loop {\n@@ -443,10 +465,7 @@ fn try_recv<T: send, Tbuffer: send>(-p: recv_packet_buffered<T, Tbuffer>)\n           full => {\n             let mut payload = none;\n             payload <-> p.payload;\n-            let old_task = swap_task(p.header.blocked_task, ptr::null());\n-            if !old_task.is_null() {\n-                rustrt::rust_task_deref(old_task);\n-            }\n+            p.header.blocked_task = ptr::null();\n             p.header.state = empty;\n             return some(option::unwrap(payload))\n           }\n@@ -454,11 +473,7 @@ fn try_recv<T: send, Tbuffer: send>(-p: recv_packet_buffered<T, Tbuffer>)\n             // This assert detects when we've accidentally unsafely\n             // casted too big of a number to a state.\n             assert old_state == terminated;\n-\n-            let old_task = swap_task(p.header.blocked_task, ptr::null());\n-            if !old_task.is_null() {\n-                rustrt::rust_task_deref(old_task);\n-            }\n+            p.header.blocked_task = ptr::null();\n             return none;\n           }\n         }\n@@ -494,10 +509,13 @@ fn sender_terminate<T: send>(p: *packet<T>) {\n         // wake up the target\n         let old_task = swap_task(p.header.blocked_task, ptr::null());\n         if !old_task.is_null() {\n+            let (old_task, deref) = weaken_task(old_task);\n             rustrt::task_signal_event(\n                 old_task,\n                 ptr::addr_of(p.header) as *libc::c_void);\n-            rustrt::rust_task_deref(old_task);\n+            if deref {\n+                rustrt::rust_task_deref(old_task);\n+            }\n         }\n         // The receiver will eventually clean up.\n         //unsafe { forget(p) }\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/7571711/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
