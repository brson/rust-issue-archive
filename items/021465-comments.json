[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70843765",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70843765",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70843765,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwODQzNzY1",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T14:15:37Z",
    "updated_at": "2015-01-21T14:15:37Z",
    "body": "On the other hand, `extend4` does not optimize better than `extend2`:\n\n``` rust\n#[inline(never)]\nfn extend2<T, I: Iterator<Item=T>+ExactSizeIterator>(vec: &mut Vec<T>, mut iter: I) {\n    let len = iter.len();\n    vec.reserve(len);\n    unsafe {\n        let mut ptr = vec.as_mut_ptr().offset(vec.len() as isize);\n        let end = ptr.offset(len as isize);\n        while ptr != end {\n            let el = iter.next();\n            assume(el.is_some());\n            ptr::write(ptr, el.unwrap());\n            ptr = ptr.offset(1);\n        }\n    }\n}\n```\n\nSo one might assume that if one can get `extend4` to optimize to a memcpy, then `extend2` will also optimize to a memcpy.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70843765/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70905697",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70905697",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70905697,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTA1Njk3",
    "user": {
      "login": "Gankra",
      "id": 1136864,
      "node_id": "MDQ6VXNlcjExMzY4NjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gankra",
      "html_url": "https://github.com/Gankra",
      "followers_url": "https://api.github.com/users/Gankra/followers",
      "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
      "organizations_url": "https://api.github.com/users/Gankra/orgs",
      "repos_url": "https://api.github.com/users/Gankra/repos",
      "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gankra/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T19:35:00Z",
    "updated_at": "2015-01-21T19:35:00Z",
    "body": "CC @Aatch \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70905697/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70920054",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70920054",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70920054,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTIwMDU0",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T20:57:37Z",
    "updated_at": "2015-01-21T20:57:37Z",
    "body": "It is possible to _always_ inline methods with `#[inline(always)]`. While I generally discourage use of the attribute, it certainly has its uses for when LLVM seems reluctant to do it itself.\n\nI might investigate what's going on here though. I assume this is all in the same crate?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70920054/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70921175",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70921175",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70921175,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTIxMTc1",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T21:04:01Z",
    "updated_at": "2015-01-21T21:04:22Z",
    "body": "@Aatch: Adding this attribute to the `next` function up there changes nothing.\n\n> I assume this is all in the same crate?\n\nIt's all one file.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70921175/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70921909",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70921909",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70921909,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTIxOTA5",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T21:08:25Z",
    "updated_at": "2015-01-21T21:08:25Z",
    "body": "Maybe related: #18363\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70921909/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70933758",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70933758",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70933758,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTMzNzU4",
    "user": {
      "login": "Aatch",
      "id": 342416,
      "node_id": "MDQ6VXNlcjM0MjQxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/342416?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Aatch",
      "html_url": "https://github.com/Aatch",
      "followers_url": "https://api.github.com/users/Aatch/followers",
      "following_url": "https://api.github.com/users/Aatch/following{/other_user}",
      "gists_url": "https://api.github.com/users/Aatch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Aatch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Aatch/subscriptions",
      "organizations_url": "https://api.github.com/users/Aatch/orgs",
      "repos_url": "https://api.github.com/users/Aatch/repos",
      "events_url": "https://api.github.com/users/Aatch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Aatch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T22:21:04Z",
    "updated_at": "2015-01-21T22:21:04Z",
    "body": "Ok, figured out the problem. It's one I already know about, which is nice I guess. The long and short of it though is that LLVM doesn't know about ownership. To demonstrate, this change to `extend4` causes it to generate the same IR as `extend5`:\n\n``` rust\n#[inline(never)]\nfn extend4<T, I: RawIterator<Item=T>>(vec: &mut Vec<T>, iter: I) {\n    let mut iter = iter; // Add this line\n    let len = iter.len();\n    vec.reserve(len);\n    unsafe {\n        let mut ptr = vec.as_mut_ptr().offset(vec.len() as isize);\n        let end = ptr.offset(len as isize);\n        while ptr != end {\n            ptr::write(ptr, iter.next());\n            ptr = ptr.offset(1);\n        }\n    }\n}\n```\n\nThat is literally it. The problem is that LLVM doesn't realise that, in the caller, the changes won't be visible. The iterator is passed as a pointer, due to it being too big to be an immediate. Thus we're writing to memory that can be seen from outside the function.\n\nMaking a new variable copies the iterator into a local stack slot and LLVM suddenly gets much happier about optimising to much faster code. The ideal fix would be to teach LLVM a bit about our ownership semantics.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70933758/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70934672",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70934672",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70934672,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTM0Njcy",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T22:26:54Z",
    "updated_at": "2015-01-21T22:26:54Z",
    "body": "Ah, so the problem wasn't the function call but the place where the pointer was stored? Either way, with this change the `extend2` function which just uses the proposed ExactSizeIterator trait does optimize to a memcpy:\n\n``` rust\n#[inline(never)]\nfn extend2<T, I: Iterator<Item=T>+ExactSizeIterator>(vec: &mut Vec<T>, iter: I) {\n    let mut iter = iter;\n    let len = iter.len();\n    vec.reserve(len);\n    unsafe {\n        let mut ptr = vec.as_mut_ptr().offset(vec.len() as isize);\n        let end = ptr.offset(len as isize);\n        while ptr != end {\n            let el = iter.next();\n            assume(el.is_some());\n            ptr::write(ptr, el.unwrap());\n            ptr = ptr.offset(1);\n        }\n    }\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70934672/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70936231",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70936231",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70936231,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTM2MjMx",
    "user": {
      "login": "Gankra",
      "id": 1136864,
      "node_id": "MDQ6VXNlcjExMzY4NjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gankra",
      "html_url": "https://github.com/Gankra",
      "followers_url": "https://api.github.com/users/Gankra/followers",
      "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
      "organizations_url": "https://api.github.com/users/Gankra/orgs",
      "repos_url": "https://api.github.com/users/Gankra/repos",
      "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gankra/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T22:36:29Z",
    "updated_at": "2015-01-21T22:36:41Z",
    "body": "@mahkoh Is the while `ptr != end` style really necessary? Would a normal `for` not suffice (wouldn't be particularly surprised either way, just curious)?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70936231/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70936556",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70936556",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70936556,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTM2NTU2",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T22:38:22Z",
    "updated_at": "2015-01-21T22:38:22Z",
    "body": "Unfortunately\n\n``` rust\n#[inline(never)]\nfn extend1<T, I: Iterator<Item=T>+ExactSizeIterator>(vec: &mut Vec<T>, iter: I) {\n    let mut iter = iter;\n    let len = iter.len();\n    vec.reserve(len);\n    for _ in (0..len) {\n        let el = iter.next();\n        unsafe {\n            assume(el.is_some());\n            assume(vec.len() < vec.capacity());\n            vec.push(el.unwrap())\n        }\n    }\n}\n```\n\ndoesn't work.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70936556/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70937067",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70937067",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70937067,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTM3MDY3",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T22:41:39Z",
    "updated_at": "2015-01-21T22:41:39Z",
    "body": "Maybe `assume(vec.len() < vec.capacity());` is just too abstract. As a `Vec` method it might be possible to write this differently and then it might work.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70937067/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70937293",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70937293",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70937293,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTM3Mjkz",
    "user": {
      "login": "Gankra",
      "id": 1136864,
      "node_id": "MDQ6VXNlcjExMzY4NjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gankra",
      "html_url": "https://github.com/Gankra",
      "followers_url": "https://api.github.com/users/Gankra/followers",
      "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
      "organizations_url": "https://api.github.com/users/Gankra/orgs",
      "repos_url": "https://api.github.com/users/Gankra/repos",
      "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gankra/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T22:43:18Z",
    "updated_at": "2015-01-21T22:43:18Z",
    "body": "This is how I would \"ideally\" write it (ignoring panic concerns, which is I guess why you went with push?):\n\n```\nfn extend1<T, I: Iterator<Item=T>+ExactSizeIterator>(vec: &mut Vec<T>, iter: I) {\n    let mut iter = iter;\n    let len = iter.len();\n    vec.reserve(len);\n    let mut ptr = vec.as_mut_ptr().offset(vec.len());\n    for el in iter {\n       ptr.write(el);\n       ptr = ptr.offset(1);\n    }\n    vec.set_len(len);\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70937293/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70938111",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70938111",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70938111,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTM4MTEx",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T22:48:39Z",
    "updated_at": "2015-01-21T22:48:39Z",
    "body": "That does indeed work:\n\n``` rust\n#[inline(never)]\nfn extend7<T, I: Iterator<Item=T>+ExactSizeIterator>(vec: &mut Vec<T>, mut iter: I) {\n    let mut iter = iter;\n    let len = iter.len();\n    vec.reserve(len);\n    unsafe {\n        let mut ptr = vec.as_mut_ptr().offset(vec.len() as isize);\n        for el in iter {\n           ptr::write(ptr, el);\n           ptr = ptr.offset(1);\n        }\n        vec.set_len(len);\n    }\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70938111/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70939765",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70939765",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70939765,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTM5NzY1",
    "user": {
      "login": "Gankra",
      "id": 1136864,
      "node_id": "MDQ6VXNlcjExMzY4NjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gankra",
      "html_url": "https://github.com/Gankra",
      "followers_url": "https://api.github.com/users/Gankra/followers",
      "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
      "organizations_url": "https://api.github.com/users/Gankra/orgs",
      "repos_url": "https://api.github.com/users/Gankra/repos",
      "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gankra/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T23:00:16Z",
    "updated_at": "2015-01-21T23:00:16Z",
    "body": "Okay that's great. Just need to add an O(1) unwind guard to set the len and we're golddeeen... maybeeee..? \n\nAh zero-sized-types complicate this all, but it's easy enough to just have _another_ branch to cover that.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70939765/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70944761",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70944761",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70944761,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTQ0NzYx",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T23:39:21Z",
    "updated_at": "2015-01-22T11:48:56Z",
    "body": "``` rust\n#[inline(never)]\nfn extend7<T, I: Iterator<Item=T>+ExactSizeIterator>(vec: &mut Vec<T>, iter: I) {\n    struct PanicGuard<'a, T: 'a> {\n        vec: &'a mut Vec<T>,\n        ptr: *const *mut T,\n    }\n\n    #[unsafe_destructor]\n    impl<'a, T> Drop for PanicGuard<'a, T> {\n        fn drop(&mut self) {\n            unsafe {\n                let diff = *self.ptr as usize - self.vec.as_ptr() as usize;\n                let size = mem::size_of::<T>();\n                let len = diff / if size == 0 { 1 } else { size };\n                self.vec.set_len(len);\n            }\n        }\n    }\n\n    let mut iter = iter;\n    let len = iter.len();\n    vec.reserve(len);\n\n    unsafe {\n        {\n            let mut ptr = if mem::size_of::<T>() == 0 {\n                (vec.as_mut_ptr() as usize + vec.len()) as *mut T\n            } else {\n                vec.as_mut_ptr().offset(vec.len() as isize)\n            };\n            let guard = PanicGuard { vec: vec, ptr: &ptr };\n            for el in iter {\n               ptr::write(ptr, el);\n               ptr = if mem::size_of::<T>() == 0 {\n                   (ptr as usize + 1) as *mut T\n               } else {\n                   ptr.offset(1)\n               };\n            }\n            mem::forget(guard);\n        }\n        vec.set_len(len);\n    }\n}\n```\n\nThis works but only for primitive types.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70944761/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70945026",
    "html_url": "https://github.com/rust-lang/rust/issues/21465#issuecomment-70945026",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/21465",
    "id": 70945026,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTQ1MDI2",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-21T23:41:35Z",
    "updated_at": "2015-01-21T23:41:35Z",
    "body": "LLVM will not optimize this for structs even if the struct contains a single primitive field.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70945026/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
