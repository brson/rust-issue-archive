[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/152824822",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-152824822",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 152824822,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1MjgyNDgyMg==",
    "user": {
      "login": "retep998",
      "id": 666308,
      "node_id": "MDQ6VXNlcjY2NjMwOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/666308?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/retep998",
      "html_url": "https://github.com/retep998",
      "followers_url": "https://api.github.com/users/retep998/followers",
      "following_url": "https://api.github.com/users/retep998/following{/other_user}",
      "gists_url": "https://api.github.com/users/retep998/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/retep998/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/retep998/subscriptions",
      "organizations_url": "https://api.github.com/users/retep998/orgs",
      "repos_url": "https://api.github.com/users/retep998/repos",
      "events_url": "https://api.github.com/users/retep998/events{/privacy}",
      "received_events_url": "https://api.github.com/users/retep998/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-01T13:16:13Z",
    "updated_at": "2015-11-01T13:16:13Z",
    "body": "I think this is just race conditions at work. When you delete a file another program might get a notification and check out what happened and that might hold a temporary lock on something. Or it might be that the previous deletions weren't actually done by the time you tried to delete the directory.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/152824822/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/152828035",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-152828035",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 152828035,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1MjgyODAzNQ==",
    "user": {
      "login": "petrochenkov",
      "id": 5751617,
      "node_id": "MDQ6VXNlcjU3NTE2MTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/petrochenkov",
      "html_url": "https://github.com/petrochenkov",
      "followers_url": "https://api.github.com/users/petrochenkov/followers",
      "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}",
      "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions",
      "organizations_url": "https://api.github.com/users/petrochenkov/orgs",
      "repos_url": "https://api.github.com/users/petrochenkov/repos",
      "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/petrochenkov/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-01T13:58:13Z",
    "updated_at": "2015-11-01T13:59:31Z",
    "body": "Hm, https://github.com/CppCon/CppCon2015/blob/master/Tutorials/Racing%20the%20Filesystem/Racing%20the%20Filesystem%20-%20Niall%20Douglas%20-%20CppCon%202015.pdf slide \"3. Deleting a directory tree\" may be related. I accidentally watched this presentation yesterday. If I understood correctly, `DeleteFileW` used in `remove_dir_all` doesn't actually delete a file, but only marks it for deletion, it still can be alive when we try to delete the parent directory causing the \"directory is not empty\" error.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/152828035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/152829016",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-152829016",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 152829016,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1MjgyOTAxNg==",
    "user": {
      "login": "Diggsey",
      "id": 451321,
      "node_id": "MDQ6VXNlcjQ1MTMyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/451321?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Diggsey",
      "html_url": "https://github.com/Diggsey",
      "followers_url": "https://api.github.com/users/Diggsey/followers",
      "following_url": "https://api.github.com/users/Diggsey/following{/other_user}",
      "gists_url": "https://api.github.com/users/Diggsey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Diggsey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Diggsey/subscriptions",
      "organizations_url": "https://api.github.com/users/Diggsey/orgs",
      "repos_url": "https://api.github.com/users/Diggsey/repos",
      "events_url": "https://api.github.com/users/Diggsey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Diggsey/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-01T14:17:24Z",
    "updated_at": "2015-11-01T14:18:01Z",
    "body": "@petrochenkov Great link - that seems like it's exactly the problem I'm experiencing.\n\nIt would be great to see some of these portable race-free idioms implemented in std.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/152829016/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/153125709",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-153125709",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 153125709,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1MzEyNTcwOQ==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-02T19:02:59Z",
    "updated_at": "2015-11-02T19:02:59Z",
    "body": "I'd be interested to dig a bit more into this to see what's going on. According to the [`DeleteFile` documentation](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363915%28v=vs.85%29.aspx) the only reason the file would be flagged for deletion would be if there are active open handles, which seems like a legitimate race condition? Note though that the same docs also recommend using [`SHFileOperation`](https://msdn.microsoft.com/en-us/library/windows/desktop/bb762164%28v=vs.85%29.aspx) for recursively deleting a tree.\n\nThose slides are certainly an interesting read though! I'd be a little wary of putting it into the standard library as the \"transactional semantics\" are a little weird. For example if you successfully rename a file to a temporary directory and then fail to delete it, what happens?\n\nIt may be the case that the best implementation for this function on Windows is to just use SHFileOperation, and that may end up just taking care of these sorts of issues on its own.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/153125709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186183730",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186183730",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186183730,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjE4MzczMA==",
    "user": {
      "login": "pitdicker",
      "id": 6255050,
      "node_id": "MDQ6VXNlcjYyNTUwNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6255050?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pitdicker",
      "html_url": "https://github.com/pitdicker",
      "followers_url": "https://api.github.com/users/pitdicker/followers",
      "following_url": "https://api.github.com/users/pitdicker/following{/other_user}",
      "gists_url": "https://api.github.com/users/pitdicker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pitdicker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pitdicker/subscriptions",
      "organizations_url": "https://api.github.com/users/pitdicker/orgs",
      "repos_url": "https://api.github.com/users/pitdicker/repos",
      "events_url": "https://api.github.com/users/pitdicker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pitdicker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T11:44:16Z",
    "updated_at": "2016-02-22T19:08:14Z",
    "body": "I will give fixing this a try.\n\nOn Windows XP we could use `SHFileOperation`, and on Vista and up `IFileOperation`. For Windows store applications there is no easy function. But I would still like to try implementing it by walking the directories and deleting recursively.\n\nCurrent problems with `remove_dir_all`:\n- can not remove contents if the path becomes longer than MAX_PATH\n- files may not be deleted immediately, causing remove_dir to fail\n- unable to remove read-only files\n\nAnd what I hope will fix it:\n- use `canonicalise()` on the base dir to get support for long paths\n- generate hash\n- read-only files (possibly with hard links) TODO: can the read-only flag be stale?\n  - open file\n  - remove read-only flag\n  - ReOpenFile with FILE_FLAG_DELETE_ON_CLOSE\n  - set read-only flag\n  - continue as with normal files\n- normal files/dirs\n  - open with FILE_FLAG_BACKUP_SEMANTICS (for opening dirs)\n          FILE_FLAG_OPEN_REPARSE_POINT (for opening reparse points)\n          FILE_FLAG_DELETE_ON_CLOSE\n  - atomically rename with SetFileInformationByHandle and FILE_RENAME_INFO\n    (normal rename on xp)\n  - move all files and subdirectories to the parent of the dir to remove\n    (not to %TEMP%, may not be on the same drive)\n    rename them to rm-[hash]-[nr]\n\nI think we know deleting will fail when opening the file with `FILE_FLAG_DELETE_ON_CLOSE` fails, so before moving.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186183730/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186183980",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186183980",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186183980,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjE4Mzk4MA==",
    "user": {
      "login": "pitdicker",
      "id": 6255050,
      "node_id": "MDQ6VXNlcjYyNTUwNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6255050?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pitdicker",
      "html_url": "https://github.com/pitdicker",
      "followers_url": "https://api.github.com/users/pitdicker/followers",
      "following_url": "https://api.github.com/users/pitdicker/following{/other_user}",
      "gists_url": "https://api.github.com/users/pitdicker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pitdicker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pitdicker/subscriptions",
      "organizations_url": "https://api.github.com/users/pitdicker/orgs",
      "repos_url": "https://api.github.com/users/pitdicker/repos",
      "events_url": "https://api.github.com/users/pitdicker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pitdicker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T11:45:45Z",
    "updated_at": "2016-02-19T11:45:45Z",
    "body": "O, and I walked against this bug when rustbuild (is that the current name) failed after make clean because of this.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186183980/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186321216",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186321216",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186321216,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjMyMTIxNg==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T17:38:56Z",
    "updated_at": "2016-02-19T17:38:56Z",
    "body": "@pitdicker thanks for taking this on! We may want to discuss this a bit before moving much more on a solution. One question is how principled should something like `fs::remove_dir_all` be. For example if `fs::remove_dir_all` automatically handled read-only files, should `fs::remove_file` also do the same? Currently we have this \"duality\" where some `fs` functions are straight counterparts to the underlying system operations, but some are somewhat fancier like `create_dir_all` and `remove_dir_all`. We'd just want to make sure to have an explicitly drawn line here. Also note I'm not really thinking of an RFC here, just some more discussion before jumping to a PR.\n\nI personally feel that `remove_dir_all` is fine to be fancy and do lots of implicit operations. I would continue to want, however, that `remove_file` and `remove_dir` are as straightforward as possible (e.g. don't mirror what's happening here unless it's a similarly small set of operations as to what happens today). Your proposed strategy seems reasonable to me at first glance, and I wouldn't mind reviewing more over a PR.\n\nCurious what others think, though? cc @rust-lang/libs \n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186321216/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186333905",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186333905",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186333905,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjMzMzkwNQ==",
    "user": {
      "login": "Diggsey",
      "id": 451321,
      "node_id": "MDQ6VXNlcjQ1MTMyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/451321?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Diggsey",
      "html_url": "https://github.com/Diggsey",
      "followers_url": "https://api.github.com/users/Diggsey/followers",
      "following_url": "https://api.github.com/users/Diggsey/following{/other_user}",
      "gists_url": "https://api.github.com/users/Diggsey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Diggsey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Diggsey/subscriptions",
      "organizations_url": "https://api.github.com/users/Diggsey/orgs",
      "repos_url": "https://api.github.com/users/Diggsey/repos",
      "events_url": "https://api.github.com/users/Diggsey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Diggsey/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T18:03:00Z",
    "updated_at": "2016-02-19T18:03:00Z",
    "body": "@alexcrichton Hmm, I would prefer `remove_file` and `remove_dir` to try to give the same guarantees they have on linux if possible. Specifically that if they succeed, the file or directory should be completely gone.\n\nIt's inevitable that people will build their own abstractions over the top of these primitive operations, and I'd very much like to avoid these kind of bugs where it's sufficiently rare that it's almost impossible to track down the true cause of the problem.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186333905/reactions",
      "total_count": 4,
      "+1": 4,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186341678",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186341678",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186341678,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjM0MTY3OA==",
    "user": {
      "login": "retep998",
      "id": 666308,
      "node_id": "MDQ6VXNlcjY2NjMwOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/666308?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/retep998",
      "html_url": "https://github.com/retep998",
      "followers_url": "https://api.github.com/users/retep998/followers",
      "following_url": "https://api.github.com/users/retep998/following{/other_user}",
      "gists_url": "https://api.github.com/users/retep998/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/retep998/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/retep998/subscriptions",
      "organizations_url": "https://api.github.com/users/retep998/orgs",
      "repos_url": "https://api.github.com/users/retep998/repos",
      "events_url": "https://api.github.com/users/retep998/events{/privacy}",
      "received_events_url": "https://api.github.com/users/retep998/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T18:14:13Z",
    "updated_at": "2016-02-19T18:14:13Z",
    "body": "> Specifically that if they succeed, the file or directory should be completely gone.\n\nThis wouldn't really work because files don't necessarily get deleted right away. You can't just move the file somewhere else and then delete it because there isn't always a reasonable place on the same volume to move the file to. Sitting around and indefinitely waiting for the file to vanish isn't ideal either. I'd personally just use `IFileOperation` for `remove_dir_all` and call it a day.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186341678/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186354493",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186354493",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186354493,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjM1NDQ5Mw==",
    "user": {
      "login": "Diggsey",
      "id": 451321,
      "node_id": "MDQ6VXNlcjQ1MTMyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/451321?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Diggsey",
      "html_url": "https://github.com/Diggsey",
      "followers_url": "https://api.github.com/users/Diggsey/followers",
      "following_url": "https://api.github.com/users/Diggsey/following{/other_user}",
      "gists_url": "https://api.github.com/users/Diggsey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Diggsey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Diggsey/subscriptions",
      "organizations_url": "https://api.github.com/users/Diggsey/orgs",
      "repos_url": "https://api.github.com/users/Diggsey/repos",
      "events_url": "https://api.github.com/users/Diggsey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Diggsey/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T18:36:38Z",
    "updated_at": "2016-02-19T18:36:38Z",
    "body": "What if the file is opened with `FILE_FLAG_DELETE_ON_CLOSE`, no share flags specified, and then is immediately closed? Successfully opening the file means that you have exclusive access, and so closing it should delete the file.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186354493/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186371190",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186371190",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186371190,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjM3MTE5MA==",
    "user": {
      "login": "retep998",
      "id": 666308,
      "node_id": "MDQ6VXNlcjY2NjMwOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/666308?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/retep998",
      "html_url": "https://github.com/retep998",
      "followers_url": "https://api.github.com/users/retep998/followers",
      "following_url": "https://api.github.com/users/retep998/following{/other_user}",
      "gists_url": "https://api.github.com/users/retep998/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/retep998/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/retep998/subscriptions",
      "organizations_url": "https://api.github.com/users/retep998/orgs",
      "repos_url": "https://api.github.com/users/retep998/repos",
      "events_url": "https://api.github.com/users/retep998/events{/privacy}",
      "received_events_url": "https://api.github.com/users/retep998/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T19:36:26Z",
    "updated_at": "2016-02-19T19:36:26Z",
    "body": "No share flags means nobody else can open it to read/write/delete it. However another handle can still be opened without read/write/delete permissions. Also what happens if you fail to open the file with no share flags? Does it error or fallback to the normal deletion method that provides no guarantees?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186371190/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186398877",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186398877",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186398877,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjM5ODg3Nw==",
    "user": {
      "login": "pitdicker",
      "id": 6255050,
      "node_id": "MDQ6VXNlcjYyNTUwNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6255050?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pitdicker",
      "html_url": "https://github.com/pitdicker",
      "followers_url": "https://api.github.com/users/pitdicker/followers",
      "following_url": "https://api.github.com/users/pitdicker/following{/other_user}",
      "gists_url": "https://api.github.com/users/pitdicker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pitdicker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pitdicker/subscriptions",
      "organizations_url": "https://api.github.com/users/pitdicker/orgs",
      "repos_url": "https://api.github.com/users/pitdicker/repos",
      "events_url": "https://api.github.com/users/pitdicker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pitdicker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-19T20:47:27Z",
    "updated_at": "2016-02-19T20:47:27Z",
    "body": "Great to see so many comments. Just what I hoped for!\n\n@alexcrichton I completely agree to keep `remove_file` and `remove_dir` simple, and only let `remove_dir_all` do magic. Actually removing read-only files is pretty difficult when you also don't want to break hard links. http://stackoverflow.com/questions/3055668/delete-link-to-file-without-clearing-readonly-bit is an example, but I am sure I found some better way somewhere.\n\n@Diggsey I would also like cross-platform consistency, but sometimes Windows is just to different... I think the standard library should at least expose primitives that only need one system call. Otherwise we lose performance and maybe get more vulnerable to race conditions. Maybe we can add a `remove_no_matter_what` in the future :)\n\n@retep998 I have not yet written the code, so I don't know if this will really solve the problem... But if this doesn't work out I am all for `IFileOperation`. Meanwhile it is a nice way for me and maybe the standard library to get better at avoiding filesystem races.\n\nI would have to test what happens with `FILE_FLAG_DELETE_ON_CLOSE`, but in theory if the file opens successfully we only have to move it to avoid a race of a couple of milliseconds. Directly after opening the file no one else can open the file anymore (it is not a share flag).\n\nWhat is difficult is where to move a file / dir to. I think the parent of the dir we are removing is good enough. It should be on the same volume, and I think we also have write permission to it because otherwise deleting a dir is not possible (wild speculation here, it is late :))\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186398877/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186471145",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-186471145",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 186471145,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NjQ3MTE0NQ==",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-20T00:54:55Z",
    "updated_at": "2016-02-20T00:54:55Z",
    "body": "I feel ok about going to extra effort to make `remove_dir_all` work as expected.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/186471145/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187315526",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-187315526",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 187315526,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NzMxNTUyNg==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-22T18:50:54Z",
    "updated_at": "2016-02-22T18:50:54Z",
    "body": "@pitdicker perhaps you could draw up a list of the possible implementation strategies for these functions? That'd also help in terms of weighing the pros/cons of each strategy and we could get a good idea of which terminology is associated with what. So far it sounds like `IFileOperation` may be the best option here, but I'm personally at least not following what `FILE_FLAG_DELETE_ON_CLOSE` would mean, especially in the case that you can't open it as someone else does.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187315526/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187353954",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-187353954",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 187353954,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NzM1Mzk1NA==",
    "user": {
      "login": "pitdicker",
      "id": 6255050,
      "node_id": "MDQ6VXNlcjYyNTUwNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6255050?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pitdicker",
      "html_url": "https://github.com/pitdicker",
      "followers_url": "https://api.github.com/users/pitdicker/followers",
      "following_url": "https://api.github.com/users/pitdicker/following{/other_user}",
      "gists_url": "https://api.github.com/users/pitdicker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pitdicker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pitdicker/subscriptions",
      "organizations_url": "https://api.github.com/users/pitdicker/orgs",
      "repos_url": "https://api.github.com/users/pitdicker/repos",
      "events_url": "https://api.github.com/users/pitdicker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pitdicker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-22T19:56:09Z",
    "updated_at": "2016-02-22T19:56:09Z",
    "body": "To be fair `IFileOperation` is a bit to diffcult for me to implement. It should \"just work\" when removing directories. But as far is I can see it is an entirally different kind of API. For example it does not work on handles but `IShellItem`s, and is mostly made for gui applications.\n\nThe steps I proposed are more ugly. They use the same simpler but more low-level APIs as the rest of the standard library. But there is a little window where files may temporarily show up in the parent directory of the one we removed. But these files would otherwise be the ones that cause `remove_dir_all` to fail currently, which is not all that often.\n\nOn Windows deleting a file is not guaranteed to be complete before the function returns. Instead a file is scheduled for deletion, when no one else has it open anymore. When Unix on the other hand deletes the file, it looks really deleted. But deletion of the inode is scheduled until everyone is done with it.\n\n`FILE_FLAG_DELETE_ON_CLOSE` is a flag we can set when opening a file, together with `DELETE` permission as access mode. It will schedule the file (or directory) for deletion. When the flag is set (i.e. as soon as open succeeds), it is not possible for others to open the file anymore. The only question is what happens if others already have the file open. If they did not have the file open with `FILE_SHARE_DELETE` we should fail to open it (as we do not have `DELETE` permission).\n\nUsing this flag should be identical to using `DeleteFile`. The only reason I want to use it, is that it keeps a hanle open. And with this handle the file can be moved to a temporary location to not block removing the parent dir.\n\nBut I am not sure of anything yet. Somehow I just can't get it to work the renaming part yet, so all this is theory, not tested :(.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187353954/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187420129",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-187420129",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 187420129,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NzQyMDEyOQ==",
    "user": {
      "login": "Diggsey",
      "id": 451321,
      "node_id": "MDQ6VXNlcjQ1MTMyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/451321?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Diggsey",
      "html_url": "https://github.com/Diggsey",
      "followers_url": "https://api.github.com/users/Diggsey/followers",
      "following_url": "https://api.github.com/users/Diggsey/following{/other_user}",
      "gists_url": "https://api.github.com/users/Diggsey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Diggsey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Diggsey/subscriptions",
      "organizations_url": "https://api.github.com/users/Diggsey/orgs",
      "repos_url": "https://api.github.com/users/Diggsey/repos",
      "events_url": "https://api.github.com/users/Diggsey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Diggsey/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-22T22:37:59Z",
    "updated_at": "2016-02-22T22:37:59Z",
    "body": "Having looked at the IFileOperation, I agree with @pitdicker that it doesn't seem like the right kind of API for low-level filesystem operations: it's very much oriented towards interactive use. (The .net framework doesn't use it either, but then `Directory.Delete` suffers from the exact same problem!)\n\nI'm starting to think that maybe just using the current implementation and retrying on failure is the best option. http://stackoverflow.com/a/1703799 (The second code example has the advantage that it only retries more than once if some progress is made, and retries more often, for more deeply nested directories)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187420129/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/188922454",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-188922454",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 188922454,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4ODkyMjQ1NA==",
    "user": {
      "login": "pitdicker",
      "id": 6255050,
      "node_id": "MDQ6VXNlcjYyNTUwNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6255050?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pitdicker",
      "html_url": "https://github.com/pitdicker",
      "followers_url": "https://api.github.com/users/pitdicker/followers",
      "following_url": "https://api.github.com/users/pitdicker/following{/other_user}",
      "gists_url": "https://api.github.com/users/pitdicker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pitdicker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pitdicker/subscriptions",
      "organizations_url": "https://api.github.com/users/pitdicker/orgs",
      "repos_url": "https://api.github.com/users/pitdicker/repos",
      "events_url": "https://api.github.com/users/pitdicker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pitdicker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-25T18:38:55Z",
    "updated_at": "2016-02-25T18:38:55Z",
    "body": "YES! I've got the manual method working.\n\nNow to clean up my messy code, and do a lot of testing...\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/188922454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/188950423",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-188950423",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 188950423,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4ODk1MDQyMw==",
    "user": {
      "login": "pitdicker",
      "id": 6255050,
      "node_id": "MDQ6VXNlcjYyNTUwNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6255050?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pitdicker",
      "html_url": "https://github.com/pitdicker",
      "followers_url": "https://api.github.com/users/pitdicker/followers",
      "following_url": "https://api.github.com/users/pitdicker/following{/other_user}",
      "gists_url": "https://api.github.com/users/pitdicker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pitdicker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pitdicker/subscriptions",
      "organizations_url": "https://api.github.com/users/pitdicker/orgs",
      "repos_url": "https://api.github.com/users/pitdicker/repos",
      "events_url": "https://api.github.com/users/pitdicker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pitdicker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-25T19:51:13Z",
    "updated_at": "2016-02-25T19:51:13Z",
    "body": "@Diggsey Thanks for looking up how .NET handles this!\n\nAnd I like the simplicity of just retrying on failure. But I don't like that it needs a little luck. So I prefer moving files the instant before they are deleted.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/188950423/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/260755122",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-260755122",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 260755122,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2MDc1NTEyMg==",
    "user": {
      "login": "timvisee",
      "id": 856222,
      "node_id": "MDQ6VXNlcjg1NjIyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856222?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/timvisee",
      "html_url": "https://github.com/timvisee",
      "followers_url": "https://api.github.com/users/timvisee/followers",
      "following_url": "https://api.github.com/users/timvisee/following{/other_user}",
      "gists_url": "https://api.github.com/users/timvisee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/timvisee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/timvisee/subscriptions",
      "organizations_url": "https://api.github.com/users/timvisee/orgs",
      "repos_url": "https://api.github.com/users/timvisee/repos",
      "events_url": "https://api.github.com/users/timvisee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/timvisee/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-11-15T20:17:49Z",
    "updated_at": "2016-11-15T20:19:49Z",
    "body": "Has a fix already been applied to `std`, or do we have a _working_ fix available yet? I'm currently bumping into the same issue on Windows, and this issue seems to be open for quite a while. Sadly, the problem seems to be quite inconsistent on my machine.\n\nAlso, I don't think that retrying to delete a file a few times sound like a good solution to put into `std`.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/260755122/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/317203756",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-317203756",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 317203756,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNzIwMzc1Ng==",
    "user": {
      "login": "orvly",
      "id": 28487245,
      "node_id": "MDQ6VXNlcjI4NDg3MjQ1",
      "avatar_url": "https://avatars.githubusercontent.com/u/28487245?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/orvly",
      "html_url": "https://github.com/orvly",
      "followers_url": "https://api.github.com/users/orvly/followers",
      "following_url": "https://api.github.com/users/orvly/following{/other_user}",
      "gists_url": "https://api.github.com/users/orvly/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/orvly/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/orvly/subscriptions",
      "organizations_url": "https://api.github.com/users/orvly/orgs",
      "repos_url": "https://api.github.com/users/orvly/repos",
      "events_url": "https://api.github.com/users/orvly/events{/privacy}",
      "received_events_url": "https://api.github.com/users/orvly/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-07-22T19:03:34Z",
    "updated_at": "2017-07-22T19:03:34Z",
    "body": "I just ran into a related problem myself, where after calling remove_dir_all on a directory which had just a single empty sub-directory, it completed successfully, but then trying to re-create this directory hierarchy immediately failed with Access Denied.  \r\n(I imagine this should be a rather common scenario with testing code which relies on the filesystem, first cleaning up any artifacts from the previous run and then re-creating them).\r\n\r\nThe problem is basically not just with remove_dir_all, but with any attempt to delete a directory - it might not be executed immediately, so any action done right after it, which assumes it doesn't exist, might fail.\r\n\r\nBut after going to the issue referenced right above this comment ([995 in rustup](https://github.com/rust-lang-nursery/rustup.rs/issues/995)) I found out about this new \"remove_dir_all\" crate from @aaronepower (hosting just this single function), which uses a trick - it moves the directory first, then deletes the moved directory (as [documented extensively there](https://github.com/Aaronepower/remove_dir_all/blob/master/src/fs.rs#L30)).  \r\nThat solved my problem as well as the more general problem of deleting a directory on Windows.\r\n[remove_dir_all crate](https://docs.rs/remove_dir_all/0.2.0/remove_dir_all/)\r\n\r\nCould its implementation replace the one in std::fs?",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/317203756/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/470619292",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-470619292",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 470619292,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3MDYxOTI5Mg==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-03-07T17:29:28Z",
    "updated_at": "2019-03-07T17:29:28Z",
    "body": "Triage: I'm not aware of any movement on this issue.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/470619292/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/475875708",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-475875708",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 475875708,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3NTg3NTcwOA==",
    "user": {
      "login": "hntd187",
      "id": 6778339,
      "node_id": "MDQ6VXNlcjY3NzgzMzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6778339?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hntd187",
      "html_url": "https://github.com/hntd187",
      "followers_url": "https://api.github.com/users/hntd187/followers",
      "following_url": "https://api.github.com/users/hntd187/following{/other_user}",
      "gists_url": "https://api.github.com/users/hntd187/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hntd187/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hntd187/subscriptions",
      "organizations_url": "https://api.github.com/users/hntd187/orgs",
      "repos_url": "https://api.github.com/users/hntd187/repos",
      "events_url": "https://api.github.com/users/hntd187/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hntd187/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-03-23T14:46:42Z",
    "updated_at": "2019-03-23T14:46:42Z",
    "body": "I can confirm this still happens @steveklabnik \r\n```\r\nError: Os { code: 145, kind: Other, message: \"The directory is not empty.\" }\r\n```\r\n\r\nJust a folder with some plain text json files in it. Also, not a large directory or have any nested structure.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/475875708/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/573353391",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-573353391",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 573353391,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MzM1MzM5MQ==",
    "user": {
      "login": "XAMPPRocky",
      "id": 4464295,
      "node_id": "MDQ6VXNlcjQ0NjQyOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4464295?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/XAMPPRocky",
      "html_url": "https://github.com/XAMPPRocky",
      "followers_url": "https://api.github.com/users/XAMPPRocky/followers",
      "following_url": "https://api.github.com/users/XAMPPRocky/following{/other_user}",
      "gists_url": "https://api.github.com/users/XAMPPRocky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/XAMPPRocky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/XAMPPRocky/subscriptions",
      "organizations_url": "https://api.github.com/users/XAMPPRocky/orgs",
      "repos_url": "https://api.github.com/users/XAMPPRocky/repos",
      "events_url": "https://api.github.com/users/XAMPPRocky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/XAMPPRocky/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-01-11T20:51:44Z",
    "updated_at": "2020-01-12T09:26:39Z",
    "body": "Hey, so there is a solution to this. Someone needs to merge the [`remove_dir_all`](https://github.com/XAMPPRocky/remove_dir_all) code into the standard library. This is a crate that created as a quick workaround for crates from an implementation from #31944 that never got merged. It's been pretty stable over the past few years, and is used in cargo and rustup.\r\n\r\nSince creating the crate, I no longer have a Windows machine. As a result I do not intend to maintain the crate. It would be great if someone could port the code into std so that everyone can have a reliable implementation on windows. :)",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/573353391/reactions",
      "total_count": 10,
      "+1": 10,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/580319473",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-580319473",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 580319473,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4MDMxOTQ3Mw==",
    "user": {
      "login": "ehuss",
      "id": 43198,
      "node_id": "MDQ6VXNlcjQzMTk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ehuss",
      "html_url": "https://github.com/ehuss",
      "followers_url": "https://api.github.com/users/ehuss/followers",
      "following_url": "https://api.github.com/users/ehuss/following{/other_user}",
      "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions",
      "organizations_url": "https://api.github.com/users/ehuss/orgs",
      "repos_url": "https://api.github.com/users/ehuss/repos",
      "events_url": "https://api.github.com/users/ehuss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ehuss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-01-30T15:55:10Z",
    "updated_at": "2020-01-30T15:55:10Z",
    "body": "I would not consider the current `remove_dir_all` crate as a *complete* solution to this.  It is better, but it still frequently fails in some situations.  See rust-lang/cargo#7042 as an example where clearing Cargo's test suite doesn't succeed.  See that PR for a link to cygwin's implementation which always works for me, and some commentary from a former cygwin developer.\r\n\r\nI'm not opposed to merging it, just saying it isn't a complete fix.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/580319473/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/661688642",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-661688642",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 661688642,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2MTY4ODY0Mg==",
    "user": {
      "login": "programmerjake",
      "id": 4584340,
      "node_id": "MDQ6VXNlcjQ1ODQzNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4584340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/programmerjake",
      "html_url": "https://github.com/programmerjake",
      "followers_url": "https://api.github.com/users/programmerjake/followers",
      "following_url": "https://api.github.com/users/programmerjake/following{/other_user}",
      "gists_url": "https://api.github.com/users/programmerjake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/programmerjake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/programmerjake/subscriptions",
      "organizations_url": "https://api.github.com/users/programmerjake/orgs",
      "repos_url": "https://api.github.com/users/programmerjake/repos",
      "events_url": "https://api.github.com/users/programmerjake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/programmerjake/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-07-21T07:34:13Z",
    "updated_at": "2020-07-21T07:34:13Z",
    "body": "Some potentially useful reference code: [Wine's implementation of `SHFileOperation`](https://github.com/wine-mirror/wine/blob/master/dlls/shell32/shlfileop.c)",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/661688642/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/835821898",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-835821898",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 835821898,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNTgyMTg5OA==",
    "user": {
      "login": "ChrisDenton",
      "id": 4459874,
      "node_id": "MDQ6VXNlcjQ0NTk4NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ChrisDenton",
      "html_url": "https://github.com/ChrisDenton",
      "followers_url": "https://api.github.com/users/ChrisDenton/followers",
      "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions",
      "organizations_url": "https://api.github.com/users/ChrisDenton/orgs",
      "repos_url": "https://api.github.com/users/ChrisDenton/repos",
      "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ChrisDenton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-09T14:51:26Z",
    "updated_at": "2021-05-09T15:25:42Z",
    "body": "I think there are (at least) three issues here:\r\n\r\n1. The main issue is that a file can be pending deletion for awhile, which prevents deleting its parent directory. This should already be fixed by recent versions of Windows but a solution that works for older versions would be welcome.\r\n2. If a process is still running then its `.exe` file cannot be deleted. I've seen this cause issues where a build system tries to cleanup `exe` files and fails. More generally, a file could be held open without the  \"FILE_SHARE_DELETE\" share mode (which means there's a file lock preventing deletion attempts until after the file handle is closed).\r\n3. People thinking the DOS `FILE_ATTRIBUTE_READONLY` is the same as the POSIX `read` permission. This is especially an issue with applications ported from Linux. This ship has sailed at this point so maybe we should just force delete `readonly` files.\r\n\r\nI think the first can be mitigated slightly by ignoring any `ERROR_DIR_NOT_EMPTY` messages at first, then recursively deleting any left over directories afterwards. Maybe in a retry loop that again skips `ERROR_DIR_NOT_EMPTY` until the final attempt.\r\n\r\nI'm uncertain if the second can be sensibly solved by Rust's std. At least not with the current API. It's just a matter of waiting. For example, the process may need to finish running and then the `.exe` file handle has to be closed. This could take any amount of time. I guess we could retry a few times before giving up?\r\n\r\nThe third can be solved by either unsetting readonly attributes or using the `FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE` flag (on OS versions that support it).",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/835821898/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/835849686",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-835849686",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 835849686,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNTg0OTY4Ng==",
    "user": {
      "login": "XAMPPRocky",
      "id": 4464295,
      "node_id": "MDQ6VXNlcjQ0NjQyOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4464295?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/XAMPPRocky",
      "html_url": "https://github.com/XAMPPRocky",
      "followers_url": "https://api.github.com/users/XAMPPRocky/followers",
      "following_url": "https://api.github.com/users/XAMPPRocky/following{/other_user}",
      "gists_url": "https://api.github.com/users/XAMPPRocky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/XAMPPRocky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/XAMPPRocky/subscriptions",
      "organizations_url": "https://api.github.com/users/XAMPPRocky/orgs",
      "repos_url": "https://api.github.com/users/XAMPPRocky/repos",
      "events_url": "https://api.github.com/users/XAMPPRocky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/XAMPPRocky/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-09T17:33:55Z",
    "updated_at": "2021-05-09T17:33:55Z",
    "body": "> I'm uncertain if the second can be sensibly solved by Rust's std. At least not with the current API. It's just a matter of waiting. For example, the process may need to finish running and then the .exe file handle has to be closed. This could take any amount of time. I guess we could retry a few times before giving up?\r\n\r\nJust my opinion, but retrying seems fine to me, this is already what some APIs do, such as symlinking in std on Windows, if it receives a certain error from Windows it just tries again with some other flags. The same could work here. I think the main thing to be aware of with retrying though is for it to still feel responsive and design it so that someone can't cause a denial-of-service attack by getting this API to repeatedly try to delete a running exe (such as itself).\r\n\r\nI think you'd want something like having just a single timeout for a fixed amount of time, only trigger timeout countdown if we've failed, and to return `ErrorKind::TimedOut` or similar if it failed.\r\n\r\nYou could maybe also probably be smarter about it and do something like collect all entries that fail, and try them a second time after you've deleted everything else, so that it's more likely that the OS has had enough time to finish up whatever it was doing.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/835849686/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1018706777",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1018706777",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1018706777,
    "node_id": "IC_kwDOAAsO6M48uDtZ",
    "user": {
      "login": "pwinckles",
      "id": 1196698,
      "node_id": "MDQ6VXNlcjExOTY2OTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1196698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pwinckles",
      "html_url": "https://github.com/pwinckles",
      "followers_url": "https://api.github.com/users/pwinckles/followers",
      "following_url": "https://api.github.com/users/pwinckles/following{/other_user}",
      "gists_url": "https://api.github.com/users/pwinckles/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pwinckles/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pwinckles/subscriptions",
      "organizations_url": "https://api.github.com/users/pwinckles/orgs",
      "repos_url": "https://api.github.com/users/pwinckles/repos",
      "events_url": "https://api.github.com/users/pwinckles/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pwinckles/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-21T17:17:36Z",
    "updated_at": "2022-01-21T17:17:58Z",
    "body": "It looks like [one of the commits](https://github.com/rust-lang/rust/commit/5ab67bff1e2230217ce133165605f8dc0d588178#diff-b2fbfcd333118e155032ff4276423d90c9fb43d97f9d4d7fe7965de5bddb3f62) that addressed the `remove_dir_all` security vulnerability may have also resolved this issue, new retry logic starting on line 1010. I haven't had a chance to test it out on a Windows system yet.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1018706777/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1083494489",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1083494489",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1083494489,
    "node_id": "IC_kwDOAAsO6M5AlNBZ",
    "user": {
      "login": "rbtcollins",
      "id": 499678,
      "node_id": "MDQ6VXNlcjQ5OTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/499678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rbtcollins",
      "html_url": "https://github.com/rbtcollins",
      "followers_url": "https://api.github.com/users/rbtcollins/followers",
      "following_url": "https://api.github.com/users/rbtcollins/following{/other_user}",
      "gists_url": "https://api.github.com/users/rbtcollins/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rbtcollins/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rbtcollins/subscriptions",
      "organizations_url": "https://api.github.com/users/rbtcollins/orgs",
      "repos_url": "https://api.github.com/users/rbtcollins/repos",
      "events_url": "https://api.github.com/users/rbtcollins/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rbtcollins/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-03-30T18:45:38Z",
    "updated_at": "2022-03-30T18:45:38Z",
    "body": "@ChrisDenton Looks like `FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE` is only available for [ZwSetInformationFile](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwsetinformationfile) - Cygwin uses the underlying NT calls, but I had the impression rust is trying to avoid getting that low level.\r\n\r\n@pwinckles The loop there may reduce the incidence, but as it is reentering into the entire thing its going to repeat IO for the depth of the point where the error occurred, though it will at least bail out fast.  I wouldn't want to use that version on rustups deletion of docs trees, for instance; though I am still interested in getting a reliable version into the core.  ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1083494489/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1083509890",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1083509890",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1083509890,
    "node_id": "IC_kwDOAAsO6M5AlQyC",
    "user": {
      "login": "ChrisDenton",
      "id": 4459874,
      "node_id": "MDQ6VXNlcjQ0NTk4NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ChrisDenton",
      "html_url": "https://github.com/ChrisDenton",
      "followers_url": "https://api.github.com/users/ChrisDenton/followers",
      "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions",
      "organizations_url": "https://api.github.com/users/ChrisDenton/orgs",
      "repos_url": "https://api.github.com/users/ChrisDenton/repos",
      "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ChrisDenton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-03-30T18:59:49Z",
    "updated_at": "2022-03-30T18:59:49Z",
    "body": "@rbtcollins `FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE` is in the standard headers (WinBase.h) and is also in the [windows-rs crate](https://microsoft.github.io/windows-docs-rs/doc/windows/Win32/System/WindowsProgramming/constant.FILE_DISPOSITION_FLAG_IGNORE_READONLY_ATTRIBUTE.html).\r\n\r\nBtw, the code currently in the standard library was written with some amount of haste so isn't necessarily the best example. I do plan to get back to it but lately I've been distracted with other issues.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1083509890/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1083633887",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1083633887",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1083633887,
    "node_id": "IC_kwDOAAsO6M5AlvDf",
    "user": {
      "login": "rbtcollins",
      "id": 499678,
      "node_id": "MDQ6VXNlcjQ5OTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/499678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rbtcollins",
      "html_url": "https://github.com/rbtcollins",
      "followers_url": "https://api.github.com/users/rbtcollins/followers",
      "following_url": "https://api.github.com/users/rbtcollins/following{/other_user}",
      "gists_url": "https://api.github.com/users/rbtcollins/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rbtcollins/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rbtcollins/subscriptions",
      "organizations_url": "https://api.github.com/users/rbtcollins/orgs",
      "repos_url": "https://api.github.com/users/rbtcollins/repos",
      "events_url": "https://api.github.com/users/rbtcollins/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rbtcollins/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-03-30T21:17:25Z",
    "updated_at": "2022-03-30T21:17:25Z",
    "body": "@ChrisDenton thats super interesting - and not visible on the MSDN doc pages :/ \r\n\r\nI meant no negativity about the current code - it is great the CVE was solved, and there time mattered a lot... and this bug is really (to my mind) about figuring out what is sensible for the stdlib - tradeoffs between complexity, generality, least surprise etc abound.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1083633887/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1084356016",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1084356016",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1084356016,
    "node_id": "IC_kwDOAAsO6M5AofWw",
    "user": {
      "login": "ChrisDenton",
      "id": 4459874,
      "node_id": "MDQ6VXNlcjQ0NTk4NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ChrisDenton",
      "html_url": "https://github.com/ChrisDenton",
      "followers_url": "https://api.github.com/users/ChrisDenton/followers",
      "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions",
      "organizations_url": "https://api.github.com/users/ChrisDenton/orgs",
      "repos_url": "https://api.github.com/users/ChrisDenton/repos",
      "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ChrisDenton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-03-31T10:00:02Z",
    "updated_at": "2022-03-31T10:00:02Z",
    "body": "> @ChrisDenton thats super interesting - and not visible on the MSDN doc pages :/\r\n\r\nThe newer information classes [are listed](https://docs.microsoft.com/en-us/windows/win32/api/minwinbase/ne-minwinbase-file_info_by_handle_class#constants) (e.g. `FileDispositionInfoEx` and `FileRenameInfoEx`) but there are not yet platform version information or dedicated pages listing the constants as there are with the others. It probably just needs someone to put in the work of writing the docs (which tbh is rarely the most popular task). In any case being in public headers and used by MSVC STL is quite a vote of confidence that it isn't going away.\r\n\r\n> I meant no negativity about the current code - it is great the CVE was solved, and there time mattered a lot... and this bug is really (to my mind) about figuring out what is sensible for the stdlib - tradeoffs between complexity, generality, least surprise etc abound.\r\n\r\nSorry! I didn't take what you said as negativity. I was meaning that more as a warning that, while I'm happy it fixes the CVE, I would still like to see the code cleaned up and improved.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1084356016/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1398875599",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1398875599",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1398875599,
    "node_id": "IC_kwDOAAsO6M5TYSXP",
    "user": {
      "login": "rbtcollins",
      "id": 499678,
      "node_id": "MDQ6VXNlcjQ5OTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/499678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rbtcollins",
      "html_url": "https://github.com/rbtcollins",
      "followers_url": "https://api.github.com/users/rbtcollins/followers",
      "following_url": "https://api.github.com/users/rbtcollins/following{/other_user}",
      "gists_url": "https://api.github.com/users/rbtcollins/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rbtcollins/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rbtcollins/subscriptions",
      "organizations_url": "https://api.github.com/users/rbtcollins/orgs",
      "repos_url": "https://api.github.com/users/rbtcollins/repos",
      "events_url": "https://api.github.com/users/rbtcollins/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rbtcollins/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2023-01-20T20:08:30Z",
    "updated_at": "2023-01-20T20:08:30Z",
    "body": "@ChrisDenton so FileDispositionInfoEx notes that deleting a file with posix semantics - \" When FILE_DISPOSITION_POSIX_SEMANTICS is set, the link is removed from the visible namespace as soon as the POSIX delete handle has been closed, but the file's data streams remain accessible by\" - does this mean that the directory delete will recieve ERROR_DIR_NOT_EMPTY while those processes with handles open continue to consume the file? Or is it genuinely unlinked from the directory and thus the directory is deletable?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1398875599/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1398916925",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1398916925",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1398916925,
    "node_id": "IC_kwDOAAsO6M5TYcc9",
    "user": {
      "login": "ChrisDenton",
      "id": 4459874,
      "node_id": "MDQ6VXNlcjQ0NTk4NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ChrisDenton",
      "html_url": "https://github.com/ChrisDenton",
      "followers_url": "https://api.github.com/users/ChrisDenton/followers",
      "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions",
      "organizations_url": "https://api.github.com/users/ChrisDenton/orgs",
      "repos_url": "https://api.github.com/users/ChrisDenton/repos",
      "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ChrisDenton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2023-01-20T20:48:25Z",
    "updated_at": "2023-01-20T20:48:25Z",
    "body": "@rbtcollins The `HANDLE` that sets the disposition must be closed for it to take full effect. On setting `FILE_DISPOSITION_POSIX_SEMANTICS`, but before closing, the file is locked such that the file can no longer be opened. However, it still remains in the directory and so attempting to delete the directory will produce `ERROR_DIR_NOT_EMPTY`. So essentially setting the disposition should be immediately followed by a close.\r\n\r\nOther file handles to the same file can remain open. They have no effect at all on the POSIX delete (unless of course they lock the file).",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1398916925/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1399298041",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1399298041",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1399298041,
    "node_id": "IC_kwDOAAsO6M5TZ5f5",
    "user": {
      "login": "rbtcollins",
      "id": 499678,
      "node_id": "MDQ6VXNlcjQ5OTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/499678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rbtcollins",
      "html_url": "https://github.com/rbtcollins",
      "followers_url": "https://api.github.com/users/rbtcollins/followers",
      "following_url": "https://api.github.com/users/rbtcollins/following{/other_user}",
      "gists_url": "https://api.github.com/users/rbtcollins/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rbtcollins/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rbtcollins/subscriptions",
      "organizations_url": "https://api.github.com/users/rbtcollins/orgs",
      "repos_url": "https://api.github.com/users/rbtcollins/repos",
      "events_url": "https://api.github.com/users/rbtcollins/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rbtcollins/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2023-01-21T17:47:47Z",
    "updated_at": "2023-01-21T17:47:47Z",
    "body": "Thank you @ChrisDenton . \r\n\r\nI'm having a little trouble figuring out the version support for this comment of yours: `FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE flag (on OS versions that support it).` It looks like its definitely present in Windows 10.1809. Is there some easy lookup matrix for these things? In particular to figure out whether to use it conditionally, or just document that successful deletion of readonly trees would require that version ...",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1399298041/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1399308592",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-1399308592",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 1399308592,
    "node_id": "IC_kwDOAAsO6M5TZ8Ew",
    "user": {
      "login": "ChrisDenton",
      "id": 4459874,
      "node_id": "MDQ6VXNlcjQ0NTk4NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ChrisDenton",
      "html_url": "https://github.com/ChrisDenton",
      "followers_url": "https://api.github.com/users/ChrisDenton/followers",
      "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions",
      "organizations_url": "https://api.github.com/users/ChrisDenton/orgs",
      "repos_url": "https://api.github.com/users/ChrisDenton/repos",
      "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ChrisDenton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2023-01-21T18:41:10Z",
    "updated_at": "2023-01-21T18:41:52Z",
    "body": "The documentation is pretty limited atm so the best bet is the C/C++ headers which indeed indicate that it's available on 1809 and later (aka `_WIN32_WINNT_WIN10_RS5`).\r\n\r\nI'd suggest trying the `FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE` flag first, checking the error returned, and then progressively falling back if necessary. The std currently checks for any of `ERROR_NOT_SUPPORTED`, `ERROR_INVALID_FUNCTION` or `ERROR_INVALID_PARAMETER` and then falls back to non-posix delete. A more involved solution could fallback to dropping `FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE` first and if that works then remembering (in an atomic) that the ignore readonly attribute isn't supported on this OS.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1399308592/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2928013331",
    "html_url": "https://github.com/rust-lang/rust/issues/29497#issuecomment-2928013331",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29497",
    "id": 2928013331,
    "node_id": "IC_kwDOAAsO6M6uhfAT",
    "user": {
      "login": "Diggsey",
      "id": 451321,
      "node_id": "MDQ6VXNlcjQ1MTMyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/451321?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Diggsey",
      "html_url": "https://github.com/Diggsey",
      "followers_url": "https://api.github.com/users/Diggsey/followers",
      "following_url": "https://api.github.com/users/Diggsey/following{/other_user}",
      "gists_url": "https://api.github.com/users/Diggsey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Diggsey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Diggsey/subscriptions",
      "organizations_url": "https://api.github.com/users/Diggsey/orgs",
      "repos_url": "https://api.github.com/users/Diggsey/repos",
      "events_url": "https://api.github.com/users/Diggsey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Diggsey/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2025-06-01T22:23:11Z",
    "updated_at": "2025-06-01T22:23:11Z",
    "body": "The implementation today is much more robust than when I opened this issue - it now has retry logic at the file/folder level, and is a more sophisticated approach in general. I attempted to recreate the issue and didn't have any success.\n\nWhile I'm sure the issue can still occur, I believe that the remaining issues are caused by real locks on the files rather than simply a race condition in the deletion logic, and that the current Rust implementation is at least as good as the equivalent functionality in other languages.\n\nFor that reason I think it makes sense to consider this solved.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2928013331/reactions",
      "total_count": 5,
      "+1": 5,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
