{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/20244",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/20244/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/20244/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/20244/events",
  "html_url": "https://github.com/rust-lang/rust/pull/20244",
  "id": 52931197,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjY2MDI3NTY=",
  "number": 20244,
  "title": "typeck: boxed closures can't capture by value",
  "user": {
    "login": "japaric",
    "id": 5018213,
    "node_id": "MDQ6VXNlcjUwMTgyMTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/japaric",
    "html_url": "https://github.com/japaric",
    "followers_url": "https://api.github.com/users/japaric/followers",
    "following_url": "https://api.github.com/users/japaric/following{/other_user}",
    "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/japaric/subscriptions",
    "organizations_url": "https://api.github.com/users/japaric/orgs",
    "repos_url": "https://api.github.com/users/japaric/repos",
    "events_url": "https://api.github.com/users/japaric/events{/privacy}",
    "received_events_url": "https://api.github.com/users/japaric/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "nikomatsakis",
    "id": 155238,
    "node_id": "MDQ6VXNlcjE1NTIzOA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nikomatsakis",
    "html_url": "https://github.com/nikomatsakis",
    "followers_url": "https://api.github.com/users/nikomatsakis/followers",
    "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
    "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
    "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
    "repos_url": "https://api.github.com/users/nikomatsakis/repos",
    "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2014-12-26T16:45:37Z",
  "updated_at": "2015-01-04T13:06:28Z",
  "closed_at": "2014-12-27T18:31:51Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/20244",
    "html_url": "https://github.com/rust-lang/rust/pull/20244",
    "diff_url": "https://github.com/rust-lang/rust/pull/20244.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/20244.patch",
    "merged_at": "2014-12-27T18:31:51Z"
  },
  "body": "closes #19141\ncloses #20193\ncloses #20228\n\n---\n\nCurrently whenever we encounter `let f = || {/* */}`, we _always_ type check the RHS as a _boxed_ closure. This is wrong when the RHS is `move || {/* */}` (because boxed closures can't capture by value) and generates all sort of badness during trans (see issues above). What we _should_ do is always type check `move || {/* */}` as an _unboxed_ closure, but ~~I _think_ (haven't tried)~~ (2) this is not feasible right now because we have a limited form of kind (`Fn` vs `FnMut` vs `FnOnce`) inference that only works when there is an expected type (1).\n\nIn this PR, I've chosen to generate a type error whenever `let f = move || {/* */}` is encountered. The error asks the user to annotate the kind of the unboxed closure (e.g. `move |:| {/* */}`). Once annotated, the compiler will type check the RHS as an unboxed closure which is what the user wants.\n\nr? @nikomatsakis \n\n(1) AIUI it only triggers in this scenario:\n\n``` rust\nfn is_uc<F>(_: F) where F: FnOnce() {}\n\nfn main() {\n    is_uc(|| {});  // type checked as unboxed closure with kind `FnOnce`\n}\n```\n\n(2) I checked, and it's not possible because `check_unboxed_closure` expects a `kind` argument, but we can't supply that argument in this case (i.e. `let f = || {}`, what's the kind?). We could force the `FnOnce` kind in that case, but that's ad hoc. We should try to infer the kind depending on how the closure is used afterwards, but there is no inference mechanism to do that (at least, not right now).\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/20244/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/20244/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
