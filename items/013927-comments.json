[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43124986",
    "html_url": "https://github.com/rust-lang/rust/issues/13927#issuecomment-43124986",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13927",
    "id": 43124986,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzMTI0OTg2",
    "user": {
      "login": "zkamsler",
      "id": 944662,
      "node_id": "MDQ6VXNlcjk0NDY2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/944662?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zkamsler",
      "html_url": "https://github.com/zkamsler",
      "followers_url": "https://api.github.com/users/zkamsler/followers",
      "following_url": "https://api.github.com/users/zkamsler/following{/other_user}",
      "gists_url": "https://api.github.com/users/zkamsler/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zkamsler/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zkamsler/subscriptions",
      "organizations_url": "https://api.github.com/users/zkamsler/orgs",
      "repos_url": "https://api.github.com/users/zkamsler/repos",
      "events_url": "https://api.github.com/users/zkamsler/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zkamsler/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-14T19:18:22Z",
    "updated_at": "2014-05-14T19:18:22Z",
    "body": "That would be nice to have, although I can think of a few issues with such an approach:\n1. The `Option` may have lower alignment requirements than the integer of the same size (i.e. `{u8,u8}` is usually 1-byte aligned and `u16` is usually 2-byte aligned). That may cause issues on platforms that do not handle unaligned loads, but I don't know enough to know if `transmute` handles that.\n2. There may be padding between the discriminant and the value, which I assume could be uninitialized.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43124986/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43169058",
    "html_url": "https://github.com/rust-lang/rust/issues/13927#issuecomment-43169058",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13927",
    "id": 43169058,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzMTY5MDU4",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-15T05:07:34Z",
    "updated_at": "2014-05-15T05:07:34Z",
    "body": "> 1. The Option may have lower alignment requirements than the integer of the same size (i.e. {u8,u8} is usually 1-byte aligned and u16 is usually 2-byte aligned). That may cause issues on platforms that do not handle unaligned loads, but I don't know enough to know if transmute handles that.\n\nSeems like a possible problem, yeah.\n\n> 1. There may be padding between the discriminant and the value, which I assume could be uninitialized.\n\nOh, I thought I mentioned this (it's why I chose to use `Option<u8>` in the example). In any case, for `x: Option<u16>`, I'd guess `x == Some(2)` becoming\n\n``` rust\ntransmute::<_, u32>(x) & 0xff00_ffff == 0x0100_0002\n```\n\nmay be faster than two branches. (However, this is becoming complicated and hard to implement/get right.)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43169058/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49528616",
    "html_url": "https://github.com/rust-lang/rust/issues/13927#issuecomment-49528616",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13927",
    "id": 49528616,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NTI4NjE2",
    "user": {
      "login": "ghost",
      "id": 10137,
      "node_id": "MDQ6VXNlcjEwMTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ghost",
      "html_url": "https://github.com/ghost",
      "followers_url": "https://api.github.com/users/ghost/followers",
      "following_url": "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
      "organizations_url": "https://api.github.com/users/ghost/orgs",
      "repos_url": "https://api.github.com/users/ghost/repos",
      "events_url": "https://api.github.com/users/ghost/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ghost/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-19T20:17:59Z",
    "updated_at": "2014-07-19T20:17:59Z",
    "body": "@huonw This is what I'm getting on master today:\n\n``` llvm\ndefine zeroext i1 @_ZN3foo20h8f1b2f0c18884ca6daaE(%\"enum.core::option::Option<[u8]>[#3]\") unnamed_addr #0 {\nmatch_case5.i:\n  %.fca.0.extract7 = extractvalue %\"enum.core::option::Option<[u8]>[#3]\" %0, 0\n  %.fca.2.0.extract9 = extractvalue %\"enum.core::option::Option<[u8]>[#3]\" %0, 2, 0\n  %cond.i = icmp eq i8 %.fca.0.extract7, 1\n  %1 = icmp eq i8 %.fca.2.0.extract9, 2\n  %__make_return_pointer.0.i = and i1 %cond.i, %1\n  ret i1 %__make_return_pointer.0.i\n}\n```\n\nCan we close this?\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49528616/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49528660",
    "html_url": "https://github.com/rust-lang/rust/issues/13927#issuecomment-49528660",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13927",
    "id": 49528660,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NTI4NjYw",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-19T20:19:58Z",
    "updated_at": "2014-07-19T20:19:58Z",
    "body": "It's still doing more work than it should be. It's just optimizing the two checks into an `AND` now.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/49528660/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52429958",
    "html_url": "https://github.com/rust-lang/rust/issues/13927#issuecomment-52429958",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13927",
    "id": 52429958,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyNDI5OTU4",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-08-17T18:15:07Z",
    "updated_at": "2014-08-17T18:15:07Z",
    "body": "The thing here is that passing the option as a struct means that LLVM passes the fields individually. So the Option's discriminant and its value are in two different registers (on x86_64). I guess the concrete way things are passed at the asm level is unknown at the IR level. The argument could be on the stack (then the alignment problems would matter), in a single register or split into multiple registers. So it's unable to optimize this any further at this level.\n\nIt can do better if it gets a pointer and you tell it that the alignment is suitable:\n\n``` llvm\n; Function Attrs: nounwind readnone uwtable\ndefine zeroext i1 @_ZN3foo20h8ac12d4c0db8e3ccdaaE({ i8, i8 }*) unnamed_addr #0 {\nmatch_case5.i:\n  %p1 = getelementptr inbounds { i8, i8 }* %0, i64 0, i32 0\n  %p2 = getelementptr inbounds { i8, i8 }* %0, i64 0, i32 1\n  %v1 = load i8* %p1, align 2 ; Just for demonstration purposes, it's not actually aligned like that\n  %v2 = load i8* %p2\n  %cond.i = icmp eq i8 %v1, 1\n  %1 = icmp eq i8 %v2, 2\n  %sret_slot.0.i = and i1 %cond.i, %1\n  ret i1 %sret_slot.0.i\n}\n```\n\nbecomes\n\n``` llvm\n; Function Attrs: nounwind readnone uwtable\ndefine zeroext i1 @_ZN3foo20h8ac12d4c0db8e3ccdaaE({ i8, i8 }* nocapture readonly) unnamed_addr #0 {\nmatch_case5.i:\n  %1 = bitcast { i8, i8 }* %0 to i16*\n  %v1 = load i16* %1, align 2\n  %2 = icmp eq i16 %v1, 513\n  ret i1 %2\n}\n```\n\nThe later passes could maybe generate slightly better asm by first combining the values into a single register and then compare against that. Not sure if that much better than the current code though.\n\nImproving the handling of aggregate values as arguments in LLVM, so that the struct gets passed in a single register _might_ work, but I'm not really sure about that.\n\nWhat does work (of course ;-)) is adding a coercion to a primitive integer type.\n\n``` llvm\n; Function Attrs: noinline nounwind readnone uwtable\ndefine internal fastcc zeroext i1 @_ZN3foo20hc5c0400b49933fc9daaE(i16 %in) unnamed_addr #0 {\nmatch_case5.i:\n  %coerce = alloca i16\n  store i16 %in, i16* %coerce\n  %coerce.p = bitcast i16* %coerce to %\"enum.core::option::Option<[u8]>[#3]\"*\n  %0 = load %\"enum.core::option::Option<[u8]>[#3]\"* %coerce.p\n  %.fca.0.extract4 = extractvalue %\"enum.core::option::Option<[u8]>[#3]\" %0, 0\n  %.fca.2.0.extract6 = extractvalue %\"enum.core::option::Option<[u8]>[#3]\" %0, 2, 0\n  %cond.i = icmp eq i8 %.fca.0.extract4, 1\n  %1 = icmp eq i8 %.fca.2.0.extract6, 2\n  %sret_slot.0.i = and i1 %cond.i, %1\n  ret i1 %sret_slot.0.i\n}\n```\n\nbecomes\n\n``` llvm\n; Function Attrs: noinline nounwind readnone uwtable\ndefine internal fastcc zeroext i1 @_ZN3foo20hc5c0400b49933fc9daaE(i16 %in) unnamed_addr #0 {\nmatch_case5.i:\n  %0 = icmp eq i16 %in, 513\n  ret i1 %0\n}\n```\n\nSee also #16506 \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52429958/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52430852",
    "html_url": "https://github.com/rust-lang/rust/issues/13927#issuecomment-52430852",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13927",
    "id": 52430852,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyNDMwODUy",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-08-17T18:45:42Z",
    "updated_at": "2014-08-17T18:45:42Z",
    "body": "FWIW, the coercion approach also handles padding in a struct. `Option<u16>`  with that approach gives:\n\n``` llvm\ndefine internal fastcc zeroext i1 @_ZN3foo20hc5c0400b49933fc9daaE(i32 %in) unnamed_addr #0 {\nmatch_case5.i:\n  %0 = and i32 %in, -65281\n  %1 = icmp eq i32 %0, 131073\n  ret i1 %1\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/52430852/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/69487999",
    "html_url": "https://github.com/rust-lang/rust/issues/13927#issuecomment-69487999",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13927",
    "id": 69487999,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NDg3OTk5",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-11T09:07:31Z",
    "updated_at": "2015-01-11T09:07:31Z",
    "body": "Closed by #20755.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/69487999/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
