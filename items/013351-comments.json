[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39657849",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39657849",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39657849,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjU3ODQ5",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T03:56:12Z",
    "updated_at": "2014-04-06T03:56:12Z",
    "body": "Looking over this, I'm not entirely convinced how favorable this is over https://github.com/mozilla/rust/pull/13349. This patch seems to have more optimized orderings for the slow path (when initialization is performed), but the same performance on the fast path (bailing out early).\n\nThis has a lot of atomic orderings which may be correct (I'm still getting a grasp on them), but I'd rather err on the side of SeqCst wherever possible. I agree that the current \"fast path\" being an xadd and an xchg (atomic add and atomic store) is a little excessive.\n\nI think that #13349 is along the right path in terms of fast path optimizations, and I'm not sure how much the slow path optimizations will matter in the long run. I do agree that the fast/slow function split will provide a bit more perf, but see my above comments for why I think it may not be necessary quite yet.\n\nDoes that sound ok to you?\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39657849/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39657907",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39657907",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39657907,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjU3OTA3",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T04:00:18Z",
    "updated_at": "2014-04-06T04:00:18Z",
    "body": "@alexcrichton I think that, even with changing all the atomics to `SeqCst`, this PR is still preferable to #13349 because it's a little easier to actually understand the algorithm. I had to read the existing implementation very carefully to understand exactly what it was doing (what with swapping one count over to the other). Whereas this PR makes it more straightforward, just keeping a tri-state flag that is separate from the count.\n\nAs for the atomic orderings, I'm reasonably confident that what I have here is correct. Sequential consistency is not necessary for this algorithm, especially because the mutex involved already provides synchronization guarantees. The main guarantee we need to enforce is that the closure happens-before anything after the call to `doit()`, hence the acquires (and that the closure happens-before the updating of the state to the final value, hence the release).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39657907/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39668985",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39668985",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39668985,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjY4OTg1",
    "user": {
      "login": "bill-myers",
      "id": 4647491,
      "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bill-myers",
      "html_url": "https://github.com/bill-myers",
      "followers_url": "https://api.github.com/users/bill-myers/followers",
      "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
      "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
      "organizations_url": "https://api.github.com/users/bill-myers/orgs",
      "repos_url": "https://api.github.com/users/bill-myers/repos",
      "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bill-myers/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T13:55:26Z",
    "updated_at": "2014-04-06T14:26:43Z",
    "body": "EDIT: oops, on second read, the atomics no longer seem correct.\n\nIn particular, I think `if self.lock_cnt.fetch_add(-1, atomics::Relaxed) == 1 {` needs to be Release, because otherwise it can be moved before `drop(guard)`, and then another task can free the mutex before we unlock it.\n\nOther than this, they seem correct.\n\nI think there are two further optimizations possible.\n\nFirst, it should be possible to save a word of memory by combining state and lock_cnt.\n\nSecond, making the fastpath check a check for >= 0 instead of != 2 might save an instruction on RISC architectures with a zero register and no compare-with-immediate instruction.\n\nThis brings to a design where the high bit is set when we should run the fastpath, and the second highest bit is used to represent whether the work is being done, the third highest whether the lock has been freed, and the rest being the lock count.\n\nHence, this code (UNTESTED!):\n\n```\n    // remove lock_cnt from the struct\n\n    #[inline]\n    pub fn doit(&self, f: ||) {\n        // Implementation-wise, this would seem like a fairly trivial primitive.\n        // The stickler part is where our mutexes currently require an\n        // allocation, and usage of a `Once` shouldn't leak this allocation.\n        //\n        // This means that there must be a deterministic destroyer of the mutex\n        // contained within (because it's not needed after the initialization\n        // has run).\n        //\n        // The general algorithm here is we keep a state value that indicates whether\n        // we've finished the work. This lets us avoid the expensive atomic\n        // read-modify-writes and mutex if there's no need. If we haven't finished\n        // the work, then we use a second value to keep track of how many outstanding\n        // threads are trying to use the mutex. When the last thread releases the\n        // mutex it drops the lock count to a \"very negative\" value to indicate to\n        // other threads that the mutex is gone.\n\n        let state = self.state.load(atomics::Acquire);\n        if state >= 0 {\n            self.doit_slow(f)\n        }\n    }\n\n    #[inline(never)]\n    fn doit_slow(&self, f: ||) {\n        // If the count is negative, then someone else finished the job,\n        // otherwise we run the job and record how many people will try to grab\n        // this lock\n        let HIGH_BIT = (uint::MAX >> 1) + 1;\n        let DONE_BIT = HIGH_BIT as int;\n        let STARTED_BIT = (HIGH_BIT >> 1) as int;\n        let LOCK_DONE_BIT = (HIGH_BIT >> 2) as int;\n        let LOCK_MASK = (LOCK_DONE_BIT - 1) as int;\n\n        if (self.state.fetch_add(1, atomics::Acquire) & LOCK_DONE_BIT) != 0 {\n            // Make sure we never overflow.\n            self.state.store(DONE_BIT | STARTED_BIT | LOCK_DONE_BIT, atomics::Relaxed);\n            return\n        }\n\n        let guard = self.mutex.lock();\n        if (self.state.fetch_or(STARTED_BIT, atomics::Relaxed) & STARTED_BIT) == 0 {\n            // we're the first one here\n            f();\n            self.state.fetch_or(DONE_BIT, atomics::Release);\n        }\n        drop(guard);\n\n        // Last one out cleans up after everyone else, no leaks!\n        // here STARTED_BIT and DONE_BIT are always set\n        if (self.state.fetch_add(-1, atomics::Release) == (DONE_BIT | STARTED_BIT | 1) {\n            // we just decremented it to 0, now make sure we can drop it to int::MIN.\n            // If this fails, someone else just waltzed in and took the mutex\n            if self.state.compare_and_swap(DONE_BIT | STARTED_BIT, DONE_BIT | STARTED_BIT | LOCK_DONE_BIT, atomics::AcqRel) == (DONE_BIT | STARTED_BIT) {\n                // good, we really were the last ones out\n                unsafe { self.mutex.destroy() }\n            }\n        }\n    }\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39668985/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39678438",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39678438",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39678438,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njc4NDM4",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T19:49:44Z",
    "updated_at": "2014-04-06T19:51:13Z",
    "body": "@bill-myers Interesting. Thanks for looking at this. I haven't carefully read your implementation yet, but I'm not convinced combining `state` and `lock_cnt` is a good idea. It will save a word of memory, but it will mean that new callers of `doit()` will take longer to hit the fast path than they should. Normally a caller of `doit()` should hit the fast path as soon as the work is done, but by combining the two variables, it doesn't hit the fast path until the mutex has been dropped. This could theoretically lead to a case where successive threads always enter `doit()` before the previous thread has exited the mutex, leading to the slow path being used forever (or at least long after it should).\n\nOr as a more trivial example, a single thread calling `o.doit(f); o.doit(f);` should reasonably expect that the second call to `doit()` hits the fast path, because it knows the work has completed. That's true with my implementation, but with yours, a second thread hitting the slow path can cause this first thread to hit the slow path on its second call.\n\nThis may be fixable by moving the definition of `DONE_BIT` up and testing for it in `doit()` instead of testing `>= 0`, although I haven't satisfied myself yet about the correctness of this, but the downside here is that, since you're already talking about trying to save an instruction on RISC, doing a bit test in the fast path is presumably going to be slower than my current `!= 2`. And the use of Once variables should not be common enough that saving a single word makes any difference (especially because they can only be created as `static`s).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39678438/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39678520",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39678520",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39678520,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njc4NTIw",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T19:52:18Z",
    "updated_at": "2014-04-06T19:52:18Z",
    "body": "@bill-myers If you truly wanted to save memory, we could drop `Once` down to a single int with no mutex, and just spinlock when waiting. This is actually how libdispatch's `dispatch_once()` function works. But I'd rather not change the semantics of `doit()` in such a fashion.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39678520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39678647",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39678647",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39678647,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njc4NjQ3",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T19:55:55Z",
    "updated_at": "2014-04-06T19:55:55Z",
    "body": "@alexcrichton Looking at `sync::mutex`, it appears that the `Mutex` type has been fixed to handle green/native correctly, despite the comment in `sync::one` claiming it doesn't. Is that correct? (If so I should update the comment).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39678647/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39679023",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39679023",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39679023,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njc5MDIz",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T20:08:20Z",
    "updated_at": "2014-04-06T20:08:20Z",
    "body": "I've updated the `Relaxed` to `Release` as @bill-myers suggested. I don't believe this is actually necessary, because `pthread_mutex_unlock()` guarantees that it synchronizes memory (though it doesn't define the precise synchronization, I have to assume that means it's basically SeqCst), and similarly `mutex.green_unlock()` uses a `SeqCst` operation. However, for peace of mind, and for protection in case `green_unlock()` ever decides that it only needs to be a `Release`, I decided to go ahead and make the change.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39679023/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39681644",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39681644",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39681644,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjgxNjQ0",
    "user": {
      "login": "bill-myers",
      "id": 4647491,
      "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bill-myers",
      "html_url": "https://github.com/bill-myers",
      "followers_url": "https://api.github.com/users/bill-myers/followers",
      "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
      "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
      "organizations_url": "https://api.github.com/users/bill-myers/orgs",
      "repos_url": "https://api.github.com/users/bill-myers/repos",
      "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bill-myers/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T21:22:12Z",
    "updated_at": "2014-04-06T21:22:25Z",
    "body": "1. No, my implementation is equivalent to yours, except for the different data layout, so it will hit the fast path in the same cases (unless I screwed it up).\n   Note that `state >= 0` is equivalent to `(state & DONE_BIT) == 0` (since DONE_BIT is the sign bit) and thus equivalent to `state != 2` in your implementation.\n   I guess it should be documented. Also, I didn't change the comments, but indeed several are now wrong.\n2. No, a portable application that spins is generally broken. The idea is to save memory without changing the semantics in any way.\n3. Yes, Mutex handles to green/native correctly (or at least it tries to)\n4. In general, mutex lock is Acquire and mutex unlock is Release (since otherwise the mutex is equivalent to a no-op), and I made that comment assuming the Rust mutex does not provide additional guarantees.\n\nRegarding memory consumption, now that I think of it, what could be done to do even better is to put the Mutex into a global hash table using the address of the Once as a key (where the hash table is either lockless or protected by a global mutex), so that you can have a single-bit Once.\n\nThis has significant tradeoffs though (e.g. it allocates memory), and I think it would be best done in a separate pull request if at all and perhaps exposed as a separate struct.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39681644/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39683044",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39683044",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39683044,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjgzMDQ0",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T21:38:51Z",
    "updated_at": "2014-04-06T21:38:51Z",
    "body": "@bill-myers \n1. Ah hah, that escaped my notice. Although I still haven't spent the time to guarantee to myself that your implementation is indeed correct (as it's more complicated to reason about).\n2. The semantics of spinlock (re-using the state as the spinlock instead of keeping a separate value) vs mutex are the same, it only affects the scheduling of threads. If the once behavior is used for initializing some memory, a spinlock is likely to behave better on a multicore system. If it's used for, say, I/O then of course a mutex is better. And of course on a single-core system a mutex is better. In any case, I wasn't actually advocating we switch to a spinlock, I was just suggesting it as a way to save more memory since you seem to think that's important.\n3. I updated the doc comments in another commit.\n4. That's certainly what it needs to provide. My belief is it typically provides at least AcqRel, but as I said before, I'm ok with using Release instead of Relaxed in case the mutex does in fact only provide Release (and I already made the change).\n\nYou can't have a single-bit once. There's two bits of data here: whether we've started, and whether we've finished. So you'd need a two-bit once. And I suspect this approach would actually be worse from a memory perspective, because hash tables have their own overhead and programs are typically not going to have very many Once values. I expect the overhead from the hash table to be larger than the memory saved by taking the mutex out of the Once.\n\nIn any case, assuming your implementation is correct (and again I haven't taken the time to satisfy to myself that it is), I'm personally in favor of not going that far. Saving a single word of memory per Once at the cost of an implementation that is significantly harder to read does not seem to me like a good tradeoff. Even the most complex program is likely to have no more than few dozen Onces.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39683044/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39701177",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39701177",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39701177,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NzAxMTc3",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-07T07:04:03Z",
    "updated_at": "2014-04-07T07:04:03Z",
    "body": "Let's please not travel too far down the premature optimization path. @kballard, you said that a primary reason for this patch was simplifying the code, and conserving one word of space I believe does not simplify this at all. While a fun exercise, I would like to keep this code as readable as possible.\n\nAdditionally, I still do not understand why it is necessary to avoid `SeqCst` on the slow path (invoking the initialization, locking the mutex, etc.). I see this as optimization which is not necessary (seeing how it's the slow path), and difficult to reason about. If you choose to continue to not use `SeqCst` orderings, I expect a significant amount of commenting explaining why the atomic orderings are indeed correct (there are many in play, not just one or two).\n\nIf this patch is targeted at _simplification_ of the logic, then it should stick to that. If it is targeted at _speeding up_ the existing logic, then I don't think that this patch is quite necessary (it just needs a fast path on what exists now).\n\n> because it's a little easier to actually understand the algorithm\n\nI don't really consider this grounds for rewriting everything, per se. Concurrent code is _always_ tricky to understand no matter how you write it. For example, I don't necessarily agree that this is simpler than what it was before, it will take me time to verify this. I am fine with re-working things, but please understand that simply rewriting is not necessarily a simplification.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39701177/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39703129",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39703129",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39703129,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NzAzMTI5",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-07T07:39:13Z",
    "updated_at": "2014-04-07T07:39:13Z",
    "body": "> Additionally, I still do not understand why it is necessary to avoid SeqCst on the slow path\n\nI don't understand why we should use `SeqCst` when we don't need that strong a fence. The atomic memory orderings in this code are actually pretty simple to reason about. The only confusion was whether unlocking a mutex is a Release or an AcqRel (or strong), and I've already modified the code to make the conservative assumption.\n\nI get that you're saying that the slow path doesn't really need optimization, because it's the slow path, but just because it's the slow path doesn't mean we need to make it slower than necessary.\n\n> Concurrent code is always tricky to understand no matter how you write it.\n\nSure, I agree with that. But again, that doesn't mean we need to make it any harder to understand than necessary.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39703129/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39704252",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-39704252",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 39704252,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NzA0MjUy",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-07T07:57:08Z",
    "updated_at": "2014-04-07T07:57:08Z",
    "body": "> Additionally, I still do not understand why it is necessary to avoid SeqCst on the slow path\n\nTo clarify: if my proposed rewrite did nothing other than change the memory orderings on the slow path, then I'd understand your objection. But my proposed rewrite changes the algorithm to make it easier to reason about. And as long as it's being rewritten, using the correct memory orderings is a sensible thing to do.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39704252/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42106220",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-42106220",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 42106220,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMTA2MjIw",
    "user": {
      "login": "flaper87",
      "id": 13816,
      "node_id": "MDQ6VXNlcjEzODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/13816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flaper87",
      "html_url": "https://github.com/flaper87",
      "followers_url": "https://api.github.com/users/flaper87/followers",
      "following_url": "https://api.github.com/users/flaper87/following{/other_user}",
      "gists_url": "https://api.github.com/users/flaper87/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flaper87/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flaper87/subscriptions",
      "organizations_url": "https://api.github.com/users/flaper87/orgs",
      "repos_url": "https://api.github.com/users/flaper87/repos",
      "events_url": "https://api.github.com/users/flaper87/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flaper87/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-03T14:26:27Z",
    "updated_at": "2014-05-03T14:26:27Z",
    "body": "It looks like this change needs further discussion too but it's been stalled for 1 month. I'll close it, it can be reopened if necessary.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42106220/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42106539",
    "html_url": "https://github.com/rust-lang/rust/pull/13351#issuecomment-42106539",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13351",
    "id": 42106539,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMTA2NTM5",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-03T14:40:22Z",
    "updated_at": "2014-05-03T14:40:22Z",
    "body": "There is discussion happening on https://github.com/mozilla/rust/pull/13349#issuecomment-41995556 , but this can just be reopened if/when a decision is made.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42106539/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
