[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15852299",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15852299",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15852299,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODUyMjk5",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-03T17:48:51Z",
    "updated_at": "2013-04-03T17:48:51Z",
    "body": "It looks like a lot of the intrinsics are implemented on x86 by just calling libc, which doesn't do our stack switch correctly. `sqrt` though does use the `sqrtss` instruction on x86. So to use these I think we need to examine every platform/intrinsic combination to see whether they are going to emit assembly or a libc call and then use conditional compilation to only use the intrinsics when we know they will be lowered to assembly.\n\nI imagine there are some other places where LLVM could be betraying us similarly, like with the `fmod` instruction.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15852299/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15862890",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15862890",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15862890,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODYyODkw",
    "user": {
      "login": "auroranockert",
      "id": 49616,
      "node_id": "MDQ6VXNlcjQ5NjE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/49616?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/auroranockert",
      "html_url": "https://github.com/auroranockert",
      "followers_url": "https://api.github.com/users/auroranockert/followers",
      "following_url": "https://api.github.com/users/auroranockert/following{/other_user}",
      "gists_url": "https://api.github.com/users/auroranockert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/auroranockert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/auroranockert/subscriptions",
      "organizations_url": "https://api.github.com/users/auroranockert/orgs",
      "repos_url": "https://api.github.com/users/auroranockert/repos",
      "events_url": "https://api.github.com/users/auroranockert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/auroranockert/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-03T20:37:34Z",
    "updated_at": "2013-04-03T20:37:47Z",
    "body": "Since there are stack problems and we don't know which platforms/llvm-versions require stack for their intrinsics, wouldn't it make sense to use the awesome new inline-assembly functionality and just emit the few instructions by hand?\n\nAs you can see from the following overly-simplified test program, the implementation wouldn't be huge, and we could fall back to libc/rust on platforms without an asm implementation.\n\n```\nmod intrinsics {\n  #[abi = \"rust-intrinsic\"]\n  pub extern \"rust-intrinsic\" {\n      fn sqrtf64(x: f64) -> f64;\n  }\n}\n\nmod assembly {\n  pub fn sqrtf64(x: f64) -> f64 {\n    let mut r = 0.0f64;\n    unsafe { asm!(\"sqrtsd $0, $1\" : \"=x\"(r) : \"x\"(x)); }\n    r\n  }\n}\n\nfn main() {\n  let mut s_a: f64 = 0.0;\n  let mut s_i: f64 = 0.0;\n\n  for core::uint::range(0, 1000000000) |i| {\n    s_i += unsafe { intrinsics::sqrtf64(i as f64) };\n    s_a += unsafe { assembly::sqrtf64(i as f64) };\n  }\n\n  io::println(fmt!(\"Intrinsics: %?, Assembly: %?\", s_i, s_a));\n}\n```\n\nPs. The assembly and intrinsic versions are about as quick on my macbook, the asm one maybe 2-3% faster, but that is probably just noise.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15862890/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15875570",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15875570",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15875570,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODc1NTcw",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-04T01:31:57Z",
    "updated_at": "2013-04-04T01:31:57Z",
    "body": "Ok, I did some digging into LLVM. It seems that a patch to [`ExpandNode`](https://github.com/brson/llvm/blob/master/lib/CodeGen/SelectionDAG/LegalizeDAG.cpp#L2557) ([the floating point operations within that](https://github.com/brson/llvm/blob/master/lib/CodeGen/SelectionDAG/LegalizeDAG.cpp#2953)) or (more usefully) [`ExpandLibCall`](https://github.com/brson/llvm/blob/master/lib/CodeGen/SelectionDAG/LegalizeDAG.cpp#L1784) that managed the C stack would fix these problems without having to resort to fragile architecture specific stuff.\n\n(I also tried some Googling, but either I don't know the right jargon, or no one else has met this problem.)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15875570/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15875694",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15875694",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15875694,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODc1Njk0",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-04T01:37:09Z",
    "updated_at": "2013-04-04T01:37:48Z",
    "body": "(I forgot to mention, but this seems to give an average speedup across all the new intrinsics of about 40%, and at least 400% for some, e.g. `sqrt`, which makes some microbenchmarks on par with/slightly faster than `gcc` and `clang` at `-O3`!)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15875694/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15895826",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15895826",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15895826,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODk1ODI2",
    "user": {
      "login": "auroranockert",
      "id": 49616,
      "node_id": "MDQ6VXNlcjQ5NjE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/49616?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/auroranockert",
      "html_url": "https://github.com/auroranockert",
      "followers_url": "https://api.github.com/users/auroranockert/followers",
      "following_url": "https://api.github.com/users/auroranockert/following{/other_user}",
      "gists_url": "https://api.github.com/users/auroranockert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/auroranockert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/auroranockert/subscriptions",
      "organizations_url": "https://api.github.com/users/auroranockert/orgs",
      "repos_url": "https://api.github.com/users/auroranockert/repos",
      "events_url": "https://api.github.com/users/auroranockert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/auroranockert/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-04T13:05:39Z",
    "updated_at": "2013-04-04T21:04:30Z",
    "body": "On a similar topic, have we considered implementing the intrinsics like https://gist.github.com/JensNockert/6da886103fc30c852032 this instead of adding each one to the compiler?\n\nMaybe I am missing something, but it seems to work?\n\nPs. I made a pull-request if anyone wants to look at how I implemented it in libcore https://github.com/mozilla/rust/pull/5724, cross-crate inlining works fine as well.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15895826/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15926347",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15926347",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15926347,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1OTI2MzQ3",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-04T21:50:37Z",
    "updated_at": "2013-04-04T21:50:37Z",
    "body": "I r+'ed @JensNockert patch in #5724 that simplifies the intrinsic declarations. That patch also adds the optimization to use both `sqrt` and `floor` intrinsics in the math modules, so will close #5686.\n\n@dbaupp It does seem like a general solution to this (including #5702) would require patching LLVM. I'm not sure whether we could convince them it's their bug though. The full stack growth solution as implemented by gcc includes a link-time step for rewriting calls to external library functions that do not participate in stack growth. In this case, these calls would theoretically be modified by the linker to call `__morestack_nosplit`. Rust doesn't rely on this though, mostly because such linkers don't exist everywhere.\n\nThat said, we are already diverging from the gcc stack growth protocol, having implemented our own support for Mac, Windows and Android. @pcwalton is now working on further LLVM changes to stack growth that are not implemented by gcc (and which we have no indication that LLVM upstream will want).\n\nI'd suggest we solve this on our end unless that becomes impossible.\n\n@JensNockert all things equal I would prefer to delegate to LLVM instead of writing assembly. There was a [report](https://wiki.linaro.org/LEG/Engineering/OPTIM/Assembly) recently about all the bad assembly in the world that reinforced this point to me.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15926347/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15926658",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15926658",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15926658,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1OTI2NjU4",
    "user": {
      "login": "auroranockert",
      "id": 49616,
      "node_id": "MDQ6VXNlcjQ5NjE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/49616?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/auroranockert",
      "html_url": "https://github.com/auroranockert",
      "followers_url": "https://api.github.com/users/auroranockert/followers",
      "following_url": "https://api.github.com/users/auroranockert/following{/other_user}",
      "gists_url": "https://api.github.com/users/auroranockert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/auroranockert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/auroranockert/subscriptions",
      "organizations_url": "https://api.github.com/users/auroranockert/orgs",
      "repos_url": "https://api.github.com/users/auroranockert/repos",
      "events_url": "https://api.github.com/users/auroranockert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/auroranockert/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-04T21:56:51Z",
    "updated_at": "2013-04-04T21:56:51Z",
    "body": "@brson I changed my mind, I fully agree with you.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15926658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15929793",
    "html_url": "https://github.com/rust-lang/rust/pull/5697#issuecomment-15929793",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/5697",
    "id": 15929793,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1OTI5Nzkz",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-04-04T23:07:22Z",
    "updated_at": "2013-04-04T23:07:22Z",
    "body": "@brson, ah ok, it's annoying that it looks like rust might permanently have a custom LLVM. I'll leave the changes to @pcwalton since he's already working on it, and I don't have much to offer in terms of C++ anyway.\n\n(@JensNockert nice work!)\n\nI'll close this, but if/when the stack changes get made, I'll be happy to fix and reopen.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/15929793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
