{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/15998",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/15998/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/15998/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/15998/events",
  "html_url": "https://github.com/rust-lang/rust/pull/15998",
  "id": 38793016,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTg5Mjc1MDI=",
  "number": 15998,
  "title": "Make use of the dereferenceable attribute instead of nonnull where we can.",
  "user": {
    "login": "luqmana",
    "id": 287063,
    "node_id": "MDQ6VXNlcjI4NzA2Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/luqmana",
    "html_url": "https://github.com/luqmana",
    "followers_url": "https://api.github.com/users/luqmana/followers",
    "following_url": "https://api.github.com/users/luqmana/following{/other_user}",
    "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions",
    "organizations_url": "https://api.github.com/users/luqmana/orgs",
    "repos_url": "https://api.github.com/users/luqmana/repos",
    "events_url": "https://api.github.com/users/luqmana/events{/privacy}",
    "received_events_url": "https://api.github.com/users/luqmana/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2014-07-26T02:21:29Z",
  "updated_at": "2014-07-26T23:45:46Z",
  "closed_at": "2014-07-26T17:26:17Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/15998",
    "html_url": "https://github.com/rust-lang/rust/pull/15998",
    "diff_url": "https://github.com/rust-lang/rust/pull/15998.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/15998.patch",
    "merged_at": "2014-07-26T17:26:24Z"
  },
  "body": "LLVM recently added a new attribute, dereferenceable: http://reviews.llvm.org/D4449\n\n> This patch adds a dereferencable attribute. In some sense, this is a companion to the nonnull attribute, but specifies that the pointer is known to be dereferencable in the same sense as a pointer generated by alloca is known to be dereferencable.\n\nWith rust, everywhere that we previously marked `nonnull` we can actually mark as `dereferenceable` (which implies nonnull) since we know the size. That is, except for one case: when generating calls for TyVisitor. It seems like we haven't substituted the self type (so we have `ty_param`) and just treat it as an opaque pointer so I just left that bit as nonnull.\n\nWith this, LLVM can for example hoist a load out of a loop where it previously couldn't:\n\n``` Rust\npub fn baz(c: &uint, n: uint) -> uint {\n    let mut res = 0;\n    for i in range(0, n) {\n        if i > 0 {\n            res += *c * i;\n        }\n    }\n    res\n}\n```\n\nBefore:\n\n``` llvm\ndefine i64 @baz(i64* noalias nocapture nonnull readonly, i64) unnamed_addr #0 {\nentry-block:\n  br label %for_loopback.outer\n\nfor_loopback.outer:                               ; preds = %then-block-33-, %entry-block\n  %.ph = phi i64 [ %.lcssa, %then-block-33- ], [ 0, %entry-block ]\n  %res.0.ph = phi i64 [ %8, %then-block-33- ], [ 0, %entry-block ]\n  br label %for_loopback\n\nfor_exit:                                         ; preds = %for_loopback\n  %res.0.ph.lcssa = phi i64 [ %res.0.ph, %for_loopback ]\n  ret i64 %res.0.ph.lcssa\n\nfor_loopback:                                     ; preds = %for_loopback.outer, %for_body\n  %2 = phi i64 [ %4, %for_body ], [ %.ph, %for_loopback.outer ]\n  %3 = icmp ult i64 %2, %1\n  br i1 %3, label %for_body, label %for_exit\n\nfor_body:                                         ; preds = %for_loopback\n  %4 = add i64 %2, 1\n  %5 = icmp eq i64 %2, 0\n  br i1 %5, label %for_loopback, label %then-block-33-\n\nthen-block-33-:                                   ; preds = %for_body\n  %.lcssa = phi i64 [ %4, %for_body ]\n  %.lcssa15 = phi i64 [ %2, %for_body ]\n  %6 = load i64* %0, align 8                     ; <------- this load\n  %7 = mul i64 %6, %.lcssa15\n  %8 = add i64 %7, %res.0.ph\n  br label %for_loopback.outer\n}\n```\n\nAfter:\n\n``` llvm\ndefine i64 @baz(i64* noalias nocapture readonly dereferenceable(8), i64) unnamed_addr #0 {\nentry-block:\n  %2 = load i64* %0, align 8                    ; <------- load once instead\n  br label %for_loopback.outer\n\nfor_loopback.outer:                               ; preds = %then-block-33-, %entry-block\n  %.ph = phi i64 [ %.lcssa, %then-block-33- ], [ 0, %entry-block ]\n  %res.0.ph = phi i64 [ %8, %then-block-33- ], [ 0, %entry-block ]\n  br label %for_loopback\n\nfor_exit:                                         ; preds = %for_loopback\n  %res.0.ph.lcssa = phi i64 [ %res.0.ph, %for_loopback ]\n  ret i64 %res.0.ph.lcssa\n\nfor_loopback:                                     ; preds = %for_loopback.outer, %for_body\n  %3 = phi i64 [ %5, %for_body ], [ %.ph, %for_loopback.outer ]\n  %4 = icmp ult i64 %3, %1\n  br i1 %4, label %for_body, label %for_exit\n\nfor_body:                                         ; preds = %for_loopback\n  %5 = add i64 %3, 1\n  %6 = icmp eq i64 %3, 0\n  br i1 %6, label %for_loopback, label %then-block-33-\n\nthen-block-33-:                                   ; preds = %for_body\n  %.lcssa = phi i64 [ %5, %for_body ]\n  %.lcssa15 = phi i64 [ %3, %for_body ]\n  %7 = mul i64 %2, %.lcssa15\n  %8 = add i64 %7, %res.0.ph\n  br label %for_loopback.outer\n}\n```\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/15998/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/15998/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
