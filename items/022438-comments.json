[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74643638",
    "html_url": "https://github.com/rust-lang/rust/pull/22438#issuecomment-74643638",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/22438",
    "id": 74643638,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NjQzNjM4",
    "user": {
      "login": "rust-highfive",
      "id": 7378925,
      "node_id": "MDQ6VXNlcjczNzg5MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7378925?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rust-highfive",
      "html_url": "https://github.com/rust-highfive",
      "followers_url": "https://api.github.com/users/rust-highfive/followers",
      "following_url": "https://api.github.com/users/rust-highfive/following{/other_user}",
      "gists_url": "https://api.github.com/users/rust-highfive/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rust-highfive/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rust-highfive/subscriptions",
      "organizations_url": "https://api.github.com/users/rust-highfive/orgs",
      "repos_url": "https://api.github.com/users/rust-highfive/repos",
      "events_url": "https://api.github.com/users/rust-highfive/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rust-highfive/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-02-17T10:03:05Z",
    "updated_at": "2015-02-17T10:03:05Z",
    "body": "r? @pnkfelix\n\n(rust_highfive has picked a reviewer for you, use r? to override)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74643638/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74663758",
    "html_url": "https://github.com/rust-lang/rust/pull/22438#issuecomment-74663758",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/22438",
    "id": 74663758,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NjYzNzU4",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-02-17T12:58:44Z",
    "updated_at": "2015-02-17T12:58:44Z",
    "body": "I've been lead to believe that emitting phi nodes directly is generally frowned upon, I guess its fine for such a localised internals change (i.e. it's not a loop the user writes directly)?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74663758/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74670905",
    "html_url": "https://github.com/rust-lang/rust/pull/22438#issuecomment-74670905",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/22438",
    "id": 74670905,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NjcwOTA1",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-02-17T13:57:15Z",
    "updated_at": "2015-02-17T13:57:15Z",
    "body": "> I've been lead to believe that emitting phi nodes directly is generally frowned upon, I guess its fine for such a localised internals change (i.e. it's not a loop the user writes directly)?\n\nNever heard of that, but now that you mentioned it, I decided to check what clang does, and it emits almost the same code that rustc produces with this patch. Phis are used there when building the loops for array initialization and destruction, same thing this code is used for. Only difference is that clang uses the pointer as the loop var instead of a counter, but the resulting optimized code seems identical and using the counter allows for the same code to be generated for zero-sized element types.\n\nC++ code:\n\n``` C++\nstruct X {\n  X() {}\n};\n\nvoid foo() {\n  X x[1000];\n}\n```\n\nClang emitted IR:\n\n``` llvm\ndefine void @_Z3foov() #0 {\n  %x = alloca [1000 x %struct.X], align 16\n  %1 = getelementptr inbounds [1000 x %struct.X]* %x, i32 0, i32 0\n  %2 = getelementptr inbounds %struct.X* %1, i64 1000\n  br label %3\n\n; <label>:3                                       ; preds = %3, %0\n  %4 = phi %struct.X* [ %1, %0 ], [ %5, %3 ]\n  call void @_ZN1XC2Ev(%struct.X* %4)\n  %5 = getelementptr inbounds %struct.X* %4, i64 1\n  %6 = icmp eq %struct.X* %5, %2\n  br i1 %6, label %7, label %3\n\n; <label>:7                                       ; preds = %3\n  ret void\n}\n```\n\nRust code:\n\n``` rust\nfn main() {\n    let x = [0; 1000];\n}\n```\n\nrustc emitted IR (with the patch):\n\n``` llvm\ndefine internal void @_ZN4main20hed4aaa978de9fce6eaaE() unnamed_addr #0 {\nentry-block:\n  %x = alloca [1000 x i32]\n  %0 = getelementptr inbounds [1000 x i32]* %x, i32 0, i32 0\n  br label %expr_repeat\n\nexpr_repeat:                                      ; preds = %expr_repeat, %entry-block\n  %1 = phi i64 [ 0, %entry-block ], [ %3, %expr_repeat ]\n  %2 = getelementptr inbounds i32* %0, i64 %1\n  store i32 0, i32* %2\n  %3 = add i64 %1, 1\n  %4 = icmp ult i64 %3, 1000\n  br i1 %4, label %expr_repeat, label %\"expr_repeat: next\"\n\n\"expr_repeat: next\":                              ; preds = %expr_repeat\n  ret void\n}\n```\n\nHad to use an object instead of an integer in C++ because that's the only way to get array initialization that does a loop.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74670905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74862504",
    "html_url": "https://github.com/rust-lang/rust/pull/22438#issuecomment-74862504",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/22438",
    "id": 74862504,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0ODYyNTA0",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-02-18T13:22:14Z",
    "updated_at": "2015-02-18T13:22:14Z",
    "body": "@bors r+ 378a\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/74862504/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
