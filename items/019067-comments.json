[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63444806",
    "html_url": "https://github.com/rust-lang/rust/issues/19067#issuecomment-63444806",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19067",
    "id": 63444806,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDQ0ODA2",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-11-18T09:44:26Z",
    "updated_at": "2014-11-18T09:44:26Z",
    "body": "> You may think that this gives us terrible performance: return a value and then immediately box it up ?! Isn't that the worst of both worlds? Rust is smarter than that. There is no copy in this code. main allocates enough room for the `box , passes a pointer to that memory into foo as x, and then foo writes the value straight into that pointer. This writes the return value directly into the allocated box.\n\nThat's wrong / doesn't work / is not implemented. There might be a copy even if the function gets inlined.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63444806/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63445302",
    "html_url": "https://github.com/rust-lang/rust/issues/19067#issuecomment-63445302",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19067",
    "id": 63445302,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDQ1MzAy",
    "user": {
      "login": "genbattle",
      "id": 483375,
      "node_id": "MDQ6VXNlcjQ4MzM3NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/483375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/genbattle",
      "html_url": "https://github.com/genbattle",
      "followers_url": "https://api.github.com/users/genbattle/followers",
      "following_url": "https://api.github.com/users/genbattle/following{/other_user}",
      "gists_url": "https://api.github.com/users/genbattle/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/genbattle/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/genbattle/subscriptions",
      "organizations_url": "https://api.github.com/users/genbattle/orgs",
      "repos_url": "https://api.github.com/users/genbattle/repos",
      "events_url": "https://api.github.com/users/genbattle/events{/privacy}",
      "received_events_url": "https://api.github.com/users/genbattle/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-11-18T09:48:43Z",
    "updated_at": "2014-11-18T09:48:54Z",
    "body": "[This comment](http://www.reddit.com/r/rust/comments/2mmd03/can_i_get_clarification_on_something_in_the_rust/cm5qdhm) seems to disagree. According to the poster it works as described.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63445302/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63445411",
    "html_url": "https://github.com/rust-lang/rust/issues/19067#issuecomment-63445411",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19067",
    "id": 63445411,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDQ1NDEx",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-11-18T09:49:34Z",
    "updated_at": "2014-11-18T09:49:34Z",
    "body": "It doesn't: https://github.com/rust-lang/rust/issues/18363\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63445411/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63452147",
    "html_url": "https://github.com/rust-lang/rust/issues/19067#issuecomment-63452147",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19067",
    "id": 63452147,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDUyMTQ3",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-11-18T10:47:10Z",
    "updated_at": "2014-11-18T10:47:55Z",
    "body": "@mahkoh as written, the code does. This is the unoptimised IR of `foo`:\n\n``` llvm\ndefine internal void @_ZN3foo20h9f580e219f1e2e10paaE(%\"struct.BigStruct<[]>\"* noalias nocapture sret dereferenceable(24), %\"struct.BigStruct<[]>\"* noalias dereferenceable(24)) unnamed_addr #0 {\nentry-block:\n  %x = alloca %\"struct.BigStruct<[]>\"*\n  store %\"struct.BigStruct<[]>\"* %1, %\"struct.BigStruct<[]>\"** %x\n  %2 = load %\"struct.BigStruct<[]>\"** %x\n  %3 = bitcast %\"struct.BigStruct<[]>\"* %2 to i8*\n  %4 = bitcast %\"struct.BigStruct<[]>\"* %0 to i8*\n  call void @llvm.memcpy.p0i8.p0i8.i64(i8* %4, i8* %3, i64 24, i32 8, i1 false)\n  br label %clean_custom_\n\nreturn:                                           ; preds = %clean_custom_\n  ret void\n\nclean_custom_:                                    ; preds = %entry-block\n  call void @\"_ZN20Box$LT$BigStruct$GT$14glue_drop.108817h69e26cab4c19e281E\"(%\"struct.BigStruct<[]>\"** %x)\n  br label %return\n}\n```\n\nIn particular, there is only one stack slot used which is storing a pointer to `BigStruct`, not `BigStruct` itself, and the `memcpy` is from the input box straight into the out pointer.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63452147/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63452971",
    "html_url": "https://github.com/rust-lang/rust/issues/19067#issuecomment-63452971",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19067",
    "id": 63452971,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDUyOTcx",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-11-18T10:53:55Z",
    "updated_at": "2014-11-18T10:53:55Z",
    "body": "I'm not saying that there are not (trivial) functions where this will work, e.g.,\n\n``` rust\nfn f() -> X {\n    unsafe { std::mem::zeroed() }\n}\n```\n\ndoes work as expected without a copy. But this is not what the guide is saying:\n\n```\nThis is important enough that it bears repeating: pointers are not for\noptimizing returning values from your code.\n```\n\nThis is wrong once `f` gets even a little complicated, e.g., the function in the other issue. Furthermore,\n\n``` rust\nArc::new(f())\n```\n\nis likely to copy the returned value twice: Once from `f` to the stack of `Arc::new` (even if Arc::new is inlined) and then onto the heap. Saying that \"Rust is smarter than that\" is misleading.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63452971/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63481864",
    "html_url": "https://github.com/rust-lang/rust/issues/19067#issuecomment-63481864",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19067",
    "id": 63481864,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDgxODY0",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-11-18T14:52:39Z",
    "updated_at": "2014-11-18T14:52:39Z",
    "body": "I wrote this section under @thestinger 's advisement, I'd like his thoughts here.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63481864/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63584754",
    "html_url": "https://github.com/rust-lang/rust/issues/19067#issuecomment-63584754",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19067",
    "id": 63584754,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNTg0NzU0",
    "user": {
      "login": "Florob",
      "id": 133684,
      "node_id": "MDQ6VXNlcjEzMzY4NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/133684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Florob",
      "html_url": "https://github.com/Florob",
      "followers_url": "https://api.github.com/users/Florob/followers",
      "following_url": "https://api.github.com/users/Florob/following{/other_user}",
      "gists_url": "https://api.github.com/users/Florob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Florob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Florob/subscriptions",
      "organizations_url": "https://api.github.com/users/Florob/orgs",
      "repos_url": "https://api.github.com/users/Florob/repos",
      "events_url": "https://api.github.com/users/Florob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Florob/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-11-19T02:55:24Z",
    "updated_at": "2014-11-19T02:57:20Z",
    "body": "@mahkoh: Correct me if I'm mistaken, but I think the behaviour described here is distinctly different from named return value optimization. The point being made here is that the returned value is immediately placed on the heap and not temporarily on the stack.\n\nE.g.:\n\n``` rust\nextern crate test;\n\npub struct X {\n    x: [u8, ..1 << 10],\n}\n\npub fn f() -> X {\n    let mut x: X = unsafe { std::mem::uninitialized() };\n    for i in range(0, x.x.len()) {\n        x.x[i] = i as u8;\n    }\n    x\n}\n\nfn main() {\n    let x = box f();\n    test::black_box(&x);\n}\n```\n\nThis will only take 1k of stack space + 1k of heap space, instead of 2k of stack space + 1k of heap space as would be the case without this optimization. With named return value optimization it would only take 1k of heap space. `box` exists precisely to prevent the issue you're describing with `Arc`. Eventually we hope to have `box (ARC) f()` (or at least I think that is the plan).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/63584754/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
