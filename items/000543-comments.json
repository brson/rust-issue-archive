[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1575089",
    "html_url": "https://github.com/rust-lang/rust/issues/543#issuecomment-1575089",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/543",
    "id": 1575089,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1NzUwODk=",
    "user": {
      "login": "lkuper",
      "id": 535218,
      "node_id": "MDQ6VXNlcjUzNTIxOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/535218?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lkuper",
      "html_url": "https://github.com/lkuper",
      "followers_url": "https://api.github.com/users/lkuper/followers",
      "following_url": "https://api.github.com/users/lkuper/following{/other_user}",
      "gists_url": "https://api.github.com/users/lkuper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lkuper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lkuper/subscriptions",
      "organizations_url": "https://api.github.com/users/lkuper/orgs",
      "repos_url": "https://api.github.com/users/lkuper/repos",
      "events_url": "https://api.github.com/users/lkuper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lkuper/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2011-07-14T21:14:11Z",
    "updated_at": "2011-07-14T21:14:11Z",
    "body": "Status update: All the code (forwarding functions and such) is in place to support method overloading, but there's still at least one memory corruption bug to fix before I can close this issue.  Here's a reduced test case:\n\n```\nfn main() {\n\n    obj a() {\n        fn foo() -> int {\n            ret 2;\n        }\n    }\n\n    auto my_a = a();\n\n    auto my_b = obj() {\n        fn foo() -> int {\n            ret 3;\n        }\n        with my_a\n    };\n\n    assert (my_b.foo() == 3);\n}\n```\n\nmy_b.foo() returns 3, as we want it to, but when this program runs under valgrind we get an invalid read followed by an invalid write.  Here's what I've been able to suss out: the invalid read and write are happening in drop glue, when trying to decrement a refcount.  In particular, we're trying to read from, then write to, a location that contains a refcount.  Either it's not actually the location of the refcount we're supposed to be decrementing, or we are not actually supposed to be decrementing anyone's refcount; I don't know which.  When we compile with -g, the name of the function in which the invalid read/write happen is `_ZN9glue_drop17O_5B_Ffoo_5B__5D_iFfoo_5B__5D_i_5D_17_9c52ab87ea8f24c9E`.  I'm not actually sure which drop glue this corresponds to; presumably it's either for the anon obj or the regular obj.\n\nAttempting to debug from the top down, instead: the only new code that deals with drop glue (or cleanups in general) is [here](https://github.com/graydon/rust/blob/c124a025bfb421791b0b4bf1350f6203e346781a/src/comp/middle/trans.rs#L7048), where I add a cleanup for the pair I'm allocating for the anonymous object.  It's entirely possible that I'm doing this wrong because I'm just guessing at what I should be passing to add_clean_temp (should it be the result of alloca, or the value from the result of trans_malloc_boxed, later, or something else?) or what type I should be passing (the node_id_type of the anon obj node, or body_ty, later, or something else?).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1575089/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1618564",
    "html_url": "https://github.com/rust-lang/rust/issues/543#issuecomment-1618564",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/543",
    "id": 1618564,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTg1NjQ=",
    "user": {
      "login": "lkuper",
      "id": 535218,
      "node_id": "MDQ6VXNlcjUzNTIxOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/535218?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lkuper",
      "html_url": "https://github.com/lkuper",
      "followers_url": "https://api.github.com/users/lkuper/followers",
      "following_url": "https://api.github.com/users/lkuper/following{/other_user}",
      "gists_url": "https://api.github.com/users/lkuper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lkuper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lkuper/subscriptions",
      "organizations_url": "https://api.github.com/users/lkuper/orgs",
      "repos_url": "https://api.github.com/users/lkuper/repos",
      "events_url": "https://api.github.com/users/lkuper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lkuper/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2011-07-20T20:20:33Z",
    "updated_at": "2011-07-20T20:20:33Z",
    "body": "I just discovered that the tests for ths issue are suddenly passing valgrind for some reason.  I'm not sure if it's because of changes to glue generation in the last few days while I've been working on other things, or if it's a side effect of the improvements I made to typechecking for anonymous objects, or something else, but I guess I'll take it.  Meanwhile, the larger problem that graydon had suggested was at the heart of the memory corruption I was getting is still present and manifesting itself as issue #702.  (But in the tests for that issue, we don't get memory corruption, we get flat-out wrong answers!)  So there's clearly still something to fix, but in the meantime, I un-xfail'd the tests for this issue and am declaring it tentatively fixed...\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1618564/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
