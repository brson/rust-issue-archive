[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/131188159",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-131188159",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 131188159,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzMTE4ODE1OQ==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-14T17:27:44Z",
    "updated_at": "2015-08-14T17:27:44Z",
    "body": "This feature is now entering its final comment period for stabilization.\n\nI will post a PR soon for renaming these function to `from_raw` and `into_raw`.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/131188159/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/131275800",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-131275800",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 131275800,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzMTI3NTgwMA==",
    "user": {
      "login": "shepmaster",
      "id": 174509,
      "node_id": "MDQ6VXNlcjE3NDUwOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/174509?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shepmaster",
      "html_url": "https://github.com/shepmaster",
      "followers_url": "https://api.github.com/users/shepmaster/followers",
      "following_url": "https://api.github.com/users/shepmaster/following{/other_user}",
      "gists_url": "https://api.github.com/users/shepmaster/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shepmaster/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shepmaster/subscriptions",
      "organizations_url": "https://api.github.com/users/shepmaster/orgs",
      "repos_url": "https://api.github.com/users/shepmaster/repos",
      "events_url": "https://api.github.com/users/shepmaster/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shepmaster/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-15T01:08:49Z",
    "updated_at": "2015-08-15T01:08:49Z",
    "body": "> renaming these function to from_raw and into_raw\n\nAwesome! That makes [sense to me](https://github.com/rust-lang/rust/pull/25777#issuecomment-105632084).\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/131275800/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132202046",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-132202046",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 132202046,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzMjIwMjA0Ng==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-18T13:17:52Z",
    "updated_at": "2015-08-18T13:54:58Z",
    "body": "This rename is important because `CStr::from_ptr` and `CString::from_ptr` [are so different, but with similar names.](https://github.com/ashleysommer/rust-fcgi/commit/591be39f185475388ca3d7dd76df9ca07d4f548b)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132202046/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132202354",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-132202354",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 132202354,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzMjIwMjM1NA==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-18T13:19:08Z",
    "updated_at": "2015-08-18T13:19:08Z",
    "body": "If you use `CString::from_ptr` on a non-rust allocated thing by mistake, you end up trying to reallocate string literals and things like that. See #27878.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132202354/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132214629",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-132214629",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 132214629,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzMjIxNDYyOQ==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-18T13:50:33Z",
    "updated_at": "2015-08-18T13:50:39Z",
    "body": "We need to learn from these bugs. Premature dropping of `CString` leading to dangling pointers, and that some raw pointers transfer ownership and others are \"borrowed\". Can we use the type system better?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132214629/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132261453",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-132261453",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 132261453,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzMjI2MTQ1Mw==",
    "user": {
      "login": "shepmaster",
      "id": 174509,
      "node_id": "MDQ6VXNlcjE3NDUwOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/174509?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shepmaster",
      "html_url": "https://github.com/shepmaster",
      "followers_url": "https://api.github.com/users/shepmaster/followers",
      "following_url": "https://api.github.com/users/shepmaster/following{/other_user}",
      "gists_url": "https://api.github.com/users/shepmaster/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shepmaster/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shepmaster/subscriptions",
      "organizations_url": "https://api.github.com/users/shepmaster/orgs",
      "repos_url": "https://api.github.com/users/shepmaster/repos",
      "events_url": "https://api.github.com/users/shepmaster/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shepmaster/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-18T16:05:38Z",
    "updated_at": "2015-08-18T16:05:38Z",
    "body": "@bluss an interesting question. In my mind, once you hit a raw pointer, all bets are off and you have to manage everything yourself. Do you have any thoughts on how to improve that with types?\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/132261453/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137387494",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-137387494",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 137387494,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNzM4NzQ5NA==",
    "user": {
      "login": "geofft",
      "id": 74644,
      "node_id": "MDQ6VXNlcjc0NjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/geofft",
      "html_url": "https://github.com/geofft",
      "followers_url": "https://api.github.com/users/geofft/followers",
      "following_url": "https://api.github.com/users/geofft/following{/other_user}",
      "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
      "organizations_url": "https://api.github.com/users/geofft/orgs",
      "repos_url": "https://api.github.com/users/geofft/repos",
      "events_url": "https://api.github.com/users/geofft/events{/privacy}",
      "received_events_url": "https://api.github.com/users/geofft/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-03T09:13:57Z",
    "updated_at": "2015-09-03T09:13:57Z",
    "body": "You can still get _some_ type-safety with raw pointers, though you don't get ownership tracking. I can see a potential API along these lines:\n\n``` rust\n#[repr(i8)] enum RustAllocChar {...}\n\nimpl CString {\n    fn into_raw(self) -> *const RustAllocChar;\n    unsafe fn from_raw(ptr: *const RustAllocChar) -> CString;\n}\n```\n\nwhich lets you write something like\n\n``` rust\nextern {\n    fn do_stuff(string: *mut RustAllocChar, free: fn(*mut RustAllocChar));\n}\n\nextern fn free(ptr: *mut RustAllocChar) {\n    drop(CString::from_raw(ptr));\n}\n\nfn main() {\n    let s = CString::new(\"Hello!\").unwrap();\n    unsafe {do_stuff(s.into_raw(), free)};\n}\n```\n\nor for a library\n\n``` rust\n#[no_mangle] // char *mylib_do_stuff(void);\nextern fn mylib_do_stuff() -> *mut RustOwnedChar {...}\n#[no_mangle] // void mylib_free(char *s);\nextern fn mylib_free(s: *mut RustOwnedChar) {...}\n```\n\nSo `RustAllocChar` (or whatever you want to call it -- maybe `CChar`?) is as valid a binding of C's `char` as `libc::c_char` is, but it clearly states that the memory is allocated by Rust: `into_raw()` no longer returns a type that is indistinguishable from foreign-allocated, otherwise-owned, or static strings. So it's harder to leak it by passing it somewhere where `*const c_char` was expected, and it's harder to pass the result of `.as_ptr()` (which is only valid until the `CString` goes out of scope) where you really wanted `.into_ptr()`, since they have different types. And it's harder to accidentally free things that shouldn't be freed, because they won't have type `*const RustAllocChar`.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137387494/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137390135",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-137390135",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 137390135,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNzM5MDEzNQ==",
    "user": {
      "login": "geofft",
      "id": 74644,
      "node_id": "MDQ6VXNlcjc0NjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/geofft",
      "html_url": "https://github.com/geofft",
      "followers_url": "https://api.github.com/users/geofft/followers",
      "following_url": "https://api.github.com/users/geofft/following{/other_user}",
      "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
      "organizations_url": "https://api.github.com/users/geofft/orgs",
      "repos_url": "https://api.github.com/users/geofft/repos",
      "events_url": "https://api.github.com/users/geofft/events{/privacy}",
      "received_events_url": "https://api.github.com/users/geofft/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-03T09:27:01Z",
    "updated_at": "2015-09-03T09:32:32Z",
    "body": "Also, while I was writing the above, I realized -- shouldn't `into_raw` return a mutable pointer, not a constant one? It is indeed mutable, in that it's an owned, heap-allocated array of bytes: C code can safely modify it within its length. It is also semantically common for C APIs to use mutable pointers vs. const pointers to indicate ownership: for instance, `void free(void *ptr)` takes a mutable pointer, so if you only have a constant pointer, you know you can't free it and therefore you don't own it. So if you're \"transfer[ring] ownership of the string to a C caller\", as our docs say, the C code is probably expecting a mutable pointer regardless of whether it intends to mutate it.\n\nSimilarly, `from_raw` should take a mutable pointer, since C APIs are probably happy to free the string by passing it back as a mutable pointer (since the usual way they free strings is `free`). This would encourage good API design and also discourage things like `from_raw`ing a string literal, but it's not strictly necessary.\n\n[EDIT: `Box::from_raw` and `into_raw` return and take mutable pointers, respectively, so this change would match their API.]\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137390135/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137432253",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-137432253",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 137432253,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNzQzMjI1Mw==",
    "user": {
      "login": "shepmaster",
      "id": 174509,
      "node_id": "MDQ6VXNlcjE3NDUwOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/174509?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shepmaster",
      "html_url": "https://github.com/shepmaster",
      "followers_url": "https://api.github.com/users/shepmaster/followers",
      "following_url": "https://api.github.com/users/shepmaster/following{/other_user}",
      "gists_url": "https://api.github.com/users/shepmaster/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shepmaster/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shepmaster/subscriptions",
      "organizations_url": "https://api.github.com/users/shepmaster/orgs",
      "repos_url": "https://api.github.com/users/shepmaster/repos",
      "events_url": "https://api.github.com/users/shepmaster/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shepmaster/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-03T13:02:13Z",
    "updated_at": "2015-09-03T13:02:13Z",
    "body": "> but it clearly states that the memory is allocated by Rust\n\nI disagree. There's no reason to assume that a `*const Foo` was allocated by Rust or the system allocator or any other allocator. \n\n> a type that is indistinguishable from foreign-allocated, otherwise-owned, or static strings\n\nThe problem is that we are dealing with C /FFI and these types _are_ indistinguishable. \n\nI think that the additional cognitive overhead of having to remember that a `RustAllocChar` can be coerced to a `*const c_char` would also be annoying. \n\nIt also sound like you are trying to use these methods inside of Rust code to call FFI code. That's definitely not the intended use case, as you don't want to have a one-way transfer of ownership due to the reallocation requirements. \n\n> `Box::from_raw` and `into_raw` return and take mutable pointers, respectively\n\nThat's a good reason to change them, and it was probably a mistake on my part originally. Honestly, the fluidity of `const` / `mut` with raw pointers always makes me treat it as a second-class citizen. ^_^\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137432253/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137485867",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-137485867",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 137485867,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNzQ4NTg2Nw==",
    "user": {
      "login": "geofft",
      "id": 74644,
      "node_id": "MDQ6VXNlcjc0NjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/geofft",
      "html_url": "https://github.com/geofft",
      "followers_url": "https://api.github.com/users/geofft/followers",
      "following_url": "https://api.github.com/users/geofft/following{/other_user}",
      "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
      "organizations_url": "https://api.github.com/users/geofft/orgs",
      "repos_url": "https://api.github.com/users/geofft/repos",
      "events_url": "https://api.github.com/users/geofft/events{/privacy}",
      "received_events_url": "https://api.github.com/users/geofft/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-03T15:29:01Z",
    "updated_at": "2015-09-03T15:29:01Z",
    "body": "> I disagree. There's no reason to assume that a `*const Foo` was allocated by Rust or the system allocator or any other allocator. [...] The problem is that we are dealing with C /FFI and these types _are_ indistinguishable.\n\nMaybe I was unclear, but this depends specifically on annotating types with a `*const TheseBytesWereAllocatedByRust`, not any old `*const Foo`, and have a guarantee that `TheseBytesWereAllocatedByRust` is _only_ instantiated by `CString` (sorta like how we have a guarantee that, e.g., `str` is UTF-8, despite it having the exact same representation as `[u8]`). This static guarantee is powered by it being a non-instantiable enum, so only unsafe code can generate or consume pointers to it.\n\nObviously this requires defining the FFI interfaces to use these types when appropriate, and not use them when inappropriate. I don't think that's too hard (we just need to pick a less stupid name than the ones I've come up with).\n\nTo be fair, it is confusing that I'm distinguishing the type of the pointed-to thing, not the type of the pointer, when it is semantically a different sort of (raw) pointer to the same `c_char`. It would be nice if the FFI bindings could take a `RustAllocPtr<c_char>`, or perhaps even a `CString` directly. But I _think_ there's no way to make that FFI-safe since you'd be wrapping the pointer with a struct, and `struct {char *}` and `char *` aren't interchangeable (they're passed differently on the x86-32 System V ABI, in particular). If there's a way to newtype a primitive type without wrapping it with a struct, that would be awesome. But short of that, I'm doing a newtype on the target of the pointer, since all data pointers have the same ABI (`struct {char} *` and `char *` are interchangeable on all platforms Rust is portable to).\n\n> I think that the additional cognitive overhead of having to remember that a RustAllocChar can be coerced to a *const c_char would also be annoying.\n\nI'm not clear on when you'd need to coerce it, in Rust code. The only purpose of a `*mut RustAllocChar` is to be immediately converted to/from `CString`. If you need a `*const c_char` (which represents some sort of borrow), in Rust, go to the `CString` first and then borrow from it. While transmuting from `*mut RustAllocChar` to `*const c_char` is safe to do, it probably represents a memory leak.\n\n> It also sound like you are trying to use these methods inside of Rust code to call FFI code. That's definitely not the intended use case, as you don't want to have a one-way transfer of ownership due to the reallocation requirements.\n\nYeah, drop my first example with the callback because that's more confusing than it's worth. What I have in mind is implementing a C API contract that says something like, \"This function returns a pointer. When you are done with it, free it by calling this other function,\" as you would do if you were implementing a C-ABI plugin spec, or writing a C-ABI library in Rust. Your example from #25777 does this. If I added both proper `const` usage (in Rust and C) and the newtype I'm suggesting (in Rust), you'd get:\n\n``` rust\n#[no_mangle]\npub extern fn reverse(s: *const libc::c_char) -> *mut RustAllocChar {\n    let s = unsafe { CStr::from_ptr(s) };\n    let s2 = s.to_str().unwrap();\n    let s3: String = s2.chars().rev().collect();\n    let s4 = CString::new(s3).unwrap();\n    s4.into_ptr()\n}\n\n#[no_mangle]\npub extern fn cleanup(s: *mut RustAllocChar) {\n    unsafe { CString::from_ptr(s) };\n}\n```\n\n``` c\n#include <stdio.h>\n\nextern char *reverse(const char *);\nextern void cleanup(char *);\n\nint main() {\n  char *s = reverse(\"Hello, world!\");\n  printf(\"%s\\n\", s);\n  cleanup(s);\n}\n```\n\nwhich, at least on the Rust side, makes it clear what pointers are owned and which are borrowed. On the C side, the API docs or header files would probably have a comment on `reverse()` saying something like \"The caller owns the resulting pointer and must free it by calling `cleanup()`\", which conveys the same thing as the type, except in prose (which is basically how life in C goes).\n\n> fluidity of const / mut with raw pointers\n\nOnly when you're defining the FFI. Rust requires you to do an unsafe cast to turn `const` to `mut`, and C compilers give you a warning if you do it as an implicit cast. (This is what allows C programmers to have the discipline of owned-pointers-are-mutable-pointers + make-every-pointer-const-if-possible, since you can only implicitly cast mutable pointers to `void *` when calling `free`.)\n\nIncidentally, the fact that C literals have type `char *` instead of `const char *` is a stupid historical artifact dating from C's need to be backwards-compatible with code from literally before const was invented. Good C code should treat literals as `const char *` as far as possible.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137485867/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137510926",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-137510926",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 137510926,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNzUxMDkyNg==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-03T16:57:10Z",
    "updated_at": "2015-09-03T16:57:10Z",
    "body": "@geofft \n\nI agree with changing `{into,from}_raw` to taking `*mut T` instead of a `*const T`, but I'm less sure about adding a custom type to represent a Rust-owned character. You mention that \"only unsafe code can generate or consume pointers to it\" but can't you have safe (in terms of Rust) code that does `1234 as *mut RustAllocChar`? In that sense these sorts of raw pointers can be manufactured at any time it seems like.\n\nIn general I feel the extra cognitive overhead of having an extra type just for this return value may not be worth the little bit of extra safety we get. For example there's still the case where `Box::into_raw` will return types like `*mut i32` which can then be passed down into C (for example), and we probably wouldn't want to wrap that up an an extra wrapper.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137510926/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137518689",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-137518689",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 137518689,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNzUxODY4OQ==",
    "user": {
      "login": "geofft",
      "id": 74644,
      "node_id": "MDQ6VXNlcjc0NjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/geofft",
      "html_url": "https://github.com/geofft",
      "followers_url": "https://api.github.com/users/geofft/followers",
      "following_url": "https://api.github.com/users/geofft/following{/other_user}",
      "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
      "organizations_url": "https://api.github.com/users/geofft/orgs",
      "repos_url": "https://api.github.com/users/geofft/repos",
      "events_url": "https://api.github.com/users/geofft/events{/privacy}",
      "received_events_url": "https://api.github.com/users/geofft/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-03T17:22:22Z",
    "updated_at": "2015-09-03T17:22:22Z",
    "body": "> You mention that \"only unsafe code can generate or consume pointers to it\" but can't you have safe (in terms of Rust) code that does `1234 as *mut RustAllocChar`? In that sense these sorts of raw pointers can be manufactured at any time it seems like.\n\n... sigh, yes, you're right. OK, I withdraw that.\n\nSo if the answer is that there's no practical way to increase the type-safety of these functions, that's fine. And `from_raw` taking a `*mut c_char` gets us most of the way there, anyway.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/137518689/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138945657",
    "html_url": "https://github.com/rust-lang/rust/issues/27769#issuecomment-138945657",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27769",
    "id": 138945657,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzODk0NTY1Nw==",
    "user": {
      "login": "aturon",
      "id": 709807,
      "node_id": "MDQ6VXNlcjcwOTgwNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/709807?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aturon",
      "html_url": "https://github.com/aturon",
      "followers_url": "https://api.github.com/users/aturon/followers",
      "following_url": "https://api.github.com/users/aturon/following{/other_user}",
      "gists_url": "https://api.github.com/users/aturon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aturon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aturon/subscriptions",
      "organizations_url": "https://api.github.com/users/aturon/orgs",
      "repos_url": "https://api.github.com/users/aturon/repos",
      "events_url": "https://api.github.com/users/aturon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aturon/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-09T15:24:32Z",
    "updated_at": "2015-09-09T15:24:32Z",
    "body": "@Gankro Some of the above discussion makes me think about your plans with `Owned`/`Shared` -- did you have a draft for those?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/138945657/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
