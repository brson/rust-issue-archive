[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161110796",
    "html_url": "https://github.com/rust-lang/rust/issues/29631#issuecomment-161110796",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29631",
    "id": 161110796,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTExMDc5Ng==",
    "user": {
      "login": "jFransham",
      "id": 1509080,
      "node_id": "MDQ6VXNlcjE1MDkwODA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1509080?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jFransham",
      "html_url": "https://github.com/jFransham",
      "followers_url": "https://api.github.com/users/jFransham/followers",
      "following_url": "https://api.github.com/users/jFransham/following{/other_user}",
      "gists_url": "https://api.github.com/users/jFransham/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jFransham/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jFransham/subscriptions",
      "organizations_url": "https://api.github.com/users/jFransham/orgs",
      "repos_url": "https://api.github.com/users/jFransham/repos",
      "events_url": "https://api.github.com/users/jFransham/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jFransham/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-01T22:07:57Z",
    "updated_at": "2015-12-01T22:11:01Z",
    "body": "The `Command` struct looks like this:\n\n``` rust\npub struct Command {\n    inner: /*target-specific module*/::Command,\n    stdin: Option<Stdio>,\n    stdout: Option<Stdio>,\n    stderr: Option<Stdio>,\n}\n```\n\n`/*target-specific module*/::Command` looks to be comparable on Windows, but on Unix it contains `uid_t` and `gid_t` types, and I don't know if they are comparable. `Stdio` also doesn't implement `PartialEq`, so you would either have to ignore `stdin`, `stdout` and `stderr`, or implement `PartialEq` for `Stdio` (and `StdioImp`, which is the type that actually holds the data), but then you have to either implement `PartialEq` for `RawStdio` (which seems nonsensical for Windows, since it is a wrapper around a handle, and I believe handles are non-comparable in general. I think the same is true for Unix file descriptors but I am less sure about this) or alternatively alternatively just always pretend that `RawStdio`s are either always equal or never equal.\n\nThis last one is pretty horrible since in general Rust avoids making guarantees that are not completely true.\n\nI am not extensively familiar with OS internals, and my assumption that Windows handles and Unix descriptors are non-comparable based on the fact that I believe that you cannot guarantee that two handles/descriptors refer to the same logical space just because they share an integer value. It's possible that there is a reliable way to check equality of these. I would very much like to be fact-checked on everything here. It does seem to line up with what @rgardner quoted @talchas saying.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161110796/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161128064",
    "html_url": "https://github.com/rust-lang/rust/issues/29631#issuecomment-161128064",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29631",
    "id": 161128064,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTEyODA2NA==",
    "user": {
      "login": "talchas",
      "id": 3578697,
      "node_id": "MDQ6VXNlcjM1Nzg2OTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3578697?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/talchas",
      "html_url": "https://github.com/talchas",
      "followers_url": "https://api.github.com/users/talchas/followers",
      "following_url": "https://api.github.com/users/talchas/following{/other_user}",
      "gists_url": "https://api.github.com/users/talchas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/talchas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/talchas/subscriptions",
      "organizations_url": "https://api.github.com/users/talchas/orgs",
      "repos_url": "https://api.github.com/users/talchas/repos",
      "events_url": "https://api.github.com/users/talchas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/talchas/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-01T23:16:19Z",
    "updated_at": "2015-12-01T23:16:19Z",
    "body": "Yes, you would need to implement PartialEq all the way down.\n\n\"you cannot guarantee that two handles/descriptors refer to the same logical space just because they share an integer value\"\n\nThis is logically nonsensical, given the same context OS-wise (ie fd 0 of two different processes can certainly be different, but within a process it obviously is the same). Now, what exactly the boundaries of that are on windows I'm not certain (though I suspect it's process for handles), but if it's smaller than that you're already screwed because you've moved a Command across that boundary and changed the meaning.\n\nNow, the /other/ direction is where you have issues - fd 0 and fd 1 can refer to the same kernel \"file description\" and thus are effectively the same (and I suspect there are similar issues on windows). Still, I think PartialEq via simple comparison is entirely reasonable for fds at least - a Command copying stdout and one copying stderr are logically different even if stdout and stderr happen to be redirected together this invocation. Windows is less clear if this /completely/ makes sense - it looks more common to DuplicateHandle than it is to dup(), but it is probably unlikely to be that surprising.\n\nThe point I was making about uid/gid is basically the same as stdin == Inherit vs Raw(0) - these may be the same thing but it's probably simpler to leave them as comparing different, and unlikely to be that shocking. (For uid/gid in particular, you could in theory setuid() and that shouldn't change Command equality).\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161128064/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161261934",
    "html_url": "https://github.com/rust-lang/rust/issues/29631#issuecomment-161261934",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29631",
    "id": 161261934,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTI2MTkzNA==",
    "user": {
      "login": "jFransham",
      "id": 1509080,
      "node_id": "MDQ6VXNlcjE1MDkwODA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1509080?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jFransham",
      "html_url": "https://github.com/jFransham",
      "followers_url": "https://api.github.com/users/jFransham/followers",
      "following_url": "https://api.github.com/users/jFransham/following{/other_user}",
      "gists_url": "https://api.github.com/users/jFransham/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jFransham/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jFransham/subscriptions",
      "organizations_url": "https://api.github.com/users/jFransham/orgs",
      "repos_url": "https://api.github.com/users/jFransham/repos",
      "events_url": "https://api.github.com/users/jFransham/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jFransham/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-02T11:05:03Z",
    "updated_at": "2015-12-02T11:05:03Z",
    "body": "So if I understand correctly, could you just `#[derive(PartialEq)]` all the way down and get reasonably meaningful results?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161261934/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161330630",
    "html_url": "https://github.com/rust-lang/rust/issues/29631#issuecomment-161330630",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29631",
    "id": 161330630,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTMzMDYzMA==",
    "user": {
      "login": "talchas",
      "id": 3578697,
      "node_id": "MDQ6VXNlcjM1Nzg2OTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3578697?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/talchas",
      "html_url": "https://github.com/talchas",
      "followers_url": "https://api.github.com/users/talchas/followers",
      "following_url": "https://api.github.com/users/talchas/following{/other_user}",
      "gists_url": "https://api.github.com/users/talchas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/talchas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/talchas/subscriptions",
      "organizations_url": "https://api.github.com/users/talchas/orgs",
      "repos_url": "https://api.github.com/users/talchas/repos",
      "events_url": "https://api.github.com/users/talchas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/talchas/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-02T15:22:06Z",
    "updated_at": "2015-12-02T15:22:06Z",
    "body": "Yeah, I think so.\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161330630/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/345170548",
    "html_url": "https://github.com/rust-lang/rust/issues/29631#issuecomment-345170548",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29631",
    "id": 345170548,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NTE3MDU0OA==",
    "user": {
      "login": "dtolnay",
      "id": 1940490,
      "node_id": "MDQ6VXNlcjE5NDA0OTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dtolnay",
      "html_url": "https://github.com/dtolnay",
      "followers_url": "https://api.github.com/users/dtolnay/followers",
      "following_url": "https://api.github.com/users/dtolnay/following{/other_user}",
      "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions",
      "organizations_url": "https://api.github.com/users/dtolnay/orgs",
      "repos_url": "https://api.github.com/users/dtolnay/repos",
      "events_url": "https://api.github.com/users/dtolnay/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dtolnay/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-17T07:51:44Z",
    "updated_at": "2017-11-17T07:51:44Z",
    "body": "From the discussion it sounds like the motivation of this would be to make it easier to write tests for a command line shell. It isn't clear to me that we could arrive at a definition of PartialEq that would make sense across a variety of use cases, especially when it comes to uid/gid and stdin/stdout/stderr. I am going to close this and recommend refactoring the shell in a way that allows you to test exactly what you want to test.\r\n\r\n#### Before\r\n\r\n```rust\r\nfn parse_the_command(inputs: Inputs) -> Command { /* ... */ }\r\n\r\nfn main() {\r\n    let child = parse_the_command(/* ... */).spawn()?;\r\n}\r\n\r\n#[test]\r\nfn test_parse_the_command() {\r\n    let expected = /* ... */;\r\n    let actual = parse_the_command(/* ... */);\r\n    assert_eq!(expected, actual);\r\n}\r\n```\r\n\r\n#### After\r\n\r\n```rust\r\n#[derive(PartialEq)]\r\nstruct Parse {\r\n    cmd: OsString,\r\n    args: Vec<OsString>,\r\n}\r\n\r\nfn parse_the_command(inputs: Inputs) -> Parse { /* ... */ }\r\n\r\nfn main() {\r\n    let parse = parse_the_command(/* ... */);\r\n    let child = Command::new(parse.cmd).args(parse.args).spawn()?;\r\n}\r\n\r\n#[test]\r\nfn test_parse_the_command() {\r\n    let expected = /* ... */;\r\n    let actual = parse_the_command(/* ... */);\r\n    assert_eq!(expected, actual);\r\n}\r\n```",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/345170548/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
