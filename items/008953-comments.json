[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23839865",
    "html_url": "https://github.com/rust-lang/rust/issues/8953#issuecomment-23839865",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8953",
    "id": 23839865,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODM5ODY1",
    "user": {
      "login": "chris-morgan",
      "id": 392868,
      "node_id": "MDQ6VXNlcjM5Mjg2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/392868?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chris-morgan",
      "html_url": "https://github.com/chris-morgan",
      "followers_url": "https://api.github.com/users/chris-morgan/followers",
      "following_url": "https://api.github.com/users/chris-morgan/following{/other_user}",
      "gists_url": "https://api.github.com/users/chris-morgan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chris-morgan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chris-morgan/subscriptions",
      "organizations_url": "https://api.github.com/users/chris-morgan/orgs",
      "repos_url": "https://api.github.com/users/chris-morgan/repos",
      "events_url": "https://api.github.com/users/chris-morgan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chris-morgan/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-05T02:18:15Z",
    "updated_at": "2013-09-05T02:18:15Z",
    "body": "I certainly felt the need of this with rust-http, where code like writing an HTTP header to a socket with write() calls for name, \": \", value, and \"\\r\\n\" would take four TCP packets rather than probably a small fraction of one. Hence (in part) my current buffering arrangement in rust-http.\n\nI think the difficulty here is handling reading and writing. As it happens, I'd rather like to be able to split a socket up into a reader and a writer, but that's out of scope here. I think, though, that we'd need three decorators; one for `Reader`, one for `Writer` and one for `Stream`\u2014the last being basically the first two glued together.\n\nI [switched from my own BufferedReader and BufferedWriter to having a unified BufferedStream](https://github.com/chris-morgan/rust-http/commit/f78236284b73ba5e980962b1ffbd71ea9a03fbbc) (the former two using borrowing on account of needing to read and write) when that approach became infeasible. Here, a BufferedReader and BufferedWriter would, I presume, own the Reader or Writer.\n\nMy BufferedStream code is available at https://github.com/chris-morgan/rust-http/blob/f78236284b73ba5e980962b1ffbd71ea9a03fbbc/src/libhttp/buffer.rs\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23839865/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23869455",
    "html_url": "https://github.com/rust-lang/rust/issues/8953#issuecomment-23869455",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8953",
    "id": 23869455,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODY5NDU1",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-05T14:00:34Z",
    "updated_at": "2013-09-05T14:00:34Z",
    "body": "CM, do you need to implement BufferedStream separately, you can just let the Writer trait pass through the reader buffer?\n\n```\npub struct ReadBuffer<R> {\n    priv reader: R,\n    priv buffer: ~[u8],\n    priv lo: uint,\n    priv hi: uint,\n}\n\nimpl<R> Decorator<R> for ReadBuffer<R> {\n    fn inner(self) -> R { self.reader }\n    fn inner_ref<'a>(&'a self) -> &'a R { &self.reader }\n    fn inner_mut_ref<'a>(&'a mut self) -> &'a mut R { &mut self.reader }\n}\n\nimpl<W: Writer> Writer for ReadBuffer<W> {\n    fn write(&mut self, buf: &[u8]) {\n        self.inner_mut_ref().write(buf)\n    }\n    fn flush(&mut self) {\n        self.inner_mut_ref().flush()\n    }\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23869455/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23871071",
    "html_url": "https://github.com/rust-lang/rust/issues/8953#issuecomment-23871071",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8953",
    "id": 23871071,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODcxMDcx",
    "user": {
      "login": "chris-morgan",
      "id": 392868,
      "node_id": "MDQ6VXNlcjM5Mjg2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/392868?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chris-morgan",
      "html_url": "https://github.com/chris-morgan",
      "followers_url": "https://api.github.com/users/chris-morgan/followers",
      "following_url": "https://api.github.com/users/chris-morgan/following{/other_user}",
      "gists_url": "https://api.github.com/users/chris-morgan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chris-morgan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chris-morgan/subscriptions",
      "organizations_url": "https://api.github.com/users/chris-morgan/orgs",
      "repos_url": "https://api.github.com/users/chris-morgan/repos",
      "events_url": "https://api.github.com/users/chris-morgan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chris-morgan/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-05T14:22:32Z",
    "updated_at": "2013-09-05T14:22:32Z",
    "body": "@blake2-ppc BufferedStream must buffer both reading and writing. Still, what you suggest sounds a good way of achieving buffering of just reading or just writing.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23871071/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23871144",
    "html_url": "https://github.com/rust-lang/rust/issues/8953#issuecomment-23871144",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8953",
    "id": 23871144,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODcxMTQ0",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-05T14:23:20Z",
    "updated_at": "2013-09-05T14:23:20Z",
    "body": "I mean that you can stack the BufferedWriter on top of the BufferedReader this way, without having to implement BufferedStream separately.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23871144/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23872095",
    "html_url": "https://github.com/rust-lang/rust/issues/8953#issuecomment-23872095",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8953",
    "id": 23872095,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODcyMDk1",
    "user": {
      "login": "olsonjeffery",
      "id": 10408,
      "node_id": "MDQ6VXNlcjEwNDA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/10408?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/olsonjeffery",
      "html_url": "https://github.com/olsonjeffery",
      "followers_url": "https://api.github.com/users/olsonjeffery/followers",
      "following_url": "https://api.github.com/users/olsonjeffery/following{/other_user}",
      "gists_url": "https://api.github.com/users/olsonjeffery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/olsonjeffery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/olsonjeffery/subscriptions",
      "organizations_url": "https://api.github.com/users/olsonjeffery/orgs",
      "repos_url": "https://api.github.com/users/olsonjeffery/repos",
      "events_url": "https://api.github.com/users/olsonjeffery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/olsonjeffery/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-05T14:35:29Z",
    "updated_at": "2013-09-05T14:35:29Z",
    "body": "@chris-morgan +1 I think it's great that you already have this code set aside and I think it's worth getting into the rust tree as-is (to relieve you of the burden of carrying it in `rust-http`, if anything).\n\nWith that being said, while looking this over something occurred to me: is it worth considering that we break `Reader` & and `Writer` into buffered/unbuffered equivalents and that this buffered implementation, as Chris presents it, would be pushed into `uvio` and exposed by an `Rtio` trait?\n\nIf we look forward to platform-backed implementations for everything in `rt::io` (that is, bsd sockets or win32 instead of libuv for everything in `rt::io::net` & the equiv. per-platform APIs for `file`, `timer`, etc), we could imagine (in the world of files, at least) a `BufferedStream` being implemented using a `FILE*` handle + `fread(3)` et al, while an `UnbufferedStream` uses a file descriptor + `pread(2)` and friends.\n\nThe drawback to this approach, of course, is that the buffering code is duplicated in multiple places in `uvio` or anywhere that doesn't have a platform-level buffering API. In this world, we would have `BufferedTcpStream`, `BufferedFileStream`, etc as user-facing constructs, with backing `Rtio` traits. Chris's `BufferedStream` would be re-used internally within `uvio` (really, it's generally applicable for any underlying implementation that doesn't have a platform-level buffered IO api for the thing we're mapping).\n\nThis may be worthy of breaking out into a separate ticket, and there's certainly an argument against what I'm proposing (as Chris has presented this solution, a `BufferedStream` can wrap anything that impls `Reader+Writer` or `Stream`).\n\nAnd based on my current read of `rt::io` (someone correct me if I'm mistaken), we would lose the ability to expose both `fread` and `pread` in a platform-backed implementation of `rt::io::file`. Not sure how important that loss is, but what I suggest above is a legitimate way to address it.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23872095/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23872754",
    "html_url": "https://github.com/rust-lang/rust/issues/8953#issuecomment-23872754",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8953",
    "id": 23872754,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODcyNzU0",
    "user": {
      "login": "chris-morgan",
      "id": 392868,
      "node_id": "MDQ6VXNlcjM5Mjg2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/392868?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chris-morgan",
      "html_url": "https://github.com/chris-morgan",
      "followers_url": "https://api.github.com/users/chris-morgan/followers",
      "following_url": "https://api.github.com/users/chris-morgan/following{/other_user}",
      "gists_url": "https://api.github.com/users/chris-morgan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chris-morgan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chris-morgan/subscriptions",
      "organizations_url": "https://api.github.com/users/chris-morgan/orgs",
      "repos_url": "https://api.github.com/users/chris-morgan/repos",
      "events_url": "https://api.github.com/users/chris-morgan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chris-morgan/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-05T14:43:48Z",
    "updated_at": "2013-09-05T14:43:48Z",
    "body": "@blake2-ppc yep, after this and discussion in IRC I get what's being meant. Yes, that would work, with `type BufferedStream<T> = BufferedReader<BufferedWriter<T>>`. The exception is if we need any `BufferedStream::*`; then that can't be done, to the best of my knowledge.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23872754/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
