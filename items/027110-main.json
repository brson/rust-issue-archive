{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/27110",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/27110/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/27110/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/27110/events",
  "html_url": "https://github.com/rust-lang/rust/pull/27110",
  "id": 95835178,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NDAyOTM4NzI=",
  "number": 27110,
  "title": "Optimize Integer formatting/parsing",
  "user": {
    "login": "arthurprs",
    "id": 715958,
    "node_id": "MDQ6VXNlcjcxNTk1OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/715958?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/arthurprs",
    "html_url": "https://github.com/arthurprs",
    "followers_url": "https://api.github.com/users/arthurprs/followers",
    "following_url": "https://api.github.com/users/arthurprs/following{/other_user}",
    "gists_url": "https://api.github.com/users/arthurprs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/arthurprs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/arthurprs/subscriptions",
    "organizations_url": "https://api.github.com/users/arthurprs/orgs",
    "repos_url": "https://api.github.com/users/arthurprs/repos",
    "events_url": "https://api.github.com/users/arthurprs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/arthurprs/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "huonw",
    "id": 1203825,
    "node_id": "MDQ6VXNlcjEyMDM4MjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/huonw",
    "html_url": "https://github.com/huonw",
    "followers_url": "https://api.github.com/users/huonw/followers",
    "following_url": "https://api.github.com/users/huonw/following{/other_user}",
    "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
    "organizations_url": "https://api.github.com/users/huonw/orgs",
    "repos_url": "https://api.github.com/users/huonw/repos",
    "events_url": "https://api.github.com/users/huonw/events{/privacy}",
    "received_events_url": "https://api.github.com/users/huonw/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 22,
  "created_at": "2015-07-18T15:47:53Z",
  "updated_at": "2015-07-19T20:39:46Z",
  "closed_at": "2015-07-19T20:39:46Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/27110",
    "html_url": "https://github.com/rust-lang/rust/pull/27110",
    "diff_url": "https://github.com/rust-lang/rust/pull/27110.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/27110.patch",
    "merged_at": "2015-07-19T20:39:46Z"
  },
  "body": "I wrote a reasonably optimized version for both functions. Further optimizations are possible but I tried to keep the code size small (which I think is important), it's a road of diminished gains.\n\nThe repository used for testing/benchmarks is https://github.com/arthurprs/rust-optimized-inttostr\n\nBenchmarks are ran for 3 different distributions, bellow are string length histograms for the u32 type\n- _h (big numbers skew)\n  [0, 0, 5, 29, 103, 212, 551, 1138, 1887, 3196, 2879]\n- _m (slight small number skew):\n  [0, 2807, 1334, 1057, 905, 821, 772, 707, 627, 605, 365]\n- _l (small numbers skew):\n  [0, 8004, 567, 351, 248, 212, 170, 126, 136, 112, 74]\n\nTested processors are\n- x64 laptop (i7-2670QM)\n- x32 server (Digital Ocean E5-2630L-v2)\n### Display\n\nIt uses a small look up table (200 bytes) and decode up to 4 characters at a time. I also took special precautions to reduce 64bit arithmetic on 32bit architectures and the gains are huge in these cases.\n\nOverall, on modern 64bit CPUs it's pretty much the same speed as the stdlib implementation for very small numbers (0..99), but pulls ahead as the length of the decimal increases. On slight older CPUs (w/ worse ALUs) or 32bit architectures it's pretty much always faster.\n\nx64 benchmarks\n\n```\ntest bench::display_h_new_u08     ... bench:      71,041 ns/iter (+/- 2,894)\ntest bench::display_h_new_u16     ... bench:     378,255 ns/iter (+/- 36,547)\ntest bench::display_h_new_u32     ... bench:   4,232,483 ns/iter (+/- 509,661)\ntest bench::display_h_new_u64     ... bench:   5,166,740 ns/iter (+/- 421,124)\ntest bench::display_h_stdlib_u08  ... bench:      73,536 ns/iter (+/- 5,287)\ntest bench::display_h_stdlib_u16  ... bench:     451,443 ns/iter (+/- 16,879)\ntest bench::display_h_stdlib_u32  ... bench:   5,551,070 ns/iter (+/- 518,151)\ntest bench::display_h_stdlib_u64  ... bench:   8,624,374 ns/iter (+/- 643,701)\ntest bench::display_l_new_u08     ... bench:      71,547 ns/iter (+/- 504)\ntest bench::display_l_new_u16     ... bench:     399,727 ns/iter (+/- 28,030)\ntest bench::display_l_new_u32     ... bench:   4,365,303 ns/iter (+/- 414,414)\ntest bench::display_l_new_u64     ... bench:   5,302,382 ns/iter (+/- 292,324)\ntest bench::display_l_stdlib_u08  ... bench:      75,445 ns/iter (+/- 2,487)\ntest bench::display_l_stdlib_u16  ... bench:     444,313 ns/iter (+/- 16,203)\ntest bench::display_l_stdlib_u32  ... bench:   5,761,801 ns/iter (+/- 387,186)\ntest bench::display_l_stdlib_u64  ... bench:   8,790,365 ns/iter (+/- 614,846)\ntest bench::display_m_new_u08     ... bench:      71,820 ns/iter (+/- 2,956)\ntest bench::display_m_new_u16     ... bench:     399,649 ns/iter (+/- 20,643)\ntest bench::display_m_new_u32     ... bench:   4,355,561 ns/iter (+/- 179,189)\ntest bench::display_m_new_u64     ... bench:   5,070,594 ns/iter (+/- 341,950)\ntest bench::display_m_stdlib_u08  ... bench:      74,900 ns/iter (+/- 1,909)\ntest bench::display_m_stdlib_u16  ... bench:     448,788 ns/iter (+/- 20,791)\ntest bench::display_m_stdlib_u32  ... bench:   5,717,939 ns/iter (+/- 316,824)\ntest bench::display_m_stdlib_u64  ... bench:   8,787,160 ns/iter (+/- 482,864)\n```\n\nx86 benchmarks\n\n```\ntest bench::display_h_new_u08     ... bench:      94,246 ns/iter (+/- 34,872)\ntest bench::display_h_new_u16     ... bench:     533,805 ns/iter (+/- 22,499)\ntest bench::display_h_new_u32     ... bench:   6,127,747 ns/iter (+/- 2,192,789)\ntest bench::display_h_new_u64     ... bench:  14,994,203 ns/iter (+/- 1,609,345)\ntest bench::display_h_stdlib_u08  ... bench:     107,233 ns/iter (+/- 8,571)\ntest bench::display_h_stdlib_u16  ... bench:     631,186 ns/iter (+/- 11,332)\ntest bench::display_h_stdlib_u32  ... bench:   7,696,344 ns/iter (+/- 957,917)\ntest bench::display_h_stdlib_u64  ... bench:  45,677,401 ns/iter (+/- 4,991,344)\ntest bench::display_l_new_u08     ... bench:      95,855 ns/iter (+/- 27,735)\ntest bench::display_l_new_u16     ... bench:     532,084 ns/iter (+/- 40,479)\ntest bench::display_l_new_u32     ... bench:   5,973,953 ns/iter (+/- 211,676)\ntest bench::display_l_new_u64     ... bench:  14,773,064 ns/iter (+/- 1,276,579)\ntest bench::display_l_stdlib_u08  ... bench:     106,350 ns/iter (+/- 63,963)\ntest bench::display_l_stdlib_u16  ... bench:     637,746 ns/iter (+/- 101,005)\ntest bench::display_l_stdlib_u32  ... bench:   7,740,640 ns/iter (+/- 848,478)\ntest bench::display_l_stdlib_u64  ... bench:  44,846,932 ns/iter (+/- 4,514,694)\ntest bench::display_m_new_u08     ... bench:      94,549 ns/iter (+/- 13,029)\ntest bench::display_m_new_u16     ... bench:     546,030 ns/iter (+/- 35,804)\ntest bench::display_m_new_u32     ... bench:   5,983,924 ns/iter (+/- 1,180,559)\ntest bench::display_m_new_u64     ... bench:  14,817,873 ns/iter (+/- 2,271,464)\ntest bench::display_m_stdlib_u08  ... bench:     107,806 ns/iter (+/- 8,805)\ntest bench::display_m_stdlib_u16  ... bench:     630,714 ns/iter (+/- 6,586)\ntest bench::display_m_stdlib_u32  ... bench:   7,784,210 ns/iter (+/- 358,601)\ntest bench::display_m_stdlib_u64  ... bench:  46,223,927 ns/iter (+/- 6,553,176)\n```\n### from_str_radix (FromStr)\n\nAll valid digits are ascii so I modified the function to use the underlining bytes instead and simplified the match to avoid wasting cycles.\n\nx64 benchmarks\n\n```\ntest bench::from_str_h_new_u08    ... bench:      28,153 ns/iter (+/- 624)\ntest bench::from_str_h_new_u16    ... bench:     223,513 ns/iter (+/- 11,554)\ntest bench::from_str_h_new_u32    ... bench:   3,098,935 ns/iter (+/- 231,022)\ntest bench::from_str_h_new_u64    ... bench:   5,009,900 ns/iter (+/- 341,961)\ntest bench::from_str_h_stdlib_u08 ... bench:      34,033 ns/iter (+/- 2,068)\ntest bench::from_str_h_stdlib_u16 ... bench:     248,785 ns/iter (+/- 14,208)\ntest bench::from_str_h_stdlib_u32 ... bench:   4,150,536 ns/iter (+/- 266,070)\ntest bench::from_str_h_stdlib_u64 ... bench:   6,817,997 ns/iter (+/- 449,838)\ntest bench::from_str_l_new_u08    ... bench:      27,552 ns/iter (+/- 1,500)\ntest bench::from_str_l_new_u16    ... bench:     234,360 ns/iter (+/- 13,144)\ntest bench::from_str_l_new_u32    ... bench:   3,140,261 ns/iter (+/- 248,175)\ntest bench::from_str_l_new_u64    ... bench:   5,176,583 ns/iter (+/- 350,416)\ntest bench::from_str_l_stdlib_u08 ... bench:      35,060 ns/iter (+/- 2,154)\ntest bench::from_str_l_stdlib_u16 ... bench:     252,135 ns/iter (+/- 23,461)\ntest bench::from_str_l_stdlib_u32 ... bench:   4,154,599 ns/iter (+/- 369,606)\ntest bench::from_str_l_stdlib_u64 ... bench:   6,892,767 ns/iter (+/- 213,030)\ntest bench::from_str_m_new_u08    ... bench:      28,252 ns/iter (+/- 1,384)\ntest bench::from_str_m_new_u16    ... bench:     231,051 ns/iter (+/- 16,540)\ntest bench::from_str_m_new_u32    ... bench:   3,166,504 ns/iter (+/- 134,418)\ntest bench::from_str_m_new_u64    ... bench:   5,103,195 ns/iter (+/- 218,912)\ntest bench::from_str_m_stdlib_u08 ... bench:      35,012 ns/iter (+/- 2,735)\ntest bench::from_str_m_stdlib_u16 ... bench:     250,967 ns/iter (+/- 14,708)\ntest bench::from_str_m_stdlib_u32 ... bench:   4,101,845 ns/iter (+/- 205,802)\ntest bench::from_str_m_stdlib_u64 ... bench:   6,823,001 ns/iter (+/- 267,215)\n```\n\nx86 benchmarks\n\n```\ntest bench::from_str_h_new_u08    ... bench:      23,682 ns/iter (+/- 3,590)\ntest bench::from_str_h_new_u16    ... bench:     190,916 ns/iter (+/- 29,688)\ntest bench::from_str_h_new_u32    ... bench:   2,649,952 ns/iter (+/- 308,576)\ntest bench::from_str_h_new_u64    ... bench:  23,458,434 ns/iter (+/- 2,327,427)\ntest bench::from_str_h_stdlib_u08 ... bench:      45,551 ns/iter (+/- 6,968)\ntest bench::from_str_h_stdlib_u16 ... bench:     313,739 ns/iter (+/- 17,175)\ntest bench::from_str_h_stdlib_u32 ... bench:   4,615,669 ns/iter (+/- 470,766)\ntest bench::from_str_h_stdlib_u64 ... bench:  30,589,482 ns/iter (+/- 2,278,996)\ntest bench::from_str_l_new_u08    ... bench:      23,763 ns/iter (+/- 5,545)\ntest bench::from_str_l_new_u16    ... bench:     185,472 ns/iter (+/- 33,097)\ntest bench::from_str_l_new_u32    ... bench:   2,691,307 ns/iter (+/- 473,886)\ntest bench::from_str_l_new_u64    ... bench:  22,952,593 ns/iter (+/- 1,963,742)\ntest bench::from_str_l_stdlib_u08 ... bench:      45,285 ns/iter (+/- 16,337)\ntest bench::from_str_l_stdlib_u16 ... bench:     313,624 ns/iter (+/- 6,643)\ntest bench::from_str_l_stdlib_u32 ... bench:   4,595,679 ns/iter (+/- 1,876,361)\ntest bench::from_str_l_stdlib_u64 ... bench:  30,434,683 ns/iter (+/- 1,901,996)\ntest bench::from_str_m_new_u08    ... bench:      23,812 ns/iter (+/- 1,505)\ntest bench::from_str_m_new_u16    ... bench:     185,553 ns/iter (+/- 19,788)\ntest bench::from_str_m_new_u32    ... bench:   2,614,920 ns/iter (+/- 66,230)\ntest bench::from_str_m_new_u64    ... bench:  23,241,778 ns/iter (+/- 3,474,077)\ntest bench::from_str_m_stdlib_u08 ... bench:      45,634 ns/iter (+/- 1,436)\ntest bench::from_str_m_stdlib_u16 ... bench:     316,479 ns/iter (+/- 21,212)\ntest bench::from_str_m_stdlib_u32 ... bench:   4,609,147 ns/iter (+/- 487,068)\ntest bench::from_str_m_stdlib_u64 ... bench:  30,165,173 ns/iter (+/- 1,601,830)\n```\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/27110/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/27110/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
