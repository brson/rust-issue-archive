{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/5975",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/5975/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/5975/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/5975/events",
  "html_url": "https://github.com/rust-lang/rust/pull/5975",
  "id": 13437488,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NTI3NTUyMQ==",
  "number": 5975,
  "title": "Allow intrinsics to use #[fixed_stack_segment], and use it for numeric intrinsics",
  "user": {
    "login": "huonw",
    "id": 1203825,
    "node_id": "MDQ6VXNlcjEyMDM4MjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/huonw",
    "html_url": "https://github.com/huonw",
    "followers_url": "https://api.github.com/users/huonw/followers",
    "following_url": "https://api.github.com/users/huonw/following{/other_user}",
    "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
    "organizations_url": "https://api.github.com/users/huonw/orgs",
    "repos_url": "https://api.github.com/users/huonw/repos",
    "events_url": "https://api.github.com/users/huonw/events{/privacy}",
    "received_events_url": "https://api.github.com/users/huonw/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 3,
  "created_at": "2013-04-20T16:00:05Z",
  "updated_at": "2014-06-15T19:30:24Z",
  "closed_at": "2013-04-20T19:45:48Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/5975",
    "html_url": "https://github.com/rust-lang/rust/pull/5975",
    "diff_url": "https://github.com/rust-lang/rust/pull/5975.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/5975.patch",
    "merged_at": null
  },
  "body": "This implements the fixed_stack_segment for items with the rust-intrinsic abi, and then uses it to make f32 and f64 use intrinsics where appropriate, but without overflowing stacks and killing canaries (cf. #5686 and #5697). Hopefully.\n\n@pcwalton, the fixed_stack_segment implementation involved mirroring its implementation in `base.rs` in `trans_closure`, but without adding the `set_no_inline` (reasoning: that would defeat the purpose of intrinsics), which is possibly incorrect.\n\nI'm a little hazy about how the underlying structure works, so I've annotated the 4 that have caused problems so far, but there's no guarantee that the other intrinsics are entirely well-behaved.\n\nAnyway, it has good results (the following are just summing the result of each function for 1 up to 100 million):\n\n```\n$ ./intrinsics-perf.sh f32\nfunc   new   old   speedup\nsin    0.80  2.75  3.44\ncos    0.80  2.76  3.45\nsqrt   0.56  2.73  4.88\nln     1.01  2.94  2.91\nlog10  0.97  2.90  2.99\nlog2   1.01  2.95  2.92\nexp    0.90  2.85  3.17\nexp2   0.92  2.87  3.12\npow    6.95  8.57  1.23\n\n   geometric mean: 2.97\n\n$ ./intrinsics-perf.sh f64\nfunc   new   old   speedup\nsin    12.08  14.06  1.16\ncos    12.04  13.67  1.14\nsqrt   0.49  2.73  5.57\nln     4.11  5.59  1.36\nlog10  5.09  6.54  1.28\nlog2   2.78  5.10  1.83\nexp    2.00  3.97  1.99\nexp2   1.71  3.71  2.17\npow    5.90  7.51  1.27\n\n   geometric mean: 1.72\n```\n\nSo about 3x faster on average for f32, and 1.7x for f64. This isn't exactly apples to apples though, since this patch also adds #[inline(always)] to all the function definitions too, which possibly gives a speedup.\n\n(fwiw, GitHub is showing 93c0888 after d9c54f8 (since I cherry-picked the latter from #5697), but git's order is the other way.)\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/5975/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/5975/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
