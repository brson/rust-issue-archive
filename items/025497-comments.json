[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102671934",
    "html_url": "https://github.com/rust-lang/rust/issues/25497#issuecomment-102671934",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/25497",
    "id": 102671934,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEwMjY3MTkzNA==",
    "user": {
      "login": "luqmana",
      "id": 287063,
      "node_id": "MDQ6VXNlcjI4NzA2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luqmana",
      "html_url": "https://github.com/luqmana",
      "followers_url": "https://api.github.com/users/luqmana/followers",
      "following_url": "https://api.github.com/users/luqmana/following{/other_user}",
      "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions",
      "organizations_url": "https://api.github.com/users/luqmana/orgs",
      "repos_url": "https://api.github.com/users/luqmana/repos",
      "events_url": "https://api.github.com/users/luqmana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luqmana/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-05-16T19:59:41Z",
    "updated_at": "2015-05-16T20:21:41Z",
    "body": "Reduced it a bit: http://is.gd/nkopPR\n\n``` Rust\n#![allow(dead_code)]\n\n#[derive(Clone)]\nenum Expression {\n    Dummy,\n    Add(Box<Expression>),\n}\n\nuse Expression::*;\n\nfn simplify(exp: Expression) -> Expression {\n    match exp {\n        Add(n) => *n.clone(),\n        _ => Dummy\n    }\n}\n\nfn main() {}\n```\n\n```\nInstruction does not dominate all uses!\n  %9 = load i8*** %1, align 8, !nonnull !0\n  %16 = bitcast i8** %9 to i8*\nLLVM ERROR: Broken function found, compilation aborted!\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102671934/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102679376",
    "html_url": "https://github.com/rust-lang/rust/issues/25497#issuecomment-102679376",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/25497",
    "id": 102679376,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEwMjY3OTM3Ng==",
    "user": {
      "login": "luqmana",
      "id": 287063,
      "node_id": "MDQ6VXNlcjI4NzA2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luqmana",
      "html_url": "https://github.com/luqmana",
      "followers_url": "https://api.github.com/users/luqmana/followers",
      "following_url": "https://api.github.com/users/luqmana/following{/other_user}",
      "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions",
      "organizations_url": "https://api.github.com/users/luqmana/orgs",
      "repos_url": "https://api.github.com/users/luqmana/repos",
      "events_url": "https://api.github.com/users/luqmana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luqmana/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-05-16T20:18:54Z",
    "updated_at": "2015-05-16T20:18:54Z",
    "body": "The broken IR:\n\n``` llvm\n*** IR Dump Before Module Verifier ***\n; Function Attrs: uwtable\ndefine internal i8* @_ZN8simplify20h85a1e2ef0fe110d4SaaE(i8*) unnamed_addr #4 {\nentry-block:\n  %sret_slot = alloca i8*\n  %exp = alloca i8*\n  %n = alloca i8***\n  %1 = alloca i8**\n  %2 = alloca { i8*, i32 }\n  store i8* %0, i8** %exp, align 8\n  %3 = load i8** %exp\n  %4 = icmp ne i8* %3, null\n  switch i1 %4, label %match_else [\n    i1 true, label %match_case\n  ]\n\ncase_body:                                        ; preds = %match_case\n  %5 = load i8**** %n\n  %6 = invoke noalias dereferenceable(8) i8** @\"_ZN5boxed18Box$LT$T$GT$.Clone5clone21h17263907606676917116E\"(i8*** noalias readonly dereferenceable(8) %5)\n          to label %normal-return unwind label %unwind_custom_\n\ncase_body1:                                       ; preds = %match_else\n  %7 = bitcast i8** %sret_slot to i8*\n  call void @llvm.memcpy.p0i8.p0i8.i64(i8* %7, i8* bitcast (i8** @const861 to i8*), i64 8, i32 8, i1 false)\n  br label %join\n\nmatch_else:                                       ; preds = %entry-block\n  br label %case_body1\n\nmatch_case:                                       ; preds = %entry-block\n  %8 = bitcast i8** %exp to i8***\n  store i8*** %8, i8**** %n\n  br label %case_body\n\nnormal-return:                                    ; preds = %case_body\n  store i8** %6, i8*** %1, align 8\n  %9 = load i8*** %1, align 8, !nonnull !0\n  %10 = bitcast i8** %9 to i8*\n  %11 = bitcast i8** %sret_slot to i8*\n  call void @llvm.memcpy.p0i8.p0i8.i64(i8* %11, i8* %10, i64 8, i32 8, i1 false)\n  call void @\"_ZN21Box$LT$Expression$GT$9drop.112917hd039fb3d1a2bcdceE\"(i8*** %5)\n  %12 = bitcast i8*** %5 to i8*\n  call void @llvm.memset.p0i8.i64(i8* %12, i8 29, i64 8, i32 8, i1 false)\n  br label %join\n\nunwind_custom_:                                   ; preds = %case_body\n  %13 = landingpad { i8*, i32 } personality i32 (i32, i32, i64, %\"1.std::rt::libunwind::_Unwind_Exception\"*, %\"1.std::rt::libunwind::_Unwind_Context\"*)* @rust_eh_personality\n          cleanup\n  store { i8*, i32 } %13, { i8*, i32 }* %2\n  br label %clean_custom_2\n\nresume:                                           ; preds = %clean_custom_\n  %14 = load { i8*, i32 }* %2\n  resume { i8*, i32 } %14\n\nclean_custom_:                                    ; preds = %unwind_custom_4, %clean_custom_2\n  call void @_ZN10Expression9drop.112617h851faf19442a2b98E(i8** %exp)\n  br label %resume\n\nclean_custom_2:                                   ; preds = %unwind_custom_\n  call void @\"_ZN21Box$LT$Expression$GT$9drop.112917hd039fb3d1a2bcdceE\"(i8*** %5)\n  %15 = bitcast i8*** %5 to i8*\n  call void @llvm.memset.p0i8.i64(i8* %15, i8 29, i64 8, i32 8, i1 false)\n  br label %clean_custom_\n\njoin:                                             ; preds = %case_body1, %normal-return\n  %16 = bitcast i8** %9 to i8*\n  invoke void @_ZN4heap13exchange_free20h10b00cb3f415f504kfaE(i8* %16, i64 8, i64 8)\n          to label %normal-return3 unwind label %unwind_custom_4\n\nnormal-return3:                                   ; preds = %join\n  call void @_ZN10Expression9drop.112617h851faf19442a2b98E(i8** %exp)\n  %17 = load i8** %sret_slot, align 8\n  ret i8* %17\n\nunwind_custom_4:                                  ; preds = %join\n  %18 = landingpad { i8*, i32 } personality i32 (i32, i32, i64, %\"1.std::rt::libunwind::_Unwind_Exception\"*, %\"1.std::rt::libunwind::_Unwind_Context\"*)* @rust_eh_personality\n          cleanup\n  store { i8*, i32 } %18, { i8*, i32 }* %2\n  br label %clean_custom_\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102679376/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102684977",
    "html_url": "https://github.com/rust-lang/rust/issues/25497#issuecomment-102684977",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/25497",
    "id": 102684977,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEwMjY4NDk3Nw==",
    "user": {
      "login": "luqmana",
      "id": 287063,
      "node_id": "MDQ6VXNlcjI4NzA2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luqmana",
      "html_url": "https://github.com/luqmana",
      "followers_url": "https://api.github.com/users/luqmana/followers",
      "following_url": "https://api.github.com/users/luqmana/following{/other_user}",
      "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions",
      "organizations_url": "https://api.github.com/users/luqmana/orgs",
      "repos_url": "https://api.github.com/users/luqmana/repos",
      "events_url": "https://api.github.com/users/luqmana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luqmana/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-05-16T20:29:07Z",
    "updated_at": "2015-05-16T20:29:07Z",
    "body": "Looking through it quickly, it seems like the order of the cleanups is messed up? If `exp` is `Dummy` then from the switch we go to the `%match_else` label which just jumps to `%case_body1` where we memcpy the value for `Dummy` into the `sret_slot` alloca and then continue to the `%join` label. This is where the problem is since it tries to call `heap::exchange_free` on the value returned from `boxed::Box<T>.Clone::clone`. But that's the thing, we wouldn't have called `clone` in that arm of the branch and hence shouldn't need to call free either.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102684977/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102686166",
    "html_url": "https://github.com/rust-lang/rust/issues/25497#issuecomment-102686166",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/25497",
    "id": 102686166,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEwMjY4NjE2Ng==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-05-16T20:34:16Z",
    "updated_at": "2015-05-16T20:34:16Z",
    "body": "Adding a block around `*n.clone()` suppresses the error. I feel like we had a similar problem not too long ago.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102686166/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102824834",
    "html_url": "https://github.com/rust-lang/rust/issues/25497#issuecomment-102824834",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/25497",
    "id": 102824834,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEwMjgyNDgzNA==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-05-17T17:28:40Z",
    "updated_at": "2015-05-17T17:28:40Z",
    "body": "This is \"caused\" by the micro optimization for dereferencing owned pointer rvalues in `expr::deref_once::deref_owned_pointer`. Since `*n.clone()` is the \"trailing\" expression for the arm its cleanup will be scheduled in the same scope as the match expression.\n\ncc @nikomatsakis \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/102824834/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/103661988",
    "html_url": "https://github.com/rust-lang/rust/issues/25497#issuecomment-103661988",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/25497",
    "id": 103661988,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEwMzY2MTk4OA==",
    "user": {
      "login": "ghost",
      "id": 10137,
      "node_id": "MDQ6VXNlcjEwMTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ghost",
      "html_url": "https://github.com/ghost",
      "followers_url": "https://api.github.com/users/ghost/followers",
      "following_url": "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
      "organizations_url": "https://api.github.com/users/ghost/orgs",
      "repos_url": "https://api.github.com/users/ghost/repos",
      "events_url": "https://api.github.com/users/ghost/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ghost/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-05-19T20:39:23Z",
    "updated_at": "2015-05-19T20:39:23Z",
    "body": "Either way, this is a dupe of https://github.com/rust-lang/rust/issues/18845. I believe @eddyb had an idea for a fix.\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/103661988/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/103670343",
    "html_url": "https://github.com/rust-lang/rust/issues/25497#issuecomment-103670343",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/25497",
    "id": 103670343,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEwMzY3MDM0Mw==",
    "user": {
      "login": "eddyb",
      "id": 77424,
      "node_id": "MDQ6VXNlcjc3NDI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eddyb",
      "html_url": "https://github.com/eddyb",
      "followers_url": "https://api.github.com/users/eddyb/followers",
      "following_url": "https://api.github.com/users/eddyb/following{/other_user}",
      "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions",
      "organizations_url": "https://api.github.com/users/eddyb/orgs",
      "repos_url": "https://api.github.com/users/eddyb/repos",
      "events_url": "https://api.github.com/users/eddyb/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eddyb/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-05-19T21:22:20Z",
    "updated_at": "2015-05-19T21:22:20Z",
    "body": "@jakub- it's simple, we ~~kill~~ remove the micro-optimization and always return an `Lvalue` datum from `expr::deref_once`.\nThe possibility of returning `Rvalue` datum also caused issues with field accesses - see #25595 for that fix.\n\nWe have a static type system and the `Lvalue`/`Rvalue` marker types are there for a reason.\nIf there is no answer to \"how is an rvalue dereference or field meaningful?\", then the return type for both of those should be `Datum<Lvalue>`.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/103670343/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
