[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/110455274",
    "html_url": "https://github.com/rust-lang/rust/issues/26128#issuecomment-110455274",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26128",
    "id": 110455274,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMDQ1NTI3NA==",
    "user": {
      "login": "aturon",
      "id": 709807,
      "node_id": "MDQ6VXNlcjcwOTgwNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/709807?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aturon",
      "html_url": "https://github.com/aturon",
      "followers_url": "https://api.github.com/users/aturon/followers",
      "following_url": "https://api.github.com/users/aturon/following{/other_user}",
      "gists_url": "https://api.github.com/users/aturon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aturon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aturon/subscriptions",
      "organizations_url": "https://api.github.com/users/aturon/orgs",
      "repos_url": "https://api.github.com/users/aturon/repos",
      "events_url": "https://api.github.com/users/aturon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aturon/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-09T18:25:35Z",
    "updated_at": "2015-06-09T18:25:35Z",
    "body": "triage: I-nominated\n\nThe compiler team may want to look at prioritizing improvements here.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/110455274/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/110513805",
    "html_url": "https://github.com/rust-lang/rust/issues/26128#issuecomment-110513805",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26128",
    "id": 110513805,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMDUxMzgwNQ==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-09T21:45:54Z",
    "updated_at": "2015-06-09T21:45:54Z",
    "body": "Checking for discriminant equality before the match statement allows LLVM to optimize the code quite a bit better, but doesn't always give optimal results (still better than what we currently get though).\n\nFor cases where we have e.g. a large number of equal match arms, it would be great if we could translate/expand them as \n\n``` rust\nmatch x {\n    A(v) | B(v) | C(v) => thing1(v),\n    X | Y | Z => thing2(),\n}\n```\n\ninstead of the current\n\n``` rust\nmatch x {\n    A(v) => thing1(v),\n    B(v) => thing1(v),\n    C(v) => thing1(v),\n    X => thing2(),\n    Y => thing2(),\n    Z => thing2(),\n}\n```\n\nbecause that makes it a lot easier for llvm properly optimize the code. I never got around to understand the generic deriving and/or match codegen enough to see if we can do that though.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/110513805/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111509863",
    "html_url": "https://github.com/rust-lang/rust/issues/26128#issuecomment-111509863",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26128",
    "id": 111509863,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMTUwOTg2Mw==",
    "user": {
      "login": "Marwes",
      "id": 957312,
      "node_id": "MDQ6VXNlcjk1NzMxMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/957312?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Marwes",
      "html_url": "https://github.com/Marwes",
      "followers_url": "https://api.github.com/users/Marwes/followers",
      "following_url": "https://api.github.com/users/Marwes/following{/other_user}",
      "gists_url": "https://api.github.com/users/Marwes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Marwes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Marwes/subscriptions",
      "organizations_url": "https://api.github.com/users/Marwes/orgs",
      "repos_url": "https://api.github.com/users/Marwes/repos",
      "events_url": "https://api.github.com/users/Marwes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Marwes/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-12T14:20:04Z",
    "updated_at": "2015-06-14T11:46:06Z",
    "body": "I have done some work on this and assuming I did not mess up my tiny benchmark I currently have managed to get C-like enums  an 8x(!) speedup for PartialEq. Looking at the llvm IR it seems that it does handle the current generated code well at all so even if it should still be a hefty improvement.\n\nNon C-like enums currently get a 1.67x speedup as well but I think it might be possible to increase it further by generating some nastier deriving code to help llvm optimize it. Note that benchmarking non-C-like enums is really difficult to do fairly since the time depends massively on the data that is benchmarked.\n\nThe idea behind the improvements is to generate code like below.\n\n```\nlet __self0_vi = unsafe {\n    std::intrinsics::discriminant_value(&self) } as i32;\nlet __self1_vi = unsafe {\n    std::intrinsics::discriminant_value(&__arg1) } as i32;\nlet __self2_vi = unsafe {\n    std::intrinsics::discriminant_value(&__arg2) } as i32;\n...\n\nif __self0_vi == __self1_vi && __self0_vi == __self2_vi && ... {\n    match (...) {\n        (Variant1, Variant1, ...) => Body1\n        (Variant2, Variant2, ...) => Body2,\n        ...\n        _ => ::core::intrinsics::unreachable()\n    }\n}\nelse {\n    <delegated expression referring to __self0_vi, et al.>\n}\n\n```\n\nI will try to get some better numbers up later but I wanted to give a heads up if anyone else is working on it/thinking of working on it.\n\n### New deriving\n\n```\nrunning 2 tests\ntest test1 ... bench:    286720 ns/iter (+/- 48894)\ntest test2 ... bench:   2189368 ns/iter (+/- 730107)\n```\n\n##### IR for Test::eq\n\n```\n; Function Attrs: inlinehint nounwind readonly uwtable\ndefine zeroext i1 @_ZN26Test...std..cmp..PartialEq2eq20hcca4a1839d4d2498maaE(i8* noalias nocapture readonly dereferenceable(1), i8* noalias nocapture readonly dereferenceable(1)) unnamed_addr #0 {\nentry-block:\n  %2 = load i8* %0, align 1, !range !0\n  %3 = load i8* %1, align 1, !range !0\n  %4 = icmp eq i8 %2, %3\n  ret i1 %4\n}\n```\n\n### Old deriving\n\n```\nrunning 2 tests\ntest test1 ... bench:   2,387,520 ns/iter (+/- 110,106)\ntest test2 ... bench:   3,666,369 ns/iter (+/- 35,928)\n```\n\n##### IR for Test::eq\n\n```\n; Function Attrs: inlinehint nounwind readonly uwtable\ndefine zeroext i1 @_ZN26Test...std..cmp..PartialEq2eq20h54f0ffdc782fbe51maaE(i8* noalias nocapture readonly dereferenceable(1), i8* noalias nocapture readonly dereferenceable(1)) unnamed_addr #0 {\nentry-block:\n  %2 = load i8* %1, align 1, !range !0\n  switch i8 %2, label %join [\n    i8 0, label %match_case\n    i8 1, label %match_case8\n    i8 2, label %match_case11\n    i8 3, label %match_case14\n    i8 4, label %match_case17\n  ]\n\nmatch_case:                                       ; preds = %entry-block\n  %3 = load i8* %0, align 1, !range !0\n  %cond23 = icmp eq i8 %3, 0\n  br label %join\n\nmatch_case8:                                      ; preds = %entry-block\n  %4 = load i8* %0, align 1, !range !0\n  %cond22 = icmp eq i8 %4, 1\n  br label %join\n\nmatch_case11:                                     ; preds = %entry-block\n  %5 = load i8* %0, align 1, !range !0\n  %cond21 = icmp eq i8 %5, 2\n  br label %join\n\nmatch_case14:                                     ; preds = %entry-block\n  %6 = load i8* %0, align 1, !range !0\n  %cond20 = icmp eq i8 %6, 3\n  br label %join\n\nmatch_case17:                                     ; preds = %entry-block\n  %7 = load i8* %0, align 1, !range !0\n  %cond = icmp eq i8 %7, 4\n  ret i1 %cond\n\njoin:                                             ; preds = %match_case14, %match_case11, %match_case8, %match_case, %entry-block\n  %sret_slot.0 = phi i1 [ false, %entry-block ], [ %cond23, %match_case ], [ %cond22, %match_case8 ], [ %cond21, %match_case11 ], [ %cond20, %match_case14 ]\n  ret i1 %sret_slot.0\n}\n```\n\n``` rust\n#![feature(test, rand)]\nextern crate rand;\nextern crate test;\nuse rand::{Rand, Rng, SeedableRng, XorShiftRng};\n\n#[derive(PartialEq)]\nenum Test {\n    Variant1,\n    Variant2,\n    Variant3,\n    Variant4,\n    Variant5,\n}\n#[derive(PartialEq)]\nenum Test2 {\n    Variant1(i32, i32),\n    Variant2(f64),\n    Variant3,\n    Variant4(Vec<Test2>),\n    Variant5,\n}\n\nimpl Rand for Test {\n    fn rand<R: Rng> (r: &mut R) -> Test {\n        match r.gen_range(0, 5) {\n            0 => Test::Variant1,\n            1 => Test::Variant2,\n            2 => Test::Variant3,\n            3 => Test::Variant4,\n            4 => Test::Variant5,\n            _ => panic!()\n        }\n    }\n}\n\nimpl Rand for Test2 {\n    fn rand<R: Rng> (r: &mut R) -> Test2 {\n        match r.gen_range(0, 5) {\n            0 => Test2::Variant1(i32::rand(r), i32::rand(r)),\n            1 => Test2::Variant2(f64::rand(r)),\n            2 => Test2::Variant3,\n            3 => {\n                let i = r.gen_range(0, 10);\n                Test2::Variant4(r.gen_iter().take(i).collect())\n            }\n            4 => Test2::Variant5,\n            _ => panic!()\n        }\n    }\n}\n\n#[bench]\nfn test1(b: &mut ::test::Bencher) {\n    let mut rng: XorShiftRng = SeedableRng::from_seed([1,2,3,4]);\n    let values: Vec<Test> = rng.gen_iter().take(500).collect();\n    b.iter(|| {\n        for x in &values {\n            for y in &values {\n                ::test::black_box(x == y);\n            }\n        }\n    })\n}\n\n#[bench]\nfn test2(b: &mut ::test::Bencher) {\n    let mut rng: XorShiftRng = SeedableRng::from_seed([1,2,3,4]);\n    let values: Vec<Test2> = rng.gen_iter().take(500).collect();\n    b.iter(|| {\n        for x in &values {\n            for y in &values {\n                ::test::black_box(x == y);\n            }\n        }\n    })\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111509863/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111807909",
    "html_url": "https://github.com/rust-lang/rust/issues/26128#issuecomment-111807909",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26128",
    "id": 111807909,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMTgwNzkwOQ==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-14T10:01:52Z",
    "updated_at": "2015-06-14T10:01:52Z",
    "body": "That is very cool. Is it possible to improve the match code instead so that libraries don't have to write in these optimizations manually?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111807909/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111815567",
    "html_url": "https://github.com/rust-lang/rust/issues/26128#issuecomment-111815567",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26128",
    "id": 111815567,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMTgxNTU2Nw==",
    "user": {
      "login": "Marwes",
      "id": 957312,
      "node_id": "MDQ6VXNlcjk1NzMxMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/957312?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Marwes",
      "html_url": "https://github.com/Marwes",
      "followers_url": "https://api.github.com/users/Marwes/followers",
      "following_url": "https://api.github.com/users/Marwes/following{/other_user}",
      "gists_url": "https://api.github.com/users/Marwes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Marwes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Marwes/subscriptions",
      "organizations_url": "https://api.github.com/users/Marwes/orgs",
      "repos_url": "https://api.github.com/users/Marwes/repos",
      "events_url": "https://api.github.com/users/Marwes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Marwes/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-14T11:43:02Z",
    "updated_at": "2015-06-14T11:43:02Z",
    "body": "The optimization is rather specific in that it only applies when you have 2 or more enums where you wan't to branch on all of them being the same. I'm not sure how often this would apply and wether the matching could detect it.\n\nThe best way of solving it though would be if llvm could optimize any generated match code to this form though :). I am honestly a bit surprised that it doesn't do it already.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/111815567/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/112856939",
    "html_url": "https://github.com/rust-lang/rust/issues/26128#issuecomment-112856939",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26128",
    "id": 112856939,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMjg1NjkzOQ==",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-17T15:48:05Z",
    "updated_at": "2015-06-17T15:48:05Z",
    "body": "I believe this was fixed by #26280, closing. (@Marwes, is this correct?)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/112856939/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/112862847",
    "html_url": "https://github.com/rust-lang/rust/issues/26128#issuecomment-112862847",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/26128",
    "id": 112862847,
    "node_id": "MDEyOklzc3VlQ29tbWVudDExMjg2Mjg0Nw==",
    "user": {
      "login": "Marwes",
      "id": 957312,
      "node_id": "MDQ6VXNlcjk1NzMxMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/957312?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Marwes",
      "html_url": "https://github.com/Marwes",
      "followers_url": "https://api.github.com/users/Marwes/followers",
      "following_url": "https://api.github.com/users/Marwes/following{/other_user}",
      "gists_url": "https://api.github.com/users/Marwes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Marwes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Marwes/subscriptions",
      "organizations_url": "https://api.github.com/users/Marwes/orgs",
      "repos_url": "https://api.github.com/users/Marwes/repos",
      "events_url": "https://api.github.com/users/Marwes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Marwes/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-06-17T16:11:26Z",
    "updated_at": "2015-06-17T16:11:26Z",
    "body": "Yes, this is fixed.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/112862847/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
