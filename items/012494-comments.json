[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35858721",
    "html_url": "https://github.com/rust-lang/rust/pull/12494#issuecomment-35858721",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/12494",
    "id": 35858721,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODU4NzIx",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-02-24T05:27:41Z",
    "updated_at": "2014-02-24T05:27:41Z",
    "body": "@dotdash thanks for the explanation. do you have an example where this leads to TCO?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35858721/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35864595",
    "html_url": "https://github.com/rust-lang/rust/pull/12494#issuecomment-35864595",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/12494",
    "id": 35864595,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODY0NTk1",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-02-24T08:03:06Z",
    "updated_at": "2014-02-24T08:03:06Z",
    "body": "Generic example:\n\n``` rust\n#[inline(never)]\nfn huge_fn(x: &str, d: int) {\n  println!(\"{}: {}\", x, d);\n}\n\nfn rec(d: int) {\n  huge_fn(\"Test\", d);\n  rec(d+1);\n}\n\npub fn main() {\n  rec(0);\n}\n```\n\nSince `&str` is not an actual pointer but a struct and doesn't fit into a single register, it is passed as a by-value argument on the stack. Without the `nocapture` attribute, TCO can't happen.\n\nIn `libstd`, TCO is made possible for `char::decompose_canonical` and `char::decompose_compatible` (but nothing else).\n\nIn can check larger libs like `libsyntax` and `librustc` later today.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35864595/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35879561",
    "html_url": "https://github.com/rust-lang/rust/pull/12494#issuecomment-35879561",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/12494",
    "id": 35879561,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODc5NTYx",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-02-24T12:00:42Z",
    "updated_at": "2014-02-24T12:00:42Z",
    "body": "Further checking tells that there may be more TCO changes in `libstd` than just those two. I had looked for `TAILCALL` in the assembly diff, but that's only for recursive tail calls I think.\n\nA different example that doesn't involve recursion is this:\n\n``` rust\n#[crate_type=\"lib\"];\n\n#[inline(never)]\npub fn func(foo: Option<int>) {\n    println!(\"{:?}\", foo);\n}\n\n#[inline(never)]\npub fn func2(foo: int) {\n    println!(\"{:?}\", foo);\n}\n\npub fn bar(foo_opt: Option<int>) {\n    func(foo_opt);\n    match foo_opt {\n        Some(foo) => func2(foo),\n        _ => {}\n    }\n}\n```\n\nWith the change, the call to `func2` gets lowered to a `jmp`.\n\nI also found this change in the IR for librustc:\n\nOld:\n\n``` llvm\n  %283 = bitcast [4 x i64]* %282 to i8*\n  %284 = load i8* %283, align 8, !range !1\n  switch i8 %284, label %match_else42 [\n  ;...\n  %285 = bitcast [4 x i64]* %282 to { i8, %\"struct.syntax::ast::DefId[#9]\", i8, { i64, void (i8*)*, i8*, i8*, %\"struct.syntax::ast::Method[#9]\" }* }*\n  ;...\n  %impl_did.sroa.0.0.idx = getelementptr inbounds { i8, %\"struct.syntax::ast::DefId[#9]\", i8, { i64, void (i8*)*, i8*, i8*, %\"struct.syntax::ast::Method[#9]\" }* }* %285, i64 0, i32 1, i32 0\n  %impl_did.sroa.0.0.copyload = load i32* %impl_did.sroa.0.0.idx, align 4\n```\n\nNew:\n\n``` llvm\n  %283 = getelementptr inbounds [4 x i64]* %282, i64 0, i64 0\n  %284 = load i64* %283, align 8\n  %285 = trunc i64 %284 to i8\n  %286 = lshr i64 %284, 32\n  %287 = trunc i64 %286 to i32\n  switch i8 %285, label %match_else42 [\n```\n\nLLVM could deduce that the value doesn't change between the two loads and combine them to a single load instead (+ shifting). Unfortunately, I don't have a simple rust example that exposes this.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35879561/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35937677",
    "html_url": "https://github.com/rust-lang/rust/pull/12494#issuecomment-35937677",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/12494",
    "id": 35937677,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1OTM3Njc3",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-02-24T21:08:05Z",
    "updated_at": "2014-02-24T21:08:05Z",
    "body": "@dotdash Thanks for the details.\n\n@nikomatsakis Can you review?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/35937677/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
