[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143254320",
    "html_url": "https://github.com/rust-lang/rust/pull/28661#issuecomment-143254320",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28661",
    "id": 143254320,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzI1NDMyMA==",
    "user": {
      "login": "rust-highfive",
      "id": 7378925,
      "node_id": "MDQ6VXNlcjczNzg5MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7378925?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rust-highfive",
      "html_url": "https://github.com/rust-highfive",
      "followers_url": "https://api.github.com/users/rust-highfive/followers",
      "following_url": "https://api.github.com/users/rust-highfive/following{/other_user}",
      "gists_url": "https://api.github.com/users/rust-highfive/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rust-highfive/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rust-highfive/subscriptions",
      "organizations_url": "https://api.github.com/users/rust-highfive/orgs",
      "repos_url": "https://api.github.com/users/rust-highfive/repos",
      "events_url": "https://api.github.com/users/rust-highfive/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rust-highfive/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-25T15:37:33Z",
    "updated_at": "2015-09-25T15:37:33Z",
    "body": "r? @brson\n\n(rust_highfive has picked a reviewer for you, use r? to override)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143254320/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143305339",
    "html_url": "https://github.com/rust-lang/rust/pull/28661#issuecomment-143305339",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28661",
    "id": 143305339,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzMwNTMzOQ==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-25T17:56:01Z",
    "updated_at": "2015-09-25T17:56:01Z",
    "body": "Can this separate out the commits from #28631? It looks like they're not functionally needed and it seems like unrelated functionality perhaps? Would at least make review easier!\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143305339/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143308244",
    "html_url": "https://github.com/rust-lang/rust/pull/28661#issuecomment-143308244",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28661",
    "id": 143308244,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzMwODI0NA==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-25T18:02:26Z",
    "updated_at": "2015-09-25T18:02:26Z",
    "body": "Oh I see what the required piece is for the dependence on the other PR! While certainly a good change to check whether it's destroyed, I'm a little confused what triggered a panic in the first place? The example from #28129 I'd expect to not panic...\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143308244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143408479",
    "html_url": "https://github.com/rust-lang/rust/pull/28661#issuecomment-143408479",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28661",
    "id": 143408479,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzQwODQ3OQ==",
    "user": {
      "login": "ranma42",
      "id": 1506030,
      "node_id": "MDQ6VXNlcjE1MDYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1506030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ranma42",
      "html_url": "https://github.com/ranma42",
      "followers_url": "https://api.github.com/users/ranma42/followers",
      "following_url": "https://api.github.com/users/ranma42/following{/other_user}",
      "gists_url": "https://api.github.com/users/ranma42/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ranma42/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ranma42/subscriptions",
      "organizations_url": "https://api.github.com/users/ranma42/orgs",
      "repos_url": "https://api.github.com/users/ranma42/repos",
      "events_url": "https://api.github.com/users/ranma42/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ranma42/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-26T07:50:44Z",
    "updated_at": "2015-09-26T07:50:44Z",
    "body": "This makes the issue with #28129 somewhat more obvious: http://is.gd/ZO6da8\nThe problem is that the `LOCAL_STDOUT` TLS variable is used from the `drop` implementation (indirectly, it is used because of `print!`).\n\nIn the original code, it was only used in `drop`, hence everything worked just fine on Linux (never-used TLS variable used during a `drop` of a TLS variable), but it broke on MacOSX because it registered a new `_tlv_atexit` callback while already running TLS destruction.\nIn the new code the `LOCAL_STDOUT` variable is initialised and destroyed _before_ `drop` is called, hence the `print!` in `drop` \"expectedly\" fails.\n\nAs you can see, it is very hard to write code using TLS variables inside `drop` in a reliable manner.\nDid you expect the example from #28129 and the one I linked to have a different panic/abort behaviour?.\nThe fragility of TLS usage in `on_panic` (the need to protect both the `thread_info::current` and `LOCAL_STDERR` by checking their state) and the hard-to-predict behaviour make me hope that there is room for improvement in this respect.\n\nThis is why I was wondering if instead of guaranteeing that never-used TLS variable can be used during TLS teardown a more robust approach could be to have a `safe_with` (or something like that) method on TLS variables that is guaranteed to be callable during TLS teardown without ever causing panics.\nI would even argue that most functions should use something like this, otherwise calling them from `drop` implementations is going to be a Bad Thing.\nIn the current state, panics would happen depending on whether they have already been destroyed.\nPost-PR it would still be bad, as they would panic if already destroyed or never-used.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143408479/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143408873",
    "html_url": "https://github.com/rust-lang/rust/pull/28661#issuecomment-143408873",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28661",
    "id": 143408873,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzQwODg3Mw==",
    "user": {
      "login": "ranma42",
      "id": 1506030,
      "node_id": "MDQ6VXNlcjE1MDYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1506030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ranma42",
      "html_url": "https://github.com/ranma42",
      "followers_url": "https://api.github.com/users/ranma42/followers",
      "following_url": "https://api.github.com/users/ranma42/following{/other_user}",
      "gists_url": "https://api.github.com/users/ranma42/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ranma42/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ranma42/subscriptions",
      "organizations_url": "https://api.github.com/users/ranma42/orgs",
      "repos_url": "https://api.github.com/users/ranma42/repos",
      "events_url": "https://api.github.com/users/ranma42/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ranma42/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-26T08:03:18Z",
    "updated_at": "2015-09-26T08:03:18Z",
    "body": "I might even go as far saying that the (possibly somewhat inconvenient) robust/safe way to constrain the spec is: no TLS variable is accessible through `with`  during TLS teardown; any call to `with` will panic, even for already-initialised, not-yet-destroyed variables.\n\nThe destruction of TLS variable would still be possible (`self` would be available in `drop`).\nFrom my point of view, the `safe_with` method could simply be a way to enforce this behaviour.\nOtherwise, we could try to ensure (at least in `std`) that all the `with` calls are protected by a `state` check (this would not be needed only for code which we know to be unreachable from TLS dtors).\nProviding the same kind of guarantee on external code is currently impossible, since `state` is unstable.\nMoreover, I believe that even if it was stable, it would be very hard to guarantee that the check is not forgotten wherever it is appropriate.\n\nUhm... I realised that my comments might look more like material for a discussion.\nShall I close this PR and open an RFC?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143408873/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143801796",
    "html_url": "https://github.com/rust-lang/rust/pull/28661#issuecomment-143801796",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28661",
    "id": 143801796,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzgwMTc5Ng==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-28T16:50:35Z",
    "updated_at": "2015-09-28T16:50:35Z",
    "body": "Whether or not this should have an RFC depends on how much of an invasive change this turns out to be. New methods probably want to go through an RFC, but minor tweaks to existing ones are fine to leave around.\n\nThanks for the explanation about where the panic comes from, makes sense! I would personally be wary of a `safe_with`-sort-of-method because that was the intended purpose of the `state` accessor where the state of TLS can be queried to avoid panicking in situations (such as when we're already panicking).\n\nI'm worried about blanket disallowing reinitilization during destruction mainly because there doesn't seem to be a technical reason to do so other than \"weird stuff happens otherwise\", and I'd prefer to have a better understand of what's happening under the hood before moving forward. My intention in opening the issue was to just document what was happening and track behavior like the corruption on OSX. I don't have a strong opinion one way or another how it should be handled, and I'm personally ok with weird behavior so long as there's no unsafety (followed up by documenting how to avoid weird behavior).\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143801796/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/150026785",
    "html_url": "https://github.com/rust-lang/rust/pull/28661#issuecomment-150026785",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28661",
    "id": 150026785,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1MDAyNjc4NQ==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-10-21T21:17:02Z",
    "updated_at": "2015-10-21T21:17:02Z",
    "body": "Closing due to inactivity, but feel free to submit an RFC or reopen this as a new PR!\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/150026785/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
