{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/12740",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/12740/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/12740/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/12740/events",
  "html_url": "https://github.com/rust-lang/rust/pull/12740",
  "id": 28911797,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTMyODA0MTk=",
  "number": 12740,
  "title": "Add a streaming json API to libserialize",
  "user": {
    "login": "nical",
    "id": 264854,
    "node_id": "MDQ6VXNlcjI2NDg1NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/264854?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nical",
    "html_url": "https://github.com/nical",
    "followers_url": "https://api.github.com/users/nical/followers",
    "following_url": "https://api.github.com/users/nical/following{/other_user}",
    "gists_url": "https://api.github.com/users/nical/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nical/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nical/subscriptions",
    "organizations_url": "https://api.github.com/users/nical/orgs",
    "repos_url": "https://api.github.com/users/nical/repos",
    "events_url": "https://api.github.com/users/nical/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nical/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 35,
  "created_at": "2014-03-06T20:29:21Z",
  "updated_at": "2014-06-25T11:13:10Z",
  "closed_at": "2014-04-30T10:21:41Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/12740",
    "html_url": "https://github.com/rust-lang/rust/pull/12740",
    "diff_url": "https://github.com/rust-lang/rust/pull/12740.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/12740.patch",
    "merged_at": "2014-04-30T10:21:41Z"
  },
  "body": "Hi rust enthusiasts,\n\nWith this patch I propose to add a \"streaming\" API to the existing json parser in libserialize.\n\nBy \"streaming\" I mean a parser that let you act on JsonEvents that are generated as while parsing happens, as opposed to parsing the entire source, generating a big data structure and working with this data structure. I think both approaches have their pros and cons so this pull request adds the streaming API, preserving the existing one.\n\nThe streaming API is simple: It consist into an Iterator<JsonEvent> that consumes an Iterator<char>. JsonEvent is an enum with values such as NumberValue(f64), BeginList, EndList, BeginObject, etc.\n\nThe user would ideally use the API as follows:\n\n```\nfor evt in StreamingParser::new(src) {\n  match evt {\n    BeginList => {\n       // ...\n    }\n    // ...\n  }\n}\n```\n\nThe iterator provides a stack() method returning a slice of StackNodes which represent \"where we currently are\" in the logical structure of the json stream (for instance at \"foo.bar[3].x\" you get [ Key(\"foo\"), Key(\"bar\"), Index(3), Key(\"x\") ].)\n\nI wrote \"ideally\" above because the current way rust expands for loops, you can't call the stack() method because the iterator is already borrowed. So for know you need to manually advance the iterator in the loop. I hope this is something we can cope with, until for loops are better integrated with the compiler.\n\nStreaming parsers are useful when you want to read from a json stream, generate a custom data structure and you know how the json is going to be structured. For example, imagine you have to parse a 3D mesh file represented in the json format. In this case you probably expect to have large arrays of vertices and using the generic parser will be very inefficient because it will create a big list of all these vertices, which you will copy into a contiguous array afterwards (so you end up doing a lot of small allocations, parsing the json once and parsing the data structure afterwards). With a streaming parser, you can add the vertices to a contiguous array as they come in without paying the cost of creating the intermediate Json data structure. You have much fewer allocations since you write directly in the final data structure and you can be smart in how you will pre-allocate it.\n\nI added added this directly into serialize::json rather than in its own library because it turns out I can reuse most of the existing code whereas maintaining a separate library (which I did originally) forces me to duplicate this code.\n\nI wrote this trying to minimize the size of the patch so there may be places where the code could be nicer at the expenses of more changes (let me know what you prefer).\n\nThis is my first (potential) contribution to rust, so please let me know if I am doing something wrong (maybe I should have first introduced this proposition in the mailing list, or opened a github issue, etc.?). I work a few meters away from @pknfelix so I am not too hard to find :)\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/12740/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/12740/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
