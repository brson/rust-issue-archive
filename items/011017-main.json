{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/11017",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/11017/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/11017/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/11017/events",
  "html_url": "https://github.com/rust-lang/rust/pull/11017",
  "id": 24400302,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTA4ODI5NTY=",
  "number": 11017,
  "title": "rustc: Optimize reading metadata by 4x",
  "user": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2013-12-17T05:06:31Z",
  "updated_at": "2014-06-12T19:01:12Z",
  "closed_at": "2013-12-20T11:16:34Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/11017",
    "html_url": "https://github.com/rust-lang/rust/pull/11017",
    "diff_url": "https://github.com/rust-lang/rust/pull/11017.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/11017.patch",
    "merged_at": "2013-12-20T11:16:35Z"
  },
  "body": "We were previously reading metadata via `ar p`, but as learned from rustdoc\nawhile back, spawning a process to do something is pretty slow. Turns out LLVM\nhas an Archive class to read archives, but it cannot write archives.\n\nThis commits adds bindings to the read-only version of the LLVM archive class\n(with a new type that only has a read() method), and then it uses this class\nwhen reading the metadata out of rlibs. When you put this in tandem of not\ncompressing the metadata, reading the metadata is 4x faster than it used to be\nThe timings I got for reading metadata from the respective libraries was:\n\n```\nlibstd-04ff901e-0.9-pre.dylib    => 100ms\nlibstd-04ff901e-0.9-pre.rlib     => 23ms\nlibrustuv-7945354c-0.9-pre.dylib => 4ms\nlibrustuv-7945354c-0.9-pre.rlib  => 1ms\nlibrustc-5b94a16f-0.9-pre.dylib  => 87ms\nlibrustc-5b94a16f-0.9-pre.rlib   => 35ms\nlibextra-a6ebb16f-0.9-pre.dylib  => 63ms\nlibextra-a6ebb16f-0.9-pre.rlib   => 15ms\nlibsyntax-2e4c0458-0.9-pre.dylib => 86ms\nlibsyntax-2e4c0458-0.9-pre.rlib  => 22ms\n```\n\nIn order to always take advantage of these faster metadata read-times, I sort\nthe files in filesearch based on whether they have an rlib extension or not\n(prefer all rlib files first).\n\nOverall, this halved the compile time for a `fn main() {}` crate from 0.185s to\n0.095s on my system (when preferring dynamic linking). Reading metadata is still\nthe slowest pass of the compiler at 0.035s, but it's getting pretty close to\nlinking at 0.021s! The next best optimization is to just not copy the metadata\nfrom LLVM because that's the most expensive part of reading metadata right now.\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/11017/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/11017/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
