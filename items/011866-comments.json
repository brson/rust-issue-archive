[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33463587",
    "html_url": "https://github.com/rust-lang/rust/pull/11866#issuecomment-33463587",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11866",
    "id": 33463587,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzNDYzNTg3",
    "user": {
      "login": "bill-myers",
      "id": 4647491,
      "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bill-myers",
      "html_url": "https://github.com/bill-myers",
      "followers_url": "https://api.github.com/users/bill-myers/followers",
      "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
      "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
      "organizations_url": "https://api.github.com/users/bill-myers/orgs",
      "repos_url": "https://api.github.com/users/bill-myers/repos",
      "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bill-myers/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-28T09:42:27Z",
    "updated_at": "2014-01-28T09:43:09Z",
    "body": "It seems it's missing logic to alternate between waking up native_blocker and green_blocker.\n\nAlso, while it's kind of nice to have the symmetry between native_blocker and green_blocker, this design seems suboptimal compared to replacing code that accesses green_blocker with code that pops from the queue, which would avoid making green tasks deschedule and get rescheduled twice in the native+green task case (first on the queue, then on green_blocker).\n\nThis probably requires to merge green_cnt and state, by reserving the two least significant bits for LOCKED and NATIVE_BLOCKED. This would also reduce the size of struct Mutex by two words.\n\nOverall, this implementation is quite nice and might be the optimal approach for performance in both the green-only and native-only cases.\n\nIt has, however, the significant caveat that it makes taking advantage of lock elision that should eventually be provided by all OS mutexes completely impossible due to always writing to state (maybe it can still be used by implementing it \"by hand\").\n\n[I think the only workable alternative so far for automatic lock elision is to use https://github.com/mozilla/rust/pull/11610#issuecomment-33075571 after adapting to always lock/unlock on each call.]\n\nAlso, it doesn't reduce to just using pthread mutexes in the native-only case, which would be a problem for taking advantage of priority inheritance for native tasks where the OS mutex supports it and in general anything that requires the OS to know that a thread owns a mutex; this is fixable if desired by removing TryLockAcquisition by removing the initial try lock code in lock, and implementing try_lock in a similar way to lock (first try_locking the green or native parts, then the whole).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33463587/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33504121",
    "html_url": "https://github.com/rust-lang/rust/pull/11866#issuecomment-33504121",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11866",
    "id": 33504121,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzNTA0MTIx",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-28T17:48:10Z",
    "updated_at": "2014-01-28T17:48:10Z",
    "body": "> It seems it's missing logic to alternate between waking up native_blocker and green_blocker.\n\nWe actually get this for free because if a green thread holds the lock, you're guaranteed that the green blocker is empty (unless you've got a steal from a try_lock, as noted by the FIXME in the code).\n\n> which would avoid making green tasks deschedule and get rescheduled twice in the native+green task case\n\nIt's true, and this is even a problem with native tasks. This unlocks the OS mutex and _then_ flags the outer mutex as available, so it's possible for the child thread to run first, go to sleep on a cvar, and then have to get woken up. I agree this is a little odd, but the focus now is to get _something_ working rather than get the fastest thing working up front.\n\n> This probably requires to merge green_cnt and state\n\nI can see how that'd work, nice idea! For now I'd rather focus on clarity, however. I'd like to get this merged in one form or another so we can start using it. I'll add a FIXME though so we don't forget that we can shrink down the size if we need to.\n\n> Overall, this implementation is quite nice\n\nThank you!\n\n> It has, however, the significant caveat that it makes taking advantage of lock elision that should eventually be provided by all OS mutexes completely impossible due to always writing to state\n\nWhile regrettable, I'm feeling at this point we should get something merged before getting the perfect thing merged. I personally don't know enough about lock elision to write a mutex for it, but regardless that probably shouldn't be the focus this time around.\n\n> Also, it doesn't reduce to just using pthread mutexes in the native-only case\n\nHmm, that's not a bad idea, I think I'll play around with that and see how it works out. I was initially worried about the TLS hit, but my profiling found this to not be _that_ expensive.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33504121/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33651189",
    "html_url": "https://github.com/rust-lang/rust/pull/11866#issuecomment-33651189",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11866",
    "id": 33651189,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzNjUxMTg5",
    "user": {
      "login": "bill-myers",
      "id": 4647491,
      "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bill-myers",
      "html_url": "https://github.com/bill-myers",
      "followers_url": "https://api.github.com/users/bill-myers/followers",
      "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
      "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
      "organizations_url": "https://api.github.com/users/bill-myers/orgs",
      "repos_url": "https://api.github.com/users/bill-myers/repos",
      "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bill-myers/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-30T01:14:19Z",
    "updated_at": "2014-01-30T01:14:48Z",
    "body": "> We actually get this for free because if a green thread holds the lock, you're guaranteed that the green blocker is empty.\n\nIndeed, I was wrong.\n\nYes, getting something merged is definitely a priority, since the implementation can be changed in a backwards compatible way, and this one seems to work.\n\nThe only significant issue regarding API and backwards compatibility is whether to commit to providing the \"immediate destruction after unlock\" guarantee to unsafe code, or to explicitly reserve the right to reimplement Mutex in a way that no longer provides it.\n\nAlso, what behavior is guaranteed when attempting to recursively lock the Mutex (always fails, always deadlocks, undefined).\n\nI'm thinking lock elision will probably not require a redesign anyway, since it's likely going to be faster to do it ourselves, by simply starting an HTM transaction and checking that state == 0 inside; the runtime probably needs to be aware of it anyway since it seems it should abort any active transaction on green context switches.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33651189/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33651296",
    "html_url": "https://github.com/rust-lang/rust/pull/11866#issuecomment-33651296",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/11866",
    "id": 33651296,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzNjUxMjk2",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-01-30T01:16:14Z",
    "updated_at": "2014-01-30T01:16:14Z",
    "body": "@bill-myers: Keep in mind that the real lock elision API has better performance characteristics than RTM, and with RTM you still need a fallback abort path (in all likelihood, to a lock).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/33651296/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
