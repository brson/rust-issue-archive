{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/19467",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/19467/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/19467/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/19467/events",
  "html_url": "https://github.com/rust-lang/rust/pull/19467",
  "id": 50722707,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjUzNzUwNTY=",
  "number": 19467,
  "title": "Unbox almost all the closures",
  "user": {
    "login": "japaric",
    "id": 5018213,
    "node_id": "MDQ6VXNlcjUwMTgyMTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/japaric",
    "html_url": "https://github.com/japaric",
    "followers_url": "https://api.github.com/users/japaric/followers",
    "following_url": "https://api.github.com/users/japaric/following{/other_user}",
    "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/japaric/subscriptions",
    "organizations_url": "https://api.github.com/users/japaric/orgs",
    "repos_url": "https://api.github.com/users/japaric/repos",
    "events_url": "https://api.github.com/users/japaric/events{/privacy}",
    "received_events_url": "https://api.github.com/users/japaric/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 16,
  "created_at": "2014-12-02T21:17:31Z",
  "updated_at": "2014-12-17T02:09:37Z",
  "closed_at": "2014-12-14T01:02:24Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/19467",
    "html_url": "https://github.com/rust-lang/rust/pull/19467",
    "diff_url": "https://github.com/rust-lang/rust/pull/19467.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/19467.patch",
    "merged_at": "2014-12-14T01:02:26Z"
  },
  "body": "This PR moves almost all our current uses of closures, both in public API and internal uses, to the new \"unboxed\" closures system.\n\nIn most cases, downstream code that _only uses_ closures will continue to work as it is. The reason is that the `|| {}` syntax can be inferred either as a boxed or an \"unboxed\" closure according to the context. For example the following code will continue to work:\n\n``` rust\nsome_option.map(|x| x.transform_with(upvar))\n```\n\nAnd will get silently upgraded to an \"unboxed\" closure.\n\nIn some other cases, it may be necessary to \"annotate\" which `Fn*` trait the closure implements:\n\n```\n// Change this\n|x| { /* body */}\n// to either of these\n|: x| { /* body */}  // closure implements the FnOnce trait\n|&mut : x| { /* body */}  // FnMut\n|&: x| { /* body */}  // Fn\n```\n\nThis mainly occurs when the closure is assigned to a variable first, and then passed to a function/method.\n\n``` rust\nlet closure = |: x| x.transform_with(upvar);\nsome.option.map(closure)\n```\n\n(It's very likely that in the future, an improved inference engine will make this annotation unnecessary)\n\nOther cases that require annotation are closures that implement some trait via a blanket `impl`, for example:\n- `std::finally::Finally`\n- `regex::Replacer`\n- `std::str::CharEq`\n\n``` rust\nstring.trim_left_chars(|c: char| c.is_whitespace())\n//~^ ERROR: the trait `Fn<(char,), bool>` is not implemented for the type `|char| -> bool`\nstring.trim_left_chars(|&: c: char| c.is_whitespace())  // OK\n```\n\nFinally, all implementations of traits that contain boxed closures in the arguments of their methods are now broken. And will need to be updated to use unboxed closures. These are the main affected traits:\n- `serialize::Decoder`\n- `serialize::DecoderHelpers`\n- `serialize::Encoder`\n- `serialize::EncoderHelpers`\n- `rustrt::ToCStr`\n\nFor example, change this:\n\n``` rust\n// libserialize/json.rs\nimpl<'a> Encoder<io::IoError> for Encoder<'a> {\n    fn emit_enum(&mut self,\n                 _name: &str,\n                 f: |&mut Encoder<'a>| -> EncodeResult) -> EncodeResult {\n        f(self)\n    }\n}\n```\n\nto:\n\n``` rust\n// libserialize/json.rs\nimpl<'a> Encoder<io::IoError> for Encoder<'a> {\n    fn emit_enum<F>(&mut self, _name: &str, f: F) -> EncodeResult where\n        F: FnOnce(&mut Encoder<'a>) -> EncodeResult\n    {\n        f(self)\n    }\n}\n```\n\n[breaking-change]\n\n---\n### How the `Fn*` bound has been selected\n\nI've chosen the bounds to make the functions/structs as \"generic as possible\", i.e. to let them allow the maximum amount of input.\n- An `F: FnOnce` bound accepts the three kinds of closures: `|:|`, `|&mut:|` and `|&:|`.\n- An `F: FnMut` bound only accepts \"non-consuming\" closures: `|&mut:|` and `|&:|`.\n- An `F: Fn` bound only accept the \"immutable environment\" closures: `|&:|`.\n\nThis means that whenever possible the `FnOnce` bound has been used, if the `FnOnce` bound couldn't be used, then the `FnMut` was used. The `Fn` bound was never used in the whole repository.\n\nThe `FnMut` bound was the most used, because it resembles the semantics of the current boxed closures: the closure can modify its environment, and the closure may be called several times.\n\nThe `FnOnce` bound allows new semantics: you can move out the upvars when the closure is called. This can be effectively paired with the `move || {}` syntax to transfer ownership from the environment to the closure caller.\n\nIn the case of trait methods, is hard to select the \"right\" bound since we can't control how the trait may be implemented by downstream users. In these cases, I have selected the bound based on how we use these traits in the repository. For this reason the selected bounds may not be ideal, and may require tweaking before stabilization.\n\nr? @aturon\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/19467/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/19467/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
