{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/29139",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/29139/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/29139/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/29139/events",
  "html_url": "https://github.com/rust-lang/rust/pull/29139",
  "id": 112009699,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NDgwMDQ4ODY=",
  "number": 29139,
  "title": "Make short string hashing 30% faster by splitting Hash::hash_end from Hash::hash",
  "user": {
    "login": "sorear",
    "id": 92735,
    "node_id": "MDQ6VXNlcjkyNzM1",
    "avatar_url": "https://avatars.githubusercontent.com/u/92735?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sorear",
    "html_url": "https://github.com/sorear",
    "followers_url": "https://api.github.com/users/sorear/followers",
    "following_url": "https://api.github.com/users/sorear/following{/other_user}",
    "gists_url": "https://api.github.com/users/sorear/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sorear/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sorear/subscriptions",
    "organizations_url": "https://api.github.com/users/sorear/orgs",
    "repos_url": "https://api.github.com/users/sorear/repos",
    "events_url": "https://api.github.com/users/sorear/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sorear/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "brson",
    "id": 147214,
    "node_id": "MDQ6VXNlcjE0NzIxNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brson",
    "html_url": "https://github.com/brson",
    "followers_url": "https://api.github.com/users/brson/followers",
    "following_url": "https://api.github.com/users/brson/following{/other_user}",
    "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
    "organizations_url": "https://api.github.com/users/brson/orgs",
    "repos_url": "https://api.github.com/users/brson/repos",
    "events_url": "https://api.github.com/users/brson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brson/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2015-10-18T09:25:07Z",
  "updated_at": "2015-11-23T21:28:49Z",
  "closed_at": "2015-11-23T21:28:48Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/29139",
    "html_url": "https://github.com/rust-lang/rust/pull/29139",
    "diff_url": "https://github.com/rust-lang/rust/pull/29139.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/29139.patch",
    "merged_at": null
  },
  "body": "# Why?\n\nSince hash functions are already designed to prevent collisions between a string and its prefixes, it's somewhat inelegant that we append a sentinel byte to strings for hashing.  I was looking at #25237 a few days ago and realized that if we distinguish hashing contexts which are at the end of the key from those that aren't, we can suppress the sentinel byte (and also vector lengths) in the cases where they aren't needed; in addition to saving a byte of hashing, it saves a call to update and associated buffer-management overhead.\n\nThis attacks the same problem as #28044.\n# How?\n\nThis adds a new method `hash_end` to the `Hash` trait, which behaves exactly as `hash` _except_ that it need not produce a prefix-free encoding.  It is always legal for `hash_end` to be the same as `hash`, and as such this is the default implementation.  There are specialized implementations for strings and slices which remove the end/length markers.\n# How much?\n\nHere's a small benchmark script:\n\n``` rust\nuse std::hash::{Hasher,Hash,SipHasher};\nuse std::env;\n\nfn main() {\n    let args : Vec<String> = env::args().collect();\n    let mut acc = 0u64;\n    match &*args[1] {\n        \"0\" => {\n            for i in 1 .. 10_000_000 {\n                acc += format!(\"{}\", i).len() as u64; // not doing hashing\n            }\n        },\n        \"1\" => {\n            for i in 1 .. 10_000_000 {\n                let mut _h = SipHasher::new();\n                format!(\"{}\", i).hash_end(&mut _h);\n                acc += _h.finish();\n            }\n        },\n        \"2\" => {\n            for i in 1 .. 10_000_000 {\n                let mut _h = SipHasher::new();\n                format!(\"{}\", i).hash(&mut _h);\n                acc += _h.finish();\n            }\n        },\n        \"3\" => {\n            let mut s = std::collections::HashSet::new();\n            for i in 1 .. 10_000_000 {\n                s.insert(format!(\"{}\", i));\n            }\n            acc = s.len() as u64;\n        },\n        \"4\" => {\n            let mut s = std::collections::HashSet::new();\n            for i in 1 .. 100_000 {\n                s.insert(format!(\"{}\", i));\n            }\n            for i in 1 .. 10_000_000 {\n                if s.contains(&format!(\"{}\", i)) { acc += 1; }\n            }\n        }\n        _ => {},\n    }\n    println!(\"{}\", acc);\n}\n```\n\nI ran it in each mode on the patched and baseline rust compilers (with `-O`, on x86_64 OSX), median of 27 runs each time, for the following timings:\n\n```\n            (0)   (1)   (2)   (3)   (4)\nPATCHED   0.864 1.133 1.276 5.564 1.619\nBASELINE  0.852 ----- 1.298 5.654 1.736\n```\n\nSubtracting out the baseline (0) case which just allocates and frees strings, it looks like a 34% improvement on short string hashing, 13% on hashset queries, and 2% on hashset insertions.  Uncertainty for the medians seems to be around 10ms.\n# What's the catch?\n- Naturally this changes hash values.  It's not clear how big a deal that is, especially in re semver.\n- More importantly: anybody who needs two types to have the same hash values (in particular `Borrow` implementers) can no longer generally do so by forwarding the `hash` method; `hash_end` must be forwarded as well.  This situation exists exactly once in the compiler.  `#[derive(Hash)]` has been modified to forward `hash_end`, so newtype-ish wrappers will just work (outside of the compiler; the compiler needs to implement `hash_end` itself when it's needed for `Borrow`, because we can't rely on the stage0 to do it.)\n# Wait!\n\n`hash_end` should probably be feature gated.  It's not in this version of the patch, because when I tried feature gating it deriving broke; I'm not sure how to tell rustc to ignore feature gates in deriving-generated code.\n\nI'm not sure whether this belongs as an RFC.\n",
  "closed_by": {
    "login": "brson",
    "id": 147214,
    "node_id": "MDQ6VXNlcjE0NzIxNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brson",
    "html_url": "https://github.com/brson",
    "followers_url": "https://api.github.com/users/brson/followers",
    "following_url": "https://api.github.com/users/brson/following{/other_user}",
    "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
    "organizations_url": "https://api.github.com/users/brson/orgs",
    "repos_url": "https://api.github.com/users/brson/repos",
    "events_url": "https://api.github.com/users/brson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brson/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/29139/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/29139/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
