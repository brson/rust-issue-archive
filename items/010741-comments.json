[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29567314",
    "html_url": "https://github.com/rust-lang/rust/issues/10741#issuecomment-29567314",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/10741",
    "id": 29567314,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5NTY3MzE0",
    "user": {
      "login": "emberian",
      "id": 704250,
      "node_id": "MDQ6VXNlcjcwNDI1MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/704250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/emberian",
      "html_url": "https://github.com/emberian",
      "followers_url": "https://api.github.com/users/emberian/followers",
      "following_url": "https://api.github.com/users/emberian/following{/other_user}",
      "gists_url": "https://api.github.com/users/emberian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/emberian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/emberian/subscriptions",
      "organizations_url": "https://api.github.com/users/emberian/orgs",
      "repos_url": "https://api.github.com/users/emberian/repos",
      "events_url": "https://api.github.com/users/emberian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/emberian/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-12-01T04:44:14Z",
    "updated_at": "2013-12-01T04:44:14Z",
    "body": "cc @thestinger \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29567314/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29692883",
    "html_url": "https://github.com/rust-lang/rust/issues/10741#issuecomment-29692883",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/10741",
    "id": 29692883,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5NjkyODgz",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-12-03T08:58:23Z",
    "updated_at": "2013-12-03T08:58:23Z",
    "body": "I have this implemented, but there's a few caveats. First, right now our linkage model makes it such that LTO is only a reasonable option for a staticlib and binary output. This doesn't make sense for rlibs or for dylibs. This also means that when running LTO, it requires all upstream dependencies to be available as rlibs. This is how I implemented it:\n- Whenever an rlib is generated, in addition to `crate.o` being inserted into the archive, `crate.bc` is also inserted into the archive (the optimized bytecode).\n- During the `run_passes` phase of the compiler, the following steps are taken:\n  - First, run the function/module pass managers over the local LLVM module\n  - Load each upstream dependency's bytecode file, and \"link into\" the current LLVM module (using llvm apis)\n  - Run an internalization pass which internalizes all symbols except those determined reachable (for the current module)\n  - Run the LTO passes (there's an LTO pass manager provided by LLVM that's used)\n  - Emit the bytecode of this entire module\n- When linking, take each upstream `libfoo.rlib`, copy it to a temporary location, remove `foo.o` from the archive, and then link as usual. I found it necessary (at least on OSX) to remove the object files because otherwise the linker would still pull in all of them (because their symbols are exported I would imagine).\n\nOptimization-wise, this appears to work as well as one would expect. I got `fn main() {}` to compile to a 1.3MB executable, and ~700KB without librustuv. These are the same numbers that I was getting in #10740 with `-ffunction-sections` + `--gc-sections`, which is a promising number. This also means that a solution to this issue may end up closing #10740.\n\nSadly this comes with a caveat, and that caveat is that this is about the slowest possible thing the compiler can do. Here's a breakdown of the timing:\n- 0.397s loading std.bc and linking into the current module\n- 0.103s loading rustuv.bc\n- 1.894s running LTO optimization passes\n- 5.067s emitting the output file (running the codegen passes)\n- 0.396s preparing libstd.rlib without std.o\n- 0.060s preparing librustuv.rlib\n- 1.416s running the system linker\n\nThe total runtime of the compiler was 9.655s. Remember that the program in question is `fn main() {}`.\n\nI don't think that this means we shouldn't have LTO support, but we would seriously need to look into optimizing this. This is an absurd runtime. If we could in theory make loading the bc libraries and preparing the new rlib libraries have 0 runtime (we can certainly optimize them more than I implemented), we're still looking at at least an 8s runtime.\n\nWhat do others think about this? Did I make a fundamental misdirection somewhere? Is this actually a reasonable runtime for an LTO optimization?\n\nAs reference, my work in progress can be found at https://github.com/alexcrichton/rust/commit/e5416c841383ed3bbac86a884d075c897adf5d6d\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29692883/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29700878",
    "html_url": "https://github.com/rust-lang/rust/issues/10741#issuecomment-29700878",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/10741",
    "id": 29700878,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5NzAwODc4",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-12-03T11:06:41Z",
    "updated_at": "2013-12-03T11:06:41Z",
    "body": "@alexcrichton I tried running that branch locally (x64 linux), and I met with:\n\n```\nnote: /home/huon/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustc/x86_64-unknown-linux-gnu/lib/libmorestack.a(morestack.o): In function `__morestack':\n(.text+0x9): undefined reference to `rust_stack_exhausted'\ncollect2: error: ld returned 1 exit status\n```\n\nin linking. (Also, how did you get those fine grained numbers?)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29700878/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29728399",
    "html_url": "https://github.com/rust-lang/rust/issues/10741#issuecomment-29728399",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/10741",
    "id": 29728399,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5NzI4Mzk5",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-12-03T16:58:15Z",
    "updated_at": "2013-12-03T16:58:15Z",
    "body": "I used a bit of an ad-hoc method to get those numbers (manual instrumentation with the `time` function), but I've formalized it a bit more now.\n\nI _think_ I fixed that problem in https://github.com/alexcrichton/rust/commit/2ba6426c1770643eaf2d46b8e8606bb103b40272, although I'm a little scared that it ran successfully on OSX in the first place...\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29728399/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29728929",
    "html_url": "https://github.com/rust-lang/rust/issues/10741#issuecomment-29728929",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/10741",
    "id": 29728929,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5NzI4OTI5",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-12-03T17:03:12Z",
    "updated_at": "2013-12-03T17:03:12Z",
    "body": "@alexcrichton: The individual crates are supposed to be somewhat optimized (not the full regular module pass) before the final LTO pass. Look at what `clang` does when compiling like this.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29728929/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29730588",
    "html_url": "https://github.com/rust-lang/rust/issues/10741#issuecomment-29730588",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/10741",
    "id": 29730588,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5NzMwNTg4",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-12-03T17:19:43Z",
    "updated_at": "2013-12-03T17:19:43Z",
    "body": "Interesting! I was hoping to avoid a \"compile this library for LTO-enabled linkage\" flag, but perhaps that may end up being inevitable. Sadly though I don't think that it will help the compile times at all (it'll probably just end up slowing them down a little with more optimizations being run at the end).\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/29730588/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
