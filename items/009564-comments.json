[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/25272498",
    "html_url": "https://github.com/rust-lang/rust/issues/9564#issuecomment-25272498",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9564",
    "id": 25272498,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI1MjcyNDk4",
    "user": {
      "login": "erickt",
      "id": 84711,
      "node_id": "MDQ6VXNlcjg0NzEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/erickt",
      "html_url": "https://github.com/erickt",
      "followers_url": "https://api.github.com/users/erickt/followers",
      "following_url": "https://api.github.com/users/erickt/following{/other_user}",
      "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/erickt/subscriptions",
      "organizations_url": "https://api.github.com/users/erickt/orgs",
      "repos_url": "https://api.github.com/users/erickt/repos",
      "events_url": "https://api.github.com/users/erickt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/erickt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-27T19:55:35Z",
    "updated_at": "2013-09-27T19:55:35Z",
    "body": "The simplest thing to do would be to add a function to `std::c_str` to implement this pattern. It wouldn't protect against someone from returning an interior pointer (#7694), but it would be simple enough that most people should reach for it first. Here's an untested example implementation:\n\n```\ntrait WithCStrs {\n    fn with_c_strs<T>(&self, null_terminated: bool, f: &fn(**libc::c_char) -> T) -> T;\n}\n\nimpl<'self, T: Str> WithCStrs for &'self [T] {\n    fn with_c_strs<T: Str, U>(&self, null_terminate: bool, f: &fn(**libc::c_char) -> U) -> U {\n        let c_strs: ~[CString] = self.map(|s: & &str| s.to_c_str());\n        let mut ptrs: ~[*c_char] = c_strs.map(|c: &CString| c.with_ref(|ptr| ptr));\n        if null_terminate {\n            ptrs.push(std::ptr::null());\n        }\n        ptrs.as_imm_buf(|buf: **c_char, _| f(buf))\n    }\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/25272498/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/25334403",
    "html_url": "https://github.com/rust-lang/rust/issues/9564#issuecomment-25334403",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9564",
    "id": 25334403,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI1MzM0NDAz",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-09-30T02:16:51Z",
    "updated_at": "2013-09-30T02:16:51Z",
    "body": "@erickt I agree. I'm not worried about someone returning an interior pointer though, because they can't dereference it without `unsafe` code.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/25334403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/50229577",
    "html_url": "https://github.com/rust-lang/rust/issues/9564#issuecomment-50229577",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9564",
    "id": 50229577,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMjI5NTc3",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-26T09:39:04Z",
    "updated_at": "2014-07-26T09:39:04Z",
    "body": "Updated (although missing some of the bells and whistles):\n\n``` rust\nfn with_c_strings<T: ToCStr, U>(x: &[T], f: |*const *const libc::c_char| -> U) -> U {\n    let c_strings: Vec<CString> = x.iter().map(|s| s.to_c_str()).collect();\n    let mut ptrs: Vec<*const libc::c_char> = c_strings.iter().map(|cs| cs.as_ptr()).collect();\n\n    ptrs.push(ptr::null());\n\n    f(ptrs.as_ptr())\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/50229577/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/50304543",
    "html_url": "https://github.com/rust-lang/rust/issues/9564#issuecomment-50304543",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9564",
    "id": 50304543,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMzA0NTQz",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-07-28T06:36:02Z",
    "updated_at": "2014-07-28T06:36:02Z",
    "body": "@huonw In the interests of avoiding a reallocation on the `ptrs` vector when pushing the null pointer, I would suggest the following:\n\n``` rust\npub fn with_c_strings<T: ToCStr, U>(x: &[T], f: |*const *const libc::c_char| -> U) -> U {\n    let c_strings: Vec<CString> = x.iter().map(|s| s.to_c_str()).collect();\n    let ptrs = c_strings.iter().map(|cs| cs.as_ptr())\n                        .chain(Some(ptr::null::<libc::c_char>()).move_iter())\n                        .collect::<Vec<*const libc::c_char>>();\n\n    f(ptrs.as_ptr())\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/50304543/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95354558",
    "html_url": "https://github.com/rust-lang/rust/issues/9564#issuecomment-95354558",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9564",
    "id": 95354558,
    "node_id": "MDEyOklzc3VlQ29tbWVudDk1MzU0NTU4",
    "user": {
      "login": "tamird",
      "id": 1535036,
      "node_id": "MDQ6VXNlcjE1MzUwMzY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1535036?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tamird",
      "html_url": "https://github.com/tamird",
      "followers_url": "https://api.github.com/users/tamird/followers",
      "following_url": "https://api.github.com/users/tamird/following{/other_user}",
      "gists_url": "https://api.github.com/users/tamird/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tamird/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tamird/subscriptions",
      "organizations_url": "https://api.github.com/users/tamird/orgs",
      "repos_url": "https://api.github.com/users/tamird/repos",
      "events_url": "https://api.github.com/users/tamird/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tamird/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-04-22T22:17:12Z",
    "updated_at": "2015-04-22T22:17:12Z",
    "body": "This has some complications in today's rust - it would look like this:\n\n``` rust\n#![feature(libc)]\n\nextern crate libc;\n\nuse std::ptr;\nuse std::ffi::CString;\n\npub fn with_c_strings<T: Copy+Into<Vec<u8>>, U, F>(ts: &[T], f: F) -> U where\n    F: FnOnce(*const *const libc::c_char) -> U {\n    let c_strs: Vec<_> = ts.iter().map(|&t| {\n        CString::new(t).unwrap()\n    }).collect();\n    let ptrs: Vec<_> = c_strs.iter().map(|c_str| c_str.as_ptr())\n                     .chain(Some(ptr::null()))\n                     .collect();\n\n    f(ptrs.as_ptr())\n}\n```\n\nUnfortunately `CString::new()` has two unaccounted-for-in-this-discussion features:\n- it returns a result (failure if the argument passed in contains a null byte)\n- it mutates the argument by appending a null byte (meaning the argument must be copied)\n\nI'm not sure there's a sane way to address this issue without violating the static guarantee of null-termination.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/95354558/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270165223",
    "html_url": "https://github.com/rust-lang/rust/issues/9564#issuecomment-270165223",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/9564",
    "id": 270165223,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MDE2NTIyMw==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-01-03T17:05:10Z",
    "updated_at": "2017-01-03T17:05:10Z",
    "body": "Triage: this is still a papercut, but not enough of one for someone to have commented in almost two years. As such, I'm going to give this a close. If someone wants to write a library function to make this easier, please do so!",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270165223/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
