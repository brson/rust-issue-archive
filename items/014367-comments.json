[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43956228",
    "html_url": "https://github.com/rust-lang/rust/issues/14367#issuecomment-43956228",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/14367",
    "id": 43956228,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzOTU2MjI4",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-22T23:30:20Z",
    "updated_at": "2014-05-22T23:30:53Z",
    "body": "I don't think this is a bug, at least, the only \"bug\" here is the non-KILL_SWITCH version _not_ being optimised.\n\nIn particular, calling `black_box(fib(20))` is the same as writing `let n = fib(20); black_box(n)`, the `fib` call can be moved around freely, as long as the `n` value passed into `black_box` is the correct one. Looking at the IR, you can see this, the \"correct\" (i.e. without KILL_SWITCH) IR looks like (the `match_else.i` block is the body of the loop):\n\n``` llvm\n  %1 = call i64 @_ZN15precise_time_ns20h53df8191405a33f50pa11v0.11.0.preE()\n  %2 = bitcast i64* %dummy.i.i to i8*\n  br label %match_else.i\n\nmatch_else.i:                                     ; preds = %match_else.i, %entry-block\n  %3 = phi i64 [ 0, %entry-block ], [ %4, %match_else.i ]\n  %4 = add i64 %3, 1\n  %5 = call fastcc i64 @_ZN3fib20hebff6027c68c44a7iaa4v0.0E(i64 20)\n  call void @llvm.lifetime.start(i64 8, i8* %2) #3\n  store i64 %5, i64* %dummy.i.i, align 8\n  call void asm \"\", \"r,~{dirflag},~{fpsr},~{flags}\"(i64* %dummy.i.i) #3\n  call void @llvm.lifetime.end(i64 8, i8* %2) #3\n  %exitcond.i = icmp eq i64 %4, 1000\n  br i1 %exitcond.i, label %_ZN5bench20h269af04030408b87Jaa4v0.0E.exit, label %match_else.i\n\n_ZN5bench20h269af04030408b87Jaa4v0.0E.exit:       ; preds = %match_else.i\n  %6 = call i64 @_ZN15precise_time_ns20h53df8191405a33f50pa11v0.11.0.preE()\n```\n\nbut the \"bad\" KILL_SWITCH version looks like\n\n``` llvm\n  %1 = call i64 @_ZN15precise_time_ns20h53df8191405a33f50pa11v0.11.0.preE()\n  %2 = call fastcc i64 @_ZN3fib20hc787ae08bc88b138iaa4v0.0E(i64 20) #3\n  %3 = bitcast i64* %dummy.i.i to i8*\n  br label %match_else.i\n\nmatch_else.i:                                     ; preds = %match_else.i, %entry-block\n  %4 = phi i64 [ 0, %entry-block ], [ %5, %match_else.i ]\n  %5 = add i64 %4, 1\n  call void @llvm.lifetime.start(i64 8, i8* %3) #3\n  store i64 %2, i64* %dummy.i.i, align 8\n  call void asm \"\", \"r,~{dirflag},~{fpsr},~{flags}\"(i64* %dummy.i.i) #3\n  call void @llvm.lifetime.end(i64 8, i8* %3) #3\n  %exitcond.i = icmp eq i64 %5, 1000\n  br i1 %exitcond.i, label %_ZN5bench20hd83cb69b9731384fJaa4v0.0E.exit, label %match_else.i\n\n_ZN5bench20hd83cb69b9731384fJaa4v0.0E.exit:       ; preds = %match_else.i\n  %6 = call i64 @_ZN15precise_time_ns20h53df8191405a33f50pa11v0.11.0.preE()\n```\n\nIn particular, the `black_box` call is always there (the `call void asm` line), and the only real difference is the position of the `fib` call (`call fastcc i64 @_ZN3fib20hc787ae08bc88b138iaa4v0.0E(i64 20) #3`), since LLVM recognised that the `fib` function is \"pure\" (i.e. just arithmetic) and so doesn't need to be recalled each time. However, this doesn't explain why it's not optimising the \"correct\" case.\n\nTo get this to reliably do what you want, _without_ us disabling optimisations (which is a nonstarter), you can pass the argument to `fib` through a black box, e.g.\n\n``` rust\n|| {\n    let mut n = 20;\n    black_box(&mut n); // doesn't change it, but LLVM can't tell.\n    fib(n)\n}\n```\n\nThis makes the IR slightly less nice, but it preserves the `fib` call in the loop.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43956228/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43959358",
    "html_url": "https://github.com/rust-lang/rust/issues/14367#issuecomment-43959358",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/14367",
    "id": 43959358,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzOTU5MzU4",
    "user": {
      "login": "japaric",
      "id": 5018213,
      "node_id": "MDQ6VXNlcjUwMTgyMTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/japaric",
      "html_url": "https://github.com/japaric",
      "followers_url": "https://api.github.com/users/japaric/followers",
      "following_url": "https://api.github.com/users/japaric/following{/other_user}",
      "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/japaric/subscriptions",
      "organizations_url": "https://api.github.com/users/japaric/orgs",
      "repos_url": "https://api.github.com/users/japaric/repos",
      "events_url": "https://api.github.com/users/japaric/events{/privacy}",
      "received_events_url": "https://api.github.com/users/japaric/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-23T00:20:12Z",
    "updated_at": "2014-05-23T00:20:12Z",
    "body": "@huonw Thanks a lot for the detailed explanation! This cleared my doubts about how `black_box` works, and also explains why `f = precise_time_ns` also \"works\" (`precise_time_ns` is an 'impure\" ffi call).\n\nI'm closing this because my hypothesis have been invalidated.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/43959358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
