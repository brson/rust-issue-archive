[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160109438",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-160109438",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 160109438,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MDEwOTQzOA==",
    "user": {
      "login": "thepowersgang",
      "id": 955596,
      "node_id": "MDQ6VXNlcjk1NTU5Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/955596?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thepowersgang",
      "html_url": "https://github.com/thepowersgang",
      "followers_url": "https://api.github.com/users/thepowersgang/followers",
      "following_url": "https://api.github.com/users/thepowersgang/following{/other_user}",
      "gists_url": "https://api.github.com/users/thepowersgang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thepowersgang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thepowersgang/subscriptions",
      "organizations_url": "https://api.github.com/users/thepowersgang/orgs",
      "repos_url": "https://api.github.com/users/thepowersgang/repos",
      "events_url": "https://api.github.com/users/thepowersgang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thepowersgang/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-27T10:38:24Z",
    "updated_at": "2015-11-27T10:38:24Z",
    "body": "Reproduction without box patterns:\n\n``` rust\n#[derive(Debug, Clone)]\npub enum Instruction {\n    Increment {\n        amount: ::std::num::Wrapping<i8>,\n    },\n    Loop(Vec<Box<Instruction>>),\n}\n\n/// Defines a method on iterators to map a function over all loop bodies.\ntrait MapLoopsExt: Iterator<Item=Box<Instruction>> {\n    fn map_loops<F>(&mut self, f: F) -> Vec<Box<Instruction>>\n        where F: Fn(Vec<Box<Instruction>>) -> Vec<Box<Instruction>>\n    {\n        self.map(|instr| {\n            match *instr {\n                Instruction::Loop(body) => Box::new( Instruction::Loop(f(body)) ),\n                other => Box::new(other)\n            }\n        }).collect()\n    }\n}\n\nimpl<I> MapLoopsExt for I where I: Iterator<Item=Box<Instruction>> { }\n\n/// Remove any loops where we know the current cell is zero.\npub fn remove_dead_loops(instrs: Vec<Box<Instruction>>) -> Vec<Box<Instruction>> {\n    instrs.clone()\n          .into_iter()\n          .enumerate()\n          .map(|(_, instr)| instr)\n          .map_loops(remove_dead_loops)\n}\n\nfn main() {\n    let mut instrs = vec![];\n    instrs = remove_dead_loops(instrs);\n    println!(\"{:?}\", instrs);\n}\n```\n\nRunning in valgrind (`rustc 1.rs -O -g`)  gives\n\n```\n==2557== Invalid read of size 1\n==2557==    at 0x10F71A: call_once (ops.rs:1813)\n==2557==    by 0x10F71A: map<Box<1::Instruction>,&mut closure> (option.rs:427)\n==2557==    by 0x10F71A: iter::_$LT$impl$GT$::next::next::h16905190649762655698 (iter.rs:3267)\n==2557==    by 0x10E0AE: from_iter<core::iter::Map<&mut core::iter::Map<core::iter::Enumerate<collections::vec::IntoIter<Box<1::Instruction>>>, closure>, closure>> (vec.rs:1239)\n==2557==    by 0x10E0AE: collect<core::iter::Map<&mut core::iter::Map<core::iter::Enumerate<collections::vec::IntoIter<Box<1::Instruction>>>, closure>, closure>,collections::vec::Vec<Box<1::Instruction>>> (iter.rs:1461)\n==2557==    by 0x10E0AE: map_loops<core::iter::Map<core::iter::Enumerate<collections::vec::IntoIter<Box<1::Instruction>>>, closure>,fn(collections::vec::Vec<Box<1::Instruction>>) -> collections::vec::Vec<Box<1::Instruction>>> (1.rs:17)\n==2557==    by 0x10E0AE: remove_dead_loops::hee4c54714bae2292bda (1.rs:30)\n==2557==    by 0x110DA4: main::hbe4f3ed567dbb481Bda (1.rs:39)\n==2557==    by 0x118EF4: sys_common::unwind::try::try_fn::h13155858200411868877 (in /home/tpg/1)\n==2557==    by 0x116A98: __rust_try (in /home/tpg/1)\n==2557==    by 0x118B96: rt::lang_start::h45458ea0787b3e00e0x (in /home/tpg/1)\n==2557==    by 0x5491A3F: (below main) (libc-start.c:289)\n==2557==  Address 0x0 is not stack'd, malloc'd or (recently) free'd\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160109438/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160111123",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-160111123",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 160111123,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MDExMTEyMw==",
    "user": {
      "login": "thepowersgang",
      "id": 955596,
      "node_id": "MDQ6VXNlcjk1NTU5Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/955596?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thepowersgang",
      "html_url": "https://github.com/thepowersgang",
      "followers_url": "https://api.github.com/users/thepowersgang/followers",
      "following_url": "https://api.github.com/users/thepowersgang/following{/other_user}",
      "gists_url": "https://api.github.com/users/thepowersgang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thepowersgang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thepowersgang/subscriptions",
      "organizations_url": "https://api.github.com/users/thepowersgang/orgs",
      "repos_url": "https://api.github.com/users/thepowersgang/repos",
      "events_url": "https://api.github.com/users/thepowersgang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thepowersgang/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-27T10:46:05Z",
    "updated_at": "2015-11-27T10:46:16Z",
    "body": "Two changes that have eliminated the crash:\n- Removing the data from `Instruction::Increment`\n- Rewriting the match to `mem::replace` in and out\n\n``` rust\n        self.map(|mut instr| {\n            if let Instruction::Loop(ref mut body) = *instr {\n                *body = f( ::std::mem::replace(body, Vec::new()) );\n            }\n            instr\n        }).collect()\n\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160111123/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160111714",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-160111714",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 160111714,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MDExMTcxNA==",
    "user": {
      "login": "Ms2ger",
      "id": 111161,
      "node_id": "MDQ6VXNlcjExMTE2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/111161?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Ms2ger",
      "html_url": "https://github.com/Ms2ger",
      "followers_url": "https://api.github.com/users/Ms2ger/followers",
      "following_url": "https://api.github.com/users/Ms2ger/following{/other_user}",
      "gists_url": "https://api.github.com/users/Ms2ger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Ms2ger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Ms2ger/subscriptions",
      "organizations_url": "https://api.github.com/users/Ms2ger/orgs",
      "repos_url": "https://api.github.com/users/Ms2ger/repos",
      "events_url": "https://api.github.com/users/Ms2ger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Ms2ger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-27T10:50:00Z",
    "updated_at": "2015-11-27T10:50:00Z",
    "body": "A little simpler:\n\n``` rust\npub enum Instruction {\n    Increment(i8),\n    Loop(Vec<Box<Instruction>>),\n}\n\n/// Defines a method on iterators to map a function over all loop bodies.\nfn map_loops<F, I>(it: I, f: F) -> Vec<Box<Instruction>>\n    where F: Fn(Vec<Box<Instruction>>) -> Vec<Box<Instruction>>,\n          I: Iterator<Item=Box<Instruction>>\n{\n    it.map(|instr| {\n        match *instr {\n            Instruction::Loop(body) => Box::new( Instruction::Loop(f(body)) ),\n            other => Box::new(other)\n        }\n    }).collect()\n}\n\n/// Remove any loops where we know the current cell is zero.\npub fn remove_dead_loops(instrs: Vec<Box<Instruction>>) -> Vec<Box<Instruction>> {\n    map_loops(instrs.into_iter()\n          .enumerate()\n          .map(|(_, instr)| instr), remove_dead_loops)\n}\n\nfn main() {\n    let mut instrs = vec![];\n    instrs = remove_dead_loops(instrs);\n    println!(\"{:?}\", instrs.len());\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160111714/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160116949",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-160116949",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 160116949,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MDExNjk0OQ==",
    "user": {
      "login": "mitaa",
      "id": 6785936,
      "node_id": "MDQ6VXNlcjY3ODU5MzY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6785936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mitaa",
      "html_url": "https://github.com/mitaa",
      "followers_url": "https://api.github.com/users/mitaa/followers",
      "following_url": "https://api.github.com/users/mitaa/following{/other_user}",
      "gists_url": "https://api.github.com/users/mitaa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mitaa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mitaa/subscriptions",
      "organizations_url": "https://api.github.com/users/mitaa/orgs",
      "repos_url": "https://api.github.com/users/mitaa/repos",
      "events_url": "https://api.github.com/users/mitaa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mitaa/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-27T11:12:53Z",
    "updated_at": "2015-11-27T15:46:57Z",
    "body": "``` rust\npub enum Instruction {\n    Increment(i8),\n    Loop(Box<Box<()>>),\n}\n\nfn main() {\n    let instrs: Option<(u8, Box<Instruction>)> = None;\n    instrs.into_iter()\n          .map(|(_, instr)| instr)\n          .map(|instr| match *instr { _other => {} })\n          .last();\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160116949/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160229682",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-160229682",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 160229682,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MDIyOTY4Mg==",
    "user": {
      "login": "thepowersgang",
      "id": 955596,
      "node_id": "MDQ6VXNlcjk1NTU5Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/955596?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thepowersgang",
      "html_url": "https://github.com/thepowersgang",
      "followers_url": "https://api.github.com/users/thepowersgang/followers",
      "following_url": "https://api.github.com/users/thepowersgang/following{/other_user}",
      "gists_url": "https://api.github.com/users/thepowersgang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thepowersgang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thepowersgang/subscriptions",
      "organizations_url": "https://api.github.com/users/thepowersgang/orgs",
      "repos_url": "https://api.github.com/users/thepowersgang/repos",
      "events_url": "https://api.github.com/users/thepowersgang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thepowersgang/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-28T00:38:07Z",
    "updated_at": "2015-11-28T00:38:07Z",
    "body": "@mitaa - That code leads to main being just `ud2`. May or may not be related.\n\n```\n00000000000054d0 <_ZN4main20h5435d5ad9987115aoaaE>:\n    54d0:       55                      push   %rbp\n    54d1:       48 89 e5                mov    %rsp,%rbp\n    54d4:       0f 0b                   ud2    \n    54d6:       66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)\n    54dd:       00 00 00 \n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160229682/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160335882",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-160335882",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 160335882,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MDMzNTg4Mg==",
    "user": {
      "login": "arielb1",
      "id": 1830974,
      "node_id": "MDQ6VXNlcjE4MzA5NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arielb1",
      "html_url": "https://github.com/arielb1",
      "followers_url": "https://api.github.com/users/arielb1/followers",
      "following_url": "https://api.github.com/users/arielb1/following{/other_user}",
      "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions",
      "organizations_url": "https://api.github.com/users/arielb1/orgs",
      "repos_url": "https://api.github.com/users/arielb1/repos",
      "events_url": "https://api.github.com/users/arielb1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arielb1/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-28T21:16:12Z",
    "updated_at": "2015-11-28T21:16:12Z",
    "body": "cc @dotdash \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160335882/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160701538",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-160701538",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 160701538,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MDcwMTUzOA==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-30T17:38:41Z",
    "updated_at": "2015-11-30T17:38:41Z",
    "body": "@mitaa's example doesn't lead directly to `ud2` for me. For some reason, the second closure is getting called there though, with `instr` being a `nullptr`, i.e. `map` is calling the closure with a `None` value. Not sure why that happens yet.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/160701538/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161003066",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-161003066",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 161003066,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTAwMzA2Ng==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-01T15:34:10Z",
    "updated_at": "2015-12-01T15:34:10Z",
    "body": "It's our null check elimination pass. At some point, the optimizer replaces something like\n\n``` llvm\n%cmp = icmp eq i8* %ptr, null\n%thing = getelementptr i8, i8* %ptr, i64 0\n%ptr = select i1 %cmp, i8* null, i8* %thing\n%cond = icmp eq i8* %ptr, null\nbr i1 %cond, label %none, label %some\n```\n\nwith just\n\n``` llvm\n%ptr = getelementptr inbounds i8, i8* %ptr, i64 0\n%cond = icmp eq i8* %ptr, null\nbr i1 %cond, label %none, label %some\n```\n\nAnd then the null check elimination pass turns that into\n\n``` llvm\n%ptr = getelementptr inbounds i8, i8* %ptr, i64 0\n%cond = icmp eq i8* %ptr, null\nbr i1 false, label %none, label %some\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161003066/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161036602",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-161036602",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 161036602,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTAzNjYwMg==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-01T17:13:34Z",
    "updated_at": "2015-12-01T17:13:34Z",
    "body": "Interesting! I'd personally be ok just removing that pass from our LLVM build until we can get around to fixing this.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161036602/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161062098",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-161062098",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 161062098,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTA2MjA5OA==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-01T18:56:28Z",
    "updated_at": "2015-12-01T18:56:28Z",
    "body": "Same for me. I wonder how much the pass even does for us now.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161062098/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161240974",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-161240974",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 161240974,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTI0MDk3NA==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-02T09:48:47Z",
    "updated_at": "2015-12-02T09:48:47Z",
    "body": "As I'm too lazy to perform a detailed analysis of the changes, here's a plain size comparison:\n\nWith the pass enabled:\n\n```\n   text    data     bss     dec     hex filename\n   9021   38039       8   47068    b7dc libarena-71b07a99.so\n  32907   12731       4   45642    b24a libflate-71b07a99.so\n  19346   40102       8   59456    e840 libfmt_macros-71b07a99.so\n  60612   69884       4  130500   1fdc4 libgetopts-71b07a99.so\n  12470   47663       8   60141    eaed libgraphviz-71b07a99.so\n  25720   23692      24   49436    c11c liblog-71b07a99.so\n  49696  103757       8  153461   25775 librbml-71b07a99.so\n3326326 3204586      32 6530944  63a780 librustc-71b07a99.so\n 216406   87608       8  304022   4a396 librustc_back-71b07a99.so\n 303578  176852       4  480434   754b2 librustc_borrowck-71b07a99.so\n  18669  148090       4  166763   28b6b librustc_data_structures-71b07a99.so\n1914982  121522      12 2036516  1f1324 librustc_driver-71b07a99.so\n 730220 1487287      16 2217523  21d633 librustc_front-71b07a99.so\n 259036   65615       8  324659   4f433 librustc_lint-71b07a99.so\n29220031        1896283  105744 31222058        1dc692a librustc_llvm-71b07a99.so\n1555916  217260       4 1773180  1b0e7c librustc_metadata-71b07a99.so\n 420615  164949       8  585572   8ef64 librustc_mir-71b07a99.so\n 927001   39807       8  966816   ec0a0 librustc_platform_intrinsics-71b07a99.so\n  39483   11805       8   51296    c860 librustc_plugin-71b07a99.so\n  89501   21744       8  111253   1b295 librustc_privacy-71b07a99.so\n 408297  163572       4  571873   8b9e1 librustc_resolve-71b07a99.so\n2255972  712481      12 2968465  2d4b91 librustc_trans-71b07a99.so\n1733482  559332       4 2292818  22fc52 librustc_typeck-71b07a99.so\n3183929  702455      24 3886408  3b4d48 librustdoc-71b07a99.so\n 162448  496300      16  658764   a0d4c libserialize-71b07a99.so\n1625883 1808437    5912 3440232  347e68 libstd-71b07a99.so\n3993545 3045683      24 7039252  6b6914 libsyntax-71b07a99.so\n 139879   87268       4  227151   3774f libterm-71b07a99.so\n 215919  126614      16  342549   53a15 libtest-71b07a99.so\n```\n\nWith the pass disabled:\n\n```\n   text    data     bss     dec     hex filename\n   9021   38037       8   47066    b7da libarena-71b07a99.so\n  32863   12725       8   45596    b21c libflate-71b07a99.so\n  19346   40109       8   59463    e847 libfmt_macros-71b07a99.so\n  60572   69879       8  130459   1fd9b libgetopts-71b07a99.so\n  12470   47663       8   60141    eaed libgraphviz-71b07a99.so\n  25756   23682      24   49462    c136 liblog-71b07a99.so\n  49680  103762       4  153446   25766 librbml-71b07a99.so\n3327398 3204506      32 6531936  63ab60 librustc-71b07a99.so\n 216430   87619       4  304053   4a3b5 librustc_back-71b07a99.so\n 302458  176868       4  479330   75062 librustc_borrowck-71b07a99.so\n  18669  148079       8  166756   28b64 librustc_data_structures-71b07a99.so\n1914726  121504       8 2036238  1f120e librustc_driver-71b07a99.so\n 730500 1487296      16 2217812  21d754 librustc_front-71b07a99.so\n 259096   65640       8  324744   4f488 librustc_lint-71b07a99.so\n29222032        1896257  105744 31224033        1dc70e1 librustc_llvm-71b07a99.so\n1556264  217305       4 1773573  1b1005 librustc_metadata-71b07a99.so\n 420447  164977       4  585428   8eed4 librustc_mir-71b07a99.so\n 927001   39810       4  966815   ec09f librustc_platform_intrinsics-71b07a99.so\n  39483   11804       4   51291    c85b librustc_plugin-71b07a99.so\n  89557   21748       4  111309   1b2cd librustc_privacy-71b07a99.so\n 408273  163546       4  571823   8b9af librustc_resolve-71b07a99.so\n2256060  712538      12 2968610  2d4c22 librustc_trans-71b07a99.so\n1733682  559378       4 2293064  22fd48 librustc_typeck-71b07a99.so\n3183961  702420      24 3886405  3b4d45 librustdoc-71b07a99.so\n 162432  496336      16  658784   a0d60 libserialize-71b07a99.so\n1625667 1808398    5912 3439977  347d69 libstd-71b07a99.so\n3993465 3045787      24 7039276  6b692c libsyntax-71b07a99.so\n 139883   87270       8  227161   37759 libterm-71b07a99.so\n 215891  126621      16  342528   53a00 libtest-71b07a99.so\n```\n\nWhich suggests that the effects of the pass are pretty minor. It was probably worth more back when it was introduced because we had fewer means of marking things as non-null in LLVM. Now that we're using thing like `!nonnull` on loads and passing fat pointers as separate values, marking the data pointer as `nonnull`, I guess LLVM can already do most of the optimizations that this pass did in the pass.\n\nSo I almost feel inclined to just drop the pass completely instead of just disabling it. Opinions?\n\ncc @rust-lang/compiler \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161240974/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161371570",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-161371570",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 161371570,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2MTM3MTU3MA==",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-12-02T17:25:45Z",
    "updated_at": "2015-12-02T17:25:45Z",
    "body": "This happens on the beta channel too.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/161371570/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/168405523",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-168405523",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 168405523,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2ODQwNTUyMw==",
    "user": {
      "login": "ranma42",
      "id": 1506030,
      "node_id": "MDQ6VXNlcjE1MDYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1506030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ranma42",
      "html_url": "https://github.com/ranma42",
      "followers_url": "https://api.github.com/users/ranma42/followers",
      "following_url": "https://api.github.com/users/ranma42/following{/other_user}",
      "gists_url": "https://api.github.com/users/ranma42/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ranma42/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ranma42/subscriptions",
      "organizations_url": "https://api.github.com/users/ranma42/orgs",
      "repos_url": "https://api.github.com/users/ranma42/repos",
      "events_url": "https://api.github.com/users/ranma42/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ranma42/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-01-02T16:39:54Z",
    "updated_at": "2016-01-02T16:39:54Z",
    "body": "@dotdash both transformations look legitimate to me: `%ptr` is always dereferenced, thus it should be guaranteed to either fault (SEGV?) or be non-null. Is it possible that there is a codeine issue?\n\nHow could I try to reproduce your results? Is it sufficient to compile without optimisation and to run them manually with `opt`?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/168405523/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/168406974",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-168406974",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 168406974,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2ODQwNjk3NA==",
    "user": {
      "login": "dotdash",
      "id": 230962,
      "node_id": "MDQ6VXNlcjIzMDk2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dotdash",
      "html_url": "https://github.com/dotdash",
      "followers_url": "https://api.github.com/users/dotdash/followers",
      "following_url": "https://api.github.com/users/dotdash/following{/other_user}",
      "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions",
      "organizations_url": "https://api.github.com/users/dotdash/orgs",
      "repos_url": "https://api.github.com/users/dotdash/repos",
      "events_url": "https://api.github.com/users/dotdash/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dotdash/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-01-02T16:56:17Z",
    "updated_at": "2016-01-02T16:56:17Z",
    "body": "@ranma42 Yes, that should work to reproduce it, if you use `opt` from your rust build that still has the NCE pass.\n\nI'm not sure where you're seeing a dereference there though. In the original IR, the deref only happens when the pointer is non-null. There's a slight mistake in the IR samples above, because I reused the name `%ptr` and forgot the `inbounds` on the first GEP, here's a fixed version:\n\n``` llvm\n%cmp = icmp eq i8* %ptr, null\n%thing = getelementptr inbounds i8, i8* %ptr, i64 0\n%ptr2 = select i1 %cmp, i8* null, i8* %thing\n%cond = icmp eq i8* %ptr2, null\nbr i1 %cond, label %none, label %some\n```\n\nHere, `%ptr2` will be `null` if `%ptr` is null, and `%thing` otherwise. So if `%ptr` is null, we'll take the branch to `%none` and all is good.\n\nNow, after the first transformation we have:\n\n``` llvm\n%ptr2 = getelementptr inbounds i8, i8* %ptr, i64 0\n%cond = icmp eq i8* %ptr2, null\nbr i1 %cond, label %none, label %some\n```\n\nAnd that happened because it assumed that `%thing` will be `null` if `%ptr` is null, which is a direct contradiction to the assumption upon which the NCE pass is based, because `%thing` is the result of an `inbounds` GEP.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/168406974/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/168412650",
    "html_url": "https://github.com/rust-lang/rust/issues/30081#issuecomment-168412650",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/30081",
    "id": 168412650,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE2ODQxMjY1MA==",
    "user": {
      "login": "ranma42",
      "id": 1506030,
      "node_id": "MDQ6VXNlcjE1MDYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1506030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ranma42",
      "html_url": "https://github.com/ranma42",
      "followers_url": "https://api.github.com/users/ranma42/followers",
      "following_url": "https://api.github.com/users/ranma42/following{/other_user}",
      "gists_url": "https://api.github.com/users/ranma42/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ranma42/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ranma42/subscriptions",
      "organizations_url": "https://api.github.com/users/ranma42/orgs",
      "repos_url": "https://api.github.com/users/ranma42/repos",
      "events_url": "https://api.github.com/users/ranma42/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ranma42/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-01-02T18:01:49Z",
    "updated_at": "2016-01-02T18:01:49Z",
    "body": "Sorry, you're right, there is no dereference; also, with the full names it is definitely easier to read :)\n\nI am not completely sure about this, but I am afraid it might be the expected behaviour of LLVM poison values :\\\n\nIn the first code, if `%ptr` is not `null`, everything should evaluate to this:\n\n``` llvm\n%cmp = false\n%thing = %ptr\n%ptr2 = %ptr\n%cond = false\nbr label %some\n```\n\nIf `%ptr` is null, instead:\n\n``` llvm\n%cmp = true\n%thing = poison\n%ptr2 = poison ; \"Values other than phi nodes depend on their operands.\" :\\\n%cond = poison\nbr i1 %cond, label %none, label %some\n```\n\nIn particular, I am unsure whether \"`%ptr2` will be null if `%ptr` is null\" is correct, given the poison propagation rules from http://llvm.org/releases/3.7.0/docs/LangRef.html#poisonvalues\nThere is an open bug against the documentation of these rules (and in particular of their interaction with `select`) https://llvm.org/bugs/show_bug.cgi?id=20895\nIt looks like there is some consensus that `select` should not be poisoned as other operations, but it is now unclear to me what LLVM is doing and what it is supposed to do :(\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/168412650/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
