{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/15983",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/15983/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/15983/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/15983/events",
  "html_url": "https://github.com/rust-lang/rust/pull/15983",
  "id": 38764252,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTg5MTU1MDc=",
  "number": 15983,
  "title": "Reduce text size for fail invocations",
  "user": {
    "login": "brson",
    "id": 147214,
    "node_id": "MDQ6VXNlcjE0NzIxNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brson",
    "html_url": "https://github.com/brson",
    "followers_url": "https://api.github.com/users/brson/followers",
    "following_url": "https://api.github.com/users/brson/following{/other_user}",
    "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
    "organizations_url": "https://api.github.com/users/brson/orgs",
    "repos_url": "https://api.github.com/users/brson/repos",
    "events_url": "https://api.github.com/users/brson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brson/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 8,
  "created_at": "2014-07-25T19:50:46Z",
  "updated_at": "2014-07-28T22:31:45Z",
  "closed_at": "2014-07-28T22:31:39Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/15983",
    "html_url": "https://github.com/rust-lang/rust/pull/15983",
    "diff_url": "https://github.com/rust-lang/rust/pull/15983.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/15983.patch",
    "merged_at": "2014-07-28T22:31:45Z"
  },
  "body": "A few refactorings to decrease text size and increase data size. I'm not sure about this tradeoff. Various stats below. cc @pcwalton\n\nThis reduces the code needed to pass arguments for `fail!()`, `fail!(\"{}\", ...)`, and to a lesser extent `fail!(\"...\")`. Still more work to be done on compiler-generated failures and the `fail!(\"...\")` case.\n\ndo_fail_empty:\n\n```\n#[inline(never)]\nfn do_fail_empty() {\n    fail!()\n}\n```\n\ndo_fail_empty before:\n\n```\n    leaq    8(%rsp), %rdi\n    movabsq $13, %rsi\n    leaq    \"str\\\"str\\\"(1494)\"(%rip), %rax\n    movq    %rax, 8(%rsp)\n    movq    $19, 16(%rsp)\n    callq   _ZN6unwind31begin_unwind_no_time_to_explain20h57030457935ab6111SdE@PLT\n```\n\ndo_fail_empty after:\n\n```\n    leaq    _ZN13do_fail_empty9file_line20h339df6a0541e837eIaaE(%rip), %rdi\n    callq   _ZN6unwind31begin_unwind_no_time_to_explain20h33184cfdcce4dfd8QTdE@PLT\n```\n\ndo_fail_fmt:\n\n```\n#[inline(never)]\nfn do_fail_fmt() {\n    fail!(\"guh{}\", \"faw\")\n}\n```\n\ndo_fail_fmt before:\n\n```\n        ... (snip lots of fmt stuff)\n    callq   _ZN3fmt22Arguments$LT$$x27a$GT$3new20he09b3a3f473879c41paE\n    leaq    144(%rsp), %rsi\n    movabsq $23, %rdx\n    leaq    \"str\\\"str\\\"(1494)\"(%rip), %rax\n    leaq    32(%rsp), %rcx\n    movq    %rcx, 160(%rsp)\n    movq    160(%rsp), %rdi\n    movq    %rax, 144(%rsp)\n    movq    $19, 152(%rsp)\n    callq   _ZN6unwind16begin_unwind_fmt20h3ebeb42f4d189b2buQdE@PLT\n```\n\ndo_fail_fmt after:\n\n```\n        ... (snip lots of fmt stuff)\n    callq   _ZN3fmt22Arguments$LT$$x27a$GT$3new20h42e5bb8d1711ee61OqaE\n    leaq    _ZN11do_fail_fmt7run_fmt9file_line20h339df6a0541e837eFbaE(%rip), %rsi\n    leaq    32(%rsp), %rax\n    movq    %rax, 144(%rsp)\n    movq    144(%rsp), %rdi\n    callq   _ZN6unwind16begin_unwind_fmt20hfdcadc14d188656biRdE@PLT\n```\n\nFile size increases.\n\nfile size before:\n\n```\n-rw-rw-r-- 1 brian brian 100501740 Jul 24 23:28 /home/brian/dev/rust2/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc-4e7c5e5c.rlib\n-rwxrwxr-x 1 brian brian  21201780 Jul 24 23:27 /home/brian/dev/rust2/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc-4e7c5e5c.so\n```\n\nfile size after:\n\n```\n-rw-rw-r-- 1 brian brian 101542484 Jul 25 00:34 x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc-4e7c5e5c.rlib\n-rwxrwxr-x 1 brian brian  21348862 Jul 25 00:34 x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc-4e7c5e5c.so\n```\n\nText size decreases by 52486 while data size increases by 143686.\n\nsection size before:\n\n```\n   text    data     bss     dec     hex filename\n12712262        5924997     368 18637627        11c633b x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc-4e7c5e5c.so\n```\n\nsection size after:\n\n```\n   text    data     bss     dec     hex filename\n12659776        6068683     368 18728827        11dc77b /home/brian/dev/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc-4e7c5e5c.so\n```\n\nI don't know if anything can be learned from these benchmarks. Looks like a wash.\n\nstd bench before:\n\n```\ntest collections::hashmap::bench::find_existing             ... bench:     43452 ns/iter (+/- 2423)\ntest collections::hashmap::bench::find_nonexisting          ... bench:     42416 ns/iter (+/- 3996)\ntest collections::hashmap::bench::find_pop_insert           ... bench:       214 ns/iter (+/- 11)\ntest collections::hashmap::bench::hashmap_as_queue          ... bench:       123 ns/iter (+/- 6)\ntest collections::hashmap::bench::insert                    ... bench:       153 ns/iter (+/- 14)\ntest collections::hashmap::bench::new_drop                  ... bench:       547 ns/iter (+/- 259)\ntest collections::hashmap::bench::new_insert_drop           ... bench:       682 ns/iter (+/- 366)\ntest io::buffered::test::bench_buffered_reader              ... bench:      1046 ns/iter (+/- 86)\ntest io::buffered::test::bench_buffered_stream              ... bench:      2156 ns/iter (+/- 801)\ntest io::buffered::test::bench_buffered_writer              ... bench:      1057 ns/iter (+/- 75)\ntest io::extensions::bench::u64_from_be_bytes_4_aligned     ... bench:        80 ns/iter (+/- 5)\ntest io::extensions::bench::u64_from_be_bytes_4_unaligned   ... bench:        81 ns/iter (+/- 6)\ntest io::extensions::bench::u64_from_be_bytes_7_aligned     ... bench:        80 ns/iter (+/- 4)\ntest io::extensions::bench::u64_from_be_bytes_7_unaligned   ... bench:        69 ns/iter (+/- 4)\ntest io::extensions::bench::u64_from_be_bytes_8_aligned     ... bench:        69 ns/iter (+/- 3)\ntest io::extensions::bench::u64_from_be_bytes_8_unaligned   ... bench:        81 ns/iter (+/- 4)\ntest io::mem::test::bench_buf_reader                        ... bench:       628 ns/iter (+/- 18)\ntest io::mem::test::bench_buf_writer                        ... bench:       478 ns/iter (+/- 19)\ntest io::mem::test::bench_mem_reader                        ... bench:       712 ns/iter (+/- 44)\ntest io::mem::test::bench_mem_writer_001_0000               ... bench:        31 ns/iter (+/- 1)\ntest io::mem::test::bench_mem_writer_001_0010               ... bench:        51 ns/iter (+/- 3)\ntest io::mem::test::bench_mem_writer_001_0100               ... bench:       121 ns/iter (+/- 8)\ntest io::mem::test::bench_mem_writer_001_1000               ... bench:       774 ns/iter (+/- 47)\ntest io::mem::test::bench_mem_writer_100_0000               ... bench:       756 ns/iter (+/- 50)\ntest io::mem::test::bench_mem_writer_100_0010               ... bench:      2726 ns/iter (+/- 198)\ntest io::mem::test::bench_mem_writer_100_0100               ... bench:      8961 ns/iter (+/- 712)\ntest io::mem::test::bench_mem_writer_100_1000               ... bench:    105673 ns/iter (+/- 24711)\ntest num::bench::bench_pow_function                         ... bench:      5849 ns/iter (+/- 371)\ntest num::strconv::bench::f64::float_to_string              ... bench:       662 ns/iter (+/- 202)\ntest num::strconv::bench::int::to_str_base_36               ... bench:       424 ns/iter (+/- 7)\ntest num::strconv::bench::int::to_str_bin                   ... bench:      1227 ns/iter (+/- 80)\ntest num::strconv::bench::int::to_str_dec                   ... bench:       466 ns/iter (+/- 13)\ntest num::strconv::bench::int::to_str_hex                   ... bench:       498 ns/iter (+/- 22)\ntest num::strconv::bench::int::to_str_oct                   ... bench:       502 ns/iter (+/- 229)\ntest num::strconv::bench::uint::to_str_base_36              ... bench:       375 ns/iter (+/- 7)\ntest num::strconv::bench::uint::to_str_bin                  ... bench:      1011 ns/iter (+/- 590)\ntest num::strconv::bench::uint::to_str_dec                  ... bench:       407 ns/iter (+/- 17)\ntest num::strconv::bench::uint::to_str_hex                  ... bench:       442 ns/iter (+/- 7)\ntest num::strconv::bench::uint::to_str_oct                  ... bench:       433 ns/iter (+/- 46)\ntest path::posix::bench::ends_with_path_home_dir            ... bench:       167 ns/iter (+/- 10)\ntest path::posix::bench::ends_with_path_missmatch_jome_home ... bench:       148 ns/iter (+/- 6)\ntest path::posix::bench::is_ancestor_of_path_with_10_dirs   ... bench:       221 ns/iter (+/- 31)\ntest path::posix::bench::join_abs_path_home_dir             ... bench:       144 ns/iter (+/- 23)\ntest path::posix::bench::join_home_dir                      ... bench:       196 ns/iter (+/- 9)\ntest path::posix::bench::join_many_abs_path_home_dir        ... bench:       143 ns/iter (+/- 6)\ntest path::posix::bench::join_many_home_dir                 ... bench:       195 ns/iter (+/- 8)\ntest path::posix::bench::path_relative_from_backward        ... bench:       248 ns/iter (+/- 10)\ntest path::posix::bench::path_relative_from_forward         ... bench:       241 ns/iter (+/- 13)\ntest path::posix::bench::path_relative_from_same_level      ... bench:       296 ns/iter (+/- 11)\ntest path::posix::bench::push_abs_path_home_dir             ... bench:       104 ns/iter (+/- 7)\ntest path::posix::bench::push_home_dir                      ... bench:     27311 ns/iter (+/- 2727)\ntest path::posix::bench::push_many_abs_path_home_dir        ... bench:       109 ns/iter (+/- 5)\ntest path::posix::bench::push_many_home_dir                 ... bench:     23263 ns/iter (+/- 1726)\ntest rand::bench::rand_isaac                                ... bench:       884 ns/iter (+/- 31) = 904 MB/s\ntest rand::bench::rand_isaac64                              ... bench:       440 ns/iter (+/- 126) = 1818 MB/s\ntest rand::bench::rand_shuffle_100                          ... bench:      2518 ns/iter (+/- 1371)\ntest rand::bench::rand_std                                  ... bench:       429 ns/iter (+/- 17) = 1864 MB/s\ntest rand::bench::rand_xorshift                             ... bench:         0 ns/iter (+/- 0) = 800000 MB/s\n```\n\nstd bench after:\n\n```\ntest collections::hashmap::bench::find_existing             ... bench:     43635 ns/iter (+/- 4508)\ntest collections::hashmap::bench::find_nonexisting          ... bench:     42323 ns/iter (+/- 1753)\ntest collections::hashmap::bench::find_pop_insert           ... bench:       216 ns/iter (+/- 11)\ntest collections::hashmap::bench::hashmap_as_queue          ... bench:       125 ns/iter (+/- 8)\ntest collections::hashmap::bench::insert                    ... bench:       153 ns/iter (+/- 63)\ntest collections::hashmap::bench::new_drop                  ... bench:       517 ns/iter (+/- 282)\ntest collections::hashmap::bench::new_insert_drop           ... bench:       734 ns/iter (+/- 264)\ntest io::buffered::test::bench_buffered_reader              ... bench:      1063 ns/iter (+/- 206)\ntest io::buffered::test::bench_buffered_stream              ... bench:      2321 ns/iter (+/- 2302)\ntest io::buffered::test::bench_buffered_writer              ... bench:      1060 ns/iter (+/- 24)\ntest io::extensions::bench::u64_from_be_bytes_4_aligned     ... bench:        69 ns/iter (+/- 2)\ntest io::extensions::bench::u64_from_be_bytes_4_unaligned   ... bench:        81 ns/iter (+/- 7)\ntest io::extensions::bench::u64_from_be_bytes_7_aligned     ... bench:        70 ns/iter (+/- 5)\ntest io::extensions::bench::u64_from_be_bytes_7_unaligned   ... bench:        69 ns/iter (+/- 5)\ntest io::extensions::bench::u64_from_be_bytes_8_aligned     ... bench:        80 ns/iter (+/- 6)\ntest io::extensions::bench::u64_from_be_bytes_8_unaligned   ... bench:        81 ns/iter (+/- 5)\ntest io::mem::test::bench_buf_reader                        ... bench:       663 ns/iter (+/- 44)\ntest io::mem::test::bench_buf_writer                        ... bench:       489 ns/iter (+/- 17)\ntest io::mem::test::bench_mem_reader                        ... bench:       700 ns/iter (+/- 23)\ntest io::mem::test::bench_mem_writer_001_0000               ... bench:        31 ns/iter (+/- 3)\ntest io::mem::test::bench_mem_writer_001_0010               ... bench:        49 ns/iter (+/- 5)\ntest io::mem::test::bench_mem_writer_001_0100               ... bench:       112 ns/iter (+/- 6)\ntest io::mem::test::bench_mem_writer_001_1000               ... bench:       765 ns/iter (+/- 59)\ntest io::mem::test::bench_mem_writer_100_0000               ... bench:       727 ns/iter (+/- 54)\ntest io::mem::test::bench_mem_writer_100_0010               ... bench:      2586 ns/iter (+/- 215)\ntest io::mem::test::bench_mem_writer_100_0100               ... bench:      8846 ns/iter (+/- 439)\ntest io::mem::test::bench_mem_writer_100_1000               ... bench:    105747 ns/iter (+/- 17443)\ntest num::bench::bench_pow_function                         ... bench:      5844 ns/iter (+/- 421)\ntest num::strconv::bench::f64::float_to_string              ... bench:       669 ns/iter (+/- 571)\ntest num::strconv::bench::int::to_str_base_36               ... bench:       417 ns/iter (+/- 24)\ntest num::strconv::bench::int::to_str_bin                   ... bench:      1216 ns/iter (+/- 36)\ntest num::strconv::bench::int::to_str_dec                   ... bench:       466 ns/iter (+/- 24)\ntest num::strconv::bench::int::to_str_hex                   ... bench:       492 ns/iter (+/- 8)\ntest num::strconv::bench::int::to_str_oct                   ... bench:       496 ns/iter (+/- 295)\ntest num::strconv::bench::uint::to_str_base_36              ... bench:       366 ns/iter (+/- 8)\ntest num::strconv::bench::uint::to_str_bin                  ... bench:      1005 ns/iter (+/- 69)\ntest num::strconv::bench::uint::to_str_dec                  ... bench:       396 ns/iter (+/- 20)\ntest num::strconv::bench::uint::to_str_hex                  ... bench:       435 ns/iter (+/- 4)\ntest num::strconv::bench::uint::to_str_oct                  ... bench:       436 ns/iter (+/- 451)\ntest path::posix::bench::ends_with_path_home_dir            ... bench:       171 ns/iter (+/- 6)\ntest path::posix::bench::ends_with_path_missmatch_jome_home ... bench:       152 ns/iter (+/- 6)\ntest path::posix::bench::is_ancestor_of_path_with_10_dirs   ... bench:       215 ns/iter (+/- 8)\ntest path::posix::bench::join_abs_path_home_dir             ... bench:       143 ns/iter (+/- 6)\ntest path::posix::bench::join_home_dir                      ... bench:       192 ns/iter (+/- 29)\ntest path::posix::bench::join_many_abs_path_home_dir        ... bench:       144 ns/iter (+/- 9)\ntest path::posix::bench::join_many_home_dir                 ... bench:       194 ns/iter (+/- 19)\ntest path::posix::bench::path_relative_from_backward        ... bench:       254 ns/iter (+/- 15)\ntest path::posix::bench::path_relative_from_forward         ... bench:       244 ns/iter (+/- 17)\ntest path::posix::bench::path_relative_from_same_level      ... bench:       293 ns/iter (+/- 27)\ntest path::posix::bench::push_abs_path_home_dir             ... bench:       108 ns/iter (+/- 5)\ntest path::posix::bench::push_home_dir                      ... bench:     32292 ns/iter (+/- 4361)\ntest path::posix::bench::push_many_abs_path_home_dir        ... bench:       108 ns/iter (+/- 6)\ntest path::posix::bench::push_many_home_dir                 ... bench:     20305 ns/iter (+/- 1331)\ntest rand::bench::rand_isaac                                ... bench:       888 ns/iter (+/- 35) = 900 MB/s\ntest rand::bench::rand_isaac64                              ... bench:       439 ns/iter (+/- 17) = 1822 MB/s\ntest rand::bench::rand_shuffle_100                          ... bench:      2582 ns/iter (+/- 1001)\ntest rand::bench::rand_std                                  ... bench:       431 ns/iter (+/- 93) = 1856 MB/s\ntest rand::bench::rand_xorshift                             ... bench:         0 ns/iter (+/- 0) = 800000 MB/s\n```\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/15983/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/15983/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
