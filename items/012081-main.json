{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/12081",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/12081/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/12081/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/12081/events",
  "html_url": "https://github.com/rust-lang/rust/pull/12081",
  "id": 27105241,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTIyOTc3MDE=",
  "number": 12081,
  "title": "Robin hood hashmap",
  "user": {
    "login": "cgaebel",
    "id": 128969,
    "node_id": "MDQ6VXNlcjEyODk2OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/128969?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cgaebel",
    "html_url": "https://github.com/cgaebel",
    "followers_url": "https://api.github.com/users/cgaebel/followers",
    "following_url": "https://api.github.com/users/cgaebel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cgaebel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cgaebel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cgaebel/subscriptions",
    "organizations_url": "https://api.github.com/users/cgaebel/orgs",
    "repos_url": "https://api.github.com/users/cgaebel/repos",
    "events_url": "https://api.github.com/users/cgaebel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cgaebel/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 52,
  "created_at": "2014-02-07T02:26:47Z",
  "updated_at": "2014-06-12T19:08:15Z",
  "closed_at": "2014-03-13T02:16:46Z",
  "author_association": "NONE",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/12081",
    "html_url": "https://github.com/rust-lang/rust/pull/12081",
    "diff_url": "https://github.com/rust-lang/rust/pull/12081.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/12081.patch",
    "merged_at": "2014-03-13T02:16:46Z"
  },
  "body": "Partially addresses #11783.\n\nPreviously, rust's hashtable was totally unoptimized. It used an Option\nper key-value pair, and used very naive open allocation.\n\nThe old hashtable had very high variance in lookup time. For an example,\nsee the 'find_nonexisting' benchmark below. This is fixed by keys in\n'lucky' spots with a low probe sequence length getting their good spots\nstolen by keys with long probe sequence lengths. This reduces hashtable\nprobe length variance, while maintaining the same mean.\n\nAlso, other optimization liberties were taken. Everything is as cache\naware as possible, and this hashtable should perform extremely well for\nboth large and small keys and values.\n\nBenchmarks:\n\n```\ncomprehensive_old_hashmap         378 ns/iter (+/- 8)\ncomprehensive_new_hashmap         206 ns/iter (+/- 4)\n1.8x faster\n\nold_hashmap_as_queue              238 ns/iter (+/- 8)\nnew_hashmap_as_queue              119 ns/iter (+/- 2)\n2x faster\n\nold_hashmap_insert                172 ns/iter (+/- 8)\nnew_hashmap_insert                146 ns/iter (+/- 11)\n1.17x faster\n\nold_hashmap_find_existing         50 ns/iter (+/- 12)\nnew_hashmap_find_existing         35 ns/iter (+/- 6)\n1.43x faster\n\nold_hashmap_find_notexisting      49 ns/iter (+/- 49)\nnew_hashmap_find_notexisting      34 ns/iter (+/- 4)\n1.44x faster\n\nMemory usage of old hashtable (64-bit assumed):\n\naligned(8+sizeof(Option)+sizeof(K)+sizeof(V))/0.75 + 48ish bytes\n\nMemory usage of new hashtable:\n\n(aligned(sizeof(K))\n+ aligned(sizeof(V))\n+ 8)/0.9 + 112ish bytes\n\nTiming of building librustc:\n\ncompile_and_link: x86_64-unknown-linux-gnu/stage0/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc\ntime: 0.457 s   parsing\ntime: 0.028 s   gated feature checking\ntime: 0.000 s   crate injection\ntime: 0.108 s   configuration 1\ntime: 1.049 s   expansion\ntime: 0.219 s   configuration 2\ntime: 0.222 s   maybe building test harness\ntime: 0.223 s   prelude injection\ntime: 0.268 s   assinging node ids and indexing ast\ntime: 0.075 s   external crate/lib resolution\ntime: 0.026 s   language item collection\ntime: 1.016 s   resolution\ntime: 0.038 s   lifetime resolution\ntime: 0.000 s   looking for entry point\ntime: 0.030 s   looking for macro registrar\ntime: 0.061 s   freevar finding\ntime: 0.138 s   region resolution\ntime: 0.110 s   type collecting\ntime: 0.072 s   variance inference\ntime: 0.126 s   coherence checking\ntime: 9.110 s   type checking\ntime: 0.186 s   const marking\ntime: 0.049 s   const checking\ntime: 0.418 s   privacy checking\ntime: 0.057 s   effect checking\ntime: 0.033 s   loop checking\ntime: 1.293 s   compute moves\ntime: 0.182 s   match checking\ntime: 0.242 s   liveness checking\ntime: 0.866 s   borrow checking\ntime: 0.150 s   kind checking\ntime: 0.013 s   reachability checking\ntime: 0.175 s   death checking\ntime: 0.461 s   lint checking\ntime: 13.112 s  translation\n  time: 4.352 s llvm function passes\n  time: 96.702 s    llvm module passes\n  time: 50.574 s    codegen passes\ntime: 154.611 s LLVM passes\n  time: 2.821 s running linker\ntime: 15.750 s  linking\n\n\ncompile_and_link: x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc\ntime: 0.422 s   parsing\ntime: 0.031 s   gated feature checking\ntime: 0.000 s   crate injection\ntime: 0.126 s   configuration 1\ntime: 1.014 s   expansion\ntime: 0.251 s   configuration 2\ntime: 0.249 s   maybe building test harness\ntime: 0.273 s   prelude injection\ntime: 0.279 s   assinging node ids and indexing ast\ntime: 0.076 s   external crate/lib resolution\ntime: 0.033 s   language item collection\ntime: 1.028 s   resolution\ntime: 0.036 s   lifetime resolution\ntime: 0.000 s   looking for entry point\ntime: 0.029 s   looking for macro registrar\ntime: 0.063 s   freevar finding\ntime: 0.133 s   region resolution\ntime: 0.111 s   type collecting\ntime: 0.077 s   variance inference\ntime: 0.565 s   coherence checking\ntime: 8.953 s   type checking\ntime: 0.176 s   const marking\ntime: 0.050 s   const checking\ntime: 0.401 s   privacy checking\ntime: 0.063 s   effect checking\ntime: 0.032 s   loop checking\ntime: 1.291 s   compute moves\ntime: 0.172 s   match checking\ntime: 0.249 s   liveness checking\ntime: 0.831 s   borrow checking\ntime: 0.121 s   kind checking\ntime: 0.013 s   reachability checking\ntime: 0.179 s   death checking\ntime: 0.503 s   lint checking\ntime: 14.385 s  translation\n  time: 4.495 s llvm function passes\n  time: 92.234 s    llvm module passes\n  time: 51.172 s    codegen passes\ntime: 150.809 s LLVM passes\n  time: 2.542 s running linker\ntime: 15.109 s  linking\n```\n\nBUT accesses are much more cache friendly. In fact, if the probe\nsequence length is below 8, only two cache lines worth of hashes will be\npulled into cache. This is unlike the old version which would have to\nstride over the stoerd keys and values, and would be more cache\nunfriendly the bigger the stored values got.\n\nAnd did you notice the higher load factor? We can now reasonably get a\nload factor of 0.9 with very good performance.\n\nPlease review this very closely. This is my first major contribution to Rust. Sorry for the ugly diff!\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/12081/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/12081/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
