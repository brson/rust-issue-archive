[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158102391",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158102391",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158102391,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODEwMjM5MQ==",
    "user": {
      "login": "aturon",
      "id": 709807,
      "node_id": "MDQ6VXNlcjcwOTgwNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/709807?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aturon",
      "html_url": "https://github.com/aturon",
      "followers_url": "https://api.github.com/users/aturon/followers",
      "following_url": "https://api.github.com/users/aturon/following{/other_user}",
      "gists_url": "https://api.github.com/users/aturon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aturon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aturon/subscriptions",
      "organizations_url": "https://api.github.com/users/aturon/orgs",
      "repos_url": "https://api.github.com/users/aturon/repos",
      "events_url": "https://api.github.com/users/aturon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aturon/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-19T16:07:46Z",
    "updated_at": "2015-11-19T16:07:46Z",
    "body": "cc @briansmith\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158102391/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158102818",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158102818",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158102818,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODEwMjgxOA==",
    "user": {
      "login": "jdm",
      "id": 27658,
      "node_id": "MDQ6VXNlcjI3NjU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/27658?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jdm",
      "html_url": "https://github.com/jdm",
      "followers_url": "https://api.github.com/users/jdm/followers",
      "following_url": "https://api.github.com/users/jdm/following{/other_user}",
      "gists_url": "https://api.github.com/users/jdm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jdm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jdm/subscriptions",
      "organizations_url": "https://api.github.com/users/jdm/orgs",
      "repos_url": "https://api.github.com/users/jdm/repos",
      "events_url": "https://api.github.com/users/jdm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jdm/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-19T16:09:25Z",
    "updated_at": "2015-11-19T16:09:25Z",
    "body": "cc me\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158102818/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158110100",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158110100",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158110100,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODExMDEwMA==",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-19T16:31:35Z",
    "updated_at": "2015-11-19T16:31:35Z",
    "body": "> The question at hand is: is this ever worth it to check usable_capacity, and is it ever undesirable?\n\nI guess you mean s/usable_capacity/malloc_usable_size/.\n\n> If I invoke shrink_to_fit or with_capacity, it ought to not reallocate when I try to convert to a Box<[T]>\n\nI think that's a \"nice to have\" but not very important. Is real-world code doing `shrink_to_fit` and then `into_boxed_slice`? I searched the uses of `into_boxed_slice` and `into_boxed_str` in the Rust and Servo repos and it looks like they are rarely used in those repos. I think using those functions is a code smell, actually.\n\n> Rust's Vec is basically the community's malloc/calloc,\n\nI disagree with this. `Vec` is the data structure you use by default, and it should have good performance by default. For example, its the thing I `collect` iterators into by default. Some people might be using `Vec` to simulate `malloc`, but I think that's much more rare. I use `with_capacity(N)` because I know I'm going to be pushing at least `N` elements into the vector and I don't want to be wasteful; I'm noever using it because I want to create a boxed slice with `N` elements in it. It makes sense to have a separate interface for people that want a \"safe\" malloc; perhaps that separate interface would just be additional stuff added to `Vec`. But I think the behavior of the common (existing) interface should be geared towards more naive uses.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158110100/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158138927",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158138927",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158138927,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODEzODkyNw==",
    "user": {
      "login": "SimonSapin",
      "id": 291359,
      "node_id": "MDQ6VXNlcjI5MTM1OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/291359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/SimonSapin",
      "html_url": "https://github.com/SimonSapin",
      "followers_url": "https://api.github.com/users/SimonSapin/followers",
      "following_url": "https://api.github.com/users/SimonSapin/following{/other_user}",
      "gists_url": "https://api.github.com/users/SimonSapin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/SimonSapin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SimonSapin/subscriptions",
      "organizations_url": "https://api.github.com/users/SimonSapin/orgs",
      "repos_url": "https://api.github.com/users/SimonSapin/repos",
      "events_url": "https://api.github.com/users/SimonSapin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/SimonSapin/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-19T18:02:13Z",
    "updated_at": "2015-11-19T18:02:13Z",
    "body": "> Rust's Vec is basically the community's malloc/calloc\n\nThat\u2019s a hack to work around the lack of proper stable API, not how it should be.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158138927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158141094",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158141094",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158141094,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODE0MTA5NA==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-19T18:11:09Z",
    "updated_at": "2015-11-19T18:11:09Z",
    "body": "Regardless of what we want to do now, we need to remove the \"guarantee\" in the nightly docs about capacity, which locks us in. We have no reason to promise all kinds of things about Vec internals.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158141094/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158314018",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158314018",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158314018,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODMxNDAxOA==",
    "user": {
      "login": "Ms2ger",
      "id": 111161,
      "node_id": "MDQ6VXNlcjExMTE2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/111161?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Ms2ger",
      "html_url": "https://github.com/Ms2ger",
      "followers_url": "https://api.github.com/users/Ms2ger/followers",
      "following_url": "https://api.github.com/users/Ms2ger/following{/other_user}",
      "gists_url": "https://api.github.com/users/Ms2ger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Ms2ger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Ms2ger/subscriptions",
      "organizations_url": "https://api.github.com/users/Ms2ger/orgs",
      "repos_url": "https://api.github.com/users/Ms2ger/repos",
      "events_url": "https://api.github.com/users/Ms2ger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Ms2ger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-20T07:50:31Z",
    "updated_at": "2015-11-20T07:50:31Z",
    "body": "CC @glandium\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158314018/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158350593",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158350593",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158350593,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODM1MDU5Mw==",
    "user": {
      "login": "Swatinem",
      "id": 580492,
      "node_id": "MDQ6VXNlcjU4MDQ5Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Swatinem",
      "html_url": "https://github.com/Swatinem",
      "followers_url": "https://api.github.com/users/Swatinem/followers",
      "following_url": "https://api.github.com/users/Swatinem/following{/other_user}",
      "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions",
      "organizations_url": "https://api.github.com/users/Swatinem/orgs",
      "repos_url": "https://api.github.com/users/Swatinem/repos",
      "events_url": "https://api.github.com/users/Swatinem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Swatinem/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-20T10:28:25Z",
    "updated_at": "2015-11-20T10:28:25Z",
    "body": "Maybe instead of actually using usable_size (which has a non-zero cost as you mentioned), the better thing to do would be to just round up to the nearest power-of-two (in bytes) for small allocations and to the nearest MiB for large ones, like mozillas nsTArray does.\n\nI have also looked a bit at the code, and at least VecDeque rounds up to the nearest pot (in elements), probably because it does a `+ 1` which is like the most wasteful thing to do related to this issue.\nThe docs for VecDeque btw say it reserves space for \"at least\" that many elements, not exactly.\n\nBtw, just grepping through the rustc code for `with_capacity` reveals a few cases where it does a `+ 1` as well.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158350593/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158387824",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158387824",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158387824,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODM4NzgyNA==",
    "user": {
      "login": "Gankra",
      "id": 1136864,
      "node_id": "MDQ6VXNlcjExMzY4NjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gankra",
      "html_url": "https://github.com/Gankra",
      "followers_url": "https://api.github.com/users/Gankra/followers",
      "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
      "organizations_url": "https://api.github.com/users/Gankra/orgs",
      "repos_url": "https://api.github.com/users/Gankra/repos",
      "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gankra/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-20T12:41:25Z",
    "updated_at": "2015-11-20T12:41:25Z",
    "body": "VecDeque needs to maintain its power of two capacity in order to support efficient modular arithmetic (just a bit mask). HashMap does the same.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158387824/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158405799",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158405799",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158405799,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODQwNTc5OQ==",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-20T13:41:24Z",
    "updated_at": "2015-11-20T13:41:24Z",
    "body": "FWIW, one can use constant-division tricks to do (relatively) efficient modular arithmetic, if the bit pattern is fixed (e.g. if the capacities are guaranteed to be either `1 << n` or `3 << n`). Of course, branching and then doing the multiplications/shifts for the latter case definitely isn't free.\n\n(I believe `x % (3 << n)` can be computed via something like: \n\n```\nx - ((x * C) >> (n + 1)) * (3 << n)\n```\n\nfor some constant `C`.)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158405799/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158430912",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158430912",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158430912,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODQzMDkxMg==",
    "user": {
      "login": "Gankra",
      "id": 1136864,
      "node_id": "MDQ6VXNlcjExMzY4NjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gankra",
      "html_url": "https://github.com/Gankra",
      "followers_url": "https://api.github.com/users/Gankra/followers",
      "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
      "organizations_url": "https://api.github.com/users/Gankra/orgs",
      "repos_url": "https://api.github.com/users/Gankra/repos",
      "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gankra/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-20T15:23:19Z",
    "updated_at": "2015-11-20T16:22:17Z",
    "body": "Oh and they both keep some slack capacity for similar perf reasons. Hashmap will only use 91% of its cap because it keeps access times down. VecDeque keeps an empty slot so that the \"two indices\" representation can differentiate between the empty and full state without us maintaining some flag that constantly needs to be checked/maintained.\n\nI would also like to slightly dissent on the point of Vec being a good malloc. It's an excellent memory-safe and exception-safe interface for acquiring, initializing, deinitializing, and releasing an allocation. It's a bad choice for lower-level uses (all the other collections), of course.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158430912/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158641129",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158641129",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158641129,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODY0MTEyOQ==",
    "user": {
      "login": "arthurprs",
      "id": 715958,
      "node_id": "MDQ6VXNlcjcxNTk1OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/715958?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arthurprs",
      "html_url": "https://github.com/arthurprs",
      "followers_url": "https://api.github.com/users/arthurprs/followers",
      "following_url": "https://api.github.com/users/arthurprs/following{/other_user}",
      "gists_url": "https://api.github.com/users/arthurprs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arthurprs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arthurprs/subscriptions",
      "organizations_url": "https://api.github.com/users/arthurprs/orgs",
      "repos_url": "https://api.github.com/users/arthurprs/repos",
      "events_url": "https://api.github.com/users/arthurprs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arthurprs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-21T13:35:02Z",
    "updated_at": "2015-11-21T13:35:15Z",
    "body": "It's important to note that jemalloc isn't the only allocation that exhibits this behavior (having some slack), actually many do.\n\nI assumed we had the trio: reserve, reserve_exact and shrink_to_fit; exactly in order to allow reserve to be highly optimized and do smart reallocation, like in this case.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158641129/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158933914",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-158933914",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 158933914,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE1ODkzMzkxNA==",
    "user": {
      "login": "larsberg",
      "id": 346072,
      "node_id": "MDQ6VXNlcjM0NjA3Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/346072?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/larsberg",
      "html_url": "https://github.com/larsberg",
      "followers_url": "https://api.github.com/users/larsberg/followers",
      "following_url": "https://api.github.com/users/larsberg/following{/other_user}",
      "gists_url": "https://api.github.com/users/larsberg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/larsberg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/larsberg/subscriptions",
      "organizations_url": "https://api.github.com/users/larsberg/orgs",
      "repos_url": "https://api.github.com/users/larsberg/repos",
      "events_url": "https://api.github.com/users/larsberg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/larsberg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-11-23T13:31:42Z",
    "updated_at": "2015-11-23T13:31:42Z",
    "body": "I think you've got the wrong larsberg. I believe you want @larsbergstrom\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/158933914/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187602448",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-187602448",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 187602448,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NzYwMjQ0OA==",
    "user": {
      "login": "kajalsinha",
      "id": 1764470,
      "node_id": "MDQ6VXNlcjE3NjQ0NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1764470?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kajalsinha",
      "html_url": "https://github.com/kajalsinha",
      "followers_url": "https://api.github.com/users/kajalsinha/followers",
      "following_url": "https://api.github.com/users/kajalsinha/following{/other_user}",
      "gists_url": "https://api.github.com/users/kajalsinha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kajalsinha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kajalsinha/subscriptions",
      "organizations_url": "https://api.github.com/users/kajalsinha/orgs",
      "repos_url": "https://api.github.com/users/kajalsinha/repos",
      "events_url": "https://api.github.com/users/kajalsinha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kajalsinha/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-23T08:40:02Z",
    "updated_at": "2016-02-23T08:40:02Z",
    "body": "hi,\n\nI am learning rust and when I run the attached programs with parameter 100 million in Point size, Rust takes much more memory in vector. Rust compiler generated program (-O) takes 4.5 GB RAM whereas clang++ generated program (-O) takes 3GB.\n\nI tried a swift program as well which tool 3 GB around (same as C++).\n\nThe time command output for rust and c++ respectively is:\n\n[Rust 1.5]\nMacBook-Pro:Pointrust kajal$ time cargo run --release 100000000\n     Running `target/release/pointrust 100000000`\n-13091672652, 50607436937\n\nreal    0m25.189s\nuser    0m15.511s\nsys 0m9.144s\n\n[C++ compiled using clang++ with -O flag]\nMacBook-Pro:somedir kajal$ time ./a.out 100000000\nAverage is 1073876718, 1073753699\n\nreal    0m21.816s\nuser    0m18.231s\nsys 0m3.167s\n\nQueries:\n1. Why sys time is more in rust and what it indicates?\n2. Can this 1.5 times more memory allocation be reduced to same as C++.\n\n[pointrust.zip](https://github.com/rust-lang/rust/files/142149/pointrust.zip)\n[PointTestCpp.cpp.zip](https://github.com/rust-lang/rust/files/142150/PointTestCpp.cpp.zip)\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187602448/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187616403",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-187616403",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 187616403,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NzYxNjQwMw==",
    "user": {
      "login": "ticki",
      "id": 13349091,
      "node_id": "MDQ6VXNlcjEzMzQ5MDkx",
      "avatar_url": "https://avatars.githubusercontent.com/u/13349091?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ticki",
      "html_url": "https://github.com/ticki",
      "followers_url": "https://api.github.com/users/ticki/followers",
      "following_url": "https://api.github.com/users/ticki/following{/other_user}",
      "gists_url": "https://api.github.com/users/ticki/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ticki/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ticki/subscriptions",
      "organizations_url": "https://api.github.com/users/ticki/orgs",
      "repos_url": "https://api.github.com/users/ticki/repos",
      "events_url": "https://api.github.com/users/ticki/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ticki/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-02-23T09:22:22Z",
    "updated_at": "2016-02-23T09:22:22Z",
    "body": "@kajalsinha You might want to specify the capacity when you create the vector (see `with_capacity`).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/187616403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/191657163",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-191657163",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 191657163,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5MTY1NzE2Mw==",
    "user": {
      "login": "kajalsinha",
      "id": 1764470,
      "node_id": "MDQ6VXNlcjE3NjQ0NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1764470?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kajalsinha",
      "html_url": "https://github.com/kajalsinha",
      "followers_url": "https://api.github.com/users/kajalsinha/followers",
      "following_url": "https://api.github.com/users/kajalsinha/following{/other_user}",
      "gists_url": "https://api.github.com/users/kajalsinha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kajalsinha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kajalsinha/subscriptions",
      "organizations_url": "https://api.github.com/users/kajalsinha/orgs",
      "repos_url": "https://api.github.com/users/kajalsinha/repos",
      "events_url": "https://api.github.com/users/kajalsinha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kajalsinha/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-03-03T08:47:56Z",
    "updated_at": "2016-03-03T08:47:56Z",
    "body": "The memory consumption remains 1.5 times even with_capacity \n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/191657163/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/191910513",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-191910513",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 191910513,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5MTkxMDUxMw==",
    "user": {
      "login": "hexsel",
      "id": 299385,
      "node_id": "MDQ6VXNlcjI5OTM4NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/299385?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexsel",
      "html_url": "https://github.com/hexsel",
      "followers_url": "https://api.github.com/users/hexsel/followers",
      "following_url": "https://api.github.com/users/hexsel/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexsel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexsel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexsel/subscriptions",
      "organizations_url": "https://api.github.com/users/hexsel/orgs",
      "repos_url": "https://api.github.com/users/hexsel/repos",
      "events_url": "https://api.github.com/users/hexsel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexsel/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-03-03T18:49:47Z",
    "updated_at": "2016-03-03T18:51:43Z",
    "body": "@kajalsinha your C++ program is using long, Rust is using f64, right?\n\nAccording to [google](https://www.google.com/search?q=c%2B%2B+long+size), a long may be 32 bits, I expect f64 is 64 bits.  If this is the case, you should be careful with any comparisons, integers are usually faster than floating point even for same size.\n\nCaveat: I was never a C++ programmer, and google is occasionally wrong.\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/191910513/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/234106315",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-234106315",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 234106315,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzNDEwNjMxNQ==",
    "user": {
      "login": "notriddle",
      "id": 1593513,
      "node_id": "MDQ6VXNlcjE1OTM1MTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/notriddle",
      "html_url": "https://github.com/notriddle",
      "followers_url": "https://api.github.com/users/notriddle/followers",
      "following_url": "https://api.github.com/users/notriddle/following{/other_user}",
      "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions",
      "organizations_url": "https://api.github.com/users/notriddle/orgs",
      "repos_url": "https://api.github.com/users/notriddle/repos",
      "events_url": "https://api.github.com/users/notriddle/events{/privacy}",
      "received_events_url": "https://api.github.com/users/notriddle/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-07-20T22:41:00Z",
    "updated_at": "2016-07-20T22:41:15Z",
    "body": "The C/C++ standards define long as a number with no less capacity than an int and no more capacity than a long long. That's it. On Mac OS X (which @kajalsinha is using, based on the console paste), [it's one word long: 32 bits on 32-bit OSX and 64 bits on 64-bit OSX](https://software.intel.com/en-us/articles/size-of-long-integer-type-on-different-architecture-and-os/). For a fair comparison with Rust, you should use an `isize`.\n\nThe fact that you're using integers in C and floating point numbers in Rust also accounts for the performance difference.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/234106315/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244823506",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-244823506",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 244823506,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0NDgyMzUwNg==",
    "user": {
      "login": "Storyyeller",
      "id": 999674,
      "node_id": "MDQ6VXNlcjk5OTY3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/999674?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Storyyeller",
      "html_url": "https://github.com/Storyyeller",
      "followers_url": "https://api.github.com/users/Storyyeller/followers",
      "following_url": "https://api.github.com/users/Storyyeller/following{/other_user}",
      "gists_url": "https://api.github.com/users/Storyyeller/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Storyyeller/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Storyyeller/subscriptions",
      "organizations_url": "https://api.github.com/users/Storyyeller/orgs",
      "repos_url": "https://api.github.com/users/Storyyeller/repos",
      "events_url": "https://api.github.com/users/Storyyeller/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Storyyeller/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-09-06T00:06:25Z",
    "updated_at": "2016-09-06T00:06:25Z",
    "body": "What is the point of even having reserve_exact(), if it provides no additional guarentees over reserve()?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244823506/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244870889",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-244870889",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 244870889,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0NDg3MDg4OQ==",
    "user": {
      "login": "ticki",
      "id": 13349091,
      "node_id": "MDQ6VXNlcjEzMzQ5MDkx",
      "avatar_url": "https://avatars.githubusercontent.com/u/13349091?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ticki",
      "html_url": "https://github.com/ticki",
      "followers_url": "https://api.github.com/users/ticki/followers",
      "following_url": "https://api.github.com/users/ticki/following{/other_user}",
      "gists_url": "https://api.github.com/users/ticki/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ticki/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ticki/subscriptions",
      "organizations_url": "https://api.github.com/users/ticki/orgs",
      "repos_url": "https://api.github.com/users/ticki/repos",
      "events_url": "https://api.github.com/users/ticki/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ticki/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-09-06T07:27:59Z",
    "updated_at": "2016-09-06T07:27:59Z",
    "body": "@Storyyeller `reserve` guarantees that `cap` is greater than or equal to the specified amount. `reserve_exact` guarantees that `cap` is equal to the specified amount, that however **does not** mean the allocator can't give more memory (`usable_size`) back.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244870889/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244881338",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-244881338",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 244881338,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0NDg4MTMzOA==",
    "user": {
      "login": "ollie27",
      "id": 7189418,
      "node_id": "MDQ6VXNlcjcxODk0MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ollie27",
      "html_url": "https://github.com/ollie27",
      "followers_url": "https://api.github.com/users/ollie27/followers",
      "following_url": "https://api.github.com/users/ollie27/following{/other_user}",
      "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions",
      "organizations_url": "https://api.github.com/users/ollie27/orgs",
      "repos_url": "https://api.github.com/users/ollie27/repos",
      "events_url": "https://api.github.com/users/ollie27/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ollie27/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-09-06T08:17:30Z",
    "updated_at": "2016-09-06T08:17:30Z",
    "body": "> that however does not mean the allocator can't give more memory (usable_size) back.\n\n@ticki what does that mean if it doesn't mean that the capacity can be greater than requested?\n\nI believe that [`reserve`](https://doc.rust-lang.org/nightly/std/vec/struct.Vec.html#method.reserve) and [`reserve_exact`](https://doc.rust-lang.org/nightly/std/vec/struct.Vec.html#method.reserve_exact) make exactly the same guarantee, namely that you can push the specified number of elements onto the `Vec` without any reallocation. The only difference is the strategy for reallocation. `reserve` might try to reserve more space than requested to avoid reallocations if you push more elements than you requested. `reserve_exact` will only try to reserve enough space for the extra elements. This is useful to reduce memory usage if you know exactly how many more elements you need to push or at least have an upper bound.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244881338/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244882337",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-244882337",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 244882337,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0NDg4MjMzNw==",
    "user": {
      "login": "ticki",
      "id": 13349091,
      "node_id": "MDQ6VXNlcjEzMzQ5MDkx",
      "avatar_url": "https://avatars.githubusercontent.com/u/13349091?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ticki",
      "html_url": "https://github.com/ticki",
      "followers_url": "https://api.github.com/users/ticki/followers",
      "following_url": "https://api.github.com/users/ticki/following{/other_user}",
      "gists_url": "https://api.github.com/users/ticki/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ticki/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ticki/subscriptions",
      "organizations_url": "https://api.github.com/users/ticki/orgs",
      "repos_url": "https://api.github.com/users/ticki/repos",
      "events_url": "https://api.github.com/users/ticki/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ticki/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-09-06T08:21:51Z",
    "updated_at": "2016-09-06T08:21:51Z",
    "body": "> what does that mean if it doesn't mean that the capacity can be greater than requested?\n\nTo make bookkeeping of the memory more smooth, most allocators has some fixed sizes you can allocate from. If the given value is not one of these, it will round up to the nearest fitting size.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244882337/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244885202",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-244885202",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 244885202,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0NDg4NTIwMg==",
    "user": {
      "login": "ollie27",
      "id": 7189418,
      "node_id": "MDQ6VXNlcjcxODk0MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ollie27",
      "html_url": "https://github.com/ollie27",
      "followers_url": "https://api.github.com/users/ollie27/followers",
      "following_url": "https://api.github.com/users/ollie27/following{/other_user}",
      "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions",
      "organizations_url": "https://api.github.com/users/ollie27/orgs",
      "repos_url": "https://api.github.com/users/ollie27/repos",
      "events_url": "https://api.github.com/users/ollie27/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ollie27/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-09-06T08:33:52Z",
    "updated_at": "2016-09-06T08:33:52Z",
    "body": "Right, but that doesn't mean that \"`reserve_exact` guarantees that cap is equal to the specified amount\". In fact the [docs](https://doc.rust-lang.org/nightly/std/vec/struct.Vec.html#method.reserve_exact) say that that is not the case:\n\n> Note that the allocator may give the collection more space than it requests. Therefore capacity can not be relied upon to be precisely minimal.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244885202/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244897920",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-244897920",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 244897920,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI0NDg5NzkyMA==",
    "user": {
      "login": "ticki",
      "id": 13349091,
      "node_id": "MDQ6VXNlcjEzMzQ5MDkx",
      "avatar_url": "https://avatars.githubusercontent.com/u/13349091?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ticki",
      "html_url": "https://github.com/ticki",
      "followers_url": "https://api.github.com/users/ticki/followers",
      "following_url": "https://api.github.com/users/ticki/following{/other_user}",
      "gists_url": "https://api.github.com/users/ticki/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ticki/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ticki/subscriptions",
      "organizations_url": "https://api.github.com/users/ticki/orgs",
      "repos_url": "https://api.github.com/users/ticki/repos",
      "events_url": "https://api.github.com/users/ticki/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ticki/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-09-06T09:27:33Z",
    "updated_at": "2016-09-06T09:27:33Z",
    "body": "@ollie27 No, the point is that the capacity is updated with the (uncanonicalised) memory returned by the allocator.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/244897920/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/301225701",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-301225701",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 301225701,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwMTIyNTcwMQ==",
    "user": {
      "login": "Mark-Simulacrum",
      "id": 5047365,
      "node_id": "MDQ6VXNlcjUwNDczNjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Mark-Simulacrum",
      "html_url": "https://github.com/Mark-Simulacrum",
      "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers",
      "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}",
      "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions",
      "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs",
      "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos",
      "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-05-13T05:06:41Z",
    "updated_at": "2017-05-13T05:06:41Z",
    "body": "Closing. If we want to pursue this, a discussion (potentially leading to PRs) on internals.rust-lang.org would be best.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/301225701/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/303779603",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-303779603",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 303779603,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwMzc3OTYwMw==",
    "user": {
      "login": "Mark-Simulacrum",
      "id": 5047365,
      "node_id": "MDQ6VXNlcjUwNDczNjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Mark-Simulacrum",
      "html_url": "https://github.com/Mark-Simulacrum",
      "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers",
      "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}",
      "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions",
      "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs",
      "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos",
      "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-05-24T16:33:50Z",
    "updated_at": "2017-05-24T16:33:50Z",
    "body": "Actually, I'm going to reopen. This is something that has potential performance impacts and we should probably keep tracking.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/303779603/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328290500",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-328290500",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 328290500,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyODI5MDUwMA==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-09-09T17:06:39Z",
    "updated_at": "2017-09-09T17:09:00Z",
    "body": "I don't see the growth factor being discussed much here.\r\n\r\n@Gankro mentions [`FBVector`](https://github.com/facebook/folly/blob/master/folly/docs/FBVector.md) and its growth factor of 1.5. A factor of 1.5 allows reusing previously freed memory after 4 reallocations, 1.45 allows memory reuse after 3 reallocations, and 1.3 allows reuse after 2 reallocations. Which one is better is [application dependent](https://stackoverflow.com/questions/1100311/what-is-the-ideal-growth-rate-for-a-dynamically-allocated-array), although some claim that 1.5 is  [close to optimal](https://crntaylor.wordpress.com/2011/07/15/optimal-memory-reallocation-and-the-golden-ratio/). \r\n\r\nWhat seems clear is that a growth factor of 2, that is, doubling the size of the vector on reallocation, is the worst possible growth factor that can be chosen because it never allows the vector to reuse any previously freed memory. That is, for a vector that reallocates multiple times, a growth factor of 2 means that the memory freed from these reallocations will never be usable for a future allocation of the vector. \r\n\r\nSince Rust currently uses a growth factor of 2, a small incremental step could be to try a smaller growth factor and see if that improves memory usage. Any one will do, although 1.3, 1.45 or 1.5 make sense to me. \r\n\r\n---\r\n\r\nFrom the `fbvector` docs:\r\n\r\n> Of course, the above makes a number of simplifying assumptions about how the memory allocator works, but definitely you don't want to choose the theoretically absolute worst growth factor (2). fbvector uses a growth factor of 1.5. That does not impede good performance at small sizes because of the way fbvector cooperates with jemalloc (below).\r\n\r\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328290500/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328291493",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-328291493",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 328291493,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyODI5MTQ5Mw==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-09-09T17:22:11Z",
    "updated_at": "2017-09-09T17:22:11Z",
    "body": "Is this even something we can change at this point?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328291493/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328291711",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-328291711",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 328291711,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyODI5MTcxMQ==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-09-09T17:25:57Z",
    "updated_at": "2017-09-09T17:38:24Z",
    "body": "Also, I don't know if the code of fbvector.h has changed much, but the part cited by @Gankro now looks like this:\r\n\r\n```c++\r\n  size_type computePushBackCapacity() const {\r\n    if (capacity() == 0) {\r\n      return std::max(64 / sizeof(T), size_type(1));\r\n    }\r\n    if (capacity() < folly::jemallocMinInPlaceExpandable / sizeof(T)) {\r\n      return capacity() * 2;\r\n    }\r\n    if (capacity() > 4096 * 32 / sizeof(T)) {\r\n      return capacity() * 2;\r\n    }\r\n    return (capacity() * 3 + 1) / 2;\r\n  }\r\n```\r\nIt hasn't changed much, but note that this function only computes the \"increased capacity on push back\". This is then used in:\r\n\r\n```c++\r\n  size_type computeInsertCapacity(size_type n) {\r\n    size_type nc = std::max(computePushBackCapacity(), size() + n);\r\n    size_type ac = folly::goodMallocSize(nc * sizeof(T)) / sizeof(T);\r\n    return ac;\r\n  }\r\n```\r\n\r\nand in `emplace_back`:\r\n\r\n```c++\r\ntemplate <typename T, typename Allocator>\r\ntemplate <class... Args>\r\nvoid fbvector<T, Allocator>::emplace_back_aux(Args&&... args) {\r\n  size_type byte_sz = folly::goodMallocSize(\r\n    computePushBackCapacity() * sizeof(T));\r\n   // ...\r\n}\r\n```\r\n\r\nto _predict_ the future capacity, but `goodMallocSize` has the last say on this. ~~~I can't find the source of `goodMallocSize`,  so I don't know if it calls `nallocx`, `usable_capacity`, or does something else.~~~ EDIT, found the source of `goodMallocSize`:\r\n\r\n```c++\r\ninline size_t goodMallocSize(size_t minSize) noexcept {\r\n  if (minSize == 0) {\r\n    return 0;\r\n  }\r\n\r\n  if (!usingJEMalloc()) {\r\n    // Not using jemalloc - no smarts\r\n    return minSize;\r\n  }\r\n\r\n  return nallocx(minSize, 0);\r\n}\r\n\r\n// We always request \"good\" sizes for allocation, so jemalloc can\r\n// never grow in place small blocks; they're already occupied to the\r\n// brim.  Blocks larger than or equal to 4096 bytes can in fact be\r\n// expanded in place, and this constant reflects that.\r\nstatic const size_t jemallocMinInPlaceExpandable = 4096;\r\n```\r\n\r\nSo currently, `fbvector` _always_ calls `nallocx`. @Gankro thoughts?\r\n\r\n---\r\n\r\n@steveklabnik  neither `RawVec` nor `RawVec::double` are stabilized, and `std::Vec` documentation says:\r\n\r\n> Vec does not guarantee any particular growth strategy when reallocating when full, nor when reserve is called. The current strategy is basic and it may prove desirable to use a non-constant growth factor. Whatever strategy is used will of course guarantee O(1) amortized push.\r\n\r\nSo as long as we still guarantee O(1) amortized push we can continue to improve this.\r\n\r\n--- \r\n\r\nEDIT: IMO it makes sense to rename `double` to `grow` to indicate that we grow the `RawVec`, and not necessarily double it, and then to switch the default capacity to 1.5, measure, use a better heuristic for small and large allocations while leaving the 1.5 heurisitc for medium sized allocations, measure, pass alignment and capacity information to the allocator to check how much memory we actually get and try to reuse most of that, measure. ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328291711/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328303020",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-328303020",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 328303020,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyODMwMzAyMA==",
    "user": {
      "login": "Gankra",
      "id": 1136864,
      "node_id": "MDQ6VXNlcjExMzY4NjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gankra",
      "html_url": "https://github.com/Gankra",
      "followers_url": "https://api.github.com/users/Gankra/followers",
      "following_url": "https://api.github.com/users/Gankra/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions",
      "organizations_url": "https://api.github.com/users/Gankra/orgs",
      "repos_url": "https://api.github.com/users/Gankra/repos",
      "events_url": "https://api.github.com/users/Gankra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gankra/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-09-09T20:57:16Z",
    "updated_at": "2017-09-09T20:57:16Z",
    "body": "Yes this will always be freely changeable. Someone just needs to put in the legwork to prove it's actually profitable. Keeping in mind many platforms don't use jemalloc, and that number will probably only be going down with time.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328303020/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328412451",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-328412451",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 328412451,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyODQxMjQ1MQ==",
    "user": {
      "login": "nagisa",
      "id": 679122,
      "node_id": "MDQ6VXNlcjY3OTEyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nagisa",
      "html_url": "https://github.com/nagisa",
      "followers_url": "https://api.github.com/users/nagisa/followers",
      "following_url": "https://api.github.com/users/nagisa/following{/other_user}",
      "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions",
      "organizations_url": "https://api.github.com/users/nagisa/orgs",
      "repos_url": "https://api.github.com/users/nagisa/repos",
      "events_url": "https://api.github.com/users/nagisa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nagisa/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-09-11T04:29:51Z",
    "updated_at": "2017-09-11T04:29:51Z",
    "body": "Would certainly be more plausible to do it on a per-platform basis. Figure\nout optimal, in some sense, growth factors for T1 platforms and just decide\non a sane default for the rest.\n\nOn Sep 9, 2017 11:57 PM, \"Alexis Beingessner\" <notifications@github.com>\nwrote:\n\nYes this will always be freely changeable. Someone just needs to put in the\nlegwork to prove it's actually profitable. Keeping in mind many platforms\ndon't use jemalloc, and that number will probably only be going down with\ntime.\n\n\u2014\nYou are receiving this because you are subscribed to this thread.\nReply to this email directly, view it on GitHub\n<https://github.com/rust-lang/rust/issues/29931#issuecomment-328303020>,\nor mute\nthe thread\n<https://github.com/notifications/unsubscribe-auth/AApc0qYjqjODqQy5dKzJQa6NpvGnTF5fks5sgvvEgaJpZM4GlqS9>\n.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/328412451/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/336840408",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-336840408",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 336840408,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzNjg0MDQwOA==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-10-16T10:02:42Z",
    "updated_at": "2017-10-16T10:02:42Z",
    "body": "I am working on this. If anyone interested and with experience would like to mentor me please let me know.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/336840408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343547935",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343547935",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343547935,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzU0NzkzNQ==",
    "user": {
      "login": "mratsim",
      "id": 22738317,
      "node_id": "MDQ6VXNlcjIyNzM4MzE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/22738317?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mratsim",
      "html_url": "https://github.com/mratsim",
      "followers_url": "https://api.github.com/users/mratsim/followers",
      "following_url": "https://api.github.com/users/mratsim/following{/other_user}",
      "gists_url": "https://api.github.com/users/mratsim/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mratsim/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mratsim/subscriptions",
      "organizations_url": "https://api.github.com/users/mratsim/orgs",
      "repos_url": "https://api.github.com/users/mratsim/repos",
      "events_url": "https://api.github.com/users/mratsim/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mratsim/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-10T18:19:44Z",
    "updated_at": "2017-11-10T18:19:44Z",
    "body": "@gnzlbg The optimal growth factor is probably the golden ratio `\u03a6` (1.618...) as discussed here https://github.com/facebook/folly/issues/543 and in depth in this [blog post](https://crntaylor.wordpress.com/2011/07/15/optimal-memory-reallocation-and-the-golden-ratio/).",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343547935/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343594063",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343594063",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343594063,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzU5NDA2Mw==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-10T21:37:50Z",
    "updated_at": "2017-11-10T21:37:50Z",
    "body": "Optimal in what Sense?\n\nNote that one property of a good growth factor is that you are able to\nreuse some previously freed memory.\n\nWith 1.45 this happens after 3 reallocations, with 1.5 after 4, and in this\nPR we have something slightly higher than 1.5. If you don't reallocate 4\ntimes a growth factor of 1.5 doesn't allow you to reuse any memory.\n\nThe golden ratio is indeed optimal in a particular sense, but the most\nefficient growth ratio is always going to be application dependent. I (and\nmany others) think 3 / 2 is a good trade off between easy to compute (no\nfloating point arithmetic necessary), low number of reallocations necessary\nto be profitable, and close enough to the golden ratio.\n\nStill, it can't be the best for all applications.\n\nOn Fri 10. Nov 2017 at 19:20, Mamy Ratsimbazafy <notifications@github.com>\nwrote:\n\n> @gnzlbg <https://github.com/gnzlbg> The optimal growth factor is probably\n> the golden ratio \u03a6 (1.618...) as discussed here facebook/folly#543\n> <https://github.com/facebook/folly/issues/543> and in depth in this blog\n> post\n> <https://crntaylor.wordpress.com/2011/07/15/optimal-memory-reallocation-and-the-golden-ratio/>\n> .\n>\n> \u2014\n> You are receiving this because you were mentioned.\n>\n>\n> Reply to this email directly, view it on GitHub\n> <https://github.com/rust-lang/rust/issues/29931#issuecomment-343547935>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AA3NprUhVqXf1bAc10r5W81vn3RBTGP2ks5s1JPdgaJpZM4GlqS9>\n> .\n>\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343594063/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343766425",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343766425",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343766425,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0Mzc2NjQyNQ==",
    "user": {
      "login": "nnethercote",
      "id": 1940286,
      "node_id": "MDQ6VXNlcjE5NDAyODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nnethercote",
      "html_url": "https://github.com/nnethercote",
      "followers_url": "https://api.github.com/users/nnethercote/followers",
      "following_url": "https://api.github.com/users/nnethercote/following{/other_user}",
      "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions",
      "organizations_url": "https://api.github.com/users/nnethercote/orgs",
      "repos_url": "https://api.github.com/users/nnethercote/repos",
      "events_url": "https://api.github.com/users/nnethercote/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nnethercote/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-12T20:48:19Z",
    "updated_at": "2024-04-19T02:58:29Z",
    "body": "I strongly advocate for a doubling strategy, as opposed to 1.5x, or the golden ratio, or any other number.\r\n\r\nAs I understand them, the arguments in favour of smaller values are based on a mistaken assumption. Let's assume we use doubling and start at 8 bytes, and then go 16, 32, 64, 128, 256, 512, 1024. For the 8..512 allocations we will have used 1016 bytes, and so we can't reuse those bytes for the 1024 bytes. With a 1.5x growth factor we would _theoretically_ be able to reuse and combine multiple previous freed allocations to satisfy subsequent requests.\r\n\r\nBut _in practice_ we can't, because the above argument assumes in the 1.5x case that these smaller allocations may be laid out in such a way that they can be combined into larger allocations, which is almost certainly not true. jemalloc rounds up requests to various size classes, and allocations of different size classes are put into different runs, where runs are measured in pages; so it is guaranteed that not a single one of those allocations in the 8..512 sequence will be adjacent, and there will be no chance of combining them for such reuse. Other allocators may behave differently, but it would be a very unusual allocator that would lay out such sequences contiguously.\r\n\r\nSo with that mistaken argument out of the way, we can see the arguments in favour of 2x: it's super simple and it's super fast to compute.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343766425/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343771827",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343771827",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343771827,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0Mzc3MTgyNw==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-12T22:03:52Z",
    "updated_at": "2017-11-12T22:03:52Z",
    "body": "> But in practice we can't, because the above argument assumes in the 1.5x case that these smaller allocations may be laid out in such a way that they can be combined into larger allocations, which is almost certainly not true. jemalloc rounds up requests to various size classes, and allocations of different size classes are put into different runs, where runs are measured in pages; so it is guaranteed that not a single one of those allocations in the 8..512 sequence will be adjacent, \r\n\r\nWhich is why the proposed strategy doubles up the memory up to the page size [*], and then switches to 1.5x. \r\n\r\n> we can see the arguments in favour of 2x: it's super simple and it's super fast to compute.\r\n\r\nA better growth-factor can 1) reduce the number of jemalloc calls, 2) reduce the time spent in these calls, and 3) reduce memory usage. These all can have a measurable performance impact. \r\n\r\nBut whether computing the growth factor takes 1 cycle or 20 is irrelevant compared to the cost of a single jemalloc call:  `nallocx` alone is already over 50 cycles.\r\n\r\n[*] Which is arguably too simple. We could probably do better than this by rounding to the next power of two, so that instead of copying the memory on growth within the same memory pool (such that the older memory can't be reused) jemalloc would instead copy the memory into the next pool freeing the old memory. ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343771827/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343807345",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343807345",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343807345,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzgwNzM0NQ==",
    "user": {
      "login": "glandium",
      "id": 1038527,
      "node_id": "MDQ6VXNlcjEwMzg1Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1038527?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glandium",
      "html_url": "https://github.com/glandium",
      "followers_url": "https://api.github.com/users/glandium/followers",
      "following_url": "https://api.github.com/users/glandium/following{/other_user}",
      "gists_url": "https://api.github.com/users/glandium/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glandium/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glandium/subscriptions",
      "organizations_url": "https://api.github.com/users/glandium/orgs",
      "repos_url": "https://api.github.com/users/glandium/repos",
      "events_url": "https://api.github.com/users/glandium/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glandium/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-13T04:18:44Z",
    "updated_at": "2017-11-13T04:19:30Z",
    "body": "Above the page size, the assumption is still bogus, at least in the case of jemalloc:\r\nIf you have a 4K allocation and realloc() it to 8K, and there are 8K available directly next to the original 4K, jemalloc is not going to allocate the 8K, copy the data and free the original 4K: it's just going to expand the original 4K to 8K, because there's 4K free right after it.\r\nBut this assumes you're using realloc, which I guess Vec does. Now, the big difference with C++ vectors is that C++ vectors may semantically need an actual malloc/copy/free sequence, where copy uses the copy constructor for the type stored in the vector. And in that case, the assumption does apply.\r\nNow, the real argument is that past a certain size, doubling can be considered too much memory overhead.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343807345/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343868072",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343868072",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343868072,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0Mzg2ODA3Mg==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-13T09:55:32Z",
    "updated_at": "2017-11-13T09:59:19Z",
    "body": "> Above the page size, the assumption is still bogus, at least in the case of jemalloc:\r\n\r\nYes, this is why the proposed strategy only uses 1.5x for medium sized vectors and switches the strategy again for \"large\" vectors (`>= 32 * 4096` bytes), currently back to doubling. \r\n\r\n> But this assumes you're using realloc, which I guess Vec does.\r\n\r\nYes, `Vec` currently uses `realloc` but with a growth factor of 2 which means that this never happens. There is a PR that uses `1.5x` for medium sized vectors and switches from `realloc` to `realloc_excess`, which in practice means that medium sized vectors will always be using a multiple of the page size.  \r\n\r\n> Now, the real argument is that past a certain size, doubling can be considered too much memory overhead.\r\n\r\nI think that we might be able to do better than doubling for \"large\" vectors by tweaking the growth factor, but not much better. The PR switches back to doubling here because this is what we are currently doing. Is there any literature or recommendations from jemalloc / malloc about this? \r\n\r\nAnyways my plan for large vectors is not to tweak the growth factor between choosing either 1.5 or 2. The main problem with \"very large\" vectors is the cost of allocating new memory, copying memory (they are very large), and freeing the old memory. \r\n\r\nOn any of the major 64 bit platforms (Linux, Windows, MacOs, ...) we can reduce the cost of this operations to ~0 for very large vectors by, e.g., once a vector becomes \"very large\" allocating 4 Gb of virtual memory (e.g. using `VirtualAlloc` on Windows, `malloc` or `mmap /dev/zero` on Linux, ...). That way the vector can keep growing in place, using only as much memory as it needs (as long as it doesn't touch a memory page it will not use it), without ever reallocating, copying memory, invalidating pointers, ...\r\n\r\nI think that this will have a much larger impact on performance than tweaking the growth factor.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343868072/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343870332",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343870332",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343870332,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0Mzg3MDMzMg==",
    "user": {
      "login": "glandium",
      "id": 1038527,
      "node_id": "MDQ6VXNlcjEwMzg1Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1038527?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glandium",
      "html_url": "https://github.com/glandium",
      "followers_url": "https://api.github.com/users/glandium/followers",
      "following_url": "https://api.github.com/users/glandium/following{/other_user}",
      "gists_url": "https://api.github.com/users/glandium/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glandium/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glandium/subscriptions",
      "organizations_url": "https://api.github.com/users/glandium/orgs",
      "repos_url": "https://api.github.com/users/glandium/repos",
      "events_url": "https://api.github.com/users/glandium/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glandium/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-13T10:03:39Z",
    "updated_at": "2017-11-13T10:03:39Z",
    "body": "Actually, C++ vectors *always* need an actual malloc/copy/free sequence, because\r\n- C++ doesn't actually use malloc/free, it uses operator new/operator delete, and doesn't actually have a realloc. Practically speaking, in many cases operator new/operator delete are equivalent to malloc/free, and realloc would work on operator new allocated buffers, but there's no guarantee by the standard that this is supposed to work.\r\n- std::vector doesn't even use operator new/operator delete directly, it goes through std::allocator, which also doesn't have a function to reallocate (obviously).\r\n\r\n> Yes, Vec currently uses realloc but with a growth factor of 2 which means that this never happens. \r\n\r\nThere is no reason for this not to happen with jemalloc, even with larger factors, for sizes between one page and the maximum size for large allocations (chunk size minus a few pages). Except, obviously, if the memory following the current buffer is not free, in which case the original assumption doesn't apply anyways.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343870332/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343883507",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-343883507",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 343883507,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0Mzg4MzUwNw==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-11-13T10:54:00Z",
    "updated_at": "2017-11-13T10:54:00Z",
    "body": "> Actually, C++ vectors always need an actual malloc/copy/free sequence, because\r\n\r\nI don't follow the point you are trying to make. Yes, C++ vectors need to do this, but Rust's `Vec` does not, or what am I missing?\r\n\r\n> There is no reason for this not to happen with jemalloc, even with larger factors, for sizes between one page and the maximum size for large allocations (chunk size minus a few pages). \r\n\r\nMaybe we are talking past each other and you meant something different, but:\r\n\r\nSuppose you have a contiguous chunk of the address space that is free (before and after this chunk the memory is not free), and that fits the initial content of a vector plus 4x vector regrowths. \r\n\r\nNow suppose that after the 4th regrowth, the first part of the buffer is still free.\r\n\r\nThe difference between a growth-factor of 1.5x and 2x is that the vector with a growth-factor of 1.5x can grow a fifth time inside that buffer while the one with a growth-factor of 2x never can. This is because, for a growth-factor of 1.5, the size of the previously freed allocations in the buffer is exactly 1.5x the size of the 4th vector, while for a growth-factor of 2x, the size of the previously-freed allocations is always smaller than 2x the size of the 4th vector. \r\n\r\n> Except, obviously, if the memory following the current buffer is not free, in which case the original assumption doesn't apply anyways.\r\n\r\nSo if the memory following the current buffer is not free, anything better than the worst theoretically-possible growth-factor allows you to grow the vector one extra time before having to go look for a larger buffer. \r\n\r\nBut even if the memory following the current buffer is free, reusing the previously-freed memory reduces fragmentation, and can potentially reduce the number of jemalloc calls as well (if the free size after the 4th vector is returned as an `Excess`). \r\n\r\nOr where you talking about a completely different situation?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/343883507/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/390183995",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-390183995",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 390183995,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDE4Mzk5NQ==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-05-18T11:55:11Z",
    "updated_at": "2018-05-18T12:01:34Z",
    "body": "Now that we are moving to the System allocator by default, I think it makes sense to at least take a look at what the C++ vector implementations do w.r.t the growth factor on the different platforms, since it could make sense that the platforms tune their growth factors for their allocators: \r\n\r\n### libc++\r\n\r\nSystem implementation on MacOSX and some *BSDs, [code](https://github.com/llvm-mirror/libcxx/blob/master/include/vector#L966):\r\n\r\n```c++\r\n//  Precondition:  __new_size > capacity()\r\ntemplate <class _Tp, class _Allocator>\r\ninline _LIBCPP_INLINE_VISIBILITY\r\ntypename vector<_Tp, _Allocator>::size_type\r\nvector<_Tp, _Allocator>::__recommend(size_type __new_size) const\r\n{\r\n    const size_type __ms = max_size();\r\n    if (__new_size > __ms)\r\n        this->__throw_length_error();\r\n    const size_type __cap = capacity();\r\n    if (__cap >= __ms / 2)\r\n        return __ms;\r\n    return _VSTD::max<size_type>(2*__cap, __new_size);\r\n}\r\n```\r\nThe growth factor is 2. Note that on *BSDs jemalloc is the default system allocator, although FBVector is tuned for jemalloc and does a couple of things differently as mentioned above (2 for tiny and large vectors, and 1.5 for the cases in which the allocation hits jemalloc pools).\r\n\r\n### libstdc++\r\n\r\nSystem implementation on Linux. The code is [here](https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/bits/stl_vector.h#L1640):\r\n\r\n```c++\r\n// Called by _M_fill_insert, _M_insert_aux etc.\r\nsize_type\r\n_M_check_len(size_type __n, const char* __s) const\r\n{\r\n\tif (max_size() - size() < __n)\r\n\t  __throw_length_error(__N(__s));\r\n\r\n\tconst size_type __len = size() + std::max(size(), __n);\r\n\treturn (__len < size() || __len > max_size()) ? max_size() : __len;\r\n}\r\n```\r\n\r\nThe growth factor is 2 (size + size).\r\n\r\n#### MSVC\r\n\r\nWindows. I couldn't find the code only anywhere, but all internet sources point to a factor of 1.5. This factor is also used by FBVector, Boost, etc. \r\n\r\n---\r\n\r\nOk so what is going on here? \r\n\r\nWell, Windows is the outlier, and that makes sense! Windows does not have overcommit, so all the memory `Vec` reserves is physical memory. [When STL,  a std lib maintainer at Microsoft, tried to changed it people complained that they preferred the lower memory consumption](https://www.reddit.com/r/cpp/comments/2ezwee/stdvector_optimization_by_facebook/ck4t8hk/).\r\n\r\nOn the other hand, for Linux and MacOSX, it might well be that `2` is more tuned for the pools that their allocators use internally. For large allocations (larger than a couple of page sizes), however, it doesn't really matter because the pages won't be committed to physical memory until they are touched. Using the larger 2x factor is a problem on 32-bit systems, but it is basically free on 64-bit systems and maybe that's what libstdc++ and libc++ are tuned for? \r\n\r\nHell, if one wouldn't be able to disable overcommit in these systems we could just have allocations of large enough vector on 64-bit systems just jump to reserving XGb of RAM and continue with a 2x factor after that. That basically allows realloc to growth the vector in place without any `memcpy`s. \r\n\r\nSo IMO, if we are going to change this, I'll say change this to whatever each system does. That is, 1.5 on Windows, and 2x on Linux and MacOSX. For targets that have `jemalloc` as a system allocator (newer Androids, *BSDs, etc.) we could consider doing what FBVector does, but IMO we should discuss that on a different issue that is specific for those systems. \r\n\r\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/390183995/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441058898",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-441058898",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 441058898,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTA1ODg5OA==",
    "user": {
      "login": "leventov",
      "id": 609240,
      "node_id": "MDQ6VXNlcjYwOTI0MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/609240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leventov",
      "html_url": "https://github.com/leventov",
      "followers_url": "https://api.github.com/users/leventov/followers",
      "following_url": "https://api.github.com/users/leventov/following{/other_user}",
      "gists_url": "https://api.github.com/users/leventov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leventov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leventov/subscriptions",
      "organizations_url": "https://api.github.com/users/leventov/orgs",
      "repos_url": "https://api.github.com/users/leventov/repos",
      "events_url": "https://api.github.com/users/leventov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leventov/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-11-22T15:13:08Z",
    "updated_at": "2018-11-22T15:13:08Z",
    "body": "> Windows does not have overcommit, so all the memory Vec reserves is physical memory.\r\n\r\nI think these are two unrelated things. Windows might not allow to overcommit, but virtual memory is still virtual. [According to this article](https://blogs.msdn.microsoft.com/oldnewthing/20160701-00/?p=93785) there have been some substantial improvements to how does it manage memory in Windows 8.1 and Windows Server 2012 R2, both released in 2013. The [comment by STL](https://www.reddit.com/r/cpp/comments/2ezwee/stdvector_optimization_by_facebook/ck4t8hk/):\r\n> Yes - but the last time I mumbled about possibly changing this, many people said they preferred the more conservative space consumption (it's not a big difference, but it's there). I'm not terribly inclined to mess with it.\r\n\r\nWas made on Aug 30 2014 and the \"last time\" mentioned could well be several years before that, so likely prior to the improvements.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441058898/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441070452",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-441070452",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 441070452,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTA3MDQ1Mg==",
    "user": {
      "login": "leventov",
      "id": 609240,
      "node_id": "MDQ6VXNlcjYwOTI0MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/609240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leventov",
      "html_url": "https://github.com/leventov",
      "followers_url": "https://api.github.com/users/leventov/followers",
      "following_url": "https://api.github.com/users/leventov/following{/other_user}",
      "gists_url": "https://api.github.com/users/leventov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leventov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leventov/subscriptions",
      "organizations_url": "https://api.github.com/users/leventov/orgs",
      "repos_url": "https://api.github.com/users/leventov/repos",
      "events_url": "https://api.github.com/users/leventov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leventov/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-11-22T15:56:10Z",
    "updated_at": "2018-11-22T19:31:28Z",
    "body": "> On the other hand, for Linux and MacOSX, it might well be that 2 is more tuned for the pools that their allocators use internally. For large allocations (larger than a couple of page sizes), however, it doesn't really matter because the pages won't be committed to physical memory until they are touched. Using the larger 2x factor is a problem on 32-bit systems, but it is basically free on 64-bit systems and maybe that's what libstdc++ and libc++ are tuned for?\r\n\r\nThe factor itself (is it 2 or a different number) couldn't be tuned for allocator alone because it doesn't take the size of the element into consideration. The capacities could always be multiples of two, but if the size of the element is 12 bytes, it's _always_ off. Compare with FBVector's initial capacity of `max(CACHE_LINE_SIZE / size_of_elem, 1)`.\r\n\r\nI think it's as important not to overestimate the amount of thought put into old systems code as not to underestimate it. I might be wrong but I have an impression that it's pretty much impossible to push any changes to those policies such as vector's growth factor, hash table load factor, etc. in C++ standard library implementations because _some users may depend on the existing behaviour_ and the priority is avoiding regressions rather than improving the average. That's probably why companies like Facebook and Google, albeit having significant power in GCC / Clang development, come along with their independent implementations. Rust still has the luxury (but probably not for long) to reconsider the old defaults and I think it should take advantage of it.\r\n\r\nThat is, I think Rust should pick up the FBVector's strategy (or something similar) on all platforms.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441070452/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441075323",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-441075323",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 441075323,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTA3NTMyMw==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-11-22T16:15:30Z",
    "updated_at": "2018-11-22T16:15:30Z",
    "body": "> The capacities could always be multiples of two, but if the size of the element is 12 bytes, it's always off. \r\n\r\nThis doesn't really matter much if you always extend your vector to the `usable_size`.\r\n\r\n> The factor itself (is it 2 or a different number) couldn't be tuned for allocator alone because it doesn't take the size of the element into consideration.\r\n\r\nIf your allocator only has even-sized or power-of-two-sized bins, a growth factor of two for a vector could make sense, even if this growth factor doesn't take the element size into account.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441075323/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441108326",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-441108326",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 441108326,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTEwODMyNg==",
    "user": {
      "login": "leventov",
      "id": 609240,
      "node_id": "MDQ6VXNlcjYwOTI0MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/609240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leventov",
      "html_url": "https://github.com/leventov",
      "followers_url": "https://api.github.com/users/leventov/followers",
      "following_url": "https://api.github.com/users/leventov/following{/other_user}",
      "gists_url": "https://api.github.com/users/leventov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leventov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leventov/subscriptions",
      "organizations_url": "https://api.github.com/users/leventov/orgs",
      "repos_url": "https://api.github.com/users/leventov/repos",
      "events_url": "https://api.github.com/users/leventov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leventov/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-11-22T19:29:08Z",
    "updated_at": "2018-11-22T19:29:08Z",
    "body": "> If your allocator only has even-sized or power-of-two-sized bins, a growth factor of two for a vector could make sense, even if this growth factor doesn't take the element size into account.\r\n\r\nIf it starts with something like FBVector's `64 / sizeof(T)`, yes. If no (libc++ and libstdc++ implementations that you pointed to don't, as far as I can tell, their capacity chain is always 1 -> 2 -> 4 -> ...), I don't see how does it make sense, if `sizeof(T)` is not a power of two.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441108326/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441385515",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-441385515",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 441385515,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTM4NTUxNQ==",
    "user": {
      "login": "gnzlbg",
      "id": 904614,
      "node_id": "MDQ6VXNlcjkwNDYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnzlbg",
      "html_url": "https://github.com/gnzlbg",
      "followers_url": "https://api.github.com/users/gnzlbg/followers",
      "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions",
      "organizations_url": "https://api.github.com/users/gnzlbg/orgs",
      "repos_url": "https://api.github.com/users/gnzlbg/repos",
      "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnzlbg/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-11-24T18:10:33Z",
    "updated_at": "2018-11-24T18:29:31Z",
    "body": "> If it starts with something like FBVector's 64 / sizeof(T), yes [...] I don't see how does it make sense, if sizeof(T) is not a power of two.\r\n\r\nIt's maybe a bit counter intuitive. `Alloc::usable_size` will always set the capacity of the vector at `BIN_SIZE / sizeof(T)`, so that the vector always uses at least `BIN_SIZE - sizeof(T) + 1` bytes of the allocation (if `BIN_SIZE % sizeof(T) == 0` then it uses `BIN_SIZE` bytes). As the vector grows, `BIN_SIZE` grows as a function of the capacity, but `sizeof(T) + 1` remains constantan\r\n\r\nThat is, a `Vec` that uses `Alloc::usable_size()` grows with `factor * capacity ~= factor * BIN_SIZE`, so `sizeof(T)` does not really play a role here. \r\n\r\nMaybe it is a bit clearer with an example, let's suppose `sizeof(T) == 13` (prime) and that our allocator only has power-of-two sizes. I'll directly jump to the cases that make this obvious:\r\n\r\n```rust\r\nlet mut v = Vec::with_capacity(8); \r\n// requests 8 * 13 = 104 bytes, allocator bin:  128 bytes\r\n// 128 / 13 = 9\r\nassert_eq!(v.capacity(), 9);\r\n\r\nv.extend(0..10); // push 10 elements to grow the vector\r\n// requested capacity: 2 * capacity() = 2 * 9 = 18 => 234 bytes\r\n// allocator bin: 256 bytes => 256 / 13 = 19\r\nassert_eq!(v.capacity(), 19); \r\n\r\nv.extend(0..10); // push another 10 elements to grow the vector\r\n// requested capacity: 2 * capacity() = 2 * 19 = 38 => 494 bytes\r\n// allocator bin: 512 bytes => 512 / 13 = 39\r\nassert_eq!(v.capacity(), 39);\r\n\r\n// etc.\r\n```\r\n\r\nSo that is what I meant with, if your `Vec` uses `Alloc::usable_size`, the exact growth-factor that you use is less \"relevant\".  For this particular case, you can actually exploit this knowledge to don't need a growth factor at all.\r\n\r\nYour allocator might not have size-classes, might lack an accurate `Alloc::usable_size()`, or might even be a real allocator like the one `FBVector` assumes (with accurate `Alloc::usable_size()` which `FBVector` uses, power-of-two size classes in a particular range, ... requiring `FBVector` to use multiple growth factors). \r\n\r\nBut even if you don't know anything about your allocator, a power-of-two size class assumptions makes sense. Many allocators use power-of-two size classes, and many types have a power-of-two size due to alignment requirements and fit it perfectly. If your vector starts with one such element and grows, it will do so perfectly, and if it doesn't fit a bin perfectly, it will always grow into the next bin (something that 1.5x growth-factor doesn't give you). A growth factor of 2 is also dirty cheap to compute.\r\n\r\nIf you have an accurate `Alloc::usable_size`, then the growth factor for small and medium allocations that fall in the allocators size classes doesn't really matter. As you move to large allocations, `Alloc::usable_size` just rounds up to the next multiple of a page size, and a factor of 1.5 grows less but more often, while a factor of 2 grows less often but more. Which one is best on that range really depends, but whether the arguments in favor of a 1.5 factor hold on that range (e.g. being able to reuse previously freed memory when growing), really depend on your allocator, and it is unclear to me that any allocator does actually anything clever enough to be helpful here. You might as well use a factor of `2` only with the hope of having to grow one time less than if you were using a factor of `1.5`.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441385515/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441390581",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-441390581",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 441390581,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTM5MDU4MQ==",
    "user": {
      "login": "leventov",
      "id": 609240,
      "node_id": "MDQ6VXNlcjYwOTI0MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/609240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leventov",
      "html_url": "https://github.com/leventov",
      "followers_url": "https://api.github.com/users/leventov/followers",
      "following_url": "https://api.github.com/users/leventov/following{/other_user}",
      "gists_url": "https://api.github.com/users/leventov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leventov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leventov/subscriptions",
      "organizations_url": "https://api.github.com/users/leventov/orgs",
      "repos_url": "https://api.github.com/users/leventov/repos",
      "events_url": "https://api.github.com/users/leventov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leventov/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2018-11-24T19:33:34Z",
    "updated_at": "2018-11-24T19:33:34Z",
    "body": "I should have clarified that I pointed to the lack of `sizeof(T)` consideration in `std::vector` implementations solely to make it more evident that those growth policies might be not results of deep thought or super fine tuning for specific allocators, but rather arbitrary decisions that were made decades ago and which nobody was able to or willed to change since. I mean, when you look at the relative complexity of the `FBVector`'s growth policy, you clearly see that authors _did_ think about that. `std::vector` double growth policy is simple, but it's likely not simplicity with \"great wisdom behind it\", so the 2.0 growth factor shouldn't receive additional credit because it appears in that `std::vector` impls. ",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/441390581/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/640002901",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-640002901",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 640002901,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0MDAwMjkwMQ==",
    "user": {
      "login": "mzabaluev",
      "id": 1198919,
      "node_id": "MDQ6VXNlcjExOTg5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1198919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzabaluev",
      "html_url": "https://github.com/mzabaluev",
      "followers_url": "https://api.github.com/users/mzabaluev/followers",
      "following_url": "https://api.github.com/users/mzabaluev/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzabaluev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzabaluev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzabaluev/subscriptions",
      "organizations_url": "https://api.github.com/users/mzabaluev/orgs",
      "repos_url": "https://api.github.com/users/mzabaluev/repos",
      "events_url": "https://api.github.com/users/mzabaluev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzabaluev/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-06-06T07:25:57Z",
    "updated_at": "2020-06-06T07:25:57Z",
    "body": "One case that would benefit if `reserve_exact` set the capacity to exactly the one requested is https://github.com/tokio-rs/bytes/issues/396",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/640002901/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1537279432",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-1537279432",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 1537279432,
    "node_id": "IC_kwDOAAsO6M5boQXI",
    "user": {
      "login": "workingjubilee",
      "id": 46493976,
      "node_id": "MDQ6VXNlcjQ2NDkzOTc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46493976?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/workingjubilee",
      "html_url": "https://github.com/workingjubilee",
      "followers_url": "https://api.github.com/users/workingjubilee/followers",
      "following_url": "https://api.github.com/users/workingjubilee/following{/other_user}",
      "gists_url": "https://api.github.com/users/workingjubilee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/workingjubilee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/workingjubilee/subscriptions",
      "organizations_url": "https://api.github.com/users/workingjubilee/orgs",
      "repos_url": "https://api.github.com/users/workingjubilee/repos",
      "events_url": "https://api.github.com/users/workingjubilee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/workingjubilee/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2023-05-07T03:31:00Z",
    "updated_at": "2023-05-07T03:31:00Z",
    "body": "The \"use a 1.5 growth strategy\" suggestion comes up a lot. However:\r\n\r\n> In practice, changes like this have been attempted, and yielded nontrivial perf regressions in the compiler: \r\n- https://github.com/rust-lang/rust/pull/108718\r\n- https://github.com/rust-lang/rust/pull/101341\r\n\r\n> As there is certainly not a shortage of Vecs in the compiler, it's reasonable to believe that this may not be a worthwhile improvement, as it trades off a potentially significant amount of runtime. However if someone can provide evidence otherwise, e.g. that the compiler is somehow distinct from every other common user of Vec, or if there is some conjoined changeset that makes this into an actual improvement, this remains open to change.\r\n\r\nFolly's size growth code seems to be similar, today, to what it was, with no exceptional difference. The last fix was to a typo. I almost find that suspicious, as the past 7 years have certainly yielded a plethora of research on allocations and their efficiency, such as mimalloc.\r\n\r\nhttps://github.com/facebook/folly/blob/1e6579890fe71387c14135080fc093045ab79897/folly/FBVector.h#L1141-L1171",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1537279432/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2065014689",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-2065014689",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 2065014689,
    "node_id": "IC_kwDOAAsO6M57FZ-h",
    "user": {
      "login": "AaronKutch",
      "id": 32419308,
      "node_id": "MDQ6VXNlcjMyNDE5MzA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32419308?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AaronKutch",
      "html_url": "https://github.com/AaronKutch",
      "followers_url": "https://api.github.com/users/AaronKutch/followers",
      "following_url": "https://api.github.com/users/AaronKutch/following{/other_user}",
      "gists_url": "https://api.github.com/users/AaronKutch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AaronKutch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AaronKutch/subscriptions",
      "organizations_url": "https://api.github.com/users/AaronKutch/orgs",
      "repos_url": "https://api.github.com/users/AaronKutch/repos",
      "events_url": "https://api.github.com/users/AaronKutch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AaronKutch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-04-18T19:16:06Z",
    "updated_at": "2024-04-18T20:24:56Z",
    "body": "I found this from https://users.rust-lang.org/t/reserve-truly-exact-capacity-for-vec/109751/19 . Some parts of this discussion are saying things about making `reserve_exact` or some part of reservation actually exact, but this is simply not possible. The `Drop` impl on `Vec` calls the drop impl on `RawVec`, which ultimately needs a `Layout` that has the same number of bytes as the allocation was created with (allocators are allowed to assume that allocation length information is being preserved, and at the same time they are allowed to return more than requested, in fact some strategies absolutely must do this, If my understanding is correct). Some field of the `RawVec` needs to store this information, and that ends up being the raw capacity also used for the capacity. It would be possible to do some capacity virtualization by adding another `usize`, but this will never happen as it impacts the performance of almost everything. Implementations simply must apply their own virtualization as needed, and they must accept that exact real capacity is not possible.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2065014689/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2065075963",
    "html_url": "https://github.com/rust-lang/rust/issues/29931#issuecomment-2065075963",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/29931",
    "id": 2065075963,
    "node_id": "IC_kwDOAAsO6M57Fo77",
    "user": {
      "login": "AaronKutch",
      "id": 32419308,
      "node_id": "MDQ6VXNlcjMyNDE5MzA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32419308?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AaronKutch",
      "html_url": "https://github.com/AaronKutch",
      "followers_url": "https://api.github.com/users/AaronKutch/followers",
      "following_url": "https://api.github.com/users/AaronKutch/following{/other_user}",
      "gists_url": "https://api.github.com/users/AaronKutch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AaronKutch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AaronKutch/subscriptions",
      "organizations_url": "https://api.github.com/users/AaronKutch/orgs",
      "repos_url": "https://api.github.com/users/AaronKutch/repos",
      "events_url": "https://api.github.com/users/AaronKutch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AaronKutch/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-04-18T19:33:07Z",
    "updated_at": "2024-04-18T19:33:07Z",
    "body": "What actually should be done is that `reserve_exact` should be deprecated, the name itself can mislead people. In fact, it lead me to an exponential capacity blowup problem in one of my crates. All other related functions need to state up front that allocations and reservations can always allocate more than requested.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2065075963/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
