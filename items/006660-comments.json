[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22679124",
    "html_url": "https://github.com/rust-lang/rust/issues/6660#issuecomment-22679124",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/6660",
    "id": 22679124,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNjc5MTI0",
    "user": {
      "login": "graydon",
      "id": 14097,
      "node_id": "MDQ6VXNlcjE0MDk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/graydon",
      "html_url": "https://github.com/graydon",
      "followers_url": "https://api.github.com/users/graydon/followers",
      "following_url": "https://api.github.com/users/graydon/following{/other_user}",
      "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/graydon/subscriptions",
      "organizations_url": "https://api.github.com/users/graydon/orgs",
      "repos_url": "https://api.github.com/users/graydon/repos",
      "events_url": "https://api.github.com/users/graydon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/graydon/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-15T01:07:09Z",
    "updated_at": "2013-08-15T01:07:09Z",
    "body": "I'm not entirely clear what's going on here. Both functions appear to have the same type but the testcase says it's testing them being different. Can you clarify?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22679124/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22719687",
    "html_url": "https://github.com/rust-lang/rust/issues/6660#issuecomment-22719687",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/6660",
    "id": 22719687,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNzE5Njg3",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-15T18:29:27Z",
    "updated_at": "2013-08-15T18:29:27Z",
    "body": "Woah, I forgot about this bug. This is an interesting test case. It has nothing to do with fastffi. In fact, i'm not sure why it crashes, it kind of .. looks like an LLVM bug? But something fishy is definitely going on. Here is an updated test:\n\n```\n// Test what happens when we link to the same function name with\n// different types. This situation can easily arise when linking two\n// crates that make use of the same C library, for example.\n\nmod A {\n    pub struct TwoU32s {\n        one: u32, two: u32\n    }\n    extern {\n        pub fn rust_dbg_extern_return_TwoU32s() -> TwoU32s;\n    }\n}\n\nmod B {\n    pub struct TwoU32s {\n        one: u32, two: u32\n    }\n    extern {\n        pub fn rust_dbg_extern_return_TwoU32s() -> TwoU32s;\n    }\n}\n\nfn wrapper() {\n}\n\n#[fixed_stack_segment]\nfn main() {\n    unsafe {\n        let a = A::rust_dbg_extern_return_TwoU32s();\n    }\n\n    unsafe {\n        let b = B::rust_dbg_extern_return_TwoU32s();\n    }\n}\n```\n\nOn my branch for #8535, this code crashes when `main` tries to return to an invalid address. This only happens if BOTH calls are present. The assembly code shows that between the two calls, there is a subtract of $esp which misaligns the stack frame (look for `// XXX`):\n\n```\n    subl    $36, %esp\n.Ltmp12:\n    .cfi_offset %ebx, -12\n    calll   .L1$pb\n.L1$pb:\n    popl    %eax\n.Ltmp13:\n    addl    $_GLOBAL_OFFSET_TABLE_+(.Ltmp13-.L1$pb), %eax\n    leal    -16(%ebp), %ecx\n    movl    %ecx, (%esp)\n    movl    %eax, %ebx\n    movl    %eax, -28(%ebp)\n    calll   rust_dbg_extern_return_TwoU32s@PLT\n    subl    $4, %esp // XXX\n    leal    -24(%ebp), %eax\n    movl    %eax, (%esp)\n    movl    -28(%ebp), %ebx\n    calll   rust_dbg_extern_return_TwoU32s@PLT\n    addl    $36, %esp\n    popl    %ebx\n    popl    %ebp\n    ret\n```\n\nHowever, when I dump the LLVM output with `--emit-llvm -S`, I get nonsense:\n\n```\n\n; Function Attrs: fixedstacksegment noinline uwtable\ndefine void @\"_ZN4main16_cd92990fc38403c7_0$x2e0E\"({ i32, %tydesc*, i8*, i8*, i8 }*) #1 {\n\"function top level\":\n  %a = alloca %\"struct.A::TwoU32s\"\n  %b = alloca %\"struct.B::TwoU32s\"\n  call void @rust_dbg_extern_return_TwoU32s(%\"struct.A::TwoU32s\"* %a)\n  call void bitcast (void (%\"struct.A::TwoU32s\"*)* @rust_dbg_extern_return_TwoU32s to void (%\"struct.B::TwoU32s\"*)*)(%\"struct.B::TwoU32s\"* %b)\n  ret void\n}\n```\n\nThere is only one call here at all?\n\nAnyway, an interesting bug. (note that I am running on 32 bit linux, btw, which may be relevant)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22719687/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22744899",
    "html_url": "https://github.com/rust-lang/rust/issues/6660#issuecomment-22744899",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/6660",
    "id": 22744899,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNzQ0ODk5",
    "user": {
      "login": "luqmana",
      "id": 287063,
      "node_id": "MDQ6VXNlcjI4NzA2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luqmana",
      "html_url": "https://github.com/luqmana",
      "followers_url": "https://api.github.com/users/luqmana/followers",
      "following_url": "https://api.github.com/users/luqmana/following{/other_user}",
      "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions",
      "organizations_url": "https://api.github.com/users/luqmana/orgs",
      "repos_url": "https://api.github.com/users/luqmana/repos",
      "events_url": "https://api.github.com/users/luqmana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luqmana/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-16T02:53:14Z",
    "updated_at": "2013-08-16T02:53:14Z",
    "body": "Should it be casting the whole function as opposed to just the argument in the second call?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22744899/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22758439",
    "html_url": "https://github.com/rust-lang/rust/issues/6660#issuecomment-22758439",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/6660",
    "id": 22758439,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNzU4NDM5",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-16T10:21:03Z",
    "updated_at": "2013-08-16T10:21:03Z",
    "body": "Oh, wait, you're right, I misread that LLVM code, there _are_ in fact two calls. I'd say it... looks about right, actually. Yes, it should be casting the function.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22758439/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/25887175",
    "html_url": "https://github.com/rust-lang/rust/issues/6660#issuecomment-25887175",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/6660",
    "id": 25887175,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI1ODg3MTc1",
    "user": {
      "login": "thestinger",
      "id": 1505226,
      "node_id": "MDQ6VXNlcjE1MDUyMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thestinger",
      "html_url": "https://github.com/thestinger",
      "followers_url": "https://api.github.com/users/thestinger/followers",
      "following_url": "https://api.github.com/users/thestinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thestinger/orgs",
      "repos_url": "https://api.github.com/users/thestinger/repos",
      "events_url": "https://api.github.com/users/thestinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thestinger/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-10-08T12:59:42Z",
    "updated_at": "2013-10-08T12:59:42Z",
    "body": "This is no longer used.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/25887175/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
