[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/133947966",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-133947966",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 133947966,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzMzk0Nzk2Ng==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-23T22:26:15Z",
    "updated_at": "2015-08-23T22:26:15Z",
    "body": "cc @luqmana\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/133947966/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/134264717",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-134264717",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 134264717,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNDI2NDcxNw==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-24T16:03:12Z",
    "updated_at": "2015-08-24T16:03:12Z",
    "body": "If we did take this route I'd want to convert the environment lock to a rwlock to ensure that we could at least have parallel dns queries. Also cc #27705. \n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/134264717/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/134268078",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-134268078",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 134268078,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNDI2ODA3OA==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-24T16:07:11Z",
    "updated_at": "2015-08-24T16:07:11Z",
    "body": "Yeah, either way the situation is tricky. We get tangled up in glibc internals.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/134268078/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/134273584",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-134273584",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 134273584,
    "node_id": "MDEyOklzc3VlQ29tbWVudDEzNDI3MzU4NA==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-08-24T16:13:44Z",
    "updated_at": "2015-08-24T16:13:44Z",
    "body": "I found the wording on [this page](http://man7.org/linux/man-pages/man7/attributes.7.html) also particularly interesting:\n\n```\n       env    Functions marked with env as an MT-Safety issue access the\n              environment with getenv(3) or similar, without any guards to\n              ensure safety in the presence of concurrent modifications.\n\n              We do not mark these functions as MT-Unsafe, however, because\n              functions that modify the environment are all marked with\n              const:env and regarded as unsafe.  Being unsafe, the latter\n              are not to be called when multiple threads are running or\n              asynchronous signals are enabled, and so the environment can\n              be considered effectively constant in these contexts, which\n              makes the former safe.\n```\n\nThe getaddrinfo function [is indeed marked with this tag](http://man7.org/linux/man-pages/man3/getaddrinfo.3.html#ATTRIBUTES)\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/134273584/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/264624978",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-264624978",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 264624978,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2NDYyNDk3OA==",
    "user": {
      "login": "fweimer",
      "id": 2729073,
      "node_id": "MDQ6VXNlcjI3MjkwNzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2729073?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fweimer",
      "html_url": "https://github.com/fweimer",
      "followers_url": "https://api.github.com/users/fweimer/followers",
      "following_url": "https://api.github.com/users/fweimer/following{/other_user}",
      "gists_url": "https://api.github.com/users/fweimer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fweimer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fweimer/subscriptions",
      "organizations_url": "https://api.github.com/users/fweimer/orgs",
      "repos_url": "https://api.github.com/users/fweimer/repos",
      "events_url": "https://api.github.com/users/fweimer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fweimer/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2016-12-03T08:09:58Z",
    "updated_at": "2016-12-03T08:10:44Z",
    "body": "`std::env::set_var` is just not safe to use in a multi-threaded program, as I commented on issue #24741:\r\n\r\nEven without low-level races, `std::env::set_var` is not quite safe because you can change a variable (such as `TZ`), do something, and change it back to the original value, without impacting something else in the process which runs at the same time.\r\n\r\nThis problem would not go away if we provided thread-safe environment access at the libc layer. Therefore, I'm surprised the function isn't marked **`unsafe`**.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/264624978/reactions",
      "total_count": 6,
      "+1": 6,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/572578962",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-572578962",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 572578962,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MjU3ODk2Mg==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-01-09T14:13:43Z",
    "updated_at": "2020-01-09T14:13:43Z",
    "body": "Triage: as far as I know, this hasn't changed at all. The docs do describe this possible footgun.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/572578962/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/725873403",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-725873403",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 725873403,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyNTg3MzQwMw==",
    "user": {
      "login": "smmalis37",
      "id": 4054472,
      "node_id": "MDQ6VXNlcjQwNTQ0NzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4054472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smmalis37",
      "html_url": "https://github.com/smmalis37",
      "followers_url": "https://api.github.com/users/smmalis37/followers",
      "following_url": "https://api.github.com/users/smmalis37/following{/other_user}",
      "gists_url": "https://api.github.com/users/smmalis37/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smmalis37/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smmalis37/subscriptions",
      "organizations_url": "https://api.github.com/users/smmalis37/orgs",
      "repos_url": "https://api.github.com/users/smmalis37/repos",
      "events_url": "https://api.github.com/users/smmalis37/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smmalis37/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-11-12T06:40:19Z",
    "updated_at": "2020-11-12T06:40:19Z",
    "body": "This issue can also apply to any external crate that calls into something that calls get_env, for example https://github.com/time-rs/time/issues/293 and https://github.com/chronotope/chrono/issues/499. Maybe some way for these crates to observe the lock is called for?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/725873403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/725984984",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-725984984",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 725984984,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyNTk4NDk4NA==",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-11-12T10:19:44Z",
    "updated_at": "2020-11-12T10:19:44Z",
    "body": "Seems to me like this is a soundness issue, and should be marked I-unsound?",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/725984984/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/729956624",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-729956624",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 729956624,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyOTk1NjYyNA==",
    "user": {
      "login": "spastorino",
      "id": 52642,
      "node_id": "MDQ6VXNlcjUyNjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/spastorino",
      "html_url": "https://github.com/spastorino",
      "followers_url": "https://api.github.com/users/spastorino/followers",
      "following_url": "https://api.github.com/users/spastorino/following{/other_user}",
      "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions",
      "organizations_url": "https://api.github.com/users/spastorino/orgs",
      "repos_url": "https://api.github.com/users/spastorino/repos",
      "events_url": "https://api.github.com/users/spastorino/events{/privacy}",
      "received_events_url": "https://api.github.com/users/spastorino/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-11-18T21:12:10Z",
    "updated_at": "2020-11-18T21:12:10Z",
    "body": "Assigning `P-medium` as [discussed as part of the Prioritization Working Group procedure](https://rust-lang.zulipchat.com/#narrow/stream/245100-t-compiler.2Fwg-prioritization.2Falerts/topic/I-prioritize.20.2327970.20Does.20getaddrinfo.20need.20to.20take.20the.20ENV.20l.E2.80.A6) and removing `I-prioritize`.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/729956624/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730483610",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-730483610",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 730483610,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDQ4MzYxMA==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-11-19T16:20:02Z",
    "updated_at": "2020-11-19T16:20:02Z",
    "body": "Just repeating what I've said on Zulip: To resolve the soundness bug in time & chrono, one option would be to provide a `std::env::lock` method, which holds a lock on the environment until dropped. It's my understanding this is basically what is happening internally on some functions already in stdlib. Exposing this would allow _much_ safer usage of FFI.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730483610/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730487950",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-730487950",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 730487950,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDQ4Nzk1MA==",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-11-19T16:27:11Z",
    "updated_at": "2020-11-19T16:27:11Z",
    "body": "The env lock has to be exposed somehow, I agree.\r\n\r\nAn alternative API would be a function that takes a closure that will be called with the lock held. This is less powerful (which might be a good thing: provide the least powerful API that is good enough).",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730487950/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730488671",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-730488671",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 730488671,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDQ4ODY3MQ==",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-11-19T16:28:18Z",
    "updated_at": "2020-11-19T16:28:18Z",
    "body": "However, talking of the env lock -- also see https://github.com/rust-lang/rust/issues/64718 for how the current use of the env lock is wrong, so exposing it in that state might be a problem.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730488671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730488851",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-730488851",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 730488851,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDQ4ODg1MQ==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-11-19T16:28:35Z",
    "updated_at": "2020-11-19T16:28:35Z",
    "body": "Sure, that would work as well. End result is the same, if done properly.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/730488851/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752296619",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752296619",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752296619,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjI5NjYxOQ==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T01:32:44Z",
    "updated_at": "2020-12-30T01:32:44Z",
    "body": "Honestly, I don\u2019t believe `std::env::set_var` can be made safe.\r\n\r\nIn a pure-Rust program, it is already safe, but in C, `setenv` is considered thread-unsafe.  Therefore, C libraries assume that they can call `getenv` at any time.  Furthermore, adding a call to `getenv` is probably not considered worthy of a major version bump in the C library, so what was previously a safe call into that library can become unsafe without warning!\r\n\r\nEven without the thread safety problems, there are other reasons that `std::env::set_var` is unsafe.  Libraries such as `gtk` will load plugins from a path specified in an environment variable, and loading a shared library is inherently unsafe.  If the shared library is in the system shared library directory, it can be assumed safe, since the OS is considered trusted.  But it isn\u2019t safe to (say) load a library from the Downloads folder (which could contain anything).\r\n\r\nWhat *might* be safe is a function that fails if multiple threads are running, and which only allows setting a limited number of env vars, such as the timezone.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752296619/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752378478",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752378478",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752378478,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjM3ODQ3OA==",
    "user": {
      "login": "CraftSpider",
      "id": 13342132,
      "node_id": "MDQ6VXNlcjEzMzQyMTMy",
      "avatar_url": "https://avatars.githubusercontent.com/u/13342132?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CraftSpider",
      "html_url": "https://github.com/CraftSpider",
      "followers_url": "https://api.github.com/users/CraftSpider/followers",
      "following_url": "https://api.github.com/users/CraftSpider/following{/other_user}",
      "gists_url": "https://api.github.com/users/CraftSpider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CraftSpider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CraftSpider/subscriptions",
      "organizations_url": "https://api.github.com/users/CraftSpider/orgs",
      "repos_url": "https://api.github.com/users/CraftSpider/repos",
      "events_url": "https://api.github.com/users/CraftSpider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CraftSpider/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T08:49:17Z",
    "updated_at": "2020-12-30T08:49:17Z",
    "body": "I think that while the thread unsafety is a significant issue, security unsafety is not the purpose of `unsafe`, and it's not practical for the std to decide what variables count as 'safe' sec-wise, as that is heavily dependent on both platform and even installed programs.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752378478/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752413284",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752413284",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752413284,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjQxMzI4NA==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T10:46:40Z",
    "updated_at": "2020-12-30T10:46:40Z",
    "body": "What I meant is that while one could reasonably argue that writing into `/proc/self/mem` is unsafe, writing into `~/Downloads` is fairly clearly safe.  But if one is allowed to set GTK\u2019s plugin path, then it is impossible to write a safe GTK binding.\r\n\r\nThis doesn\u2019t even consider C libraries that call `getenv` from background threads.  I believe this is considered perfectly okay in C, but `std::env::set_var` being safe makes writing safe bindings to such libraries impossible.  There is no way (other than disgusting linker hacks) to make them synchronize their calls to `getenv` with Rust\u2019s calls to `setenv`, so either we give up binding to such libraries, or we declare `std::env::set_var` unsafe.  Not being able to bind to such libraries safely would be a shame, IMO.  An unsafe `std::env::set_var` would be much less of a loss.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752413284/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752416994",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752416994",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752416994,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjQxNjk5NA==",
    "user": {
      "login": "ssokolow",
      "id": 46915,
      "node_id": "MDQ6VXNlcjQ2OTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/46915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ssokolow",
      "html_url": "https://github.com/ssokolow",
      "followers_url": "https://api.github.com/users/ssokolow/followers",
      "following_url": "https://api.github.com/users/ssokolow/following{/other_user}",
      "gists_url": "https://api.github.com/users/ssokolow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ssokolow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ssokolow/subscriptions",
      "organizations_url": "https://api.github.com/users/ssokolow/orgs",
      "repos_url": "https://api.github.com/users/ssokolow/repos",
      "events_url": "https://api.github.com/users/ssokolow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ssokolow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T11:00:30Z",
    "updated_at": "2020-12-30T12:09:08Z",
    "body": "I think it makes more sense to call it \"out of scope\".\r\n\r\nSetting environment variables is such a common thing in interacting with the greater software ecosystem that I think declaring it unsafe would be akin to re-legislating whether leaking memory (and, thus, `Box::leak` and using `Rc` and `Arc` in ways that can't be proven free of reference cycles) should be `unsafe`.\r\n\r\nAmong other reasons, it would be very strongly at odds with codebases which are using cargo-geiger and `#![forbid(unsafe_code)]` to manage their auditing burdens for more subtle sources of unsafety. (i.e. raw pointer arithmetic, Undefined Behaviour, etc.)\r\n\r\nThere are entire design philosophies for microservices which call for you to pass all your configuration parameters via environment variables instead of files or command-line arguments... and if you just allow safe environment variable-ing when invoking subprocesses, it's not difficult for a process to re-call itself with a new environment that has something like `LD_PRELOAD` set. (Heck, I use that ease to make shell scripts which re-`exec` themselves in `xterm` if they don't have an open `stdin` and re-call themselves via `sudo` if they're not running with root permissions.)\r\n\r\n...not to mention that, if you're going to mark `set_var` as unsafe, you might as well also mark all file I/O as unsafe, since that can be used to modify the user's rcfiles:\r\n\r\n* Does GTK 3.x still allow a user's theme config to specify a compiled theme engine to load or are they forcing it to be pure CSS now? I know `~/.gtkrc-2.0` allows you to load arbitrary sofiles.\r\n* Why not modify an rcfile like `.bashrc` or `.xsessionrc` and set something like `LD_PRELOAD` that way?\r\n* If the process is running as the user that owns it (eg. `cargo install ...`), it can binary-patch itself so its next run will occur in an exploited state.\r\n* If the process is being invoked via a launcher from `/usr/share/applications`, then environment variables can be set for its next invocation by dropping an override into `~/.local/share/applications`.\r\n* etc. etc. etc.\r\n\r\nThis sort of thing is why, when I see this come up in Rust API design discussions on places like /r/rust/, people are advised to limit use of `unsafe` to a fairly narrow and solid definition of memory unsafety.\r\n\r\nFundamentally, neither POSIX nor GTK are designed with this kind of distinction in mind, so there's no perfect solution that's still practical in the real world. The fix for GTK will have to involve GTK chipping in with some kind of system to let a sandbox say \"all the mounts in the sandbox which hold code are read-only, and all the mounts in the sandbox which hold writable data are `noexec` and `noexec` means don't load plugins from them either\".\r\n\r\nOtherwise, you're basically retreading the same \"learn the lesson the hard way\" ground Python devs walked when they wrote and then removed the [`rexec` and `bastion` modules](https://docs.python.org/2/library/rexec.html) from the standard library. (If you weren't using Python in the early days of the 2.x series, they were attempts to provide restricted execution for a general-purpose language that wasn't built around a sandbox-friendly API the way JavaScript and Lua are without involving OS-level sandboxing.)",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752416994/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752670387",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752670387",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752670387,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjY3MDM4Nw==",
    "user": {
      "login": "carbotaniuman",
      "id": 41451839,
      "node_id": "MDQ6VXNlcjQxNDUxODM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/41451839?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/carbotaniuman",
      "html_url": "https://github.com/carbotaniuman",
      "followers_url": "https://api.github.com/users/carbotaniuman/followers",
      "following_url": "https://api.github.com/users/carbotaniuman/following{/other_user}",
      "gists_url": "https://api.github.com/users/carbotaniuman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/carbotaniuman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/carbotaniuman/subscriptions",
      "organizations_url": "https://api.github.com/users/carbotaniuman/orgs",
      "repos_url": "https://api.github.com/users/carbotaniuman/repos",
      "events_url": "https://api.github.com/users/carbotaniuman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/carbotaniuman/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T15:53:28Z",
    "updated_at": "2020-12-30T15:53:28Z",
    "body": "I don't know why there's a tangent about security unsafety, but I think the parent was talking about how set_env automatically races with every single use of getenv by C/C++/FFI code. A data race is as UB as it gets.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752670387/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752691378",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752691378",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752691378,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjY5MTM3OA==",
    "user": {
      "login": "ssokolow",
      "id": 46915,
      "node_id": "MDQ6VXNlcjQ2OTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/46915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ssokolow",
      "html_url": "https://github.com/ssokolow",
      "followers_url": "https://api.github.com/users/ssokolow/followers",
      "following_url": "https://api.github.com/users/ssokolow/following{/other_user}",
      "gists_url": "https://api.github.com/users/ssokolow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ssokolow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ssokolow/subscriptions",
      "organizations_url": "https://api.github.com/users/ssokolow/orgs",
      "repos_url": "https://api.github.com/users/ssokolow/repos",
      "events_url": "https://api.github.com/users/ssokolow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ssokolow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T17:03:06Z",
    "updated_at": "2020-12-30T17:07:22Z",
    "body": "My point is that `set_env` has so many uses in purely safe projects that do no FFI that marking it unsafe because of FFI data races would be like a more minor version of marking `println!` and friends unsafe because an FFI dependency might write to stdout or stderr without acquiring the lock... and I doubt you'd consider that a reasonable change.\r\n\r\n...or marking file I/O unsafe because `flock(2)` is advisory locking, not mandatory, and you could get a data race between the file descriptors your code opened and descriptors opened on the same file(s) by something else, in-process or out-of-process.\r\n\r\nIf you apply `unsafe` too broadly, it loses its value and it honestly wouldn't surprise me if such a change resulted in a `safed_setenv` crate that just restores the old status quo (with a clear explanation of what it's doing and why in the README) so that `set_env` isn't the one and only thing keeping an otherwise pure safe Rust crate from using `#![forbid(unsafe_code)]`.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752691378/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752694521",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752694521",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752694521,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjY5NDUyMQ==",
    "user": {
      "login": "carbotaniuman",
      "id": 41451839,
      "node_id": "MDQ6VXNlcjQxNDUxODM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/41451839?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/carbotaniuman",
      "html_url": "https://github.com/carbotaniuman",
      "followers_url": "https://api.github.com/users/carbotaniuman/followers",
      "following_url": "https://api.github.com/users/carbotaniuman/following{/other_user}",
      "gists_url": "https://api.github.com/users/carbotaniuman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/carbotaniuman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/carbotaniuman/subscriptions",
      "organizations_url": "https://api.github.com/users/carbotaniuman/orgs",
      "repos_url": "https://api.github.com/users/carbotaniuman/repos",
      "events_url": "https://api.github.com/users/carbotaniuman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/carbotaniuman/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T17:13:54Z",
    "updated_at": "2020-12-30T17:13:54Z",
    "body": "I understand that unsafe should only be used for memory safety, and that's what I'm saying. Glibc, musl, basically all Unix libcs says that messing with setenv is out of scope, and their official reocmmnedation/requirement is to not call it when you have threads.\r\n\r\nI'm mainly talking about the `localtime_r` and `getaddrinfo` case. If the only way to express those functions **soundly** is to be unsafe with the caveat that `set_var` has not been called, maybe we put the emphasis on the wrong with.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752694521/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752696162",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752696162",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752696162,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjY5NjE2Mg==",
    "user": {
      "login": "Nemo157",
      "id": 81079,
      "node_id": "MDQ6VXNlcjgxMDc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/81079?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nemo157",
      "html_url": "https://github.com/Nemo157",
      "followers_url": "https://api.github.com/users/Nemo157/followers",
      "following_url": "https://api.github.com/users/Nemo157/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nemo157/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nemo157/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nemo157/subscriptions",
      "organizations_url": "https://api.github.com/users/Nemo157/orgs",
      "repos_url": "https://api.github.com/users/Nemo157/repos",
      "events_url": "https://api.github.com/users/Nemo157/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nemo157/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-30T17:19:57Z",
    "updated_at": "2020-12-30T17:19:57Z",
    "body": "`std::env::set_var` could be made sound to FFI by making it purely affect the Rust runtime's environment variables. That means any variable set by it could only be read via `std::env::get_var`, and would probably make it more expensive as it would have to CoW the C environment variables, but that is the only approach that seems to allow disconnecting its soundness from the soundness of the underlying `setenv` call.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752696162/reactions",
      "total_count": 6,
      "+1": 6,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752897480",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752897480",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752897480,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1Mjg5NzQ4MA==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-31T09:08:57Z",
    "updated_at": "2020-12-31T09:08:57Z",
    "body": "Another approach would be to have `std::env::set_var` fail if multiple threads are running.  This is trivial on Linux if `/proc` is mounted.\r\n\r\nThis is my preferred approach for several reasons:\r\n\r\n- It allows programs that call `std::env::set_var` early in `main` to continue to work.  This is useful for setting parameters for C libraries, for example.\r\n- We can expose the \u201care multiple threads running\u201d function in from libstd.  This is useful for calling inherently thread-unsafe C functions such as `curl_global_init`, which otherwise cannot be safely called from Rust.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752897480/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752905756",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752905756",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752905756,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjkwNTc1Ng==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-31T09:46:49Z",
    "updated_at": "2020-12-31T09:46:49Z",
    "body": "@DemiMarie By fail, I presume you mean panic?; `env::set_var` doesn't return a `Result`/`Option`. It's certainly an option, though the behavior would certainly have to be clearly documented.\r\n\r\n<sup>(for those wondering, the uptick in activity is because I created a thread on IRLO)</sup>",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752905756/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752908837",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-752908837",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 752908837,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjkwODgzNw==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2020-12-31T09:56:03Z",
    "updated_at": "2020-12-31T09:56:03Z",
    "body": "@jhpratt yes, panic.  I can\u2019t think of any legitimate uses for changing environment variables (which, by definition, are global state) when multiple threads are running.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/752908837/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753238125",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-753238125",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 753238125,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MzIzODEyNQ==",
    "user": {
      "login": "ssokolow",
      "id": 46915,
      "node_id": "MDQ6VXNlcjQ2OTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/46915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ssokolow",
      "html_url": "https://github.com/ssokolow",
      "followers_url": "https://api.github.com/users/ssokolow/followers",
      "following_url": "https://api.github.com/users/ssokolow/following{/other_user}",
      "gists_url": "https://api.github.com/users/ssokolow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ssokolow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ssokolow/subscriptions",
      "organizations_url": "https://api.github.com/users/ssokolow/orgs",
      "repos_url": "https://api.github.com/users/ssokolow/repos",
      "events_url": "https://api.github.com/users/ssokolow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ssokolow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-01-01T01:30:52Z",
    "updated_at": "2021-01-01T01:31:43Z",
    "body": "@DemiMarie I'd be in favour of doing that and adding a couple of other versions, following the pattern of many other panicking operations in `std`:\r\n\r\n* `fn set_var_checked` (Returns a `Result` with the error variant covering \"threading in use\" but also also taking over the existing \"may panic if `key` is empty, contains an ASCII equals sign `'='` or the NUL character `'\\0'`, or when the value contains the NUL character\")\r\n* `unsafe fn set_var_unchecked` (Used for situations where threads are at play, but a manual audit has confirmed that only one of them has anything to do with the environment.)\r\n\r\n`set_var` could then be re-implemented as something along the lines of `set_var_checked(...).unwrap()`.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753238125/reactions",
      "total_count": 5,
      "+1": 5,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753240109",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-753240109",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 753240109,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MzI0MDEwOQ==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-01-01T01:56:24Z",
    "updated_at": "2021-01-01T01:56:24Z",
    "body": "@ssokolow I like `set_var_checked`, but prefer to avoid `set_var_unchecked`.  The problem is that `set_var_unchecked` doesn\u2019t seem to have useful semantics: even if *right now* no other thread accesses the environment, this could change in a patch version bump of a dependency.  I cannot think of any legitimate uses for it right now, and I suspect that those that do exist would be okay with calling `setenv` manually.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753240109/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753240400",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-753240400",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 753240400,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MzI0MDQwMA==",
    "user": {
      "login": "ssokolow",
      "id": 46915,
      "node_id": "MDQ6VXNlcjQ2OTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/46915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ssokolow",
      "html_url": "https://github.com/ssokolow",
      "followers_url": "https://api.github.com/users/ssokolow/followers",
      "following_url": "https://api.github.com/users/ssokolow/following{/other_user}",
      "gists_url": "https://api.github.com/users/ssokolow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ssokolow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ssokolow/subscriptions",
      "organizations_url": "https://api.github.com/users/ssokolow/orgs",
      "repos_url": "https://api.github.com/users/ssokolow/repos",
      "events_url": "https://api.github.com/users/ssokolow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ssokolow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-01-01T02:00:51Z",
    "updated_at": "2021-01-01T02:02:14Z",
    "body": "@DemiMarie Fair enough. I suppose it's rare enough to need to change in-process environment after the initial setup phase that asking people to add a dependency on `libc` or `winapi` would be acceptable when one of the following is insufficient:\r\n\r\n* Set the environment before starting the threads\r\n* Use `Command::env*` methods when invoking subprocesses\r\n* Do everything single-threaded\r\n\r\nIt'd certainly encourage people to think twice before doing it.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/753240400/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/792999894",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-792999894",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 792999894,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5Mjk5OTg5NA==",
    "user": {
      "login": "joshtriplett",
      "id": 162737,
      "node_id": "MDQ6VXNlcjE2MjczNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshtriplett",
      "html_url": "https://github.com/joshtriplett",
      "followers_url": "https://api.github.com/users/joshtriplett/followers",
      "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions",
      "organizations_url": "https://api.github.com/users/joshtriplett/orgs",
      "repos_url": "https://api.github.com/users/joshtriplett/repos",
      "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshtriplett/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T19:07:50Z",
    "updated_at": "2021-03-08T19:07:50Z",
    "body": "Following up on this:\r\n\r\n@RalfJung wrote:\r\n> The env lock has to be exposed somehow, I agree.\r\n\r\nI don't think we should expose the internals of our environment locking, because that means we'll never be able to change or evolve it again.\r\n\r\nI looked into using `getaddrinfo_a` with `GAI_WAIT`, since it's marked as \"MT-Safe\" rather than \"MT-Safe env locale\" like `getaddrinfo` is, but I think this is a [bug in the documentation](https://lore.kernel.org/linux-man/YEZwqXhBTzbMAyzo@localhost/T/#u), because `getaddrinfo_a` still calls the same `getaddrinfo` in a thread, so it'll still fail in the same way if the environment changes concurrently.\r\n\r\nFor the moment at least, I do think the right solution is to take the environment lock around calls to `getaddrinfo`. This doesn't solve the general problem, since non-Rust code won't use the Rust environment lock, but it'll at least mean purely Rust programs won't have any issues here, which is an improvement over the current situation.\r\n\r\n(And yes, we should also switch that lock to an rwlock. There were some efforts to do that recently, which [ran into an issue that required reverting them](https://github.com/rust-lang/rust/pull/82877), but I think it'd be possible to make the same change again as long as we avoid releasing a lock in a child process that we acquire in the parent. Once we do that, switching it to an rwlock seems fine, and will avoid a performance bottleneck on `getaddrinfo` calls.)\r\n\r\nIdeally we should have a better solution for the environment in the future, but in the meantime, using the environment lock here seems like a good idea.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/792999894/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793011300",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793011300",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793011300,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzAxMTMwMA==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T19:25:38Z",
    "updated_at": "2021-03-08T19:25:38Z",
    "body": "@joshtriplett What would you consider exposing the internals of the environment locking? In the same comment, Ralf threw out the option of a closure that would be run with the lock held. That wouldn't result in any public API exposing the implementation detail, but would still result in the same behavior.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793011300/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793012548",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793012548",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793012548,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzAxMjU0OA==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T19:27:29Z",
    "updated_at": "2021-03-08T19:27:29Z",
    "body": "@joshtriplett What about having our environment-modification functions `panic!` if there is more than one thread running?  That seems to be the only sustainable approach in the long run.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793012548/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793036927",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793036927",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793036927,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzAzNjkyNw==",
    "user": {
      "login": "joshtriplett",
      "id": 162737,
      "node_id": "MDQ6VXNlcjE2MjczNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshtriplett",
      "html_url": "https://github.com/joshtriplett",
      "followers_url": "https://api.github.com/users/joshtriplett/followers",
      "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions",
      "organizations_url": "https://api.github.com/users/joshtriplett/orgs",
      "repos_url": "https://api.github.com/users/joshtriplett/repos",
      "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshtriplett/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T20:03:43Z",
    "updated_at": "2021-03-08T20:03:43Z",
    "body": "@jhpratt That would hide the exact mechanism we use for locking, but would still expose that we use locking around the environment. It would also likely expose semantics of mutual exclusion. For instance, does it support recursive locking or can it self-deadlock? Does it use mutual exclusion (in which case people could count on two such closures not running concurrently), or a read lock, or some other mechanism such as snapshotting or transactions? What if we have a target where the environment is multi-thread safe; can we just call the closure with no locking, or would that break assumptions made based on other targets?\r\n\r\nThis is an area that still needs some fixing, and I'd be concerned that exposing its internals will make it much harder for us to improve it in the future.\r\n\r\n@DemiMarie That would break a huge number of programs that work today. Rust's locking makes those programs correct as long as they only use Rust functions to touch the environment.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793036927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793054549",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793054549",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793054549,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzA1NDU0OQ==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T20:30:13Z",
    "updated_at": "2021-03-08T20:30:13Z",
    "body": "> @DemiMarie That would break a huge number of programs that work today. Rust's locking makes those programs correct as long as they only use Rust functions to touch the environment.\r\n\r\nThe problem is that there are far, *far* too many ways to touch the environment.  A C library that a Rust program depends on could start touching the environment in a patch release, and without warning.  Furthermore, there is currently no way to safely call C libraries that read environment variables.  See https://github.com/rust-lang/rust/issues/27970#issuecomment-725873403 for cases where this is a problem.  Rust bindings to GTK would also be affected.  And even if a C library does not currently access the environment, it might start doing so in a minor version.  If I maintained such a library, I would not consider adding a call to `getenv` to be a breaking change.\r\n\r\nIn short, on \\*nix, calling `setenv` or `putenv` (or assigning to `environ`) from a multi-threaded program is *itself* Undefined Behavior, unless one knows every C function the other threads could possibly be calling.  And that is not a realistic assumption in practice.  That leaves panicking as the only option.  Is it a good one?  No.  But it is the best one available to us.   And it unlocks critical functionality such as proper time zone handling.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793054549/reactions",
      "total_count": 4,
      "+1": 4,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793063984",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793063984",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793063984,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzA2Mzk4NA==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T20:45:17Z",
    "updated_at": "2021-03-08T20:45:17Z",
    "body": "> That would break a huge number of programs that work today. Rust's locking makes those programs correct as long as they only use Rust functions to touch the environment.\r\n\r\nThe problem is that's not always possible. If it were, I likely wouldn't even be subscribed to this issue, as there wouldn't have been a soundness issue in the time crate.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793063984/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793069777",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793069777",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793069777,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzA2OTc3Nw==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T20:54:33Z",
    "updated_at": "2021-03-08T20:54:33Z",
    "body": "> > That would break a huge number of programs that work today. Rust's locking makes those programs correct as long as they only use Rust functions to touch the environment.\r\n> \r\n> The problem is that's not always possible. If it were, I likely wouldn't even be subscribed to this issue, as there wouldn't have been a soundness issue in the time crate.\r\n\r\nExactly :+1:",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793069777/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793166833",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793166833",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793166833,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzE2NjgzMw==",
    "user": {
      "login": "joshtriplett",
      "id": 162737,
      "node_id": "MDQ6VXNlcjE2MjczNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshtriplett",
      "html_url": "https://github.com/joshtriplett",
      "followers_url": "https://api.github.com/users/joshtriplett/followers",
      "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions",
      "organizations_url": "https://api.github.com/users/joshtriplett/orgs",
      "repos_url": "https://api.github.com/users/joshtriplett/repos",
      "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshtriplett/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-08T23:28:17Z",
    "updated_at": "2021-03-08T23:28:17Z",
    "body": "I'm not arguing that the general state of environment handling in threaded programs is anything less than awful.\r\n\r\nIt *is* worth pointing out that glibc, at least, seems to have its own internal locking, such that concurrent calls to `setenv` and `getenv` are not *inherently* racy. And since Rust calls those functions internally rather than reimplementing environment handling itself, the combination of Rust and glibc shouldn't in general have races. (There are exceptions, notably around fork/exec, and those need further work.)\r\n\r\nThe issue is that today, there are many, many programs out there that use threads, use Rust environment functions, and either don't call C or don't call any C code that touches the environment. Those programs run fine today, and will break if we change our environment functions to panic.\r\n\r\nI understand why, if you've run into a problem caused by this, panicking if called from a multithreaded program seems like it might be the best option. But I don't think the breakage that would cause is something we should do lightly. And I'm still hoping there are better alternatives.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793166833/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793478122",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-793478122",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 793478122,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MzQ3ODEyMg==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-03-09T07:20:56Z",
    "updated_at": "2021-03-09T07:20:56Z",
    "body": "> I'm not arguing that the general state of environment handling in threaded programs is anything less than awful.\r\n> \r\n> It _is_ worth pointing out that glibc, at least, seems to have its own internal locking, such that concurrent calls to `setenv` and `getenv` are not _inherently_ racy. And since Rust calls those functions internally rather than reimplementing environment handling itself, the combination of Rust and glibc shouldn't in general have races. (There are exceptions, notably around fork/exec, and those need further work.)\r\n\r\nThe glibc documentation states otherwise.  So does POSIX.  What we *might* be able to do is atomically replace `extern char **environ` with a different pointer, leaking the old one.  But even that is doubtful: it could race with libc, which won\u2019t access `environ` atomically.  And it will leak memory.\r\n\r\n> The issue is that today, there are many, many programs out there that use threads, use Rust environment functions, and either don't call C or don't call any C code that touches the environment. Those programs run fine today, and will break if we change our environment functions to panic.\r\n> \r\n> I understand why, if you've run into a problem caused by this, panicking if called from a multithreaded program seems like it might be the best option. But I don't think the breakage that would cause is something we should do lightly. And I'm still hoping there are better alternatives.\r\n\r\nI don\u2019t like the idea of panicking, but from what I can tell, that is the only option available if we want `std::env::{set,remove}_var` to actually modify the C environment.  Of course, if we are willing for those functions to only affect the environment as seen by Rust, then everything is fine.  Using `setenv` from a multithreaded process isn\u2019t, unless one controls all of the threads in the process.\r\n\r\nAlso, do you know of any specific programs that *do* call `std::env::{set,remove}_var` with multiple threads running?  Those functions are usually called during initialization.  The main exception I can think of is programs that use PAM, but PAM is inherently unsafe in a multithreaded process.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/793478122/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/836271814",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-836271814",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 836271814,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNjI3MTgxNA==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-10T07:06:18Z",
    "updated_at": "2021-05-10T07:06:18Z",
    "body": "Out of curiosity, what's the chances of getting a crater run if there were a speculative PR put together changing `setenv` to panic when multiple threads are running?\r\n\r\nNote that I don't particularly care for this solution, but it _is_ a solution. If fallout is minimal, why not do it? If there's significant fallout, at least we can eliminate it.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/836271814/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/836493700",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-836493700",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 836493700,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNjQ5MzcwMA==",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-10T09:56:57Z",
    "updated_at": "2021-05-10T09:58:01Z",
    "body": "> Out of curiosity, what's the chances of getting a crater run if there were a speculative PR put together changing `setenv` to panic when multiple threads are running?\r\n> \r\n> Note that I don't particularly care for this solution, but it _is_ a solution. If fallout is minimal, why not do it? If there's significant fallout, at least we can eliminate it.\r\n\r\nThis actually seems like the best answer to me.  IMO we should ~~really do the same thing with `std::process::exit`; which has similar problems~~ figure out a better solution for `std::process::exit` (such as panicking if Rust\u2019s `main` was not used *and* multiple threads are running).",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/836493700/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/837239171",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-837239171",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 837239171,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNzIzOTE3MQ==",
    "user": {
      "login": "bluss",
      "id": 3209739,
      "node_id": "MDQ6VXNlcjMyMDk3Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bluss",
      "html_url": "https://github.com/bluss",
      "followers_url": "https://api.github.com/users/bluss/followers",
      "following_url": "https://api.github.com/users/bluss/following{/other_user}",
      "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bluss/subscriptions",
      "organizations_url": "https://api.github.com/users/bluss/orgs",
      "repos_url": "https://api.github.com/users/bluss/repos",
      "events_url": "https://api.github.com/users/bluss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bluss/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-10T19:55:59Z",
    "updated_at": "2021-05-12T18:07:09Z",
    "body": "@jhpratt I would guess the most important code does not run in a crater test. It's a great tool for build testing but I don't think it can give us a conclusive answer here.\r\n\r\nThere are a lot of projects that one can find that use set_var in its test suite. That's not necessarily a big problem for Rust in the large, that's just a scaffolding issue, but it will be the biggest signal that comes out from crater, that those testsuites all panic (?).\r\nI guess those few test cases that call library code, that in turn call set_var, that will be the interesting data points from crater in terms of actual possible application breakage.\r\n\r\nMaybe a real world case study would do better?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/837239171/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/837394203",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-837394203",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 837394203,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNzM5NDIwMw==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-10T21:44:31Z",
    "updated_at": "2021-05-10T21:44:31Z",
    "body": "Yeah, that's definitely true :/ How would a \"real world case study\" as you mention work? Aside from just asking people if they ever run `setenv` when multiple threads are running, which would likely produce very skewed results.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/837394203/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/837762755",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-837762755",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 837762755,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNzc2Mjc1NQ==",
    "user": {
      "login": "joshtriplett",
      "id": 162737,
      "node_id": "MDQ6VXNlcjE2MjczNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshtriplett",
      "html_url": "https://github.com/joshtriplett",
      "followers_url": "https://api.github.com/users/joshtriplett/followers",
      "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions",
      "organizations_url": "https://api.github.com/users/joshtriplett/orgs",
      "repos_url": "https://api.github.com/users/joshtriplett/repos",
      "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshtriplett/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-11T04:06:57Z",
    "updated_at": "2021-05-11T04:06:57Z",
    "body": "Offhand, one common example would be running your main function inside an async runtime that starts threads, and then setting environment variables at the top of that async main.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/837762755/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/838044179",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-838044179",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 838044179,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzODA0NDE3OQ==",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-05-11T08:12:45Z",
    "updated_at": "2021-05-11T08:12:45Z",
    "body": "This is me mostly speaking of ignorance: What are real-world use cases for setenv? I've never used it. If I understood _where_ and _why_ it's used, I can think about potential workarounds and their respective tradeoffs a bit.\r\n\r\nThe async runtime is a reasonable concern. While one could certainly write out the macro expansion for an async main, it would require some thought from the programmer's perspective.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/838044179/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/965568295",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-965568295",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 965568295,
    "node_id": "IC_kwDOAAsO6M45jWcn",
    "user": {
      "login": "leo60228",
      "id": 8355305,
      "node_id": "MDQ6VXNlcjgzNTUzMDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8355305?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leo60228",
      "html_url": "https://github.com/leo60228",
      "followers_url": "https://api.github.com/users/leo60228/followers",
      "following_url": "https://api.github.com/users/leo60228/following{/other_user}",
      "gists_url": "https://api.github.com/users/leo60228/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leo60228/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leo60228/subscriptions",
      "organizations_url": "https://api.github.com/users/leo60228/orgs",
      "repos_url": "https://api.github.com/users/leo60228/repos",
      "events_url": "https://api.github.com/users/leo60228/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leo60228/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-11-10T17:24:19Z",
    "updated_at": "2021-11-11T20:22:34Z",
    "body": "It's not very reliable, but here's a reproducer: https://gist.github.com/d3709b9b3a4b5338ef89c98b28ad078e\r\n\r\nOn my machine (24 logical cores), you can run `while :; do timeout 0.1 target/release/gai-crash; done` and get a segfault within a few seconds.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/965568295/reactions",
      "total_count": 10,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 10,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1001358327",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1001358327",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1001358327,
    "node_id": "IC_kwDOAAsO6M47r4P3",
    "user": {
      "login": "saethlin",
      "id": 12105168,
      "node_id": "MDQ6VXNlcjEyMTA1MTY4",
      "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/saethlin",
      "html_url": "https://github.com/saethlin",
      "followers_url": "https://api.github.com/users/saethlin/followers",
      "following_url": "https://api.github.com/users/saethlin/following{/other_user}",
      "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions",
      "organizations_url": "https://api.github.com/users/saethlin/orgs",
      "repos_url": "https://api.github.com/users/saethlin/repos",
      "events_url": "https://api.github.com/users/saethlin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/saethlin/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-27T06:15:39Z",
    "updated_at": "2021-12-27T06:16:50Z",
    "body": "> Furthermore, there is currently no way to safely call C libraries that read environment variables. See #27970 (comment) for cases where this is a problem.\r\n\r\nI think this comment understates the problem. openssl calls `getenv` during certificate validation, because it calls `gmtime_r`\\*. If the community is going to take this family of problems seriously, I think the `chrono`/`time` advisories are just the start.\r\n\r\n---\r\n\r\n\\* well, it calls `getenv` if linked against glibc, and `gmtime_r` is `MT-Safe env` so any implementation may but I don't think musl does.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1001358327/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1001359526",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1001359526",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1001359526,
    "node_id": "IC_kwDOAAsO6M47r4im",
    "user": {
      "login": "thomcc",
      "id": 860665,
      "node_id": "MDQ6VXNlcjg2MDY2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thomcc",
      "html_url": "https://github.com/thomcc",
      "followers_url": "https://api.github.com/users/thomcc/followers",
      "following_url": "https://api.github.com/users/thomcc/following{/other_user}",
      "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions",
      "organizations_url": "https://api.github.com/users/thomcc/orgs",
      "repos_url": "https://api.github.com/users/thomcc/repos",
      "events_url": "https://api.github.com/users/thomcc/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thomcc/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-27T06:18:47Z",
    "updated_at": "2021-12-27T06:20:24Z",
    "body": "It's worth noting that there's significant (and ongoing) discussion about this https://internals.rust-lang.org/t/synchronized-ffi-access-to-posix-environment-variable-functions/15475. I think we're going to take this seriously, but probably the solution is probably not to report a CVE against nearly every rust library that does FFI.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1001359526/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1001363572",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1001363572",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1001363572,
    "node_id": "IC_kwDOAAsO6M47r5h0",
    "user": {
      "login": "saethlin",
      "id": 12105168,
      "node_id": "MDQ6VXNlcjEyMTA1MTY4",
      "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/saethlin",
      "html_url": "https://github.com/saethlin",
      "followers_url": "https://api.github.com/users/saethlin/followers",
      "following_url": "https://api.github.com/users/saethlin/following{/other_user}",
      "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions",
      "organizations_url": "https://api.github.com/users/saethlin/orgs",
      "repos_url": "https://api.github.com/users/saethlin/repos",
      "events_url": "https://api.github.com/users/saethlin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/saethlin/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-27T06:29:57Z",
    "updated_at": "2021-12-27T06:29:57Z",
    "body": "I totally agree, that would not be a good outcome. Thanks for directing me to the discussion, I'm not used to looking at IRLO.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1001363572/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002769068",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1002769068",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1002769068,
    "node_id": "IC_kwDOAAsO6M47xQqs",
    "user": {
      "login": "fweimer",
      "id": 2729073,
      "node_id": "MDQ6VXNlcjI3MjkwNzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2729073?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fweimer",
      "html_url": "https://github.com/fweimer",
      "followers_url": "https://api.github.com/users/fweimer/followers",
      "following_url": "https://api.github.com/users/fweimer/following{/other_user}",
      "gists_url": "https://api.github.com/users/fweimer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fweimer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fweimer/subscriptions",
      "organizations_url": "https://api.github.com/users/fweimer/orgs",
      "repos_url": "https://api.github.com/users/fweimer/repos",
      "events_url": "https://api.github.com/users/fweimer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fweimer/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-29T20:40:44Z",
    "updated_at": "2021-12-29T20:40:44Z",
    "body": "> I think this comment understates the problem. openssl calls `getenv` during certificate validation, because it calls `gmtime_r`*. If the community is going to take this family of problems seriously, I think the `chrono`/`time` advisories are just the start.\r\n> \r\n> * well, it calls `getenv` if linked against glibc, and `gmtime_r` is `MT-Safe env` so any implementation may but I don't think musl does.\r\n\r\nWe should be able to make the *internal* `getenv` calls in glibc MT-safe at least. The external interface is a different matter. POSIX even hints towards a thread-safe implementation for the public `getenv` function (*The returned string pointer might also be invalidated if the calling thread is terminated.*), although this would be an observable difference to the C11 `getenv`.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002769068/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002872405",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1002872405",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1002872405,
    "node_id": "IC_kwDOAAsO6M47xp5V",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-30T04:50:17Z",
    "updated_at": "2021-12-30T04:50:17Z",
    "body": "@fweimer would it be possible to provide a way for Rust to detect this at runtime?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002872405/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002879459",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1002879459",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1002879459,
    "node_id": "IC_kwDOAAsO6M47xrnj",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-30T05:31:10Z",
    "updated_at": "2021-12-30T05:31:10Z",
    "body": "@fweimer Would it be desirable to:\r\n\r\n1. Issue an advisory for this, so that it gets backported by distribution maintainers, and\r\n2. Provide an interface that Rust can use at runtime to detect a patched glibc?\r\n\r\n@RichFelker would you be interested in changing this in musl?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002879459/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002880904",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1002880904",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1002880904,
    "node_id": "IC_kwDOAAsO6M47xr-I",
    "user": {
      "login": "leo60228",
      "id": 8355305,
      "node_id": "MDQ6VXNlcjgzNTUzMDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8355305?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leo60228",
      "html_url": "https://github.com/leo60228",
      "followers_url": "https://api.github.com/users/leo60228/followers",
      "following_url": "https://api.github.com/users/leo60228/following{/other_user}",
      "gists_url": "https://api.github.com/users/leo60228/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leo60228/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leo60228/subscriptions",
      "organizations_url": "https://api.github.com/users/leo60228/orgs",
      "repos_url": "https://api.github.com/users/leo60228/repos",
      "events_url": "https://api.github.com/users/leo60228/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leo60228/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-30T05:39:56Z",
    "updated_at": "2021-12-30T05:39:56Z",
    "body": "This issue doesn't solely apply to glibc and musl. We'd need to ensure this for every target, or get it changed in the standard. I don't think either option is feasible. ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002880904/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002882670",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1002882670",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1002882670,
    "node_id": "IC_kwDOAAsO6M47xsZu",
    "user": {
      "login": "saethlin",
      "id": 12105168,
      "node_id": "MDQ6VXNlcjEyMTA1MTY4",
      "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/saethlin",
      "html_url": "https://github.com/saethlin",
      "followers_url": "https://api.github.com/users/saethlin/followers",
      "following_url": "https://api.github.com/users/saethlin/following{/other_user}",
      "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions",
      "organizations_url": "https://api.github.com/users/saethlin/orgs",
      "repos_url": "https://api.github.com/users/saethlin/repos",
      "events_url": "https://api.github.com/users/saethlin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/saethlin/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-30T05:49:26Z",
    "updated_at": "2021-12-30T05:52:31Z",
    "body": "Patching POSIX/libc has been proposed in the IRLO thread linked above. I don't think it's a good solution because this takes the ability to fix things out of the hands of the Rust programmers, and in many cases leaves us at the behest of whatever distro we happen to be using (there is at least one comment to this effect in the thread). And in addition, this does nothing to help with programs or libraries that access the environment through `environ`/the third argument to `main` (this is mentioned multiple times in the IRLO thread).\r\n\r\nMoreover, I don't think it's at all fair to put this on libc maintainers. Rust messed up here. Or, if not the standard library, loads of library authors messed up. And even if there were libc patches, I struggle to imagine prioritizing this as a backported security fix. IMO it's a pretty clear case of someone didn't follow the very old and well-documented interface (and spooky though this bug is, it would be tricky to exploit). I can't imagine that if this had been brought up around 1.0 that all of `std::env` would look like what it does today. To that end: https://github.com/rust-lang/rust/pull/92365\r\n\r\n---\r\n\r\nIt would be _nice_ if POSIX or libc authors decided to make `getenv` and `setenv` both thread-safe, because it would mitigate the impact of this kind of mistake, as it has been made outside of Rust too: https://sourceware.org/bugzilla/show_bug.cgi?id=15607#c3",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1002882670/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003006386",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003006386",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003006386,
    "node_id": "IC_kwDOAAsO6M47yKmy",
    "user": {
      "login": "fweimer",
      "id": 2729073,
      "node_id": "MDQ6VXNlcjI3MjkwNzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2729073?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fweimer",
      "html_url": "https://github.com/fweimer",
      "followers_url": "https://api.github.com/users/fweimer/followers",
      "following_url": "https://api.github.com/users/fweimer/following{/other_user}",
      "gists_url": "https://api.github.com/users/fweimer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fweimer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fweimer/subscriptions",
      "organizations_url": "https://api.github.com/users/fweimer/orgs",
      "repos_url": "https://api.github.com/users/fweimer/repos",
      "events_url": "https://api.github.com/users/fweimer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fweimer/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-30T12:22:34Z",
    "updated_at": "2021-12-30T12:22:34Z",
    "body": "> @fweimer Would it be desirable to:\r\n> \r\n>     1. Issue an advisory for this, so that it gets backported by distribution maintainers, and\r\n> \r\n>     2. Provide an interface that Rust can use at runtime to detect a patched glibc?\r\n\r\nWe don't have patches yet. It's unclear how backportable they would be.\r\n\r\nThis is definitely *not* a glibc security vulnerability (if that's why mean by \u201cadvisory\u201d). `setenv` is not required to be thread-safe.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003006386/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003066633",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003066633",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003066633,
    "node_id": "IC_kwDOAAsO6M47yZUJ",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-30T15:02:59Z",
    "updated_at": "2021-12-30T15:02:59Z",
    "body": "> @richfelker would you be interested in changing this in musl?\r\n\r\nNo. At has been explained above and in the other tracker item of this form I took part in, this is purely a bug in the Rust specification, and needs to be fixed there. `setenv` (the POSIX function) is not thread-safe, and for every good reason should not be required to be. \"Not thread-safe\" means you are essentially not allowed to use it in a multi-threaded program at all. (There may be some subtle exceptions to that, but it's a good enough approximation.)\r\n\r\nWhy is it important that `setenv` not be thread-safe? Because the interface for accessing the environment, `getenv`, provides the caller a pointer to storage whose lifetime could end when `setenv` is called, but the caller of `getenv` has no way to \"release\" its reference to this storage. The other sanctioned interface, accessing `environ[]` directly, would have data races under concurrent `setenv`, which is just as bad. So if `setenv` were thread-safe, the operations of *reading* the environment would necessarily be non-thread-safe. Present issues of POSIX do not require that `getenv` be thread-safe, but basically everything depends on it being thread-safe, and all implementations I'm aware of make it so (which requires no work, since it's accessing read-only data). And at least for implementation-internal access to the environment, it's a requirement that it be thread-safe. And future issues of POSIX [will require](https://www.austingroupbugs.net/view.php?id=188#c325) it to be.\r\n\r\nFor what it's worth, `getaddrinfo` is not one of the functions which POSIX permits to inspect the environment, and the musl implementation does not, so this particular manifestation of the Rust issue should not be one you encounter on musl.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003066633/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003218748",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003218748",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003218748,
    "node_id": "IC_kwDOAAsO6M47y-c8",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T00:11:04Z",
    "updated_at": "2021-12-31T00:11:50Z",
    "body": "I don't think it's reasonable to change the behavior of the current `set_var` to panic or otherwise fail because that's a backward-incompatible change. Nor do I think it's reasonable to add any locking overhead or complexity to `get_var`.\r\n\r\nWhat makes sense to me is to:\r\n* Add an `unsafe fn set_var_unchecked(...)` that does exactly what the current set_var does.\r\n* Clearly document the thread safety hazard in `set_var_unchecked`.\r\n* Change `set_var` so that it is a wrapper around `set_var_unchecked`.\r\n* Mark `set_var` as `#[deprecated = \"use set_var_unchecked\"]`.\r\n* Expand the documentation of `set_var` to explain why it is deprecated.\r\n* In the next edition, make `set_var` an `unsafe fn`.\r\n\r\nThat's it. No added locking, no additional checking of `/proc`, no trying to patch libc. Leave `get_env` and similar as regular safe functions; they *are* safe as long as nobody does an unsafe thing using `set_var/set_var_unchecked`.\r\n\r\n@ssokolow wrote:\r\n> There are entire design philosophies for microservices which call for you to pass all your configuration parameters via environment variables instead of files or command-line arguments\r\n\r\nFor that kind of application, can't you just use `Command::{env, envs}` so that the environment variables are set when the process is spawned, instead of using `set_env`?\r\n\r\n@ssokolow wrote:\r\n> My point is that set_env has so many uses in purely safe projects\r\n\r\nI don't think there has been evidence to support this claim yet.\r\n\r\n> There are a lot of projects that one can find that use set_var in its test suite. That's not necessarily a big problem for Rust in the large, that's just a scaffolding issue\r\n\r\nIt is an issue for those tests because they unsafe because `set_env` actually is unsafe. Even if `set_env` were somehow safe, such tests are often racing with each other (FWIW, I found this issue trying to find a solution for projects who had tests misbehaving due to `set_env`).",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003218748/reactions",
      "total_count": 8,
      "+1": 8,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003231461",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003231461",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003231461,
    "node_id": "IC_kwDOAAsO6M47zBjl",
    "user": {
      "login": "ssokolow",
      "id": 46915,
      "node_id": "MDQ6VXNlcjQ2OTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/46915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ssokolow",
      "html_url": "https://github.com/ssokolow",
      "followers_url": "https://api.github.com/users/ssokolow/followers",
      "following_url": "https://api.github.com/users/ssokolow/following{/other_user}",
      "gists_url": "https://api.github.com/users/ssokolow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ssokolow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ssokolow/subscriptions",
      "organizations_url": "https://api.github.com/users/ssokolow/orgs",
      "repos_url": "https://api.github.com/users/ssokolow/repos",
      "events_url": "https://api.github.com/users/ssokolow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ssokolow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T01:13:46Z",
    "updated_at": "2021-12-31T01:14:03Z",
    "body": "Based on the discussions here and on IRO, I've since come around to the view that marking it unsafe in a way that doesn't break existing code is the right thing to do, as long as it's understood that it's not \"because of FFI data races\".\r\n\r\n(i.e. That it should be `unsafe` but it's important to think of the reasoning in terms of \"In day to day coding, we generally don't think of `std`'s dependency on `libc` as FFI, but this can make safe Rust fail because of it\". It's not something Rust can fix because of libc-internal uses, and it's something that has the potential to bite you even if your program uses only safe Rust and no third-party crates which do FFI.)",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003231461/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003233051",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003233051",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003233051,
    "node_id": "IC_kwDOAAsO6M47zB8b",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T01:23:34Z",
    "updated_at": "2021-12-31T01:23:34Z",
    "body": "On the contrary I believe that this should have an unsafe equivalent (in addition to the safe version being deprecated) because of FFI. As someone who calls a libc method that obtains an environment variable, I uphold all safety invariants of that method. It is std that is not upholding the safety invariants of set_env. Yes, it potentially manifests in pure Rust code, but it's much more likely when dealing with FFI. Rust upholding a safety invariant does not mean upholding it only when used with other Rust code. FFI is just as important.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003233051/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003233951",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003233951",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003233951,
    "node_id": "IC_kwDOAAsO6M47zCKf",
    "user": {
      "login": "ssokolow",
      "id": 46915,
      "node_id": "MDQ6VXNlcjQ2OTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/46915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ssokolow",
      "html_url": "https://github.com/ssokolow",
      "followers_url": "https://api.github.com/users/ssokolow/followers",
      "following_url": "https://api.github.com/users/ssokolow/following{/other_user}",
      "gists_url": "https://api.github.com/users/ssokolow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ssokolow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ssokolow/subscriptions",
      "organizations_url": "https://api.github.com/users/ssokolow/orgs",
      "repos_url": "https://api.github.com/users/ssokolow/repos",
      "events_url": "https://api.github.com/users/ssokolow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ssokolow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T01:27:45Z",
    "updated_at": "2021-12-31T01:27:45Z",
    "body": "> On the contrary I believe that this should have an unsafe equivalent (in addition to the safe version being deprecated) because of FFI.\r\n\r\nI'm not sure who you're replying to. Both I and @briansmith argued for this functionality to exist in `unsafe` form.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003233951/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003235108",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003235108",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003235108,
    "node_id": "IC_kwDOAAsO6M47zCck",
    "user": {
      "login": "jhpratt",
      "id": 3161395,
      "node_id": "MDQ6VXNlcjMxNjEzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3161395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jhpratt",
      "html_url": "https://github.com/jhpratt",
      "followers_url": "https://api.github.com/users/jhpratt/followers",
      "following_url": "https://api.github.com/users/jhpratt/following{/other_user}",
      "gists_url": "https://api.github.com/users/jhpratt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jhpratt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jhpratt/subscriptions",
      "organizations_url": "https://api.github.com/users/jhpratt/orgs",
      "repos_url": "https://api.github.com/users/jhpratt/repos",
      "events_url": "https://api.github.com/users/jhpratt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jhpratt/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T01:34:50Z",
    "updated_at": "2021-12-31T01:34:50Z",
    "body": "I was addressing this specific part\n\n> as long as it's understood that it's not \"because of FFI data races\".\n\nThough I'm certain we'd agree that we don't need to agree on the _reason_ for doing this so long as it's done.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003235108/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003235589",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003235589",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003235589,
    "node_id": "IC_kwDOAAsO6M47zCkF",
    "user": {
      "login": "ssokolow",
      "id": 46915,
      "node_id": "MDQ6VXNlcjQ2OTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/46915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ssokolow",
      "html_url": "https://github.com/ssokolow",
      "followers_url": "https://api.github.com/users/ssokolow/followers",
      "following_url": "https://api.github.com/users/ssokolow/following{/other_user}",
      "gists_url": "https://api.github.com/users/ssokolow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ssokolow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ssokolow/subscriptions",
      "organizations_url": "https://api.github.com/users/ssokolow/orgs",
      "repos_url": "https://api.github.com/users/ssokolow/repos",
      "events_url": "https://api.github.com/users/ssokolow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ssokolow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T01:38:54Z",
    "updated_at": "2021-12-31T01:38:54Z",
    "body": "Ahh. My point there was that, originally, I was seeing it more as \"`LD_PRELOAD` can break Rust safety invariants, as can things like GTK plugin loading, so why are we complicating safe Rust code that relies only on the FFI in `std`?\"\r\n\r\nWhen you \"turn to FFI\", there's an expectation that either you or your dependency developer will take on the responsibility of abstracting away what unsafety can be abstracted and documenting what is an inherently unsafe aspect of what you're depending on.\r\n\r\n`std` technically uses FFI, but to think about it the same way would fatally undermine what Rust is trying to accomplish as far as safety goes.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003235589/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003328227",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003328227",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003328227,
    "node_id": "IC_kwDOAAsO6M47zZLj",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T09:56:00Z",
    "updated_at": "2021-12-31T09:57:51Z",
    "body": "> Nor do I think it's reasonable to add any locking overhead or complexity to get_var.\r\n\r\nThe current get_var already performs locking; I don't think anyone proposed to add more locking.\r\nUnder your proposal, one could consider removing that locking, though probably it is better to keep it for compatibility reasons? OTOH, removing that lock would finally fix https://github.com/rust-lang/rust/issues/64718 (or at least the part of it that is about the env lock).",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003328227/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003461956",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003461956",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003461956,
    "node_id": "IC_kwDOAAsO6M47z51E",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2021-12-31T22:50:52Z",
    "updated_at": "2021-12-31T22:50:52Z",
    "body": "> The current get_var already performs locking; I don't think anyone proposed to add more locking. \r\n\r\nOK, I didn't realize that. This doesn't change my proposal. The `set_var_unchecked` that I am proposing would continue to do the locking, since I defined it to do exactly what `set_var` does now.\r\n\r\n> Under your proposal, one could consider removing that locking, though probably it is better to keep it for compatibility reasons? OTOH, removing that lock would finally fix #64718 (or at least the part of it that is about the env lock).\r\n\r\nSince the locking versions are already implemented, I suspect some people already rely on that locking in their pure-Rust (or close enough) code, especially tests. In #64718, there was already a plan proposed that seems to fix that issue without having to get rid of the lock?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003461956/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003471829",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003471829",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003471829,
    "node_id": "IC_kwDOAAsO6M47z8PV",
    "user": {
      "login": "saethlin",
      "id": 12105168,
      "node_id": "MDQ6VXNlcjEyMTA1MTY4",
      "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/saethlin",
      "html_url": "https://github.com/saethlin",
      "followers_url": "https://api.github.com/users/saethlin/followers",
      "following_url": "https://api.github.com/users/saethlin/following{/other_user}",
      "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions",
      "organizations_url": "https://api.github.com/users/saethlin/orgs",
      "repos_url": "https://api.github.com/users/saethlin/repos",
      "events_url": "https://api.github.com/users/saethlin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/saethlin/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-01T00:12:14Z",
    "updated_at": "2022-01-01T00:12:24Z",
    "body": "> I suspect some people already rely on that locking in their pure-Rust (or close enough) code, especially tests\r\n\r\nYes. We're aware of ~300 published crates which rely on this: https://crater-reports.s3.amazonaws.com/pr-90799/index.html",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003471829/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003759020",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003759020",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003759020,
    "node_id": "IC_kwDOAAsO6M471CWs",
    "user": {
      "login": "comex",
      "id": 47517,
      "node_id": "MDQ6VXNlcjQ3NTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/comex",
      "html_url": "https://github.com/comex",
      "followers_url": "https://api.github.com/users/comex/followers",
      "following_url": "https://api.github.com/users/comex/following{/other_user}",
      "gists_url": "https://api.github.com/users/comex/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/comex/subscriptions",
      "organizations_url": "https://api.github.com/users/comex/orgs",
      "repos_url": "https://api.github.com/users/comex/repos",
      "events_url": "https://api.github.com/users/comex/events{/privacy}",
      "received_events_url": "https://api.github.com/users/comex/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-02T18:51:58Z",
    "updated_at": "2022-01-02T18:52:54Z",
    "body": "@richfelker\r\n\r\n> \"Not thread-safe\" means you are essentially not allowed to use it in a multi-threaded program at all. (There may be some subtle exceptions to that, but it's a good enough approximation.)\r\n\r\nThe problem is that most people don't know about this rule and so their code doesn't follow it, even in otherwise high-quality codebases.  As a test, I hacked up glibc to print a message to syslog whenever `setenv` or `putenv` is called while multiple threads running; I installed this in a Debian VM and started up some random desktop sessions.  Here's what I got:\r\n\r\nhttps://gist.github.com/comex/9fa0899293d1c6e748faa81b875b25ac\r\n\r\nIt's inevitable that Rust code will end up in the same address space as code that does this, whether it's a Rust binary using C libraries or vice versa.  But this leads to the extreme conclusion that portable Rust code cannot safely access the environment *at all*, not even just to read it.  It can't even safely copy the environment at initialization time, not if built into a library that might be `dlopen`ed by C code while threads are already running.\r\n\r\nPerhaps all that code should be fixed.  (After all, some of these instances probably represent dormant race conditions in the C code itself, even without Rust coming into the picture.)  But the above link represents only a small sample of Linux desktop applications, and Linux desktop applications represent a tiny fraction of the environments people run Rust code in.  I suspect that unchecked `setenv` use can be found throughout the entire ecosystem of multithreaded C programs (and [Python programs](https://bugs.python.org/issue39375), and [Ruby programs](https://marc.info/?l=llvm-dev&m=136942524817592&w=2), et cetera).  Fixing it all is impossible.\r\n\r\nThe alternative, changing multiple libcs for multiple operating systems by multiple vendors that don't cooperate on anything these days is\u2026 also a tall order, to be sure.  Even so, it seems like a more viable path.  @zackw, a contributor to glibc, has helped get the ball rolling.  He has a draft proposal for how to make the environment thread-safe without breaking compatibility too badly.  I don't think he has gotten around to revising it and inviting \"feedback from a wider community\" yet, but since this conversation is happening now, I'll link it in case you're interested:\r\n\r\nhttps://internals.rust-lang.org/t/synchronized-ffi-access-to-posix-environment-variable-functions/15475/178\r\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003759020/reactions",
      "total_count": 7,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 6,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003761979",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003761979",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003761979,
    "node_id": "IC_kwDOAAsO6M471DE7",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-02T19:16:10Z",
    "updated_at": "2022-01-02T19:19:32Z",
    "body": ">  But this leads to the extreme conclusion that portable Rust code cannot safely access the environment at all, not even just to read it. It can't even safely copy the environment at initialization time, not if built into a library that might be dlopened by C code while threads are already running.\r\n\r\nThis \"conclusion\" makes no sense at all. Any C code doing this has **extreme** **serious** memory-corruption race-condition bugs, including when used from C, and needs to be fixed. It is not a thread-safe or a library-safe operation and you would not expect to find it in library code. \"Rust becomes unsafe if you `dlopen` C code with extreme memory-safety violations\" is not a surprise or a problem for Rust to try to mitigate. If you `dlopen` C code that does `*(char *)rand() = 42;` you get to keep both pieces, and this is no different.\r\n\r\n> https://gist.github.com/comex/9fa0899293d1c6e748faa81b875b25ac\r\n\r\nHow many of those are multi-threaded programs, and how many of them are doing the `setenv`/`putenv` anywhere other than at startup or after `fork` before exec'ing something? From a quick reading, I would guess the vast majority are not relevant to the topic at hand.\r\n\r\n> The alternative, changing multiple libcs for multiple operating systems...\r\n\r\nNo it is not. The interface contract **fundamentally does not admit any \"fix\"** for this.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003761979/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003783801",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003783801",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003783801,
    "node_id": "IC_kwDOAAsO6M471IZ5",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-02T22:15:19Z",
    "updated_at": "2022-01-02T22:15:19Z",
    "body": "> How many of those are multi-threaded programs, and how many of them are doing the setenv/putenv anywhere other than at startup or after fork before exec'ing something?\r\n\r\nQuoting comex, emphasis mine: \"print a message to syslog whenever setenv or putenv is called **while multiple threads [are] running**\"",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003783801/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003785784",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003785784",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003785784,
    "node_id": "IC_kwDOAAsO6M471I44",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-02T22:32:51Z",
    "updated_at": "2022-01-02T22:32:51Z",
    "body": "OK. From the look of the types of vars, it still appears these are being set to pass to a child process. I wonder if the evaluation of the \"multiple threads\" predicate is wrong after fork. I suppose I should dig in and look at one or more of them. Obvious approach would be just setting breakpoints on `setenv` and `putenv`.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003785784/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003836757",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003836757",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003836757,
    "node_id": "IC_kwDOAAsO6M471VVV",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T02:20:20Z",
    "updated_at": "2022-01-03T02:20:20Z",
    "body": "> No it is not. The interface contract **fundamentally does not admit any \"fix\"** for this.\r\n\r\nIs leaking memory an option?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003836757/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003837131",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003837131",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003837131,
    "node_id": "IC_kwDOAAsO6M471VbL",
    "user": {
      "login": "leo60228",
      "id": 8355305,
      "node_id": "MDQ6VXNlcjgzNTUzMDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8355305?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leo60228",
      "html_url": "https://github.com/leo60228",
      "followers_url": "https://api.github.com/users/leo60228/followers",
      "following_url": "https://api.github.com/users/leo60228/following{/other_user}",
      "gists_url": "https://api.github.com/users/leo60228/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leo60228/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leo60228/subscriptions",
      "organizations_url": "https://api.github.com/users/leo60228/orgs",
      "repos_url": "https://api.github.com/users/leo60228/repos",
      "events_url": "https://api.github.com/users/leo60228/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leo60228/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T02:21:44Z",
    "updated_at": "2022-01-03T02:21:44Z",
    "body": "Even if it works in most cases, an atomic write and non-atomic read is still a data race, right?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003837131/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003837679",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003837679",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003837679,
    "node_id": "IC_kwDOAAsO6M471Vjv",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T02:24:05Z",
    "updated_at": "2022-01-03T02:24:05Z",
    "body": "Yes",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003837679/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003913165",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1003913165",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1003913165,
    "node_id": "IC_kwDOAAsO6M471n_N",
    "user": {
      "login": "comex",
      "id": 47517,
      "node_id": "MDQ6VXNlcjQ3NTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/comex",
      "html_url": "https://github.com/comex",
      "followers_url": "https://api.github.com/users/comex/followers",
      "following_url": "https://api.github.com/users/comex/following{/other_user}",
      "gists_url": "https://api.github.com/users/comex/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/comex/subscriptions",
      "organizations_url": "https://api.github.com/users/comex/orgs",
      "repos_url": "https://api.github.com/users/comex/repos",
      "events_url": "https://api.github.com/users/comex/events{/privacy}",
      "received_events_url": "https://api.github.com/users/comex/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T07:33:52Z",
    "updated_at": "2022-01-03T07:33:52Z",
    "body": "> OK. From the look of the types of vars, it still appears these are being set to pass to a child process. I wonder if the evaluation of the \"multiple threads\" predicate is wrong after fork. I suppose I should dig in and look at one or more of them. Obvious approach would be just setting breakpoints on `setenv` and `putenv`.\r\n\r\nIt does correctly handle fork.  In case anyone wants to reproduce the results, [here is a slightly less ugly version](https://gist.github.com/comex/d80d45e05379e08769df5abe838d5528) of the glibc patch I used.  It can also capture core dumps.\r\n\r\n> No it is not. The interface contract **fundamentally does not admit any \"fix\"** for this.\r\n\r\nIt is unfixable in some cases, namely:\r\n1. Accessing `environ` directly;\r\n2. Calling `putenv` on a buffer, and then modifying the buffer.\r\n\r\nThe draft proposal I mentioned proposes to deprecate these, since they're relatively rare.  For more typical use cases, the interface can be 'fixed' (well, band-aided over) by ensuring that environment variable buffers are never freed.  It also proposes adding new functions to cover use cases that currently require accessing `environ` directly, such as listing variables.\r\n\r\nYes, it's all a big hack.  But I am pretty convinced that the alternatives are worse.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1003913165/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004323522",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004323522",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004323522,
    "node_id": "IC_kwDOAAsO6M473MLC",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:01:44Z",
    "updated_at": "2022-01-03T20:07:05Z",
    "body": "@comex wrote:\r\n> The problem is that most people don't know about this rule and so their code doesn't follow it, even in otherwise high-quality codebases. As a test, I hacked up glibc to print a message to syslog whenever `setenv` or `putenv` is called while multiple threads running; I installed this in a Debian VM and started up some random desktop sessions. Here's what I got:\r\n> \r\n> https://gist.github.com/comex/9fa0899293d1c6e748faa81b875b25ac\r\n\r\nI looked at your list and I noticed that Firefox ESR has several entries. Firefox has a wrapper around libc called NSPR that implements an environment lock (`PR_SetEnv`, `PR_GetEnv`) for reading and writing the environment just like Rust's libstd does. (More on this below.) Thus, just because that multi-threaded program is calling `setenv` doesn't necessarily mean it is doing so unsafely; these may be the \"subtle exceptions\" that @richfelker was referring to. The other applications like StarOffice and Gnome may be doing similar. It is true it is a huge footgun and many applications probably are getting it wrong, but your list isn't conclusive as to whether any of these applications are getting it wrong.\r\n\r\n> It's inevitable that Rust code will end up in the same address space as code that does this, whether it's a Rust binary using C libraries or vice versa. But this leads to the extreme conclusion that portable Rust code cannot safely access the environment _at all_, not even just to read it. It can't even safely copy the environment at initialization time, not if built into a library that might be `dlopen`ed by C code while threads are already running.\r\n\r\nLet's use Firefox as an example. Firefox has, through NSPR, its own safe way to use the environment using locks. Rust has its own. But, they aren't safe to use together unless they agree to use the same lock. I.e. Firefox should be patching libstd to use the NSPR lock or patching NSPR to use the Rust lock, if it wants non-`unsafe` Rust code to be able to safely read and write the environment. The same with StarOffice, etc. This patching is probably not happening, so in general Rust libraries must avoid calling `setenv`/`env::set_var` completely, if they want to be thread-safe and be safe to use in such applications.\r\n\r\nYour list is a list of applications that modify the environment when there are multiple threads. That list is evidence that there are many applications that can't adopt Rust libraries that use `env::set_var` safely. Importantly, it's not a list of libraries that claim to be thread-safe that might be linked into a Rust program, so it's not evidence that there are a lot of such libraries that are a hazard to Rust programs.\r\n\r\n> Perhaps all that code should be fixed. (After all, some of these instances probably represent dormant race conditions in the C code itself, even without Rust coming into the picture.) But the above link represents only a small sample of Linux desktop applications, and Linux desktop applications represent a tiny fraction of the environments people run Rust code in. I suspect that unchecked `setenv` use can be found throughout the entire ecosystem of multithreaded C programs (and [Python programs](https://bugs.python.org/issue39375), and [Ruby programs](https://marc.info/?l=llvm-dev&m=136942524817592&w=2), et cetera). Fixing it all is impossible.\r\n\r\nIndeed, because each standard library (NSPR, Rust libstd, Ruby's, Python's) first attempts to fix the problem by adding their own lock, which works for things in the process that use that standard library, but fail for things in the process that use a different standard library.\r\n\r\n> The alternative, changing multiple libcs for multiple operating systems by multiple vendors that don't cooperate on anything these days is\u2026 also a tall order, to be sure. Even so, it seems like a more viable path. @zackw, a contributor to glibc, has helped get the ball rolling. He has a draft proposal for how to make the environment thread-safe without breaking compatibility too badly. I don't think he has gotten around to revising it and inviting \"feedback from a wider community\" yet, but since this conversation is happening now, I'll link it in case you're interested:\r\n> \r\n> https://internals.rust-lang.org/t/synchronized-ffi-access-to-posix-environment-variable-functions/15475/178\r\n\r\nI think there is value in pursuing something like that. But, those changes are not going into Debian Stable or RHEL 5 or whatever. Or even the latest and greatest musl C, judging by @richfelker's comments here. The process of changing libc's so that we can rely on them implementing a particular change that isn't addressing a security emergency (in their eyes, not ours) has a decade-plus long latency--and that's if that proposal is accepted at all. Rust still needs a solution that can be deployed in the meantime.\r\n\r\nThe proposal I made above and your suggestion here aren't mutually exclusive. Mine can be implemented in the interim and then once we're satisfied that all the libc's have been patched, we could implement yours.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004323522/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004330238",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004330238",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004330238,
    "node_id": "IC_kwDOAAsO6M473Nz-",
    "user": {
      "login": "tarcieri",
      "id": 797,
      "node_id": "MDQ6VXNlcjc5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tarcieri",
      "html_url": "https://github.com/tarcieri",
      "followers_url": "https://api.github.com/users/tarcieri/followers",
      "following_url": "https://api.github.com/users/tarcieri/following{/other_user}",
      "gists_url": "https://api.github.com/users/tarcieri/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tarcieri/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tarcieri/subscriptions",
      "organizations_url": "https://api.github.com/users/tarcieri/orgs",
      "repos_url": "https://api.github.com/users/tarcieri/repos",
      "events_url": "https://api.github.com/users/tarcieri/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tarcieri/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:12:06Z",
    "updated_at": "2022-01-03T20:12:06Z",
    "body": "> What makes sense to me is to:\r\n> \r\n> * Add an `unsafe fn set_var_unchecked(...)` that does exactly what the current set_var does.\r\n> * Clearly document the thread safety hazard in `set_var_unchecked`.\r\n> * Change `set_var` so that it is a wrapper around `set_var_unchecked`.\r\n> * Mark `set_var` as `#[deprecated = \"use set_var_unchecked\"]`.\r\n> * Expand the documentation of `set_var` to explain why it is deprecated.\r\n> * In the next edition, make `set_var` an `unsafe fn`.\r\n\r\nFor what it's worth, according to a straw poll on this thread, an overwhelming majority of people preferred this approach:\r\n\r\nhttps://internals.rust-lang.org/t/synchronized-ffi-access-to-posix-environment-variable-functions/15475/155",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004330238/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004340520",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004340520",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004340520,
    "node_id": "IC_kwDOAAsO6M473QUo",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:29:40Z",
    "updated_at": "2022-01-03T20:37:14Z",
    "body": "The current documentation of `env::set_var` says: \"Note that while concurrent access to environment variables is safe in Rust, some platforms only expose inherently unsafe non-threadsafe APIs for inspecting the environment. As a result, extra care needs to be taken when auditing calls to unsafe external FFI functions to ensure that any external environment accesses are properly synchronized with accesses in Rust.\" This is misleading. Rust code that calls `env::{set_var,get_var}` is unsafe even if it never calls any unsafe functions, if it is in a process (e.g. Firefox) that uses a different mechanism (e.g. a different lock) to protect access to the environment. So, at a minimum we should fix this documentation right away.\r\n\r\nAlso, I'd like to add an additional suggestion to my proposal:\r\n* In the updated documentation for these functions, encourage people to use `Command::{env,envs}` when spawning processes instead of `setenv`/`putenv`/`env::set_var`, whenever practical.\r\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004340520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004341718",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004341718",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004341718,
    "node_id": "IC_kwDOAAsO6M473QnW",
    "user": {
      "login": "thomcc",
      "id": 860665,
      "node_id": "MDQ6VXNlcjg2MDY2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thomcc",
      "html_url": "https://github.com/thomcc",
      "followers_url": "https://api.github.com/users/thomcc/followers",
      "following_url": "https://api.github.com/users/thomcc/following{/other_user}",
      "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions",
      "organizations_url": "https://api.github.com/users/thomcc/orgs",
      "repos_url": "https://api.github.com/users/thomcc/repos",
      "events_url": "https://api.github.com/users/thomcc/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thomcc/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:32:06Z",
    "updated_at": "2022-01-03T20:32:06Z",
    "body": "I think those steps are not particularly uncontroversial (and I'm happy to see the concensus[^1]), the open question is whether or not that's sufficient.\r\n\r\n[^1]: I'm *very* happy to see it being taken seriously, in a way that isn't \"expose libstd's lock\" (which would be a problem for no_std code) and \"forbid calling functions that read from the environment\" (which would be a problem for FFI code). I was pretty worried we'd land on one of those for quite a while...\r\n\r\nConcretely, I voted \"yes\" on that poll, agree that the listed steps are a good idea, but... think it isn't sufficient for several types of existing users to be able to migrate in many cases.\r\n\r\nI worry that without a migration path to a safe function, users will throw up their hands and either `#[allow(deprecated)]` or use `unsafe { set_var_unchecked(...) }`, without being able to guarantee it's sound.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004341718/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004347210",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004347210",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004347210,
    "node_id": "IC_kwDOAAsO6M473R9K",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:43:43Z",
    "updated_at": "2022-01-03T20:44:59Z",
    "body": "> Let's use Firefox as an example. Firefox has, through NSPR, its own safe way to use the environment using locks. Rust has its own. But, they aren't safe to use together unless they agree to use the same lock. I.e. Firefox should be patching libstd to use the NSPR lock or patching NSPR to use the Rust lock, if it wants non-unsafe Rust code to be able to safely read and write the environment. The same with StarOffice, etc. This patching is probably not happening, so in general Rust libraries must avoid calling setenv/env::set_var completely, if they want to be thread-safe and be safe to use in such applications.\r\n\r\nIt's worse than that: Rust libraries used by Firefox must avoid calling `env::get_var` because that could race with a `setenv` from NSPR! Likewise, Firefox must not link with any C library that calls `getenv`, since that call would also fail to be protected by the lock.\r\n\r\nThe NSPR lock is just as bad as the Rust lock when it comes to compositionality with general-purpose C code. Both of them only work if they are used by 100% of the code that reads or mutates the environment. How does Firefox avoid the `getaddrinfo` problem that started this thread? The `getenv` inside `getaddrinfo` or `localtime_r` is just as unsafe in Firefox as it is in a Rust FFI situation.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004347210/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004347779",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004347779",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004347779,
    "node_id": "IC_kwDOAAsO6M473SGD",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:44:47Z",
    "updated_at": "2022-01-03T20:44:47Z",
    "body": "Regarding the specific issue of whether libstd's `getaddrinfo` wrapper should have a lock around the call to the C function, see https://emptysqua.re/blog/mac-python-getaddrinfo-queueing/, where the author notes that lock contention was a serious problem with CPython's implementation of exactly that idea. Rust's env lock would need to become, at minimum, a reader-writer lock so that the `getaddrinfo` calls do not get serialized in a high-performance multithreaded application. Even then, I think most applications that would want to call `getaddrinfo` and which care about performance would accept the overhead of acquiring a read lock.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004347779/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004349488",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004349488",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004349488,
    "node_id": "IC_kwDOAAsO6M473Sgw",
    "user": {
      "login": "tarcieri",
      "id": 797,
      "node_id": "MDQ6VXNlcjc5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tarcieri",
      "html_url": "https://github.com/tarcieri",
      "followers_url": "https://api.github.com/users/tarcieri/followers",
      "following_url": "https://api.github.com/users/tarcieri/following{/other_user}",
      "gists_url": "https://api.github.com/users/tarcieri/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tarcieri/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tarcieri/subscriptions",
      "organizations_url": "https://api.github.com/users/tarcieri/orgs",
      "repos_url": "https://api.github.com/users/tarcieri/repos",
      "events_url": "https://api.github.com/users/tarcieri/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tarcieri/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:48:27Z",
    "updated_at": "2022-01-03T20:48:39Z",
    "body": "> Rust's env lock would need to become, at minimum, a reader-writer lock\r\n\r\nIt already is: \r\n\r\nhttps://github.com/rust-lang/rust/blob/5e93f6e318e687c05c8c44517de4586ed75ce3f4/library/std/src/sys/unix/os.rs#L487",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004349488/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004364985",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004364985",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004364985,
    "node_id": "IC_kwDOAAsO6M473WS5",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:17:16Z",
    "updated_at": "2022-01-03T21:17:16Z",
    "body": "> It's worse than that: Rust libraries used by Firefox must avoid calling `env::get_var` because that could race with a `setenv` from NSPR! Likewise, Firefox must not link with any C library that calls `getenv`, since that call would also fail to be protected by the lock.\r\n\r\nThat's not how Rust's memory unsafety model works, right? The unsafe action is the call to `setenv` in a thread executing concurrently with any other thread that might call `getenv`. Just like any thread could use `unsafe` code to scribble on memory concurrently with a thread running safe Rust code, and cause the safe Rust code to fault.\r\n\r\n> The NSPR lock is just as bad as the Rust lock when it comes to compositionality with general-purpose C code. Both of them only work if they are used by 100% of the code that reads or mutates the environment. How does Firefox avoid the `getaddrinfo` problem that started this thread? The `getenv` inside `getaddrinfo` or `localtime_r` is just as unsafe in Firefox as it is in a Rust FFI situation.\r\n\r\nGenerally environment variables aren't to be used in Firefox because it has a different configuration mechanism. Also, Firefox has many bugs, and I did see some that are still open related to memory safety and the environment.\r\n\r\nOn non-Windows targets Firefox does appear to use NSPR `PR_GetAddrInfoByName`, and `PR_GetAddrInfoByName` does seem to have a lock around `getaddrinfo` in some circumstances. I'm not sure whether it uses the lock on Linux since it seems to be an autoconf-type mess. Also, Firefox's acceptable performance characteristics aren't necessarily every applications' acceptable performance characteristics.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004364985/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004368906",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004368906",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004368906,
    "node_id": "IC_kwDOAAsO6M473XQK",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:24:05Z",
    "updated_at": "2022-01-03T21:25:31Z",
    "body": "> On non-Windows targets Firefox does appear to use NSPR `PR_GetAddrInfoByName`, and `PR_GetAddrInfoByName` does seem to have a lock around `getaddrinfo` in some circumstances. I'm not sure whether it uses the lock on Linux since it seems to be an autoconf-type mess. Also, Firefox's acceptable performance characteristics aren't necessarily every applications' acceptable performance characteristics.\r\n\r\nOh, that lock in `PR_GetAddrInfoByName` is separate from the NSPR environment lock, and is to guard against non-reentrant getaddrinfo. So, Firefox may indeed have a memory safety bug here, if `getaddrinfo` reads from the environment around the time a `PR_SetEnv`/etc. is called in another thread.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004368906/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004369720",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004369720",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004369720,
    "node_id": "IC_kwDOAAsO6M473Xc4",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:25:33Z",
    "updated_at": "2022-01-03T21:31:37Z",
    "body": "> That's not how Rust's memory unsafety model works, right? The unsafe action is the call to setenv in a thread executing concurrently with any other thread that might call getenv. Just like any thread could use unsafe code to scribble on memory concurrently with a thread running safe Rust code, and cause the safe Rust code to fault.\r\n\r\nI am not quite sure what you mean by \"Rust's memory unsafety model\", but if a Rust function uses `get_var` and, concurrently, another thread uses the NSPR-protected `setenv`, then we have a data race and hence UB. This is the exact same problem that makes a call to `getaddrinfo` UB when there is a concurrent Rust call to `set_var`: we end up calling `setenv` and `getenv` concurrently without (proper) synchronization, which POSIX says is UB and which can lead to data races in the actual implementations.\r\n\r\nWhether the bug here is in the Rust code that called `get_var`, or the NSPR function that called `setenv` while holding an ineffective lock -- that is a matter of discussion. But unambiguously there is a bug here.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004369720/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004372045",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004372045",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004372045,
    "node_id": "IC_kwDOAAsO6M473YBN",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:29:45Z",
    "updated_at": "2022-01-03T21:29:45Z",
    "body": "As @richfelker keeps saying: under current POSIX, the only correct thing to do in a concurrent program is to never call `setenv` once the first thread spawns. Adding a lock to protect environment accesses is *not* a viable alternative unless you can guarantee that the same lock protects *all* environment accesses. We are having this discussion because the Rust lock can not actually make this guarantee. I don't think Firefox's NSPR lock can make the guarantee, either -- unless Firefox patches every single library it links with (be it written in C, Rust, or whatever) to ensure all environment accesses use the NSPR lock.\r\n\r\nHaving a lock clearly doesn't work for Rust, that's why we are here. Why would you think that it works any better for Firefox/NSPR?",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004372045/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004373116",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004373116",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004373116,
    "node_id": "IC_kwDOAAsO6M473YR8",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:31:42Z",
    "updated_at": "2022-01-03T21:31:42Z",
    "body": "> I am not quite sure what you mean by \"Rust's memory unsafety model\", but if a Rust function uses `get_var` and, concurrently, another thread uses the NSPR-protected `setenv`, then we have a data race and hence UB.\r\n\r\n`setenv` is an unsafe function, and is breaking invariants that Rust doesn't enforce. This is equivalent to `*(char *)rand() = 42` that @richfelker noted above.\r\n\r\n>  This is the exact same problem that makes a call to `getaddrinfo` UB when there is a concurrent Rust call to `set_var`: we end up calling `setenv` and `getenv` concurrently without (proper) synchronization, which POSIX says is UB and which can lead to data races in the actual implementations.\r\n\r\nThat's because `env::set_var` is an unsafe function and should be deprecated and eventually made `unsafe`.\r\n\r\n> Having a lock clearly doesn't work for Rust, that's why we are here. Why would you think that it works any better for Firefox/NSPR?\r\n\r\nI hope nothing I've written above makes it seem like I'm advocating for adding a lock or using the lock more. My proposal is in https://github.com/rust-lang/rust/issues/27970#issuecomment-1003218748.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004373116/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004374047",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004374047",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004374047,
    "node_id": "IC_kwDOAAsO6M473Ygf",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:33:18Z",
    "updated_at": "2022-01-03T21:41:35Z",
    "body": "> I hope nothing I've written above makes it seem like I'm advocating for adding a lock or using the lock more.\r\n\r\n@briansmith you wrote\r\n> Thus, just because that multi-threaded program is calling setenv doesn't necessarily mean it is doing so unsafely; these may be the \"subtle exceptions\" that @richfelker was referring to.\r\n\r\nI hope the subsequent discussion established that Firefox's lock is *not* one of these \"subtle exceptions\". It is just as broken as Rust's lock the moment any non-NSRP code exists in the process (and there is plenty of such code, if only in the Rust libraries that Firefox links with).\r\n\r\nSo, we are back to @comex' point that the current POSIX API is broken in the sense that it does not fit the need of the ecosystem -- the ecosystem needs a thread-safe way to access *and mutate* the environment, and the fact that POSIX does not provide this leads to a lot of software that is, at least in principle, broken. At the same time there is no way to fix this issue anywhere other than in libc, since there is no other way to ensure that all libraries linked into a process use the same lock.\r\n\r\nRust should do what it can to mitigate this on its side (including making `set_var` unsafe), but at the same time I see clear evidence that POSIX needs to be fixed to serve the need of the software out there. Replying with \"wontfix\" just results in broken software, as we can see. Other OSes are clearly doing better here (Windows does not have these problems), it's time for Linux/POSIX to catch up.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004374047/reactions",
      "total_count": 6,
      "+1": 6,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004375203",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004375203",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004375203,
    "node_id": "IC_kwDOAAsO6M473Yyj",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:35:23Z",
    "updated_at": "2022-01-03T22:32:57Z",
    "body": "> unless Firefox patches every single library it links with (be it written in C, Rust, or whatever) to ensure all environment accesses use the NSPR lock.\r\n\r\nFWIW, this is indeed what Firefox developers are expected to do. 1. Remove as many uses of the environment as possible. 2. Change any that can't be removed to use `PR_SetEnv`/`PR_GetEnv`. Note that it seems the Firefox developers overlooked the fact that `getaddrinfo` may access the environment; perhaps they were relying on it conforming to POSIX. If I were still working on Firefox I would add to the backlog the task of removing all the `PR_SetEnv` calls. Note that Firefox has years-old issues where unsafe uses of the environment are documented.\r\n\r\n[Edit: I filed https://bugzilla.mozilla.org/show_bug.cgi?id=1748361 against Firefox's NSPR library regarding this.]",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004375203/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004379661",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004379661",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004379661,
    "node_id": "IC_kwDOAAsO6M473Z4N",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:44:12Z",
    "updated_at": "2022-01-03T21:44:12Z",
    "body": "> So, we are back to @comex' point that the current POSIX API is broken in the sense that it does not fit the need of the ecosystem\r\n\r\nI agree.\r\n\r\n> -- the ecosystem needs a thread-safe way to access _and mutate_ the environment\r\n\r\nA very small part of the ecosystem needs that.\r\n\r\n> At the same time there is no way to fix this issue anywhere other than in libc, since there is no other way to ensure that all libraries linked into a process use the same lock.\r\n\r\nThere are multiple issues:\r\n1. Currently, `env::set_var` is an unsafe function, but it isn't marked `unsafe`. This is a serious bug that should be fixed immediately. I provided a proposal for this above.\r\n2. `getaddrinfo` on Linux (in glibc at least) accesses the environment even though it isn't supposed to, which is problematic if anything concurrently modifies the environment. What should we do about it? I propose that we don't try to paper over it, and just make sure all the APIs we provide for modifying the environment are marked `unsafe`, and document the hazards clearly.\r\n3. It would be nice to have a non-`unsafe` version of `env::set_var` that is actually safe to use. In general, this seems to require cooperation from libc, as you and @comex note. This would be a decades-long process and it isn't very urgent for us to deal with, IMO.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004379661/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004394793",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004394793",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004394793,
    "node_id": "IC_kwDOAAsO6M473dkp",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T22:15:35Z",
    "updated_at": "2022-01-03T22:15:35Z",
    "body": "> There are multiple issues:\r\n\r\nI agree on all 3 of these, including your approach for (1) -- except I am not sure if changing `unsafe`ty of a function at an edition boundary is possible (and if it is, there are some other candidates, such as `Command::before_exec`), but that is mostly independent of the rest of the plan.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004394793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004396441",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004396441",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004396441,
    "node_id": "IC_kwDOAAsO6M473d-Z",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T22:18:43Z",
    "updated_at": "2022-01-03T22:22:13Z",
    "body": "Besides the three issues I noted above, there is a fourth issue: `getenv` is also not thread-safe:\r\n\r\n@richfelker wrote:\r\n> And future issues of POSIX [will require](https://www.austingroupbugs.net/view.php?id=188#c325) it to be.\r\n\r\nThis is the change in that doc:\r\n\r\n> At line 33878 change:\r\n> \r\n>     The getenv() function is inherently not thread-safe because it\r\n>     returns a value pointing to static data.\r\n> \r\n> to:\r\n> \r\n>     Some earlier versions of this standard did not require getenv()\r\n>     to be thread-safe because it was allowed to return a value\r\n>     pointing to an internal buffer. However, this behaviour allowed\r\n>     by the C Standard is no longer allowed by POSIX.1. POSIX.1\r\n>     requires the environment data to be available through environ[],\r\n>     so there is no reason why getenv() can't return a pointer to the\r\n>     actual data instead of a copy. Therefore getenv() is now required\r\n>     to be thread-safe (except when another thread modifies the\r\n>     environment).\r\n\r\nWe could either keep using `getenv` on the assumption that it is thread-safe even though current and older POSIX says it isn't thread-safe, or we could just change `std::env` to use `environ` directly with pure Rust code and avoid `getenv()` completely; i.e. RiiR. I prefer to RiiR, though I think it should be a lower priority.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004396441/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004404334",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004404334",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004404334,
    "node_id": "IC_kwDOAAsO6M473f5u",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T22:35:41Z",
    "updated_at": "2022-01-03T22:35:41Z",
    "body": "@briansmith wrote:\r\n\r\n> Thus, just because that multi-threaded program is calling `setenv` doesn't necessarily mean it is doing so unsafely; these may be the \"subtle exceptions\" that @richfelker was referring to.\r\n\r\nIt does mean it's doing so unsafely. The only \"subtle exception\" is that the unsafety is defined as making the call concurrently with any other standard function, so a program where the only other thread(s) do not call library functions at all, only do raw computation and communication of results via raw atomics without invoking synchronization primitives, could in theory be well-defined while calling thread-unsafe functions fron a single thread. In reality, such programs don't exist, and they're not relevant to the topic at hand. For all practical purposes, if your program is multithreaded at the time of a call to `setenv`, it has UB.\r\n\r\nIn particular, putting locks around a call to a non-thread-safe function (and whatever other functions you expect \"might access the same internal state it does\") does not make the function thread-safe. If it's non-thread-safe, you just can't use it.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004404334/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004408287",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004408287",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004408287,
    "node_id": "IC_kwDOAAsO6M473g3f",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T22:46:52Z",
    "updated_at": "2022-01-03T22:46:52Z",
    "body": "This isn't a response to any one comment, but I'd like to address a general theme I've seen that the environment could somehow be \"made thread-safe for modification\", either with a different API (more powerful than `getenv` that gives the caller a way to express the lifetime of its reference to the string) or by leaking memory (note: this would be bad for legacy single-threaded apps that repeatedly change `TZ` or similar, which are actually a thing). This is at best pointless, because what you're asking for is making it \"safe\" to change string-valued global variables out from under code using them. Even if you could change the value of a variable safely in a way that doesn't involve machine-level data races, there's still a race between setting the value and using the value where another thread could set it to something different. It's possible that some or even most of these *happen to be avoided* by virtue of threads having different roles where they don't set or use the same environment variables as each other, but it's a fundamentally unsafe programming model, and we've known it's unsafe for something like half a century.\r\n\r\nThe only legitimate role the environment has in a safe programming model is as immutable input context at program invocation, where it acts similar to `argv[]` but implicitly inherited-unless-modified rather than specific to a particular program invocation. And for this it has always worked very well.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004408287/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004414347",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004414347",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004414347,
    "node_id": "IC_kwDOAAsO6M473iWL",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T23:03:42Z",
    "updated_at": "2022-01-03T23:03:42Z",
    "body": "To add onto what @richfelker said, there's no way to implement a thread-safe `env::set_var` that modifies the environment returned by `getenv`, because `getenv` must use the environment in `environ[]` and because `environ` is a global variable and not a function, there's no way to add a lock to it transparently.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004414347/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004419196",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004419196",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004419196,
    "node_id": "IC_kwDOAAsO6M473jh8",
    "user": {
      "login": "tarcieri",
      "id": 797,
      "node_id": "MDQ6VXNlcjc5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tarcieri",
      "html_url": "https://github.com/tarcieri",
      "followers_url": "https://api.github.com/users/tarcieri/followers",
      "following_url": "https://api.github.com/users/tarcieri/following{/other_user}",
      "gists_url": "https://api.github.com/users/tarcieri/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tarcieri/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tarcieri/subscriptions",
      "organizations_url": "https://api.github.com/users/tarcieri/orgs",
      "repos_url": "https://api.github.com/users/tarcieri/repos",
      "events_url": "https://api.github.com/users/tarcieri/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tarcieri/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-03T23:13:57Z",
    "updated_at": "2022-01-03T23:15:52Z",
    "body": "> The only legitimate role the environment has in a safe programming model is as immutable input context at program invocation, where it acts similar to argv[] but implicitly inherited-unless-modified rather than specific to a particular program invocation. And for this it has always worked very well.\r\n\r\n@richfelker as long as we're spitballing about hypothetical new libc features, how about a feature that opts-in to actually enforcing this, i.e. a way to `freezeenv` the environment within a particular process such that calls to `setenv`/`unsetenv` return an error at the libc level?\r\n\r\nIf that were possible, it seems like the safety errors around `getenv` would just go away without the need for synchronization (besides a process-wide \"is environment frozen?\" atomic flag).\r\n\r\nOf course, instead the `setenv`/`unsetenv` callers would have to deal with a runtime error, but based on the above conversation it sounds like there's no truly sound solution to fix these safety issues without ensuring that the callers simply don't use these functions inside of programs where multiple threads access the environment.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004419196/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004463946",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004463946",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004463946,
    "node_id": "IC_kwDOAAsO6M473udK",
    "user": {
      "login": "saethlin",
      "id": 12105168,
      "node_id": "MDQ6VXNlcjEyMTA1MTY4",
      "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/saethlin",
      "html_url": "https://github.com/saethlin",
      "followers_url": "https://api.github.com/users/saethlin/followers",
      "following_url": "https://api.github.com/users/saethlin/following{/other_user}",
      "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions",
      "organizations_url": "https://api.github.com/users/saethlin/orgs",
      "repos_url": "https://api.github.com/users/saethlin/repos",
      "events_url": "https://api.github.com/users/saethlin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/saethlin/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T01:24:45Z",
    "updated_at": "2022-01-04T01:25:00Z",
    "body": "> I worry that without a migration path to a safe function, users will throw up their hands and either `#[allow(deprecated)]`\r\n\r\nI don't want to harp on this well-known situation too much: `itoa` used `mem::uninitialized` for 2 years after it was deprecated for being essentially impossible to call, and for sure the way `itoa` used it was UB. Migration might be slower than we would hope. Even if we have a safe migration path.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004463946/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004479195",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004479195",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004479195,
    "node_id": "IC_kwDOAAsO6M473yLb",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T02:15:55Z",
    "updated_at": "2022-01-04T02:15:55Z",
    "body": "> @richfelker as long as we're spitballing about hypothetical new libc features, how about a feature that opts-in to actually enforcing this, i.e. a way to `freezeenv` the environment within a particular process such that calls to `setenv`/`unsetenv` return an error at the libc level?\r\n\r\nThis is an interesting idea. At first I thought you meant a lock against changing except by the lock holding thread, that could be unlocked, rather than a permanent freeze. This would kinda make some of the above abuse work, but I think the lock would have to be held so long as to make things start to break. Your idea seems better. However...\r\n\r\n> If that were possible, it seems like the safety errors around `getenv` would just go away without the need for synchronization (besides a process-wide \"is environment frozen?\" atomic flag).\r\n> \r\n> Of course, instead the `setenv`/`unsetenv` callers would have to deal with a runtime error, but based on the above conversation it sounds like there's no truly sound solution to fix these safety issues without ensuring that the callers simply don't use these functions inside of programs where multiple threads access the environment.\r\n\r\nHaving `unsetenv` be able to fail is probably a serious security problem in itself. I mean, as specified it's allowed to, but there's no reason for it ever to fail if the argument is valid, and I'm sure lots of programmers don't check the return value.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004479195/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004519988",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004519988",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004519988,
    "node_id": "IC_kwDOAAsO6M4738I0",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T04:23:34Z",
    "updated_at": "2022-01-04T04:23:34Z",
    "body": "> If it's non-thread-safe, you just can't use it.\r\n\r\nI wonder if libc should expose an `is_single_threaded` function.  If this returns true, mutating the environment is safe.  The main use for this would be in assertions, such as:\r\n\r\n```c\r\nint main(int argc, char *argv[]) {\r\n    some_struct *s = some_initialization_that_might_use_threads();\r\n    if (!is_single_threaded()) {\r\n        fputs(\"BUG: some_initialization_that_might_use_threads didn\u2019t stop the threads it created!\\n\");\r\n        abort();\r\n    }\r\n    modify_environment(s);\r\n    rest_of_program();\r\n}\r\n```\r\n\r\n> The only legitimate role the environment has in a safe programming model is as immutable input context at program invocation, where it acts similar to `argv[]` but implicitly inherited-unless-modified rather than specific to a particular program invocation. And for this it has always worked very well.\r\n\r\nThis also means that any library that accepts configuration via the environment, without allowing this configuration to be overridden in a thread-safe way, is significantly lacking, if not outright buggy.  If one must use such libraries, the only option available is to call `setenv`, `putenv`, or `unsetenv` early in `main`, while the program is single-threaded.\r\n\r\nIt is also worth noting that one cannot modify the environment in a child process after `fork()`, if the parent process is multi-threaded.  POSIX only allows async-signal-safe interfaces to be used there, which `*env` are not.  So the only safe approach I am aware of is to allocate an entirely new environment block in the parent process and use `execve`.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004519988/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004603999",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004603999",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004603999,
    "node_id": "IC_kwDOAAsO6M474Qpf",
    "user": {
      "login": "comex",
      "id": 47517,
      "node_id": "MDQ6VXNlcjQ3NTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/comex",
      "html_url": "https://github.com/comex",
      "followers_url": "https://api.github.com/users/comex/followers",
      "following_url": "https://api.github.com/users/comex/following{/other_user}",
      "gists_url": "https://api.github.com/users/comex/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/comex/subscriptions",
      "organizations_url": "https://api.github.com/users/comex/orgs",
      "repos_url": "https://api.github.com/users/comex/repos",
      "events_url": "https://api.github.com/users/comex/events{/privacy}",
      "received_events_url": "https://api.github.com/users/comex/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T08:14:52Z",
    "updated_at": "2022-01-04T08:14:52Z",
    "body": "> This is at best pointless, because what you're asking for is making it \"safe\" to change string-valued global variables out from under code using them. Even if you could change the value of a variable safely in a way that doesn't involve machine-level data races, there's still a race between setting the value and using the value where another thread could set it to something different. It's possible that some or even most of these _happen to be avoided_ by virtue of threads having different roles where they don't set or use the same environment variables as each other, but it's a fundamentally unsafe programming model, and we've known it's unsafe for something like half a century.\r\n\r\nArguably this is an example of a difference between C and Rust philosophy.  You're treating memory safety as a special case of correctness, reasoning that there is no point making it memory-safe if it can't be correct.  From my perspective, an API that encourages logical race conditions is like a house that's not built to code, while a memory-unsafe API is like a house that's \\*\\*on fire\\*\\*.\r\n\r\nTo be fair, I was suggesting changes in lib\\*c\\*.  And if Rust needs a temporary workaround anyway, given that all changes to OS components take a long time to become ubiquitous, then perhaps there is no use in seeking a fix at an intermediate level between 'temporary workaround to put out the fire' (whatever that may be) and 'long-term solution' (moving away from the environment entirely).\r\n\r\nIt almost seems like the best workaround would be a tiny library to provide a thread-safe shadow environment, which could hypothetically be shared by all the codebases that currently put locks around setenv, ranging from Rust's libstd to Mozilla's codebase to Python, etc.  That way, at least those codebases would be safe to use together.  Unfortunately, various features of the ecosystem make adding a dependency far more costly than just the size of the code itself, so such an approach is probably not realistic.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004603999/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004663606",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004663606",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004663606,
    "node_id": "IC_kwDOAAsO6M474fM2",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T09:49:35Z",
    "updated_at": "2022-01-04T19:30:33Z",
    "body": "> In particular, putting locks around a call to a non-thread-safe function (and whatever other functions you expect \"might access the same internal state it does\") does not make the function thread-safe. If it's non-thread-safe, you just can't use it.\r\n\r\n~~POSIX~~ explicitly allows calling `MT-Unsafe const:X` functions if suitable locking is in place on *all* concurrent calls that are marked with `MT-(Un)Safe X`. So putting locks around these *can* make them thread safe, the difficulty is in ensuring that the locks are put *everywhere*. That can only be done in a \"closed world\" situation where one has full control over all code linked into the process.\r\n\r\n(EDIT: turns out just glibc makes that guarantee, not POSIX.)\r\n\r\n> Even if you could change the value of a variable safely in a way that doesn't involve machine-level data races, there's still a race between setting the value and using the value where another thread could set it to something different. It's possible that some or even most of these happen to be avoided by virtue of threads having different roles where they don't set or use the same environment variables as each other, but it's a fundamentally unsafe programming model, and we've known it's unsafe for something like half a century.\r\n\r\nIt's not a great programming model for sure, but it is not \"unsafe\" in the same sense that triggering UB is unsafe. (It is not `unsafe` in the Rust sense, in particular.) And it can be perfectly fine when different variables are used in different threads. Unfortunately POSIX acts as a bug amplifier where such code that might have a logic bug or might even be fine is then viewed as having full UB. That's a footgun if I've ever seen one.\r\n\r\n> The only legitimate role the environment has in a safe programming model is as immutable input context at program invocation, where it acts similar to argv[] but implicitly inherited-unless-modified rather than specific to a particular program invocation. And for this it has always worked very well.\r\n\r\nThen please remove `setenv`, `putenv`, and `unsetenv` entirely. But as long as those functions exist, the reality of this API contradicts your statement. POSIX clearly intends the environment to be mutable. Or rather, it lures programmers by pretending that the environment can be mutated, only to hit them with a club if they try to actually mutate it. This is the API design equivalent of an ambush.\r\n\r\nOkay, maybe I got carried away a bit here. ;) But I really think it is unfair to blame programmers here.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004663606/reactions",
      "total_count": 10,
      "+1": 5,
      "-1": 0,
      "laugh": 5,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004997015",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1004997015",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1004997015,
    "node_id": "IC_kwDOAAsO6M475wmX",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T16:56:09Z",
    "updated_at": "2022-01-04T17:07:08Z",
    "body": "> It almost seems like the best workaround would be a tiny library to provide a thread-safe shadow environment, which could hypothetically be shared by all the codebases that currently put locks around setenv, ranging from Rust's libstd to Mozilla's codebase to Python, etc. That way, at least those codebases would be safe to use together. Unfortunately, various features of the ecosystem make adding a dependency far more costly than just the size of the code itself, so such an approach is probably not realistic.\r\n\r\nYou could imagine defining an API like this, or a better API:\r\n```\r\nvoid shared_env_read_lock() __attribute__((weak));\r\nvoid shared_env_read_unlock() __attribute__((weak));\r\nvoid shared_env_write_lock() __attribute__((weak));\r\nvoid shared_env_write_unlock() __attribute__((weak));\r\n```\r\nEach standard library (Ruby, NSPR, Rust libstd, etc.) would provide an implementation of that API and it wouldn't matter which implementation the linker chose as long as it chose the same implementation for all 4 functions. Even libc could opt into doing it. This works poorly for `getaddrinfo` and any other function that does I/O, which is back to the original problem here. For `getaddrinfo`, i wouldn't feel great about holding even a read lock over I/O, though I could maybe be convinced that it is harmless enough considering nobody is supposed to be calling any of the functions that would acquire the write lock anyway.\r\n\r\nBefore that though, I'd like to try harder to eradicate uses of `env::set_var`  and `env::remove_var` in the Rust ecosystem, since I think many library authors have likely overlooked the case where they are being used in a process that isn't pure Rust and where the non-Rust code is using a different lock to protect the environment or not using a lock at all. I think the process of trying to eradicate `set_var`/`remove_var` will teach us what primitives we'd need to add. In particular, I suspect we'll get to the point where the next step is to expand the testing harness to allow safely running a test with environment variables set to particular values.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1004997015/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005006394",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005006394",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005006394,
    "node_id": "IC_kwDOAAsO6M475y46",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T17:05:46Z",
    "updated_at": "2022-01-04T17:07:52Z",
    "body": "A long time ago @thomcc wrote:\r\n> but probably the solution is probably not to report a CVE against nearly every rust library that does FFI.\r\n\r\nI think it doesn't make sense to file bugs on projects that are just reading the environment. However, I do recommend filing issues against crates that are modifying the environment by calling `env::set_ver` or `env::remove_var` and making PRs to help them find an alternate solution (hopefully `Command::{env,envs}`). I would suggest prioritizing non-test instances over test instances. I also suggest prioritizing fixing instances in libraries first, and then instances in multi-threaded programs.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005006394/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005026280",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005026280",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005026280,
    "node_id": "IC_kwDOAAsO6M4753vo",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T17:31:46Z",
    "updated_at": "2022-01-04T17:31:46Z",
    "body": "@DemiMarie wrote:\r\n\r\n> This also means that any library that accepts configuration via the environment, without allowing this configuration to be overridden in a thread-safe way, is significantly lacking, if not outright buggy.\r\n\r\nYes, absolutely.\r\n\r\n> It is also worth noting that one cannot modify the environment in a child process after `fork()`, if the parent process is multi-threaded. POSIX only allows async-signal-safe interfaces to be used there, which `*env` are not. So the only safe approach I am aware of is to allocate an entirely new environment block in the parent process and use `execve`.\r\n\r\nIf you need to modify the environment in the child without exec'ing, you can modify `environ` directly. However there are very few if any (likely no) applications for this since the functions which would consume it are almost surely AS-unsafe. Note however that relaxation of the rule about what you can do after MT `fork` is a common extension implementations offer, albeit inconsistently. (For example glibc goes to the trouble of making sure `malloc` works here, but doesn't explicitly try to make anything else work, and what does vs doesn't work is undocumented but widely relied upon, including in some language runtimes like Ruby where the unwritten contract spilled into the language's contract for programs written in the language...)\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005026280/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005033339",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005033339",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005033339,
    "node_id": "IC_kwDOAAsO6M4755d7",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T17:41:44Z",
    "updated_at": "2022-01-04T17:46:37Z",
    "body": "@RalfJung wrote:\r\n\r\n> POSIX explicitly allows calling `MT-Unsafe const:X` functions if suitable locking is in place on _all_ concurrent calls that are marked with `MT-(Un)Safe X`. So putting locks around these _can_ make them thread safe, the difficulty is in ensuring that the locks are put _everywhere_. That can only be done in a \"closed world\" situation where one has full control over all code linked into the process.\r\n\r\nThis is not the case. `MT-Unsafe const:X` is a glibc invention that does not match the POSIX definition of thread-safety at all, and that's the source of a lot of this confusion. These glibc annotations were invented to describe the implementation properties of glibc and make what was previously a de facto contract with glibc into a documented one.\r\n\r\nThe [POSIX definition of thread-safe](https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap03.html#tag_03_407) is:\r\n\r\n> A thread-safe function can be safely invoked concurrently with other calls to the same function, or with calls to any other thread-safe functions, by multiple threads. Each function defined in the System Interfaces volume of POSIX.1-2017 is thread-safe unless explicitly stated otherwise. Examples are any \"pure\" function, a function which holds a mutex locked while it is accessing static storage, or objects shared among threads.\r\n\r\nThread-unsafe is not separately defined, but in the absence of anything more specific, the only reasonable interpretation is that functions which are not thread-safe are not required to have these properties. In particular you cannot assume thread-unsafe functions \"can be safely invoked concurrently... with calls to any other thread-safe functions\".\r\n\r\nThere is no mention of different classes/categories \"X\" of thread-unsafety.\r\n\r\nThread-safety specifically in regards to the environment is also touched on in [2.9.1](https://pubs.opengroup.org/onlinepubs/9699919799/functions/V2_chap02.html#tag_15_09_01):\r\n\r\n> Since multi-threaded applications are not allowed to use the environ variable to access or modify any environment variable while any other thread is concurrently modifying any environment variable, any function dependent on any environment variable is not thread-safe if another thread is modifying the environment; see XSH exec.\r\n\r\nThis text is redundant with the thread-unsafety of `setenv`, but also covers the case where `environ` is modified directly.\r\n\r\n> Then please remove `setenv`, `putenv`, and `unsetenv` entirely.\r\n\r\nI mostly wouldn't be opposed to that, but that isn't how standards that document & establish consensus on existing practice work. I would strongly support removing the Rust `set_env` operation entirely without adding a replacement for it, though. Perhaps making it so that you can't mutate the environment from Rust without FFI would help to satisfy the Rust purists on this issue?\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005033339/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005057469",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005057469",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005057469,
    "node_id": "IC_kwDOAAsO6M475_W9",
    "user": {
      "login": "nico-abram",
      "id": 24706838,
      "node_id": "MDQ6VXNlcjI0NzA2ODM4",
      "avatar_url": "https://avatars.githubusercontent.com/u/24706838?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nico-abram",
      "html_url": "https://github.com/nico-abram",
      "followers_url": "https://api.github.com/users/nico-abram/followers",
      "following_url": "https://api.github.com/users/nico-abram/following{/other_user}",
      "gists_url": "https://api.github.com/users/nico-abram/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nico-abram/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nico-abram/subscriptions",
      "organizations_url": "https://api.github.com/users/nico-abram/orgs",
      "repos_url": "https://api.github.com/users/nico-abram/repos",
      "events_url": "https://api.github.com/users/nico-abram/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nico-abram/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T18:15:39Z",
    "updated_at": "2022-01-04T18:15:39Z",
    "body": "If `std::env::set_var` is deprecated and/or made unsafe, should something like a safe `std::os::windows::env::set_var` be added to provide a migration path to users of non POSIX platforms?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005057469/reactions",
      "total_count": 5,
      "+1": 5,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005075383",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005075383",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005075383,
    "node_id": "IC_kwDOAAsO6M476Du3",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T18:41:04Z",
    "updated_at": "2022-01-04T18:41:04Z",
    "body": "From the glibc official documentation (https://www.gnu.org/software/libc/manual/html_node/Environment-Access.html#Environment-Access):\r\n> Libraries should use secure_getenv instead of getenv, so that they do not accidentally use untrusted environment variables. \r\n\r\nI just filed https://github.com/rust-lang/rust/issues/92558 about that.\r\n\r\n> Modifications of environment variables are not allowed in multi-threaded programs. The getenv and secure_getenv functions can be safely used in multi-threaded programs.\r\n\r\n@richfelker Where can we find the similar documentation for musl? Specifically, I'm looking for documentation that says `getenv` is thread safe in the same way that glibc says it is.\r\n\r\n@nico-abram wrote:\r\n> If std::env::set_var is deprecated and/or made unsafe, should something like a safe std::os::windows::env::set_var be added to provide a migration path to users of non POSIX platforms?\r\n\r\nThat sounds reasonable to me, though I think it could be done as an independent follow-up.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005075383/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005085598",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005085598",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005085598,
    "node_id": "IC_kwDOAAsO6M476GOe",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T18:56:26Z",
    "updated_at": "2022-01-04T18:56:26Z",
    "body": "@briansmith wrote:\r\n\r\n> > Libraries should use secure_getenv instead of getenv, so that they do not accidentally use untrusted environment variables.\r\n> \r\n> I just filed #92558 about that.\r\n\r\nThis is an oversimplification and really depends on what they're doing with the variables.\r\n\r\n\r\n> > Modifications of environment variables are not allowed in multi-threaded programs. The getenv and secure_getenv functions can be safely used in multi-threaded programs.\r\n> \r\n> @richfelker Where can we find the similar documentation for musl? Specifically, I'm looking for documentation that says `getenv` is thread safe in the same way that glibc says it is.\r\n\r\nPresently there is no such documentation. Having documentation for guarantees beyond the ones the standard makes is an open todo item. For this specific case, however, the POSIX-next requirement serves as the documentation.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005085598/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005087097",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005087097",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005087097,
    "node_id": "IC_kwDOAAsO6M476Gl5",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T18:58:01Z",
    "updated_at": "2022-01-04T18:58:01Z",
    "body": "Sorry about all the discussion about deprecating `env::{set_var,remove_var}` above. I didn't realize there was a separate issue about it: #90308. I'll direct all my future comments about the deprecation there.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005087097/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005109434",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005109434",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005109434,
    "node_id": "IC_kwDOAAsO6M476MC6",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T19:29:42Z",
    "updated_at": "2022-01-04T19:29:42Z",
    "body": "> This is not the case. MT-Unsafe const:X is a glibc invention that does not match the POSIX definition of thread-safety at all, and that's the source of a lot of this confusion. These glibc annotations were invented to describe the implementation properties of glibc and make what was previously a de facto contract with glibc into a documented one.\r\n\r\nI stand corrected, sorry for that -- I did not realize that this was all glibc-specific.\r\n\r\n> I mostly wouldn't be opposed to that, but that isn't how standards that document & establish consensus on existing practice work.\r\n\r\nExisting practice clearly involves calling `setenv` in multi-threaded programs, so it does not seem to me like POSIX is interested in accounting for existing practice.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005109434/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 3,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005116576",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005116576",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005116576,
    "node_id": "IC_kwDOAAsO6M476Nyg",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-04T19:40:57Z",
    "updated_at": "2022-01-04T19:40:57Z",
    "body": "@RalfJung wrote:\r\n\r\n> Existing practice clearly involves calling `setenv` in multi-threaded programs, so it does not seem to me like POSIX is interested in accounting for existing practice.\r\n\r\nHere existing practice means what existing implementations support as well as what existing applications are using from that set. Bugs in existing applications that are going unnoticed or willfully unfixed aren't part of said \"existing practice\".\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005116576/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005405050",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005405050",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005405050,
    "node_id": "IC_kwDOAAsO6M477UN6",
    "user": {
      "login": "comex",
      "id": 47517,
      "node_id": "MDQ6VXNlcjQ3NTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/comex",
      "html_url": "https://github.com/comex",
      "followers_url": "https://api.github.com/users/comex/followers",
      "following_url": "https://api.github.com/users/comex/following{/other_user}",
      "gists_url": "https://api.github.com/users/comex/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/comex/subscriptions",
      "organizations_url": "https://api.github.com/users/comex/orgs",
      "repos_url": "https://api.github.com/users/comex/repos",
      "events_url": "https://api.github.com/users/comex/events{/privacy}",
      "received_events_url": "https://api.github.com/users/comex/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-05T06:00:13Z",
    "updated_at": "2022-01-05T06:00:13Z",
    "body": "> > Since multi-threaded applications are not allowed to use the environ variable to access or modify any environment variable while any other thread is concurrently modifying any environment variable, any function dependent on any environment variable is not thread-safe if another thread is modifying the environment; see XSH exec.\r\n> \r\n> This text is redundant with the thread-unsafety of `setenv`, but also covers the case where `environ` is modified directly.\r\n\r\nNotably, this implies that it *is* safe for a multithreaded program to access the environment under a lock, as long as it does so by accessing `environ` directly rather than using `getenv` or `setenv`, and as long as no other threads simultaneously call \"any function dependent on any environment variable\".  However, it's not clear to me if there are any guarantees around what functions are \"dependent on any environment variable\", e.g. whether glibc's `getaddrinfo` behavior is conforming.  Quite possibly it is, in which case this guarantee is fairly useless.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005405050/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005421792",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1005421792",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1005421792,
    "node_id": "IC_kwDOAAsO6M477YTg",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-01-05T06:39:45Z",
    "updated_at": "2022-01-05T06:39:45Z",
    "body": "@comex wrote:\r\n\r\n> However, it's not clear to me if there are any guarantees around what functions are \"dependent on any environment variable\", e.g. whether glibc's `getaddrinfo` behavior is conforming. Quite possibly it is, in which case this guarantee is fairly useless.\r\n\r\nThe standard is very explicit where functions are specified to use the environment, so my interpretation is that this behavior is non-conforming, and that's why we don't do it in musl. If I recall, we've had this discussion with glibc folks a few times in the past and the consensus was that stdlib extensions using the environment where it's not specified really should be scanning the environment at program entry time to extract the settings they want to use, so that the specified safety properties are maintained. I think this is the path glibc is following for adding any new tuning variables, though the existing ones (at least for now) continue to behave as they always have.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1005421792/reactions",
      "total_count": 4,
      "+1": 4,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1346046136",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1346046136",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1346046136,
    "node_id": "IC_kwDOAAsO6M5QOwi4",
    "user": {
      "login": "tmccombs",
      "id": 2541726,
      "node_id": "MDQ6VXNlcjI1NDE3MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541726?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tmccombs",
      "html_url": "https://github.com/tmccombs",
      "followers_url": "https://api.github.com/users/tmccombs/followers",
      "following_url": "https://api.github.com/users/tmccombs/following{/other_user}",
      "gists_url": "https://api.github.com/users/tmccombs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tmccombs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tmccombs/subscriptions",
      "organizations_url": "https://api.github.com/users/tmccombs/orgs",
      "repos_url": "https://api.github.com/users/tmccombs/repos",
      "events_url": "https://api.github.com/users/tmccombs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tmccombs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2022-12-12T08:05:44Z",
    "updated_at": "2022-12-12T08:05:44Z",
    "body": "> The standard is very explicit where functions are specified to use the environment\r\n\r\nBut does it explicitly state that functions cannot add additional dependencies on environment variables that are not explicitly specified? ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1346046136/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1767480001",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-1767480001",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 1767480001,
    "node_id": "IC_kwDOAAsO6M5pWZrB",
    "user": {
      "login": "evanj",
      "id": 675151,
      "node_id": "MDQ6VXNlcjY3NTE1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/675151?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/evanj",
      "html_url": "https://github.com/evanj",
      "followers_url": "https://api.github.com/users/evanj/followers",
      "following_url": "https://api.github.com/users/evanj/following{/other_user}",
      "gists_url": "https://api.github.com/users/evanj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/evanj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/evanj/subscriptions",
      "organizations_url": "https://api.github.com/users/evanj/orgs",
      "repos_url": "https://api.github.com/users/evanj/repos",
      "events_url": "https://api.github.com/users/evanj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/evanj/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2023-10-18T01:49:20Z",
    "updated_at": "2023-10-18T01:49:37Z",
    "body": "Just to confirm this is not a theoretical issue, here is a Rust program that only uses the standard library and crashes in Linux with glibc with a Segmentation Fault. It calls `ToSocketAddrs` on one thread, which calls `getaddrinfo`, and calls `set_env` on another. https://github.com/evanj/cgogetenvcrash/blob/main/rustsetenvcrash/src/main.rs",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/1767480001/reactions",
      "total_count": 11,
      "+1": 11,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013135995",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2013135995",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2013135995,
    "node_id": "IC_kwDOAAsO6M53_gR7",
    "user": {
      "login": "VorpalBlade",
      "id": 3315306,
      "node_id": "MDQ6VXNlcjMzMTUzMDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3315306?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/VorpalBlade",
      "html_url": "https://github.com/VorpalBlade",
      "followers_url": "https://api.github.com/users/VorpalBlade/followers",
      "following_url": "https://api.github.com/users/VorpalBlade/following{/other_user}",
      "gists_url": "https://api.github.com/users/VorpalBlade/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/VorpalBlade/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/VorpalBlade/subscriptions",
      "organizations_url": "https://api.github.com/users/VorpalBlade/orgs",
      "repos_url": "https://api.github.com/users/VorpalBlade/repos",
      "events_url": "https://api.github.com/users/VorpalBlade/events{/privacy}",
      "received_events_url": "https://api.github.com/users/VorpalBlade/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-21T17:31:45Z",
    "updated_at": "2024-03-21T17:31:45Z",
    "body": "What is the status of this? Specifically with regards to exposing the env lock to users of std, this was talked about in 2020 but nothing much seems to have happened? Was the idea dropped, if so where is the rationale for that documented? ",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013135995/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013470577",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2013470577",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2013470577,
    "node_id": "IC_kwDOAAsO6M54Ax9x",
    "user": {
      "login": "ChrisDenton",
      "id": 4459874,
      "node_id": "MDQ6VXNlcjQ0NTk4NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ChrisDenton",
      "html_url": "https://github.com/ChrisDenton",
      "followers_url": "https://api.github.com/users/ChrisDenton/followers",
      "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions",
      "organizations_url": "https://api.github.com/users/ChrisDenton/orgs",
      "repos_url": "https://api.github.com/users/ChrisDenton/repos",
      "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ChrisDenton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-21T19:32:03Z",
    "updated_at": "2024-03-21T19:32:03Z",
    "body": "glibc says calling set_env is unsound in the presence of threads. So in order to address this we need the application to essentially become single threaded while set_env is being called.\n\nThe environment lock falls short on this. We can't seriously mandate that everyone acquires a lock before making libc calls, not least because the lock is Rust only.\n\nA more robust course of action would be to simply (and more accurately) mark set_env unsafe and teach how it can be safely used in a cross-platform manner. In this scenario the lock is basically redundant so it could even be considered for removal.",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013470577/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013502427",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2013502427",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2013502427,
    "node_id": "IC_kwDOAAsO6M54A5vb",
    "user": {
      "login": "tarcieri",
      "id": 797,
      "node_id": "MDQ6VXNlcjc5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tarcieri",
      "html_url": "https://github.com/tarcieri",
      "followers_url": "https://api.github.com/users/tarcieri/followers",
      "following_url": "https://api.github.com/users/tarcieri/following{/other_user}",
      "gists_url": "https://api.github.com/users/tarcieri/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tarcieri/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tarcieri/subscriptions",
      "organizations_url": "https://api.github.com/users/tarcieri/orgs",
      "repos_url": "https://api.github.com/users/tarcieri/repos",
      "events_url": "https://api.github.com/users/tarcieri/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tarcieri/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-21T19:39:57Z",
    "updated_at": "2024-03-21T19:39:57Z",
    "body": "I believe this is the current plan:\r\n\r\nhttps://github.com/rust-lang/rust/pull/116888#issuecomment-1852620311\r\n\r\n> We discussed this in the libs-api meeting. What we would like to see happen is that this function gets turned into an unsafe function for the 2024 edition, but on older editions only emits a warning if not inside an unsafe block (possibly using deprecated_safe https://github.com/rust-lang/rust/issues/94978).",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013502427/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013548564",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2013548564",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2013548564,
    "node_id": "IC_kwDOAAsO6M54BFAU",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-21T19:51:36Z",
    "updated_at": "2024-03-21T19:51:36Z",
    "body": "Plan sounds good.\r\n\r\nThe right thing for applications to do is *not modify the environment*. If they're modifying it to pass to child processes, the right way to do that is passing an explicit new environment, not modifying your own environment and relying on it getting copied. If they're using the environment to control the behavior of C library code they're calling, that's inherently unsafe and the library should be fixed to accept explicit caller-provided overrides of whatever it was getting from the environment.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013548564/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013585621",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2013585621",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2013585621,
    "node_id": "IC_kwDOAAsO6M54BODV",
    "user": {
      "login": "VorpalBlade",
      "id": 3315306,
      "node_id": "MDQ6VXNlcjMzMTUzMDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3315306?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/VorpalBlade",
      "html_url": "https://github.com/VorpalBlade",
      "followers_url": "https://api.github.com/users/VorpalBlade/followers",
      "following_url": "https://api.github.com/users/VorpalBlade/following{/other_user}",
      "gists_url": "https://api.github.com/users/VorpalBlade/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/VorpalBlade/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/VorpalBlade/subscriptions",
      "organizations_url": "https://api.github.com/users/VorpalBlade/orgs",
      "repos_url": "https://api.github.com/users/VorpalBlade/repos",
      "events_url": "https://api.github.com/users/VorpalBlade/events{/privacy}",
      "received_events_url": "https://api.github.com/users/VorpalBlade/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-21T20:01:35Z",
    "updated_at": "2024-03-21T20:01:49Z",
    "body": "> Plan sounds good.\r\n> \r\n> The right thing for applications to do is _not modify the environment_. If they're modifying it to pass to child processes, the right way to do that is passing an explicit new environment, not modifying your own environment and relying on it getting copied. If they're using the environment to control the behavior of C library code they're calling, that's inherently unsafe and the library should be fixed to accept explicit caller-provided overrides of whatever it was getting from the environment.\r\n\r\n@richfelker This doesn't really work if you are implementing a shell though, unless you decide to emulate your internal environment completely (and pass that on to tasks you spawn). That is a niche use case sure, and I'm curious as to what nushell and fish (which was recently rewritten in Rust) do here.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013585621/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013631951",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2013631951",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2013631951,
    "node_id": "IC_kwDOAAsO6M54BZXP",
    "user": {
      "login": "tbu-",
      "id": 6666593,
      "node_id": "MDQ6VXNlcjY2NjY1OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6666593?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbu-",
      "html_url": "https://github.com/tbu-",
      "followers_url": "https://api.github.com/users/tbu-/followers",
      "following_url": "https://api.github.com/users/tbu-/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbu-/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbu-/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbu-/subscriptions",
      "organizations_url": "https://api.github.com/users/tbu-/orgs",
      "repos_url": "https://api.github.com/users/tbu-/repos",
      "events_url": "https://api.github.com/users/tbu-/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbu-/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-21T20:11:53Z",
    "updated_at": "2024-03-21T20:11:53Z",
    "body": "> unless you decide to emulate your internal environment completely (and pass that on to tasks you spawn).\r\n\r\nNote that \"emulating the internal environment completely\" essentially only means keeping a hashmap around and accessing that instead of `std::env::var`.\r\n\r\n> I'm curious as to what nushell and fish (which was recently rewritten in Rust) do here.\r\n\r\nfish doesn't call `std::env::set_var`: https://github.com/search?q=repo%3Afish-shell%2Ffish-shell+set_var&type=code\r\nnushell doesn't call `std::env::set_var` outside of test code: https://github.com/search?q=repo%3Anushell%2Fnushell+set_var&type=code.\r\n\r\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013631951/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013651271",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2013651271",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2013651271,
    "node_id": "IC_kwDOAAsO6M54BeFH",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-21T20:18:16Z",
    "updated_at": "2024-03-21T20:18:16Z",
    "body": "> unless you decide to emulate your internal environment completely (and pass that on to tasks you spawn).\r\n\r\nOf course this is the correct way to do a shell. Just because ancient unix history did things the sloppy way of modifying the shell process's environment directly rather than keeping its own data structures for key/value map doesn't mean a modern one written in a modern safe language should copy the same bad ideas. It's not even easier to store exports in your own environment, since you already need your own map for non-exported variables, and you can just use the same one (with export flag on each entry) for both.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2013651271/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2014153521",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2014153521",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2014153521,
    "node_id": "IC_kwDOAAsO6M54DYsx",
    "user": {
      "login": "tmccombs",
      "id": 2541726,
      "node_id": "MDQ6VXNlcjI1NDE3MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541726?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tmccombs",
      "html_url": "https://github.com/tmccombs",
      "followers_url": "https://api.github.com/users/tmccombs/followers",
      "following_url": "https://api.github.com/users/tmccombs/following{/other_user}",
      "gists_url": "https://api.github.com/users/tmccombs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tmccombs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tmccombs/subscriptions",
      "organizations_url": "https://api.github.com/users/tmccombs/orgs",
      "repos_url": "https://api.github.com/users/tmccombs/repos",
      "events_url": "https://api.github.com/users/tmccombs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tmccombs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-22T01:31:36Z",
    "updated_at": "2024-03-22T01:31:36Z",
    "body": "> If they're using the environment to control the behavior of C library code they're calling, that's inherently unsafe and the library should be fixed to accept explicit caller-provided overrides of whatever it was getting from the environment.\r\n\r\nIt is really unfortunate that libc and posix have functions that depend on environment variables, such as `localtime_r` and anything that uses the locale.  I really wish the c and posix standard would make a more multithreading friendly API. ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2014153521/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2014217709",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2014217709",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2014217709,
    "node_id": "IC_kwDOAAsO6M54DoXt",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-22T02:43:15Z",
    "updated_at": "2024-03-22T02:43:15Z",
    "body": "There is never a reason to set the locale environment vars within a program. If you want to request a specific locale, you pass the name to the locale functions. The environment is only there as a default inherited at execution time.\r\n\r\nFor time zones, indeed the standard library functionality is rather poor. There have been proposals to modernize it with first class zone objects, but not a lot of progress on making it happen.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2014217709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2014795753",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2014795753",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2014795753,
    "node_id": "IC_kwDOAAsO6M54F1fp",
    "user": {
      "login": "kamulos",
      "id": 5168812,
      "node_id": "MDQ6VXNlcjUxNjg4MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5168812?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kamulos",
      "html_url": "https://github.com/kamulos",
      "followers_url": "https://api.github.com/users/kamulos/followers",
      "following_url": "https://api.github.com/users/kamulos/following{/other_user}",
      "gists_url": "https://api.github.com/users/kamulos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kamulos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kamulos/subscriptions",
      "organizations_url": "https://api.github.com/users/kamulos/orgs",
      "repos_url": "https://api.github.com/users/kamulos/repos",
      "events_url": "https://api.github.com/users/kamulos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kamulos/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-22T10:31:03Z",
    "updated_at": "2024-03-22T10:31:03Z",
    "body": "Just for completeness sake: there is also https://github.com/sunfishcode/eyra#why which solves the issue on the level of the libc",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2014795753/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2015816049",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2015816049",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2015816049,
    "node_id": "IC_kwDOAAsO6M54Julx",
    "user": {
      "login": "DemiMarie",
      "id": 6395399,
      "node_id": "MDQ6VXNlcjYzOTUzOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6395399?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DemiMarie",
      "html_url": "https://github.com/DemiMarie",
      "followers_url": "https://api.github.com/users/DemiMarie/followers",
      "following_url": "https://api.github.com/users/DemiMarie/following{/other_user}",
      "gists_url": "https://api.github.com/users/DemiMarie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DemiMarie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DemiMarie/subscriptions",
      "organizations_url": "https://api.github.com/users/DemiMarie/orgs",
      "repos_url": "https://api.github.com/users/DemiMarie/repos",
      "events_url": "https://api.github.com/users/DemiMarie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DemiMarie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-22T20:00:27Z",
    "updated_at": "2024-03-22T20:00:27Z",
    "body": "> For time zones, indeed the standard library functionality is rather poor. There have been proposals to modernize it with first class zone objects, but not a lot of progress on making it happen.\r\n\r\nIs this something that could be prototyped in a C library?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2015816049/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2016705882",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2016705882",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2016705882,
    "node_id": "IC_kwDOAAsO6M54NH1a",
    "user": {
      "login": "tmccombs",
      "id": 2541726,
      "node_id": "MDQ6VXNlcjI1NDE3MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541726?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tmccombs",
      "html_url": "https://github.com/tmccombs",
      "followers_url": "https://api.github.com/users/tmccombs/followers",
      "following_url": "https://api.github.com/users/tmccombs/following{/other_user}",
      "gists_url": "https://api.github.com/users/tmccombs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tmccombs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tmccombs/subscriptions",
      "organizations_url": "https://api.github.com/users/tmccombs/orgs",
      "repos_url": "https://api.github.com/users/tmccombs/repos",
      "events_url": "https://api.github.com/users/tmccombs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tmccombs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-03-24T06:05:33Z",
    "updated_at": "2024-03-24T06:05:33Z",
    "body": "Sure. It isn't trivial though. On linux, you need to know how to read the timezone files, which is kind of complicated to do, I think that is what chrono does though. I'm not sure if there is a documented and supported way to do it on other major platforms. I think Mac uses the same tzinfo format, but I'm not sure if that is documented to remain stable. I don't know about windows, or mobile oses.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2016705882/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2197777428",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2197777428",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2197777428,
    "node_id": "IC_kwDOAAsO6M6C_2wU",
    "user": {
      "login": "fweimer-rh",
      "id": 75532728,
      "node_id": "MDQ6VXNlcjc1NTMyNzI4",
      "avatar_url": "https://avatars.githubusercontent.com/u/75532728?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fweimer-rh",
      "html_url": "https://github.com/fweimer-rh",
      "followers_url": "https://api.github.com/users/fweimer-rh/followers",
      "following_url": "https://api.github.com/users/fweimer-rh/following{/other_user}",
      "gists_url": "https://api.github.com/users/fweimer-rh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fweimer-rh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fweimer-rh/subscriptions",
      "organizations_url": "https://api.github.com/users/fweimer-rh/orgs",
      "repos_url": "https://api.github.com/users/fweimer-rh/repos",
      "events_url": "https://api.github.com/users/fweimer-rh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fweimer-rh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-06-28T23:49:00Z",
    "updated_at": "2024-06-28T23:49:00Z",
    "body": "I've posted a patch that should fix this for glibc:\r\n\r\n* [[PATCH] stdlib: Make getenv thread-safe in more cases](https://inbox.sourceware.org/libc-alpha/87le2od4xh.fsf@oldenburg.str.redhat.com/)\r\n\r\nReviews would be appreciated. It does not solve the conceptual problem that the environment is a process-global resource. Other threads still observe temporary environment changes intended for the current thread only. Just the crashes and missed variable lookups are gone.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2197777428/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2197795435",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2197795435",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2197795435,
    "node_id": "IC_kwDOAAsO6M6C_7Jr",
    "user": {
      "login": "briansmith",
      "id": 16816,
      "node_id": "MDQ6VXNlcjE2ODE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16816?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/briansmith",
      "html_url": "https://github.com/briansmith",
      "followers_url": "https://api.github.com/users/briansmith/followers",
      "following_url": "https://api.github.com/users/briansmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/briansmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/briansmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/briansmith/subscriptions",
      "organizations_url": "https://api.github.com/users/briansmith/orgs",
      "repos_url": "https://api.github.com/users/briansmith/repos",
      "events_url": "https://api.github.com/users/briansmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/briansmith/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-06-29T00:27:35Z",
    "updated_at": "2024-06-29T00:27:35Z",
    "body": "> I've posted a patch that should fix this for glibc:\r\n\r\nJust to clarify, your patch doesn't fix it \"enough\" for Rust to consider them to `set_var`/`remove_var` to be safe, because C code is still allowed to read directly from `environ` and do other things that aren't protected by your improvements. That doesn't mean your improvement isn't welcome though.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2197795435/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2197825809",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2197825809",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2197825809,
    "node_id": "IC_kwDOAAsO6M6DACkR",
    "user": {
      "login": "richfelker",
      "id": 10458007,
      "node_id": "MDQ6VXNlcjEwNDU4MDA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10458007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richfelker",
      "html_url": "https://github.com/richfelker",
      "followers_url": "https://api.github.com/users/richfelker/followers",
      "following_url": "https://api.github.com/users/richfelker/following{/other_user}",
      "gists_url": "https://api.github.com/users/richfelker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richfelker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richfelker/subscriptions",
      "organizations_url": "https://api.github.com/users/richfelker/orgs",
      "repos_url": "https://api.github.com/users/richfelker/repos",
      "events_url": "https://api.github.com/users/richfelker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richfelker/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-06-29T01:35:27Z",
    "updated_at": "2024-06-29T01:35:27Z",
    "body": "I don't see how this provides any significant thread-safety. The core unsafety of modifying the environment is that the lifetime of a string returned by `getenv` can end asynchronously if another thread changes the environment. The only way to avoid this is to leak everything ever added.\r\n",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2197825809/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198019316",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2198019316",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2198019316,
    "node_id": "IC_kwDOAAsO6M6DAxz0",
    "user": {
      "login": "tbu-",
      "id": 6666593,
      "node_id": "MDQ6VXNlcjY2NjY1OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6666593?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbu-",
      "html_url": "https://github.com/tbu-",
      "followers_url": "https://api.github.com/users/tbu-/followers",
      "following_url": "https://api.github.com/users/tbu-/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbu-/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbu-/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbu-/subscriptions",
      "organizations_url": "https://api.github.com/users/tbu-/orgs",
      "repos_url": "https://api.github.com/users/tbu-/repos",
      "events_url": "https://api.github.com/users/tbu-/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbu-/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-06-29T07:00:59Z",
    "updated_at": "2024-06-29T07:00:59Z",
    "body": "Another way is for `getenv` to put the result into a thread-local variable. This is compatible with POSIX's guarantees, but probably not in line with glibc's backward compatibility guarantees.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198019316/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198029819",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2198029819",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2198029819,
    "node_id": "IC_kwDOAAsO6M6DA0X7",
    "user": {
      "login": "RalfJung",
      "id": 330628,
      "node_id": "MDQ6VXNlcjMzMDYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RalfJung",
      "html_url": "https://github.com/RalfJung",
      "followers_url": "https://api.github.com/users/RalfJung/followers",
      "following_url": "https://api.github.com/users/RalfJung/following{/other_user}",
      "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions",
      "organizations_url": "https://api.github.com/users/RalfJung/orgs",
      "repos_url": "https://api.github.com/users/RalfJung/repos",
      "events_url": "https://api.github.com/users/RalfJung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RalfJung/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-06-29T07:39:05Z",
    "updated_at": "2024-06-29T07:39:05Z",
    "body": "From the patch:\r\n\r\n> I think this achieves full thread safety and async-signal-safety for\r\ngetenv if the environment is only updated using setenv, unsetenv,\r\nclearenv.  If putenv is used, it depends on how the passed string is\r\nupdated afterwards.  Likewise for direct environ writes.  This is fairly\r\neasy to accomplish because the current implementation never frees any\r\nvariables set using setenv.\r\n\r\nSo, seems to me like setenv is already leaking, and this patch builds on that.\r\n\r\nVery nice to see progress on this!",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198029819/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198036203",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2198036203",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2198036203,
    "node_id": "IC_kwDOAAsO6M6DA17r",
    "user": {
      "login": "VorpalBlade",
      "id": 3315306,
      "node_id": "MDQ6VXNlcjMzMTUzMDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3315306?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/VorpalBlade",
      "html_url": "https://github.com/VorpalBlade",
      "followers_url": "https://api.github.com/users/VorpalBlade/followers",
      "following_url": "https://api.github.com/users/VorpalBlade/following{/other_user}",
      "gists_url": "https://api.github.com/users/VorpalBlade/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/VorpalBlade/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/VorpalBlade/subscriptions",
      "organizations_url": "https://api.github.com/users/VorpalBlade/orgs",
      "repos_url": "https://api.github.com/users/VorpalBlade/repos",
      "events_url": "https://api.github.com/users/VorpalBlade/events{/privacy}",
      "received_events_url": "https://api.github.com/users/VorpalBlade/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-06-29T07:55:44Z",
    "updated_at": "2024-06-29T07:55:44Z",
    "body": "Even if that patch is accepted in glibc, POSIX doesn't guarantee thread safety, so this cannot change the decision for Rust (unless you get a change into musl, all the *BSDs, OpenSolaris, Darwin/Mac OS X etc, as well as the POSIX standard itself). And I don't foresee that happening due to backward compatibility around `environ` as well as the issue mentioned with `putenv`.\r\n\r\nStill, it is a step in the right direction.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198036203/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198279309",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2198279309",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2198279309,
    "node_id": "IC_kwDOAAsO6M6DBxSN",
    "user": {
      "login": "tmccombs",
      "id": 2541726,
      "node_id": "MDQ6VXNlcjI1NDE3MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541726?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tmccombs",
      "html_url": "https://github.com/tmccombs",
      "followers_url": "https://api.github.com/users/tmccombs/followers",
      "following_url": "https://api.github.com/users/tmccombs/following{/other_user}",
      "gists_url": "https://api.github.com/users/tmccombs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tmccombs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tmccombs/subscriptions",
      "organizations_url": "https://api.github.com/users/tmccombs/orgs",
      "repos_url": "https://api.github.com/users/tmccombs/repos",
      "events_url": "https://api.github.com/users/tmccombs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tmccombs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-06-29T18:03:35Z",
    "updated_at": "2024-06-29T18:03:35Z",
    "body": "Well, if it weren't for direct access to environ and the putenv issue, there could possibly be a safe function that is only available on platforms that use a new enough version of glibc. ",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2198279309/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2199535372",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2199535372",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2199535372,
    "node_id": "IC_kwDOAAsO6M6DGj8M",
    "user": {
      "login": "tbu-",
      "id": 6666593,
      "node_id": "MDQ6VXNlcjY2NjY1OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6666593?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbu-",
      "html_url": "https://github.com/tbu-",
      "followers_url": "https://api.github.com/users/tbu-/followers",
      "following_url": "https://api.github.com/users/tbu-/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbu-/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbu-/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbu-/subscriptions",
      "organizations_url": "https://api.github.com/users/tbu-/orgs",
      "repos_url": "https://api.github.com/users/tbu-/repos",
      "events_url": "https://api.github.com/users/tbu-/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbu-/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-07-01T08:22:11Z",
    "updated_at": "2024-07-01T08:22:11Z",
    "body": "> Even if that patch is accepted in glibc, POSIX doesn't guarantee thread safety, so this cannot change the decision for Rust (unless you get a change into musl, all the *BSDs, OpenSolaris, Darwin/Mac OS X etc, as well as the POSIX standard itself).\r\n\r\nNote that Rust doesn't strictly adhere to POSIX, Rust is fine with stuff that all the platforms implement. E.g. `pthread_t` is assumed to be an integer even though POSIX explicitly says that it might not be.\r\n\r\nI haven't looked into whether musl, *BSDs or Darwin implement synchronization for environment variables. I just wanted to say that POSIX itself might not be a requirement.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2199535372/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2200517621",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2200517621",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2200517621,
    "node_id": "IC_kwDOAAsO6M6DKTv1",
    "user": {
      "login": "tmccombs",
      "id": 2541726,
      "node_id": "MDQ6VXNlcjI1NDE3MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541726?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tmccombs",
      "html_url": "https://github.com/tmccombs",
      "followers_url": "https://api.github.com/users/tmccombs/followers",
      "following_url": "https://api.github.com/users/tmccombs/following{/other_user}",
      "gists_url": "https://api.github.com/users/tmccombs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tmccombs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tmccombs/subscriptions",
      "organizations_url": "https://api.github.com/users/tmccombs/orgs",
      "repos_url": "https://api.github.com/users/tmccombs/repos",
      "events_url": "https://api.github.com/users/tmccombs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tmccombs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-07-01T15:54:29Z",
    "updated_at": "2024-07-01T15:54:29Z",
    "body": "What if another thread reads environ directly? Would that still be undefined behavior unless setenv uses an atomic operation to swap the pointer, *and* the reader uses an atomic load to read environ?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2200517621/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2200542088",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2200542088",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2200542088,
    "node_id": "IC_kwDOAAsO6M6DKZuI",
    "user": {
      "login": "fweimer-rh",
      "id": 75532728,
      "node_id": "MDQ6VXNlcjc1NTMyNzI4",
      "avatar_url": "https://avatars.githubusercontent.com/u/75532728?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fweimer-rh",
      "html_url": "https://github.com/fweimer-rh",
      "followers_url": "https://api.github.com/users/fweimer-rh/followers",
      "following_url": "https://api.github.com/users/fweimer-rh/following{/other_user}",
      "gists_url": "https://api.github.com/users/fweimer-rh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fweimer-rh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fweimer-rh/subscriptions",
      "organizations_url": "https://api.github.com/users/fweimer-rh/orgs",
      "repos_url": "https://api.github.com/users/fweimer-rh/repos",
      "events_url": "https://api.github.com/users/fweimer-rh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fweimer-rh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-07-01T16:05:28Z",
    "updated_at": "2024-07-01T16:05:28Z",
    "body": "> What if another thread reads environ directly? Would that still be undefined behavior unless setenv uses an atomic operation to swap the pointer, _and_ the reader uses an atomic load to read environ?\r\n\r\n@tmccombs Is this a question about the proposed new glibc implementation? It's not possible to ensure a proper snapshot with just atomic access to `environ`. Even if individual accesses never fault, it's impossible to know whether you have actually observed all currently active environment variables. Concurrent `unsetenv` calls may have shuffled around the array while you were reading it. I assume that this question is related to the implementation of [`std::env:vars()`](https://doc.rust-lang.org/std/env/fn.vars.html). Realistically, this will a new interface. For glibc's internal use in `execve`, `posix_spawn` etc., we can add something that treats `environ` differently so that we can obtain a snapshot similar to `getenv`, but exposing that externally as-is would constraint the implementation too much.",
    "author_association": "NONE",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2200542088/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2201065586",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2201065586",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2201065586,
    "node_id": "IC_kwDOAAsO6M6DMZhy",
    "user": {
      "login": "tmccombs",
      "id": 2541726,
      "node_id": "MDQ6VXNlcjI1NDE3MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541726?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tmccombs",
      "html_url": "https://github.com/tmccombs",
      "followers_url": "https://api.github.com/users/tmccombs/followers",
      "following_url": "https://api.github.com/users/tmccombs/following{/other_user}",
      "gists_url": "https://api.github.com/users/tmccombs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tmccombs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tmccombs/subscriptions",
      "organizations_url": "https://api.github.com/users/tmccombs/orgs",
      "repos_url": "https://api.github.com/users/tmccombs/repos",
      "events_url": "https://api.github.com/users/tmccombs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tmccombs/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-07-01T21:02:48Z",
    "updated_at": "2024-07-01T21:02:48Z",
    "body": "My point is that even if a c library reads from environ directly, then no amount of synchronization around setenv in rust would be safe in a multi-threaded program.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2201065586/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2558868195",
    "html_url": "https://github.com/rust-lang/rust/issues/27970#issuecomment-2558868195",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/27970",
    "id": 2558868195,
    "node_id": "IC_kwDOAAsO6M6YhTrj",
    "user": {
      "login": "tgross35",
      "id": 13724985,
      "node_id": "MDQ6VXNlcjEzNzI0OTg1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13724985?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tgross35",
      "html_url": "https://github.com/tgross35",
      "followers_url": "https://api.github.com/users/tgross35/followers",
      "following_url": "https://api.github.com/users/tgross35/following{/other_user}",
      "gists_url": "https://api.github.com/users/tgross35/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tgross35/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tgross35/subscriptions",
      "organizations_url": "https://api.github.com/users/tgross35/orgs",
      "repos_url": "https://api.github.com/users/tgross35/repos",
      "events_url": "https://api.github.com/users/tgross35/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tgross35/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2024-12-23T04:07:39Z",
    "updated_at": "2024-12-23T04:07:39Z",
    "body": "> I've posted a patch that should fix this for glibc:\n> \n>     * [[PATCH] stdlib: Make getenv thread-safe in more cases](https://inbox.sourceware.org/libc-alpha/87le2od4xh.fsf@oldenburg.str.redhat.com/)\n> \n> \n> Reviews would be appreciated. It does not solve the conceptual problem that the environment is a process-global resource. Other threads still observe temporary environment changes intended for the current thread only. Just the crashes and missed variable lookups are gone.\n\nA version of this has since been committed https://github.com/bminor/glibc/commit/7a61e7f557a97ab597d6fca5e2d1f13f65685c61.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/2558868195/reactions",
      "total_count": 4,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 2,
      "eyes": 1
    },
    "performed_via_github_app": null
  }
]
