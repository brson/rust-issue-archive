[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59823596",
    "html_url": "https://github.com/rust-lang/rust/issues/18193#issuecomment-59823596",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/18193",
    "id": 59823596,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5ODIzNTk2",
    "user": {
      "login": "jfager",
      "id": 23755,
      "node_id": "MDQ6VXNlcjIzNzU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23755?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jfager",
      "html_url": "https://github.com/jfager",
      "followers_url": "https://api.github.com/users/jfager/followers",
      "following_url": "https://api.github.com/users/jfager/following{/other_user}",
      "gists_url": "https://api.github.com/users/jfager/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jfager/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jfager/subscriptions",
      "organizations_url": "https://api.github.com/users/jfager/orgs",
      "repos_url": "https://api.github.com/users/jfager/repos",
      "events_url": "https://api.github.com/users/jfager/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jfager/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-10-20T19:16:22Z",
    "updated_at": "2014-10-20T19:16:22Z",
    "body": "I'm getting different results:\n\n$ rustc --opt-level=3 --test slow_position.rs\n$ ./slow_position --bench\n\nrunning 4 tests\ntest _range    ... bench:     35569 ns/iter (+/- 8183)\ntest enumerate ... bench:     35699 ns/iter (+/- 1615)\ntest iter      ... bench:     35929 ns/iter (+/- 4164)\ntest position  ... bench:     31404 ns/iter (+/- 10487)\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 4 measured\n\n(the assembly version segfaulted on me).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59823596/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59823906",
    "html_url": "https://github.com/rust-lang/rust/issues/18193#issuecomment-59823906",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/18193",
    "id": 59823906,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5ODIzOTA2",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-10-20T19:18:44Z",
    "updated_at": "2014-10-20T19:18:44Z",
    "body": "> test position ... bench: 31404 ns/iter (+/- **10487**)\n\nwow. What platform?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59823906/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59824696",
    "html_url": "https://github.com/rust-lang/rust/issues/18193#issuecomment-59824696",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/18193",
    "id": 59824696,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5ODI0Njk2",
    "user": {
      "login": "jfager",
      "id": 23755,
      "node_id": "MDQ6VXNlcjIzNzU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23755?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jfager",
      "html_url": "https://github.com/jfager",
      "followers_url": "https://api.github.com/users/jfager/followers",
      "following_url": "https://api.github.com/users/jfager/following{/other_user}",
      "gists_url": "https://api.github.com/users/jfager/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jfager/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jfager/subscriptions",
      "organizations_url": "https://api.github.com/users/jfager/orgs",
      "repos_url": "https://api.github.com/users/jfager/repos",
      "events_url": "https://api.github.com/users/jfager/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jfager/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-10-20T19:24:17Z",
    "updated_at": "2014-10-20T19:24:17Z",
    "body": "On a macbook.  Here's another run without a bunch of stuff in the background screwing up the variance:\n\n$ rustc --opt-level=3 --test slow_position.rs\n$ ./slow_position --bench\n\nrunning 4 tests\ntest _range    ... bench:     33728 ns/iter (+/- 2331)\ntest enumerate ... bench:     33677 ns/iter (+/- 2851)\ntest iter      ... bench:     33699 ns/iter (+/- 3995)\ntest position  ... bench:     28884 ns/iter (+/- 978)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59824696/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59825232",
    "html_url": "https://github.com/rust-lang/rust/issues/18193#issuecomment-59825232",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/18193",
    "id": 59825232,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5ODI1MjMy",
    "user": {
      "login": "arielb1",
      "id": 1830974,
      "node_id": "MDQ6VXNlcjE4MzA5NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arielb1",
      "html_url": "https://github.com/arielb1",
      "followers_url": "https://api.github.com/users/arielb1/followers",
      "following_url": "https://api.github.com/users/arielb1/following{/other_user}",
      "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions",
      "organizations_url": "https://api.github.com/users/arielb1/orgs",
      "repos_url": "https://api.github.com/users/arielb1/repos",
      "events_url": "https://api.github.com/users/arielb1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arielb1/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-10-20T19:28:04Z",
    "updated_at": "2014-10-20T19:52:30Z",
    "body": "The IL for `iter`-s inner loop is (de-gensymmed)\n\n``` llvm\n.loop.preheader: ; preds = %.noexc15\n  br label %.loop\n\nfor_loopback.i: ; preds = %for_body.i14\n  %16 = icmp eq i8* %18, %14\n  br i1 %16, label %.noexc6.loopexit, label %.exit\n\n.loop: ; preds = %.loop.preheader, %for_loopback.i\n  %i = phi i64 [ %21, %for_loopback.i ], [ 0, %.loop.preheader ]\n  %ix = phi i8* [ %18, %for_loopback.i ], [ %.pre, %.loop.preheader ]\n  %17 = icmp eq i8* %ix, null ; WTF? spurious null check\n  br i1 %17, label %.noexc6.loopexit, label %for_body.i14\n\nfor_body.i14: ; preds = .loop\n  %18 = getelementptr inbounds i8* %ix, i64 1\n  %19 = load i8* %ix, align 1\n  %20 = icmp eq i8 %19, 1\n  %21 = add i64 %i, 1\n  br i1 %20, label %.noexc6.loopexit, label %for_loopback.i\n```\n\nWhich looks sane, except for the spurious null check (which remains in the assembly).\n\nBenchmarks on my machine:\n\n```\n$ grep model\\ name /proc/cpuinfo | uniq\nmodel name  : Intel(R) Core(TM) i5-3317U CPU @ 1.70GHz\n$ rustc -O --test test.rs\n$ ./test --bench\n\nrunning 5 tests\ntest _range    ... bench:     51362 ns/iter (+/- 4319)\ntest assembly  ... bench:     51578 ns/iter (+/- 2938)\ntest enumerate ... bench:     51465 ns/iter (+/- 850)\ntest iter      ... bench:     77122 ns/iter (+/- 886)\ntest position  ... bench:     77147 ns/iter (+/- 1315)\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 5 measured\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59825232/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59831188",
    "html_url": "https://github.com/rust-lang/rust/issues/18193#issuecomment-59831188",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/18193",
    "id": 59831188,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5ODMxMTg4",
    "user": {
      "login": "arielb1",
      "id": 1830974,
      "node_id": "MDQ6VXNlcjE4MzA5NzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arielb1",
      "html_url": "https://github.com/arielb1",
      "followers_url": "https://api.github.com/users/arielb1/followers",
      "following_url": "https://api.github.com/users/arielb1/following{/other_user}",
      "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions",
      "organizations_url": "https://api.github.com/users/arielb1/orgs",
      "repos_url": "https://api.github.com/users/arielb1/repos",
      "events_url": "https://api.github.com/users/arielb1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arielb1/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-10-20T20:08:49Z",
    "updated_at": "2014-10-20T20:12:08Z",
    "body": "The spurious null check is the issue \u2013 writing a `nop` over it in the object code gives 51365\u00b1385 ns/iter on my laptop.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/59831188/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/69666625",
    "html_url": "https://github.com/rust-lang/rust/issues/18193#issuecomment-69666625",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/18193",
    "id": 69666625,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjY2NjI1",
    "user": {
      "login": "mahkoh",
      "id": 1882250,
      "node_id": "MDQ6VXNlcjE4ODIyNTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1882250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mahkoh",
      "html_url": "https://github.com/mahkoh",
      "followers_url": "https://api.github.com/users/mahkoh/followers",
      "following_url": "https://api.github.com/users/mahkoh/following{/other_user}",
      "gists_url": "https://api.github.com/users/mahkoh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mahkoh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mahkoh/subscriptions",
      "organizations_url": "https://api.github.com/users/mahkoh/orgs",
      "repos_url": "https://api.github.com/users/mahkoh/repos",
      "events_url": "https://api.github.com/users/mahkoh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mahkoh/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-12T23:17:50Z",
    "updated_at": "2015-01-12T23:17:50Z",
    "body": "New code:\n\n``` rust\n#![feature(asm)]\n#![allow(unstable)]\n\nextern crate test;\n\nuse test::{Bencher};\n\n#[inline(never)]\nfn gen() -> Vec<u8> {\n    (0..1024*65).map(|_| 0).collect()\n}\n\n#[bench]\nfn position(b: &mut Bencher) {\n    let v = gen();\n    b.iter(|| {\n        test::black_box(v.as_slice().iter().position(|&c| c == 1));\n    });\n}\n\n#[bench]\nfn iter(b: &mut Bencher) {\n    let v = gen();\n    b.iter(|| {\n        let mut res = None;\n        let mut i = 0us;\n        for &b in v.as_slice().iter() {\n            if b == 1 {\n                res = Some(i);\n                break;\n            }\n            i += 1;\n        }\n        test::black_box(res);\n    });\n}\n\n#[bench]\nfn enumerate(b: &mut Bencher) {\n    let v = gen();\n    b.iter(|| {\n        let mut res = None;\n        for (i, &b) in v.as_slice().iter().enumerate() {\n            if b == 1 {\n                res = Some(i);\n                break;\n            }\n        }\n        test::black_box(res);\n    });\n}\n\n#[bench]\nfn _range(b: &mut Bencher) {\n    let v = gen();\n    b.iter(|| {\n        let mut res = None;\n        for i in (0..v.len()) {\n            if v[i] == 1 {\n                res = Some(i);\n                break;\n            }\n        }\n        test::black_box(res);\n    });\n}\n\n#[bench]\nfn assembly(b: &mut Bencher) {\n    let v = gen();\n    b.iter(|| {\n        unsafe {\n            let mut start = v.as_ptr();\n            let end = start.offset(v.len() as isize);\n            asm!(\"\n                dec $0\n                .align 16, 0x90\n            AGAIN:\n                inc $0\n                cmp $0, $1\n                je EXIT\n                cmpb $$1, ($0)\n                jne AGAIN\n            EXIT:\n                \" : \"+r\"(start) : \"r\"(end));\n            if start < end {\n                test::black_box(Some(start as usize - v.as_ptr() as usize));\n            } else {\n                test::black_box(None::<u8>);\n            }\n        }\n    });\n}\n```\n\nNew results:\n\n```\ntest _range    ... bench:     95373 ns/iter (+/- 734)\ntest assembly  ... bench:     60773 ns/iter (+/- 396)\ntest enumerate ... bench:     95355 ns/iter (+/- 361)\ntest iter      ... bench:     91127 ns/iter (+/- 455)\ntest position  ... bench:     91081 ns/iter (+/- 543)\n```\n\nUnacceptable performance.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/69666625/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
