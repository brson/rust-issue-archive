{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/26027",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/26027/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/26027/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/26027/events",
  "html_url": "https://github.com/rust-lang/rust/pull/26027",
  "id": 85418726,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MzcwMDAzNzI=",
  "number": 26027,
  "title": "Only report Self: Sized violation once.",
  "user": {
    "login": "nham",
    "id": 546409,
    "node_id": "MDQ6VXNlcjU0NjQwOQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/546409?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nham",
    "html_url": "https://github.com/nham",
    "followers_url": "https://api.github.com/users/nham/followers",
    "following_url": "https://api.github.com/users/nham/following{/other_user}",
    "gists_url": "https://api.github.com/users/nham/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nham/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nham/subscriptions",
    "organizations_url": "https://api.github.com/users/nham/orgs",
    "repos_url": "https://api.github.com/users/nham/repos",
    "events_url": "https://api.github.com/users/nham/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nham/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 29,
  "created_at": "2015-06-05T04:34:28Z",
  "updated_at": "2015-07-05T20:40:38Z",
  "closed_at": "2015-07-05T17:12:11Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/26027",
    "html_url": "https://github.com/rust-lang/rust/pull/26027",
    "diff_url": "https://github.com/rust-lang/rust/pull/26027.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/26027.patch",
    "merged_at": null
  },
  "body": "## Background\n\nThe cause of #20692 seems to be in [middle::trait::object_safety::object_safety_violations](https://github.com/rust-lang/rust/blob/7ae4a8e9f3150f62964151ef54b3da3cd24ee123/src/librustc/middle/traits/object_safety.rs#L78-L85). The `supertrait_def_ids` call returns an iterator that iterates over trait definition ids. The iteration seems to start at the current trait and then traverse supertraits in order. For example, in the following block of code, it goes `Bar` -> `Foo` -> `Sized`:\n\n``` rust\ntrait Foo: Sized { }\ntrait Bar: Foo { }\n\nfn foo<T: Bar>(x: &T) {\n    let _ = x as &Bar; //~ ERROR cannot convert to a trait object because trait `Bar` is not object-safe\n}\n\nfn main () {}\n```\n\nHowever for each trait in the hierarchy, `object_safety_violations_in_trait` gets called (in the `.flat_map()` call). Each call (all 3 of them) results in a `Self : Sized` violation since each trait in the hierarchy has `Sized` as a supertrait. That is why the above code compiles with 2 extra notes today:\n\n```\n: rustc 20692.rs\n20692.rs:5:13: 5:14 error: cannot convert to a trait object because trait `Bar` is not object-safe [E0038]\n20692.rs:5     let _ = x as &Bar; //~ ERROR cannot convert to a trait object because trait `Bar` is not object-safe\n                       ^\n20692.rs:5:13: 5:14 note: the trait cannot require that `Self : Sized`\n20692.rs:5     let _ = x as &Bar; //~ ERROR cannot convert to a trait object because trait `Bar` is not object-safe\n                       ^\n20692.rs:5:13: 5:14 note: the trait cannot require that `Self : Sized`\n20692.rs:5     let _ = x as &Bar; //~ ERROR cannot convert to a trait object because trait `Bar` is not object-safe\n                       ^\n20692.rs:5:13: 5:14 note: the trait cannot require that `Self : Sized`\n20692.rs:5     let _ = x as &Bar; //~ ERROR cannot convert to a trait object because trait `Bar` is not object-safe\n                       ^\n```\n## The fix\n\nThe fix I've submitted is to move the `trait_has_sized_self` check out of `object_safety_violations_in_trait` to `object_safety_violations` so it's only called once, and not for each supertrait.\n## How to test?\n\nI need help here. I don't see how to test it. This doesn't work:\n\n``` rust\ntrait Foo: Sized { }\ntrait Bar: Foo { }\n\nfn foo<T: Bar>(x: &T) {\n    let _ = x as &Bar; //~ ERROR cannot convert to a trait object because trait `Foo` is not object-safe\n                       //~^ NOTE the trait cannot require that `Self : Sized`\n}\n\nfn main() {}\n```\n\nPutting this in compile-fail passes without the fix. It seems that this doesn't try to match the number of notes exactly, so even though compilation results in 3 notes emitted today, it matches the one that is expected in the test and ignores the extra error output.\n\nAny advice on how to test this fix?\n\nFixes #20692.\n",
  "closed_by": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/26027/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/26027/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
