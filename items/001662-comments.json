[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3658164",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3658164",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3658164,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NTgxNjQ=",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-01-25T20:17:03Z",
    "updated_at": "2012-01-25T20:18:05Z",
    "body": "I like this. I think though that we don't need the ref count on the port. Right now port lifetime is managed in Rust code with a boxed resource and I think that will still work - and I'd rather have Rust code than C++. Ports do have native ref counts as well but they should be removable.\n\nShould be on the 0.2 milestone.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3658164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3658461",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3658461",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3658461,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NTg0NjE=",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-01-25T20:34:44Z",
    "updated_at": "2012-01-25T20:34:44Z",
    "body": "ok, yes, I think we can avoid the ref count in that case.  \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3658461/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3663218",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3663218",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3663218,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NjMyMTg=",
    "user": {
      "login": "graydon",
      "id": 14097,
      "node_id": "MDQ6VXNlcjE0MDk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/graydon",
      "html_url": "https://github.com/graydon",
      "followers_url": "https://api.github.com/users/graydon/followers",
      "following_url": "https://api.github.com/users/graydon/following{/other_user}",
      "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/graydon/subscriptions",
      "organizations_url": "https://api.github.com/users/graydon/orgs",
      "repos_url": "https://api.github.com/users/graydon/repos",
      "events_url": "https://api.github.com/users/graydon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/graydon/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-01-26T02:10:24Z",
    "updated_at": "2012-01-26T02:10:24Z",
    "body": "I don't think this is quite right. I agree that we can get a lot of work out of the sending path. Currently ... if you count the locks there's probably like 6 or 8 locking operations per send, plus a couple TLS operations. \n\nBut there's integration with scheduling, fairness, lifecycle events, etc. to get right as well. So tread carefully. \"Rewriting from scratch\" is a good way to make everything break. We've had a broken comm system before, and it was really bad. We couldn't trust programs to obey sane communication semantics. The current system is overprotective due to bad experience. I'd prefer you go step-by-step removing overhead-bits you see as unnecessary. Convince yourself they're unnecessary with very clear reasoning, make big ASCII-ART diagrams, try to remove as many concepts as possible, then remove code, patch-at-a-time. \"Rewrite all this crap\" tends to result in us having a broken comms system. Have had such on several occasions.\n\nFor example, maybe you can reason-out that port lifetime is a subset of task lifetime, tasks acquire a lock on each of their ports while destructing, and the send side only ever holds the lock temporarily, so there's no way to get a sending-chan holding a ref to a dead-task. So then you can knock two refcount ops out of the path (ref/unref on ports). Do so, test extensively, land that patch, repeat on the next obvious too-expensive thing (maybe the TLS-based assertions all over the place? :)\n\nMoreover, while removing costs from the send path is good, depositing new costs in the channel-copy path ... should be done with care. I want chan copy to remain mostly cheap, your new design makes them atomic-op expensive. We talked before about a design where a chan is a multi-word structure, say (portid, port_), and the port_ field gets zeroed when you copy a chan. Then on first send on a chan, if port\\* is null the send path looks up portid in a task-local table, +1s the resulting port refcount, and fills in the task local table. This way each sending-task contributes only 1 atomic rc op to the port, and only on the first send from a channel in the task. All other ops are lazy and weak.\n\nAnyway, lifecycle stuff is hard. You want to minimize the number of parties that can block on one another's lifecycle events, and create the smallest amount of zombie structures that have to wait around for someone pointing to them to mop them up. Maybe tombstoned stub ports are acceptable, but be careful. Try not to create a system that breaks its own rules, leaks or races.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3663218/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3698410",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3698410",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3698410,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2OTg0MTA=",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-01-28T05:21:35Z",
    "updated_at": "2012-01-28T05:21:35Z",
    "body": "Just to update what we've been discussing recently. Erlang appears to manage their 'ports' with one giant array (many millions of entries) that maps handle indexes to pointers. They just start at index zero and increase monotonically until they hit the end of the array, then wrap around. No free list or anything. I don't think we understand their locking protocol yet (I haven't looked at it personally). This is attractive in its simplicity, but presents obvious problems when looking at targets with limited resources like android.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3698410/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3701662",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3701662",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3701662,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MDE2NjI=",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-01-28T16:45:16Z",
    "updated_at": "2012-01-28T16:45:16Z",
    "body": "I should add that the analysis of Erlang's behavior is based on a superficial read of the code and could well be wrong.  But I'm reasonably confident.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3701662/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3706126",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3706126",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3706126,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MDYxMjY=",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-01-29T02:38:06Z",
    "updated_at": "2012-01-29T02:38:06Z",
    "body": "One other thing: @graydon pointed out that the source of our inefficiency may well be in the scheduler.  This is certainly true. I've updated the title of this issue accordingly to reflect that what's truly needed is better measurement and appropriate changes.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3706126/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3802699",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3802699",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3802699,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MDI2OTk=",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-02-03T19:28:42Z",
    "updated_at": "2012-02-03T19:28:42Z",
    "body": "I fixed the gross inefficiencies in the scheduler and our message throughput looks much better now.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3802699/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3803580",
    "html_url": "https://github.com/rust-lang/rust/issues/1662#issuecomment-3803580",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1662",
    "id": 3803580,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MDM1ODA=",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2012-02-03T20:15:39Z",
    "updated_at": "2012-02-03T20:15:39Z",
    "body": "I'll close this for now.  There's no doubt more work to be done but at least it's not embarrassing. \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/3803580/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
