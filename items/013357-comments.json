[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39665785",
    "html_url": "https://github.com/rust-lang/rust/issues/13357#issuecomment-39665785",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13357",
    "id": 39665785,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjY1Nzg1",
    "user": {
      "login": "brendanzab",
      "id": 695077,
      "node_id": "MDQ6VXNlcjY5NTA3Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/695077?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brendanzab",
      "html_url": "https://github.com/brendanzab",
      "followers_url": "https://api.github.com/users/brendanzab/followers",
      "following_url": "https://api.github.com/users/brendanzab/following{/other_user}",
      "gists_url": "https://api.github.com/users/brendanzab/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brendanzab/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brendanzab/subscriptions",
      "organizations_url": "https://api.github.com/users/brendanzab/orgs",
      "repos_url": "https://api.github.com/users/brendanzab/repos",
      "events_url": "https://api.github.com/users/brendanzab/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brendanzab/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T11:17:44Z",
    "updated_at": "2014-04-06T11:17:56Z",
    "body": "Here is a use-case: bjz/glfw-rs#132\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39665785/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39674434",
    "html_url": "https://github.com/rust-lang/rust/issues/13357#issuecomment-39674434",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13357",
    "id": 39674434,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njc0NDM0",
    "user": {
      "login": "edwardw",
      "id": 454049,
      "node_id": "MDQ6VXNlcjQ1NDA0OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/454049?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/edwardw",
      "html_url": "https://github.com/edwardw",
      "followers_url": "https://api.github.com/users/edwardw/followers",
      "following_url": "https://api.github.com/users/edwardw/following{/other_user}",
      "gists_url": "https://api.github.com/users/edwardw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/edwardw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/edwardw/subscriptions",
      "organizations_url": "https://api.github.com/users/edwardw/orgs",
      "repos_url": "https://api.github.com/users/edwardw/repos",
      "events_url": "https://api.github.com/users/edwardw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/edwardw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-06T17:35:42Z",
    "updated_at": "2014-04-06T17:37:09Z",
    "body": "`sync::one::Once` uses a `sync::mutex::StaticMutex` internally as guard. One difficulty about a new `fn try(...) -> bool` is that it may never succeeded so the static guard may never be consumed. Is there some sort of global hook I can use to do the cleanup for that `StaticMutex`?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39674434/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39699626",
    "html_url": "https://github.com/rust-lang/rust/issues/13357#issuecomment-39699626",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13357",
    "id": 39699626,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njk5NjI2",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-07T06:30:19Z",
    "updated_at": "2014-04-07T06:30:19Z",
    "body": "I guess that's a consideration, but I don't think it's a huge problem: if `Once`'s closure \"fails\" every time, then it seems rather likely that the program is going to give up and exit relatively quickly (leaving the operating system to clean up anything about the mutexes that it needs to, which is perfectly valid).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39699626/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39703754",
    "html_url": "https://github.com/rust-lang/rust/issues/13357#issuecomment-39703754",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13357",
    "id": 39703754,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NzAzNzU0",
    "user": {
      "login": "lilyball",
      "id": 714,
      "node_id": "MDQ6VXNlcjcxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lilyball",
      "html_url": "https://github.com/lilyball",
      "followers_url": "https://api.github.com/users/lilyball/followers",
      "following_url": "https://api.github.com/users/lilyball/following{/other_user}",
      "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions",
      "organizations_url": "https://api.github.com/users/lilyball/orgs",
      "repos_url": "https://api.github.com/users/lilyball/repos",
      "events_url": "https://api.github.com/users/lilyball/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lilyball/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-07T07:49:54Z",
    "updated_at": "2014-04-07T07:49:54Z",
    "body": "I disagree with this issue. `Once` is a very targeted API, intended for use-cases where 99.9% of calls do nothing. It's convenient for library initialization, but there are plenty of alternatives when you need different behavior, such as using a Mutex and a boolean variable. That replacement would not only have the same semantics as being asked for in this issue, but would have the same performance too (since we're considering a library initialization routine that's only invoked when the caller expects the library hasn't been initialized yet). And it can be done without changing any library API whatsoever.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39703754/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39704764",
    "html_url": "https://github.com/rust-lang/rust/issues/13357#issuecomment-39704764",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13357",
    "id": 39704764,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NzA0NzY0",
    "user": {
      "login": "huonw",
      "id": 1203825,
      "node_id": "MDQ6VXNlcjEyMDM4MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huonw",
      "html_url": "https://github.com/huonw",
      "followers_url": "https://api.github.com/users/huonw/followers",
      "following_url": "https://api.github.com/users/huonw/following{/other_user}",
      "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huonw/subscriptions",
      "organizations_url": "https://api.github.com/users/huonw/orgs",
      "repos_url": "https://api.github.com/users/huonw/repos",
      "events_url": "https://api.github.com/users/huonw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huonw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-07T08:04:19Z",
    "updated_at": "2014-04-07T16:48:23Z",
    "body": "I guess the following works, yeah.\n\n``` rust\nuse sync::mutex::{MUTEX_INIT, StaticMutex};\n\nfn init(x: u32) -> i32 {\n    static mut init_mutex: StaticMutex = MUTEX_INIT;\n    static mut inited: bool = false;\n\n    unsafe {\n        let _guard = init_mutex.lock();\n        if inited { return 0 }\n\n        ret = my_lib_init(x);\n        inited = ret >= 0;\n        ret\n    }\n}\n```\n\nClosing. (If someone feels like this is insufficient, you can reopen/request a reopening.)\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/39704764/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/40164493",
    "html_url": "https://github.com/rust-lang/rust/issues/13357#issuecomment-40164493",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13357",
    "id": 40164493,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMTY0NDkz",
    "user": {
      "login": "brendanzab",
      "id": 695077,
      "node_id": "MDQ6VXNlcjY5NTA3Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/695077?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brendanzab",
      "html_url": "https://github.com/brendanzab",
      "followers_url": "https://api.github.com/users/brendanzab/followers",
      "following_url": "https://api.github.com/users/brendanzab/following{/other_user}",
      "gists_url": "https://api.github.com/users/brendanzab/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brendanzab/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brendanzab/subscriptions",
      "organizations_url": "https://api.github.com/users/brendanzab/orgs",
      "repos_url": "https://api.github.com/users/brendanzab/repos",
      "events_url": "https://api.github.com/users/brendanzab/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brendanzab/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-11T02:09:35Z",
    "updated_at": "2014-04-11T08:30:17Z",
    "body": "Could you have something like:\n\n``` rust\nuse sync::mutex::{MUTEX_INIT, StaticMutex};\n\npub struct TryOnce {\n    mutex: StaticMutex,\n    is_done: bool,\n}\n\npub static TRY_ONCE_INIT: TryOnce = TryOnce {\n    mutex: MUTEX_INIT,\n    is_done: false,\n};\n\nimpl TryOnce {\n    /// Attempt to call `f`.\n    ///\n    /// # Arguments\n    ///\n    /// - `f`: A function that will only be called if `TryOnce::try` has not\n    ///   previously been called successfully.\n    ///   - To indicate that the function call was successful an `OK(_)` value\n    ///     should be returned. This will prevent  all subsequent subsequent\n    ///     calls to `TryOnce::try` from executing `f` and `Some(OK(_))` to be\n    ///     returned.\n    ///   - To indicate that the function call failed an `Err(_)` value should\n    ///     be returned. This will allow `TryOnce::try` to be called again, and\n    ///     will cause `TryOnce::try` to return `Some(Err(_))`.\n    ///\n    /// # Returns\n    ///\n    /// - `Some(_)` if `TryOnce::try` has never been successfully called.\n    /// - `None` if `TryOnce::try` has previously returned `Some(Ok(_))`.\n    ///\n    /// # Example\n    ///\n    /// ~~~rust\n    /// # mod ffi {\n    /// #     pub static FALSE: int = 0;\n    /// #     pub static TRUE:  int = 1;\n    /// #     pub fn init() -> int { TRUE }\n    /// # }\n    ///\n    /// enum InitError {\n    ///     InternalInitError,\n    ///     AlreadyInitialized,\n    /// }\n    ///\n    /// fn init() -> Result<~str, InitError> {\n    ///     static mut INIT: TryOnce = TRY_ONCE_INIT;\n    ///     unsafe {\n    ///         INIT.try(&|| {\n    ///             if ffi::init() == ffi::TRUE {\n    ///                 Ok(~\"hi!\")\n    ///             } else {\n    ///                 Err(InternalInitError)\n    ///             }\n    ///         })\n    ///     }.unwrap_or(Err(AlreadyInitialized))\n    /// }\n    /// ~~~\n    pub fn try<T, E>(&mut self, f: &|| -> Result<T, E>) -> Option<Result<T, E>> {\n        let guard = self.mutex.lock();\n        let result = if self.is_done {\n            None\n        } else {\n            let result = (*f)();\n            self.is_done = result.is_ok();\n            Some(result)\n        };\n        drop(guard);\n        result\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{TRY_ONCE_INIT, TryOnce};\n\n    #[deriving(Eq, Show)]\n    enum InitError {\n        InternalInitError,\n        AlreadyInitialized,\n    }\n\n    #[test]\n    fn test() {\n        static mut INIT: TryOnce = TRY_ONCE_INIT;\n\n        let err: &|| -> Result<~str, InitError> = &|| Err(InternalInitError);\n        let ok:  &|| -> Result<~str, InitError> = &|| Ok(~\"pickles\");\n\n        assert_eq!(unsafe { INIT.try(err) }, Some(Err(InternalInitError)));\n        assert_eq!(unsafe { INIT.try(ok)  }, Some(Ok(~\"pickles\")));\n        assert_eq!(unsafe { INIT.try(err) }, None);\n        assert_eq!(unsafe { INIT.try(ok)  }, None);\n    }\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/40164493/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
