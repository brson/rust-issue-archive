[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/38264622",
    "html_url": "https://github.com/rust-lang/rust/issues/13027#issuecomment-38264622",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13027",
    "id": 38264622,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MjY0NjIy",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-03-21T10:39:55Z",
    "updated_at": "2014-03-21T10:39:55Z",
    "body": "Based on reading PR #13034 and the code, I think the bug is a bug in `enter_opt`, which doesn't properly consider guards and the possible overlap between literals and ranges. However, I don't think the fix in PR #13034 is quite right -- `opt_eq` is not meant to be a general \"might match\" check.\n\nWhat `enter_opt` seems to currently do is to iterate over the list of patterns, given that the given option `opt` matched. So, in the example test case, the state would be that the remaining patterns are:\n1. literal(1) with guard \n2. range(1, 2)\n3. wildcard\n\nand the opt here is `literal(1)`. What `enter_opt` incorrectly does is to consider 1 and 3 a match but not 2. I'm not....100% sure what the intended answer is here actually, and the introduction of a guard makes things more complicated. In particular I don't quite understand where the precedence of earlier matches comes into play.\n\nImagine that there were no guard: in that case, I could imagine the correct answer being just 1, because that match has the highest precedence. But the code doesn't appear to be setup that way, it seems to test each option independently with no regard for order. Therefore I gather that it would yield (in the case with no guard) 1 and 3. And then I think in the next recursion call to `compile_match()`, we would not consider option 3 because it is a \"default\" match. (Ah, I see. What was confusing me is how a match like this would work `match foo { 1 => x, 1 => y, _ => z }`. It seems like we would infinitely recurse because `enter_opt` would always yield both options. But the answer is that we rule these cases out by an earlier check, which reports that the second 1 is unreachable.)\n\nNote: [Marijn's article](http://marijnhaverbeke.nl/hob/saga/pattern_matching.html) may shed some light on the intended workings of the code. For some reason I haven't read it. I'm a glutton for punishment I guess. I really ought to, particularly since he writes so well.\n\nBased on all this, the right fix is... not immediately obvious to me. One option is to have `enter_opt` consider guards and precedence, but as I said that doesn't seem to be what the code is setup to do. Another option is to handle guards early -- right now, if the next option in the list has a guard, we will execute it, but only if the pattern is fully matched. I could imagine trying to test the remaining bits of pattern imperatively and test the guard, but that'd be a whole other code path (it might be one that we want, actually, if we are going to permit overloadable deref in patterns...but that's a separate bug).\n\nHaving `enter_opt` unconditionally consider literals as matching against ranges feels a bit creepy. I think the code would fail to terminate for a test case like `match foo { 1 => ..., 1 => 3 => ... }`. Perhaps if the exhaustiveness check reported an error for this case, but it doesn't. Also, I think there is a related bug that the current patch would not solve, though if we patched up `enter_opt` more thoroughly it might:\n\n```\nmatch 2 { \n    1 .. 3 if false => { ... }\n    1 .. 4 => { ... }\n     _ => { .. }\n }\n```\n\nMy conclusion is thus that the best thing would be to change `enter_opt` to consider guards and precedence, but I want to read marijn's article maybe and see if it offers a 3rd way.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/38264622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/38298671",
    "html_url": "https://github.com/rust-lang/rust/issues/13027#issuecomment-38298671",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13027",
    "id": 38298671,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4Mjk4Njcx",
    "user": {
      "login": "edwardw",
      "id": 454049,
      "node_id": "MDQ6VXNlcjQ1NDA0OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/454049?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/edwardw",
      "html_url": "https://github.com/edwardw",
      "followers_url": "https://api.github.com/users/edwardw/followers",
      "following_url": "https://api.github.com/users/edwardw/following{/other_user}",
      "gists_url": "https://api.github.com/users/edwardw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/edwardw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/edwardw/subscriptions",
      "organizations_url": "https://api.github.com/users/edwardw/orgs",
      "repos_url": "https://api.github.com/users/edwardw/repos",
      "events_url": "https://api.github.com/users/edwardw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/edwardw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-03-21T17:06:34Z",
    "updated_at": "2014-03-21T18:33:57Z",
    "body": "I think I understand the logic of `enter_opt` now. It translates the following:\n\n```\nmatch val {\n    m1 if g1 => b1,\n    m2 => b2,\n    _ => b3\n}\n```\n\nto something like:\n\n```\nif match(val, m1) { b1 or b3 }  // m1 is stricter than m2, so no need to have b2 here\nelse if match(val, m2) { b2 or b3 }\nelse { b3 }\n```\n\nBy the virtue of the fact that we are in `trans` already, `enter_opt` assumes m1 is \"stricter\" than m2 because otherwise compiler should've bailed out with \"unreachable pattern\" error. Unfortunately, \"m1 + guard\" is not necessarily stricter than m2 since guard function may return false.\n\nNote,\n\n```\nmatch val {\n    m1 if g1 => b1,\n    m1 => b2,\n    _ => b3\n}\n```\n\nis translated correctly to:\n\n```\nif match(val, m1) { b1 or b2 or b3 }\nelse { b3 }\n```\n\nbecause we have exact equality of two `m1` here.\n\nSo, we probably need to change the semantic of `opt_eq` to do range overlap, single value + range overlap and  range + single value overlap check after all. A possible optimization is that the extended check is only necessary if there's a guard.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/38298671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/38350915",
    "html_url": "https://github.com/rust-lang/rust/issues/13027#issuecomment-38350915",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13027",
    "id": 38350915,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MzUwOTE1",
    "user": {
      "login": "edwardw",
      "id": 454049,
      "node_id": "MDQ6VXNlcjQ1NDA0OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/454049?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/edwardw",
      "html_url": "https://github.com/edwardw",
      "followers_url": "https://api.github.com/users/edwardw/followers",
      "following_url": "https://api.github.com/users/edwardw/following{/other_user}",
      "gists_url": "https://api.github.com/users/edwardw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/edwardw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/edwardw/subscriptions",
      "organizations_url": "https://api.github.com/users/edwardw/orgs",
      "repos_url": "https://api.github.com/users/edwardw/repos",
      "events_url": "https://api.github.com/users/edwardw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/edwardw/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-03-22T13:04:32Z",
    "updated_at": "2014-03-22T13:04:32Z",
    "body": "I've revised #13034. It now only touches `enter_opt` and passes a more comprehensive test. It also fixes #12582. Please review.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/38350915/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
