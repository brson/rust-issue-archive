[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41639919",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-41639919",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 41639919,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjM5OTE5",
    "user": {
      "login": "lifthrasiir",
      "id": 323836,
      "node_id": "MDQ6VXNlcjMyMzgzNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/323836?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lifthrasiir",
      "html_url": "https://github.com/lifthrasiir",
      "followers_url": "https://api.github.com/users/lifthrasiir/followers",
      "following_url": "https://api.github.com/users/lifthrasiir/following{/other_user}",
      "gists_url": "https://api.github.com/users/lifthrasiir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lifthrasiir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lifthrasiir/subscriptions",
      "organizations_url": "https://api.github.com/users/lifthrasiir/orgs",
      "repos_url": "https://api.github.com/users/lifthrasiir/repos",
      "events_url": "https://api.github.com/users/lifthrasiir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lifthrasiir/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-29T04:04:38Z",
    "updated_at": "2014-04-29T04:04:38Z",
    "body": "This change would also mean that the \"key\" suffix commonly attached to the TLS data is no longer appropriate.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41639919/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41640910",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-41640910",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 41640910,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjQwOTEw",
    "user": {
      "login": "bill-myers",
      "id": 4647491,
      "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bill-myers",
      "html_url": "https://github.com/bill-myers",
      "followers_url": "https://api.github.com/users/bill-myers/followers",
      "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
      "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
      "organizations_url": "https://api.github.com/users/bill-myers/orgs",
      "repos_url": "https://api.github.com/users/bill-myers/repos",
      "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bill-myers/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-29T04:35:01Z",
    "updated_at": "2014-04-29T04:41:09Z",
    "body": "Is there a reason to keep get_mut and borrow tracking in there, as opposed to only having a get() and having the user use RefCell or Cell if they want mutability?\n\nI think the code (which seems to have semantics equivalent to RefCell) was originally written before RefCell was introduced, and a change like this would be the time to revisit this.\n\nEDIT: hmm, thinking more about it, the naive implementation doesn't seem quite possible due to key insertion and removal; but maybe it can at least use RefCell internally?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41640910/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41641076",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-41641076",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 41641076,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjQxMDc2",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-29T04:39:26Z",
    "updated_at": "2014-04-29T04:39:26Z",
    "body": "That's an interesting idea! That makes sense to me as the best course of action to take.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41641076/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41642315",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-41642315",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 41642315,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjQyMzE1",
    "user": {
      "login": "bill-myers",
      "id": 4647491,
      "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bill-myers",
      "html_url": "https://github.com/bill-myers",
      "followers_url": "https://api.github.com/users/bill-myers/followers",
      "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
      "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
      "organizations_url": "https://api.github.com/users/bill-myers/orgs",
      "repos_url": "https://api.github.com/users/bill-myers/repos",
      "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bill-myers/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-29T05:17:15Z",
    "updated_at": "2014-04-29T05:34:59Z",
    "body": "So, looking more deeply at this, the key insight is that the code boxes all values in ~T as ~LocalData: this seems to be a fundamental requirement, both due to destruction and due to the fact that otherwise enlarging the map would invalidate all borrowed pointers, resulting in memory unsafety.\n\nSo what could be done is replacing the ~T with an Rc<T> and thus have an API providing the ability to get/set the Rc<T> (or possibly a Weak<T>, using a WeakKey key type).\n\nInternally, it should be stored as Rc<LocalData>; that's impossible without DST, but it should be possible to get equivalent results manually by storing a transmuted Rc<T> to uint plus a bare function that destroys it.\n\nThe user can then use RefCell for mutability; using RefCell internally instead just wastes memory because you can no longer combine the refcnt with the borrow flags, so it's actually not such a good idea.\n\nWith this design, one could also trivially use pthread_getspecific/pthread_setspecific with native tasks, by passing the transmuted Rc<T> there, and the destructor bare function to pthread_key_create.\n\nI'm not quite sure if this would be an improvement though, because it uses more memory, due to the refcnt and borrow flags being split (in case the user uses RefCell), and Rc also having a weak count (but with the advantage that TLS lookup and borrowing is decoupled, and that you can have weak references to the TLS boxed data).\n\nAt any rate, there should probably be a separate key type that just provides get/set of an uint, without the need of any extra allocation, reference counting or borrowing.\n\nA key type providing get/set of an Option<~T>, setting it to None on get, is also a possibility.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41642315/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41642921",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-41642921",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 41642921,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjQyOTIx",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-29T05:32:40Z",
    "updated_at": "2014-04-29T05:32:53Z",
    "body": "This PR is focused on getting the API right. There are many shortcomings of the implementation, primarily being that a lookup is a linear scan in a task-local array. I don't think that micro-optimizing this implementation is going to be worth it unless it comes close to native TLS.\n\nI'm still musing over whether to expose mutability as part of the API. So long as borrows are supported, it seems to make sense to go ahead and expose mutable borrows. If you've got the flag you may as well use it.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41642921/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41643576",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-41643576",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 41643576,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjQzNTc2",
    "user": {
      "login": "bill-myers",
      "id": 4647491,
      "node_id": "MDQ6VXNlcjQ2NDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4647491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bill-myers",
      "html_url": "https://github.com/bill-myers",
      "followers_url": "https://api.github.com/users/bill-myers/followers",
      "following_url": "https://api.github.com/users/bill-myers/following{/other_user}",
      "gists_url": "https://api.github.com/users/bill-myers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bill-myers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bill-myers/subscriptions",
      "organizations_url": "https://api.github.com/users/bill-myers/orgs",
      "repos_url": "https://api.github.com/users/bill-myers/repos",
      "events_url": "https://api.github.com/users/bill-myers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bill-myers/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-29T05:49:06Z",
    "updated_at": "2014-04-29T06:02:16Z",
    "body": "Even more general and simpler solution: provide two key types, parameterized by T, with the constraint that `sizeof(T) <= sizeof(uint)` (which I think unfortunately requires adding a builtin kind to the compiler to express).\n\nThe first key type requires Clone, clones on get and provides a set, and would typically be used with Rc<T>, Rc<Cell<T>> or Rc<RefCell<T>> or with uint; the second key type only provides a swap operation instead of get, and would typically be used with Option<~T> (and in fact might be omitted, since it's of limited use).\n\nThe values would be internally transmuted to uint and stored along with a bare function destructor either in an ad-hoc structure or passed to pthread_setspecific or similar native APIs (the size restriction allows to do the latter, as well as storing it unboxed in a map).\n\nEDIT: unfortunately the Clone-based key is unsound in general, because clone() may remove the TLS key; hence, the class needs to be private, and only specializations for Rc, Arc and other \"well-behaved\" types, plus a version for generic T: Copy should be exposed publicly (and eventually an effect system could be added, allowing to require clone to be free of side effects and eliminate the hack).\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41643576/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41714158",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-41714158",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 41714158,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNzE0MTU4",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-04-29T18:27:39Z",
    "updated_at": "2014-04-29T18:27:39Z",
    "body": "I have pushed a change which combines `pop` and `set` into one method, `replace`, and the `get_mut` method was also removed.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/41714158/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42230364",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-42230364",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 42230364,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjMwMzY0",
    "user": {
      "login": "seanmonstar",
      "id": 51479,
      "node_id": "MDQ6VXNlcjUxNDc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/51479?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/seanmonstar",
      "html_url": "https://github.com/seanmonstar",
      "followers_url": "https://api.github.com/users/seanmonstar/followers",
      "following_url": "https://api.github.com/users/seanmonstar/following{/other_user}",
      "gists_url": "https://api.github.com/users/seanmonstar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/seanmonstar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/seanmonstar/subscriptions",
      "organizations_url": "https://api.github.com/users/seanmonstar/orgs",
      "repos_url": "https://api.github.com/users/seanmonstar/repos",
      "events_url": "https://api.github.com/users/seanmonstar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/seanmonstar/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-05T19:49:55Z",
    "updated_at": "2014-05-05T19:49:55Z",
    "body": "Bump?\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42230364/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42393229",
    "html_url": "https://github.com/rust-lang/rust/pull/13835#issuecomment-42393229",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/13835",
    "id": 42393229,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMzkzMjI5",
    "user": {
      "login": "pcwalton",
      "id": 157897,
      "node_id": "MDQ6VXNlcjE1Nzg5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pcwalton",
      "html_url": "https://github.com/pcwalton",
      "followers_url": "https://api.github.com/users/pcwalton/followers",
      "following_url": "https://api.github.com/users/pcwalton/following{/other_user}",
      "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions",
      "organizations_url": "https://api.github.com/users/pcwalton/orgs",
      "repos_url": "https://api.github.com/users/pcwalton/repos",
      "events_url": "https://api.github.com/users/pcwalton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pcwalton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2014-05-07T06:19:03Z",
    "updated_at": "2014-05-07T06:19:03Z",
    "body": ":metal:\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/42393229/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
