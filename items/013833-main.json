{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/13833",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/13833/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/13833/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/13833/events",
  "html_url": "https://github.com/rust-lang/rust/pull/13833",
  "id": 32411551,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTUyNjg1NDk=",
  "number": 13833,
  "title": "rustc: Enable -f{function,data}-sections",
  "user": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 4,
  "created_at": "2014-04-29T00:43:54Z",
  "updated_at": "2014-06-13T15:22:40Z",
  "closed_at": "2014-04-30T00:36:46Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/13833",
    "html_url": "https://github.com/rust-lang/rust/pull/13833",
    "diff_url": "https://github.com/rust-lang/rust/pull/13833.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/13833.patch",
    "merged_at": null
  },
  "body": "The compiler has previously been producing binaries on the order of 1.8MB for\nhello world programs \"fn main() {}\". This is largely a result of the compilation\nmodel used by compiling entire libraries into a single object file and because\nstatic linking is favored by default.\n\nWhen linking, linkers will pull in the entire contents of an object file if any\nsymbol from the object file is used. This means that if any symbol from a rust\nlibrary is used, the entire library is pulled in unconditionally, regardless of\nwhether the library is used or not.\n\nTraditional C/C++ projects do not normally encounter these large executable\nproblems because their archives (rust's rlibs) are composed of many objects.\nBecause of this, linkers can eliminate entire objects from being in the final\nexecutable. With rustc, however, the linker does not have the opportunity to\nleave out entire object files.\n\nIn order to get similar benefits from dead code stripping at link time, this\ncommit enables the -ffunction-sections and -fdata-sections flags in LLVM, as\nwell as passing --gc-sections to the linker _by default_. This means that each\nfunction and each global will be placed into its own section, allowing the\nlinker to GC all unused functions and data symbols.\n\nBy enabling these flags, rust is able to generate much smaller binaries default.\nOn linux, a hello world binary went from 1.8MB to 597K (a 67% reduction in\nsize). The output size of dynamic libraries remained constant, but the output\nsize of rlibs increased, as seen below:\n\n```\nlibarena       -  2.27% bigger\nlibcollections -  0.64% bigger\nlibflate       -  0.85% bigger\nlibfourcc      - 14.67% bigger\nlibgetopts     -  4.52% bigger\nlibglob        -  2.74% bigger\nlibgreen       -  9.68% bigger\nlibhexfloat    - 13.68% bigger\nliblibc        - 10.79% bigger\nliblog         - 10.95% bigger\nlibnative      -  8.34% bigger\nlibnum         -  2.31% bigger\nlibrand        -  1.71% bigger\nlibregex       -  6.43% bigger\nlibrustc       -  4.21% bigger\nlibrustdoc     -  8.98% bigger\nlibrustuv      -  4.11% bigger\nlibsemver      -  2.68% bigger\nlibserialize   -  1.92% bigger\nlibstd         -  3.59% bigger\nlibsync        -  3.96% bigger\nlibsyntax      -  4.96% bigger\nlibterm        - 13.96% bigger\nlibtest        -  6.03% bigger\nlibtime        -  2.86% bigger\nliburl         -  6.59% bigger\nlibuuid        -  4.70% bigger\nlibworkcache   -  8.44% bigger\n```\n\nThis increase in size is a result of encoding many more section names into each\nobject file (rlib). These increases are moderate enough that this change seems\nworthwhile to me, due to the drastic improvements seen in the final artifacts.\nThe overall increase of the stage2 target folder (not the size of an install)\nwent from 337MB to 348MB (3% increase).\n\nAdditionally, linking is generally slower when executed with all these new\nsections plus the --gc-sections flag. The stage0 compiler takes 1.4s to link the\n`rustc` binary, where the stage1 compiler takes 1.9s to link the binary. Three\nmegabytes are shaved off the binary. I found this increase in link time to be\nacceptable relative to the benefits of code size gained.\n\nThis commit only enables --gc-sections for _executables_, not dynamic libraries.\nLLVM does all the heavy lifting when producing an object file for a dynamic\nlibrary, so there is little else for the linker to do (remember that we only\nhave one object file).\n\nI conducted similar experiments by putting a _module's_ functions and data\nsymbols into its own section (granularity moved to a module level instead of a\nfunction/static level). The size benefits of a hello world were seen to be on\nthe order of 400K rather than 1.2MB. It seemed that enough benefit was gained\nusing ffunction-sections that this route was less desirable, despite the lesser\nincreases in binary rlib size.\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/13833/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/13833/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
