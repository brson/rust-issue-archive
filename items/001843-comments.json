[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19919960",
    "html_url": "https://github.com/rust-lang/rust/issues/1843#issuecomment-19919960",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1843",
    "id": 19919960,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTE5OTYw",
    "user": {
      "login": "pnkfelix",
      "id": 173127,
      "node_id": "MDQ6VXNlcjE3MzEyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pnkfelix",
      "html_url": "https://github.com/pnkfelix",
      "followers_url": "https://api.github.com/users/pnkfelix/followers",
      "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}",
      "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions",
      "organizations_url": "https://api.github.com/users/pnkfelix/orgs",
      "repos_url": "https://api.github.com/users/pnkfelix/repos",
      "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pnkfelix/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-24T16:54:44Z",
    "updated_at": "2013-06-24T16:54:44Z",
    "body": "@brson what is this bug asking for, more specifically?\n- Which particular lint check is it referring to?  I've looked through `librustc/midde/lint.rs` and cannot find anything that seems to match this description.  (I also checked out the code circa one year ago and did not see anything obvious.)\n- I know that the syntax for defined a so-called \"crust\" function has changed significantly in the past year.  It looks like the appropriate way to do it at the moment is: `extern \"Rust\" fn`.  (The crust use-case needs to be documented, at least in the FFI tutorial.)\n- Most odd of all, it seems like we have a uniform syntax for associating calling conventions with particular function pointers, but we do not seem to properly support using it.  (I elaborate more on this below.)\n\nIt also looks like and that there are some hidden gotcha's that need to be addressed, like the following:\n\n(In these examples, I am linking to a simple object file whose C source, `ntwice.c`, is below as well.) \n\nThe first example compiles, but something is wrong with the calling convention, and it produces the wrong answer:\n\n``` rust\ntype c_int = ::std::libc::c_int;\n\nmod ntwice {\n    type c_int = ::std::libc::c_int;\n\n    #[abi = \"cdecl\"]\n    pub extern {\n        fn twice(tf: *u8, x: c_int) -> c_int;\n        fn callback(rf: *u8, // <===== no decl for callback\n                    x: c_int) -> c_int;\n    }\n}\n\nextern fn incr2(x:c_int) -> c_int { x+2 }\n\nextern \"Rust\" // <===== extern decl; none given for `callback` param `rf`.\nfn rtwice(f: extern \"C\" fn(c_int) -> c_int, x: c_int) -> c_int {\n    println(fmt!(\"---- Rust rtwice calling f(%?)\", x));\n    let ret = f(f(x));\n    println(fmt!(\"---- Rust rtwice calling f(%?) => %?\", x, ret));\n    ret\n}\n\nfn main() {\n    println(\"Hello world\");\n    unsafe {\n        let x = ntwice::twice(incr2, 3);\n        println(fmt!(\"Rust ntwice::twice(incr2, 3): %?\", x));\n        let y = ntwice::callback(rtwice, 4);\n        println(fmt!(\"Rust ntwice::callback(rtwice, 4): %?\", y));\n    }\n}\n\n```\n\n```\n+ rustc --link-args ntwice.o play-foreign.rs\n+ ./play-foreign\nHello world\n-- C twice calling f(3)\n-- C twice done w/ f(3) => 7\nRust ntwice::twice(incr2, 3): 7\n-- C callback calling rtwice(incr3, 4)\n---- Rust rtwice calling f(4)\n------ C Enter incr3(f, 120493568)\n------ C Finis incr3(f, 120493568) => 120493571\n------ C Enter incr3(f, 1283)\n------ C Finis incr3(f, 1283) => 1286\n---- Rust rtwice calling f(4) => 1286\n-- C callback done w/ rtwice(incr3, 4) => 1286\nRust ntwice::callback(rtwice, 4): 1286\n```\n\nThis second example also compiles, but something again goes wrong with the calling convention, and it segfaults on my machine:\n\n``` rust\ntype c_int = ::std::libc::c_int;\n\nmod ntwice {\n    type c_int = ::std::libc::c_int;\n\n    #[abi = \"cdecl\"]\n    pub extern {\n        fn twice(tf: *u8, x: c_int) -> c_int;\n        // a \"real\" decl for callback\n        fn callback(rf: extern \"Rust\" fn(extern \"C\" fn(c_int) -> c_int,\n                                         x: c_int) -> c_int,\n                    x: c_int) -> c_int;\n    }\n}\n\nextern fn incr2(x:c_int) -> c_int { x+2 }\n\n// <===== no extern decl, unlike `callback` param `rf`.\nfn rtwice(f: extern \"C\" fn(c_int) -> c_int, x: c_int) -> c_int {\n    println(fmt!(\"---- Rust rtwice calling f(%?)\", x));\n    let ret = f(f(x));\n    println(fmt!(\"---- Rust rtwice calling f(%?) => %?\", x, ret));\n    ret\n}\n\nfn main() {\n    println(\"Hello world\");\n    unsafe {\n        let x = ntwice::twice(incr2, 3);\n        println(fmt!(\"Rust ntwice::twice(incr2, 3): %?\", x));\n        let y = ntwice::callback(rtwice, 4);\n        println(fmt!(\"Rust ntwice::callback(rtwice, 4): %?\", y));\n    }\n}\n```\n\n```\n+ rustc --link-args ntwice.o play-foreign2.rs\n+ ./play-foreign2\nHello world\n-- C twice calling f(3)\n-- C twice done w/ f(3) => 7\nRust ntwice::twice(incr2, 3): 7\n-- C callback calling rtwice(incr3, 4)\n---- Rust rtwice calling f(2104208)\n./test-play-foreign.sh: line 14: 47675 Segmentation fault: 11  ./play-foreign2\n```\n\nThis third example fails to compile, I assume because a fn item prefixed by `extern \"Rust\"` is treated as having the type `*u8`; it would be better if we could have it carry around the more elaborate type that is reported by `rustc` that is assigned to the parameter `f`\n\n``` rust\ntype c_int = ::std::libc::c_int;\n\nmod ntwice {\n    type c_int = ::std::libc::c_int;\n\n    #[abi = \"cdecl\"]\n    pub extern {\n        fn twice(tf: *u8, x: c_int) -> c_int;\n        // a \"real\" decl for callback\n        fn callback(rf: extern \"Rust\" fn(extern \"C\" fn(c_int) -> c_int,\n                                         x: c_int) -> c_int,\n                    x: c_int) -> c_int;\n    }\n}\n\nextern fn incr2(x:c_int) -> c_int { x+2 }\n\nextern \"Rust\" // <===== extern decl matches that of `callback` param `rf`.\nfn rtwice(f: extern \"C\" fn(c_int) -> c_int, x: c_int) -> c_int {\n    println(fmt!(\"---- Rust rtwice calling f(%?)\", x));\n    let ret = f(f(x));\n    println(fmt!(\"---- Rust rtwice calling f(%?) => %?\", x, ret));\n    ret\n}\n\nfn main() {\n    println(\"Hello world\");\n    unsafe {\n        let x = ntwice::twice(incr2, 3);\n        println(fmt!(\"Rust ntwice::twice(incr2, 3): %?\", x));\n        let y = ntwice::callback(rtwice, 4);\n        println(fmt!(\"Rust ntwice::callback(rtwice, 4): %?\", y));\n    }\n}\n```\n\n```\n+ rustc --link-args ntwice.o play-foreign3.rs\nplay-foreign3.rs:30:33: 30:39 error: mismatched types: expected `extern \"Rust\" fn(extern \"C\" fn(i32) -> i32, i32) -> i32` but found `*u8` (expected extern fn but found *-ptr)\nplay-foreign3.rs:30         let y = ntwice::callback(rtwice, 4);\n                                                     ^~~~~~\nerror: aborting due to previous error\n```\n\n`ntwice.c`:\n\n``` c\n#include <stdio.h>\n\nint twice(int (*f)(int), int x) {\n    int ret, arg;\n    printf(\"-- C twice calling f(%d)\\n\", x);\n    ret = f(f(x));\n    printf(\"-- C twice done w/ f(%d) => %d\\n\", x, ret);\n    return ret;\n}\n\nint incr3(int x) {\n    int ret;\n    printf(\"------ C Enter incr3(f, %d)\\n\", x);\n    ret = x + 3;\n    printf(\"------ C Finis incr3(f, %d) => %d\\n\", x, ret);\n    return ret;\n}\n\nint callback(int (*rtwice)(int (*f)(int), int x), int x) {\n    int ret;\n    printf(\"-- C callback calling rtwice(incr3, %d)\\n\", x);\n    ret = rtwice(incr3, x);\n    printf(\"-- C callback done w/ rtwice(incr3, %d) => %d\\n\", x, ret);\n    return ret;\n}\n```\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/19919960/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/20179415",
    "html_url": "https://github.com/rust-lang/rust/issues/1843#issuecomment-20179415",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1843",
    "id": 20179415,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIwMTc5NDE1",
    "user": {
      "login": "pnkfelix",
      "id": 173127,
      "node_id": "MDQ6VXNlcjE3MzEyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pnkfelix",
      "html_url": "https://github.com/pnkfelix",
      "followers_url": "https://api.github.com/users/pnkfelix/followers",
      "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}",
      "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions",
      "organizations_url": "https://api.github.com/users/pnkfelix/orgs",
      "repos_url": "https://api.github.com/users/pnkfelix/repos",
      "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pnkfelix/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-06-28T09:49:59Z",
    "updated_at": "2013-06-28T09:49:59Z",
    "body": "brson did write a recent mailing list post answering some FFI questions and noting current hacks versus long term plans, see: https://mail.mozilla.org/pipermail/rust-dev/2013-May/004107.html\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/20179415/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23166053",
    "html_url": "https://github.com/rust-lang/rust/issues/1843#issuecomment-23166053",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1843",
    "id": 23166053,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzMTY2MDUz",
    "user": {
      "login": "pnkfelix",
      "id": 173127,
      "node_id": "MDQ6VXNlcjE3MzEyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pnkfelix",
      "html_url": "https://github.com/pnkfelix",
      "followers_url": "https://api.github.com/users/pnkfelix/followers",
      "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}",
      "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions",
      "organizations_url": "https://api.github.com/users/pnkfelix/orgs",
      "repos_url": "https://api.github.com/users/pnkfelix/repos",
      "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pnkfelix/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-23T14:11:49Z",
    "updated_at": "2013-08-23T14:11:49Z",
    "body": "visiting for bug triage, email 2013-08-19.\n\nI don't think the questions I posted to brson have been answered.  To be fair, I haven't taken the time to try to distill my questions down to a single three line example, so its okay that they haven't been answered.\n\nBut nonetheless, I don't know how to categorize this ticket without more information.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23166053/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23171399",
    "html_url": "https://github.com/rust-lang/rust/issues/1843#issuecomment-23171399",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1843",
    "id": 23171399,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzMTcxMzk5",
    "user": {
      "login": "nikomatsakis",
      "id": 155238,
      "node_id": "MDQ6VXNlcjE1NTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nikomatsakis",
      "html_url": "https://github.com/nikomatsakis",
      "followers_url": "https://api.github.com/users/nikomatsakis/followers",
      "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}",
      "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions",
      "organizations_url": "https://api.github.com/users/nikomatsakis/orgs",
      "repos_url": "https://api.github.com/users/nikomatsakis/repos",
      "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nikomatsakis/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-23T15:33:25Z",
    "updated_at": "2013-08-23T15:33:25Z",
    "body": "A lot of this has changed with my recent pushes, but I think what @brson was referring to specifically was the lint that checks that people do not use `int` or `uint` in extern fn declarations. The purpose of this lint is because `int` in C is (typically) always 32 bits, whereas in Rust it varies depending on the target architecture. So we encourage people to write either `c_int` or `uintptr_t`, depending on what they wanted.\n\nMany of your other questions, specifically regarding the ABI of extern fns and the like, aren't relevant to this bug per se, but I think that they _ought_ to work now. \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/23171399/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/27013643",
    "html_url": "https://github.com/rust-lang/rust/issues/1843#issuecomment-27013643",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1843",
    "id": 27013643,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MDEzNjQz",
    "user": {
      "login": "catamorphism",
      "id": 427212,
      "node_id": "MDQ6VXNlcjQyNzIxMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/catamorphism",
      "html_url": "https://github.com/catamorphism",
      "followers_url": "https://api.github.com/users/catamorphism/followers",
      "following_url": "https://api.github.com/users/catamorphism/following{/other_user}",
      "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions",
      "organizations_url": "https://api.github.com/users/catamorphism/orgs",
      "repos_url": "https://api.github.com/users/catamorphism/repos",
      "events_url": "https://api.github.com/users/catamorphism/events{/privacy}",
      "received_events_url": "https://api.github.com/users/catamorphism/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-10-24T17:42:40Z",
    "updated_at": "2013-10-24T17:42:40Z",
    "body": "Low priority, no milestone\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/27013643/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70698982",
    "html_url": "https://github.com/rust-lang/rust/issues/1843#issuecomment-70698982",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/1843",
    "id": 70698982,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNjk4OTgy",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-01-20T17:50:44Z",
    "updated_at": "2015-01-20T17:50:44Z",
    "body": "> The purpose of this lint is because int in C is (typically) always 32 bits, whereas in Rust it varies depending on the target architecture. \n\noh noooooooooo :wink: \n\nI think this ticket is old enough to be completely outdated, especially with the changes to `int`. If I'm wrong, please re-open.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/70698982/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
