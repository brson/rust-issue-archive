[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22512316",
    "html_url": "https://github.com/rust-lang/rust/issues/8340#issuecomment-22512316",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8340",
    "id": 22512316,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNTEyMzE2",
    "user": {
      "login": "toddaaro",
      "id": 366431,
      "node_id": "MDQ6VXNlcjM2NjQzMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/366431?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/toddaaro",
      "html_url": "https://github.com/toddaaro",
      "followers_url": "https://api.github.com/users/toddaaro/followers",
      "following_url": "https://api.github.com/users/toddaaro/following{/other_user}",
      "gists_url": "https://api.github.com/users/toddaaro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/toddaaro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/toddaaro/subscriptions",
      "organizations_url": "https://api.github.com/users/toddaaro/orgs",
      "repos_url": "https://api.github.com/users/toddaaro/repos",
      "events_url": "https://api.github.com/users/toddaaro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/toddaaro/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-12T17:59:10Z",
    "updated_at": "2013-08-12T17:59:10Z",
    "body": "This is the design I have been thinking about over the weekend:\n\n1) A SchedHandle stops holding a \"new\" callback to ping. Instead it includes a reference to a singleton idle callback in the scheduler struct.\n\n2) The Scheduler struct gains a new field, an atomic boolean that represents the \"pending callback\" state of the scheduler.\n\n3) The new path to ping the singleton callback first checks this atomic boolean. If there is already an idle callback pending the value will be \"true\" and the callback ping is skipped. If the value is false, it means that a callback ping needs to be sent. The flag is CASed to true, and the pinger that successfully does CAS does the callback registration.\n\n4) The first step in run_sched_once is to set the flag to false, as there is no callback pending as the scheduler is active. If the scheduler decides to send itself a callback it uses the same path as (3). \n\nThis should be safe, as the CAS on the atomic boolean guarantees that only one thread uses the callback at a time, and the way a scheduler is destructed is by waiting until the handles are done, so the handle can't outlive the callback it points to.\n\nOne tricky situation is where a thread can decide to send a callback right as the run_sched_once function starts, observe the flag as 'true', and skip the callback. The scheduler could then swap the flag to 'false' \"missing\" that attempted callback registration. As long as the scheduler can send itself a callback when there is more work to do this should be a non-issue, but we need to make sure we can answer that question correctly.\n\nI don't think the ABA problem will be an issue here. If it is, we can use an atomic uint instead and do n%2 to find a boolean value. The extra bits just provide a \"count\" of where we are so ABA issues go away.\n\nThis should be very performant, as the absolute minimum amount of work is done. No extra callbacks are registered, and no allocation is required to make a \"new\" callback. There is one atomic memory operation per callback attempt, one callback object, and callbacks are only pinged when there isn't already one pending.\n\nThe major design question is whether or not the flag is required. Libuv might be doing something equivalent internally, making this atomic op redundant. It does hold two roles though, both protecting the single callback object from concurrent use, and also eliminating \"duplicate\" callbacks. Libuv likely doesn't do both of these things, so it is very likely we should use the flag.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22512316/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22512860",
    "html_url": "https://github.com/rust-lang/rust/issues/8340#issuecomment-22512860",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8340",
    "id": 22512860,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNTEyODYw",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-12T18:07:54Z",
    "updated_at": "2013-08-12T18:08:09Z",
    "body": "My comments from IRC:\n\n11:04 @brson toddaaro: this description seems to mix the idle and async callbacks, sugesting that the idle callback is registered from another thread, which can't happen.\n               SchedHandles use async callbacks to wake up the scheduler remotely, for which you might use atomics to short-circuit, and idle callbacks are for running the\n               scheduler locally\n11:04 -!- ecr [Thunderbir@moz-BBE3ABD.mv.mozilla.com] has joined #rust\n11:06 @brson toddaaro: there are two distinct optimizations to make here: 1) stop running the idle callback so much and 2) stop firing async callbacks when they aren't needed\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22512860/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22516005",
    "html_url": "https://github.com/rust-lang/rust/issues/8340#issuecomment-22516005",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8340",
    "id": 22516005,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyNTE2MDA1",
    "user": {
      "login": "toddaaro",
      "id": 366431,
      "node_id": "MDQ6VXNlcjM2NjQzMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/366431?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/toddaaro",
      "html_url": "https://github.com/toddaaro",
      "followers_url": "https://api.github.com/users/toddaaro/followers",
      "following_url": "https://api.github.com/users/toddaaro/following{/other_user}",
      "gists_url": "https://api.github.com/users/toddaaro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/toddaaro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/toddaaro/subscriptions",
      "organizations_url": "https://api.github.com/users/toddaaro/orgs",
      "repos_url": "https://api.github.com/users/toddaaro/repos",
      "events_url": "https://api.github.com/users/toddaaro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/toddaaro/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-12T18:51:46Z",
    "updated_at": "2013-08-12T18:52:07Z",
    "body": "Paraphrasing some IRC:\ntoddaaro: while distinct, they have roughly the same purpose so it would be nice to optimize them together somehow\nbrson: adding atomic synchronization cost to idle callbacks would be pretty bad\ntoddaaro: I'll ponder and figure out a dance that doesn't\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22516005/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22804963",
    "html_url": "https://github.com/rust-lang/rust/issues/8340#issuecomment-22804963",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/8340",
    "id": 22804963,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyODA0OTYz",
    "user": {
      "login": "toddaaro",
      "id": 366431,
      "node_id": "MDQ6VXNlcjM2NjQzMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/366431?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/toddaaro",
      "html_url": "https://github.com/toddaaro",
      "followers_url": "https://api.github.com/users/toddaaro/followers",
      "following_url": "https://api.github.com/users/toddaaro/following{/other_user}",
      "gists_url": "https://api.github.com/users/toddaaro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/toddaaro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/toddaaro/subscriptions",
      "organizations_url": "https://api.github.com/users/toddaaro/orgs",
      "repos_url": "https://api.github.com/users/toddaaro/repos",
      "events_url": "https://api.github.com/users/toddaaro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/toddaaro/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2013-08-17T03:46:38Z",
    "updated_at": "2013-08-17T03:46:38Z",
    "body": "Closed by PR #8566 \n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/22804963/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
