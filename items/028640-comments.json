[
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143132658",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-143132658",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 143132658,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzEzMjY1OA==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-25T05:44:07Z",
    "updated_at": "2015-09-25T05:44:07Z",
    "body": "This is actually largely all expected behavior depending on how you look at it! For the first part, it looks like the entry in `LC_LOAD_DYLIB` is the same as the dylib's `LC_ID_DYLIB` directive. This is set via the `-install_name` flag to the linker, but because the compiler doesn't leverage the option the name defaults to `-o`:\n\n```\n     -install_name name\n                 Sets an internal \"install path\" (LC_ID_DYLIB) in a dynamic\n                 library. Any clients linked against the library will record\n                 that path as the way dyld should locate this library.  If\n                 this option is not specified, then the -o path will be\n                 used.  This option is also called -dylib_install_name for\n                 compatibility.\n```\n\nSo to \"fix\" this we'd want to pass `-install_name` to all our linker invocations. Note that we're currently intentionally not using rpath or other feature (although it's debatable as to whether we should!).\n\nDo you know if there's a benefit (beyond looking nicer) to doing this? It looks like we wouldn't necessarily get any concrete benefit, but I'm certainly no expert in this area!\n\nFor the second part, this is actually a little subtle with dylib generation and how we call the linker. Due to the way linkage in Rust work we continually link dylibs downstream instead of just linking them once, so when the `rustc` binary is generated it's linked (via `-l`) to all the upstream dylibs (e.g. all the libs you're seeing). The linker appears to assume that all dynamic libraries must be linked, so it emits `LC_LOAD_DYLIB` sections for all of them.\n\nNow we also pass the `-dead_strip` flag to the linker which also allows stripping unused dynamic libraries, except that we don't actually generate any dynamic libraries that can be stripped because we don't pass this option:\n\n```\n     -mark_dead_strippable_dylib\n                 Specifies that the dylib being built can be dead strip by\n                 any client.  That is, the dylib has no initialization side\n                 effects.  So if a client links against the dylib, but never\n                 uses any symbol from it, the linker can optimize away the\n                 use of the dylib.\n```\n\nThe clause there about no initialization side effects makes me wary that we'd want to start passing it because a statically linked native library may have side effects (even though no Rust code does). Like the previous point, though, do you know of any concrete benefits of enabling dead stripping of dylibs? Everything will eventually be transitively needed anyway, so I'd expect it to not buy us too much beyond aesthetics of course.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143132658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143345890",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-143345890",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 143345890,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0MzM0NTg5MA==",
    "user": {
      "login": "m4b",
      "id": 1920204,
      "node_id": "MDQ6VXNlcjE5MjAyMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1920204?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/m4b",
      "html_url": "https://github.com/m4b",
      "followers_url": "https://api.github.com/users/m4b/followers",
      "following_url": "https://api.github.com/users/m4b/following{/other_user}",
      "gists_url": "https://api.github.com/users/m4b/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/m4b/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/m4b/subscriptions",
      "organizations_url": "https://api.github.com/users/m4b/orgs",
      "repos_url": "https://api.github.com/users/m4b/repos",
      "events_url": "https://api.github.com/users/m4b/events{/privacy}",
      "received_events_url": "https://api.github.com/users/m4b/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-25T20:26:53Z",
    "updated_at": "2015-09-25T20:26:53Z",
    "body": "### Point 1\n\nGood call checking the `LC_ID_DYLIB`.\n\nSo I would suggest using the `install-name` flag as you suggested; I believe this is typical in OSX builds and unusual to leave it off.\n\nAs for benefits of using this, honestly the aesthetic argument is enough for me, as the current setup looks strange and non-standard.  I would argue when in Rome, do as the Romans do in this case.\n\nA second reason is again, the dynamic lib calls are only accidentally working, because of the default search paths of `dyld`.  To rely on this behavior when it can be solved with something like `-install_name /usr/local/lib/$(basename $i)` seems unecessary, as it could be potentially dangerous (what if the default search locations change, someone uses non-standard environment variables, etc.), which can all be easily resolved by setting the install names properly.\n\nLastly, and this may or may not be a security issue, but again, the dylib's name (`LC_ID_DYLIB`) and `LC_LOAD_DYLIB` are called install names for a reason; it's where they reside and where the linker looks first.\n\nTo illustrate this, in a directory, say `/tmp`, create the following folder:\n\n```\nx86_64-apple-darwin/stage1/lib/rustlib/x86_64-apple-darwin/lib/\n```\n\nNow cp `libstd-198068b3.dylib` to that folder and run:\n\n```\nDYLD_PRINT_LIBRARIES=true rustc --version\n```\n\nand you should see that `dyld` loaded the `libstd-198068b3.dylib` in the directories we just created.  In other words, it loaded some dynamic library named the same thing in the directories, but which isn't the system library...  This cannot happen when the install name is absolute (or properly prefixed with an `@rpath`)\n\nAgain, this may or may not be a security issue; it doesn't look like the libraries are signed, so I could in principle alter any symbol's assembly in the tmp `libstd-198068b3.dylib` to do whatever I like; regardless though, this can all be avoided and resolved by simply setting the install names to the expected values, and it just looks nice to boot :)\n\n### Point 2\n\nAgain, for me the aesthetic argument is sufficient, in addition to if they are serving no purpose, then remove them.\n\nAs for side-effects, that is definitely a legitimate concern; given this condition, then since the majority of the dead libraries are rust libraries (which as you say have no side-effects), I'd suggest marking them as dead libraries at the very least.  It cleans up the binary, and makes it clearer what exactly this binary depends on, say for static analysis tools, someone looking at the binary, someone [computing the transitive closure of symbols against a library](https://github.com/m4b/rdr/commit/40511b9b5759877a15d1070abf58611af977d2b2) ;), etc.\n\nAs for the other two native libraries, which could be side-effecting, I only see:\n\n```\n/usr/lib/libedit.3.dylib\n/usr/lib/libc++.1.dylib\n```\n\nAs for the side-effect concern itself, I believe that warning only applies to loading a library _purely_ for it's initialization side-effect, and no other reason.  I'm not sure how common this is, and I suspect not at all.\n\nIf `libedit` and `libc++` are a transitive dependency, then I believe `dyld` will load and call every libraries `init` routines before any symbol linking or passing control to main occurs, and so I don't think this is something you need to worry about (unless, like above, you are loading those libraries purely for their side-effects and you know the library isn't required and hence loaded by any other library or its transitive dependencies).\n\nOf course don't take my word, absolutely test, but I believe all of the above caveats would also apply to the GNU/Linux version of rustc, which has the exact minimal dependencies I listed above.\n\nSo if the worry is not including `libc++` in the load commands for its side-effects, this will equally apply to the GNU/Linux case, but which doesn't seem to be an issue there (and again, I believe the same condition applies to `ld.so` in that it loads and runs the init code of all libraries prior to passing control to the binaries main, etc.)\n\nThat being said, and given the above, I'd suggest the following as a conservative library declaration:\n\n```\n/usr/local/lib/librustc_driver-198068b3.dylib\n/usr/local/lib/libstd-198068b3.dylib\n/usr/lib/libSystem.B.dylib\n/usr/lib/libedit.3.dylib\n/usr/lib/libc++.1.dylib\n```\n\nAlthough again, I really don't think the latter two are needed at all, and only clutter things.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143345890/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143869140",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-143869140",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 143869140,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0Mzg2OTE0MA==",
    "user": {
      "login": "m4b",
      "id": 1920204,
      "node_id": "MDQ6VXNlcjE5MjAyMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1920204?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/m4b",
      "html_url": "https://github.com/m4b",
      "followers_url": "https://api.github.com/users/m4b/followers",
      "following_url": "https://api.github.com/users/m4b/following{/other_user}",
      "gists_url": "https://api.github.com/users/m4b/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/m4b/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/m4b/subscriptions",
      "organizations_url": "https://api.github.com/users/m4b/orgs",
      "repos_url": "https://api.github.com/users/m4b/repos",
      "events_url": "https://api.github.com/users/m4b/events{/privacy}",
      "received_events_url": "https://api.github.com/users/m4b/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-28T20:46:39Z",
    "updated_at": "2015-09-28T20:46:39Z",
    "body": "On a related note, I've also noticed that executables or dynamic libraries import the technically _incorrect_ rust dynamic libraries if you go by those libraries's `LC_ID_DYLIB` (again, it works for the reasons above, namely that it doesn't find them and then uses the basename to resolve them against the default lib dirs).\n\nE.g. compiling the following:\n\n``` rust\nfn main (){\n    println!(\"{}\", 5);\n}\n```\n\nwith `rustc -C prefer-dynamic foo.rs -o foo` produces an executable with the following imports:\n\n```\n1018 __ZN2io5stdio6_print20h89c6f7f6ec14651d44gE (8) ~> x86_64-apple-darwin/stage2/lib/rustlib/x86_64-apple-darwin/lib/libstd-198068b3.dylib\n1020 __ZN2rt10lang_start20hd654f015947477d622wE (8) ~> x86_64-apple-darwin/stage2/lib/rustlib/x86_64-apple-darwin/lib/libstd-198068b3.dylib\n1028 _rust_stack_exhausted (8) ~> x86_64-apple-darwin/stage2/lib/rustlib/x86_64-apple-darwin/lib/libstd-198068b3.dylib\n1000 dyld_stub_binder (8) -> /usr/lib/libSystem.B.dylib\n1010 __ZN3fmt3num16i32.fmt..Display3fmt20hd8c7f550e968736bw5ME (8) -> x86_64-apple-darwin/stage2/lib/rustlib/x86_64-apple-darwin/lib/libstd-198068b3.dylib\n```\n\n**NOTE** the _stage2_ in the install_name path for the rust libs.\n\nAs stated above, `otool -l /usr/local/lib/libstd-198068b3.dylib` states that its `LC_ID_DYLIB` is:\n\n```\nx86_64-apple-darwin/stage1/lib/rustlib/x86_64-apple-darwin/lib/libstd-198068b3.dylib\n```\n\n**NOTE** the _stage1_.\n\n`rustc --version` is rustc 1.3.0 (9a92aaf19 2015-09-15), OSX 10.10.5\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143869140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143877508",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-143877508",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 143877508,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0Mzg3NzUwOA==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-28T21:19:04Z",
    "updated_at": "2015-09-28T21:19:04Z",
    "body": "I think it'd be fine to start passing `-install_name`, but from looking around it's not clear to me that there's _a_ value to pass in. For example there doesn't seem to be any definitive answer as to what a standard value is for a project that doesn't know where it's going to be installed. Targeting a solution at _just_ our own installation won't be enough as these are the same artifacts that all Rust programs link against, so I'm not sure what should be passed in.\n\nAt the very least we could pass `-install_name output_filename.dylib` to strip the folders and such, but I'm not sure if that's really much better than where we're at today. \n\nFor the `-mark_dead_strippable_dylib` option, I think we'd be fine to just start passing that, it probably wouldn't  cause too too many problems. Those two libraries that `rustc` links to aren't marked as strippable, however, and it has to be up to the linker currently to elide the symbols.\n\nFor the running against the \"wrong libraries\", this is actually somewhat intentional behavior in the sense that it's fine and it happens on all other systems as well.\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143877508/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143882754",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-143882754",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 143882754,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0Mzg4Mjc1NA==",
    "user": {
      "login": "m4b",
      "id": 1920204,
      "node_id": "MDQ6VXNlcjE5MjAyMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1920204?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/m4b",
      "html_url": "https://github.com/m4b",
      "followers_url": "https://api.github.com/users/m4b/followers",
      "following_url": "https://api.github.com/users/m4b/following{/other_user}",
      "gists_url": "https://api.github.com/users/m4b/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/m4b/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/m4b/subscriptions",
      "organizations_url": "https://api.github.com/users/m4b/orgs",
      "repos_url": "https://api.github.com/users/m4b/repos",
      "events_url": "https://api.github.com/users/m4b/events{/privacy}",
      "received_events_url": "https://api.github.com/users/m4b/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-28T21:44:29Z",
    "updated_at": "2015-09-28T21:44:29Z",
    "body": "I would suggest default prefixing with `/usr/local/lib` since that's where you install them by default anyway; and then if a user wants a non-standard install prefix, let them pass that in at compile time and use that.  Again, `@rpath` and other friends can be helpful in this matter depending on the use case, but it is probably overkill for now.\n\nI've noticed https://github.com/rust-lang/rust/issues/17219 has other issues with the library install name paths, so it might be something you just want to set to `/usr/local/lib` and deal with it from there.\n\nIt will also prevent a library with the same name if a path exists during execution time from being used, which I mentioned above as well, and after thinking about it more, it is probably pretty serious and can be entirely avoided by using absolute install_names.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143882754/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143886116",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-143886116",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 143886116,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0Mzg4NjExNg==",
    "user": {
      "login": "m4b",
      "id": 1920204,
      "node_id": "MDQ6VXNlcjE5MjAyMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1920204?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/m4b",
      "html_url": "https://github.com/m4b",
      "followers_url": "https://api.github.com/users/m4b/followers",
      "following_url": "https://api.github.com/users/m4b/following{/other_user}",
      "gists_url": "https://api.github.com/users/m4b/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/m4b/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/m4b/subscriptions",
      "organizations_url": "https://api.github.com/users/m4b/orgs",
      "repos_url": "https://api.github.com/users/m4b/repos",
      "events_url": "https://api.github.com/users/m4b/events{/privacy}",
      "received_events_url": "https://api.github.com/users/m4b/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-28T22:00:34Z",
    "updated_at": "2015-09-28T22:00:34Z",
    "body": "As for the wrong libraries, I can't understand how this is intentional or fine.  To be blunt, it's just incorrect.  Generated binaries library dependencies should be referencing the exact same name in `LC_ID_DYLIB`.\n\nFor example, scanning the dynamic libraries in /usr/local/lib with something like:\n\n```\ncd /usr/local/lib; for i in *.dylib; do otool -l $i | grep -A 3 LC_ID_DYLIB; done\n```\n\nThe only offenders are rust libraries with non-absolute paths.\n\nSImilarly for the binaries in `/usr/local/bin`:\n\n```\ncd /usr/local/bin; for i in *; do echo \"BINARY $i\"; otool -l $i | grep -A 3 LC_LOAD_DYLIB; done\n```\n\nThe only offenders seem to be rust generated binaries.\n\nAs such I'm not sure what you mean when you say it's fine or happens all other systems as well?  On linux you have soname's, so it's a different system, and what's occurring here can't come up.  In fact, this is the purpose of `ldconfig -p`, it maps soname's to actual install locations; but if your soname is bad, your binary won't load.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/143886116/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/144206815",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-144206815",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 144206815,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0NDIwNjgxNQ==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-09-29T22:16:29Z",
    "updated_at": "2015-09-29T22:16:29Z",
    "body": "Currently there's a number of methods by which you can install rust on OSX:\n1. Build from source\n2. Run the standard installers\n3. Homebrew\n4. Multirust\n\nUnfortunately we can't just assume that `/usr/local` is the root for installation as it's only true some of the time, and worse still the _builder_ of the compiler may not know where it's being installed to. As a result I don't think we can encode absolute paths as part of the build, but they can certainly be tweaked with `install_name_tool` after the fact. \n\nWhen I say we're mixing up libraries what I mean is that the ones in `/usr/local/lib` are built in stage1 where the ones in `/usr/local/lib/rustlib/$triple/lib` are built during stage2. Artifacts are linked against the stage2 versions but end up running with the stage1 ones (due to `DYLD_LIBRARY_PATH` most of the time). We're actually required for these two stages to be the same for plugins, so it's find to switch them up.\n\nAnd don't get me wrong, it definitely looks like there's something to do here! I'm not sure how much of it should be in the compiler vs as part of an installation, but it sounds like at least _some_ change needs to be made!\n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/144206815/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/144876418",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-144876418",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 144876418,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0NDg3NjQxOA==",
    "user": {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-10-01T23:27:30Z",
    "updated_at": "2015-10-01T23:27:30Z",
    "body": "cc @brson \n",
    "author_association": "MEMBER",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/144876418/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/146644958",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-146644958",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 146644958,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE0NjY0NDk1OA==",
    "user": {
      "login": "brson",
      "id": 147214,
      "node_id": "MDQ6VXNlcjE0NzIxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brson",
      "html_url": "https://github.com/brson",
      "followers_url": "https://api.github.com/users/brson/followers",
      "following_url": "https://api.github.com/users/brson/following{/other_user}",
      "gists_url": "https://api.github.com/users/brson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brson/subscriptions",
      "organizations_url": "https://api.github.com/users/brson/orgs",
      "repos_url": "https://api.github.com/users/brson/repos",
      "events_url": "https://api.github.com/users/brson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2015-10-08T18:23:42Z",
    "updated_at": "2015-10-08T18:23:42Z",
    "body": "It seems like this problem affects more than just the libs we distribute, but also all OS X libs that rustc generates.\n\nIt's baffling that dynamic linkers all seem to expect you to magically know features of your runtime environment _from your build environment_. Linux has a similar problem that the path to the dynamic linker is embedded in the binary.\n\nDynamic linkers are such a nightmare.\n",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/146644958/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 2,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270206610",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-270206610",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 270206610,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MDIwNjYxMA==",
    "user": {
      "login": "comex",
      "id": 47517,
      "node_id": "MDQ6VXNlcjQ3NTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/comex",
      "html_url": "https://github.com/comex",
      "followers_url": "https://api.github.com/users/comex/followers",
      "following_url": "https://api.github.com/users/comex/following{/other_user}",
      "gists_url": "https://api.github.com/users/comex/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/comex/subscriptions",
      "organizations_url": "https://api.github.com/users/comex/orgs",
      "repos_url": "https://api.github.com/users/comex/repos",
      "events_url": "https://api.github.com/users/comex/events{/privacy}",
      "received_events_url": "https://api.github.com/users/comex/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-01-03T19:50:08Z",
    "updated_at": "2017-01-03T19:50:08Z",
    "body": "I think this is fixed.  I now get\r\n```\r\n          cmd LC_LOAD_DYLIB\r\n      cmdsize 64\r\n         name @rpath/libstd-713ad88203512705.dylib (offset 24)\r\n```\r\n\r\nwith rustc installed via rustup.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270206610/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270209017",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-270209017",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 270209017,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MDIwOTAxNw==",
    "user": {
      "login": "m4b",
      "id": 1920204,
      "node_id": "MDQ6VXNlcjE5MjAyMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1920204?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/m4b",
      "html_url": "https://github.com/m4b",
      "followers_url": "https://api.github.com/users/m4b/followers",
      "following_url": "https://api.github.com/users/m4b/following{/other_user}",
      "gists_url": "https://api.github.com/users/m4b/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/m4b/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/m4b/subscriptions",
      "organizations_url": "https://api.github.com/users/m4b/orgs",
      "repos_url": "https://api.github.com/users/m4b/repos",
      "events_url": "https://api.github.com/users/m4b/events{/privacy}",
      "received_events_url": "https://api.github.com/users/m4b/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-01-03T19:59:36Z",
    "updated_at": "2017-01-03T19:59:36Z",
    "body": "@comex can you update with output for the LC_RPATH value?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270209017/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270213676",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-270213676",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 270213676,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MDIxMzY3Ng==",
    "user": {
      "login": "comex",
      "id": 47517,
      "node_id": "MDQ6VXNlcjQ3NTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/comex",
      "html_url": "https://github.com/comex",
      "followers_url": "https://api.github.com/users/comex/followers",
      "following_url": "https://api.github.com/users/comex/following{/other_user}",
      "gists_url": "https://api.github.com/users/comex/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/comex/subscriptions",
      "organizations_url": "https://api.github.com/users/comex/orgs",
      "repos_url": "https://api.github.com/users/comex/repos",
      "events_url": "https://api.github.com/users/comex/events{/privacy}",
      "received_events_url": "https://api.github.com/users/comex/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2017-01-03T20:19:41Z",
    "updated_at": "2017-01-03T20:19:41Z",
    "body": "Oh, yeah.  Actually, `LC_RPATH` is not quite right.  There are two:\r\n```\r\nLoad command 14\r\n          cmd LC_RPATH\r\n      cmdsize 128\r\n         path @loader_path/../../Users/comex/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib (offset 12)\r\nLoad command 15\r\n          cmd LC_RPATH\r\n      cmdsize 64\r\n         path /usr/local/lib/rustlib/x86_64-apple-darwin/lib (offset 12)\r\n```\r\n\r\nThe first one is right, although I'm about to file another issue about the nonsensicality of using a relative path in this instance.  The second one is wrong, as `/usr/local/lib/rustlib` does not exist.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/270213676/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 1,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/545896769",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-545896769",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 545896769,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0NTg5Njc2OQ==",
    "user": {
      "login": "steveklabnik",
      "id": 27786,
      "node_id": "MDQ6VXNlcjI3Nzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveklabnik",
      "html_url": "https://github.com/steveklabnik",
      "followers_url": "https://api.github.com/users/steveklabnik/followers",
      "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions",
      "organizations_url": "https://api.github.com/users/steveklabnik/orgs",
      "repos_url": "https://api.github.com/users/steveklabnik/repos",
      "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveklabnik/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-10-24T12:34:50Z",
    "updated_at": "2019-10-24T12:34:50Z",
    "body": "Triage: i don't have a mac, so I can't re-try this. The original report was in 2015, a couple of comments in 2017. Lots has changed. Can anyone reproduce this?",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/545896769/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/546165636",
    "html_url": "https://github.com/rust-lang/rust/issues/28640#issuecomment-546165636",
    "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/28640",
    "id": 546165636,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0NjE2NTYzNg==",
    "user": {
      "login": "comex",
      "id": 47517,
      "node_id": "MDQ6VXNlcjQ3NTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/comex",
      "html_url": "https://github.com/comex",
      "followers_url": "https://api.github.com/users/comex/followers",
      "following_url": "https://api.github.com/users/comex/following{/other_user}",
      "gists_url": "https://api.github.com/users/comex/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/comex/subscriptions",
      "organizations_url": "https://api.github.com/users/comex/orgs",
      "repos_url": "https://api.github.com/users/comex/repos",
      "events_url": "https://api.github.com/users/comex/events{/privacy}",
      "received_events_url": "https://api.github.com/users/comex/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "created_at": "2019-10-25T01:42:59Z",
    "updated_at": "2019-10-25T01:43:11Z",
    "body": "In my previous post here (from 2017), I think I pasted the rpath not of a toolchain dylib but of a binary compiled with `-C prefer-dynamic`; sorry for not making that clear at the time.  Let's try this again.\r\n\r\n`LC_ID_DYLIB` and `LC_LOAD_DYLIB` still use rpath:\r\n```\r\n% otool -Lvv ~/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libtest*.dylib                \r\n/Users/comex/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libtest-6343af43832822dc.dylib:\r\n\t@rpath/libtest-6343af43832822dc.dylib (compatibility version 0.0.0, current version 0.0.0)\r\n\t@rpath/libstd-330229df6d027e2b.dylib (compatibility version 0.0.0, current version 0.0.0)\r\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.50.4)\r\n\t/usr/lib/libresolv.9.dylib (compatibility version 1.0.0, current version 1.0.0)\r\n```\r\n\r\nHere is the rpath for a dylib from the toolchain:\r\n```\r\n% otool -lvv ~/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib/libtest*.dylib | grep -A 2 RPATH\r\n          cmd LC_RPATH\r\n      cmdsize 32\r\n         path @loader_path/../lib (offset 12)\r\n```\r\n\r\nNo `/usr/local/lib`, which is good.  `@loader_path` is documented in `man dyld` as \"the path to the directory containing the mach-o binary which contains the load command using @loader_path\"... so it makes sense for dylibs to refer to each other this way.\r\n\r\nHowever, when compiling a binary:\r\n\r\nIf I only pass `-C prefer-dynamic` without `-C rpath`, the binary is just broken:\r\n```\r\n% rustc -C prefer-dynamic a.rs\r\n% otool -lvv a | grep -A 2 RPATH\r\n# no output\r\n% ./a\r\ndyld: Library not loaded: @rpath/libstd-330229df6d027e2b.dylib\r\n  Referenced from: /private/tmp/./a\r\n  Reason: image not found\r\nzsh: abort      ./a\r\n```\r\n\r\nThis has a separate report: [#50001 (Cannot execute Hello World on macOS with prefer-dynamic)](https://github.com/rust-lang/rust/issues/50001)\r\n\r\nIf I pass `-C rpath`, the binary does work, but the rpaths are even stranger than in 2017:\r\n```\r\n% cd /tmp/foobar\r\n% rustc -C prefer-dynamic -C rpath /tmp/a.rs\r\n% otool -lvv a | grep -A 2 RPATH       \r\n          cmd LC_RPATH\r\n      cmdsize 136\r\n         path @loader_path/../../../Users/comex/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/x86_64-apple-darwin/lib (offset 12)\r\n--\r\n          cmd LC_RPATH\r\n      cmdsize 72\r\n         path /private/tmp/foobar/lib/rustlib/x86_64-apple-darwin/lib (offset 12)\r\n```\r\n\r\nThe first rpath is similar to before: a relative path from the directory containing the binary to the dylib, even though in this case that means backing all the way out to the root directory.  It works but will stop working if the binary is moved.  I'm not sure if I ever filed an issue for it, but #58343 seems to be about the same issue on Linux.\r\n\r\nThe second rpath is broken... differently from before.  For some reason, rustc has appended `lib/rustlib/x86_64-apple-darwin/lib` to `/private/tmp/foobar`, the directory containing the binary.  This path does not exist; `/private/tmp/foobar` is completely empty except for that binary.",
    "author_association": "CONTRIBUTOR",
    "reactions": {
      "url": "https://api.github.com/repos/rust-lang/rust/issues/comments/546165636/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
