{
  "url": "https://api.github.com/repos/rust-lang/rust/issues/25784",
  "repository_url": "https://api.github.com/repos/rust-lang/rust",
  "labels_url": "https://api.github.com/repos/rust-lang/rust/issues/25784/labels{/name}",
  "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/25784/comments",
  "events_url": "https://api.github.com/repos/rust-lang/rust/issues/25784/events",
  "html_url": "https://github.com/rust-lang/rust/pull/25784",
  "id": 80696532,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MzYxNjA2NDQ=",
  "number": 25784,
  "title": "Reset signal behavior before starting children with std::process",
  "user": {
    "login": "geofft",
    "id": 74644,
    "node_id": "MDQ6VXNlcjc0NjQ0",
    "avatar_url": "https://avatars.githubusercontent.com/u/74644?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/geofft",
    "html_url": "https://github.com/geofft",
    "followers_url": "https://api.github.com/users/geofft/followers",
    "following_url": "https://api.github.com/users/geofft/following{/other_user}",
    "gists_url": "https://api.github.com/users/geofft/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/geofft/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/geofft/subscriptions",
    "organizations_url": "https://api.github.com/users/geofft/orgs",
    "repos_url": "https://api.github.com/users/geofft/repos",
    "events_url": "https://api.github.com/users/geofft/events{/privacy}",
    "received_events_url": "https://api.github.com/users/geofft/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 211668062,
      "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=",
      "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api",
      "name": "T-libs-api",
      "color": "bfd4f2",
      "default": false,
      "description": "Relevant to the library API team, which will review and decide on the PR/issue."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "alexcrichton",
    "id": 64996,
    "node_id": "MDQ6VXNlcjY0OTk2",
    "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexcrichton",
    "html_url": "https://github.com/alexcrichton",
    "followers_url": "https://api.github.com/users/alexcrichton/followers",
    "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
    "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
    "repos_url": "https://api.github.com/users/alexcrichton/repos",
    "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "alexcrichton",
      "id": 64996,
      "node_id": "MDQ6VXNlcjY0OTk2",
      "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexcrichton",
      "html_url": "https://github.com/alexcrichton",
      "followers_url": "https://api.github.com/users/alexcrichton/followers",
      "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions",
      "organizations_url": "https://api.github.com/users/alexcrichton/orgs",
      "repos_url": "https://api.github.com/users/alexcrichton/repos",
      "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexcrichton/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 37,
  "created_at": "2015-05-25T22:53:53Z",
  "updated_at": "2015-06-23T06:33:03Z",
  "closed_at": "2015-06-22T18:42:33Z",
  "author_association": "CONTRIBUTOR",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/rust-lang/rust/pulls/25784",
    "html_url": "https://github.com/rust-lang/rust/pull/25784",
    "diff_url": "https://github.com/rust-lang/rust/pull/25784.diff",
    "patch_url": "https://github.com/rust-lang/rust/pull/25784.patch",
    "merged_at": "2015-06-22T18:42:33Z"
  },
  "body": "UNIX specifies that signal dispositions and masks get inherited to child processes, but in general, programs are not very robust to being started with non-default signal dispositions or to signals being blocked. For example, libstd sets `SIGPIPE` to be ignored, on the grounds that Rust code using libstd will get the `EPIPE` errno and handle it correctly. But shell pipelines are built around the assumption that `SIGPIPE` will have its default behavior of killing the process, so that things like `head` work:\n\n```\ngeofft@titan:/tmp$ for i in `seq 1 20`; do echo \"$i\"; done | head -1\n1\ngeofft@titan:/tmp$ cat bash.rs\nfn main() {\n        std::process::Command::new(\"bash\").status();\n}\ngeofft@titan:/tmp$ ./bash\ngeofft@titan:/tmp$ for i in `seq 1 20`; do echo \"$i\"; done | head -1\n1\nbash: echo: write error: Broken pipe\nbash: echo: write error: Broken pipe\nbash: echo: write error: Broken pipe\nbash: echo: write error: Broken pipe\nbash: echo: write error: Broken pipe\n[...]\n```\n\nHere, `head` is supposed to terminate the input process quietly, but the bash subshell has inherited the ignored disposition of `SIGPIPE` from its Rust grandparent process. So it gets a bunch of `EPIPE`s that it doesn't know what to do with, and treats it as a generic, transient error. You can see similar behavior with `find / | head`, `yes | head`, etc.\n\nThis PR resets Rust's `SIGPIPE` handler, as well as any signal mask that may have been set, before spawning a child. Setting a signal mask, and then using a dedicated thread or something like `signalfd` to dequeue signals, is one of two reasonable ways for a library to process signals. See carllerche/mio#16 for more discussion about this approach to signal handling and why it needs a change to `std::process`. The other approach is for the library to set a signal-handling function (`signal()` / `sigaction()`): in that case, dispositions are reset to the default behavior on exec (since the function pointer isn't valid across exec), so we don't have to care about that here.\n\nAs part of this PR, I noticed that we had two somewhat-overlapping sets of bindings to signal functionality in `libstd`. One dated to old-IO and probably the old runtime, and was mostly unused. The other is currently used by `stack_overflow.rs`. I consolidated the two bindings into one set, and double-checked them by hand against all supported platforms' headers. This probably means it's safe to enable `stack_overflow.rs` on more targets, but I'm not including such a change in this PR.\n\nr? @alexcrichton\ncc @Zoxc for changes to `stack_overflow.rs`\n",
  "closed_by": {
    "login": "bors",
    "id": 3372342,
    "node_id": "MDQ6VXNlcjMzNzIzNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bors",
    "html_url": "https://github.com/bors",
    "followers_url": "https://api.github.com/users/bors/followers",
    "following_url": "https://api.github.com/users/bors/following{/other_user}",
    "gists_url": "https://api.github.com/users/bors/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bors/subscriptions",
    "organizations_url": "https://api.github.com/users/bors/orgs",
    "repos_url": "https://api.github.com/users/bors/repos",
    "events_url": "https://api.github.com/users/bors/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bors/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/rust-lang/rust/issues/25784/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/rust-lang/rust/issues/25784/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "_meta": {
    "type": "pr"
  }
}
